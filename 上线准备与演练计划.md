# 黑科易购项目 - 上线准备与演练计划

## 📅 上线时间规划
- **目标上线日期**: YYYY-MM-DD
- **预演时间**: YYYY-MM-DD (提前1-2天)
- **上线窗口**: 建议在业务低峰期（如凌晨0:00-4:00）

## 🛠️ 上线准备清单

### 1. 环境准备
| 环境 | 检查项 | 负责人 | 状态 |
|------|--------|--------|------|
| **生产环境** | 服务器资源（CPU、内存、磁盘） | 运维 | ⬜ |
|  | 网络带宽和延迟 | 运维 | ⬜ |
|  | 数据库服务（MySQL） | DBA | ⬜ |
|  | 缓存服务（Redis） | 运维 | ⬜ |
|  | 服务注册中心（Nacos） | 运维 | ⬜ |
|  | 日志收集系统（ELK） | 运维 | ⬜ |
|  | 监控系统（Prometheus/Grafana） | 运维 | ⬜ |
| **测试环境** | 与生产环境配置一致性 | 开发 | ⬜ |
|  | 数据准备（模拟生产数据） | 测试 | ⬜ |

### 2. 代码与配置准备
| 检查项 | 负责人 | 状态 |
|--------|--------|------|
| 代码分支合并与冲突解决 | 开发 | ⬜ |
| 版本标签创建（Git Tag） | 开发 | ⬜ |
| 生产环境配置文件（.env.prod） | 开发 | ⬜ |
| 配置项加密（敏感信息） | 开发 | ⬜ |
| 数据库连接配置验证 | 开发 | ⬜ |
| 第三方服务配置（支付、短信等） | 开发 | ⬜ |

### 3. 数据准备
| 检查项 | 负责人 | 状态 |
|--------|--------|------|
| 数据库全量备份脚本 | DBA | ⬜ |
| 表结构迁移脚本（schema.sql） | 开发 | ⬜ |
| 基础数据初始化脚本（init_data.sql） | 开发 | ⬜ |
| 测试数据清理脚本 | 开发 | ⬜ |
| 数据迁移验证脚本 | 测试 | ⬜ |

## 📊 数据迁移方案

### 1. 迁移前准备
- **备份策略**: 执行全量备份，备份文件存储在独立服务器
  ```bash
  # 备份数据库
  mysqldump -u root -p --databases heikeji_mall > heikeji_mall_backup_$(date +%Y%m%d_%H%M%S).sql
  
  # 压缩备份文件
  gzip heikeji_mall_backup_$(date +%Y%m%d_%H%M%S).sql
  ```

- **环境检查**: 确保目标数据库版本与开发环境一致（MySQL 8.0+）
- **权限设置**: 确保迁移账号拥有足够的数据库权限

### 2. 迁移步骤
1. **创建数据库**: 
   ```sql
   CREATE DATABASE IF NOT EXISTS heikeji_mall DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

2. **执行表结构迁移**: 
   ```bash
   mysql -u root -p heikeji_mall < sql/schema.sql
   ```

3. **执行基础数据初始化**: 
   ```bash
   mysql -u root -p heikeji_mall < sql/init_data.sql
   ```

4. **验证迁移结果**: 
   - 检查表结构是否完整
   - 检查基础数据是否正确
   - 验证外键约束和索引

### 3. 数据验证标准
| 验证项 | 验证方法 | 负责人 |
|--------|----------|--------|
| 表数量一致性 | 比较开发环境与生产环境的表数量 | 开发 |
| 字段定义一致性 | 比较关键表的字段类型和约束 | 开发 |
| 基础数据完整性 | 查询基础数据记录数 | 测试 |
| 业务逻辑验证 | 执行核心业务流程测试 | 测试 |

## 🔄 回滚计划

### 1. 数据库回滚
- **回滚时间**: 预计10-30分钟
- **回滚步骤**: 
  ```bash
  # 停止所有应用服务
  
  # 恢复数据库
  mysql -u root -p heikeji_mall < heikeji_mall_backup_$(date +%Y%m%d_%H%M%S).sql
  
  # 重新启动应用服务
  ```

### 2. 服务回滚
- **回滚时间**: 预计5-15分钟
- **回滚步骤**: 
  ```bash
  # 停止当前版本服务
  
  # 部署上一版本服务包
  java -jar heikeji-app-<上一版本号>.jar --spring.profiles.active=prod
  
  # 验证服务可用性
  ```

### 3. 配置回滚
- **回滚时间**: 预计2-5分钟
- **回滚步骤**: 
  ```bash
  # 备份当前配置
  cp .env.prod .env.prod.rollback
  
  # 恢复上一版本配置
  cp .env.prod.bak .env.prod
  
  # 重启服务使配置生效
  ```

## 🧪 上线演练流程

### 1. 预演环境搭建
1. 克隆生产环境配置
2. 部署应用服务到预演环境
3. 初始化数据库
4. 配置监控和日志系统

### 2. 演练步骤

#### 步骤1: 服务启动验证
```bash
# 启动顺序（按照依赖关系）
1. Nacos服务注册中心
2. MySQL数据库
3. Redis缓存
4. 核心业务服务（user, product, order, payment等）
5. 聚合服务（heikeji-app）
```

#### 步骤2: 功能验证
| 功能模块 | 验证项 | 负责人 |
|----------|--------|--------|
| **用户模块** | 注册、登录、个人信息管理 | 测试 |
| **商品模块** | 商品列表、详情、搜索 | 测试 |
| **购物车** | 添加商品、修改数量、结算 | 测试 |
| **订单模块** | 下单、取消订单、查询订单 | 测试 |
| **支付模块** | 支付流程、支付回调、退款 | 测试 |
| **配送模块** | 配送状态查询、外卖柜功能 | 测试 |

#### 步骤3: 性能测试
- **并发测试**: 模拟100-500用户并发访问
- **响应时间**: 核心接口响应时间<2秒
- **资源占用**: CPU使用率<70%，内存使用率<80%

#### 步骤4: 故障演练
- **服务重启测试**: 模拟单个服务故障，验证自动恢复能力
- **数据库连接中断测试**: 验证连接池重连机制
- **网络延迟测试**: 模拟网络延迟，验证系统稳定性

### 3. 演练结果评估
| 评估项 | 评估标准 | 结果 |
|--------|----------|------|
| 服务启动成功率 | 100% | ⬜ |
| 核心功能通过率 | 100% | ⬜ |
| 性能指标达标率 | 100% | ⬜ |
| 故障恢复时间 | <5分钟 | ⬜ |

## 🚨 上线应急方案

### 1. 常见问题及处理
| 问题类型 | 症状 | 处理方案 | 负责人 |
|----------|------|----------|--------|
| **数据库连接失败** | 应用启动失败，日志显示连接超时 | 检查数据库服务状态、连接配置和网络 | DBA/运维 |
| **服务注册失败** | 服务无法注册到Nacos | 检查Nacos服务状态、网络和配置 | 开发/运维 |
| **支付失败** | 用户支付报错 | 检查支付配置、第三方接口状态 | 开发/支付负责人 |
| **高并发性能问题** | 响应时间过长、服务崩溃 | 紧急扩容、限流、降级 | 运维/架构 |

### 2. 应急联系人
| 角色 | 姓名 | 联系方式 |
|------|------|----------|
| 项目负责人 |  |  |
| 开发负责人 |  |  |
| 运维负责人 |  |  |
| DBA |  |  |
| 测试负责人 |  |  |

## 📈 上线后监控

### 1. 实时监控指标
| 监控项 | 阈值 | 告警方式 |
|--------|------|----------|
| CPU使用率 | >80% | 短信+邮件 |
| 内存使用率 | >85% | 短信+邮件 |
| 磁盘使用率 | >90% | 短信+邮件 |
| 数据库连接数 | >80% | 邮件 |
| 接口响应时间 | >3秒 | 邮件 |
| 错误率 | >1% | 短信+邮件 |

### 2. 上线后验证
1. 上线后1小时内：每15分钟检查一次系统状态
2. 上线后24小时内：监控关键指标和业务数据
3. 上线后72小时内：进行一次全面的系统性能评估

## 📝 上线总结

### 1. 上线结果
- 上线是否成功：□ 是 □ 否
- 实际上线时间：YYYY-MM-DD HH:MM
- 完成时间：YYYY-MM-DD HH:MM
- 总耗时：HH:MM

### 2. 问题记录
| 问题描述 | 影响范围 | 处理时间 | 解决方案 |
|----------|----------|----------|----------|
|  |  |  |  |
|  |  |  |  |

### 3. 经验教训
- 成功经验：
- 需要改进的地方：

### 4. 后续优化计划
- 性能优化：
- 功能优化：
- 运维优化：

---

**文档审批**
| 角色 | 姓名 | 审批意见 | 日期 |
|------|------|----------|------|
| 项目负责人 |  |  |  |
| 开发负责人 |  |  |  |
| 运维负责人 |  |  |  |
| 测试负责人 |  |  |  |
