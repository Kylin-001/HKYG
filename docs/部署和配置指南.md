# 黑科易购项目部署和配置指南

## 1. 环境要求

### 1.1 基础环境

#### 1.1.1 硬件要求

| 环境类型 | CPU | 内存 | 磁盘 | 网络 |
|---------|-----|-----|------|------|
| **开发环境** | 最少4核，推荐8核Intel i7/i9或AMD Ryzen 7/9 | 最少8GB RAM，推荐16GB DDR4 3200MHz+ | 最少100GB可用空间，推荐256GB+ NVMe SSD | 千兆网络，稳定的外网连接 |
| **测试环境** | 最少8核，推荐16核 | 最少16GB RAM，推荐32GB | 最少500GB SSD，IOPS > 5000 | 千兆网络，稳定连接 |
| **生产环境** | 最少16核，推荐32核 | 最少32GB RAM，推荐64GB+ | 最少1TB SSD，RAID 10配置 | 万兆网络，冗余线路 |

#### 1.1.2 操作系统要求

- **开发环境**：
  - Linux：Ubuntu 22.04 LTS (推荐)、CentOS Stream 9、Debian 12
  - macOS：12.0+ (Monterey)或13.0+ (Ventura)
  - Windows：Windows 10/11 Pro或Enterprise，建议配合WSL2使用

- **测试/生产环境**：
  - Linux：Ubuntu 22.04 LTS (推荐)、CentOS Stream 9、RHEL 9
  - 内核版本：Linux内核5.4或更高版本
  - 系统优化：建议关闭swap，调整文件句柄限制到65535+

### 1.2 软件环境

#### 1.2.1 开发环境

| 软件 | 版本要求 | 推荐版本 | 用途 | 兼容性说明 |
|-----|---------|---------|-----|----------|
| **JDK** | JDK 17 | OpenJDK 17.0.8+ | 后端开发 | 不兼容JDK 11以下版本 |
| **Maven** | 3.8.6+ | 3.9.6 | 项目构建 | 与JDK 17完全兼容 |
| **Node.js** | v18.x LTS | v18.20.0+ | 前端开发 | 不兼容v16以下版本 |
| **npm/Yarn** | npm 9.x+ 或 Yarn 1.22.x+ | npm 9.6.7+ 或 Yarn 1.22.22+ | 包管理 | npm与Node.js v18配套 |
| **Docker** | 20.10.x+ | 25.0.0+ | 容器化 | 推荐最新稳定版 |
| **Docker Compose** | 2.0.x+ | 2.25.0+ | 多容器管理 | 与Docker版本匹配 |
| **Git** | 2.30.x+ | 2.45.0+ | 版本控制 | 支持LFS功能 |
| **IDE** | IntelliJ IDEA 2023+ 或 VS Code 1.85+ | IntelliJ IDEA 2024.1 或 VS Code 1.89.0+ | 开发工具 | 配合项目插件使用 |

#### 1.2.2 生产环境

| 组件类型 | 组件名称 | 版本要求 | 推荐版本 | 配置要求 |
|---------|---------|---------|---------|--------|
| **容器平台** | Kubernetes | 1.24+ | 1.28.x | 高可用集群，最少3个master节点 |
| **服务网格** | Istio | 1.18+ | 1.20.x | 启用mTLS，配置网格策略 |
| **监控系统** | Prometheus | 2.40+ | 2.45.x | 持久化存储，保留30天数据 |
|  | Grafana | 9.x | 9.5.x | 自定义仪表板，LDAP集成 |
| **日志系统** | Elasticsearch | 8.x | 8.14.x | 集群模式，至少3个节点 |
|  | Logstash | 8.x | 8.14.x | 资源限制合理配置 |
|  | Kibana | 8.x | 8.14.x | 权限控制配置 |
| **CI/CD** | Jenkins | 2.401+ | 2.450.x | 分布式构建节点 |
| 或 | GitLab CI | 15.0+ | 16.10.x | 自托管Runner配置 |
| **网络** | Ingress Controller | NGINX 1.9+ 或 Traefik 2.9+ | NGINX 1.11.x | 启用HTTPS，限速配置 |
| **存储** | CSI Driver | 与K8s版本兼容 | 最新兼容版本 | 支持动态PV配置 |

#### 1.2.3 数据库和中间件

| 组件名称 | 版本要求 | 推荐版本 | 部署方式 | 关键配置 |
|---------|---------|---------|---------|--------|
| **MySQL** | 8.0+ | 8.0.36+ | 主从复制 | innodb_buffer_pool_size=50%内存 |
| **Redis** | 6.2+ | 7.0.x | 主从+哨兵 | maxmemory=4GB, maxmemory-policy=allkeys-lru |
| **Elasticsearch** | 8.x | 8.14.x | 集群 | heap_size=8GB, 分片合理分布 |
| **Nacos** | 2.0+ | 2.3.x | 集群 | 持久化配置，节点数>=3 |
| **RocketMQ** | 4.9+ | 5.1.x | 集群 | 高可用配置，NameServer多实例 |

### 1.3 安全要求

- **防火墙**：配置适当的入站/出站规则，仅开放必要端口
- **SSH**：禁用root直接登录，使用密钥认证，修改默认端口
- **SELinux/AppArmor**：生产环境启用，开发环境可适当放松
- **证书**：使用有效的TLS证书，定期更新
- **密码策略**：强密码策略，定期轮换密钥和凭证

### 1.4 依赖包管理

#### 1.4.1 系统依赖（Ubuntu示例）

```bash
# 系统更新和依赖安装
sudo apt update
sudo apt install -y build-essential curl wget git unzip \
    openssl libssl-dev zlib1g-dev libncurses5-dev \
    libgdbm-dev libnss3-dev libreadline-dev libffi-dev \
    libsqlite3-dev libbz2-dev uuid-dev liblzma-dev

## 2. 开发环境部署

### 2.1 准备工作

#### 2.1.1 克隆代码仓库

```bash
git clone https://your-git-repo/heikeji-mall.git
cd heikeji-mall
```

## 4. 环境变量配置

### 4.1 环境变量概述

环境变量是黑科易购项目的重要配置方式，用于管理不同环境下的系统参数。通过环境变量，可以灵活配置数据库连接、缓存设置、第三方服务集成等关键信息，避免硬编码敏感信息。

### 4.2 环境变量文件结构

项目支持多环境配置，通过以下环境变量文件管理配置：

- `.env`：通用环境变量，适用于所有环境
- `.env.development`：开发环境特定配置
- `.env.test`：测试环境特定配置
- `.env.production`：生产环境特定配置

环境变量加载优先级（从高到低）：
1. 命令行传入的环境变量
2. 系统环境变量
3. `.env.{环境}`文件
4. `.env`文件

### 4.3 核心环境变量详解

#### 4.3.1 数据库相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `MYSQL_HOST` | 字符串 | 是 | localhost | MySQL数据库主机地址 | 生产环境使用内网地址 |
| `MYSQL_PORT` | 整数 | 否 | 3306 | MySQL数据库端口 | 通常保持默认 |
| `MYSQL_USER` | 字符串 | 是 | root | 数据库用户名 | 生产环境使用专用账户 |
| `MYSQL_PASSWORD` | 字符串 | 是 | - | 数据库密码 | 生产环境使用强密码 |
| `MYSQL_DATABASE` | 字符串 | 是 | heikeji_mall | 数据库名称 | 通常保持默认 |
| `MYSQL_CONNECTION_TIMEOUT` | 整数 | 否 | 30000 | 数据库连接超时时间(毫秒) | 根据网络情况调整 |
| `MYSQL_MAX_POOL_SIZE` | 整数 | 否 | 50 | 数据库连接池最大连接数 | 生产环境：100-200 |
| `MYSQL_MIN_IDLE` | 整数 | 否 | 10 | 数据库连接池最小空闲连接数 | 生产环境：20-30 |
| `MYSQL_VALIDATION_TIMEOUT` | 整数 | 否 | 5000 | 连接验证超时时间(毫秒) | 通常保持默认 |

#### 4.3.2 Redis缓存相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `REDIS_HOST` | 字符串 | 是 | localhost | Redis服务器主机地址 | 生产环境使用集群地址 |
| `REDIS_PORT` | 整数 | 否 | 6379 | Redis服务器端口 | 通常保持默认 |
| `REDIS_PASSWORD` | 字符串 | 否 | - | Redis密码 | 生产环境必须设置 |
| `REDIS_DATABASE` | 整数 | 否 | 0 | Redis数据库索引 | 建议按功能分库 |
| `REDIS_TIMEOUT` | 整数 | 否 | 3000 | Redis连接超时时间(毫秒) | 根据网络情况调整 |
| `REDIS_MAX_ACTIVE` | 整数 | 否 | 100 | 最大活动连接数 | 生产环境：200-500 |
| `REDIS_MAX_IDLE` | 整数 | 否 | 20 | 最大空闲连接数 | 生产环境：50-100 |
| `REDIS_MIN_IDLE` | 整数 | 否 | 10 | 最小空闲连接数 | 生产环境：20-30 |
| `REDIS_MAX_WAIT` | 整数 | 否 | -1 | 最大等待时间(毫秒) | -1表示不限制 |
| `CACHE_ENABLED` | 布尔值 | 否 | true | 是否启用缓存 | 开发环境可设为false |
| `CACHE_TTL` | 整数 | 否 | 3600 | 缓存默认过期时间(秒) | 根据数据更新频率调整 |

#### 4.3.3 服务注册与配置中心相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `NACOS_HOST` | 字符串 | 是 | localhost | Nacos服务器主机地址 | 生产环境使用集群地址 |
| `NACOS_PORT` | 整数 | 否 | 8848 | Nacos服务器端口 | 通常保持默认 |
| `NACOS_USERNAME` | 字符串 | 否 | nacos | Nacos登录用户名 | 生产环境修改默认用户名 |
| `NACOS_PASSWORD` | 字符串 | 否 | nacos | Nacos登录密码 | 生产环境使用强密码 |
| `NACOS_NAMESPACE` | 字符串 | 否 | public | Nacos命名空间 | 按环境区分：dev/test/prod |
| `NACOS_GROUP` | 字符串 | 否 | DEFAULT_GROUP | Nacos配置分组 | 可按服务或功能分组 |
| `REGISTER_WITH_NACOS` | 布尔值 | 否 | true | 是否注册到Nacos | 开发环境可设为false |
| `DISCOVERY_ENABLED` | 布尔值 | 否 | true | 是否启用服务发现 | 开发环境可设为false |

#### 4.3.4 Elasticsearch相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `ELASTICSEARCH_HOST` | 字符串 | 否 | localhost | Elasticsearch主机地址 | 生产环境使用集群地址 |
| `ELASTICSEARCH_PORT` | 整数 | 否 | 9200 | Elasticsearch端口 | 通常保持默认 |
| `ELASTICSEARCH_USERNAME` | 字符串 | 否 | elastic | Elasticsearch用户名 | 生产环境修改默认用户名 |
| `ELASTICSEARCH_PASSWORD` | 字符串 | 否 | - | Elasticsearch密码 | 生产环境必须设置 |
| `ELASTICSEARCH_SSL_ENABLED` | 布尔值 | 否 | false | 是否启用SSL | 生产环境建议启用 |
| `ELASTICSEARCH_CONNECTION_TIMEOUT` | 整数 | 否 | 30000 | 连接超时时间(毫秒) | 根据网络情况调整 |

#### 4.3.5 服务器与应用相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `SERVER_PORT` | 整数 | 否 | 8080 | 服务器监听端口 | 按服务定义不同端口 |
| `SERVER_CONTEXT_PATH` | 字符串 | 否 | / | 应用上下文路径 | 通常保持默认 |
| `ENVIRONMENT` | 字符串 | 否 | development | 运行环境 | development/test/production |
| `LOG_LEVEL` | 字符串 | 否 | info | 日志级别 | 开发：debug，生产：info |
| `LOG_FILE_PATH` | 字符串 | 否 | logs | 日志文件路径 | 根据部署环境调整 |
| `JVM_OPTS` | 字符串 | 否 | -Xms512m -Xmx512m | JVM参数 | 生产环境：-Xms2g -Xmx2g |
| `METRICS_ENABLED` | 布尔值 | 否 | true | 是否启用指标收集 | 建议保持启用 |
| `HEALTH_CHECK_ENABLED` | 布尔值 | 否 | true | 是否启用健康检查 | 建议保持启用 |
| `CORS_ENABLED` | 布尔值 | 否 | true | 是否启用跨域支持 | 生产环境根据需求配置 |
| `API_DOC_ENABLED` | 布尔值 | 否 | true | 是否启用API文档 | 生产环境建议关闭 |

#### 4.3.6 安全相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `JWT_SECRET` | 字符串 | 是 | - | JWT签名密钥 | 生产环境使用强密钥 |
| `JWT_EXPIRE_TIME` | 整数 | 否 | 3600 | JWT令牌过期时间(秒) | 根据安全要求调整 |
| `JWT_REFRESH_EXPIRE_TIME` | 整数 | 否 | 2592000 | 刷新令牌过期时间(秒) | 通常为30天 |
| `SSL_ENABLED` | 布尔值 | 否 | false | 是否启用SSL | 生产环境必须启用 |
| `SSL_KEY_STORE` | 字符串 | 否 | - | SSL密钥库路径 | 启用SSL时必填 |
| `SSL_KEY_STORE_PASSWORD` | 字符串 | 否 | - | SSL密钥库密码 | 启用SSL时必填 |
| `SSL_TRUST_STORE` | 字符串 | 否 | - | SSL信任库路径 | 必要时配置 |
| `SSL_TRUST_STORE_PASSWORD` | 字符串 | 否 | - | SSL信任库密码 | 必要时配置 |
| `ENCRYPT_ENABLED` | 布尔值 | 否 | true | 是否启用敏感数据加密 | 建议保持启用 |

#### 4.3.7 第三方服务集成相关环境变量

| 环境变量 | 类型 | 必填 | 默认值 | 说明 | 环境建议 |
|---------|------|------|-------|------|--------|
| `WECHAT_APPID` | 字符串 | 否 | - | 微信公众号/小程序AppID | 根据实际应用配置 |
| `WECHAT_SECRET` | 字符串 | 否 | - | 微信公众号/小程序Secret | 生产环境妥善保管 |
| `ALIYUN_OSS_ENDPOINT` | 字符串 | 否 | - | 阿里云OSS服务端点 | 使用时配置 |
| `ALIYUN_OSS_ACCESS_KEY_ID` | 字符串 | 否 | - | 阿里云访问密钥ID | 使用时配置 |
| `ALIYUN_OSS_ACCESS_KEY_SECRET` | 字符串 | 否 | - | 阿里云访问密钥密钥 | 生产环境妥善保管 |
| `ALIYUN_OSS_BUCKET_NAME` | 字符串 | 否 | - | OSS存储桶名称 | 使用时配置 |
| `SMS_SERVICE_ENABLED` | 布尔值 | 否 | false | 是否启用短信服务 | 使用时启用 |
| `SMS_ACCESS_KEY` | 字符串 | 否 | - | 短信服务访问密钥 | 使用时配置 |
| `SMS_SECRET_KEY` | 字符串 | 否 | - | 短信服务密钥 | 生产环境妥善保管 |

### 4.4 环境变量配置示例

#### 4.4.1 开发环境配置示例 (.env.development)

```dotenv
# 数据库配置
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=root123
MYSQL_DATABASE=heikeji_mall
MYSQL_MAX_POOL_SIZE=30
MYSQL_MIN_IDLE=5

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DATABASE=0
CACHE_ENABLED=true
CACHE_TTL=3600

# Nacos配置
NACOS_HOST=localhost
NACOS_PORT=8848
NACOS_USERNAME=nacos
NACOS_PASSWORD=nacos
NACOS_NAMESPACE=dev
NACOS_GROUP=DEV_GROUP

# 服务器配置
SERVER_PORT=8080
ENVIRONMENT=development
LOG_LEVEL=debug
JVM_OPTS=-Xms512m -Xmx512m -XX:+UseG1GC
METRICS_ENABLED=true
API_DOC_ENABLED=true

# 安全配置
JWT_SECRET=dev_jwt_secret_key_change_in_production
JWT_EXPIRE_TIME=3600
SSL_ENABLED=false
```

#### 4.4.2 生产环境配置示例 (.env.production)

```dotenv
# 数据库配置
MYSQL_HOST=mysql-master.internal
MYSQL_PORT=3306
MYSQL_USER=heikeji_app
MYSQL_PASSWORD=ComplexPassword123!
MYSQL_DATABASE=heikeji_mall
MYSQL_MAX_POOL_SIZE=150
MYSQL_MIN_IDLE=20
MYSQL_CONNECTION_TIMEOUT=30000

# Redis配置
REDIS_HOST=redis-cluster.internal
REDIS_PORT=6379
REDIS_PASSWORD=SecureRedisPassword789$
REDIS_DATABASE=1
REDIS_MAX_ACTIVE=300
REDIS_MAX_IDLE=50
CACHE_TTL=7200

# Nacos配置
NACOS_HOST=nacos-cluster.internal
NACOS_PORT=8848
NACOS_USERNAME=nacos_admin
NACOS_PASSWORD=StrongNacosPass456#
NACOS_NAMESPACE=prod
NACOS_GROUP=PROD_GROUP

# Elasticsearch配置
ELASTICSEARCH_HOST=es-cluster.internal
ELASTICSEARCH_PORT=9200
ELASTICSEARCH_USERNAME=heikeji_app
ELASTICSEARCH_PASSWORD=ElasticPass987#
ELASTICSEARCH_SSL_ENABLED=true

# 服务器配置
SERVER_PORT=8080
ENVIRONMENT=production
LOG_LEVEL=info
LOG_FILE_PATH=/var/log/heikeji
JVM_OPTS=-Xms2g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
METRICS_ENABLED=true
API_DOC_ENABLED=false

# 安全配置
JWT_SECRET=ComplexProductionJWTSecretKeyWithLongString1234567890
JWT_EXPIRE_TIME=1800
JWT_REFRESH_EXPIRE_TIME=2592000
SSL_ENABLED=true
SSL_KEY_STORE=/etc/ssl/keystore.p12
SSL_KEY_STORE_PASSWORD=KeystorePass567$

# 第三方服务配置
WECHAT_APPID=wx1234567890abcdef
WECHAT_SECRET=0123456789abcdef0123456789abcdef
```

### 4.5 环境变量管理最佳实践

#### 4.5.1 敏感信息管理

1. **避免硬编码敏感信息**：所有密码、密钥等敏感信息必须通过环境变量配置，禁止硬编码在代码中
2. **使用密钥管理服务**：生产环境建议使用专业的密钥管理服务（如Vault、阿里云KMS等）
3. **定期轮换密钥**：定期更换数据库密码、API密钥等敏感信息
4. **最小权限原则**：为不同服务配置最小权限的账户，避免使用管理员账户

#### 4.5.2 环境变量维护

1. **配置文件模板**：提供`.env.example`文件作为模板，包含所有必要的环境变量但不含敏感值
2. **版本控制管理**：敏感配置文件不应提交到版本控制系统，应添加到`.gitignore`
3. **环境一致性**：确保开发、测试和生产环境的环境变量结构保持一致
4. **文档更新**：及时更新环境变量文档，确保与实际使用一致

#### 4.5.3 Kubernetes环境中的环境变量管理

1. **使用ConfigMap管理非敏感配置**：
   ```bash
   kubectl create configmap heikeji-config --from-env-file=.env -n heikeji-mall
   ```

2. **使用Secret管理敏感配置**：
   ```bash
   kubectl create secret generic heikeji-secrets --from-literal=mysql-password=ComplexPassword123! --from-literal=redis-password=SecureRedisPassword789$ -n heikeji-mall
   ```

3. **在Pod中引用环境变量**：
   ```yaml
   env:
   - name: MYSQL_PASSWORD
     valueFrom:
       secretKeyRef:
         name: heikeji-secrets
         key: mysql-password
   ```

4. **环境变量注入方式**：
   - 通过`env`字段直接注入
   - 通过`envFrom`从ConfigMap或Secret注入
   - 使用外部密钥管理服务的CSI驱动

### 4.6 环境变量验证与故障排查

1. **验证环境变量是否正确加载**：
   - 检查应用启动日志中的环境变量信息
   - 使用`kubectl describe pod <pod-name>`查看Kubernetes中的环境变量

2. **常见问题排查**：
   - 环境变量名称错误：检查大小写是否正确
   - 敏感信息格式问题：如密码包含特殊字符需要转义
   - 环境变量冲突：检查是否有多个地方定义了同名环境变量
   - 权限问题：确保进程有权限读取环境变量文件

3. **环境变量调试命令**：
   ```bash
   # 在容器中查看环境变量
   kubectl exec -it <pod-name> -- env | grep -E 'MYSQL|REDIS|NACOS'
   
   # 查看应用启动时的环境变量日志
   kubectl logs <pod-name> | grep -i 'environment variable'
   ```
```

### 2.2 使用Docker Compose启动开发环境

```bash
# 进入项目根目录
cd heikeji-mall

# 启动所有服务（包括数据库、Redis、Elasticsearch、Nacos等）
docker-compose -f docker-compose-dev.yml up -d
```

### 2.3 后端服务编译和启动

#### 2.3.1 编译后端服务

```bash
# 进入后端服务目录
cd heikeji-mall-service

# 编译所有模块
mvn clean install -DskipTests
```

#### 2.3.2 启动单个服务（开发模式）

```bash
# 例如启动用户服务
cd service-user
mvn spring-boot:run
```

### 2.4 前端服务编译和启动

#### 2.4.1 Web端编译和启动

```bash
# 进入前端目录
cd heikeji-frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

#### 2.4.2 小程序端编译和启动

```bash
# 进入小程序目录
cd heikeji-miniprogram

# 安装依赖
npm install

# 启动开发服务器
npm run dev:weapp
```

## 3. 生产环境部署

### 3.1 Kubernetes部署

#### 3.1.1 准备Kubernetes集群

确保您已有一个运行中的Kubernetes集群，并配置好`kubectl`命令行工具。

#### 3.1.2 创建命名空间

```bash
kubectl create namespace heikeji-mall
```

#### 3.1.3 创建Secret配置

```bash
kubectl create secret generic heikeji-mall-secrets \
  --from-literal=mysql-password=your_password \
  --from-literal=redis-password=your_redis_password \
  --from-literal=wechat-appid=your_appid \
  --from-literal=wechat-secret=your_secret \
  -n heikeji-mall
```

#### 3.1.4 部署基础设施

使用Helm部署必要的基础设施组件：

```bash
# 添加Helm仓库
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add elastic https://helm.elastic.co

# 更新Helm仓库
helm repo update

# 部署MySQL
helm install mysql bitnami/mysql \
  --set auth.rootPassword=your_password \
  --set auth.database=heikeji_mall \
  -n heikeji-mall

# 部署Redis
helm install redis bitnami/redis \
  --set auth.password=your_redis_password \
  -n heikeji-mall

# 部署Elasticsearch
helm install elasticsearch elastic/elasticsearch \
  --set replicas=3 \
  -n heikeji-mall

# 部署Nacos
helm install nacos nacos/nacos \
  -n heikeji-mall
```

#### 3.1.5 部署应用服务

### 3.1.5.1 服务配置参数说明

每个微服务都需要配置以下关键参数：

| 配置项 | 说明 | 默认值 | 推荐值 |
|-------|------|-------|-------|
| `JVM_OPTS` | JVM参数配置 | `-Xms256m -Xmx512m` | 生产环境：`-Xms2g -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200` |
| `SERVICE_PORT` | 服务端口 | 8080 | 按服务定义 |
| `NACOS_SERVER_ADDR` | Nacos服务地址 | localhost:8848 | 集群地址 |
| `NACOS_NAMESPACE` | Nacos命名空间 | public | dev/test/prod |
| `MYSQL_HOST` | MySQL主机地址 | localhost | 数据库集群地址 |
| `REDIS_HOST` | Redis主机地址 | localhost | Redis集群地址 |
| `LOG_LEVEL` | 日志级别 | info | 开发：debug，生产：info |
| `ENVIRONMENT` | 运行环境 | dev | dev/test/staging/prod |
| `MAX_CONNECTIONS` | 最大连接数 | 100 | 生产环境：500-1000 |
| `CONNECTION_TIMEOUT` | 连接超时时间(ms) | 30000 | 根据网络情况调整 |

### 3.1.5.2 服务配置文件示例

**API网关配置示例（service-gateway.yaml）：**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: heikeji-mall
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: api-gateway
        image: heikeji/api-gateway:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        env:
        - name: JVM_OPTS
          value: "-Xms1g -Xmx1g -XX:+UseG1GC"
        - name: SERVICE_PORT
          value: "8080"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: NACOS_NAMESPACE
          value: "prod"
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: LOG_LEVEL
          value: "info"
        - name: RATE_LIMIT_ENABLED
          value: "true"
        - name: RATE_LIMIT_RPS
          value: "1000"
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
      volumes:
      - name: config-volume
        configMap:
          name: gateway-config
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: heikeji-mall
spec:
  selector:
    app: api-gateway
  ports:
  - port: 80
    targetPort: 8080
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: api-gateway
  namespace: heikeji-mall
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  rules:
  - host: api.heikeji-mall.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 80
```

**用户服务配置示例（service-user.yaml）：**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-user
  namespace: heikeji-mall
spec:
  replicas: 2
  selector:
    matchLabels:
      app: service-user
  template:
    metadata:
      labels:
        app: service-user
    spec:
      containers:
      - name: service-user
        image: heikeji/service-user:latest
        ports:
        - containerPort: 8081
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        env:
        - name: JVM_OPTS
          value: "-Xms512m -Xmx512m -XX:+UseG1GC"
        - name: SERVICE_PORT
          value: "8081"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: NACOS_NAMESPACE
          value: "prod"
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: MYSQL_HOST
          valueFrom:
            secretKeyRef:
              name: heikeji-mall-secrets
              key: mysql-host
        - name: MYSQL_PORT
          value: "3306"
        - name: MYSQL_DATABASE
          value: "heikeji_mall"
        - name: MYSQL_USERNAME
          valueFrom:
            secretKeyRef:
              name: heikeji-mall-secrets
              key: mysql-username
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: heikeji-mall-secrets
              key: mysql-password
        - name: REDIS_HOST
          value: "redis-master"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: heikeji-mall-secrets
              key: redis-password
        - name: CACHE_ENABLED
          value: "true"
        - name: CACHE_TTL
          value: "3600"
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: service-user
  namespace: heikeji-mall
spec:
  selector:
    app: service-user
  ports:
  - port: 80
    targetPort: 8081
  type: ClusterIP
```

### 3.1.5.3 部署命令

```bash
# 部署API网关
kubectl apply -f k8s/api-gateway.yaml -n heikeji-mall

# 部署微服务
kubectl apply -f k8s/service-user.yaml -n heikeji-mall
kubectl apply -f k8s/service-product.yaml -n heikeji-mall
kubectl apply -f k8s/service-order.yaml -n heikeji-mall
kubectl apply -f k8s/service-pay.yaml -n heikeji-mall
kubectl apply -f k8s/service-marketing.yaml -n heikeji-mall
kubectl apply -f k8s/service-delivery.yaml -n heikeji-mall
kubectl apply -f k8s/service-logistics.yaml -n heikeji-mall
kubectl apply -f k8s/service-campus.yaml -n heikeji-mall
kubectl apply -f k8s/service-community.yaml -n heikeji-mall

# 部署前端服务
kubectl apply -f k8s/frontend.yaml -n heikeji-mall
```

### 3.1.5.4 服务部署最佳实践

1. **资源限制设置**
   - 合理设置CPU和内存请求和限制，避免资源争用
   - 对不同服务设置与其负载相匹配的资源限制
   - 示例：API网关通常需要更多内存，订单服务需要更多CPU

2. **健康检查配置**
   - 配置适当的readiness和liveness探针
   - 合理设置initialDelaySeconds，给服务足够的启动时间
   - 为不同服务设置合适的检查间隔

3. **水平扩展策略**
   - 根据服务特性设置合适的副本数
   - 考虑使用HorizontalPodAutoscaler实现自动扩缩容
   - 关键服务（如订单、支付）建议多副本部署

4. **服务优雅启动与终止**
   - 实现优雅关闭逻辑，处理正在进行的请求
   - 配置terminationGracePeriodSeconds确保服务有足够时间关闭

5. **配置管理**
   - 使用ConfigMap管理非敏感配置
   - 使用Secret管理敏感信息（密码、密钥等）
   - 考虑使用外部配置中心（如Nacos）实现动态配置更新

### 3.1.5.5 部署后验证

```bash
# 检查部署状态
kubectl get deployments -n heikeji-mall

# 检查Pod状态
kubectl get pods -n heikeji-mall

# 查看服务日志
kubectl logs -f <pod-name> -n heikeji-mall

# 验证服务可用性
kubectl run -it --rm --restart=Never test-pod --image=busybox -- wget -qO- http://api-gateway:80/actuator/health

# 检查服务访问
curl -X GET http://api.heikeji-mall.com/actuator/health
```

### 3.1.5.6 常见服务配置参数说明

#### 通用参数
- `SERVER_PORT`: 服务监听端口
- `LOG_LEVEL`: 日志级别（DEBUG, INFO, WARN, ERROR）
- `ENVIRONMENT`: 运行环境标识
- `METRICS_ENABLED`: 是否启用指标收集

#### 数据库参数
- `DB_TYPE`: 数据库类型（mysql, oracle等）
- `DB_URL`: 数据库连接URL
- `DB_USERNAME`: 数据库用户名
- `DB_PASSWORD`: 数据库密码
- `DB_MIN_IDLE`: 连接池最小空闲连接数
- `DB_MAX_POOL_SIZE`: 连接池最大连接数
- `DB_VALIDATION_TIMEOUT`: 连接验证超时时间

#### 缓存参数
- `CACHE_TYPE`: 缓存类型（redis, caffeine等）
- `REDIS_HOST`: Redis主机地址
- `REDIS_PORT`: Redis端口
- `REDIS_PASSWORD`: Redis密码
- `CACHE_TTL`: 缓存默认过期时间（秒）
- `CACHE_KEY_PREFIX`: 缓存键前缀

#### 服务发现与配置中心参数
- `NACOS_SERVER_ADDR`: Nacos服务器地址
- `NACOS_NAMESPACE`: 命名空间
- `NACOS_GROUP`: 配置分组
- `REGISTER_WITH_NACOS`: 是否注册到Nacos
- `DISCOVERY_ENABLED`: 是否启用服务发现

#### 安全参数
- `JWT_SECRET`: JWT签名密钥
- `JWT_EXPIRE_TIME`: JWT过期时间（秒）
- `ENCRYPT_ENABLED`: 是否启用加密
- `SSL_ENABLED`: 是否启用SSL

### 3.2 CI/CD配置

#### 3.2.1 Jenkins流水线配置

创建`Jenkinsfile`：

```groovy
pipeline {
    agent any
    
    stages {
        stage('拉取代码') {
            steps {
                checkout scm
            }
        }
        
        stage('构建后端') {
            steps {
                dir('heikeji-mall-service') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }
        
        stage('构建前端') {
            steps {
                dir('heikeji-frontend') {
                    sh 'npm install'
                    sh 'npm run build'
                }
                
                dir('heikeji-miniprogram') {
                    sh 'npm install'
                    sh 'npm run build:weapp'
                }
            }
        }
        
        stage('构建Docker镜像') {
            steps {
                // 构建后端服务镜像
                sh 'docker build -t heikeji/api-gateway:${BUILD_NUMBER} -f docker/api-gateway/Dockerfile .'
                sh 'docker build -t heikeji/service-user:${BUILD_NUMBER} -f docker/service-user/Dockerfile .'
                // ... 其他服务镜像
                
                // 构建前端镜像
                sh 'docker build -t heikeji/frontend:${BUILD_NUMBER} -f docker/frontend/Dockerfile .'
                
                // 推送镜像到镜像仓库
                sh 'docker push heikeji/api-gateway:${BUILD_NUMBER}'
                // ... 推送其他镜像
            }
        }
        
        stage('部署到Kubernetes') {
            steps {
                // 更新Kubernetes配置中的镜像版本
                sh 'sed -i "s|image: heikeji/api-gateway:.*|image: heikeji/api-gateway:${BUILD_NUMBER}|g" k8s/api-gateway.yaml'
                // ... 更新其他配置
                
                // 应用更新
                sh 'kubectl apply -f k8s/ -n heikeji-mall'
            }
        }
    }
    
    post {
        success {
            echo '部署成功!'
        }
        failure {
            echo '部署失败!'
        }
    }
}
```

## 4. 配置说明

### 4.1 后端服务配置

#### 4.1.1 Nacos配置中心

后端服务通过Nacos配置中心管理配置，主要配置文件包括：

- **application.yml**：公共配置
- **${service-name}-${profile}.yml**：各服务特定配置

关键配置项说明：

```yaml
# 数据库配置
spring:
  datasource:
    url: jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DATABASE}?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: ${MYSQL_USER}
    password: ${MYSQL_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver

# Redis配置
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT}
    password: ${REDIS_PASSWORD}
    database: 0

# Elasticsearch配置
  elasticsearch:
    uris: http://${ELASTICSEARCH_HOST}:${ELASTICSEARCH_PORT}

# Nacos配置
  cloud:
    nacos:
      discovery:
        server-addr: ${NACOS_HOST}:${NACOS_PORT}
      config:
        server-addr: ${NACOS_HOST}:${NACOS_PORT}
        file-extension: yml

# 微信配置
wechat:
  appid: ${WECHAT_APPID}
  secret: ${WECHAT_SECRET}

# 服务配置
server:
  port: ${SERVER_PORT}
  servlet:
    context-path: /api/v1
```

### 4.2 前端配置

#### 4.2.1 Web端配置

在`heikeji-frontend/.env`中配置：

```dotenv
# 开发环境
VITE_API_BASE_URL=http://localhost:8080/api/v1
VITE_APP_ENV=development

# 生产环境
VITE_API_BASE_URL=https://api.heikeji.com/v1
VITE_APP_ENV=production
```

#### 4.2.2 小程序配置

在`heikeji-miniprogram/src/config/index.js`中配置：

```javascript
export default {
  // API基础路径
  API_BASE_URL: process.env.NODE_ENV === 'production' 
    ? 'https://api.heikeji.com/v1' 
    : 'http://localhost:8080/api/v1',
  
  // 微信小程序配置
  WECHAT_APPID: 'your_appid',
  
  // 地图配置
  MAP_KEY: 'your_map_key',
  
  // 其他配置...
}
```

## 5. 数据库部署与初始化

### 5.1 MySQL数据库安装

#### 5.1.1 安装MySQL 8.0+

**Ubuntu 22.04 LTS：**

```bash
# 更新软件包索引
sudo apt update

# 安装MySQL服务器
sudo apt install -y mysql-server

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 运行安全脚本（设置root密码、移除匿名用户等）
sudo mysql_secure_installation
```

**CentOS Stream 9：**

```bash
# 安装MySQL服务器
sudo dnf install -y mysql-server

# 启动MySQL服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 获取临时密码并设置新密码
sudo grep 'temporary password' /var/log/mysql/mysqld.log
sudo mysql_secure_installation
```

#### 5.1.2 验证安装

```bash
# 检查MySQL服务状态
sudo systemctl status mysql

# 连接到MySQL
mysql -u root -p
```

### 5.2 数据库初始化

#### 5.2.1 创建数据库和用户

```sql
-- 创建数据库
CREATE DATABASE heikeji_mall CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建应用用户并授予权限
CREATE USER 'heikeji_app'@'%' IDENTIFIED BY 'StrongPassword123!';
GRANT ALL PRIVILEGES ON heikeji_mall.* TO 'heikeji_app'@'%';

-- 创建只读用户（用于报表和备份）
CREATE USER 'heikeji_readonly'@'%' IDENTIFIED BY 'ReadOnlyPassword456!';
GRANT SELECT ON heikeji_mall.* TO 'heikeji_readonly'@'%';

-- 创建监控用户
CREATE USER 'heikeji_monitor'@'%' IDENTIFIED BY 'MonitorPassword789!';
GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'heikeji_monitor'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

#### 5.2.2 执行数据库结构脚本

```bash
# 执行初始化脚本
mysql -u root -p heikeji_mall < sql/init.sql

# 验证表结构
mysql -u heikeji_app -p -e "USE heikeji_mall; SHOW TABLES;"
```

#### 5.2.3 导入测试数据（开发/测试环境）

```bash
# 导入测试数据
mysql -u heikeji_app -p heikeji_mall < sql/test_data.sql

# 验证数据导入
mysql -u heikeji_app -p -e "USE heikeji_mall; SELECT COUNT(*) FROM user;"
```

### 5.3 用户权限管理

#### 5.3.1 权限最佳实践

- **最小权限原则**：每个用户只授予其工作所需的最小权限
- **IP限制**：限制数据库用户的访问来源IP
- **定期轮换密码**：建议每90天更换一次数据库密码
- **避免使用root用户**：应用程序永远不要使用root用户连接数据库

#### 5.3.2 配置IP限制

```sql
-- 修改用户以限制IP访问
DROP USER 'heikeji_app'@'%';
CREATE USER 'heikeji_app'@'192.168.%.%' IDENTIFIED BY 'StrongPassword123!';
GRANT ALL PRIVILEGES ON heikeji_mall.* TO 'heikeji_app'@'192.168.%.%';
FLUSH PRIVILEGES;
```

#### 5.3.3 定期权限审计

```bash
# 查看所有用户权限
mysql -u root -p -e "SELECT user, host FROM mysql.user;"
mysql -u root -p -e "SHOW GRANTS FOR 'heikeji_app'@'192.168.%.%';"
```

### 5.4 MySQL配置优化

#### 5.4.1 基础配置优化

编辑MySQL配置文件（`/etc/mysql/mysql.conf.d/mysqld.cnf`或`/etc/my.cnf`）：

```ini
[mysqld]
# 基础设置
user = mysql
default_storage_engine = InnoDB
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 连接设置
max_connections = 1000
wait_timeout = 1800
interactive_timeout = 1800

# 缓冲池设置（建议设置为服务器内存的50%）
innodb_buffer_pool_size = 4G
innodb_buffer_pool_instances = 4

# 日志设置
log_error = /var/log/mysql/error.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 1

# 性能优化
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1
innodb_stats_on_metadata = 0
max_allowed_packet = 64M
query_cache_size = 0
query_cache_type = 0
```

重启MySQL服务使配置生效：

```bash
sudo systemctl restart mysql
```

#### 5.4.2 生产环境高级配置

```ini
# 事务隔离级别
transaction_isolation = READ-COMMITTED

# 二进制日志（用于主从复制和备份）
server-id = 1
enable_log_bin = 1
log_bin = /var/log/mysql/mysql-bin.log
expire_logs_days = 7
max_binlog_size = 100M

# 复制设置
binlog_format = ROW
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1

# 表空间加密（可选）
# encrypt-tables = ON
```

### 5.5 主从复制配置（生产环境）

#### 5.5.1 主服务器配置

在主服务器的MySQL配置文件中添加：

```ini
[mysqld]
server-id = 1
enable_log_bin = 1
log_bin = /var/log/mysql/mysql-bin.log
binlog_do_db = heikeji_mall
binlog_format = ROW
sync_binlog = 1
```

重启主服务器并创建复制用户：

```sql
-- 创建复制用户
CREATE USER 'replication_user'@'%' IDENTIFIED BY 'ReplicationPass123!';
GRANT REPLICATION SLAVE ON *.* TO 'replication_user'@'%';
FLUSH PRIVILEGES;

-- 锁定数据库（备份时使用）
FLUSH TABLES WITH READ LOCK;
SHOW MASTER STATUS;
-- 记录File和Position值，用于从服务器配置
```

#### 5.5.2 从服务器配置

在从服务器的MySQL配置文件中添加：

```ini
[mysqld]
server-id = 2
relay_log = /var/log/mysql/relay-bin.log
read_only = 1
```

重启从服务器并配置复制：

```sql
-- 配置主从复制
CHANGE MASTER TO
  MASTER_HOST='master_ip_address',
  MASTER_USER='replication_user',
  MASTER_PASSWORD='ReplicationPass123!',
  MASTER_LOG_FILE='mysql-bin.000001', -- 替换为主服务器SHOW MASTER STATUS显示的值
  MASTER_LOG_POS=156;

-- 启动复制
START SLAVE;

-- 检查复制状态
SHOW SLAVE STATUS\G;
```

### 5.6 数据库连接池配置

在应用程序中配置数据库连接池参数：

```yaml
# Spring Boot application.yml示例
spring:
  datasource:
    url: jdbc:mysql://mysql-host:3306/heikeji_mall?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: heikeji_app
    password: StrongPassword123!
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      validation-timeout: 5000
      connection-test-query: SELECT 1

## 6. 安全配置

### 6.1 HTTPS配置

在生产环境中，建议配置HTTPS：

1. 获取SSL证书
2. 配置Kubernetes Ingress或Nginx：

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: heikeji-ingress
  namespace: heikeji-mall
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.heikeji.com
    secretName: heikeji-tls
  rules:
  - host: api.heikeji.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-gateway
            port:
              number: 8080
```

### 6.2 接口限流配置

在Nginx或API网关中配置限流：

```yaml
# Sentinel限流配置
spring:
  cloud:
    sentinel:
      datasource:
        ds:
          nacos:
            server-addr: ${NACOS_HOST}:${NACOS_PORT}
            dataId: sentinel-rules
            groupId: DEFAULT_GROUP
            rule-type: flow
```

## 7. 监控与告警

### 7.1 监控体系架构

黑科易购项目采用多层次的监控体系，覆盖系统层、应用层、业务层和基础设施层，确保系统运行状态可观测、问题可快速定位。

#### 7.1.1 监控组件

| 组件名称 | 版本要求 | 部署方式 | 功能描述 |
|---------|---------|---------|--------|
| Prometheus | 2.40+ | Kubernetes Pod | 指标采集、存储和查询 |
| Grafana | 9.x+ | Kubernetes Pod | 可视化仪表盘、数据展示 |
| AlertManager | 0.25+ | Kubernetes Pod | 告警管理、通知分发 |
| Spring Boot Actuator | 与Spring Boot版本匹配 | 内嵌应用 | 应用指标暴露 |
| Micrometer | 1.10+ | 依赖库 | 指标收集抽象层 |

#### 7.1.2 监控数据流向

```
应用服务 → Micrometer → Prometheus Agent → Prometheus Server → Grafana
                                                          → AlertManager → 通知渠道
```

### 7.2 应用监控配置

#### 7.2.1 Spring Boot Actuator配置

确保每个服务都暴露了必要的监控端点：

```yaml
management:
  endpoints:
    web:
      exposure:
        include: ["health", "info", "prometheus", "metrics", "beans", "threaddump", "heapdump"]
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        "http.server.requests": true
      percentiles:
        "http.server.requests": [0.5, 0.95, 0.99]
```

#### 7.2.2 核心监控指标配置

##### 7.2.2.1 JVM指标

| 指标名称 | 描述 | 告警阈值 | 采集频率 | 重要性 |
|---------|------|---------|---------|-------|
| `jvm_memory_used_bytes{area="heap"}` | 堆内存使用量 | >85%持续5分钟 | 30秒 | 高 |
| `jvm_gc_collection_seconds_sum{gc="G1 Young Generation"}` | 新生代GC耗时 | >500ms/分钟 | 30秒 | 中 |
| `jvm_gc_collection_seconds_sum{gc="G1 Old Generation"}` | 老年代GC耗时 | >1000ms/分钟 | 30秒 | 高 |
| `jvm_threads_states_threads{state="blocked"}` | 阻塞线程数 | >10 | 30秒 | 高 |
| `process_cpu_usage` | CPU使用率 | >80%持续10分钟 | 30秒 | 高 |

##### 7.2.2.2 接口性能指标

| 指标名称 | 描述 | 告警阈值 | 采集频率 | 重要性 |
|---------|------|---------|---------|-------|
| `http_server_requests_seconds{quantile="0.95"}` | 95%接口响应时间 | >500ms持续3分钟 | 15秒 | 高 |
| `http_server_requests_seconds_count{status=~"5.."}` | 5xx错误请求数 | >5/分钟 | 15秒 | 高 |
| `http_server_requests_seconds_count{status=~"4.."}` | 4xx错误请求数 | >20/分钟 | 15秒 | 中 |
| `http_server_requests_seconds_count` | 总请求量 | 低于基线30%持续5分钟 | 15秒 | 高 |

##### 7.2.2.3 业务指标

| 指标名称 | 描述 | 告警阈值 | 采集频率 | 重要性 |
|---------|------|---------|---------|-------|
| `custom_business_orders_total` | 订单总量 | 低于基线40%持续10分钟 | 1分钟 | 高 |
| `custom_business_payment_success_rate` | 支付成功率 | <95%持续5分钟 | 1分钟 | 高 |
| `custom_business_user_login_total` | 用户登录量 | 低于基线50%持续10分钟 | 1分钟 | 中 |
| `custom_business_cart_operation_total` | 购物车操作量 | 异常突增200% | 1分钟 | 中 |

#### 7.2.3 Prometheus配置示例

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'spring-boot'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace]
        action: keep
        regex: heikeji-mall
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name

  - job_name: 'kubernetes-nodes'
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
```

### 7.3 告警配置

#### 7.3.1 AlertManager配置

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alerts@heikeji.com'
  smtp_auth_username: 'alerts@heikeji.com'
  smtp_auth_password: 'password'

route:
  group_by: ['alertname', 'job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 1h
  receiver: 'webhook-notifications'
  routes:
    - match:
        severity: critical
      receiver: 'critical-notifications'
      repeat_interval: 15m
    - match:
        severity: warning
      receiver: 'warning-notifications'
      repeat_interval: 30m

receivers:
- name: 'webhook-notifications'
  webhook_configs:
    - url: 'http://webhook-service:8080/alert'
      send_resolved: true

- name: 'critical-notifications'
  webhook_configs:
    - url: 'http://webhook-service:8080/critical'
      send_resolved: true
  email_configs:
    - to: 'ops@heikeji.com'
      send_resolved: true

- name: 'warning-notifications'
  webhook_configs:
    - url: 'http://webhook-service:8080/warning'
      send_resolved: true
  email_configs:
    - to: 'devops@heikeji.com'
      send_resolved: true

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
```

#### 7.3.2 告警规则配置

```yaml
# alert-rules.yml
groups:
- name: heikeji-mall-alerts
  rules:
  # JVM告警规则
  - alert: HighHeapUsage
    expr: sum(jvm_memory_used_bytes{area="heap"}) by (instance) / sum(jvm_memory_max_bytes{area="heap"}) by (instance) * 100 > 85
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "高堆内存使用率 ({{ $labels.instance }})"
      description: "堆内存使用率超过85% 已持续5分钟\n  当前值: {{ $value | printf \"%.2f\" }}%"

  - alert: HighCPULoad
    expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "高CPU负载 ({{ $labels.instance }})"
      description: "CPU使用率超过80% 已持续10分钟\n  当前值: {{ $value | printf \"%.2f\" }}%"

  # API性能告警
  - alert: SlowAPIResponses
    expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le, uri)) > 0.5
    for: 3m
    labels:
      severity: warning
    annotations:
      summary: "API响应缓慢 ({{ $labels.uri }})"
      description: "API {{ $labels.uri }} 95%响应时间超过500ms 已持续3分钟\n  当前值: {{ $value | printf \"%.3f\" }}s"

  - alert: HighErrorRate
    expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) by (instance, uri) / sum(rate(http_server_requests_seconds_count[5m])) by (instance, uri) * 100 > 5
    for: 2m
    labels:
      severity: critical
    annotations:
      summary: "高错误率 ({{ $labels.instance }})"
      description: "{{ $labels.uri }} 错误率超过5% 已持续2分钟\n  当前值: {{ $value | printf \"%.2f\" }}%"

  # 业务指标告警
  - alert: LowOrderVolume
    expr: sum(custom_business_orders_total[10m]) < on() group_left() (sum(custom_business_orders_total[10m] offset 1h) * 0.6)
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "订单量异常下降"
      description: "订单量较上一小时下降超过40% 已持续5分钟"

  - alert: LowPaymentSuccessRate
    expr: custom_business_payment_success_rate < 0.95
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "支付成功率异常"
      description: "支付成功率低于95% 已持续5分钟\n  当前值: {{ $value | printf \"%.2f\" }}%"
```

### 7.4 日志管理

#### 7.4.1 ELK日志收集配置

使用Filebeat收集容器日志并发送到Elasticsearch：

```yaml
# filebeat.yml
filebeat.inputs:
- type: docker
  containers.ids:
    - "*"
  processors:
    - add_kubernetes_metadata:
        host: ${NODE_NAME}
        matchers:
        - logs_path:
            logs_path: "/var/log/containers/"
    - decode_json_fields:
        fields: ["message"]
        target: "json"
        overwrite_keys: true
    - drop_fields:
        fields: ["stream", "input_type"]

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  indices:
    - index: "heikeji-mall-%{+YYYY.MM.dd}"
      when.contains:
        kubernetes.namespace: "heikeji-mall"
  pipeline: "heikeji-mall-pipeline"

setup.template:
  name: "heikeji-mall"
  pattern: "heikeji-mall-*"
  enabled: true

logging.level: info
```

#### 7.4.2 日志格式规范

应用日志应遵循以下格式：

```java
// 推荐的Logback配置
<configuration>
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
      <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg %X{traceId} %X{spanId}%n</pattern>
    </encoder>
  </appender>
  
  <root level="INFO">
    <appender-ref ref="CONSOLE" />
  </root>
</configuration>
```

### 7.5 Grafana仪表盘配置

#### 7.5.1 推荐的仪表盘

| 仪表盘名称 | 描述 | 导入ID/来源 |
|----------|------|------------|
| JVM (Micrometer) | JVM详细监控 | 4701 |
| Spring Boot 2.1 Statistics | Spring Boot应用统计 | 12900 |
| Kubernetes Cluster | K8s集群监控 | 10856 |
| MySQL Overview | MySQL数据库监控 | 7362 |
| Redis Dashboard | Redis监控 | 763 |
| API Performance | API性能监控 | 自定义 |
| Business Metrics | 业务指标监控 | 自定义 |

#### 7.5.2 业务监控仪表盘示例

创建以下JSON配置的业务监控仪表盘：

```json
{
  "dashboard": {
    "id": null,
    "title": "黑科易购业务监控",
    "panels": [
      {
        "title": "订单量统计",
        "type": "graph",
        "datasource": "Prometheus",
        "targets": [
          {
            "expr": "sum(increase(custom_business_orders_total[5m])) by (minute)",
            "legendFormat": "订单量"
          }
        ]
      },
      {
        "title": "支付成功率",
        "type": "gauge",
        "datasource": "Prometheus",
        "targets": [
          {
            "expr": "custom_business_payment_success_rate * 100",
            "legendFormat": "支付成功率"
          }
        ],
        "options": {
          "thresholds": [
            { "color": "green", "value": null },
            { "color": "orange", "value": 90 },
            { "color": "red", "value": 80 }
          ]
        }
      }
    ]
  }
}
```

### 7.6 监控最佳实践

1. **监控覆盖范围**：确保覆盖系统、应用、业务和基础设施四个层次
2. **告警阈值设置**：根据业务特点和历史数据设置合理的告警阈值
3. **告警分级**：实施P0-P3四级告警，不同级别采用不同的通知渠道和处理流程
4. **告警抑制**：配置合理的告警抑制规则，避免告警风暴
5. **定期检查**：每周审查监控覆盖情况和告警有效性
6. **性能基准**：建立关键指标的性能基准，用于异常检测
7. **监控演练**：定期进行监控告警演练，确保团队响应及时
8. **监控扩展**：根据业务发展持续扩展监控指标和覆盖范围

## 8. 常见问题与排查

### 8.1 服务启动失败

- 检查环境变量配置是否正确
- 检查数据库连接是否正常
- 检查Nacos服务是否可用
- 查看服务日志：`kubectl logs -f [pod-name] -n heikeji-mall`

### 8.2 接口访问超时

- 检查网络连接是否正常
- 检查数据库性能是否良好
- 检查Redis缓存是否正常工作
- 检查服务是否存在死锁或长时间阻塞的情况

### 8.3 数据库连接问题

- 确认数据库地址、端口、用户名和密码是否正确
- 检查数据库用户权限是否足够
- 检查数据库最大连接数设置是否合理

### 8.4 前端页面空白

- 检查API地址配置是否正确
- 检查CORS配置是否允许跨域访问
- 检查浏览器控制台是否有错误信息
- 检查前端资源是否正确加载

### 8.5 小程序授权失败

- 检查微信AppID和AppSecret是否正确
- 确认小程序已通过审核并发布
- 检查服务器域名是否已在小程序管理后台配置

## 9. 备份与恢复

### 9.1 数据库备份

定期执行数据库备份：

```bash
# 备份整个数据库
mysqldump -u root -p heikeji_mall > backup_$(date +%Y%m%d).sql

# 备份特定表
mysqldump -u root -p heikeji_mall user product order > backup_tables_$(date +%Y%m%d).sql
```

### 9.2 数据库恢复

```bash
mysql -u root -p heikeji_mall < backup_20240530.sql
```

### 9.3 配置文件备份

定期备份Nacos配置中心的配置：

```bash
# 使用Nacos API导出配置
curl -X GET "http://${NACOS_HOST}:${NACOS_PORT}/nacos/v1/cs/configs?dataId=service-user-dev.yml&group=DEFAULT_GROUP" > service-user-dev.yml
```

## 10. 性能优化建议

### 10.1 数据库优化

- 合理设计索引，避免全表扫描
- 使用连接池管理数据库连接
- 优化SQL查询，避免复杂查询
- 考虑分库分表策略应对大数据量

### 10.2 缓存优化

- 合理使用Redis缓存热点数据
- 设置适当的缓存过期时间
- 实现缓存预热机制
- 处理缓存穿透、缓存击穿和缓存雪崩问题

### 10.3 服务优化

- 合理设置JVM参数
- 实现异步处理机制
- 使用线程池管理并发任务
- 考虑服务拆分和水平扩展

### 10.4 前端优化

- 使用CDN加速静态资源加载
- 实现代码分割和懒加载
- 优化图片资源，使用WebP格式
- 使用本地存储缓存不常变化的数据

## 11. 附录

### 11.1 端口占用说明

| 服务/组件 | 端口 | 说明 |
|---------|-----|------|
| API网关 | 8080 | 服务访问入口 |
| MySQL | 3306 | 数据库服务 |
| Redis | 6379 | 缓存服务 |
| Elasticsearch | 9200 | 搜索服务 |
| Nacos | 8848 | 服务注册与配置中心 |
| RocketMQ | 9876 | 消息队列服务 |
| Prometheus | 9090 | 监控服务 |
| Grafana | 3000 | 监控可视化 |
| Kibana | 5601 | 日志可视化 |

### 11.2 常用命令

```bash
# 查看所有Pod状态
kubectl get pods -n heikeji-mall

# 查看服务日志
kubectl logs -f [pod-name] -n heikeji-mall

# 进入容器内部
kubectl exec -it [pod-name] -n heikeji-mall -- /bin/bash

# 重启服务
kubectl rollout restart deployment [deployment-name] -n heikeji-mall

# 查看服务状态
kubectl get svc -n heikeji-mall
```

### 11.3 支持与联系

- 技术支持邮箱：heikeji_tech@heuu.edu.cn
- 问题反馈：在系统内提交问题反馈或联系项目组

本部署和配置指南将根据项目进展持续更新，最终解释权归黑龙江科技大学黑科易购项目组所有。