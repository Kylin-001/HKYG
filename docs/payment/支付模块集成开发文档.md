# 支付模块与订单模块集成开发文档

## 1. 项目概述

本文档详细说明黑科易购项目中支付模块与订单模块的集成实现，包括订单创建、支付处理、订单状态更新、超时取消等核心功能的设计和实现。

## 2. 技术架构

### 2.1 模块划分

- **订单服务**：负责订单的创建、查询、更新、取消等核心业务逻辑
- **支付服务**：负责支付订单的创建、支付处理、回调通知、退款等功能
- **前端应用**：提供用户界面，调用后端API完成订单和支付相关操作

### 2.2 核心依赖

- Spring Boot
- MyBatis Plus
- Redis（用于缓存支付信息和分布式锁）
- Element UI（前端UI框架）
- Axios（前端HTTP客户端）

## 3. 订单状态定义

### 3.1 订单状态常量

```java
// 订单状态常量定义
public static final int ORDER_STATUS_PENDING_PAYMENT = 10; // 待付款
public static final int ORDER_STATUS_PAID = 20; // 已支付
public static final int ORDER_STATUS_PENDING_SHIP = 30; // 待发货
public static final int ORDER_STATUS_SHIPPED = 40; // 已发货
public static final int ORDER_STATUS_PENDING_RECEIVE = 50; // 待收货
public static final int ORDER_STATUS_COMPLETED = 60; // 已完成
public static final int ORDER_STATUS_CANCELLED = 70; // 已取消
public static final int ORDER_STATUS_REFUNDED = 80; // 已退款

// 外卖订单特有状态
public static final int ORDER_STATUS_TAKEOUT_WAITING = 21; // 待接单
public static final int ORDER_STATUS_TAKEOUT_PREPARING = 22; // 备餐中
public static final int ORDER_STATUS_TAKEOUT_DELIVERING = 23; // 配送中

// 支付状态常量
public static final int PAY_STATUS_UNPAID = 0; // 未支付
public static final int PAY_STATUS_PAID = 1; // 已支付
public static final int PAY_STATUS_FAILED = 2; // 支付失败

// 支付方式常量
public static final int PAY_METHOD_WECHAT = 1; // 微信支付
public static final int PAY_METHOD_ALIPAY = 2; // 支付宝
public static final int PAY_METHOD_BALANCE = 3; // 余额支付
```

## 4. 核心API接口

### 4.1 订单服务API

#### 创建订单

```java
Order createOrder(Order order);
Order createTakeoutOrder(Order order);
Order createDirectBuyOrder(Order order, Long productId, Integer quantity);
```

#### 支付相关

```java
String payOrder(String orderId, Integer paymentMethod);
String payOrder(String orderId, Integer paymentMethod, Long userId);
boolean handlePaymentCallback(String orderId, Integer payStatus, String transactionId, Date payTime);
boolean updatePayStatus(String orderId, Integer payStatus, String transactionId, Date payTime);
```

#### 订单管理

```java
boolean cancelOrder(String orderId, String reason, Long userId);
boolean confirmReceive(String orderId, Long userId);
List<Order> getPendingOrders();
int cancelTimeoutOrders();
```

### 4.2 前端API调用

#### order.js

```javascript
// 创建支付订单
export function createPayment(orderId, paymentMethod)
// 处理支付回调
export function handlePaymentCallback(params)
// 查询支付状态
export function getPaymentStatus(orderId)
// 创建直接购买订单并支付
export function createOrderAndPay(params)
// 创建外卖订单并支付
export function createTakeoutOrderAndPay(params)
// 取消超时订单（前端触发的检查）
export function checkTimeoutOrders()
```

#### payment.js

```javascript
// 获取支持的支付方式列表
export function getPaymentMethods()
// 微信支付相关API
export function createWechatPayment(orderId)
// 支付宝支付相关API
export function createAlipayPayment(orderId)
// 余额支付相关API
export function balancePayment(orderId, password)
// 支付记录相关API
export function getPaymentRecords(params)
// 支付退款相关API
export function applyRefund(orderId, params)
// 轮询支付结果
export function pollPaymentResult(orderId, interval, maxRetries)
```

## 5. 支付流程说明

### 5.1 普通订单支付流程

1. **创建订单**：用户确认订单信息后，调用`createOrder`创建订单
2. **发起支付**：前端调用`createPayment`或`payOrder`发起支付
3. **支付处理**：支付服务处理支付请求，生成支付链接或参数
4. **用户支付**：用户在支付平台完成支付
5. **支付回调**：支付平台通知系统支付结果，调用`handlePaymentCallback`
6. **状态更新**：系统更新订单状态为已支付（20）
7. **通知用户**：发送支付成功通知给用户

### 5.2 外卖订单支付流程

1. **创建外卖订单**：调用`createTakeoutOrder`创建外卖订单
2. **发起支付**：前端调用`createTakeoutOrderAndPay`发起支付
3. **支付处理**：同普通订单支付处理
4. **用户支付**：同普通订单
5. **支付回调**：同普通订单
6. **状态更新**：系统更新订单状态为待接单（21）
7. **通知商家**：通知商家有新订单需要接单

### 5.3 订单超时取消流程

1. **定时任务触发**：系统定时调用`cancelTimeoutOrders`方法
2. **查询超时订单**：查询超过30分钟未支付的订单
3. **取消订单处理**：将订单状态更新为已取消（70）
4. **发送通知**：通知用户订单已超时取消

## 6. 订单金额计算规则

### 6.1 普通订单金额计算

```java
// 普通订单金额计算逻辑
private BigDecimal calculateOrderAmount(List<OrderItem> orderItems) {
    BigDecimal totalAmount = BigDecimal.ZERO;
    for (OrderItem item : orderItems) {
        // 计算商品总价 = 商品单价 * 数量
        BigDecimal itemTotal = item.getPrice().multiply(new BigDecimal(item.getQuantity()));
        totalAmount = totalAmount.add(itemTotal);
    }
    return totalAmount;
}

// 应用优惠券
private BigDecimal applyCoupon(BigDecimal originalAmount, String couponCode) {
    // 简单实现：如果优惠码有效，减去10元
    if (StringUtils.isNotBlank(couponCode) && "DISCOUNT10".equals(couponCode)) {
        BigDecimal discount = new BigDecimal("10.00");
        return originalAmount.subtract(discount).max(BigDecimal.ZERO);
    }
    return originalAmount;
}
```

### 6.2 外卖订单金额计算

```java
// 计算配送费
private BigDecimal getDeliveryFee(String address) {
    // 简单实现：固定配送费5元
    return new BigDecimal("5.00");
}

// 外卖订单总金额 = 商品金额 + 配送费 - 优惠券
```

## 7. 错误处理机制

### 7.1 后端错误处理

- 订单不存在：返回404错误
- 订单状态不正确：返回400错误，说明当前订单状态不允许执行该操作
- 支付失败：记录失败原因，更新支付状态为失败（2），允许用户重新支付
- 系统错误：记录详细错误日志，返回500错误

### 7.2 前端错误处理

```javascript
// 请求拦截器中添加错误处理
// 支付相关错误特殊处理
if (error.config && error.config.url.includes('/order/pay')) {
    // 支付错误特殊处理
    if (error.response && error.response.status === 400) {
        Message.error('支付参数错误，请重新尝试');
    } else if (error.response && error.response.status === 409) {
        Message.error('订单状态已变更，请刷新页面后重试');
    } else {
        Message.error('支付请求失败，请稍后重试');
    }
}
```

## 8. 支付安全措施

1. **幂等性设计**：确保重复支付请求不会导致多次扣款
2. **数据校验**：严格校验订单金额、状态等关键信息
3. **事务处理**：支付状态更新和订单状态更新在同一事务中完成
4. **日志记录**：记录所有支付相关操作的详细日志，便于审计和问题排查
5. **超时处理**：设置合理的支付超时时间，避免订单长时间处于未支付状态

## 9. 测试说明

### 9.1 单元测试

- **OrderServiceImplTest**：测试订单创建、支付处理、金额计算等核心功能
- **重点测试场景**：
  - 订单金额计算
  - 支付订单功能
  - 支付回调处理
  - 订单超时取消
  - 取消订单与退款
  - 优惠券应用

### 9.2 集成测试

- **OrderPaymentIntegrationTest**：测试完整的订单支付流程
- **测试场景**：
  - 完整订单创建和支付流程
  - 订单取消和退款流程
  - 外卖订单支付流程
  - 支付失败处理
  - 订单超时自动取消

## 10. 部署与配置

### 10.1 配置项

- 订单超时时间：`order.timeout.minutes=30`
- 支付回调URL：`payment.callback.url=http://your-domain.com/order/pay/callback`
- 支付方式配置：微信支付、支付宝等配置信息

### 10.2 定时任务

- 订单超时检查：建议每5分钟执行一次
- 支付状态同步：建议每10分钟执行一次，确保订单状态与支付状态一致

## 11. 后续优化方向

1. **分布式事务**：引入分布式事务框架，确保订单与支付数据一致性
2. **支付重试机制**：完善支付失败自动重试机制
3. **支付方式扩展**：支持更多支付方式，如银联支付、Apple Pay等
4. **性能优化**：优化订单查询和支付处理性能
5. **风控系统**：引入风控系统，防止恶意支付和刷单行为

---

文档版本：v1.0
最后更新：2023年12月