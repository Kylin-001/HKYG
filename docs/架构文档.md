# 黑科易购项目架构文档

## 1. 项目概述

黑科易购是一个基于微服务架构的电子商务平台，提供商品浏览、搜索、下单、支付、物流跟踪等全流程购物服务。项目采用前后端分离架构，支持多端访问（PC、移动端）。

### 1.1 核心功能

- 用户管理：注册、登录、个人信息管理
- 商品管理：商品分类、商品列表、商品详情、搜索推荐
- 订单管理：购物车、下单、订单查询、订单状态管理
- 支付系统：多渠道支付（微信、支付宝）、退款管理
- 评价系统：商品评价、晒单分享
- 活动营销：优惠券、积分系统、促销活动
- 消息通知：站内信、邮件通知、短信提醒
- 用户行为分析：用户行为记录、统计分析、行为趋势、热门商品分析、用户活跃度、偏好分析、流失风险评估、群体行为分析、购买意向预测

## 2. 技术架构

### 2.1 整体架构

系统采用经典的微服务架构，分为前端层、API网关层、服务层、数据访问层和基础设施层。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                               前端层                                         │
│  ┌───────────────┐    ┌───────────────┐    ┌──────────────────────────────┐  │
│  │  管理后台 (Vue)│    │  PC门户 (Vue) │    │  移动端 (H5/小程序/App)        │  │
│  └───────────────┘    └───────────────┘    └──────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
┌─────────────────────────────────────────────────────────────────────────────┐
│                               API网关层                                      │
│                      ┌──────────────────────────────┐                        │
│                      │  Spring Cloud Gateway        │                        │
│                      │  (路由、限流、认证、熔断)      │                        │
│                      └──────────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
┌─────────────────────────────────────────────────────────────────────────────┐
│                               服务层                                         │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ 用户服务      │  │ 商品服务     │  │ 订单服务     │  │ 支付服务          │  │
│  └──────────────┘  └─────────────┘  └──────────────┘  └───────────────────┘  │
│                                                                             │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ 营销服务      │  │ 活动服务     │  │ 评价服务     │  │ 消息通知服务       │  │
│  └──────────────┘  └─────────────┘  └──────────────┘  └───────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据访问与共享层                                    │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ MySQL集群    │  │ Redis缓存    │  │ ElasticSearch│  │ 消息队列 (RabbitMQ) │  │
│  └──────────────┘  └─────────────┘  └──────────────┘  └───────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           基础设施与运维层                                    │
│  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│  │ Docker容器化 │  │ Kubernetes  │  │ CI/CD流水线   │  │ 监控告警系统       │  │
│  └──────────────┘  └─────────────┘  └──────────────┘  └───────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 技术栈选择

#### 后端技术栈

| 类别 | 技术 | 版本 | 用途 |
|-----|------|------|------|
| 核心框架 | Spring Boot | 2.7.x | 应用基础框架 |
| 微服务 | Spring Cloud | 2021.x | 微服务框架 |
| 服务注册发现 | Nacos | 2.0.x | 服务注册与配置中心 |
| API网关 | Spring Cloud Gateway | 3.x | 统一入口、路由转发 |
| 服务调用 | OpenFeign | 3.x | 声明式服务调用 |
| 负载均衡 | Ribbon | 3.x | 客户端负载均衡 |
| 断路器 | Hystrix | 1.5.x | 服务熔断、降级 |
| 分布式事务 | Seata | 1.5.x | 分布式事务协调 |
| ORM框架 | MyBatis-Plus | 3.5.x | 数据库访问增强 |
| 缓存 | Redis | 6.x | 缓存、会话存储 |
| 搜索引擎 | ElasticSearch | 7.x | 商品搜索、数据检索 |
| 消息队列 | RabbitMQ | 3.8.x | 异步消息处理 |
| 定时任务 | Quartz | 2.3.x | 定时任务调度 |
| 日志框架 | SLF4J + Logback | - | 日志记录 |
| 安全框架 | Spring Security + JWT | - | 认证授权 |

#### 前端技术栈

| 类别 | 技术 | 版本 | 用途 |
|-----|------|------|------|
| 前端框架 | Vue.js | 3.x | 前端开发框架 |
| UI组件库 | Element Plus | 2.x | UI组件 |
| 状态管理 | Vuex | 4.x | 全局状态管理 |
| 路由 | Vue Router | 4.x | 前端路由 |
| HTTP客户端 | Axios | 0.27.x | HTTP请求 |
| 构建工具 | Vite | 3.x | 快速构建工具 |

## 3. 模块划分

### 3.1 核心模块

- **heikeji-common**：公共模块，包含工具类、常量、异常定义等
  - **common-core**：核心公共组件
  - **common-db**：数据库相关公共组件
  - **common-security**：安全相关公共组件

- **heikeji-gateway**：API网关模块，负责请求路由、认证授权、限流等

- **heikeji-system**：系统管理模块，包含用户、角色、权限等基础功能

- **heikeji-auth**：认证授权模块，负责用户登录、JWT令牌生成等

- **heikeji-user**：用户管理模块，负责用户信息管理、用户行为分析等
  - **用户行为分析**：实现用户行为记录、统计分析、行为趋势、热门商品分析、用户活跃度评估、用户偏好分析、流失风险预测、群体行为分析和购买意向预测等功能，为平台提供数据支持和智能决策依据

- **heikeji-product**：商品管理模块，负责商品信息管理、商品搜索等

- **heikeji-order**：订单管理模块，负责订单创建、订单查询、订单状态流转等

- **heikeji-payment**：支付管理模块，负责支付渠道对接、支付结果处理等

- **heikeji-marketing**：营销活动模块，负责优惠券、促销活动管理等

- **heikeji-message**：消息通知模块，负责站内信、短信、邮件等通知

- **heikeji-evaluation**：评价管理模块，负责商品评价、晒单管理等

- **heikeji-frontend**：前端模块，包含PC端、移动端、管理后台等

## 4. 数据库设计

### 4.1 数据库选型

系统采用MySQL作为主数据库，ElasticSearch作为搜索引擎，Redis作为缓存数据库。

### 4.2 主数据库结构

主要数据表包括：

- **用户相关**：用户表(user)、用户地址表(user_address)、用户收藏表(user_collection)、用户行为表(user_behavior)等
- **商品相关**：商品分类表(category)、商品表(product)、商品SKU表(product_sku)、商品图片表(product_image)等
- **订单相关**：订单表(orders)、订单商品表(order_item)、订单日志表(order_log)等
- **支付相关**：支付记录表(payment_record)、支付渠道表(payment_channel)等
- **营销相关**：优惠券表(coupon)、用户优惠券表(user_coupon)、活动表(promotion_activity)等
- **评价相关**：商品评价表(product_review)、评价图片表(review_image)等

### 4.3 数据存储策略

- **分库分表**：对于大数据量表（如订单表、用户表）采用分库分表策略
- **读写分离**：实现数据库读写分离，提高系统吞吐量
- **缓存策略**：热点数据缓存、查询结果缓存、分布式锁等
- **数据同步**：MySQL与ElasticSearch之间的数据实时同步

## 5. 系统安全

### 5.1 认证授权

- **JWT认证**：无状态认证，便于水平扩展
- **权限控制**：基于RBAC的权限模型，细粒度权限控制
- **接口鉴权**：所有API接口必须经过认证授权才能访问
- **敏感操作验证**：重要操作需要二次验证（如修改密码、支付等）

### 5.2 数据安全

- **数据加密**：敏感数据（如密码、手机号）加密存储
- **接口防刷**：API接口限流、频率控制
- **SQL注入防护**：使用参数化查询、ORM框架
- **XSS防护**：输入验证、输出编码
- **CSRF防护**：使用Token验证

### 5.3 安全配置

- **HTTPS**：全站HTTPS加密传输
- **防火墙配置**：合理配置防火墙规则
- **定期安全扫描**：定期进行安全漏洞扫描和渗透测试

## 6. 系统扩展性设计

### 6.1 水平扩展

- **服务无状态化**：服务设计为无状态，便于水平扩展
- **数据库分库分表**：支持数据水平拆分
- **消息队列解耦**：使用消息队列实现异步处理，提高系统吞吐量

### 6.2 功能扩展

- **插件机制**：设计插件化架构，支持功能模块动态加载
- **事件驱动**：基于事件驱动的系统架构，便于功能扩展
- **接口标准化**：统一接口规范，便于集成第三方系统

## 7. 性能优化

### 7.1 缓存策略

- **多级缓存**：本地缓存 + Redis缓存
- **热点数据缓存**：商品详情、分类信息等热点数据缓存
- **缓存预热**：系统启动时加载热点数据到缓存
- **缓存更新策略**：合理设计缓存更新机制，保证数据一致性

### 7.2 数据库优化

- **索引优化**：合理设计数据库索引
- **慢查询优化**：定期分析并优化慢查询
- **连接池配置**：优化数据库连接池参数

### 7.3 代码优化

- **并发优化**：合理使用线程池、并行处理
- **算法优化**：优化关键算法，提高执行效率
- **资源复用**：对象池、连接池等资源复用机制

## 8. 系统部署架构

### 8.1 开发环境

- 本地开发环境，使用Docker容器化部署必要组件
- 开发调试工具：Swagger、Actuator等

### 8.2 测试环境

- 独立的测试环境，模拟生产环境配置
- 自动化测试工具集成

### 8.3 生产环境

- 高可用集群部署
- 负载均衡
- 数据库主从复制
- Redis集群
- 监控告警系统

## 9. 运维监控

### 9.1 监控体系

- **应用监控**：JVM监控、接口性能监控
- **系统监控**：服务器资源监控（CPU、内存、磁盘、网络）
- **业务监控**：核心业务指标监控（订单量、注册量、支付成功率等）
- **日志监控**：集中式日志收集与分析
- **链路追踪**：分布式调用链路追踪

### 9.2 告警机制

- **多渠道告警**：邮件、短信、企业微信等
- **告警级别**：根据严重程度设置不同级别的告警
- **告警抑制**：避免告警风暴

## 10. 后续优化方向

- 微服务架构进一步完善
- 用户行为分析功能深度优化（实时分析、更精确的预测模型）
- 大数据分析和商业智能功能增强
- 用户体验优化
- 性能进一步优化
- 安全性持续提升