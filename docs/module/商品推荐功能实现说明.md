# 商品推荐功能实现说明

## 功能概述

本项目实现了基于用户浏览历史和购买历史的个性化商品推荐功能，主要包含以下特性：

1. **用户浏览历史记录**：记录用户的商品浏览行为
2. **个性化推荐算法**：根据用户的浏览和购买历史推荐相关商品
3. **API接口支持**：提供通用推荐和个性化推荐的接口
4. **测试用例**：包含功能测试和性能测试

## 数据库设计

### 新增表：product_view_history

| 字段名 | 数据类型 | 描述 | 约束 |
|-------|---------|------|------|
| id | bigint | 主键ID | AUTO_INCREMENT |
| user_id | bigint | 用户ID | NOT NULL |
| product_id | bigint | 商品ID | NOT NULL |
| view_time | datetime | 浏览时间 | NOT NULL |
| view_count | int | 浏览次数 | DEFAULT 1 |
| create_time | datetime | 创建时间 | DEFAULT CURRENT_TIMESTAMP |
| update_time | datetime | 更新时间 | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP |

**唯一约束**：确保同一天内同一用户对同一商品的浏览记录唯一
**索引**：user_id、product_id、view_time上创建索引以提高查询效率

## 核心组件

### 1. 浏览历史相关

- `ProductViewHistory`：用户浏览历史实体类
- `ProductViewHistoryMapper`：数据访问接口
- `ProductViewHistoryService`：业务逻辑接口
- `ProductViewHistoryServiceImpl`：业务逻辑实现
- `ProductViewHistoryController`：API控制器

### 2. 个性化推荐相关

- `ProductMapper`：扩展了个性化推荐相关的数据库操作方法
- `ProductService`：添加了`getPersonalizedRecommendProductList`方法
- `ProductServiceImpl`：实现了个性化推荐算法
- `ProductController`：添加了个性化推荐API接口

## API接口说明

### 浏览历史接口

1. **记录商品浏览**
   - URL: `/product/view/record`
   - Method: POST
   - Params: `productId` (商品ID)
   - 返回：操作结果

2. **删除浏览记录**
   - URL: `/product/view/delete`
   - Method: DELETE
   - Params: `productId` (商品ID)
   - 返回：操作结果

3. **清空所有浏览记录**
   - URL: `/product/view/clear`
   - Method: DELETE
   - 返回：操作结果

### 推荐功能接口

1. **通用推荐商品列表**
   - URL: `/product/recommendList`
   - Method: GET
   - Params: `limit` (限制数量，默认6)
   - 返回：推荐商品列表

2. **个性化推荐商品列表**
   - URL: `/product/personalizedRecommendList`
   - Method: GET
   - Params: `limit` (限制数量，默认10), `userId` (用户ID，可选)
   - 返回：个性化推荐商品列表

## 推荐算法说明

个性化推荐算法的核心逻辑如下：

1. **数据收集**：
   - 获取用户最近浏览的商品ID列表
   - 获取用户浏览最多的商品分类ID列表
   - 获取用户购买过的商品分类
   - 获取用户购买过的商品ID列表

2. **数据处理**：
   - 合并浏览和购买的分类，优先显示浏览的分类
   - 合并已浏览和已购买的商品ID，用于排除推荐

3. **推荐生成**：
   - 根据用户感兴趣的分类推荐相关商品
   - 按相关性排序（分类匹配度、销量、是否推荐、更新时间）
   - 排除用户已浏览和购买过的商品

4. **兜底策略**：
   - 如果个性化推荐不足，补充通用推荐商品
   - 发生异常时返回通用推荐

## 性能优化

1. **索引优化**：在`product_view_history`表的关键字段上创建索引
2. **查询优化**：合理限制查询结果数量，避免大数据量返回
3. **异常处理**：发生异常时优雅降级为通用推荐
4. **数据合并**：优化分类和商品ID的合并逻辑

## 测试说明

### 功能测试

`ProductServiceImplTest`类包含以下测试用例：
- 通用推荐功能测试
- 个性化推荐功能测试
- 无用户ID的推荐测试
- 无效参数的推荐测试

### 性能测试

`ProductServicePerformanceTest`类包含以下测试用例：
- 通用推荐性能测试
- 个性化推荐性能测试
- 不同用户的推荐性能一致性测试
- 大批量请求的稳定性测试

## 使用建议

1. **前端集成**：
   - 在商品详情页调用浏览历史记录接口
   - 在首页和商品列表页调用个性化推荐接口
   - 根据用户登录状态决定是否传递userId参数

2. **性能监控**：
   - 建议在生产环境监控推荐接口的响应时间
   - 关注大数据量场景下的性能表现

3. **后续优化**：
   - 可以考虑添加缓存机制提高响应速度
   - 引入更复杂的推荐算法（如协同过滤）提升推荐精度
   - 增加用户行为数据的维度（如收藏、加购等）