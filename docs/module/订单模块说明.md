# 订单模块说明

## 1. 模块概述

订单模块是黑科易购项目的核心模块之一，负责处理订单的创建、支付、发货、确认收货等全流程管理。该模块与商品模块、用户模块、支付模块等多个模块紧密协作，形成完整的电商交易流程。

## 2. 核心功能

### 2.1 订单创建
- 从购物车选择商品创建订单
- 直接购买商品创建订单
- 订单信息填写（收货地址、支付方式、配送方式等）
- 订单金额计算（商品总价、运费、优惠折扣等）

### 2.2 订单支付
- 支持多种支付方式（微信支付、支付宝支付等）
- 支付状态查询和更新
- 支付超时处理
- 支付失败重试机制

### 2.3 订单管理
- 订单列表查询
- 订单详情查看
- 订单状态更新
- 订单取消
- 订单退款处理

### 2.4 订单配送
- 配送信息填写和更新
- 物流信息查询
- 发货处理
- 确认收货

### 2.5 订单售后
- 申请退款
- 申请退货
- 售后进度查询
- 售后纠纷处理

## 3. 订单状态流转

```
创建订单 → 待支付 → 待发货 → 待收货 → 待评价 → 已完成
         ↓        ↓        ↓        ↓        ↓
         已取消    已取消    已取消    已取消    已取消
         ↓        ↓        ↓        ↓        ↓
         退款中    退款中    退款中    退款中    售后中
```

## 4. 核心数据结构

### 4.1 订单表（order_info）

| 字段名 | 数据类型 | 描述 |
|--------|---------|------|
| id | bigint | 订单ID |
| order_sn | varchar(32) | 订单编号 |
| user_id | bigint | 用户ID |
| total_amount | decimal(10,2) | 订单总金额 |
| pay_amount | decimal(10,2) | 实际支付金额 |
| freight_amount | decimal(10,2) | 运费 |
| promotion_amount | decimal(10,2) | 优惠金额 |
| pay_type | tinyint | 支付方式（1：微信支付，2：支付宝支付） |
| order_status | tinyint | 订单状态（0：待支付，1：待发货，2：待收货，3：待评价，4：已完成，5：已取消） |
| pay_status | tinyint | 支付状态（0：未支付，1：已支付，2：支付失败） |
| consignee | varchar(64) | 收货人 |
| mobile | varchar(11) | 收货人手机号 |
| address | varchar(255) | 收货地址 |
| delivery_company | varchar(64) | 快递公司 |
| delivery_sn | varchar(64) | 快递单号 |
| create_time | datetime | 创建时间 |
| pay_time | datetime | 支付时间 |
| delivery_time | datetime | 发货时间 |
| receive_time | datetime | 收货时间 |
| cancel_time | datetime | 取消时间 |

### 4.2 订单项表（order_item）

| 字段名 | 数据类型 | 描述 |
|--------|---------|------|
| id | bigint | 订单项ID |
| order_id | bigint | 订单ID |
| sku_id | bigint | 商品SKU ID |
| product_id | bigint | 商品ID |
| product_name | varchar(255) | 商品名称 |
| product_pic | varchar(255) | 商品图片 |
| product_price | decimal(10,2) | 商品单价 |
| product_count | int | 商品数量 |
| product_sku_code | varchar(64) | 商品SKU编码 |
| product_category_id | bigint | 商品分类ID |
| sp1 | varchar(64) | 商品规格1 |
| sp2 | varchar(64) | 商品规格2 |
| sp3 | varchar(64) | 商品规格3 |
| category_name | varchar(64) | 商品分类名称 |
| promotion_amount | decimal(10,2) | 优惠金额 |
| coupon_amount | decimal(10,2) | 优惠券金额 |
| integration_amount | decimal(10,2) | 积分抵扣金额 |
| real_amount | decimal(10,2) | 实际支付金额 |

## 5. 核心API接口

### 5.1 订单创建
- **接口地址**：`/api/order/create`
- **请求方式**：POST
- **请求参数**：购物车商品列表、收货地址ID、支付方式ID、配送方式ID等
- **返回结果**：订单ID和订单编号

### 5.2 订单支付
- **接口地址**：`/api/order/pay/{orderId}`
- **请求方式**：POST
- **请求参数**：支付方式、支付金额等
- **返回结果**：支付链接或支付二维码

### 5.3 订单列表
- **接口地址**：`/api/order/list`
- **请求方式**：GET
- **请求参数**：订单状态、页码、每页数量等
- **返回结果**：订单列表

### 5.4 订单详情
- **接口地址**：`/api/order/{orderId}`
- **请求方式**：GET
- **返回结果**：订单详细信息

### 5.5 订单取消
- **接口地址**：`/api/order/cancel/{orderId}`
- **请求方式**：POST
- **返回结果**：取消结果

### 5.6 确认收货
- **接口地址**：`/api/order/confirm/{orderId}`
- **请求方式**：POST
- **返回结果**：确认结果

### 5.7 申请退款
- **接口地址**：`/api/order/refund/apply`
- **请求方式**：POST
- **请求参数**：订单ID、退款金额、退款原因等
- **返回结果**：退款申请结果

## 6. 模块间依赖关系

- **商品模块**：获取商品信息、库存检查、库存扣减
- **用户模块**：获取用户信息、收货地址信息
- **支付模块**：处理支付请求、查询支付状态
- **优惠券模块**：计算优惠金额、核销优惠券
- **积分模块**：积分抵扣、积分赠送
- **物流模块**：获取物流信息、更新物流状态

## 7. 性能优化

- **订单创建**：使用分布式事务确保订单数据一致性，同时使用异步处理非核心流程
- **订单查询**：使用索引优化查询性能，支持分页查询和条件过滤
- **库存扣减**：使用Redis分布式锁防止超卖，同时使用异步消息更新数据库库存
- **支付回调**：使用幂等设计确保支付回调的安全性和可靠性
- **订单状态更新**：使用消息队列异步更新订单状态，提高系统响应速度

## 8. 安全设计

- **订单数据加密**：敏感信息如收货人手机号、地址等进行加密存储
- **权限控制**：用户只能查询和操作自己的订单
- **防重复提交**：使用令牌机制防止订单重复创建
- **数据校验**：严格校验订单数据的合法性和完整性
- **日志记录**：记录所有订单操作日志，便于追溯和审计

## 9. 部署和运维

- **部署方式**：独立的微服务部署
- **数据库**：使用MySQL存储订单数据，支持主从复制和读写分离
- **缓存**：使用Redis缓存热点订单数据和订单统计信息
- **消息队列**：使用RabbitMQ处理订单相关的异步消息
- **监控**：使用Prometheus和Grafana监控订单模块的运行状态和性能指标
- **日志**：使用ELK Stack集中管理订单模块的日志

## 10. 未来规划

- 支持批量下单功能
- 支持订单拆分和合并
- 优化订单推荐算法
- 加强订单数据分析和统计功能
- 支持更多支付方式和配送方式
- 优化订单流程，提高用户体验