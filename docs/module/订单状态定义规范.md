# 订单状态定义规范

## 1. 概述

为了确保黑科易购项目中订单状态的一致性和准确性，特制定本订单状态定义规范。本规范详细定义了订单生命周期中各个状态的含义、触发条件和流转规则，适用于项目中的所有订单相关模块和功能。

## 2. 订单状态分类

订单状态分为以下几类：

- **基本状态**：订单从创建到完成的主要流转状态
- **支付状态**：订单支付相关的状态
- **配送状态**：订单配送相关的状态
- **售后状态**：订单售后相关的状态

## 3. 基本状态定义

| 状态值 | 状态名称 | 状态含义 | 触发条件 | 可执行操作 |
|--------|---------|---------|---------|----------|
| 0 | 待支付 | 订单已创建，等待用户支付 | 用户创建订单成功 | 支付订单、取消订单 |
| 1 | 待发货 | 订单已支付，等待商家发货 | 支付成功 | 催发货、申请退款 |
| 2 | 待收货 | 订单已发货，等待用户确认收货 | 商家发货成功 | 查看物流、确认收货、申请退款/退货 |
| 3 | 待评价 | 订单已收货，等待用户评价 | 用户确认收货成功 | 评价商品、申请售后 |
| 4 | 已完成 | 订单已完成，交易结束 | 用户评价完成或评价超时 | 查看订单、再次购买 |
| 5 | 已取消 | 订单已取消，交易终止 | 用户取消订单、支付超时、商家取消订单 | 查看订单 |

## 4. 支付状态定义

| 状态值 | 状态名称 | 状态含义 | 触发条件 |
|--------|---------|---------|---------|
| 0 | 未支付 | 订单尚未支付 | 订单创建成功 |
| 1 | 已支付 | 订单已成功支付 | 支付成功回调 |
| 2 | 支付中 | 支付请求已发送，等待支付结果 | 用户发起支付请求 |
| 3 | 支付失败 | 支付失败 | 支付失败回调或支付超时 |
| 4 | 退款中 | 退款申请已提交，等待处理 | 用户申请退款 |
| 5 | 已退款 | 退款成功 | 退款成功回调 |
| 6 | 退款失败 | 退款失败 | 退款失败回调 |

## 5. 配送状态定义

| 状态值 | 状态名称 | 状态含义 | 触发条件 |
|--------|---------|---------|---------|
| 0 | 待发货 | 等待商家发货 | 支付成功 |
| 1 | 已发货 | 商家已发货，等待物流配送 | 商家确认发货 |
| 2 | 配送中 | 商品正在配送途中 | 物流公司揽件 |
| 3 | 已签收 | 商品已被签收 | 物流公司确认签收 |
| 4 | 配送失败 | 配送失败 | 配送过程中出现问题 |

## 6. 售后状态定义

| 状态值 | 状态名称 | 状态含义 | 触发条件 |
|--------|---------|---------|---------|
| 0 | 无售后 | 订单未发起售后 | 订单创建成功 |
| 1 | 售后申请中 | 用户已提交售后申请，等待审核 | 用户提交售后申请 |
| 2 | 售后审核中 | 商家正在审核售后申请 | 商家开始审核售后申请 |
| 3 | 售后审核通过 | 售后申请审核通过，等待用户退货 | 商家审核通过售后申请 |
| 4 | 待商家收货 | 用户已退货，等待商家确认收货 | 用户填写退货物流信息 |
| 5 | 商家已收货 | 商家已收到退货，等待退款 | 商家确认收到退货 |
| 6 | 售后完成 | 售后已完成，退款成功 | 退款成功 |
| 7 | 售后拒绝 | 售后申请被拒绝 | 商家拒绝售后申请 |

## 7. 订单状态流转规则

### 7.1 基本状态流转

```
待支付 → 待发货 → 待收货 → 待评价 → 已完成
   ↑         ↑         ↑         ↑
   └─────────┴─────────┴─────────┴─────────→ 已取消
```

### 7.2 支付状态流转

```
未支付 → 支付中 → 已支付
   ↑         ↓
   └─────────→ 支付失败
已支付 → 退款中 → 已退款
         ↓
         退款失败
```

### 7.3 配送状态流转

```
待发货 → 已发货 → 配送中 → 已签收
         ↓
         配送失败
```

### 7.4 售后状态流转

```
无售后 → 售后申请中 → 售后审核中 → 售后审核通过 → 待商家收货 → 商家已收货 → 售后完成
                   ↓
                   售后拒绝
```

## 8. 状态更新机制

### 8.1 自动更新

- **支付超时**：订单创建后超过30分钟未支付，系统自动将订单状态更新为已取消
- **评价超时**：订单确认收货后超过7天未评价，系统自动将订单状态更新为已完成
- **物流状态同步**：系统定期从物流公司获取物流信息，自动更新订单配送状态

### 8.2 手动更新

- **用户操作**：用户可以进行支付、取消订单、确认收货、评价商品、申请售后等操作，手动触发订单状态更新
- **商家操作**：商家可以进行发货、取消订单、审核售后申请、确认收货等操作，手动触发订单状态更新
- **系统管理员操作**：系统管理员可以进行订单状态调整、售后处理等操作，手动触发订单状态更新

## 9. 状态查询接口

### 9.1 获取订单基本状态

- **接口地址**：`/api/order/status/{orderId}`
- **请求方式**：GET
- **返回结果**：订单基本状态、支付状态、配送状态、售后状态等

### 9.2 获取订单状态流转记录

- **接口地址**：`/api/order/status/log/{orderId}`
- **请求方式**：GET
- **返回结果**：订单状态流转的详细记录，包括状态变更时间、变更原因、操作人等

## 10. 状态管理规范

### 10.1 状态一致性

- 所有订单相关模块必须使用本规范定义的订单状态
- 订单状态的更新必须通过统一的状态管理服务进行，确保状态的一致性
- 订单状态的流转必须遵循本规范定义的流转规则，不得随意跳过或修改状态

### 10.2 状态日志

- 所有订单状态的变更必须记录详细的日志，包括状态变更时间、变更前后的状态、变更原因、操作人等
- 状态日志必须永久保存，便于追溯和审计

### 10.3 状态通知

- 订单状态变更时，必须及时通知相关方（用户、商家、系统管理员等）
- 通知方式包括短信、站内信、邮件等，根据订单重要程度和用户设置选择合适的通知方式

## 11. 异常处理

### 11.1 状态不一致处理

- 定期检查订单状态的一致性，发现不一致时及时修复
- 修复订单状态时，必须记录详细的修复日志和原因

### 11.2 状态流转异常处理

- 当订单状态流转出现异常时，系统自动触发告警，通知系统管理员
- 系统管理员及时处理异常，确保订单状态的正确性和一致性

## 12. 附则

### 12.1 规范的修订

- 本规范的修订必须经过项目技术委员会的批准
- 修订后的规范必须及时通知所有相关人员，并组织培训

### 12.2 规范的实施

- 本规范自发布之日起实施
- 所有订单相关的开发、测试和运维工作必须遵循本规范
- 对违反本规范的行为，项目技术委员会有权进行处罚

### 12.3 解释权

- 本规范的最终解释权归黑科易购项目技术委员会所有