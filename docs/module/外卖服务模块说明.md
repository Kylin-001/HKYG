# 外卖服务模块说明

## 1. 模块概述

外卖服务模块是黑科易购校园服务平台的核心功能模块之一，为黑龙江科技大学学生提供便捷的校园外卖服务。该模块支持三种灵活的配送方式：外卖柜配送、特殊地点配送和寝室配送，满足不同学生的需求。

## 2. 核心功能

### 2.1 订单管理
- **创建订单**：支持根据商品列表、配送方式等信息创建外卖订单
- **订单查询**：支持根据订单ID、用户ID查询订单详情
- **订单状态管理**：支持订单状态的更新和流转
- **取消订单**：支持用户取消未完成的订单

### 2.2 配送管理
- **外卖柜管理**：支持外卖柜的查询、分配和释放
- **配送方式选择**：支持三种配送方式（外卖柜、特殊地点、寝室）
- **配送轨迹跟踪**：支持订单配送状态的实时跟踪

### 2.3 商品管理
- **商品查询**：支持查询商家的商品列表
- **商品库存管理**：自动更新商品库存和销量
- **商品状态验证**：确保只有上架商品可以下单

### 2.4 支付管理
- **创建支付**：支持创建微信支付订单
- **支付状态查询**：支持查询订单支付状态
- **支付回调处理**：处理微信支付回调

## 3. 技术实现

### 3.1 技术栈
- **框架**：Spring Boot 2.7.x
- **ORM**：MyBatis Plus 3.5.x
- **缓存**：Redis
- **安全**：Spring Security + JWT
- **文档**：Swagger/OpenAPI 3.0

### 3.2 核心类和接口

#### 控制器层
- `TakeoutController`：外卖订单核心接口
- `DeliveryLockerController`：外卖柜管理接口
- `MerchantController`：商家管理接口
- `TakeoutProductController`：商品管理接口

#### 服务层
- `TakeoutService`：外卖订单核心服务
- `TakeoutOrderService`：外卖订单服务（兼容旧版本）
- `DeliveryLockerService`：外卖柜服务
- `PaymentService`：支付服务

#### 数据访问层
- `TakeoutOrderMapper`：订单数据访问
- `TakeoutOrderItemMapper`：订单商品数据访问
- `DeliveryLockerMapper`：外卖柜数据访问
- `TakeoutProductMapper`：商品数据访问

### 3.3 数据库结构

#### 核心表
- `takeout_order`：外卖订单主表
- `takeout_order_item`：外卖订单商品明细表
- `delivery_locker`：外卖柜表
- `takeout_product`：外卖商品表
- `takeout_delivery_track`：外卖配送轨迹表
- `merchant`：商家表

## 4. 业务流程

### 4.1 创建外卖订单流程
1. 用户选择商品和配送方式
2. 系统验证商家、商品、库存和价格
3. 计算订单总金额
4. 生成订单号
5. 创建订单记录
6. 创建订单商品记录
7. 更新商品库存和销量
8. 创建初始配送轨迹

### 4.2 订单状态流转
```
待接单 → 已接单 → 配送中 → 已送达
       ↓
       已取消
```

### 4.3 外卖柜使用流程
1. 用户选择外卖柜配送方式
2. 系统查询可用外卖柜
3. 用户选择合适的外卖柜
4. 系统分配外卖柜格口
5. 配送员将外卖放入指定格口
6. 用户凭取餐码取餐
7. 系统释放外卖柜格口

## 5. API接口

### 5.1 订单管理接口

#### 创建外卖订单
```
POST /api/takeout/order
Content-Type: application/json
Authorization: Bearer {token}

{
  "merchantId": 1,
  "deliveryType": 1,  // 1-外卖柜，2-特殊地点，3-送到寝室
  "deliveryLockerCode": "LOCKER001",  // 配送方式为1时必填
  "deliverySpecialPlace": "西区1号楼门口饮料机",  // 配送方式为2时必填
  "deliveryDormBuilding": "西区1号楼A栋",  // 配送方式为3时必填
  "deliveryDormRoom": "501",  // 配送方式为3时必填
  "receiverName": "张三",
  "receiverPhone": "13800138000",
  "receiverAddress": "黑龙江科技大学西区",
  "orderItems": [
    {
      "productId": 1,
      "quantity": 2,
      "price": 25.00
    }
  ],
  "remark": "不要辣"
}
```

#### 获取订单详情
```
GET /api/takeout/order/{id}
Authorization: Bearer {token}
```

#### 获取用户订单列表
```
GET /api/takeout/user/orders?userId={userId}&status={status}
Authorization: Bearer {token}
```

### 5.2 外卖柜管理接口

#### 获取可用外卖柜列表
```
GET /api/takeout/locker/available
```

#### 分配外卖柜格口
```
POST /api/takeout/locker/allocate?lockerCode={lockerCode}
```

#### 释放外卖柜格口
```
POST /api/takeout/locker/release?lockerCode={lockerCode}&cellNo={cellNo}
```

## 6. 配置说明

### 6.1 主要配置项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `takeout.order.expire-time` | 订单过期时间（分钟） | 30 |
| `takeout.locker.occupied-time` | 外卖柜占用时间（分钟） | 120 |
| `takeout.payment.timeout` | 支付超时时间（分钟） | 15 |

### 6.2 配置文件位置

各服务模块的配置文件位于 `src/main/resources/application.yml` 或对应的环境配置文件中。

## 7. 监控与日志

### 7.1 日志记录
- 订单操作日志：记录订单创建、状态变更等关键操作
- 支付日志：记录支付创建、回调等支付相关操作
- 外卖柜操作日志：记录外卖柜分配、释放等操作

### 7.2 监控指标
- 订单创建成功率
- 订单取消率
- 外卖柜使用率
- 订单配送时间
- 支付成功率

## 8. 扩展建议

1. **增加配送员评分系统**：允许用户对配送服务进行评分
2. **实现智能调度算法**：根据配送员位置、订单量等因素智能分配订单
3. **增加优惠券功能**：支持外卖订单使用优惠券
4. **实现预订单功能**：允许用户提前下单
5. **增加订单评价功能**：允许用户对订单进行评价

## 9. 常见问题

### 9.1 订单创建失败
- 检查商家是否存在
- 检查商品库存是否充足
- 检查配送方式是否合法
- 检查收货信息是否完整

### 9.2 外卖柜分配失败
- 检查外卖柜是否存在
- 检查外卖柜是否已满
- 检查外卖柜状态是否正常

### 9.3 支付失败
- 检查支付方式是否支持
- 检查用户支付账户余额是否充足
- 检查支付超时时间是否合理

## 10. 联系方式

如遇问题，请联系技术支持团队。
