# 黑科易购项目运维文档

## 1. 系统监控

### 1.1 监控体系架构

黑科易购项目采用多层次的监控体系，包括：

- **应用层监控**：JVM状态、接口性能、业务指标
- **系统层监控**：服务器CPU、内存、磁盘、网络
- **数据库监控**：MySQL性能、连接数、慢查询
- **中间件监控**：Redis、ElasticSearch、RabbitMQ状态
- **链路监控**：分布式调用链路追踪
- **业务监控**：核心业务指标、流量监控

### 1.2 监控工具

| 监控工具 | 用途 | 地址 |
|----------|------|------|
| Prometheus | 指标采集和存储 | http://prometheus.heikeji.com |
| Grafana | 可视化展示 | http://grafana.heikeji.com |
| Zipkin | 分布式链路追踪 | http://zipkin.heikeji.com |
| ELK Stack | 日志收集和分析 | http://kibana.heikeji.com |
| Spring Boot Admin | 应用状态监控 | http://admin.heikeji.com |

### 1.3 核心监控指标

#### 1.3.1 应用监控指标

- **JVM指标**：堆内存使用率、GC次数、GC耗时
- **线程指标**：活跃线程数、线程池状态
- **接口指标**：请求量、响应时间、错误率
- **业务指标**：QPS、TPS、订单量、注册量
- **用户行为指标**：页面浏览量、用户活跃度、商品收藏率、购买转化率

#### 1.3.2 系统监控指标

- **CPU使用率**：平均值、最大值、各核心使用率
- **内存使用率**：物理内存、交换内存使用率
- **磁盘使用率**：容量、IOPS、吞吐量
- **网络指标**：带宽使用率、连接数、流量

#### 1.3.3 数据库监控指标

- **连接数**：活跃连接、最大连接数、连接使用率
- **查询性能**：QPS、TPS、慢查询数量
- **缓冲池**：缓冲池命中率、大小
- **锁状态**：锁等待、死锁数量

## 2. 告警机制

### 2.1 告警策略

| 告警级别 | 描述 | 处理时间 | 通知方式 |
|----------|------|----------|----------|
| P0 | 系统完全不可用 | 立即处理 | 电话+短信+邮件+企业微信 |
| P1 | 核心功能不可用 | 1小时内 | 电话+短信+邮件+企业微信 |
| P2 | 重要功能受影响 | 4小时内 | 短信+邮件+企业微信 |
| P3 | 非核心功能异常 | 24小时内 | 邮件+企业微信 |
| P4 | 性能下降 | 下一工作日 | 邮件 |

### 2.2 常见告警项

#### 2.2.1 应用告警

- **应用宕机**：服务无心跳或无法正常响应
- **接口错误率过高**：错误率超过阈值（如5%）
- **响应时间过长**：平均响应时间超过阈值（如500ms）
- **JVM内存不足**：堆内存使用率超过90%
- **GC频繁**：Young GC频率或耗时异常

#### 2.2.2 系统告警

- **CPU使用率过高**：持续超过80%超过5分钟
- **内存不足**：内存使用率超过90%
- **磁盘空间不足**：磁盘使用率超过85%
- **磁盘IO异常**：IO等待时间过长
- **网络异常**：丢包率高或连接数过多

#### 2.2.3 数据库告警

- **数据库连接数过多**：接近最大连接数
- **慢查询数量异常**：短时间内慢查询激增
- **主从复制延迟**：延迟超过预设阈值
- **数据库负载过高**：CPU或IO使用率过高

### 2.3 告警处理流程

1. **告警触发**：监控系统检测到异常并触发告警
2. **告警通知**：通过配置的渠道发送告警通知
3. **告警确认**：运维人员确认接收告警
4. **问题诊断**：分析日志、监控数据，定位问题根源
5. **问题修复**：根据问题类型采取相应的修复措施
6. **验证恢复**：确认系统恢复正常
7. **告警关闭**：手动或自动关闭告警
8. **事后复盘**：记录问题原因和解决方案，更新运维手册

## 3. 日志管理

### 3.1 日志分类

- **应用日志**：应用运行日志，记录应用状态和错误信息
- **业务日志**：业务操作日志，记录重要的业务流程和操作
- **访问日志**：API访问日志，记录所有API请求和响应
- **错误日志**：错误信息汇总，便于问题排查
- **安全日志**：安全相关日志，记录认证、授权等操作

### 3.2 日志存储

- **本地存储**：应用服务器本地临时存储
- **集中存储**：使用ELK Stack进行集中式日志收集和存储
- **日志轮转**：配置合理的日志轮转策略，防止磁盘空间耗尽
- **日志保留**：
  - 生产环境：至少保留30天
  - 重要日志：保留90天或更长
  - 归档日志：定期归档到低成本存储

### 3.3 日志查询和分析

- **Kibana**：用于日志查询、可视化和分析
- **常用查询**：
  - 根据时间范围查询
  - 根据服务名、实例ID查询
  - 根据错误类型、关键字查询
  - 根据用户ID、订单ID等业务字段查询
- **日志分析**：
  - 错误趋势分析
  - 接口性能分析
  - 用户行为分析：页面浏览路径、商品点击分布、转化漏斗分析
  - 异常模式识别

### 3.4 日志清理

- **自动清理**：配置日志清理定时任务
- **清理策略**：
  - 按时间清理：超过保留期的日志自动清理
  - 按大小清理：当日志总量达到阈值时清理最旧的日志
  - 按级别清理：不同级别的日志采用不同的保留策略

## 4. 备份与恢复

### 4.1 数据备份策略

| 数据类型 | 备份频率 | 备份方式 | 保留周期 |
|----------|----------|----------|----------|
| 数据库全量 | 每日1次 | mysqldump | 7天 |
| 数据库增量 | 每小时1次 | binlog | 30天 |
| 用户行为数据 | 每日1次 | 独立备份 | 90天（用于长期分析） |
| 配置文件 | 每次变更 | 文件备份 | 90天 |
| 日志文件 | 每日1次 | 归档备份 | 30天 |
| 用户上传文件 | 每日1次 | 增量备份 | 90天 |

### 4.2 备份验证

- **定期测试**：每月至少进行一次备份恢复测试
- **验证内容**：
  - 备份文件完整性
  - 备份文件可恢复性
  - 恢复后数据一致性
  - 恢复时间是否在可接受范围内

### 4.3 数据恢复流程

#### 4.3.1 数据库恢复

1. **确认恢复需求**：明确需要恢复的时间点和范围
2. **停止相关服务**：暂停写入操作，避免数据冲突
3. **恢复全量备份**：
   ```bash
   mysql -u root -p < full_backup_20230615.sql
   ```
4. **恢复增量备份**：
   ```bash
   mysqlbinlog binlog.000001 binlog.000002 | mysql -u root -p
   ```
5. **验证数据**：确认数据一致性和完整性
6. **启动服务**：恢复服务并监控运行状态

#### 4.3.2 配置文件恢复

1. **备份当前配置**：
   ```bash
   cp -r /path/to/config /path/to/config.bak
   ```
2. **恢复备份文件**：
   ```bash
   cp -r /path/to/backup/config /path/to/config
   ```
3. **验证配置**：检查配置文件权限和内容
4. **重启服务**：使配置生效

## 5. 性能优化

### 5.1 应用性能优化

- **JVM调优**：
  - 合理设置堆内存大小
  - 选择合适的GC算法（G1GC）
  - 优化GC参数，减少停顿时间
  - 监控内存泄漏

- **线程池优化**：
  - 根据业务特点设置合理的线程池大小
  - 配置合适的队列容量
  - 设置合理的拒绝策略

- **代码优化**：
  - 避免不必要的对象创建
  - 优化循环和递归
  - 减少同步操作
  - 使用缓存减少数据库访问

### 5.2 数据库性能优化

- **索引优化**：
  - 为查询频繁的字段创建索引
  - 避免在索引字段上进行函数操作
  - 定期分析和优化索引
  - 为用户行为表的时间、用户ID、商品ID等字段创建复合索引

- **查询优化**：
  - 避免SELECT *
  - 优化JOIN查询
  - 使用分页查询
  - 避免在WHERE条件中使用!=、NOT IN等低效操作
  - 对用户行为分析的复杂查询使用物化视图或预计算

- **表结构优化**：
  - 合理设计表结构，避免过大的表
  - 对大表进行分表分库
  - 定期清理历史数据
  - 考虑将用户行为数据存储在专门的分析型数据库或数据仓库中

- **数据库配置优化**：
  - 调整缓冲池大小
  - 优化连接池参数
  - 调整日志配置

### 5.3 缓存优化

- **缓存策略**：
  - 热点数据缓存
  - 多级缓存（本地缓存+Redis）
  - 缓存预热
  - 缓存更新策略（主动更新、过期更新）

- **Redis优化**：
  - 合理设置过期时间
  - 使用合适的数据结构
  - 避免大key
  - 监控内存使用情况
  - 配置持久化策略

### 5.4 网络优化

- **CDN加速**：静态资源使用CDN分发
- **压缩传输**：启用gzip压缩
- **HTTP/2**：升级到HTTP/2
- **减少网络请求**：合并请求、使用缓存

## 6. 安全运维

### 6.1 日常安全检查

- **系统漏洞扫描**：每周进行一次漏洞扫描
- **依赖包检查**：定期检查第三方依赖的安全漏洞
- **安全日志审计**：分析登录失败、异常访问等日志
- **权限检查**：确认用户权限配置是否合理

### 6.2 安全加固

- **系统加固**：
  - 关闭不必要的服务和端口
  - 配置防火墙规则
  - 定期更新系统补丁
  - 禁用root远程登录

- **应用加固**：
  - 实施WAF（Web应用防火墙）
  - 防止SQL注入、XSS攻击
  - 实施接口限流
  - 敏感数据加密存储

- **数据库加固**：
  - 限制数据库访问IP
  - 配置最小权限账号
  - 启用SSL加密传输
  - 定期修改密码

### 6.3 安全应急响应

- **应急响应流程**：
  1. 安全事件发现和报告
  2. 初步评估和分析
  3. 遏制和隔离
  4. 消除威胁
  5. 系统恢复
  6. 事后分析和改进

- **常见安全事件处理**：
  - 暴力破解攻击：启用IP黑名单、验证码
  - 数据泄露：立即隔离、评估影响范围、通知相关方
  - DDoS攻击：启用流量清洗、配置防火墙规则
  - 恶意代码：隔离受感染服务器、清除恶意代码、加强监控

## 7. 定期维护

### 7.1 日常维护任务

| 维护内容 | 频率 | 负责人 |
|----------|------|--------|
| 监控系统检查 | 每日 | 运维工程师 |
| 日志查看和分析 | 每日 | 运维工程师 |
| 备份验证 | 每日 | 运维工程师 |
| 服务器资源监控 | 每日 | 运维工程师 |
| 安全日志审计 | 每日 | 安全工程师 |

### 7.2 周维护任务

| 维护内容 | 频率 | 负责人 |
|----------|------|--------|
| 系统漏洞扫描 | 每周 | 安全工程师 |
| 性能报告生成 | 每周 | 运维工程师 |
| 数据库性能分析 | 每周 | DBA |
| 服务可用性统计 | 每周 | 运维工程师 |

### 7.3 月度维护任务

| 维护内容 | 频率 | 负责人 |
|----------|------|--------|
| 备份恢复测试 | 每月 | 运维工程师 |
| 系统优化 | 每月 | 运维工程师 |
| 容量规划评估 | 每月 | 架构师 |
| 安全渗透测试 | 每月 | 安全工程师 |
| 运维文档更新 | 每月 | 运维工程师 |

### 7.4 季度维护任务

| 维护内容 | 频率 | 负责人 |
|----------|------|--------|
| 全系统压力测试 | 每季度 | 测试工程师 |
| 灾难恢复演练 | 每季度 | 运维团队 |
| 技术栈升级评估 | 每季度 | 架构师 |
| 全面安全评估 | 每季度 | 安全团队 |

## 8. 故障处理

### 8.1 常见故障类型及处理

#### 8.1.1 服务不可用

- **故障现象**：服务无响应或响应异常
- **可能原因**：
  - 服务崩溃
  - 资源耗尽（CPU/内存/磁盘）
  - 网络问题
  - 数据库连接问题
- **处理步骤**：
  1. 检查服务状态和日志
  2. 检查服务器资源使用情况
  3. 检查网络连接
  4. 检查数据库状态
  5. 必要时重启服务
  6. 分析根本原因并修复

#### 8.1.2 数据库连接失败

- **故障现象**：应用无法连接数据库
- **可能原因**：
  - 数据库服务宕机
  - 连接数超过限制
  - 网络问题
  - 权限问题
- **处理步骤**：
  1. 检查数据库服务状态
  2. 检查数据库连接数
  3. 检查网络连接
  4. 检查数据库用户权限
  5. 重启数据库服务（必要时）
  6. 调整连接池配置

#### 8.1.3 缓存服务异常

- **故障现象**：缓存读取或写入失败
- **可能原因**：
  - Redis服务宕机
  - 内存不足
  - 连接数过多
  - 配置错误
- **处理步骤**：
  1. 检查Redis服务状态
  2. 检查内存使用情况
  3. 检查连接数
  4. 重启Redis服务（必要时）
  5. 调整配置参数
  6. 验证数据一致性

#### 8.1.4 网络问题

- **故障现象**：服务间通信失败，网络延迟高
- **可能原因**：
  - 网络设备故障
  - 网络配置错误
  - 带宽饱和
  - 防火墙配置问题
- **处理步骤**：
  1. 检查网络设备状态
  2. 检查网络配置
  3. 监控网络流量
  4. 检查防火墙规则
  5. 联系网络管理员处理

### 8.2 故障处理流程

1. **故障发现**：通过监控告警、用户反馈等方式发现故障
2. **故障分级**：根据影响范围和严重程度进行分级
3. **故障定位**：收集信息、分析日志、排查问题
4. **应急处理**：采取临时措施恢复服务
5. **根本原因分析**：确定故障的根本原因
6. **永久修复**：实施永久性解决方案
7. **预防措施**：更新监控、完善流程、加强测试
8. **事后总结**：记录故障处理过程，更新知识库

## 9. 容量管理

### 9.1 容量规划

- **服务器容量**：
  - 根据业务增长预测服务器需求
  - 预留30%的容量余量
  - 考虑峰值流量

- **数据库容量**：
  - 监控数据增长趋势
  - 规划存储扩展方案
  - 考虑分库分表策略

- **带宽容量**：
  - 监控带宽使用情况
  - 根据流量增长预测带宽需求
  - 配置CDN减轻带宽压力

### 9.2 扩容策略

- **垂直扩容**：升级服务器配置（CPU、内存、磁盘）
- **水平扩容**：增加服务器数量，实现负载均衡
- **数据库扩容**：
  - 读写分离
  - 分库分表
  - 主从复制

- **扩容流程**：
  1. 评估扩容需求
  2. 制定扩容方案
  3. 准备扩容资源
  4. 执行扩容操作
  5. 验证扩容结果
  6. 监控系统性能

## 10. 版本管理与更新

### 10.1 版本控制

- **版本号格式**：X.Y.Z
  - X：主版本号，不兼容的API变更
  - Y：次版本号，向下兼容的功能性新增
  - Z：修订号，向下兼容的问题修正

- **版本发布流程**：
  1. 开发完成后提交代码
  2. 自动构建和测试
  3. 部署到测试环境
  4. 测试验证
  5. 准备发布版本
  6. 部署到生产环境
  7. 监控系统运行情况

### 10.2 灰度发布

- **灰度策略**：
  - 流量灰度：将部分用户流量引导到新版本
  - 区域灰度：先在特定区域部署新版本
  - 用户灰度：选择特定用户群体测试新版本

- **灰度流程**：
  1. 制定灰度计划
  2. 部署新版本（小比例）
  3. 监控关键指标
  4. 逐步扩大灰度比例
  5. 全量发布或回滚

### 10.3 回滚策略

- **回滚条件**：
  - 发现严重bug或性能问题
  - 业务指标异常下降
  - 系统稳定性受到影响

- **回滚流程**：
  1. 评估回滚影响
  2. 停止新版本部署
  3. 执行回滚操作
  4. 验证回滚结果
  5. 分析问题原因

## 11. 运维自动化

### 11.1 自动化部署

- **CI/CD流水线**：
  - 代码提交自动触发构建
  - 自动运行测试
  - 自动部署到测试环境
  - 手动/自动部署到生产环境

- **部署工具**：
  - Jenkins：持续集成/持续部署
  - Ansible：自动化配置和部署
  - Docker：容器化部署
  - Kubernetes：容器编排

### 11.2 自动化运维脚本

- **日常维护脚本**：
  - 服务状态检查脚本
  - 日志清理脚本
  - 备份验证脚本
  - 性能数据收集脚本

- **监控告警脚本**：
  - 自定义监控检查脚本
  - 告警通知脚本
  - 自动恢复脚本

### 11.3 配置管理

- **配置中心**：
  - 使用Nacos统一管理配置
  - 支持配置热更新
  - 版本控制和回滚
  - 环境隔离

- **配置变更流程**：
  1. 提交配置变更申请
  2. 审核变更内容
  3. 执行配置更新
  4. 验证更新效果
  5. 记录变更历史

## 12. 资源管理

### 12.1 服务器资源管理

- **资源分配原则**：
  - 按服务重要性分配资源
  - 考虑服务间资源隔离
  - 预留足够的资源余量

- **资源监控**：
  - 使用Prometheus监控资源使用情况
  - 设置资源使用告警阈值
  - 定期分析资源使用趋势

### 12.2 数据库资源管理

- **连接池管理**：
  - 合理设置连接池大小
  - 监控连接使用情况
  - 配置连接超时和最大生命周期

- **存储管理**：
  - 监控存储使用率
  - 规划存储空间扩展
  - 定期清理无效数据

### 12.3 中间件资源管理

- **缓存资源管理**：
  - 监控缓存命中率
  - 优化缓存配置
  - 处理缓存热点问题

- **消息队列管理**：
  - 监控队列积压情况
  - 配置合理的消费者数量
  - 处理消息重试和死信

## 13. 运维文档维护

### 13.1 文档更新流程

1. 收集文档更新需求
2. 编写或更新文档内容
3. 审核文档准确性
4. 发布更新后的文档
5. 通知相关人员

### 13.2 文档版本控制

- 文档与代码版本保持一致
- 记录文档修改历史
- 保留旧版本文档的归档

### 13.3 文档分类与索引

- 按功能模块分类
- 建立文档索引
- 提供文档搜索功能

## 14. 应急预案

### 14.1 系统崩溃应急预案

- **响应流程**：
  1. 确认系统崩溃范围和影响
  2. 启动备用系统或服务
  3. 恢复数据（必要时）
  4. 分析崩溃原因
  5. 修复并恢复主系统

### 14.2 数据丢失应急预案

- **响应流程**：
  1. 确认数据丢失范围和严重程度
  2. 从备份恢复数据
  3. 验证恢复的数据完整性
  4. 分析数据丢失原因
  5. 加强数据保护措施

### 14.3 大规模流量应急预案

- **响应流程**：
  1. 监控流量增长趋势
  2. 启动限流措施保护核心服务
  3. 扩容关键服务和资源
  4. 降级非核心功能
  5. 加强监控和告警

### 14.4 安全事件应急预案

- **响应流程**：
  1. 确认安全事件类型和影响范围
  2. 隔离受影响系统
  3. 收集证据并分析攻击来源
  4. 清除安全威胁
  5. 恢复系统正常运行
  6. 加强安全防护措施