# 黑科易购项目部署文档

## 1. 项目概述

黑科易购是一个基于微服务架构的校园电商平台，包含以下核心组件：

- **前端**：Vue.js 应用，位于 `heikeji-frontend` 目录
- **后端服务**：多个 Spring Boot 微服务，位于 `heikeji-mall-service` 目录
- **网关**：API 网关，位于 `heikeji-gateway` 目录
- **认证服务**：身份认证服务，位于 `heikeji-auth` 目录
- **数据库**：MySQL 8.3.x
- **缓存**：Redis 7.2.x
- **服务注册与配置中心**：Nacos 3.1.1
- **消息队列**：RabbitMQ 3.10.x
- **分布式链路追踪**：Zipkin 2.24.x

## 2. 部署方式选择

本项目支持两种部署方式，您可以根据实际需求选择：

| 部署方式 | 特点 | 适用场景 |
|---------|------|----------|
| **Docker Compose部署** | 一键部署所有服务，环境隔离，易于管理 | 推荐给所有用户，尤其是生产环境 |
| **传统部署** | 手动安装依赖，灵活性高 | 开发环境，学习目的 |

## 3. 部署环境准备

### 3.1 硬件要求

| 环境类型 | CPU | 内存 | 磁盘 | 网络 |
|---------|-----|------|------|------|
| 开发环境 | 4核+ | 8GB+ | 100GB+ SSD | 千兆网络 |
| 测试环境 | 8核+ | 16GB+ | 200GB+ SSD | 千兆网络 |
| 生产环境 | 16核+ | 32GB+ | 500GB+ SSD | 万兆网络 |

### 3.2 软件要求

| 软件 | 版本 | 用途 |
|------|------|------|
| JDK | 11+ | Java运行环境 |
| MySQL | 8.0+ | 主数据库 |
| Redis | 6.0+ | 缓存数据库 |
| ElasticSearch | 7.10+ | 搜索引擎 |
| RabbitMQ | 3.8+ | 消息队列 |
| Nacos | 2.0+ | 服务注册与配置中心 |
| Docker | 20.10+ | 容器化部署 |
| Kubernetes | 1.20+ | 容器编排（可选） |
| Nginx | 1.20+ | Web服务器/反向代理 |

### 3.3 软件安装命令

| 软件 | 版本 | 安装命令 |
|------|------|----------|
| OpenJDK | 17 | `sudo apt install openjdk-17-jdk` |
| Maven | 3.8.0+ | 见详细说明 |
| Node.js | 18.x+ | 见详细说明 |
| Docker | 20.10.x+ | `sudo apt install docker.io` |
| Docker Compose | 1.29.x+ | `sudo apt install docker-compose` |

## 4. 环境变量配置

### 4.1 环境变量文件说明

项目支持多环境配置，通过`.env`文件管理环境变量。主要环境配置文件包括：

- `.env`：通用环境变量
- `.env.dev`：开发环境配置
- `.env.test`：测试环境配置
- `.env.prod`：生产环境配置

### 4.2 配置文件优先级

环境变量加载优先级（从高到低）：

1. 命令行参数
2. 系统环境变量
3. `.env.{profile}`（特定环境配置）
4. `.env`（通用配置）

### 4.3 核心配置项说明

#### 数据库配置

```
# MySQL数据库配置
DB_HOST=数据库主机地址
DB_PORT=数据库端口
DB_NAME=数据库名称
DB_USERNAME=数据库用户名
DB_PASSWORD=数据库密码
```

#### Redis配置

```
REDIS_HOST=Redis主机地址
REDIS_PORT=Redis端口
REDIS_PASSWORD=Redis密码
REDIS_DATABASE=Redis数据库编号
```

#### 服务配置

```
# 服务端口
SERVER_PORT=8080
# 服务地址
SERVER_HOST=0.0.0.0
```

#### 安全配置

```
# JWT密钥
JWT_SECRET=密钥字符串
JWT_EXPIRATION=过期时间（毫秒）
# 安全盐值
SECURITY_SALT=盐值字符串
```

## 5. 部署方式

### 5.1 手动部署（传统部署）

#### 5.1.1 编译打包

```bash
# 克隆代码库
git clone https://github.com/your-org/heikeji-mall.git
cd heikeji-mall

# 编译打包
mvn clean package -DskipTests
```

#### 5.1.2 配置环境变量

```bash
# 复制环境变量文件
cp .env.example .env

# 根据实际环境修改.env文件
vim .env
```

#### 5.1.3 启动服务

```bash
# 启动服务（以用户服务为例）
java -jar heikeji-user/target/heikeji-user.jar
```

### 5.2 Docker部署

#### 5.2.1 构建Docker镜像

```bash
# 构建基础镜像
docker build -t heikeji-mall/base:latest .

# 构建各服务镜像（以用户服务为例）
cd heikeji-user
docker build -t heikeji-mall/user:latest .
```

#### 5.2.2 运行Docker容器

```bash
# 运行用户服务容器
docker run -d \
  --name heikeji-user \
  -p 8081:8080 \
  -v $(pwd)/.env:/app/.env \
  -v $(pwd)/logs:/app/logs \
  heikeji-mall/user:latest
```

### 5.3 Docker Compose部署（推荐）

#### 5.3.1 安装Docker和Docker Compose

```bash
# 更新软件包列表
sudo apt update

# 安装Docker
sudo apt install docker.io -y

# 安装Docker Compose
sudo apt install docker-compose -y

# 验证安装
docker --version
docker-compose --version

# 添加当前用户到docker组（避免每次使用sudo）
sudo usermod -aG docker $USER
newgrp docker  # 立即生效
```

#### 5.3.2 启动服务

```bash
# 进入项目根目录
cd /path/to/heikeji-mall

# 启动所有服务
docker-compose up -d

# 检查服务状态
docker-compose ps
```

#### 5.3.3 构建和部署应用服务

```bash
# 构建后端服务
mvn clean install '-Dmaven.test.skip=true'

# 启动后端服务
cd heikeji-mall-service
./start_services.sh

# 构建前端服务
cd ../heikeji-frontend
npm install
npm run build

# 配置Nginx
sudo cp ../nginx.conf /etc/nginx/conf.d/heikeji-mall.conf
sudo nginx -t
sudo systemctl restart nginx
```

### 5.4 Kubernetes部署

#### 5.4.1 创建Kubernetes配置文件

项目提供Kubernetes部署配置文件，位于`k8s/`目录下：

- `deployment.yaml`：部署配置
- `service.yaml`：服务配置
- `ingress.yaml`：入口配置
- `configmap.yaml`：配置映射
- `secret.yaml`：密钥配置

#### 5.4.2 应用Kubernetes配置

```bash
# 应用配置
kubectl apply -f k8s/

# 查看部署状态
kubectl get pods
```

## 6. 服务启动顺序

为确保系统正常运行，建议按照以下顺序启动服务：

1. **基础设施服务**：
   - MySQL
   - Redis
   - ElasticSearch
   - RabbitMQ
   - Nacos

2. **核心服务**：
   - heikeji-auth（认证服务）
   - heikeji-system（系统服务）
   - heikeji-user（用户服务）
   - heikeji-product（商品服务）

3. **业务服务**：
   - heikeji-order（订单服务）
   - heikeji-payment（支付服务）
   - heikeji-marketing（营销服务）
   - heikeji-evaluation（评价服务）
   - heikeji-message（消息服务）

4. **网关服务**：
   - heikeji-gateway（API网关）

5. **前端服务**：
   - heikeji-frontend（前端应用）

## 7. 自动部署脚本使用

项目提供了自动化部署脚本，简化部署流程：

### 7.1 Linux/Mac部署脚本

```bash
# 赋予执行权限
chmod +x deploy.sh

# 执行部署脚本
./deploy.sh [环境] [服务名]
# 例如：部署开发环境的用户服务
./deploy.sh dev user
```

### 7.2 Windows部署脚本

```batch
# 执行部署脚本
deploy.bat [环境] [服务名]
# 例如：部署开发环境的用户服务
deploy.bat dev user
```

## 8. 数据库初始化

### 8.1 执行数据库脚本

```bash
# 使用MySQL客户端执行初始化脚本
mysql -u username -p database_name < sql/init.sql
```

### 8.2 数据迁移

系统支持使用Flyway进行数据库版本管理：

```bash
# 执行数据迁移
mvn flyway:migrate
```

### 8.3 传统部署数据库初始化

```bash
# 创建数据库
mysql -u root -p -e "CREATE DATABASE heikeji_mall CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

# 导入数据
mysql -u root -p heikeji_mall < full_db.sql
```

## 9. 监控与日志

### 9.1 监控配置

系统集成了Prometheus和Spring Boot Actuator进行监控：

```bash
# 访问监控端点
http://localhost:8080/actuator
http://localhost:9090/ # Prometheus
```

### 9.2 日志配置

日志文件默认位于`./logs`目录下，主要日志文件包括：

- `app.log`：应用日志
- `error.log`：错误日志
- `business.log`：业务日志
- `access.log`：访问日志

### 9.3 日志级别调整

可通过环境变量调整日志级别：

```
LOG_LEVEL=INFO # 可选值：DEBUG, INFO, WARN, ERROR
```

## 10. 常见问题与解决方案

### 10.1 启动失败

- **端口被占用**：修改服务端口或关闭占用端口的进程
- **数据库连接失败**：检查数据库配置和网络连接
- **依赖服务不可用**：确保所有依赖服务已启动

### 10.2 性能问题

- **数据库性能**：检查慢查询日志，优化索引
- **缓存命中率低**：调整缓存策略，增加缓存预热
- **JVM参数不合理**：优化JVM参数配置

### 10.3 安全问题

- **敏感信息泄露**：确保敏感配置使用环境变量或加密存储
- **权限控制不当**：检查权限配置，确保最小权限原则
- **接口安全**：实施接口限流，防止恶意请求

### 10.4 MySQL问题

| 问题 | 解决方案 |
|------|----------|
| 无法启动MySQL | 查看日志：`journalctl -xeu mysql` |
| 身份认证失败 | 参考MYSQL_AUTHENTICATION_SOLUTION.md |
| 密码忘记 | 参考MySQL密码重置文档 |

### 10.5 服务注册失败

| 问题 | 解决方案 |
|------|----------|
| Nacos注册失败 | 检查Nacos服务是否启动，配置文件中的地址是否正确 |
| 服务间通信失败 | 检查网络配置，确保服务在同一网络中 |

### 10.6 前端问题

| 问题 | 解决方案 |
|------|----------|
| 无法访问前端 | 检查Nginx配置和日志 |
| 前端无法调用API | 检查Nginx反向代理配置，后端服务是否启动 |
| 静态资源加载失败 | 检查静态资源路径配置 |

### 10.7 端口冲突

```bash
# 查看端口占用情况
netstat -tuln | grep [port]

# 查找占用端口的进程
lsof -i :[port]

# 终止占用端口的进程
kill -9 [pid]
```

## 11. 滚动更新

### 11.1 蓝绿部署

```bash
# 部署新版本服务
./deploy.sh prod user new

# 验证新版本
curl http://localhost:8081/actuator/health

# 切换流量（修改负载均衡配置）
# 回滚（如遇问题）
./deploy.sh prod user rollback
```

### 11.2 金丝雀发布

```bash
# 部署金丝雀版本
./deploy.sh prod user canary

# 逐步增加流量比例
# 监控系统状态
# 全部切换或回滚
```

## 12. 备份与恢复

### 12.1 数据库备份

```bash
# 创建备份目录
mkdir -p /opt/backup

# 备份数据库
mysqldump -u root -p heikeji_mall > /opt/backup/heikeji_mall_$(date +%Y%m%d).sql

# 压缩备份文件
gzip /opt/backup/heikeji_mall_$(date +%Y%m%d).sql
```

### 12.2 数据恢复

```bash
# 恢复数据库
mysql -u username -p database_name < backup_file.sql
```

### 12.3 配置备份

```bash
# 备份配置文件
tar -czvf config_backup_$(date +%Y%m%d).tar.gz .env*
```

## 13. 服务降级与熔断测试

### 13.1 手动触发熔断

```bash
# 模拟服务压力，触发熔断
ab -n 10000 -c 100 http://localhost:8080/api/user/list
```

### 13.2 验证降级策略

```bash
# 检查服务是否正常降级
curl -v http://localhost:8080/api/user/detail/1
```

## 14. 服务访问地址

| 服务 | 访问地址 | 用户名/密码 |
|------|----------|-------------|
| 前端 | http://localhost | - |
| Nacos 控制台 | http://localhost:8848/nacos | nacos/nacos |
| RabbitMQ 控制台 | http://localhost:15672 | guest/guest |
| Zipkin 控制台 | http://localhost:9411/zipkin | - |
| Swagger 文档 | http://localhost:8080/swagger-ui.html | - |

## 15. 常用命令

### 15.1 Docker Compose命令

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose down

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f [service-name]

# 重启服务
docker-compose restart [service-name]
```

### 15.2 后端服务命令

```bash
# 查看后端服务进程
ps -ef | grep java

# 停止所有后端服务
ps -ef | grep java | grep -v grep | awk '{print $2}' | xargs kill -9

# 查看服务日志
tail -f heikeji-mall-service/[service-name].log
```

### 15.3 系统服务命令

```bash
# 查看MySQL状态
sudo systemctl status mysql

# 重启MySQL
sudo systemctl restart mysql

# 查看Nginx状态
sudo systemctl status nginx

# 重启Nginx
sudo systemctl restart nginx
```

## 16. 监控与维护

### 16.1 系统监控

- 使用 `htop` 查看系统资源使用情况
- 使用 `iotop` 查看磁盘I/O情况
- 使用 `vmstat` 查看系统状态

### 16.2 日志管理

- 后端服务日志：`heikeji-mall-service/[service-name].log`
- Nginx日志：`/var/log/nginx/`
- MySQL日志：`/var/log/mysql/`

## 17. 版本更新

### 17.1 后端更新

```bash
# 拉取最新代码
git pull

# 停止当前服务
ps -ef | grep java | grep -v grep | awk '{print $2}' | xargs kill -9

# 重新构建
mvn clean install '-Dmaven.test.skip=true'

# 启动服务
cd heikeji-mall-service
./start_services.sh
```

### 17.2 前端更新

```bash
# 拉取最新代码
git pull

# 重新构建
cd heikeji-frontend
npm install
npm run build

# 重启Nginx
sudo systemctl restart nginx
```

## 18. 部署优化建议

### 18.1 生产环境优化

1. **使用优化后的部署文件**：参考DEPLOYMENT_OPTIMIZATION.md
2. **配置HTTPS**：为Nginx添加SSL证书
3. **启用防火墙**：配置ufw或firewalld
4. **设置日志轮转**：配置logrotate管理日志文件
5. **监控告警**：集成Prometheus和Grafana

### 18.2 性能优化

1. **数据库优化**：添加索引，优化查询
2. **Redis缓存**：合理使用缓存，减少数据库压力
3. **服务集群**：对核心服务进行集群部署
4. **负载均衡**：使用Nginx或其他负载均衡器
5. **CDN加速**：静态资源使用CDN加速

## 19. 部署检查清单

部署完成后，请检查以下内容：

- [ ] 所有服务是否正常启动
- [ ] 数据库连接是否正常
- [ ] 缓存服务是否可用
- [ ] 监控系统是否正常工作
- [ ] 日志是否正常输出
- [ ] API接口是否可正常访问
- [ ] 安全配置是否正确
- [ ] 性能指标是否在合理范围内