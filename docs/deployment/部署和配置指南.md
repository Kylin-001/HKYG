# 黑科易购项目部署和配置指南

## 1. 项目概述

黑科易购是一个基于微服务架构的校园电商平台，包含以下核心组件：

- **前端**：Vue.js 应用，位于 `heikeji-frontend` 目录
- **后端服务**：多个 Spring Boot 微服务，位于 `heikeji-mall-service` 目录
- **网关**：API 网关，位于 `heikeji-gateway` 目录
- **认证服务**：身份认证服务，位于 `heikeji-auth` 目录
- **数据库**：MySQL 数据库，位于 `sql` 目录下的 SQL 文件
- **缓存**：Redis 缓存
- **消息队列**：RabbitMQ
- **服务注册与配置中心**：Nacos
- **分布式事务管理器**：Seata

## 2. 部署环境准备

### 2.1 硬件要求

| 环境类型 | CPU | 内存 | 磁盘 | 网络 |
|---------|-----|------|------|------|
| 开发环境 | 4核+ | 8GB+ | 100GB+ SSD | 千兆网络 |
| 测试环境 | 8核+ | 16GB+ | 200GB+ SSD | 千兆网络 |
| 生产环境 | 16核+ | 32GB+ | 500GB+ SSD | 千兆网络 |

### 2.2 软件要求

| 软件 | 版本 | 用途 |
|------|------|------|
| JDK | 11+ | 运行 Java 应用 |
| Maven | 3.6+ | 构建 Java 项目 |
| Node.js | 14+ | 运行前端项目 |
| npm | 6+ | 管理前端依赖 |
| MySQL | 8.0+ | 数据库 |
| Redis | 6.0+ | 缓存 |
| RabbitMQ | 3.8+ | 消息队列 |
| Nacos | 2.0+ | 服务注册与配置中心 |
| Seata | 1.4+ | 分布式事务管理器 |
| Docker | 20.0+ | 容器化部署 |
| Docker Compose | 1.28+ | 编排容器 |

### 2.3 系统环境配置

#### 2.3.1 Linux 系统配置

1. **关闭防火墙**（开发环境，生产环境建议配置防火墙规则）
   ```bash
   systemctl stop firewalld
   systemctl disable firewalld
   ```

2. **关闭 SELinux**
   ```bash
   setenforce 0
   sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
   ```

3. **配置系统参数**
   ```bash
   # 编辑 /etc/sysctl.conf 文件，添加以下内容
   net.core.somaxconn = 65535
   net.ipv4.tcp_max_syn_backlog = 65535
   net.ipv4.tcp_fin_timeout = 30
   net.ipv4.tcp_tw_reuse = 1
   net.ipv4.tcp_tw_recycle = 1
   vm.swappiness = 0
   
   # 使配置生效
   sysctl -p
   ```

4. **配置资源限制**
   ```bash
   # 编辑 /etc/security/limits.conf 文件，添加以下内容
   * soft nofile 65535
   * hard nofile 65535
   * soft nproc 65535
   * hard nproc 65535
   ```

## 3. 基础服务部署

### 3.1 MySQL 部署

1. **使用 Docker 部署 MySQL**
   ```bash
   docker run -d \
     --name mysql \
     -p 3306:3306 \
     -e MYSQL_ROOT_PASSWORD=root123 \
     -e MYSQL_DATABASE=heikeji_mall \
     -v mysql_data:/var/lib/mysql \
     mysql:8.0
   ```

2. **导入初始数据**
   ```bash
   # 进入项目根目录
   cd /home/heikeji/heikeji-mall
   
   # 导入数据库结构
   mysql -h localhost -u root -proot123 heikeji_mall < sql/heikeji_mall.sql
   
   # 导入初始数据
   mysql -h localhost -u root -proot123 heikeji_mall < sql/heikeji_mall_data.sql
   ```

### 3.2 Redis 部署

1. **使用 Docker 部署 Redis**
   ```bash
   docker run -d \
     --name redis \
     -p 6379:6379 \
     -v redis_data:/data \
     redis:6.0 --requirepass redis123
   ```

### 3.3 RabbitMQ 部署

1. **使用 Docker 部署 RabbitMQ**
   ```bash
   docker run -d \
     --name rabbitmq \
     -p 5672:5672 \
     -p 15672:15672 \
     -v rabbitmq_data:/var/lib/rabbitmq \
     rabbitmq:3.8-management
   ```

2. **配置 RabbitMQ**
   - 访问 http://localhost:15672，使用默认用户名 `guest` 和密码 `guest` 登录
   - 创建虚拟主机 `heikeji_mall`
   - 创建用户 `heikeji`，密码 `heikeji123`，并授权访问 `heikeji_mall` 虚拟主机

### 3.4 Nacos 部署

1. **使用 Docker 部署 Nacos**
   ```bash
   docker run -d \
     --name nacos \
     -p 8848:8848 \
     -e MODE=standalone \
     -e SPRING_DATASOURCE_PLATFORM=mysql \
     -e MYSQL_SERVICE_HOST=localhost \
     -e MYSQL_SERVICE_PORT=3306 \
     -e MYSQL_SERVICE_DB_NAME=nacos \
     -e MYSQL_SERVICE_USER=root \
     -e MYSQL_SERVICE_PASSWORD=root123 \
     -v nacos_data:/home/nacos/data \
     nacos/nacos-server:2.0.3
   ```

2. **初始化 Nacos 数据库**
   - 创建名为 `nacos` 的数据库
   - 导入 Nacos 初始数据，文件位于 `nacos/conf/nacos-mysql.sql`（需从 Nacos 官方仓库下载）

### 3.5 Seata 部署

1. **使用 Docker 部署 Seata**
   ```bash
   docker run -d \
     --name seata \
     -p 8091:8091 \
     -v seata_data:/seata-server/data \
     seataio/seata-server:1.4.2
   ```

2. **配置 Seata**
   - 编辑 `registry.conf` 文件，配置 Nacos 注册中心
   - 编辑 `file.conf` 文件，配置数据库和存储模式

## 4. 后端服务部署

### 4.1 构建后端服务

1. **进入后端服务目录**
   ```bash
   cd /home/heikeji/heikeji-mall/heikeji-mall-service
   ```

2. **构建所有服务**
   ```bash
   mvn clean package -DskipTests
   ```

### 4.2 部署单个服务

以 `service-product` 为例：

1. **创建服务目录**
   ```bash
   mkdir -p /opt/heikeji-mall/service-product
   ```

2. **复制 jar 包和配置文件**
   ```bash
   cp service-product/target/service-product-1.0.0.jar /opt/heikeji-mall/service-product/
   cp service-product/src/main/resources/application.yml /opt/heikeji-mall/service-product/
   ```

3. **编辑配置文件**
   ```bash
   vim /opt/heikeji-mall/service-product/application.yml
   ```
   修改数据库连接、Redis 连接、Nacos 连接等配置

4. **创建启动脚本**
   ```bash
   cat > /opt/heikeji-mall/service-product/start.sh << EOF
   #!/bin/bash
   java -jar -Dspring.profiles.active=prod service-product-1.0.0.jar
   EOF
   
   chmod +x /opt/heikeji-mall/service-product/start.sh
   ```

5. **启动服务**
   ```bash
   cd /opt/heikeji-mall/service-product
   ./start.sh
   ```

### 4.3 使用 Docker Compose 部署所有服务

1. **创建 docker-compose.yml 文件**
   ```yaml
   version: '3.8'
   
   services:
     service-auth:
       build: ./heikeji-auth
       ports:
         - "8080:8080"
       environment:
         - SPRING_PROFILES_ACTIVE=prod
       depends_on:
         - mysql
         - redis
         - nacos
     
     service-product:
       build: ./heikeji-mall-service/service-product
       ports:
         - "8081:8080"
       environment:
         - SPRING_PROFILES_ACTIVE=prod
       depends_on:
         - mysql
         - redis
         - nacos
     
     service-order:
       build: ./heikeji-mall-service/service-order
       ports:
         - "8082:8080"
       environment:
         - SPRING_PROFILES_ACTIVE=prod
       depends_on:
         - mysql
         - redis
         - rabbitmq
         - nacos
         - seata
     
     service-user:
       build: ./heikeji-mall-service/service-user
       ports:
         - "8083:8080"
       environment:
         - SPRING_PROFILES_ACTIVE=prod
       depends_on:
         - mysql
         - redis
         - nacos
     
     gateway:
       build: ./heikeji-gateway
       ports:
         - "8888:8888"
       environment:
         - SPRING_PROFILES_ACTIVE=prod
       depends_on:
         - nacos
   ```

2. **启动所有服务**
   ```bash
   cd /home/heikeji/heikeji-mall
   docker-compose up -d
   ```

## 5. 前端项目部署

### 5.1 构建前端项目

1. **进入前端目录**
   ```bash
   cd /home/heikeji/heikeji-mall/heikeji-frontend
   ```

2. **安装依赖**
   ```bash
   npm install
   ```

3. **构建项目**
   ```bash
   npm run build:prod
   ```

### 5.2 部署前端项目

1. **使用 Nginx 部署**
   ```bash
   # 创建前端部署目录
   mkdir -p /opt/heikeji-mall/frontend
   
   # 复制构建后的文件
   cp -r dist/* /opt/heikeji-mall/frontend/
   
   # 配置 Nginx
   cat > /etc/nginx/conf.d/heikeji-mall.conf << EOF
   server {
       listen 80;
       server_name localhost;
       
       location / {
           root /opt/heikeji-mall/frontend;
           index index.html index.htm;
           try_files $uri $uri/ /index.html;
       }
       
       location /api {
           proxy_pass http://localhost:8888;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       }
   }
   EOF
   
   # 重启 Nginx
   systemctl restart nginx
   ```

## 6. 配置管理

### 6.1 Nacos 配置中心

1. **访问 Nacos 控制台**
   - 地址：http://localhost:8848/nacos
   - 用户名：nacos
   - 密码：nacos

2. **添加配置**
   - 选择 "配置管理" -> "配置列表"
   - 点击 "+" 按钮，添加配置
   - 配置示例：
     - 数据 ID：service-product-prod.yml
     - 组：DEFAULT_GROUP
     - 配置格式：YAML
     - 配置内容：数据库连接、Redis 连接等配置

### 6.2 动态刷新配置

- 在 Spring Boot 服务中，使用 `@RefreshScope` 注解标记需要动态刷新的 Bean
- 当配置发生变化时，Nacos 会自动通知服务刷新配置

## 7. 监控与维护

### 7.1 服务监控

1. **Nacos 服务监控**
   - 访问 Nacos 控制台，查看服务注册状态
   - 监控服务健康状态和流量

2. **Spring Boot Admin 监控**
   - 部署 Spring Boot Admin 服务
   - 所有后端服务注册到 Spring Boot Admin
   - 监控服务运行状态、内存使用、GC 情况等

### 7.2 日志管理

1. **集中日志收集**
   - 使用 ELK Stack（Elasticsearch、Logstash、Kibana）收集和分析日志
   - 配置 Logback 输出 JSON 格式日志
   - 使用 Filebeat 收集日志文件

2. **日志查询**
   - 通过 Kibana 查询和分析日志
   - 设置日志告警规则

### 7.3 常见问题排查

1. **服务无法启动**
   - 检查配置文件是否正确
   - 检查端口是否被占用
   - 检查依赖服务是否正常运行

2. **数据库连接失败**
   - 检查数据库地址、端口、用户名、密码是否正确
   - 检查数据库是否正常运行
   - 检查防火墙是否开放端口

3. **服务调用失败**
   - 检查服务是否注册到 Nacos
   - 检查服务之间的依赖关系
   - 检查网络是否通畅

## 8. 自动化部署

### 8.1 CI/CD 流程

1. **Jenkins 部署**
   - 安装 Jenkins
   - 配置 Jenkins 任务，实现代码提交后自动构建和部署
   - 使用 Jenkins Pipeline 编写部署脚本

2. **GitLab CI/CD**
   - 配置 `.gitlab-ci.yml` 文件
   - 实现代码提交、合并请求时自动构建和测试
   - 部署到测试环境和生产环境

### 8.2 脚本化部署

1. **编写部署脚本**
   ```bash
   #!/bin/bash
   # 部署脚本示例
   
   # 定义变量
   PROJECT_DIR="/home/heikeji/heikeji-mall"
   BACKEND_DIR="$PROJECT_DIR/heikeji-mall-service"
   FRONTEND_DIR="$PROJECT_DIR/heikeji-frontend"
   
   # 拉取最新代码
   echo "拉取最新代码..."
   cd $PROJECT_DIR
   git pull
   
   # 构建后端服务
   echo "构建后端服务..."
   cd $BACKEND_DIR
   mvn clean package -DskipTests
   
   # 部署后端服务
   echo "部署后端服务..."
   # 此处添加部署逻辑
   
   # 构建前端项目
   echo "构建前端项目..."
   cd $FRONTEND_DIR
   npm install
   npm run build:prod
   
   # 部署前端项目
   echo "部署前端项目..."
   # 此处添加部署逻辑
   
   echo "部署完成！"
   ```

2. **使用 Ansible 批量部署**
   - 编写 Ansible Playbook
   - 实现多服务器批量部署
   - 配置管理和服务编排

## 9. 安全管理

### 9.1 访问控制

1. **Nginx 访问控制**
   - 配置 IP 白名单
   - 限制访问频率
   - 配置 HTTPS

2. **API 网关安全**
   - 配置 API 密钥认证
   - 实现请求限流和熔断
   - 配置 CORS 策略

### 9.2 数据安全

1. **数据库安全**
   - 定期备份数据库
   - 配置数据库审计
   - 限制数据库用户权限

2. **敏感数据保护**
   - 对敏感数据进行加密存储
   - 实现数据脱敏
   - 配置数据访问日志

## 10. 性能优化

### 10.1 数据库优化

1. **索引优化**
   - 为查询频繁的字段创建索引
   - 避免创建过多索引
   - 定期优化和重建索引

2. **查询优化**
   - 优化 SQL 查询语句
   - 使用分页查询
   - 避免全表扫描

### 10.2 缓存优化

1. **合理使用缓存**
   - 缓存热点数据
   - 设置合理的缓存过期时间
   - 实现缓存预热

2. **缓存一致性**
   - 确保缓存与数据库数据一致
   - 实现缓存失效策略

### 10.3 代码优化

1. **异步处理**
   - 使用 CompletableFuture 实现异步编程
   - 对耗时操作进行异步处理

2. **批量处理**
   - 批量插入和更新数据
   - 减少数据库交互次数

## 11. 总结

本指南详细介绍了黑科易购项目的部署和配置流程，包括基础服务部署、后端服务部署、前端项目部署、配置管理、监控与维护、自动化部署、安全管理和性能优化等方面。

通过本指南的指导，可以快速部署和配置黑科易购项目，确保项目的稳定运行和高效维护。