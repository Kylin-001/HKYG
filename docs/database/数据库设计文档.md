# 黑科易购项目数据库设计文档

## 1. 数据库概述

### 1.1 数据库选型

系统采用以下数据库技术：
- **主数据库**：MySQL 8.0+，用于存储核心业务数据
- **搜索引擎**：Elasticsearch 7.x，用于商品搜索和复杂查询
- **缓存数据库**：Redis 5.0+，用于缓存热点数据和会话管理

### 1.2 数据库架构

- **读写分离**：主库负责写操作，从库负责读操作，提高系统吞吐量
- **分库分表**：对大数据量表（如订单表、用户表）采用分库分表策略
- **数据同步**：MySQL与Elasticsearch之间实现实时数据同步

## 2. 核心表结构

### 2.1 用户模块表

#### 2.1.1 用户基础表（user）

```sql
CREATE TABLE `user` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `open_id` VARCHAR(50) NOT NULL COMMENT '微信openId',
  `union_id` VARCHAR(50) DEFAULT NULL COMMENT '微信unionId',
  `nickname` VARCHAR(50) DEFAULT NULL COMMENT '用户昵称',
  `username` VARCHAR(50) UNIQUE COMMENT '用户名',
  `password` VARCHAR(255) COMMENT '密码（加密存储）',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
  `gender` TINYINT(1) DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `student_id` VARCHAR(20) DEFAULT NULL COMMENT '学号',
  `real_name` VARCHAR(50) DEFAULT NULL COMMENT '真实姓名',
  `level_id` BIGINT(20) DEFAULT 1 COMMENT '会员等级ID',
  `status` TINYINT(1) DEFAULT 0 COMMENT '状态：0-正常，1-禁用',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_open_id` (`open_id`),
  KEY `idx_phone` (`phone`),
  KEY `idx_student_id` (`student_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户基础表';
```

#### 2.1.2 用户地址表（user_address）

```sql
CREATE TABLE `user_address` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '地址ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `consignee_name` VARCHAR(50) NOT NULL COMMENT '收货人姓名',
  `consignee_phone` VARCHAR(20) NOT NULL COMMENT '收货人手机号',
  `province` VARCHAR(50) NOT NULL COMMENT '省份',
  `city` VARCHAR(50) NOT NULL COMMENT '城市',
  `district` VARCHAR(50) NOT NULL COMMENT '区县',
  `detail_address` VARCHAR(255) NOT NULL COMMENT '详细地址',
  `is_default` TINYINT(1) DEFAULT 0 COMMENT '是否默认地址：0-否，1-是',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_is_default` (`is_default`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户地址表';
```

#### 2.1.3 用户收藏表（user_collection）

```sql
CREATE TABLE `user_collection` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '收藏ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `product_id` BIGINT(20) NOT NULL COMMENT '商品ID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '收藏时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_product` (`user_id`,`product_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户收藏表';
```

### 2.2 商品模块表

#### 2.2.1 商品分类表（category）

```sql
CREATE TABLE `category` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '分类ID',
  `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
  `parent_id` BIGINT(20) DEFAULT 0 COMMENT '父分类ID，0表示一级分类',
  `level` TINYINT(1) NOT NULL COMMENT '分类级别：1-一级，2-二级，3-三级',
  `sort_order` INT(11) DEFAULT 0 COMMENT '排序序号',
  `icon` VARCHAR(255) DEFAULT NULL COMMENT '分类图标',
  `status` TINYINT(1) DEFAULT 0 COMMENT '状态：0-正常，1-禁用',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_level` (`level`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品分类表';
```

#### 2.2.2 商品表（product）

```sql
CREATE TABLE `product` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `merchant_id` BIGINT(20) NOT NULL COMMENT '商家ID',
  `category_id` BIGINT(20) NOT NULL COMMENT '分类ID',
  `name` VARCHAR(255) NOT NULL COMMENT '商品名称',
  `subtitle` VARCHAR(255) DEFAULT NULL COMMENT '商品副标题',
  `description` TEXT COMMENT '商品描述',
  `main_image` VARCHAR(255) DEFAULT NULL COMMENT '主图URL',
  `price` DECIMAL(10,2) NOT NULL COMMENT '商品价格',
  `stock` INT(11) NOT NULL COMMENT '商品库存',
  `sales` INT(11) DEFAULT 0 COMMENT '销量',
  `status` TINYINT(1) DEFAULT 0 COMMENT '商品状态：0-上架，1-下架',
  `is_new` TINYINT(1) DEFAULT 0 COMMENT '是否新品：0-否，1-是',
  `is_hot` TINYINT(1) DEFAULT 0 COMMENT '是否热销：0-否，1-是',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_merchant_id` (`merchant_id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status` (`status`),
  KEY `idx_is_new` (`is_new`),
  KEY `idx_is_hot` (`is_hot`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';
```

#### 2.2.3 商品SKU表（product_sku）

```sql
CREATE TABLE `product_sku` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT 'SKU ID',
  `product_id` BIGINT(20) NOT NULL COMMENT '商品ID',
  `spec_values` VARCHAR(255) NOT NULL COMMENT '规格值组合，如：红色,XL',
  `price` DECIMAL(10,2) NOT NULL COMMENT 'SKU价格',
  `stock` INT(11) NOT NULL COMMENT 'SKU库存',
  `sku_image` VARCHAR(255) DEFAULT NULL COMMENT 'SKU图片',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品SKU表';
```

#### 2.2.4 商品热词表（product_hot_word）

```sql
CREATE TABLE `product_hot_word` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `word` VARCHAR(100) NOT NULL COMMENT '热词内容',
  `search_count` INT(11) DEFAULT 0 COMMENT '搜索次数',
  `status` INT(1) DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `show_on_home` INT(1) DEFAULT 0 COMMENT '是否显示在首页：0-否，1-是',
  `sort_order` INT(11) DEFAULT 0 COMMENT '排序',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_word` (`word`),
  KEY `idx_search_count` (`search_count`),
  KEY `idx_sort_order` (`sort_order`),
  KEY `idx_show_on_home` (`show_on_home`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品热词表';
```

### 2.3 订单模块表

#### 2.3.1 订单表（orders）

```sql
CREATE TABLE `orders` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_sn` VARCHAR(50) NOT NULL COMMENT '订单编号',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `merchant_id` BIGINT(20) DEFAULT NULL COMMENT '商家ID',
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '订单总金额',
  `actual_amount` DECIMAL(10,2) NOT NULL COMMENT '实际支付金额',
  `coupon_id` BIGINT(20) DEFAULT NULL COMMENT '优惠券ID',
  `coupon_amount` DECIMAL(10,2) DEFAULT 0.00 COMMENT '优惠券金额',
  `payment_method` TINYINT(1) DEFAULT 1 COMMENT '支付方式：1-微信支付',
  `payment_status` TINYINT(1) DEFAULT 0 COMMENT '支付状态：0-未支付，1-已支付，2-支付失败',
  `order_status` TINYINT(2) DEFAULT 0 COMMENT '订单状态：0-待付款，1-待发货，2-待收货，3-已完成，4-已取消，5-已退款',
  `shipping_id` BIGINT(20) DEFAULT NULL COMMENT '配送地址ID',
  `consignee_name` VARCHAR(50) DEFAULT NULL COMMENT '收货人姓名',
  `consignee_phone` VARCHAR(20) DEFAULT NULL COMMENT '收货人手机号',
  `shipping_address` VARCHAR(255) DEFAULT NULL COMMENT '收货地址',
  `remark` VARCHAR(255) DEFAULT NULL COMMENT '订单备注',
  `payment_time` DATETIME DEFAULT NULL COMMENT '支付时间',
  `delivery_time` DATETIME DEFAULT NULL COMMENT '发货时间',
  `confirm_time` DATETIME DEFAULT NULL COMMENT '确认收货时间',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_sn` (`order_sn`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_merchant_id` (`merchant_id`),
  KEY `idx_order_status` (`order_status`),
  KEY `idx_payment_status` (`payment_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

#### 2.3.2 订单商品表（order_item）

```sql
CREATE TABLE `order_item` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '订单商品ID',
  `order_id` BIGINT(20) NOT NULL COMMENT '订单ID',
  `product_id` BIGINT(20) NOT NULL COMMENT '商品ID',
  `sku_id` BIGINT(20) DEFAULT NULL COMMENT 'SKU ID',
  `product_name` VARCHAR(255) NOT NULL COMMENT '商品名称',
  `product_image` VARCHAR(255) DEFAULT NULL COMMENT '商品图片',
  `spec_info` VARCHAR(255) DEFAULT NULL COMMENT '规格信息',
  `price` DECIMAL(10,2) NOT NULL COMMENT '商品单价',
  `quantity` INT(11) NOT NULL COMMENT '购买数量',
  `total_price` DECIMAL(10,2) NOT NULL COMMENT '商品总价',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单商品表';
```

### 2.4 支付模块表

#### 2.4.1 支付记录表（payment_record）

```sql
CREATE TABLE `payment_record` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '支付记录ID',
  `order_id` BIGINT(20) NOT NULL COMMENT '订单ID',
  `order_sn` VARCHAR(50) NOT NULL COMMENT '订单编号',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `amount` DECIMAL(10,2) NOT NULL COMMENT '支付金额',
  `pay_type` TINYINT(1) DEFAULT 1 COMMENT '支付类型：1-微信支付',
  `transaction_id` VARCHAR(100) DEFAULT NULL COMMENT '第三方支付流水号',
  `status` TINYINT(1) DEFAULT 0 COMMENT '支付状态：0-待支付，1-支付成功，2-支付失败',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='支付记录表';
```

### 2.5 营销模块表

#### 2.5.1 优惠券表（coupon）

```sql
CREATE TABLE `coupon` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '优惠券ID',
  `name` VARCHAR(100) NOT NULL COMMENT '优惠券名称',
  `type` TINYINT(1) DEFAULT 1 COMMENT '优惠券类型：1-满减券，2-折扣券',
  `value` DECIMAL(10,2) DEFAULT NULL COMMENT '优惠金额',
  `discount` DECIMAL(5,2) DEFAULT NULL COMMENT '折扣率（如9.5折为9.5）',
  `min_amount` DECIMAL(10,2) DEFAULT 0.00 COMMENT '最低使用金额',
  `start_time` DATETIME NOT NULL COMMENT '开始时间',
  `end_time` DATETIME NOT NULL COMMENT '结束时间',
  `total_count` INT(11) NOT NULL COMMENT '总数量',
  `used_count` INT(11) DEFAULT 0 COMMENT '已使用数量',
  `status` TINYINT(1) DEFAULT 0 COMMENT '状态：0-正常，1-已失效',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';
```

#### 2.5.2 用户优惠券表（user_coupon）

```sql
CREATE TABLE `user_coupon` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '用户优惠券ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `coupon_id` BIGINT(20) NOT NULL COMMENT '优惠券ID',
  `order_id` BIGINT(20) DEFAULT NULL COMMENT '使用的订单ID',
  `status` TINYINT(1) DEFAULT 0 COMMENT '状态：0-未使用，1-已使用，2-已过期',
  `receive_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '领取时间',
  `use_time` DATETIME DEFAULT NULL COMMENT '使用时间',
  `expire_time` DATETIME NOT NULL COMMENT '过期时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_coupon_id` (`coupon_id`),
  KEY `idx_status` (`status`),
  KEY `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户优惠券表';
```

### 2.6 系统管理表

#### 2.6.1 管理员用户表（admin_user）

```sql
CREATE TABLE `admin_user` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '管理员ID',
  `username` VARCHAR(50) NOT NULL COMMENT '用户名',
  `password` VARCHAR(255) NOT NULL COMMENT '密码（加密存储）',
  `real_name` VARCHAR(50) DEFAULT NULL COMMENT '真实姓名',
  `avatar` VARCHAR(255) DEFAULT NULL COMMENT '头像',
  `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
  `email` VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
  `status` TINYINT(1) DEFAULT 0 COMMENT '状态：0-正常，1-禁用',
  `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
  `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员用户表';
```

#### 2.6.2 管理员角色表（admin_role）

```sql
CREATE TABLE `admin_role` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `name` VARCHAR(50) NOT NULL COMMENT '角色名称',
  `description` VARCHAR(200) DEFAULT NULL COMMENT '角色描述',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员角色表';
```

#### 2.6.3 管理员权限表（admin_permission）

```sql
CREATE TABLE `admin_permission` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '权限ID',
  `name` VARCHAR(50) NOT NULL COMMENT '权限名称',
  `code` VARCHAR(50) NOT NULL COMMENT '权限编码',
  `description` VARCHAR(200) DEFAULT NULL COMMENT '权限描述',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员权限表';
```

### 2.7 用户行为分析表

#### 2.7.1 页面浏览记录表（user_behavior_page_view）

```sql
CREATE TABLE `user_behavior_page_view` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT(20) DEFAULT NULL COMMENT '用户ID',
  `session_id` VARCHAR(100) NOT NULL COMMENT '会话ID',
  `page_path` VARCHAR(255) NOT NULL COMMENT '页面路径',
  `page_title` VARCHAR(100) DEFAULT NULL COMMENT '页面标题',
  `referrer` VARCHAR(255) DEFAULT NULL COMMENT '来源页面',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '用户IP地址',
  `user_agent` TEXT DEFAULT NULL COMMENT '用户代理信息',
  `stay_time` BIGINT(20) DEFAULT 0 COMMENT '停留时间（毫秒）',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '记录时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_session_id` (`session_id`),
  KEY `idx_page_path` (`page_path`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='页面浏览记录表';
```

#### 2.7.2 点击事件表（user_behavior_click_event）

```sql
CREATE TABLE `user_behavior_click_event` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT(20) DEFAULT NULL COMMENT '用户ID',
  `session_id` VARCHAR(100) NOT NULL COMMENT '会话ID',
  `event_type` VARCHAR(50) NOT NULL COMMENT '事件类型',
  `element_id` VARCHAR(100) DEFAULT NULL COMMENT '元素ID',
  `element_name` VARCHAR(100) DEFAULT NULL COMMENT '元素名称',
  `page_path` VARCHAR(255) NOT NULL COMMENT '页面路径',
  `page_title` VARCHAR(100) DEFAULT NULL COMMENT '页面标题',
  `click_position` VARCHAR(50) DEFAULT NULL COMMENT '点击位置（JSON格式）',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '用户IP地址',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '记录时间',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_session_id` (`session_id`),
  KEY `idx_event_type` (`event_type`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点击事件表';
```

#### 2.7.3 购买行为表（user_behavior_purchase）

```sql
CREATE TABLE `user_behavior_purchase` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `order_id` BIGINT(20) NOT NULL COMMENT '订单ID',
  `product_id` BIGINT(20) NOT NULL COMMENT '商品ID',
  `product_name` VARCHAR(255) NOT NULL COMMENT '商品名称',
  `category_id` BIGINT(20) DEFAULT NULL COMMENT '分类ID',
  `category_name` VARCHAR(100) DEFAULT NULL COMMENT '分类名称',
  `sku_id` BIGINT(20) DEFAULT NULL COMMENT 'SKU ID',
  `price` DECIMAL(10,2) NOT NULL COMMENT '商品价格',
  `quantity` INT(11) NOT NULL DEFAULT 1 COMMENT '购买数量',
  `total_amount` DECIMAL(10,2) NOT NULL COMMENT '总金额',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '记录时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_product` (`order_id`,`product_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='购买行为表';
```

#### 2.7.4 用户偏好表（user_behavior_preference）

```sql
CREATE TABLE `user_behavior_preference` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '记录ID',
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `preference_type` VARCHAR(50) NOT NULL COMMENT '偏好类型：category-分类，product-商品，time_period-时段',
  `preference_value` VARCHAR(100) NOT NULL COMMENT '偏好值',
  `score` INT(11) DEFAULT 0 COMMENT '偏好分数',
  `view_count` INT(11) DEFAULT 0 COMMENT '查看次数',
  `click_count` INT(11) DEFAULT 0 COMMENT '点击次数',
  `purchase_count` INT(11) DEFAULT 0 COMMENT '购买次数',
  `last_visit_time` DATETIME DEFAULT NULL COMMENT '最后访问时间',
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_preference` (`user_id`,`preference_type`,`preference_value`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_preference_type` (`preference_type`),
  KEY `idx_score` (`score`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户偏好表';
```

## 3. 表关系图

### 3.1 核心表关系

```
user 1:n user_address
user 1:n user_collection
user 1:n orders
user 1:n user_coupon
user 1:n payment_record

category 1:n product
product 1:n product_sku
product 1:n user_collection
product 1:n order_item

orders 1:n order_item
orders 1:1 payment_record

coupon 1:n user_coupon
user_coupon n:1 orders

admin_user n:m admin_role
admin_role n:m admin_permission
```

## 4. 索引优化策略

### 4.1 主键索引
所有表都使用自增ID作为主键，自动创建主键索引。

### 4.2 唯一索引
- 用户表的open_id、username字段创建唯一索引
- 订单表的order_sn字段创建唯一索引
- 管理员表的username字段创建唯一索引

### 4.3 普通索引
- 常用查询字段创建索引，如用户ID、商品ID、订单状态等
- 外键字段创建索引，提高联表查询性能
- 排序字段创建索引，优化排序操作

## 5. 数据安全

### 5.1 敏感数据加密
- 密码使用BCrypt算法加密存储
- 手机号、邮箱等敏感信息考虑加密或脱敏处理

### 5.2 数据备份与恢复
- 定期全量备份数据库
- 设置增量备份机制
- 制定数据恢复方案和演练计划

### 5.3 访问控制
- 严格控制数据库用户权限
- 生产环境禁止直接使用root账户
- 应用层实现访问控制和权限校验

## 6. 扩展性设计

### 6.1 分库分表策略
- **垂直分库**：按业务模块拆分，如用户库、订单库、商品库
- **水平分表**：对大数据量表按时间或ID范围拆分
  - 订单表按创建时间分表
  - 用户表按ID范围分表

### 6.2 读写分离
- 主库负责写操作
- 多个从库负责读操作
- 使用中间件实现读写分离路由

### 6.3 数据同步
- MySQL与Elasticsearch之间的数据实时同步
- 使用Canal或Debezium监听binlog实现

## 7. 注意事项

1. 所有表都必须设置主键
2. 所有表都必须包含create_time和update_time字段
3. 合理设置字段类型和长度，避免浪费空间
4. 对常用查询字段创建合适的索引
5. 定期清理过期数据，保持数据库性能
6. 数据库结构变更必须通过DDL脚本执行，并进行备份
7. 生产环境禁止直接修改数据库结构

本数据库设计文档将根据业务需求和系统发展不断更新和优化。