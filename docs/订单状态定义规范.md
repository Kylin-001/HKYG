# 订单状态定义规范

## 1. 主订单表状态定义 (order表)

### 1.1 基础状态
- `0` - 待支付：订单创建完成，等待用户支付
- `1` - 已支付：用户已完成支付，等待商家接单/发货
- `2` - 待接单：商家待接单状态（外卖订单特有）
- `3` - 已发货：商家已发货，配送中
- `4` - 已送达：配送已完成，等待用户确认收货
- `5` - 已完成：用户已确认收货，订单完成
- `6` - 已取消：订单被取消
- `7` - 超时未取货：外卖柜超时未取货（系统自动处理）

### 1.2 扩展状态
- `8` - 退款中：申请退款，等待处理
- `9` - 已退款：退款完成

## 2. 外卖订单表状态定义 (takeout_order表)

### 2.1 配送状态
- `0` - 待接单：等待商家接单
- `1` - 已接单：商家已接单，准备制作
- `2` - 配送中：商家制作完成，配送员配送中
- `3` - 已送达：配送员已送达指定位置
- `4` - 已取消：订单被取消
- `5` - 用户已取货：用户确认从外卖柜取货
- `6` - 超时未取货：外卖柜超时未取货

## 3. 状态转换规则

### 3.1 主订单状态转换
```
待支付(0) → 已支付(1) → 待接单(2)/已发货(3)
已支付(1) → 待接单(2) [外卖订单]
已支付(1) → 已发货(3) [普通订单]
待接单(2) → 已发货(3) → 已送达(4) → 已完成(5)
已发货(3) → 已送达(4) → 已完成(5)
已支付(1) → 已取消(6)
待接单(2) → 已取消(6)
已发货(3) → 已取消(6) [特殊情况]
已送达(4) → 已完成(5)
[超时检测] 已送达(4) → 超时未取货(7)
超时未取货(7) → 已取消(6) [系统处理]
已支付(1) → 退款中(8) → 已退款(9)
```

### 3.2 外卖订单状态转换
```
待接单(0) → 已接单(1) → 配送中(2) → 已送达(3) → 用户已取货(5)
待接单(0) → 已取消(4)
已接单(1) → 配送中(2) → 已取消(4)
配送中(2) → 已送达(3) → 已取消(4)
已送达(3) → 用户已取货(5)
[超时检测] 已送达(3) → 超时未取货(6)
超时未取货(6) → 已取消(4) [系统处理]
```

## 4. 配送方式状态映射

### 4.1 外卖柜配送
- 状态流转：已送达(3) → 用户已取货(5) 或 超时未取货(6)
- 超时机制：外卖柜超时后自动释放格口，状态转为超时未取货(6)

### 4.2 特殊地点配送
- 状态流转：已送达(3) → 用户已取货(5)
- 无超时机制，配送员送达后等待用户确认

### 4.3 送到寝室
- 状态流转：已送达(3) → 用户已取货(5)
- 无超时机制，配送员送达后等待用户确认

## 5. 完整性约束

### 5.1 状态值约束
- 所有订单状态值必须在定义范围内
- 非法状态值应抛出异常

### 5.2 状态转换约束
- 只能进行合法的状态转换
- 已完成(5)、已取消(6)、已退款(9)状态不可再更改

### 5.3 业务规则约束
- 超时未取货状态只能由系统自动设置
- 用户不能手动将订单设置为超时未取货状态

## 6. 常量定义类

建议创建统一的常量定义类：
- `OrderStatusConstant` - 主订单状态常量
- `TakeoutOrderStatusConstant` - 外卖订单状态常量
- `DeliveryStatusConstant` - 配送订单状态常量

所有状态转换逻辑应在服务层统一管理，确保状态变更的一致性和可追溯性。