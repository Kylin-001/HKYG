# 黑科易购项目部署文档

## 1. 部署环境准备

### 1.1 硬件要求

| 环境类型 | CPU | 内存 | 磁盘 | 网络 |
|---------|-----|------|------|------|
| 开发环境 | 4核+ | 8GB+ | 100GB+ SSD | 千兆网络 |
| 测试环境 | 8核+ | 16GB+ | 200GB+ SSD | 千兆网络 |
| 生产环境 | 16核+ | 32GB+ | 500GB+ SSD | 万兆网络 |

### 1.2 软件要求

| 软件 | 版本 | 用途 |
|------|------|------|
| JDK | 11+ | Java运行环境 |
| MySQL | 8.0+ | 主数据库 |
| Redis | 6.0+ | 缓存数据库 |
| ElasticSearch | 7.10+ | 搜索引擎 |
| RabbitMQ | 3.8+ | 消息队列 |
| Nacos | 2.0+ | 服务注册与配置中心 |
| Docker | 20.10+ | 容器化部署 |
| Kubernetes | 1.20+ | 容器编排（可选） |
| Nginx | 1.20+ | Web服务器/反向代理 |

## 2. 环境变量配置

### 2.1 环境变量文件说明

项目支持多环境配置，通过`.env`文件管理环境变量。主要环境配置文件包括：

- `.env`：通用环境变量
- `.env.dev`：开发环境配置
- `.env.test`：测试环境配置
- `.env.prod`：生产环境配置

### 2.2 配置文件优先级

环境变量加载优先级（从高到低）：

1. 命令行参数
2. 系统环境变量
3. `.env.{profile}`（特定环境配置）
4. `.env`（通用配置）

### 2.3 核心配置项说明

#### 数据库配置

```
# MySQL数据库配置
DB_HOST=数据库主机地址
DB_PORT=数据库端口
DB_NAME=数据库名称
DB_USERNAME=数据库用户名
DB_PASSWORD=数据库密码
```

#### Redis配置

```
REDIS_HOST=Redis主机地址
REDIS_PORT=Redis端口
REDIS_PASSWORD=Redis密码
REDIS_DATABASE=Redis数据库编号
```

#### 服务配置

```
# 服务端口
SERVER_PORT=8080
# 服务地址
SERVER_HOST=0.0.0.0
```

#### 安全配置

```
# JWT密钥
JWT_SECRET=密钥字符串
JWT_EXPIRATION=过期时间（毫秒）
# 安全盐值
SECURITY_SALT=盐值字符串
```

## 3. 部署方式

### 3.1 手动部署

#### 3.1.1 编译打包

```bash
# 克隆代码库
git clone https://github.com/your-org/heikeji-mall.git
cd heikeji-mall

# 编译打包
mvn clean package -DskipTests
```

#### 3.1.2 配置环境变量

```bash
# 复制环境变量文件
cp .env.example .env

# 根据实际环境修改.env文件
vim .env
```

#### 3.1.3 启动服务

```bash
# 启动服务（以用户服务为例）
java -jar heikeji-user/target/heikeji-user.jar
```

### 3.2 Docker部署

#### 3.2.1 构建Docker镜像

```bash
# 构建基础镜像
docker build -t heikeji-mall/base:latest .

# 构建各服务镜像（以用户服务为例）
cd heikeji-user
docker build -t heikeji-mall/user:latest .
```

#### 3.2.2 运行Docker容器

```bash
# 运行用户服务容器
docker run -d \
  --name heikeji-user \
  -p 8081:8080 \
  -v $(pwd)/.env:/app/.env \
  -v $(pwd)/logs:/app/logs \
  heikeji-mall/user:latest
```

### 3.3 Docker Compose部署

#### 3.3.1 创建docker-compose.yml

```yaml
version: '3.8'

networks:
  heikeji-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  elasticsearch-data:
  rabbitmq-data:
  nacos-data:

# 定义数据库、缓存等基础设施服务
# 实际使用时需添加完整配置
```

#### 3.3.2 启动所有服务

```bash
docker-compose up -d
```

### 3.4 Kubernetes部署

#### 3.4.1 创建Kubernetes配置文件

项目提供Kubernetes部署配置文件，位于`k8s/`目录下：

- `deployment.yaml`：部署配置
- `service.yaml`：服务配置
- `ingress.yaml`：入口配置
- `configmap.yaml`：配置映射
- `secret.yaml`：密钥配置

#### 3.4.2 应用Kubernetes配置

```bash
# 应用配置
kubectl apply -f k8s/

# 查看部署状态
kubectl get pods
```

## 4. 服务启动顺序

为确保系统正常运行，建议按照以下顺序启动服务：

1. **基础设施服务**：
   - MySQL
   - Redis
   - ElasticSearch
   - RabbitMQ
   - Nacos

2. **核心服务**：
   - heikeji-auth（认证服务）
   - heikeji-system（系统服务）
   - heikeji-user（用户服务）
   - heikeji-product（商品服务）

3. **业务服务**：
   - heikeji-order（订单服务）
   - heikeji-payment（支付服务）
   - heikeji-marketing（营销服务）
   - heikeji-evaluation（评价服务）
   - heikeji-message（消息服务）

4. **网关服务**：
   - heikeji-gateway（API网关）

5. **前端服务**：
   - heikeji-frontend（前端应用）

## 5. 自动部署脚本使用

项目提供了自动化部署脚本，简化部署流程：

### 5.1 Linux/Mac部署脚本

```bash
# 赋予执行权限
chmod +x deploy.sh

# 执行部署脚本
./deploy.sh [环境] [服务名]
# 例如：部署开发环境的用户服务
./deploy.sh dev user
```

### 5.2 Windows部署脚本

```batch
# 执行部署脚本
deploy.bat [环境] [服务名]
# 例如：部署开发环境的用户服务
deploy.bat dev user
```

## 6. 数据库初始化

### 6.1 执行数据库脚本

```bash
# 使用MySQL客户端执行初始化脚本
mysql -u username -p database_name < sql/init.sql
```

### 6.2 数据迁移

系统支持使用Flyway进行数据库版本管理：

```bash
# 执行数据迁移
mvn flyway:migrate
```

## 7. 监控与日志

### 7.1 监控配置

系统集成了Prometheus和Spring Boot Actuator进行监控：

```bash
# 访问监控端点
http://localhost:8080/actuator
http://localhost:9090/ # Prometheus
```

### 7.2 日志配置

日志文件默认位于`./logs`目录下，主要日志文件包括：

- `app.log`：应用日志
- `error.log`：错误日志
- `business.log`：业务日志
- `access.log`：访问日志

### 7.3 日志级别调整

可通过环境变量调整日志级别：

```
LOG_LEVEL=INFO # 可选值：DEBUG, INFO, WARN, ERROR
```

## 8. 常见问题与解决方案

### 8.1 启动失败

- **端口被占用**：修改服务端口或关闭占用端口的进程
- **数据库连接失败**：检查数据库配置和网络连接
- **依赖服务不可用**：确保所有依赖服务已启动

### 8.2 性能问题

- **数据库性能**：检查慢查询日志，优化索引
- **缓存命中率低**：调整缓存策略，增加缓存预热
- **JVM参数不合理**：优化JVM参数配置

### 8.3 安全问题

- **敏感信息泄露**：确保敏感配置使用环境变量或加密存储
- **权限控制不当**：检查权限配置，确保最小权限原则
- **接口安全**：实施接口限流，防止恶意请求

## 9. 滚动更新

### 9.1 蓝绿部署

```bash
# 部署新版本服务
./deploy.sh prod user new

# 验证新版本
curl http://localhost:8081/actuator/health

# 切换流量（修改负载均衡配置）
# 回滚（如遇问题）
./deploy.sh prod user rollback
```

### 9.2 金丝雀发布

```bash
# 部署金丝雀版本
./deploy.sh prod user canary

# 逐步增加流量比例
# 监控系统状态
# 全部切换或回滚
```

## 10. 备份与恢复

### 10.1 数据库备份

```bash
# 备份数据库
mysqldump -u username -p database_name > backup_$(date +%Y%m%d).sql

# 压缩备份文件
tar -czvf backup_$(date +%Y%m%d).tar.gz backup_$(date +%Y%m%d).sql
```

### 10.2 数据恢复

```bash
# 恢复数据库
mysql -u username -p database_name < backup_file.sql
```

### 10.3 配置备份

```bash
# 备份配置文件
tar -czvf config_backup_$(date +%Y%m%d).tar.gz .env*
```

## 11. 服务降级与熔断测试

### 11.1 手动触发熔断

```bash
# 模拟服务压力，触发熔断
ab -n 10000 -c 100 http://localhost:8080/api/user/list
```

### 11.2 验证降级策略

```bash
# 检查服务是否正常降级
curl -v http://localhost:8080/api/user/detail/1
```

## 12. 部署检查清单

部署完成后，请检查以下内容：

- [ ] 所有服务是否正常启动
- [ ] 数据库连接是否正常
- [ ] 缓存服务是否可用
- [ ] 监控系统是否正常工作
- [ ] 日志是否正常输出
- [ ] API接口是否可正常访问
- [ ] 安全配置是否正确
- [ ] 性能指标是否在合理范围内