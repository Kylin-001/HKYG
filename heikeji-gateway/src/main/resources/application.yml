server:
  port: 9999
  servlet:
    context-path: /
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml,application/xml+rss,image/svg+xml
    min-response-size: 1024

spring:
  application:
    name: heikeji-gateway
  
  # 服务发现配置
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: public
    gateway:
      # 路由配置
      routes:
        # 管理后台服务路由
        - id: heikeji-admin
          uri: lb://heikeji-admin
          predicates:
            - Path=/admin/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 20
                redis-rate-limiter.burstCapacity: 40
                key-resolver: '#{@userKeyResolver}'
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY, SERVICE_UNAVAILABLE
        
        # 商品服务路由
        - id: heikeji-mall-product
          uri: lb://heikeji-mall-product
          predicates:
            - Path=/api/product/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: '#{@ipKeyResolver}'
        
        # 订单服务路由
        - id: heikeji-mall-order
          uri: lb://heikeji-mall-order
          predicates:
            - Path=/api/order/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 30
                redis-rate-limiter.burstCapacity: 60
                key-resolver: '#{@userKeyResolver}'
        
        # 用户服务路由
        - id: heikeji-mall-user
          uri: lb://heikeji-mall-user
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 40
                redis-rate-limiter.burstCapacity: 80
                key-resolver: '#{@ipKeyResolver}'
        
        # 支付服务路由
        - id: heikeji-mall-payment
          uri: lb://heikeji-mall-payment
          predicates:
            - Path=/api/payment/**
          filters:
            - StripPrefix=0
            - name: CircuitBreaker
              args:
                name: paymentCircuitBreaker
                fallbackUri: forward:/fallback/payment
        
        # APP应用服务路由
        - id: heikeji-mall-app
          uri: lb://heikeji-mall-app
          predicates:
            - Path=/api/app/**
          filters:
            - StripPrefix=0
        
        # 通用服务路由（默认兜底）
        - id: fallback-service
          uri: http://localhost:9999
          predicates:
            - Path=/fallback/**
          filters:
            - StripPrefix=1

      # 全局过滤器配置
      default-filters:
        - name: GlobalFilter
        - name: AddResponseHeader
          args:
            name: X-Response-Time
            value: #{T(System).currentTimeMillis()}
        - name: DedupeResponseHeader
          args:
            name: Access-Control-Allow-Origin, Access-Control-Allow-Credentials
            strategy: RETAIN_UNIQUE
      
      # 跨域配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
      
      # 负载均衡配置
      loadbalancer:
        ribbon:
          enabled: false

  # Redis配置（用于限流）
  redis:
    host: localhost
    port: 6379
    database: 1
    timeout: 3000
    jedis:
      pool:
        max-active: 8
        max-wait: -1
        max-idle: 8
        min-idle: 0

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always

# 日志配置
logging:
  level:
    root: info
    org.springframework.cloud.gateway: debug
    com.heikeji.gateway: debug
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n'
    file: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n'
  file:
    name: logs/heikeji-gateway.log
    max-size: 10MB
    max-history: 7

# 自定义配置
gateway:
  # 限流配置
  ratelimit:
    user-rate-limit:
      replenish-rate: 20
      burst-capacity: 40
    ip-rate-limit:
      replenish-rate: 100
      burst-capacity: 200
  
  # 安全配置
  security:
    # 不需要认证的路径
    whitelist:
      - /admin/login
      - /api/user/login
      - /api/user/register
      - /api/product/public/**
      - /fallback/**
    # JWT配置
    jwt:
      secret: heikeji_gateway_jwt_secret_key_2024
      expiration: 3600000
      header: Authorization
      tokenStartWith: Bearer