<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人资料 - 黑科易购</title>
<link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        /* 自定义样�?*/
        .avatar-upload {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        .avatar-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007bff;
        }
        .avatar-upload-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .avatar-upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            text-align: center;
            padding: 5px;
            border-bottom-left-radius: 50%;
            border-bottom-right-radius: 50%;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .avatar-upload:hover .avatar-upload-overlay {
            opacity: 1;
        }
        .form-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-section h5 {
            margin-bottom: 15px;
            color: #495057;
        }
        .change-password-btn {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- 导航�?-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/images/logo.png" alt="黑科易购" height="30">
                <span class="ms-2">黑科易购</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/category-list">分类</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/product-list">商品列表</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/cart">购物�?/a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span id="username">{{username}}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/api/address-list">地址管理</a></li>
                            <li><a class="dropdown-item" href="/api/order-list">我的订单</a></li>
                            <li><a class="dropdown-item" href="/api/takeout-order-list">外卖订单</a></li>
                            <li><a class="dropdown-item" href="/api/delivery-request-list">跑腿服务</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" id="logoutBtn">退出登�?/a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体内容 -->
    <div class="container my-5">
        <div class="row">
            <!-- 侧边�?-->
            <div class="col-lg-3 mb-5 mb-lg-0">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">用户中心</div>
                    <div class="list-group">
                        <a href="/api/order-list" class="list-group-item list-group-item-action">我的订单</a>
                        <a href="/api/takeout-order-list" class="list-group-item list-group-item-action">外卖订单</a>
                        <a href="/api/delivery-request-list" class="list-group-item list-group-item-action">跑腿服务</a>
                        <a href="/api/address-list" class="list-group-item list-group-item-action">地址管理</a>
                        <a href="/api/profile" class="list-group-item list-group-item-action active">个人资料</a>
                    </div>
                </div>
            </div>

            <!-- 涓汉璧勬枡鍖哄�?-->
            <div class="col-lg-9">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">个人资料设置</h5>
                    </div>
                    <div class="card-body">
                        <!-- 加载中状�?-->
                        <div id="loading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载�?.</span>
                            </div>
                            <p class="mt-2">正在加载个人资料...</p>
                        </div>

                        <form id="profileForm" class="d-none">
                            <!-- 基本信息部分 -->
                            <div class="form-section">
                                <h5>基本信息</h5>
                                
                                <!-- 头像上传 -->
                                <div class="mb-4 text-center">
                                    <div class="avatar-upload">
                                        <img id="avatarPreview" src="/static/images/default-avatar.png" alt="头像" class="avatar-preview">
                                        <input type="file" id="avatarInput" class="avatar-upload-input" accept="image/*">
                                        <div class="avatar-upload-overlay">更换头像</div>
                                    </div>
                                    <p class="text-sm text-muted mt-2">支持 JPG、PNG、GIF 格式，大小不超过 2MB</p>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="username" class="form-label">用户�?/label>
                                        <input type="text" class="form-control" id="usernameField" name="username" readonly placeholder="用户�?>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nickname" class="form-label">昵称</label>
                                        <input type="text" class="form-control" id="nickname" name="nickname" placeholder="请输入昵�?>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">邮箱地址</label>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="请输入邮箱地址">
                                </div>

                                <div class="mb-3">
                                    <label for="phone" class="form-label">手机号码</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="请输入手机号�?>
                                </div>
                            </div>

                            <!-- 个人简介部�?-->
                            <div class="form-section">
                                <h5>个人简�?/h5>
                                <div class="mb-3">
                                    <label for="bio" class="form-label">简�?/label>
                                    <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="请输入个人简�?></textarea>
                                    <div class="form-text">最多输�?200 �?/div>
                                </div>
                            </div>

                            <!-- 密码修改部分 -->
                            <div class="form-section">
                                <h5>账户安全</h5>
                                <div class="mb-3">
                                    <label class="form-label">登录密码</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" placeholder="请输入当前密�? readonly>
                                        <button type="button" class="btn btn-outline-secondary change-password-btn" data-password-field="currentPassword">修改</button>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">保存修改</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="oldPassword" class="form-label">当前密码</label>
                            <input type="password" class="form-control" id="oldPassword" name="oldPassword" required placeholder="请输入当前密�?>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">新密�?/label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required placeholder="请输入新密码">
                            <div class="form-text">密码必须包含字母和数字，长度至少8�?/div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认新密�?/label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required placeholder="请再次输入新密码">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitPasswordChange">确定修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="text-center">
                <p class="text-muted">黑科易购 - 校园生活服务平台</p>
                <p class="text-muted">© 2023 heikeji-mall. All Rights Reserved.>
            </div>
        </div>
    </footer>

    <!-- 引入 jQuery -->
    <script src="/js/jquery.min.js"></script>
    <!-- 引入 Bootstrap JS -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <!-- 引入认证工具 -->
    <script src="/js/auth-utils.js"></script>
    
    <script>
        $(document).ready(function() {
            // 检查登录状�?
            authUtils.checkLogin();
            
            // 更新用户�?
            $('#username').text(authUtils.getUsername() || '用户');
            
            // 加载个人资料
            loadUserProfile();
            
            // 头像预览
            $('#avatarInput').change(function(e) {
                if (e.target.files && e.target.files[0]) {
                    // 检查文件大小（2MB�?
                    if (e.target.files[0].size > 2 * 1024 * 1024) {
                        alert('文件大小不能超过2MB');
                        return;
                    }
                    
                    // 检查文件类�?
                    const fileType = e.target.files[0].type;
                    if (!fileType.match('image/jpeg') && !fileType.match('image/png') && !fileType.match('image/gif')) {
                        alert('只支�?JPG、PNG、GIF 格式的图�?);
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        $('#avatarPreview').attr('src', event.target.result);
                    }
                    reader.readAsDataURL(e.target.files[0]);
                    
                    // 自动上传头像
                    uploadAvatar(e.target.files[0]);
                }
            });
            
            // 个人资料表单提交
            $('#profileForm').submit(function(event) {
                event.preventDefault();
                saveUserProfile();
            });
            
            // 淇敼瀵嗙爜鎸夐挳鐐瑰嚮浜嬩欢
            $('.change-password-btn').click(function() {
                $('#changePasswordForm')[0].reset();
                $('#changePasswordModal').modal('show');
            });
            
            // 鎻愪氦瀵嗙爜淇敼
            $('#submitPasswordChange').click(function() {
                changePassword();
            });
            
            // 閫€鍑虹櫥褰?            $('#logoutBtn').click(function() {
                authUtils.logout();
                window.location.href = '/api/auth/login';
            });
        });

        /**
         * 加载用户个人资料
         */
        function loadUserProfile() {
            $('#loading').removeClass('d-none');
            $('#profileForm').addClass('d-none');
            
            $.authAjax({
                url: '/api/user/profile',
                type: 'GET',
                success: function(response) {
                    $('#loading').addClass('d-none');
                    
                    if (response.code === 200 && response.data) {
                        const userInfo = response.data;
                        $('#usernameField').val(userInfo.username || '');
                        $('#nickname').val(userInfo.nickname || '');
                        $('#email').val(userInfo.email || '');
                        $('#phone').val(userInfo.phone || '');
                        $('#bio').val(userInfo.bio || '');
                        
                        // 璁剧疆澶村儚
                        if (userInfo.avatar) {
                            $('#avatarPreview').attr('src', userInfo.avatar);
                        }
                        
                        $('#profileForm').removeClass('d-none');
                    } else {
                        alert('加载个人资料失败');
                    }
                },
                error: function() {
                    $('#loading').addClass('d-none');
                    alert('网络错误，请稍后重试');
                }
            });
        }

        /**
         * 上传头像
         */
        function uploadAvatar(file) {
            const formData = new FormData();
            formData.append('avatar', file);
            
            $.authAjax({
                url: '/api/user/upload-avatar',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    if (response.code === 200 && response.data && response.data.avatarUrl) {
                        showSuccessMessage('头像上传成功');
                    } else {
                        alert('头像上传失败，请重试');
                        // 鎭㈠榛樿澶村�?
                        $('#avatarPreview').attr('src', '/static/images/default-avatar.png');
                        $('#avatarInput').val('');
                    }
                },
                error: function() {
                    alert('澶村儚涓婁紶澶辫触锛岃閲嶈�?);
                    $('#avatarPreview').attr('src', '/static/images/default-avatar.png');
                    $('#avatarInput').val('');
                }
            });
        }

        /**
         * 显示成功消息
         */
        function showSuccessMessage(message) {
            // 鍒涘缓涓€涓畝鍗曠殑鎴愬姛娑堟伅鎻愮ず
            const messageElement = $('<div class="alert alert-success alert-dismissible fade show position-fixed top-20 left-50 transform -translate-x-50 z-50" role="alert">').text(message);
            const closeButton = $('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');
            messageElement.append(closeButton);
            
            $('body').append(messageElement);
            
            // 3绉掑悗鑷姩鍏抽�?
            setTimeout(() => {
                messageElement.alert('close');
            }, 3000);
        }
        
        /**
         * 楠岃瘉宸ュ叿鍑芥�?
         */
        const validators = {
            isValidEmail: function(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            },
            isValidPhone: function(phone) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                return phoneRegex.test(phone);
            },
            isStrongPassword: function(password) {
                // 密码必须包含字母和数字，长度至少8�?               const hasLetter = /[a-zA-Z]/.test(password);
                const hasNumber = /\d/.test(password);
                return password.length >= 8 && hasLetter && hasNumber;
            }
        };
        
        /**
         * 保存用户个人资料
         */
        function saveUserProfile() {
            // 琛ㄥ崟楠岃瘉
            const nickname = $('#nickname').val().trim();
            const email = $('#email').val().trim();
            const phone = $('#phone').val().trim();
            const bio = $('#bio').val().trim();
            
            if (email && !validators.isValidEmail(email)) {
                alert('请输入正确的邮箱地址');
                return;
            }
            
            if (phone && !validators.isValidPhone(phone)) {
                alert('请输入正确的手机号码');
                return;
            }
            
            if (bio.length > 200) {
                alert('个人简介不能超�?00�?);
                return;
            }
            
            // 构建请求数据
            const data = {
                nickname: nickname,
                email: email,
                phone: phone,
                bio: bio
            };
            
            // 禁用保存按钮
            const saveBtn = $('#profileForm button[type="submit"]');
            const originalText = saveBtn.text();
            saveBtn.prop('disabled', true).text('保存�?..');
            
            $.authAjax({
                url: '/api/user/update-profile',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    saveBtn.prop('disabled', false).text(originalText);
                    
                    if (response.code === 200) {
                        showSuccessMessage('个人资料更新成功');
                    } else {
                        alert(response.message || '个人资料更新失败');
                    }
                },
                error: function() {
                    saveBtn.prop('disabled', false).text(originalText);
                    alert('缃戠粶閿欒锛岃绋嶅悗閲嶈�?);
                }
            });
        }

        /**
         * 修改密码
         */
        function changePassword() {
            // 琛ㄥ崟楠岃瘉
            const oldPassword = $('#oldPassword').val();
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            
            if (!oldPassword) {
                alert('请输入当前密�?);
                return;
            }
            
            if (!validators.isStrongPassword(newPassword)) {
                alert('新密码必须包含字母和数字，长度至�?�?);
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一�?);
                return;
            }
            
            // 鏋勫缓璇锋眰鏁版�?
            const data = {
                oldPassword: oldPassword,
                newPassword: newPassword
            };
            
            // 绂佺敤鎻愪氦鎸夐�?
            const submitBtn = $('#submitPasswordChange');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('修改�?..');
            
            $.authAjax({
                url: '/api/user/change-password',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    submitBtn.prop('disabled', false).text(originalText);
                    
                    if (response.code === 200) {
                        showSuccessMessage('密码修改成功，请重新登录');
                        $('#changePasswordModal').modal('hide');
                        setTimeout(() => {
                            authUtils.logout();
                            authUtils.redirectToLogin();
                        }, 2000);
                    } else {
                        alert(response.message || '密码修改失败');
                    }
                },
                error: function() {
                    submitBtn.prop('disabled', false).text(originalText);
                    alert('缃戠粶閿欒锛岃绋嶅悗閲嶈�?);
                }
            });
        }
    </script>
</body>
</html>
