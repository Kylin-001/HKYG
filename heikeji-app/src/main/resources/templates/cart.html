<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´­ç‰©è½? é»‘ç§‘æ˜“è´­</title>
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth-utils.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .cart-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .cart-item:hover {
            background-color: #f8f9fa;
        }
        .cart-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }
        .cart-footer {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .checkbox-custom {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .empty-cart {
            text-align: center;
            padding: 60px 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .empty-cart-icon {
            font-size: 60px;
            color: #ccc;
            margin-bottom: 20px;
        }
        .cart-header {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">é»‘ç§‘æ˜“è´­</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/api/product/list">å•†å“åˆ—è¡¨</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/api/cart">è´­ç‰©è½?/a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/order/list">æˆ‘çš„è®¢å•</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="userMenu">
                    <!-- ç”¨æˆ·èœå•å°†æ ¹æ®ç™»å½•çŠ¶æ€åŠ¨æ€ç”Ÿæˆ?-->
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/login">ç™»å½•</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- åŠ è½½é®ç½©å±?-->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; justify-content: center; align-items: center; display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">åŠ è½½ä¸?..</span>
        </div>
    </div>
    
    <div class="container mt-4">
        <h2>æˆ‘çš„è´­ç‰©è½?/h2>
        
        <div class="cart-content mt-4">
            <!-- è´­ç‰©è½¦å¤´éƒ?-->
            <div class="cart-header row">
                <div class="col-md-1">
                    <input type="checkbox" id="selectAll" class="checkbox-custom" onclick="selectAllItems(this)">
                    <label for="selectAll" style="cursor: pointer; margin-left: 5px;">å…¨é€?/label>
                </div>
                <div class="col-md-3">å•†å“ä¿¡æ¯</div>
                <div class="col-md-2">å•ä»·</div>
                <div class="col-md-2">æ•°é‡</div>
                <div class="col-md-2">å°è®¡</div>
                <div class="col-md-2">æ“ä½œ</div>
            </div>
            
            <div id="cart-items" class="mb-4">
                <!-- è´­ç‰©è½¦å•†å“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€åŠ è½?-->
                <div class="text-center py-5">
                    <p>è´­ç‰©è½¦ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»é€›é€›å§ï¼?/p>
                    <a href="/api/product/list" class="btn btn-primary">å»è´­ç‰?/a>
                </div>
            </div>
        </div>
        
        <div class="cart-footer">
            <div class="row justify-content-between align-items-center">
                <div>
                    <button class="btn btn-outline-danger me-3" onclick="deleteSelectedItems()">åˆ é™¤é€‰ä¸­</button>
                    <button class="btn btn-outline-secondary" onclick="clearCart()">æ¸…ç©ºè´­ç‰©è½?/button>
                </div>
                <div>
                    <span class="mr-3">å·²é€?<span id="total-count">0</span> ä»?/span>
                    <span class="text-danger font-weight-bold">åˆè®¡ï¼šÂ?span id="total-amount">0.00</span></span>
                    <button id="checkout-btn" class="btn btn-danger ml-4 disabled">å»ç»“ç®?/button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç€›æ¨ºåç’î… å¢¿æï¸½æšŸé¹î†¼æ‹°éŸå——æ§æ·‡â„ƒä¼…
        let cartItems = [];
        let productDetails = {};
        
        $(document).ready(function() {
            // é‡å­˜æŸŠç€µè‰°åŸ…éå¿•æ•¤é´é£å§¸é¬?            updateUserMenu();
            
            // å¦«â‚¬éŒãƒ§æ«¥è¤°æ› å§¸é?            if (!authUtils.isLoggedIn()) {
                alert('ç’‡å³°å›é§è¯²ç¶');
                window.location.href = '/api/auth/login';
                return;
            }
            
            // é”çŠºæµ‡ç’î… å¢¿æï¸½æšŸé¹?            loadCartItems();
            
            // é˜è¤ç²¨ç» æ¥å¯œé–½î†¾å£é‘è®³ç°¨æµ?            $('#checkout-btn').click(function() {
                if ($(this).hasClass('disabled')) {
                    return;
                }
                goToCheckout();
            });
        });
        
        // é„å‰§ãšé”çŠºæµ‡é–¬î†¾åƒµç?        function showLoading() {
            $('#loadingOverlay').css('display', 'flex');
        }

        // é—…æ„¯æ£Œé”çŠºæµ‡é–¬î†¾åƒµç?        function hideLoading() {
            $('#loadingOverlay').css('display', 'none');
        }
        
        // é”çŠºæµ‡ç’î… å¢¿æï¸½æšŸé¹?        function loadCartItems() {
            showLoading();
            $.authAjax({
                url: '/api/cart/list',
                type: 'GET',
                success: function(response) {
                hideLoading();
                  if (response.code === 200 && response.data && response.data.length > 0) {
                        cartItems = response.data;
                        // é»æ„¬å½‡éŸå——æ§IDé’æ¥„ã€?
                        const productIds = cartItems.map(item => item.productId);
                        // éµå½’å™ºé‘¾å³°å½‡éŸå——æ§ç’‡ï¸½å„
                        fetchProductDetails(productIds);
                    } else {
                        showEmptyCart();
                    }
                },
                error: function() {
                hideLoading();
                alert('é”çŠºæµ‡ç’î… å¢¿æï¹€ã‘ç’ãƒ¯ç´ç’‡é£â—¢éšåº¨å™¸ç’?);
                showEmptyCart();
                }
            });
        }
        
        // é‘¾å³°å½‡éŸå——æ§ç’‡ï¸½å„?
        function fetchProductDetails(productIds) {
            if (productIds.length === 0) return;
            
            showLoading();
            $.authAjax({
                url: '/api/product/batch',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(productIds),
                success: function(response) {
                hideLoading();
                if (response.code === 200 && response.data) {
                        // é‹å‹«ç¼“éŸå——æ§IDé’æ‹Œî‡›é¯å‘¯æ®‘é„çŠ²çš?
                        response.data.forEach(product => {
                            productDetails[product.id] = product;
                        });
                    }
                    renderCartItems();
                },
                error: function() {
                hideLoading();
                console.error('è·å–å•†å“è¯¦æƒ…å¤±è´¥');
                renderCartItems(); // å³ä½¿è·å–å¤±è´¥ä¹Ÿæ¸²æŸ“è´­ç‰©è½¦
                }
            });
        }
        
        // æ¸²æŸ“è´­ç‰©è½¦å•†å“?
        function renderCartItems() {
            if (cartItems.length === 0) {
                showEmptyCart();
                return;
            }
            
            const cartItemsHtml = cartItems.map(item => {
                const product = productDetails[item.productId] || {};
                const price = product.price || 0;
                const subtotal = (price * item.quantity).toFixed(2);
                const imageUrl = product.mainImage || '/images/default-product.jpg';
                
                return `
                    <div class="cart-item row align-items-center" data-product-id="${item.productId}">
                        <div class="col-md-1">
                            <input type="checkbox" class="cart-item-checkbox checkbox-custom" checked>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <img src="${imageUrl}" alt="${product.name || 'éŸå——æ?}">
                                <div style="margin-left: 10px;">
                                    <h6 class="mb-1"><a href="/api/product/detail/${item.productId}" class="text-dark">${product.name || 'å•†å“'}</a></h6>
                                    <p class="text-muted text-sm mb-0">${product.subtitle || ''}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="text-danger font-weight-bold">Â¥{price.toFixed(2)}</span>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="input-group" style="width: 120px; margin: 0 auto;">
                                <button class="btn btn-outline-secondary decrease-quantity" type="button">-</button>
                                <input type="number" class="form-control text-center" value="${item.quantity}" min="1" max="99">
                                <button class="btn btn-outline-secondary increase-quantity" type="button">+</button>
                            </div>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="text-danger font-weight-bold">é”?{subtotal}</span>
                        </div>
                        <div class="col-md-2 text-center">
                            <button class="btn btn-link delete-item">åˆ é™¤</button>
                            <button class="btn btn-link text-primary buy-now" style="margin-left: 10px;">ç«‹å³è´­ä¹°</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            $('#cart-items').html(cartItemsHtml);
            updateCartSummary();
            bindCartItemEvents();
        }
        
        // æ˜¾ç¤ºç©ºè´­ç‰©è½¦
        function showEmptyCart() {
            $('#cart-items').html(`
                <div class="empty-cart">
                    <div class="empty-cart-icon">é¦ƒæ´…</div>
                    <p>è´­ç‰©è½¦è¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»é€‰è´­å•†å“å§ï¼</p>
                    <a href="/api/product/list" class="btn btn-primary mt-3">å»è´­ç‰?/a>
                </div>
            `);
        }
        
        // å…¨é€?å–æ¶ˆå…¨é€?
        function selectAllItems(checkbox) {
            $('.cart-item-checkbox').prop('checked', checkbox.checked);
            updateCartSummary();
        }
        
        // ç»‘å®šè´­ç‰©è½¦å•†å“äº‹ä»?
        function bindCartItemEvents() {
            // å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶
            $('.cart-item-checkbox').click(updateCartSummary);
            
            // æ•°é‡å¢å‡æŒ‰é’®
            $('.decrease-quantity').click(function() {
                const input = $(this).siblings('input');
                let value = parseInt(input.val());
                if (value > 1) {
                    input.val(value - 1);
                    updateQuantity($(this).closest('.cart-item'), value - 1);
                }
            });
            
            $('.increase-quantity').click(function() {
                const input = $(this).siblings('input');
                let value = parseInt(input.val());
                const cartItem = $(this).closest('.cart-item');
                const productId = cartItem.data('product-id');
                const product = productDetails[productId];
                
                // æ£€æŸ¥åº“å­?
                if (product && value >= product.stock) {
                    alert('åº“å­˜ä¸è¶³');
                    return;
                }
                
                if (value < 99) {
                    input.val(value + 1);
                    updateQuantity(cartItem, value + 1);
                }
            });
            
            // æ•°é‡è¾“å…¥æ¡†å˜æ›?
            $('.form-control').change(function() {
                let value = parseInt($(this).val());
                const cartItem = $(this).closest('.cart-item');
                const productId = cartItem.data('product-id');
                const product = productDetails[productId];
                
                // éªŒè¯æ•°é‡
                if (isNaN(value) || value < 1) {
                    value = 1;
                } else if (value > 99) {
                    value = 99;
                }
                
                // æ£€æŸ¥åº“å­?
                if (product && value > product.stock) {
                    alert('åº“å­˜ä¸è¶³');
                    value = product.stock > 0 ? product.stock : 1;
                }
                
                $(this).val(value);
                updateQuantity(cartItem, value);
            });
            
            // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('.delete-item').click(function() {
                const cartItem = $(this).closest('.cart-item');
                const productId = cartItem.data('product-id');
                deleteCartItem(productId, cartItem);
            });
            
            // ç«‹å³è´­ä¹°æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('.buy-now').click(function() {
                const cartItem = $(this).closest('.cart-item');
                const productId = cartItem.data('product-id');
                const quantity = parseInt(cartItem.find('.form-control').val());
                buyNow(productId, quantity);
            });
        }
        
        // æ›´æ–°å•†å“æ•°é‡
        function updateQuantity(cartItem, quantity) {
            showLoading();
            const productId = cartItem.data('product-id');
            
            // å…ˆæ£€æŸ¥åº“å­?
                const product = productDetails[productId];
            if (product && quantity > product.stock) {
                alert('æ´æ’³ç“¨æ¶“å¶ˆå†»');
                // æ¢å¤åŸæ•°é‡?
                    const cartItemData = cartItems.find(item => item.productId === productId);
                if (cartItemData) {
                    cartItem.find('.form-control').val(cartItemData.quantity);
                }
                return;
            }
            
            $.authAjax({
                url: '/api/cart/update',
                type: 'POST',
                data: { productId: productId, quantity: quantity },
                success: function(response) {
                hideLoading();
                if (response.code === 200) {
                        // æ›´æ–°æœ¬åœ°æ•°æ®
                        const cartItemData = cartItems.find(item => item.productId === productId);
                        if (cartItemData) {
                            cartItemData.quantity = quantity;
                        }
                        // æ›´æ–°å°è®¡
                        const price = product ? product.price : 0;
                        cartItem.find('.col-md-2.text-center:eq(1) span').text(`Â¥{(price * quantity).toFixed(2)}`);
                        updateCartSummary();
                    } else {
                        alert('æ›´æ–°æ•°é‡å¤±è´¥ï¼? + (response.msg || 'æœªçŸ¥é”™è¯¯'));
                        // æ¢å¤åŸæ•°é‡?
                        loadCartItems();
                    }
                },
                error: function() {
                    alert('æ›´æ–°æ•°é‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    loadCartItems();
                }
            });
        }
        
        // åˆ é™¤è´­ç‰©è½¦å•†å“?
        function deleteCartItem(productId, cartItem) {
            showLoading();
            if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥å•†å“å—ï¼Ÿ')) {
                $.authAjax({
                        url: '/api/cart/delete',
                        type: 'POST',
                        data: { productId: productId },
                          success: function(response) {
                          hideLoading();
                          if (response.code === 200) {
                            cartItem.fadeOut('fast', function() {
                                cartItem.remove();
                                // æ›´æ–°æœ¬åœ°æ•°æ®
                                cartItems = cartItems.filter(item => item.productId !== productId);
                                delete productDetails[productId];
                                updateCartSummary();
                                // å¦‚æœè´­ç‰©è½¦ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºè´­ç‰©è½¦æç¤º
                                if ($('.cart-item').length === 0) {
                                    showEmptyCart();
                                }
                            });
                        } else {
                            alert('åˆ é™¤å¤±è´¥ï¼? + (response.msg || 'æœªçŸ¥é”™è¯¯'));
                        }
                    },
                    error: function() {
                              alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                });
            }
        }
        
        // åˆ é™¤é€‰ä¸­çš„å•†å“?
        function deleteSelectedItems() {
            showLoading();
            const selectedItems = [];
            
            $('.cart-item-checkbox:checked').each(function() {
                const productId = $(this).closest('.cart-item').data('product-id');
                selectedItems.push(productId);
            });
            
            if (selectedItems.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å•†å“');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„å•†å“å—ï¼?)) {
                $.authAjax({
                        url: '/api/cart/batch-delete',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(selectedItems),
                        success: function(response) {
                        hideLoading();
                        if (response.code === 200) {
                            // åˆ é™¤é€‰ä¸­çš„å•†å“?
                            selectedItems.forEach(productId => {
                                const cartItem = $(`.cart-item[data-product-id="${productId}"]`);
                                cartItem.fadeOut('fast', function() {
                                    cartItem.remove();
                                });
                                // æ›´æ–°æœ¬åœ°æ•°æ®
                                cartItems = cartItems.filter(item => item.productId !== productId);
                                delete productDetails[productId];
                            });
                            
                            updateCartSummary();
                            
                            // å¦‚æœè´­ç‰©è½¦ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºè´­ç‰©è½¦æç¤º
                            setTimeout(() => {
                                if ($('.cart-item').length === 0) {
                                    showEmptyCart();
                                }
                            }, 300);
                        } else {
                            alert('åˆ é™¤å¤±è´¥ï¼? + (response.msg || 'æœªçŸ¥é”™è¯¯'));
                        }
                    },
                    error: function() {
                        hideLoading();
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                });
            }
        }
        
        // æ¸…ç©ºè´­ç‰©è½?
        function clearCart() {
            showLoading();
            if (cartItems.length === 0) {
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                $.authAjax({
                        url: '/api/cart/clear',
                        type: 'POST',
                        success: function(response) {
                        hideLoading();
                        if (response.code === 200) {
                            // æ¸…ç©ºæœ¬åœ°æ•°æ®
                            cartItems = [];
                            productDetails = {};
                            showEmptyCart();
                            updateCartSummary();
                        } else {
                            alert('æ¸…ç©ºå¤±è´¥ï¼? + (response.msg || 'æœªçŸ¥é”™è¯¯'));
                        }
                    },
                    error: function() {
                        hideLoading();
                        alert('æ¸…ç©ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                });
            }
        }
        
        // æ›´æ–°è´­ç‰©è½¦æ±‡æ€»ä¿¡æ?
        function updateCartSummary() {
            let totalCount = 0;
            let totalAmount = 0;
            let hasChecked = false;
            
            $('.cart-item').each(function() {
                const checkbox = $(this).find('.cart-item-checkbox');
                if (checkbox.is(':checked')) {
                    hasChecked = true;
                    const quantity = parseInt($(this).find('.form-control').val());
                    const priceText = $(this).find('.col-md-2.text-center:eq(0) span').text();
                    const price = parseFloat(priceText.replace('Â¥', ''));
                    totalCount += quantity;
                    totalAmount += price * quantity;
                }
            });
            
            $('#total-count').text(totalCount);
            $('#total-amount').text(totalAmount.toFixed(2));
            
            // å¯ç”¨æˆ–ç¦ç”¨ç»“ç®—æŒ‰é’?
            if (hasChecked) {
                $('#checkout-btn').removeClass('disabled');
            } else {
                $('#checkout-btn').addClass('disabled');
            }
        }
        
        // å»ç»“ç®?
        function goToCheckout() {
            showLoading();
            const selectedItems = [];
            
            $('.cart-item-checkbox:checked').each(function() {
                const cartItem = $(this).closest('.cart-item');
                const productId = cartItem.data('product-id');
                const quantity = parseInt(cartItem.find('.form-control').val());
                
                selectedItems.push({
                    productId: productId,
                    quantity: quantity
                });
            });
            
            if (selectedItems.length === 0) {
                alert('è¯·é€‰æ‹©è¦ç»“ç®—çš„å•†å“');
                return;
            }
            
            // ä¿å­˜é€‰ä¸­çš„å•†å“ä¿¡æ¯åˆ°localStorage
            localStorage.setItem('cartCheckoutItems', JSON.stringify(selectedItems));
            
            // è®¾ç½®ä¸æ˜¯ç›´æ¥è´­ä¹°
            localStorage.setItem('directBuyFlag', 'false');
            
            // å¦«â‚¬éŒãƒ¥ç°±ç€›æ¨ºè‹Ÿé¦ã„¥ç•¬é´æ„¬æ‚—éå†²ç•¾é„îˆšæƒç’ºå® æµ†
            checkCartStockAndProceed(selectedItems);
        }
        
        // æ£€æŸ¥è´­ç‰©è½¦åº“å­˜å¹¶å†³å®šæ˜¯å¦ç»§ç»­ç»“ç®?
        function checkCartStockAndProceed(selectedItems) {
            $.authAjax({
                url: '/api/cart/check-stock',
                type: 'GET',
                success: function(response) {
                        hideLoading();
                        let hasStockIssues = false;
                        let errorMessage = '';
                    
                    // é€‚é…ä¸åŒçš„å“åº”æ ¼å¼?
                    if ((response.code === 200 || response.code === 0) && response.data && response.data.length > 0) {
                        // æœ‰åº“å­˜ä¸è¶³çš„å•†å“
                        hasStockIssues = true;
                        errorMessage = 'ä»¥ä¸‹å•†å“åº“å­˜ä¸è¶³ï¼š\n';
                        response.data.forEach(msg => {
                            errorMessage += msg + '\n';
                        });
                        alert(errorMessage);
                    }
                    
                    // å³ä½¿æœ‰åº“å­˜é—®é¢˜ä¹Ÿå…è®¸ç”¨æˆ·ç»§ç»­ï¼Œä½†ä¼šæç¤?
                    if (!hasStockIssues || confirm('éƒ¨åˆ†å•†å“åº“å­˜ä¸è¶³ï¼Œæ˜¯å¦ç»§ç»­ç»“ç®—ï¼Ÿ')) {
                        // è·³è½¬åˆ°ç»“ç®—é¡µé?
            window.location.href = '/api/checkout';
                    }
                },
                error: function() {
                    hideLoading();
                    console.error('åº“å­˜æ£€æŸ¥å¤±è´?);
                    // åº“å­˜æ£€æŸ¥å¤±è´¥ä¹Ÿå…è®¸ç”¨æˆ·ç»§ç»­ç»“ç®—
                    if (confirm('åº“å­˜æ£€æŸ¥å¤±è´¥ï¼Œæ˜¯å¦ç»§ç»­ç»“ç®—ï¼?)) {
                        window.location.href = '/api/checkout';
                    }
                }
            });
        }
        
        // ç«‹å³è´­ä¹°
        function buyNow(productId, quantity) {
            // éªŒè¯æ•°é‡ä¸å°äº?
            if (!quantity || quantity < 1) {
                alert('è´­ä¹°æ•°é‡å¿…é¡»å¤§äº0');
                return;
            }
            
            // å…ˆæ£€æŸ¥å•ä¸ªå•†å“åº“å­?
            const product = productDetails[productId];
            if (product && quantity > product.stock) {
                alert('è¯¥å•†å“åº“å­˜ä¸è¶?);
                return;
            }
            
            showLoading();
            
            // åˆ›å»ºç›´æ¥è´­ä¹°çš„æ ‡è®?
            localStorage.setItem('directBuyFlag', 'true');
            localStorage.setItem('directBuyItem', JSON.stringify({
                productId: productId,
                quantity: quantity
            }));
            
            // è·³è½¬åˆ°ç»“ç®—é¡µé?
            window.location.href = '/api/checkout';
        }
    </script>
    
    <script>
        // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€?
        function updateUserMenu() {
            const userMenu = $('#userMenu');
            if (authUtils.isLoggedIn()) {
                const username = authUtils.getUsername() || 'ç”¨æˆ·';
                userMenu.html(`
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            ${username}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="/api/order/list">æˆ‘çš„è®¢å•</a>
                            <a class="dropdown-item" href="/api/cart">è´­ç‰©è½?/a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="javascript:void(0)" onclick="logout()">é€€å‡ºç™»å½?/a>
                        </div>
                    </li>
                `);
            } else {
                userMenu.html(`
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/login">ç™»å½•</a>
                    </li>
                `);
            }
        }
        
        // ç”¨æˆ·é€€å‡?
        function logout() {
            authUtils.logout();
            updateUserMenu();
            alert('å·²é€€å‡ºç™»å½?);
            window.location.href = '/api/auth/login';
        }
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°ç”¨æˆ·èœå?
        $(document).ready(function() {
            updateUserMenu();
        });
    </script>
    
    <!-- é¡µè„š -->
    <footer class="bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>å…³äºæˆ‘ä»¬</h5>
                    <p>é»‘ç§‘æ˜“è´­è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›é«˜å“è´¨çš„ç”µå­äº§å“å’Œä¼˜è´¨çš„è´­ç‰©ä½“éªŒã€?/p>
                </div>
                <div class="col-md-4">
                    <h5>å¿«é€Ÿé“¾æ?/h5>
                    <ul class="list-unstyled">
                        <li><a href="/" class="text-dark">é¦–é¡µ</a></li>
                        <li><a href="/api/category/list" class="text-dark">å•†å“åˆ†ç±»</a></li>
                        <li><a href="/api/order/list" class="text-dark">æˆ‘çš„è®¢å•</a></li>
                        <li><a href="/api/cart" class="text-dark">è´­ç‰©è½?/a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>è”ç³»æˆ‘ä»¬</h5>
                    <p>æœåŠ¡ç”µè¯ï¼?00-123-4567</p>
                    <p>é‚®ç®±ï¼šservice@heikeji.com</p>
                </div>
            </div>
            <div class="text-center mt-4">
                <p>&copy; 2024 é»‘ç§‘æ˜“è´­. ä¿ç•™æ‰€æœ‰æƒåˆ?/p>
            </div>
        </div>
    </footer>
</body>
</html>
