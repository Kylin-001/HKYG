<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å€ç®¡ç† - é»‘ç§‘æ˜“è´­</title>
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        /* è‡ªå®šä¹‰æ ·å¼?*/
        .address-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .address-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }
        .address-item .default-badge {
            background-color: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .address-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .address-item:hover .address-actions {
            opacity: 1;
        }
        .add-address-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #007bff;
            border: none;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            transition: all 0.3s ease;
        }
        .add-address-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ ?-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="/static/images/logo.png" alt="é»‘ç§‘æ˜“è´­" height="30">
                    <span class="ms-2">é»‘ç§‘æ˜“è´­</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/category-list">åˆ†ç±»</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/product-list">å•†å“åˆ—è¡¨</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/cart">è´­ç‰©è½?/a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span id="username">{{username}}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/api/address-list">åœ°å€ç®¡ç†</a></li>
                            <li><a class="dropdown-item" href="/api/order-list">æˆ‘çš„è®¢å•</a></li>
                            <li><a class="dropdown-item" href="/api/takeout-order-list">å¤–å–è®¢å•</a></li>
                            <li><a class="dropdown-item" href="/api/delivery-request-list">è·‘è…¿æœåŠ¡</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" id="logoutBtn">é€€å‡ºç™»å½?/a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="container my-5">
        <div class="row">
            <!-- ä¾§è¾¹æ ?-->
            <div class="col-lg-3 mb-5 mb-lg-0">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">ç”¨æˆ·ä¸­å¿ƒ</div>
                    <div class="list-group">
                        <a href="/api/order-list" class="list-group-item list-group-item-action">æˆ‘çš„è®¢å•</a>
                        <a href="/api/takeout-order-list" class="list-group-item list-group-item-action">å¤–å–è®¢å•</a>
                        <a href="/api/delivery-request-list" class="list-group-item list-group-item-action">è·‘è…¿æœåŠ¡</a>
                        <a href="/api/address-list" class="list-group-item list-group-item-action active">åœ°å€ç®¡ç†</a>
                        <a href="/api/profile" class="list-group-item list-group-item-action">ä¸ªäººèµ„æ–™</a>
                    </div>
                </div>
            </div>

            <!-- åœ°å€åˆ—è¡¨åŒºåŸŸ -->
            <div class="col-lg-9">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">æˆ‘çš„æ”¶è´§åœ°å€</h5>
                        <span class="text-muted" id="addressCount"></span>
                    </div>
                    <div class="card-body">
                        <!-- åŠ è½½ä¸­çŠ¶æ€?-->
                        <div id="loading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸?..</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨åŠ è½½åœ°å€ä¿¡æ¯...</p>
                        </div>

                        <!-- åœ°å€åˆ—è¡¨ -->
                        <div id="addressList" class="mt-4 d-none">
                            <!-- åœ°å€é¡¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ?-->
                        </div>

                        <!-- ç©ºçŠ¶æ€?-->
                        <div id="emptyState" class="text-center py-10 d-none">
                            <img src="/static/images/empty-address.png" alt="æš‚æ— åœ°å€" class="mb-3" style="width: 150px;">
                            <p class="text-muted">æ‚¨è¿˜æ²¡æœ‰æ·»åŠ æ”¶è´§åœ°å€</p>
                            <button class="btn btn-primary mt-2" id="emptyAddAddressBtn">æ·»åŠ åœ°å€</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åœ°å€æŒ‰é’® -->
    <button class="add-address-btn" id="addAddressBtn">+</button>

    <!-- é®ç½©å±?-->
    <div id="mask" class="fixed inset-0 bg-black bg-opacity-50 d-none" style="z-index: 1000;"></div>

    <!-- åœ°å€è¡¨å•æ¨¡æ€æ¡† -->
    <div id="addressModal" class="fixed top-50 left-50 transform -translate-x-50 -translate-y-50 bg-white rounded-lg shadow-lg p-5 w-100 max-w-2xl d-none" style="z-index: 1001;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0" id="modalTitle">æ·»åŠ æ”¶è´§åœ°å€</h5>
            <button class="btn-close" id="closeModalBtn"></button>
        </div>
        <form id="addressForm">
            <input type="hidden" id="addressId" name="addressId">
            <div class="mb-3">
                <label for="consignee" class="form-label">æ”¶è´§äº?/label>
                <input type="text" class="form-control" id="consignee" name="consignee" required placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å">
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">æ‰‹æœºå·ç </label>
                <input type="tel" class="form-control" id="phone" name="phone" required placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ?>
            </div>
            <div class="mb-3">
                <label for="address" class="form-label">è¯¦ç»†åœ°å€</label>
                <textarea class="form-control" id="address" name="address" rows="3" required placeholder="è¯·è¾“å…¥å®Œæ•´åœ°å€ä¿¡æ¯"></textarea>
            </div>
            <div class="mb-3">
                <label for="location" class="form-label">ä½ç½®ç±»å‹</label>
                <select class="form-select" id="location" name="location" required>
                    <option value="">è¯·é€‰æ‹©ä½ç½®ç±»å‹</option>
                    <option value="dorm">å®¿èˆ</option>
                    <option value="office">åŠå…¬æ¥?/option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="isDefault" name="isDefault">
                    <label class="form-check-label" for="isDefault">è®¾ä¸ºé»˜è®¤åœ°å€</label>
                </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="button" class="btn btn-secondary" id="cancelBtn">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">ä¿å­˜</button>
            </div>
        </form>
    </div>

    <!-- ç¡®è®¤å¯¹è¯æ¡?-->
    <div id="confirmModal" class="fixed top-50 left-50 transform -translate-x-50 -translate-y-50 bg-white rounded-lg shadow-lg p-5 w-100 max-w-sm d-none" style="z-index: 1001;">
        <h5 class="mb-3">ç¡®è®¤æ“ä½œ</h5>
        <p class="mb-4" id="confirmMessage">ç¡®å®šè¦åˆ é™¤è¯¥åœ°å€å—ï¼Ÿ</p>
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" id="confirmCancelBtn">å–æ¶ˆ</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">åˆ é™¤</button>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="text-center">
                <p class="text-muted">é»‘ç§‘æ˜“è´­ - æ ¡å›­ç”Ÿæ´»æœåŠ¡å¹³å°</p>
                <p class="text-muted">Â© 2023 heikeji-mall. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- å¼•å…¥ jQuery -->
<script src="/js/jquery.min.js"></script>
    <!-- å¼•å…¥ Bootstrap JS -->
<script src="/js/bootstrap.bundle.min.js"></script>
    <!-- å¼•å…¥è®¤è¯å·¥å…· -->
    <script src="/js/auth-utils.js"></script>
    
    <script>
        // å½“å‰æ­£åœ¨ç¼–è¾‘æˆ–åˆ é™¤çš„åœ°å€ID
        let currentAddressId = null;
        let isEditMode = false;
        
        /**
         * éªŒè¯å·¥å…·å‡½æ•°
         */
        const validators = {
            isValidPhone: function(phone) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                return phoneRegex.test(phone);
            }
        };
        
        /**
         * æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
         */
        function showSuccessMessage(message) {
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„æˆåŠŸæ¶ˆæ¯æç¤º
            const messageElement = $('<div class="alert alert-success alert-dismissible fade show position-fixed top-20 left-50 transform -translate-x-50 z-50" role="alert">').text(message);
            const closeButton = $('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');
            messageElement.append(closeButton);
            
            $('body').append(messageElement);
            
            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                messageElement.alert('close');
            }, 3000);
        }

        $(document).ready(function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€?
            authUtils.checkLogin();
            
            // æ›´æ–°ç”¨æˆ·å?
            $('#username').text(authUtils.getUsername() || 'ç”¨æˆ·');
            
            // åŠ è½½åœ°å€åˆ—è¡¨
            loadAddressList();
            
            // æ·»åŠ åœ°å€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#addAddressBtn, #emptyAddAddressBtn').click(function() {
                openAddressModal();
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            $('#closeModalBtn, #cancelBtn').click(function() {
                closeAddressModal();
            });
            
            // é®ç½©å±‚ç‚¹å‡»å…³é—­æ¨¡æ€æ¡†
            $('#mask').click(function() {
                closeAddressModal();
                closeConfirmModal();
            });
            
            // åœ°å€è¡¨å•æäº¤
            $('#addressForm').submit(function(event) {
                event.preventDefault();
                saveAddress();
            });
            
            // ç¡®è®¤åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#confirmDeleteBtn').click(function() {
                deleteAddress();
            });
            
            // å–æ¶ˆåˆ é™¤
            $('#confirmCancelBtn').click(function() {
                closeConfirmModal();
            });
            
            // é€€å‡ºç™»å½?
            $('#logoutBtn').click(function() {
                authUtils.logout();
                window.location.href = '/api/auth/login';
            });
        });

        /**
         * åŠ è½½åœ°å€åˆ—è¡¨
         */
        function loadAddressList() {
            $('#loading').removeClass('d-none');
            $('#addressList').addClass('d-none');
            $('#emptyState').addClass('d-none');
            
            $.authAjax({
                url: '/api/address/list',
                type: 'GET',
                success: function(response) {
                    $('#loading').addClass('d-none');
                    
                    if (response.code === 200 && response.data && response.data.length > 0) {
                        const addresses = response.data;
                        $('#addressCount').text(`å…?${addresses.length} ä¸ªåœ°å€`);
                        renderAddressList(addresses);
                        $('#addressList').removeClass('d-none');
                    } else {
                        $('#emptyState').removeClass('d-none');
                    }
                },
                error: function() {
                    $('#loading').addClass('d-none');
                    alert('åŠ è½½åœ°å€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        /**
         * æ¸²æŸ“åœ°å€åˆ—è¡¨
         */
        function renderAddressList(addresses) {
            const $addressList = $('#addressList');
            $addressList.empty();
            
            addresses.forEach(address => {
                const addressHtml = `
                    <div class="address-item" data-id="${address.addressId}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <strong class="me-3">${address.consignee}</strong>
                                <span>${address.phone}</span>
                                ${address.isDefault ? '<span class="default-badge ml-2">é»˜è®¤</span>' : ''}
                            </div>
                            <div class="address-actions">
                                <button class="btn btn-sm btn-outline-primary me-1 edit-btn">ç¼–è¾‘</button>
                                <button class="btn btn-sm btn-outline-danger delete-btn">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="text-muted">${address.address}</div>
                        <div class="mt-2 text-sm text-muted">
                            ä½ç½®ç±»å‹ï¼?{address.location === 'dorm' ? 'å®¿èˆ' : address.location === 'office' ? 'åŠå…¬æ¥? : 'å…¶ä»–'}
                        </div>
                    </div>
                `;
                
                $addressList.append(addressHtml);
            });
            
            // ç»‘å®šç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®äº‹ä»?
            $('.edit-btn').click(function() {
                const addressId = $(this).closest('.address-item').data('id');
                editAddress(addressId);
            });
            
            $('.delete-btn').click(function() {
                const addressId = $(this).closest('.address-item').data('id');
                confirmDelete(addressId);
            });
        }

        /**
         * æ‰“å¼€åœ°å€ç¼–è¾‘æ¨¡æ€æ¡†
         */
        function openAddressModal() {
            isEditMode = false;
            $('#modalTitle').text('æ·»åŠ æ”¶è´§åœ°å€');
            $('#addressForm')[0].reset();
            $('#addressId').val('');
            
            $('#mask').removeClass('d-none');
            $('#addressModal').removeClass('d-none');
        }

        /**
         * ç¼–è¾‘åœ°å€
         */
        function editAddress(addressId) {
            isEditMode = true;
            currentAddressId = addressId;
            $('#modalTitle').text('ç¼–è¾‘æ”¶è´§åœ°å€');
            
            // åŠ è½½åœ°å€è¯¦æƒ…
            $.authAjax({
                url: `/api/address/detail/${addressId}`,
                type: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        const address = response.data;
                        $('#addressId').val(address.addressId);
                        $('#consignee').val(address.consignee);
                        $('#phone').val(address.phone);
                        $('#address').val(address.address);
                        $('#location').val(address.location);
                        $('#isDefault').prop('checked', address.isDefault);
                        
                        $('#mask').removeClass('d-none');
                        $('#addressModal').removeClass('d-none');
                    }
                }
            });
        }

        /**
         * å…³é—­åœ°å€æ¨¡æ€æ¡†
         */
        function closeAddressModal() {
            $('#mask').addClass('d-none');
            $('#addressModal').addClass('d-none');
            currentAddressId = null;
        }

        /**
         * ä¿å­˜åœ°å€
         */
        function saveAddress() {
            // è¡¨å•éªŒè¯
            const consignee = $('#consignee').val().trim();
            const phone = $('#phone').val().trim();
            const address = $('#address').val().trim();
            const location = $('#location').val();
            
            if (!consignee) {
                alert('è¯·è¾“å…¥æ”¶è´§äººå§“å');
                return;
            }
            
            if (!validators.isValidPhone(phone)) {
                alert('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
                return;
            }
            
            if (!address) {
                alert('è¯·è¾“å…¥è¯¦ç»†åœ°å€');
                return;
            }
            
            if (!location) {
                alert('è¯·é€‰æ‹©ä½ç½®ç±»å‹');
                return;
            }
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const data = {
                consignee: consignee,
                phone: phone,
                address: address,
                location: location,
                isDefault: $('#isDefault').is(':checked')
            };
            
            // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ·»åŠ åœ°å€ID
            if (isEditMode) {
                data.addressId = $('#addressId').val();
            }
            
            // ç¦ç”¨ä¿å­˜æŒ‰é’®
            $('#saveBtn').prop('disabled', true).text('ä¿å­˜ä¸?.');
            
            $.authAjax({
                url: isEditMode ? '/api/address/update' : '/api/address/add',
                type: isEditMode ? 'PUT' : 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    $('#saveBtn').prop('disabled', false).text('ä¿å­˜');
                    
                    if (response.code === 200) {
                        showSuccessMessage(isEditMode ? 'åœ°å€æ›´æ–°æˆåŠŸ' : 'åœ°å€æ·»åŠ æˆåŠŸ');
                        closeAddressModal();
                        loadAddressList(); // é‡æ–°åŠ è½½åœ°å€åˆ—è¡¨
                    } else {
                        alert(response.message || (isEditMode ? 'åœ°å€æ›´æ–°å¤±è´¥' : 'åœ°å€æ·»åŠ å¤±è´¥'));
                    }
                },
                error: function() {
                    $('#saveBtn').prop('disabled', false).text('æ·‡æ¿†ç“?);
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        /**
         * ç¡®è®¤åˆ é™¤
         */
        function confirmDelete(addressId) {
            currentAddressId = addressId;
            $('#confirmMessage').text('ç¡®å®šè¦åˆ é™¤è¯¥åœ°å€å—ï¼Ÿåˆ é™¤åä¸å¯æ¢å¤?);
            $('#mask').removeClass('d-none');
            $('#confirmModal').removeClass('d-none');
        }

        /**
         * å…³é—­ç¡®è®¤å¯¹è¯æ¡?
         */
        function closeConfirmModal() {
            $('#mask').addClass('d-none');
            $('#confirmModal').addClass('d-none');
            currentAddressId = null;
        }

        /**
         * åˆ é™¤åœ°å€
         */
        function deleteAddress() {
            if (!currentAddressId) return;
            
            // ç¦ç”¨åˆ é™¤æŒ‰é’®
            $('#confirmDeleteBtn').prop('disabled', true).text('åˆ é™¤ä¸?.');
            
            $.authAjax({
                url: `/api/address/delete/${currentAddressId}`,
                type: 'DELETE',
                success: function(response) {
                    $('#confirmDeleteBtn').prop('disabled', false).text('åˆ é™¤');
                    
                    if (response.code === 200) {
                        showSuccessMessage('åœ°å€åˆ é™¤æˆåŠŸ');
                        closeConfirmModal();
                        loadAddressList(); // é‡æ–°åŠ è½½åœ°å€åˆ—è¡¨
                    } else {
                        alert(response.message || 'åœ°å€åˆ é™¤å¤±è´¥');
                        closeConfirmModal();
                    }
                },
                error: function() {
                    $('#confirmDeleteBtn').prop('disabled', false).text('åˆ é™¤');
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                    closeConfirmModal();
                }
            });
        }
    </script>
</body>
</html>
