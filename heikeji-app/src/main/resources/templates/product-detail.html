<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è¯¦æƒ… - é»‘ç§‘æ˜“è´­</title>
<link rel="stylesheet" href="/css/bootstrap.min.css">
    <style>
        .product-main-image {
            width: 100%;
            height: 400px;
            object-fit: contain;
            border: 1px solid #e0e0e0;
            padding: 10px;
        }
        .image-thumbnails {
            margin-top: 10px;
        }
        .image-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            margin-right: 10px;
            padding: 5px;
            transition: border-color 0.3s ease;
        }
        .image-thumbnail.active {
            border-color: #007bff;
        }
        .product-price {
            color: #e74c3c;
            font-size: 28px;
            font-weight: bold;
            margin-right: 10px;
        }
        .product-original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 16px;
        }
        .product-info {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-input {
            width: 50px;
            height: 30px;
            border: 1px solid #e0e0e0;
            text-align: center;
            border-left: none;
            border-right: none;
        }
        .btn-add-cart, .btn-buy-now {
            padding: 10px 30px;
            font-size: 16px;
            margin-right: 15px;
        }
        .product-detail-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        .section-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ ?-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">é»‘ç§‘æ˜“è´­</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                    <a class="nav-link" href="/api/product/list">å•†å“åˆ—è¡¨</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api/cart">è´­ç‰©è½?/a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/api/order/list">æˆ‘çš„è®¢å•</a>
                </li>
                </ul>
                <div class="navbar-nav" id="userMenu">
                    <!-- ç”¨æˆ·èœå•å°†æ ¹æ®ç™»å½•çŠ¶æ€åŠ¨æ€ç”Ÿæˆ?-->
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/login">ç™»å½•</a>
                    </li>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- é¢åŒ…å±‘å¯¼èˆ?-->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">é¦–é¡µ</a></li>
                <li class="breadcrumb-item"><a href="/api/product/list">å•†å“åˆ—è¡¨</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="breadcrumbProductName"></li>
            </ol>
        </nav>

        <!-- åŠ è½½ä¸­çŠ¶æ€?-->
        <div id="loading" class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="sr-only">åŠ è½½ä¸?..</span>
            </div>
        </div>

        <!-- å•†å“ä¿¡æ¯åŒºåŸŸ -->
        <div id="productDetail" style="display: none;">
            <div class="row">
                <!-- å•†å“å›¾ç‰‡ -->
                <div class="col-md-6">
                    <img id="mainImage" src="" alt="å•†å“å›¾ç‰‡" class="product-main-image">
                    <div class="image-thumbnails" id="imageThumbnails">
                        <!-- ç¼©ç•¥å›¾ä¼šåŠ¨æ€åŠ è½?-->
                    </div>
                </div>

                <!-- å•†å“ä¿¡æ¯ -->
                <div class="col-md-6">
                    <h1 id="productName" class="mb-3"></h1>
                    <p id="productSubtitle" class="text-muted mb-4"></p>

                    <div class="product-info">
                        <div class="d-flex items-center mb-3">
                            <span class="product-price" id="productPrice"></span>
                              <span class="product-original-price" id="productOriginalPrice"></span>
                          </div>
                        <div class="mb-2">
                            <span class="text-muted mr-2">é”€é‡?</span>
                            <span id="productSales"></span>
                        </div>
                        <div>
                            <span class="text-muted mr-2">åº“å­˜:</span>
                            <span id="productStock"></span>
                        </div>
                    </div>

                    <!-- è´­ä¹°æ•°é‡ -->
                    <div class="quantity-control">
                        <span class="text-muted mr-2">æ•°é‡:</span>
                        <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
                        <input type="number" id="quantity" class="quantity-input" value="1" min="1" onchange="validateQuantity()">
                        <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="mt-4">
                        <button class="btn btn-primary btn-add-cart" onclick="addToCart()">åŠ å…¥è´­ç‰©è½?/button>
                        <button class="btn btn-danger btn-buy-now" onclick="buyNow()">ç«‹å³è´­ä¹°</button>
                    </div>
                </div>
            </div>

            <!-- å•†å“è¯¦æƒ… -->
            <div class="product-detail-section">
                <h3 class="section-title">å•†å“è¯¦æƒ…</h3>
                <div id="productDetailContent" class="text-muted">
                    <!-- å•†å“è¯¦æƒ…ä¼šåŠ¨æ€åŠ è½?-->
                </div>
            </div>
        </div>
    </div>

<script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/auth-utils.js"></script>
    <script>
        // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€?
        function updateUserMenu() {
            const userMenu = $('#userMenu');
            if (authUtils.isLoggedIn()) {
                const username = authUtils.getUsername() || 'ç”¨æˆ·';
                userMenu.html(`
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            ${username}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="/api/order/list">é´æˆ æ®‘ç’ãˆ å´Ÿ</a>
                        <a class="dropdown-item" href="/api/cart">ç’î… å¢¿æ?/a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="javascript:void(0)" onclick="logout()">é–«â‚¬é‘è™¹æ«¥è¤°?/a>
                        </div>
                    </li>
                `);
            } else {
                userMenu.html(`
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/login">é§è¯²ç¶?/a>
                    </li>
                `);
            }
        }
        
        // é„å‰§ãšé”çŠºæµ‡é–¬î†¾åƒµç?        function showLoading() {
            $('#loadingOverlay').css('display', 'flex');
        }

        // é—…æ„¯æ£Œé”çŠºæµ‡é–¬î†¾åƒµç?        function hideLoading() {
            $('#loadingOverlay').css('display', 'none');
        }

        // é¢ã„¦åŸ›é§è¯²åš­
        function logout() {
            authUtils.logout();
            updateUserMenu();
            alert('å®¸æŸ¥â‚¬â‚¬é‘è™¹æ«¥è¤°?);
            window.location.href = '/api/auth/login';
        }
        
        // æ¤¤ç”¸æ½°é”çŠºæµ‡éƒèˆµæ´¿é‚æ‰®æ•¤é´ç–¯å½é—?        $(document).ready(function() {
            updateUserMenu();
        });
    </script>
    <script>
        let productId = null;
        let productData = null;

        $(function() {
            // æµ å¶¶RLé‘¾å³°å½‡éŸå——æ§ID
            const urlParams = new URLSearchParams(window.location.search);
            productId = urlParams.get('productId') || window.location.pathname.split('/').pop();
            
            if (productId) {
                loadProductDetail();
            } else {
                alert('éŸå——æ§IDæ¶“å¶…ç“¨é¦?);
                window.history.back();
            }
        });

        // é”çŠºæµ‡éŸå——æ§ç’‡ï¸½å„?
        function loadProductDetail() {
            showLoading();
            $.authAjax({
                url: `/api/product/detail/${productId}`,
                type: 'GET',
                success: function(res) {
                    hideLoading();
                    if (res.code === 200) {
                        productData = res.data;
                        renderProductDetail(productData);
                        $('#loading').hide();
                        $('#productDetail').show();
                    } else {
                        alert(res.msg || 'éŸå——æ§æ¶“å¶…ç“¨é?);
                        window.history.back();
                    }
                },
                error: function() {
                    hideLoading();
                    alert('ç¼ƒæˆ ç²¶å¯®å‚šçˆ¶é”›å²ƒî‡¬ç»‹å¶…æ‚—é–²å¶ˆç˜?);
                }
            });
        }

        // å¨“å‰ç…‹éŸå——æ§ç’‡ï¸½å„?
        function renderProductDetail(product) {
            $('#productName').text(product.name);
            $('#productSubtitle').text(product.subtitle);
            $('#breadcrumbProductName').text(product.name);
            $('#productPrice').text('æ¥? + product.price);
            $('#productOriginalPrice').text('æ¥? + product.originalPrice);
            $('#productSales').text(product.sales);
            $('#productStock').text(product.stock);
            
            // ç’å‰§ç–†æ¶“è¯²æµ˜
            $('#mainImage').attr('src', product.mainImage);
            
            // å¨“å‰ç…‹ç¼‚â•ƒæšé?            const imageThumbnails = $('#imageThumbnails');
            imageThumbnails.empty();
            
            // æ¶“è¯²æµ˜æµ£æ»€è´Ÿç»—îƒ¿ç«´æ¶“î†ç¼‰é£ãƒ¥æµ˜
            const mainThumbnail = $('<img>')
                .attr('src', product.mainImage)
                .addClass('image-thumbnail active')
                .on('click', function() {
                    $('#mainImage').attr('src', product.mainImage);
                    $('.image-thumbnail').removeClass('active');
                    $(this).addClass('active');
                });
            imageThumbnails.append(mainThumbnail);
            
            // éæœµç²¬é¥å‰§å¢–æµ£æ»€è´Ÿç¼‚â•ƒæšé?            if (product.images) {
                const images = product.images.split(',');
                images.forEach(img => {
                    if (img && img.trim()) {
                        const thumbnail = $('<img>')
                            .attr('src', img.trim())
                            .addClass('image-thumbnail')
                            .on('click', function() {
                                $('#mainImage').attr('src', img.trim());
                                $('.image-thumbnail').removeClass('active');
                                $(this).addClass('active');
                            });
                        imageThumbnails.append(thumbnail);
                    }
                });
            }
            
            // å¨“å‰ç…‹éŸå——æ§ç’‡ï¸½å„?
            $('#productDetailContent').html(product.detail || '<p>é†å‚›æ£¤ç’‡ï¸½å„</p>');
        }

        // é€ç‘°å½‰ç’î…æ‹±éä¼´å™º
        function changeQuantity(delta) {
            const quantityInput = $('#quantity');
            let currentQuantity = parseInt(quantityInput.val());
            currentQuantity += delta;
            
            // çº­î†»ç¹šéä¼´å™ºé¦ã„¥æ‚éå—šå¯–é¥æ‘å”?
            if (currentQuantity < 1) {
                currentQuantity = 1;
            }
            if (productData && currentQuantity > productData.stock) {
                currentQuantity = productData.stock;
            }
            
            quantityInput.val(currentQuantity);
        }

        // æ¥ å²ƒç˜‰éä¼´å™ºæˆæ’³å?
        function validateQuantity() {
            const quantityInput = $('#quantity');
            let currentQuantity = parseInt(quantityInput.val());
            
            if (isNaN(currentQuantity) || currentQuantity < 1) {
                currentQuantity = 1;
            }
            if (productData && currentQuantity > productData.stock) {
                currentQuantity = productData.stock;
            }
            
            quantityInput.val(currentQuantity);
        }

        // é”çŠ²å†ç’î… å¢¿æ?        function addToCart() {
            // å¦«â‚¬éŒãƒ§æ«¥è¤°æ› å§¸é?            if (!authUtils.isLoggedIn()) {
                alert('ç’‡å³°å›é§è¯²ç¶');
                window.location.href = '/api/auth/login';
                return;
            }
            
            const quantity = parseInt($('#quantity').val());
            
            if (!productData) {
                alert('éŸå——æ§æ·‡â„ƒä¼…é”çŠºæµ‡æ¾¶è¾«è§¦');
                return;
            }
            
            if (quantity > productData.stock) {
                alert('æ´æ’³ç“¨æ¶“å¶ˆå†»');
                return;
            }
            
            showLoading();
            $.authAjax({
                url: '/api/cart/add',
                type: 'POST',
                data: {
                    productId: productData.id,
                    quantity: quantity
                },
                success: function(res) {
                    hideLoading();
                    if (res.code === 200) {
                        alert('å¨£è¯²å§é´æ„¬å§›é”?);
                    // å¨£è¯²å§é´æ„¬å§›éšåº¢æ´¿é‚ç™ Ié»æ„®ã?
                    const btn = $(this);
                    btn.text('å®¸æ’å§é?);
                    btn.prop('disabled', true);
                    btn.addClass('btn-success');
                    btn.removeClass('btn-primary');
                    
                    // 3ç§’åæ¢å¤æŒ‰é’®çŠ¶æ€?
                    setTimeout(() => {
                        btn.text('åŠ å…¥è´­ç‰©è½?);
                        btn.prop('disabled', false);
                        btn.removeClass('btn-success');
                        btn.addClass('btn-primary');
                    }, 3000);
                    } else {
                        alert(res.msg || 'æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                },
                error: function() {
                    hideLoading();
                    alert('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
                }
            });
        }

        // ç«‹å³è´­ä¹°
        function buyNow() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€?
            if (!authUtils.isLoggedIn()) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/api/auth/login';
                return;
            }
            
            const quantity = parseInt($('#quantity').val());
            
            // éªŒè¯æ•°é‡ä¸å°äº?
            if (!quantity || quantity < 1) {
                alert('è´­ä¹°æ•°é‡å¿…é¡»å¤§äº0');
                return;
            }
            
            if (!productData) {
                alert('å•†å“ä¿¡æ¯åŠ è½½å¤±è´¥');
                return;
            }
            
            if (quantity > productData.stock) {
                alert('åº“å­˜ä¸è¶³');
                return;
            }
            
            // åˆ›å»ºä¸´æ—¶è®¢å•ä¿¡æ¯ï¼Œä½¿ç”¨ä¸cart.htmlå’Œcheckout.htmlä¸€è‡´çš„localStorageé”®å
            localStorage.setItem('directBuyFlag', 'true');
            localStorage.setItem('directBuyItem', JSON.stringify({
                productId: productData.id,
                quantity: quantity
            }));
            
            window.location.href = '/api/checkout';
        }
    </script>
    
    <!-- åŠ è½½é®ç½©å±?-->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; justify-content: center; align-items: center; display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">åŠ è½½ä¸?..</span>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>å…³äºæˆ‘ä»¬</h5>
                    <p>é»‘ç§‘æ˜“è´­è‡´åŠ›äºä¸ºç”¨æˆ·æä¾›é«˜å“è´¨çš„ç”µå­äº§å“å’Œä¼˜è´¨çš„è´­ç‰©ä½“éªŒã€?/p>
                </div>
                <div class="col-md-4">
                    <h5>å¿«é€Ÿé“¾æ?/h5>
                    <ul class="list-unstyled">
                        <li><a href="/" class="text-dark">é¦–é¡µ</a></li>
                    <li><a href="/api/category/list" class="text-dark">å•†å“åˆ†ç±»</a></li>
                    <li><a href="/api/order/list" class="text-dark">æˆ‘çš„è®¢å•</a></li>
                    <li><a href="/api/cart" class="text-dark">è´­ç‰©è½?/a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>è”ç³»æˆ‘ä»¬</h5>
                    <p>æœåŠ¡ç”µè¯ï¼?00-123-4567</p>
                    <p>é‚®ç®±ï¼šservice@heikeji.com</p>
                </div>
            </div>
            <div class="text-center mt-4">
                <p>&copy; 2024 é»‘ç§‘æ˜“è´­. ä¿ç•™æ‰€æœ‰æƒåˆ?/p>
            </div>
        </div>
    </footer>
</body>
</html>
