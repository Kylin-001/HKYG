<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•æ”¯ä»˜ - é»‘ç§‘æ˜“è´­</title>
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth-utils.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-weight: bold;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        .payment-qrcode {
            text-align: center;
            padding: 20px;
        }
        .payment-qrcode img {
            width: 200px;
            height: 200px;
            margin-bottom: 10px;
        }
        .payment-status {
            text-align: center;
            padding: 40px 0;
        }
        .payment-status-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .status-success {
            color: #28a745;
        }
        .status-pending {
            color: #ffc107;
        }
        .btn-group {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="/">é»‘ç§‘æ˜“è´­</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api/cart">è´­ç‰©è½?/a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/api/order/list">æˆ‘çš„è®¢å•</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="userMenu">
                    <!-- ç”¨æˆ·èœå•å°†æ ¹æ®ç™»å½•çŠ¶æ€åŠ¨æ€ç”Ÿæˆ?-->
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/login">ç™»å½•</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>è®¢å•æ”¯ä»˜</h2>
        
        <!-- è®¢å•ä¿¡æ¯ -->
        <div class="section">
            <div class="section-title">è®¢å•ä¿¡æ¯</div>
            <div class="order-info">
                <p><strong>è®¢å•å·ï¼š</strong><span id="order-no"></span></p>
                <p><strong>æ”¯ä»˜é‡‘é¢ï¼?/strong><span class="text-danger" id="payment-amount"></span></p>
                <p><strong>è®¢å•çŠ¶æ€ï¼š</strong><span id="order-status"></span></p>
            </div>
        </div>
        
        <!-- æ”¯ä»˜çŠ¶æ€?-->
        <div class="section">
            <div class="section-title">æ”¯ä»˜çŠ¶æ€?/div>
            <div id="payment-status-container" class="payment-status">
                <div id="status-icon" class="payment-status-icon">â?/div>
                <h3 id="status-text">è¯·å°½å¿«å®Œæˆæ”¯ä»?/h3>
                <p id="status-desc">æ”¯ä»˜äºŒç»´ç æœ‰æ•ˆæœŸä¸?<span id="countdown">15:00</span></p>
                <div id="qr-code-container" class="payment-qrcode d-none">
                        <img id="qr-code-img" src="/images/payment-placeholder.png" alt="æ”¯ä»˜äºŒç»´ç ? class="qrcode-image">
                        <p class="qrcode-text">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç æ”¯ä»?/p>
                        <button id="simulate-payment-btn" class="btn btn-primary mt-3" style="display: block; margin: 20px auto;">æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ</button>
                    </div>
                <div class="btn-group">
                    <a href="/api/order/list" class="btn btn-secondary">æŸ¥çœ‹æˆ‘çš„è®¢å•</a>
                    <a href="/" class="btn btn-primary">ç»§ç»­è´­ç‰©</a>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½é®ç½©å±?-->
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">åŠ è½½ä¸?..</span>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // é¡µé¢åˆå§‹åŒ?
            updateUserMenu();
            initPayment();
        });
        
        // æ”¯ä»˜ç›¸å…³å˜é‡
        let orderNo = '';
        let paymentAmount = '';
        
        // åˆå§‹åŒ–æ”¯ä»˜åŠŸèƒ?
        function initPayment() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼Œå¦‚æœæœªç™»å½•åˆ™è·³è½¬
            if (!authUtils.checkLogin()) {
                return;
            }
            
            // ä»URLè·å–è®¢å•å?
            const urlParams = new URLSearchParams(window.location.search);
            orderNo = urlParams.get('orderNo');
            
            if (!orderNo) {
                showError('è®¢å•å·ä¸å­˜åœ¨');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }
            
            // æ˜¾ç¤ºè®¢å•å?
            $('#order-no').text(orderNo);
            
            // è·å–è®¢å•è¯¦æƒ…
            getOrderDetail(orderNo);
            
            // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('#simulate-payment-btn').click(function() {
                clearInterval(window.pollingTimer);
                updatePaymentStatus(true);
                $('#order-status').text('å·²æ”¯ä»?);
            });
        }
        
        // è·å–è®¢å•è¯¦æƒ…
        function getOrderDetail(orderNo) {
            showLoading();
            $.authAjax({
                url: '/api/order/detail',
                type: 'GET',
                data: { orderNo: orderNo },
                success: function(response) {
                    hideLoading();
                    if (response.code === 200 && response.data) {
                        const order = response.data;
                        paymentAmount = order.totalAmount + order.freightAmount;
                        
                        // æ›´æ–°é¡µé¢æ˜¾ç¤º
                        $('#payment-amount').text('Â¥' + paymentAmount.toFixed(2));
                        updateOrderStatusText(order.status);
                        
                        // å¦‚æœè®¢å•æœªæ”¯ä»˜ï¼Œåˆ›å»ºæ”¯ä»˜
                        if (order.status === 0) {
                            createPayment(order.id, orderNo, paymentAmount, 1); // é»˜è®¤å¾®ä¿¡æ”¯ä»˜
                        } else if (order.status === 1) {
                            // å¦‚æœè®¢å•å·²æ”¯ä»˜ï¼Œç›´æ¥æ˜¾ç¤ºæˆåŠŸ
                            updatePaymentStatus(true);
                        }
                    }
                },
                error: function() {
                    hideLoading();
                    showError('è·å–è®¢å•ä¿¡æ¯å¤±è´¥');
                }
            });
        }
        
        // å€’è®¡æ—¶ç›¸å…³å˜é‡?
        let countdownTimer = null;
        const EXPIRY_TIME = 15 * 60; // 15åˆ†é’Ÿï¼Œå•ä½ç§’
        
        // åˆ›å»ºæ”¯ä»˜è®¢å•
        function createPayment(orderId, orderNo, amount, payType) {
            showLoading();
            $.authAjax({
                url: '/api/payment/create',
                type: 'POST',
                data: { 
                    orderId: orderId, 
                    orderNo: orderNo, 
                    amount: amount, 
                    paymentType: getPaymentMethodValue(payType) 
                },
                success: function(response) {
                    hideLoading();
                    if ((response.code === 200 || response.code === 0) && response.data) {
                        // æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç åŒºåŸ?
                        $('#qr-code-container').removeClass('d-none');
                        
                        // ç”Ÿæˆæ”¯ä»˜äºŒç»´ç ?
                        generateQRCode(orderNo);
                        
                        // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€?
                        startPolling(orderNo);
                        
                        // å¼€å§‹å€’è®¡æ—?
                        startCountdown();
                    } else {
                        showError('åˆ›å»ºæ”¯ä»˜å¤±è´¥ï¼? + (response.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                },
                error: function() {
                    hideLoading();
                    showError('åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥');
                }
            });
        }
        
        // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€?
        function startPolling(orderNo) {
            window.pollingTimer = setInterval(() => {
                checkPaymentStatus(orderNo, window.pollingTimer);
            }, 3000);
        }
        
        // å¼€å§‹å€’è®¡æ—?
        function startCountdown() {
            let seconds = EXPIRY_TIME;
            updateCountdownDisplay(seconds);
            
            countdownTimer = setInterval(() => {
                seconds--;
                
                if (seconds <= 0) {
                    clearInterval(countdownTimer);
                    clearInterval(window.pollingTimer);
                    paymentTimeout();
                    return;
                }
                
                updateCountdownDisplay(seconds);
            }, 1000);
        }
        
        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤?
        function updateCountdownDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            $('#countdown').text(formattedTime);
        }
        
        // æ”¯ä»˜è¶…æ—¶å¤„ç†
        function paymentTimeout() {
            $('#status-desc').text('æ”¯ä»˜å·²è¶…æ—¶ï¼Œè¯·é‡æ–°ä¸‹å?);
            $('#qr-code-container').addClass('d-none');
            $('#status-icon').text('â?);
            $('#status-text').text('æ”¯ä»˜è¶…æ—¶');
            
            // æç¤ºç”¨æˆ·
            alert('æ”¯ä»˜å·²è¶…æ—¶ï¼Œè¯·é‡æ–°ä¸‹å?);
            
            // å¯é€‰ï¼šè‡ªåŠ¨è·³è½¬å›è®¢å•åˆ—è¡?           setTimeout(() => {
                window.location.href = '/api/order/list';
            }, 3000);
        }
        
        // ç”ŸæˆäºŒç»´ç ?
        function generateQRCode(paymentInfo) {
            // æ¨¡æ‹Ÿç”ŸæˆäºŒç»´ç ?
            const qrCodeUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent('PAY_' + paymentInfo);
            $('#qr-code-img').attr('src', qrCodeUrl);
        }
        
        // æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?
        function checkPaymentStatus(orderNo, interval) {
            $.authAjax({
                url: '/api/payment/status?orderNo=' + orderNo,
                type: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        const status = response.data;
                        if (status === 1) { // å·²æ”¯ä»?
                            clearInterval(interval);
                            clearInterval(countdownTimer);
                            updatePaymentStatus(true);
                            $('#order-status').text('å·²æ”¯ä»?);
                        }
                    }
                },
                error: function() {
                    console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´?);
                }
            });
        }
        
        // æ›´æ–°æ”¯ä»˜çŠ¶æ€æ˜¾ç¤?
        function updatePaymentStatus(isSuccess) {
            const statusIcon = $('#status-icon');
            const statusText = $('#status-text');
            const statusDesc = $('#status-desc');
            
            if (isSuccess) {
                statusIcon.text('âœ?);
                statusIcon.addClass('status-success');
                statusIcon.removeClass('status-pending');
                statusText.text('æ”¯ä»˜æˆåŠŸ');
                statusDesc.text('æ‚¨çš„è®¢å•å·²æ”¯ä»˜æˆåŠ?);
                $('#qr-code-container').addClass('d-none');
                clearInterval(countdownTimer);
            } else {
                statusIcon.text('âœ?);
                statusIcon.removeClass('status-success');
                statusIcon.addClass('status-pending');
                statusText.text('æ”¯ä»˜å¤±è´¥');
                statusDesc.text('æ”¯ä»˜è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯?);
            }
        }
        
        // æ›´æ–°è®¢å•çŠ¶æ€æ–‡æœ?
        function updateOrderStatusText(status) {
            const statusMap = {
                0: 'å¾…æ”¯ä»?,
                1: 'å·²æ”¯ä»?,
                2: 'å·²å‘è´?,
                3: 'å·²å®Œæˆ?,
                4: 'å·²æ”¶è´?
            };
            $('#order-status').text(statusMap[status] || 'æœªçŸ¥çŠ¶æ€?);
        }
        
        // è·å–æ”¯ä»˜æ–¹å¼å€?
        function getPaymentMethodValue(payType) {
            const paymentMap = {
                'wechat': 1,
                'alipay': 2,
                'card': 3,
                1: 1,  // å¾®ä¿¡æ”¯ä»˜
                2: 2,  // æ”¯ä»˜å®?
                3: 3   // é“¶è¡Œå?
            };
            return paymentMap[payType] || 1;
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            alert(message);
            console.error(message);
        }
        
        // æ˜¾ç¤ºåŠ è½½é®ç½©å±?
        function showLoading() {
            $('#loadingOverlay').css('display', 'flex');
        }

        // éšè—åŠ è½½é®ç½©å±?
        function hideLoading() {
            $('#loadingOverlay').css('display', 'none');
        }
        
        // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·çŠ¶æ€?
        function updateUserMenu() {
            const userMenu = $('#userMenu');
            if (authUtils.isLoggedIn()) {
                const username = authUtils.getUsername() || 'ç”¨æˆ·';
                userMenu.html(`
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            ${username}
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a class="dropdown-item" href="/api/order/list">æˆ‘çš„è®¢å•</a>
                            <a class="dropdown-item" href="/api/cart">è´­ç‰©è½?/a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="javascript:void(0)" onclick="logout()">é€€å‡ºç™»å½?/a>
                        </div>
                    </li>
                `);
            } else {
                userMenu.html(`
                    <li class="nav-item">
                        <a class="nav-link" href="/api/auth/login">ç™»å½•</a>
                    </li>
                `);
            }
        }
        
        // ç”¨æˆ·ç™»å‡º
        function logout() {
            authUtils.logout();
            updateUserMenu();
            alert('å·²é€€å‡ºç™»å½?);
            window.location.href = '/api/auth/login';
        }
    </script>
    
    <!-- é¡µè„š -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h4>å…³äºæˆ‘ä»¬</h4>
                    <p>é»‘ç§‘æ˜“è´­æ˜¯ä¸€å®¶ä¸“æ³¨äºç”µå­äº§å“é”€å”®çš„ç”µå•†å¹³å°ï¼Œæä¾›ä¼˜è´¨çš„è´­ç‰©ä½“éªŒå’Œå®Œå–„çš„å”®åæœåŠ¡ã€?/p>
                </div>
                <div class="col-md-4">
                    <h4>å¿«é€Ÿé“¾æ?/h4>
                    <ul class="list-unstyled">
                        <li><a href="/index.html">é¦–é¡µ</a></li>
                        <li><a href="/api/product/list">å•†å“åˆ—è¡¨</a></li>
                        <li><a href="/api/auth/login">ç™»å½•</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h4>è”ç³»æˆ‘ä»¬</h4>
                    <p>æœåŠ¡ç”µè¯ï¼?00-123-4567</p>
                    <p>é‚®ç®±ï¼šservice@heikeji.com</p>
                </div>
            </div>
            <div class="text-center mt-4">
                <p>Â© 2024 é»‘ç§‘æ˜“è´­ ç‰ˆæƒæ‰€æœ?/p>
            </div>
        </div>
    </footer>
    </body>
</html>
