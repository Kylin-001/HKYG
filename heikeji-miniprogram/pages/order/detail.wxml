<!-- pages/order/detail.wxml -->
<view class="container">
  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <text>加载中...</text>
  </view>

  <!-- 订单详情内容 -->
  <view class="order-content" wx:elif="{{orderDetail}}">
    <!-- 订单状态卡片 -->
    <view class="status-card {{orderDetail.status === 'PENDING_PAYMENT' ? 'status-warning' : orderDetail.status === 'PAID' ? 'status-info' : orderDetail.status === 'COMPLETED' ? 'status-success' : 'status-default'}}">
      <view class="status-header">
        <text class="status-text">{{getOrderStatusText(orderDetail.status)}}</text>
        <text class="order-no">订单号：{{orderDetail.orderNo}}</text>
      </view>
      
      <view class="order-amount">
        <text class="amount-label">实付金额：</text>
        <text class="amount-value">¥{{orderDetail.totalAmount}}</text>
      </view>
      
      <view class="order-time">
        <text>下单时间：{{formatTime(orderDetail.createTime)}}</text>
      </view>
    </view>

    <!-- 收货信息 -->
    <view class="section-card" wx:if="{{orderDetail.address}}">
      <view class="section-header">
        <text class="section-title">收货信息</text>
      </view>
      <view class="address-info">
        <text class="recipient">{{orderDetail.address.recipient}} {{orderDetail.address.phone}}</text>
        <text class="address-detail">{{orderDetail.address.address}}</text>
      </view>
    </view>

    <!-- 商品信息 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">商品信息</text>
      </view>
      <view class="product-list">
        <view class="product-item" wx:for="{{orderDetail.items}}" wx:key="id">
          <image src="{{item.image}}" class="product-image" mode="aspectFill"></image>
          <view class="product-info">
            <text class="product-name">{{item.name}}</text>
            <text class="product-spec">{{item.spec || '规格'}}</text>
            <view class="product-footer">
              <text class="product-price">¥{{item.price}}</text>
              <text class="product-quantity">x{{item.quantity}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 配送信息 -->
    <view class="section-card" wx:if="{{orderDetail.deliveryInfo}}">
      <view class="section-header">
        <text class="section-title">配送信息</text>
      </view>
      <view class="delivery-info">
        <view class="delivery-item">
          <text class="delivery-label">配送方式：</text>
          <text class="delivery-value">{{orderDetail.deliveryInfo.type === 'TAKEOUT' ? '外卖配送' : '到店自提'}}</text>
        </view>
        <view class="delivery-item" wx:if="{{orderDetail.deliveryInfo.deliveryFee}}">
          <text class="delivery-label">配送费：</text>
          <text class="delivery-value">¥{{orderDetail.deliveryInfo.deliveryFee}}</text>
        </view>
        <view class="delivery-item" wx:if="{{orderDetail.deliveryInfo.expectedArrivalTime}}">
          <text class="delivery-label">预计送达：</text>
          <text class="delivery-value">{{formatTime(orderDetail.deliveryInfo.expectedArrivalTime)}}</text>
        </view>
      </view>
    </view>

    <!-- 订单信息 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">订单信息</text>
      </view>
      <view class="order-info">
        <view class="info-item">
          <text class="info-label">订单类型：</text>
          <text class="info-value">{{getOrderTypeText(orderDetail.orderType)}}</text>
        </view>
        <view class="info-item" wx:if="{{orderDetail.merchantName}}">
          <text class="info-label">商家：</text>
          <text class="info-value">{{orderDetail.merchantName}}</text>
        </view>
        <view class="info-item" wx:if="{{orderDetail.paymentStatus}}">
          <text class="info-label">支付状态：</text>
          <text class="info-value payment-status-{{orderDetail.paymentStatus === 'PAID' ? 'success' : orderDetail.paymentStatus === 'REFUNDED' ? 'warning' : 'default'}}">
            {{getPaymentStatusText(orderDetail.paymentStatus)}}
          </text>
        </view>
      </view>
    </view>

    <!-- 价格明细 -->
    <view class="section-card">
      <view class="section-header">
        <text class="section-title">价格明细</text>
      </view>
      <view class="price-detail">
        <view class="price-item">
          <text class="price-label">商品总价：</text>
          <text class="price-value">¥{{orderDetail.totalPrice}}</text>
        </view>
        <view class="price-item" wx:if="{{orderDetail.discount > 0}}">
          <text class="price-label">优惠金额：</text>
          <text class="price-value discount">-¥{{orderDetail.discount}}</text>
        </view>
        <view class="price-item" wx:if="{{orderDetail.deliveryFee > 0}}">
          <text class="price-label">配送费：</text>
          <text class="price-value">¥{{orderDetail.deliveryFee}}</text>
        </view>
        <view class="price-item total">
          <text class="price-label">实付金额：</text>
          <text class="price-value total">¥{{orderDetail.totalAmount}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 订单不存在 -->
  <view class="empty" wx:else>
    <text>订单不存在或已被删除</text>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar" wx:if="{{orderDetail}}">
    <view class="actions-left">
      <button type="default" size="mini" wx:if="{{orderDetail.status === 'PENDING_PAYMENT'}}">
        取消订单
      </button>
      <button type="default" size="mini" wx:if="{{orderDetail.status === 'DELIVERED'}}">
        确认收货
      </button>
      <button type="default" size="mini" wx:if="{{orderDetail.status === 'COMPLETED'}}">
        申请退款
      </button>
      <button type="default" size="mini" open-type="contact">
        联系客服
      </button>
    </view>
    <view class="actions-right">
      <button type="primary" size="mini" wx:if="{{orderDetail.status === 'PENDING_PAYMENT'}}" bindtap="openPaymentModal">
        去支付
      </button>
      <button type="primary" size="mini" wx:if="{{orderDetail.merchantPhone}}" bindtap="callMerchant">
        联系商家
      </button>
    </view>
  </view>

  <!-- 支付方式选择弹窗 -->
  <view class="modal" wx:if="{{isPaymentModalVisible}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">选择支付方式</text>
        <text class="modal-close" bindtap="closePaymentModal">×</text>
      </view>
      <view class="payment-methods">
        <view class="payment-method" wx:for="{{paymentMethods}}" wx:key="id" bindtap="selectPaymentMethod" data-id="{{item.id}}">
          <view class="method-info">
            <image src="{{item.icon}}" class="method-icon" mode="aspectFill"></image>
            <text class="method-name">{{item.name}}</text>
          </view>
          <radio checked="{{item.checked}}" disabled></radio>
        </view>
      </view>
      <view class="modal-footer">
        <button type="primary" bindtap="confirmPayment" loading="{{paymentLoading}}">
          确认支付 ¥{{orderDetail.totalAmount}}
        </button>
      </view>
    </view>
  </view>
</view>