import java.net.HttpURLConnection;
import java.net.URL;
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class test_api {
    public static void main(String[] args) {
        try {
            String url = "http://localhost:8082/api/courier/dashboard";
            URL obj = new URL(url);
            HttpURLConnection conn = (HttpURLConnection) obj.openConnection();
            
            conn.setRequestMethod("GET");
            conn.setRequestProperty("X-Courier-Id", "1001");
            conn.setRequestProperty("Content-Type", "application/json");
            
            int responseCode = conn.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                String inputLine;
                StringBuffer response = new StringBuffer();
                
                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();
                
                System.out.println("Response: " + response.toString());
            } else {
                System.out.println("API call failed: " + responseCode);
            }
            
        } catch (Exception e) {
            System.out.println("Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
import java.net.HttpURLConnection;
import java.net.URL;
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class test_api_detailed {
    public static void main(String[] args) {
        try {
            String url = "http://localhost:8082/api/courier/dashboard";
            URL obj = new URL(url);
            HttpURLConnection conn = (HttpURLConnection) obj.openConnection();
            
            // Simulate real browser request
            conn.setRequestMethod("GET");
            conn.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36");
            conn.setRequestProperty("Accept", "application/json, text/plain, */*");
            conn.setRequestProperty("Accept-Language", "zh-CN,zh;q=0.9,en;q=0.8");
            conn.setRequestProperty("X-Courier-Id", "1001");
            conn.setRequestProperty("Content-Type", "application/json");
            conn.setRequestProperty("Origin", "http://localhost:8080");
            conn.setRequestProperty("Referer", "http://localhost:8080/");
            
            // Set connection timeout
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(5000);
            
            System.out.println("Request URL: " + url);
            System.out.println("Request Method: GET");
            System.out.println("Request Headers:");
            System.out.println("  X-Courier-Id: 1001");
            System.out.println("  Content-Type: application/json");
            
            int responseCode = conn.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            System.out.println("Response Message: " + conn.getResponseMessage());
            
            // Get response headers
            System.out.println("Response Headers:");
            for (int i = 1; i <= 20; i++) {
                String headerKey = conn.getHeaderFieldKey(i);
                String headerValue = conn.getHeaderField(i);
                if (headerKey == null || headerValue == null) {
                    break;
                }
                System.out.println("  " + headerKey + ": " + headerValue);
            }
            
            // Read response content
            String content;
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream(), "UTF-8"));
                String inputLine;
                StringBuffer response = new StringBuffer();
                
                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();
                content = response.toString();
            } else {
                BufferedReader errorReader = new BufferedReader(new InputStreamReader(conn.getErrorStream(), "UTF-8"));
                String inputLine;
                StringBuffer errorResponse = new StringBuffer();
                
                while ((inputLine = errorReader.readLine()) != null) {
                    errorResponse.append(inputLine);
                }
                errorReader.close();
                content = errorResponse.toString();
            }
            
            System.out.println("Response Content: " + content);
            
        } catch (Exception e) {
            System.out.println("Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
import java.net.HttpURLConnection;
import java.net.URL;
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class test_courier_api {
    public static void main(String[] args) {
        System.out.println("=== Testing Courier API ===");
        
        // Test if server is responding
        testHealthEndpoint();
        
        // Test courier API
        testCourierAPI();
    }
    
    private static void testHealthEndpoint() {
        try {
            System.out.println("\n--- Testing Health Endpoint ---");
            String url = "http://localhost:8082/api/health";
            URL obj = new URL(url);
            HttpURLConnection conn = (HttpURLConnection) obj.openConnection();
            conn.setRequestMethod("GET");
            conn.setRequestProperty("User-Agent", "TestClient/1.0");
            
            int responseCode = conn.getResponseCode();
            System.out.println("Health Check - Response Code: " + responseCode);
            
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));
                String inputLine;
                StringBuffer response = new StringBuffer();
                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();
                System.out.println("Health Check Response: " + response.toString());
            } else {
                System.out.println("Health Check Failed");
            }
        } catch (Exception e) {
            System.out.println("Health Check Error: " + e.getMessage());
        }
    }
    
    private static void testCourierAPI() {
        try {
            System.out.println("\n--- Testing Courier API Endpoints ---");
            
            // Test 1: Basic API call (without X-Courier-Id)
            testApiCall("http://localhost:8082/api/courier/dashboard", null, "Basic API Call");
            
            // Test 2: API call with X-Courier-Id
            testApiCall("http://localhost:8082/api/courier/dashboard", "1001", "API Call with X-Courier-Id");
            
            // Test 3: Test other endpoint
            testApiCall("http://localhost:8082/api/courier/profile", "1001", "Profile Endpoint");
            
        } catch (Exception e) {
            System.out.println("Courier API Test Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private static void testApiCall(String urlString, String courierId, String testName) {
        try {
            System.out.println("\nTest: " + testName);
            System.out.println("URL: " + urlString);
            
            URL url = new URL(urlString);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("GET");
            conn.setRequestProperty("Accept", "application/json");
            conn.setRequestProperty("User-Agent", "CourierApp/1.0");
            conn.setConnectTimeout(5000);
            conn.setReadTimeout(5000);
            
            if (courierId != null) {
                conn.setRequestProperty("X-Courier-Id", courierId);
                System.out.println("X-Courier-Id: " + courierId);
            }
            
            int responseCode = conn.getResponseCode();
            System.out.println("Response Code: " + responseCode);
            System.out.println("Response Message: " + conn.getResponseMessage());
            
            // Show response headers
            System.out.println("Response Headers:");
            for (int i = 1; i <= 20; i++) {
                String headerKey = conn.getHeaderFieldKey(i);
                String headerValue = conn.getHeaderField(i);
                if (headerKey == null || headerValue == null) break;
                System.out.println("  " + headerKey + ": " + headerValue);
            }
            
            // Read response content
            String content;
            if (responseCode == 200) {
                BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream(), "UTF-8"));
                String inputLine;
                StringBuffer response = new StringBuffer();
                while ((inputLine = in.readLine()) != null) {
                    response.append(inputLine);
                }
                in.close();
                content = response.toString();
                System.out.println("Response Content: " + content);
            } else {
                System.out.println("Request failed, trying to read error response...");
                try {
                    BufferedReader errorReader = new BufferedReader(new InputStreamReader(conn.getErrorStream(), "UTF-8"));
                    String inputLine;
                    StringBuffer errorResponse = new StringBuffer();
                    while ((inputLine = errorReader.readLine()) != null) {
                        errorResponse.append(inputLine);
                    }
                    errorReader.close();
                    content = errorResponse.toString();
                    if (content.isEmpty()) {
                        content = "No error content";
                    }
                    System.out.println("Error Content: " + content);
                } catch (Exception e) {
                    System.out.println("Cannot read error response: " + e.getMessage());
                }
            }
            
        } catch (Exception e) {
            System.out.println("API Call Error: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
package com.heikeji.admin;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;

/**
 * åå°ç®¡ç†ç³»ç»Ÿå¯åŠ¨ç±?
 */
@SpringBootApplication
@ComponentScan(basePackages = {"com.heikeji"})
public class AdminApplication {

    public static void main(String[] args) {
        SpringApplication.run(AdminApplication.class, args);
    }

}
package com.heikeji.admin.common;

/**
 * ä¸šåŠ¡å¼‚å¸¸ç±? */
public class BusinessException extends RuntimeException {

    private static final long serialVersionUID = 1L;

    /**
     * é”™è¯¯ç ?     */
    private Integer code;

    /**
     * é”™è¯¯æ¶ˆæ¯
     */
    private String message;

    /**
     * æ„é€ æ–¹æ³?     */
    public BusinessException() {
        super();
    }

    /**
     * æ„é€ æ–¹æ³?     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public BusinessException(String message) {
        super(message);
        this.message = message;
        this.code = 500;
    }

    /**
     * æ„é€ æ–¹æ³?     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }

    /**
     * æ„é€ æ–¹æ³?     * @param message é”™è¯¯æ¶ˆæ¯
     * @param cause å¼‚å¸¸åŸå› 
     */
    public BusinessException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 500;
    }

    /**
     * æ„é€ æ–¹æ³?     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     * @param cause å¼‚å¸¸åŸå› 
     */
    public BusinessException(Integer code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }

    /**
     * è·å–é”™è¯¯ç ?     */
    public Integer getCode() {
        return code;
    }

    /**
     * è®¾ç½®é”™è¯¯ç ?     */
    public void setCode(Integer code) {
        this.code = code;
    }

    /**
     * è·å–é”™è¯¯æ¶ˆæ¯
     */
    @Override
    public String getMessage() {
        return message;
    }

    /**
     * è®¾ç½®é”™è¯¯æ¶ˆæ¯
     */
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.admin.common;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.DisabledException;
import org.springframework.security.authentication.LockedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.context.request.WebRequest;

import jakarta.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†ç±? */
@ControllerAdvice
public class GlobalExceptionHandler {

    /**
     * å¤„ç†ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public R handleBusinessException(BusinessException ex) {
        return R.error(ex.getCode(), ex.getMessage());
    }

    /**
     * å¤„ç†å‚æ•°éªŒè¯å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseBody
    public R handleValidationExceptions(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error -> {
            errors.put(error.getField(), error.getDefaultMessage());
        });
        return R.error(400, "å‚æ•°éªŒè¯å¤±è´¥").put("errors", errors);
    }

    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸
     */
    @ExceptionHandler(BadCredentialsException.class)
    @ResponseBody
    public R handleBadCredentialsException(BadCredentialsException ex) {
        return R.error(401, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }

    /**
     * å¤„ç†ç”¨æˆ·ç¦ç”¨å¼‚å¸¸
     */
    @ExceptionHandler(DisabledException.class)
    @ResponseBody
    public R handleDisabledException(DisabledException ex) {
        return R.error(403, "ç”¨æˆ·å·²è¢«ç¦ç”¨");
    }

    /**
     * å¤„ç†ç”¨æˆ·é”å®šå¼‚å¸¸
     */
    @ExceptionHandler(LockedException.class)
    @ResponseBody
    public R handleLockedException(LockedException ex) {
        return R.error(403, "ç”¨æˆ·å·²è¢«é”å®š");
    }

    /**
     * å¤„ç†è®¿é—®æ‹’ç»å¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    @ResponseBody
    public R handleAccessDeniedException(AccessDeniedException ex) {
        return R.error(403, "æƒé™ä¸è¶³ï¼Œæ‹’ç»è®¿é—?);
    }

    /**
     * å¤„ç†è¿è¡Œæ—¶å¼‚å¸?     */
    @ExceptionHandler(RuntimeException.class)
    @ResponseBody
    public R handleRuntimeException(RuntimeException ex) {
        // è®°å½•å¼‚å¸¸æ—¥å¿—
        ex.printStackTrace();
        return R.error(500, ex.getMessage() != null ? ex.getMessage() : "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }

    /**
     * å¤„ç†æ‰€æœ‰å…¶ä»–å¼‚å¸?     */
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public R handleAllExceptions(Exception ex) {
        // è®°å½•å¼‚å¸¸æ—¥å¿—
        ex.printStackTrace();
        return R.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }

    /**
     * å¤„ç†HTTP 404å¼‚å¸¸
     */
    @ExceptionHandler(org.springframework.web.servlet.NoHandlerFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    @ResponseBody
    public R handleNotFoundError(HttpServletRequest request, Exception ex) {
        return R.error(404, "è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨: " + request.getRequestURI());
    }

    /**
     * å¤„ç†HTTP 405å¼‚å¸¸
     */
    @ExceptionHandler(org.springframework.web.HttpRequestMethodNotSupportedException.class)
    @ResponseStatus(HttpStatus.METHOD_NOT_ALLOWED)
    @ResponseBody
    public R handleMethodNotAllowedError(HttpServletRequest request, Exception ex) {
        return R.error(405, "ä¸æ”¯æŒçš„è¯·æ±‚æ–¹æ³•: " + request.getMethod());
    }

    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // å¤šçº§ä»£ç†æ—¶ï¼Œå–ç¬¬ä¸€ä¸ªIP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }
}
package com.heikeji.admin.common;

import java.io.Serializable;
import java.util.HashMap;
import java.util.Map;

/**
 * å“åº”ç»“æœå°è£…ç±? */
public class R extends HashMap<String, Object> implements Serializable {
    private static final long serialVersionUID = 1L;

    public R() {
        put("code", 0);
        put("msg", "success");
    }

    public static R error() {
        return error(500, "æœåŠ¡å™¨é”™è¯?);
    }

    public static R error(String msg) {
        return error(500, msg);
    }

    public static R error(int code, String msg) {
        R r = new R();
        r.put("code", code);
        r.put("msg", msg);
        return r;
    }

    public static R ok() {
        return new R();
    }

    public static R ok(String msg) {
        R r = new R();
        r.put("msg", msg);
        return r;
    }

    public static R ok(Map<String, Object> map) {
        R r = new R();
        r.putAll(map);
        return r;
    }

    @Override
    public R put(String key, Object value) {
        super.put(key, value);
        return this;
    }

    public R data(Object data) {
        super.put("data", data);
        return this;
    }

    public R count(Long count) {
        super.put("count", count);
        return this;
    }

    public R rows(Object rows) {
        super.put("rows", rows);
        return this;
    }
}
package com.heikeji.admin.config;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.stereotype.Component;

/**
 * åº”ç”¨å¯åŠ¨åæ‰§è¡Œçš„åˆå§‹åŒ–æ“ä½? */
@Component
public class ApplicationRunnerImpl implements ApplicationRunner {

    private static final Logger logger = LoggerFactory.getLogger(ApplicationRunnerImpl.class);

    @Override
    public void run(ApplicationArguments args) throws Exception {
        logger.info("======= Heikeji Admin åº”ç”¨å¯åŠ¨æˆåŠŸ =======");
        logger.info("è®¿é—®åœ°å€: http://localhost:8081/admin");
        logger.info("APIæ¥å£åœ°å€: http://localhost:8081/admin/api");
        logger.info("åˆå§‹åŒ–SQLè„šæœ¬: src/main/resources/init.sql");
        logger.info("é»˜è®¤ç®¡ç†å‘˜è´¦å? admin / 123456");
        logger.info("======================================");
    }
}
package com.heikeji.admin.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis-Plusé…ç½®ç±? */
@Configuration
@MapperScan("com.heikeji.admin.mapper")
public class MybatisPlusConfig {

    /**
     * é…ç½®åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // æ·»åŠ åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
package com.heikeji.admin.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;

/**
 * Redisé…ç½®ç±? */
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // ä½¿ç”¨StringRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„keyå€?        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        
        // ä½¿ç”¨GenericJackson2JsonRedisSerializeræ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–redisçš„valueå€?        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        template.afterPropertiesSet();
        return template;
    }
}
package com.heikeji.admin.config;

/**
 * Swaggeré…ç½®ç±»ï¼ˆæš‚æ—¶ç¦ç”¨ï¼?
 * æ³¨é‡Šæ‰æ‰€æœ‰Swaggerç›¸å…³ä»£ç ä»¥é¿å…Spring Boot 2.7.14å…¼å®¹æ€§é—®é¢?
 */
public class SwaggerConfig {

    /**
     * Swaggeré…ç½®å·²å®Œå…¨ç¦ç”¨ï¼Œè¿”å›nullé¿å…åˆå§‹åŒ?
     * å¾…Spring Boot 2.7.14å…¼å®¹æ€§é—®é¢˜è§£å†³åå†å¯ç”?
     */
    public Object createRestApi() {
        return null; // å®Œå…¨ç¦ç”¨Swagger
    }
}
package com.heikeji.admin.config;

import com.heikeji.admin.interceptor.RequestLogInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * Webé…ç½®ç±? * é…ç½®æ‹¦æˆªå™¨ã€CORSç­‰Webç›¸å…³è®¾ç½®
 */
@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private RequestLogInterceptor requestLogInterceptor;

    /**
     * é…ç½®CORS
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*")
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);
    }

    /**
     * æ³¨å†Œæ‹¦æˆªå™?     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æ³¨å†Œè¯·æ±‚æ—¥å¿—æ‹¦æˆªå™?        registry.addInterceptor(requestLogInterceptor)
                .addPathPatterns("/**")
                .excludePathPatterns("/swagger-ui/**", "/v3/api-docs/**", "/doc.html", "/webjars/**", "/favicon.ico");
    }
}
package com.heikeji.admin.controller;

import com.heikeji.admin.common.R;
import com.heikeji.admin.entity.AdminUser;
import com.heikeji.admin.service.AdminUserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * ç®¡ç†å‘˜ç”¨æˆ·æ§åˆ¶å™¨
 */
@Api(tags = "ç”¨æˆ·ç®¡ç†")
@RestController
@RequestMapping("/api/user")
public class AdminUserController {

    @Autowired
    private AdminUserService adminUserService;

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨")
    @GetMapping("/list")
    public R userList(@ApiParam("æŸ¥è¯¢å‚æ•°ï¼ŒåŒ…å«pageã€limitç­?) @RequestParam Map<String, Object> params) {
        Map<String, Object> result = adminUserService.pageUser(params);
        return R.ok().data(result);
    }

    /**
     * æ ¹æ®IDè·å–ç”¨æˆ·ä¿¡æ¯
     */
    @ApiOperation("æ ¹æ®IDè·å–ç”¨æˆ·ä¿¡æ¯")
    @GetMapping("/{id}")
    public R getUserById(@ApiParam("ç”¨æˆ·ID") @PathVariable("id") Long id) {
        AdminUser user = adminUserService.getUserInfo(id);
        if (user == null) {
            return R.error(404, "ç”¨æˆ·ä¸å­˜åœ?);
        }
        return R.ok().data(user);
    }

    /**
     * æ·»åŠ ç”¨æˆ·
     */
    @ApiOperation("æ·»åŠ ç”¨æˆ·")
    @PostMapping("/")
    public R addUser(@ApiParam("ç”¨æˆ·ä¿¡æ¯") @RequestBody AdminUser user) {
        // éªŒè¯å‚æ•°
        if (user.getUsername() == null || user.getPassword() == null) {
            return R.error(400, "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º");
        }

        boolean success = adminUserService.addUser(user);
        if (success) {
            return R.ok("æ·»åŠ ç”¨æˆ·æˆåŠŸ");
        } else {
            return R.error(500, "æ·»åŠ ç”¨æˆ·å¤±è´¥");
        }
    }

    /**
     * ä¿®æ”¹ç”¨æˆ·
     */
    @ApiOperation("ä¿®æ”¹ç”¨æˆ·")
    @PutMapping("/{id}")
    public R updateUser(@ApiParam("ç”¨æˆ·ID") @PathVariable("id") Long id, 
                       @ApiParam("ç”¨æˆ·ä¿¡æ¯") @RequestBody AdminUser user) {
        // è®¾ç½®ç”¨æˆ·ID
        user.setId(id);

        boolean success = adminUserService.updateUser(user);
        if (success) {
            return R.ok("ä¿®æ”¹ç”¨æˆ·æˆåŠŸ");
        } else {
            return R.error(500, "ä¿®æ”¹ç”¨æˆ·å¤±è´¥");
        }
    }

    /**
     * åˆ é™¤ç”¨æˆ·
     */
    @ApiOperation("åˆ é™¤ç”¨æˆ·")
    @DeleteMapping("/{id}")
    public R deleteUser(@ApiParam("ç”¨æˆ·ID") @PathVariable("id") Long id) {
        try {
            boolean success = adminUserService.deleteUser(id);
            if (success) {
                return R.ok("åˆ é™¤ç”¨æˆ·æˆåŠŸ");
            } else {
                return R.error(500, "åˆ é™¤ç”¨æˆ·å¤±è´¥");
            }
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "åˆ é™¤ç”¨æˆ·å¤±è´¥");
        }
    }

    /**
     * æ‰¹é‡åˆ é™¤ç”¨æˆ·
     */
    @ApiOperation("æ‰¹é‡åˆ é™¤ç”¨æˆ·")
    @DeleteMapping("/batch")
    public R batchDeleteUser(@ApiParam("ç”¨æˆ·IDåˆ—è¡¨") @RequestBody List<Long> ids) {
        try {
            if (ids == null || ids.isEmpty()) {
                return R.error(400, "è¯·é€‰æ‹©è¦åˆ é™¤çš„ç”¨æˆ·");
            }

            boolean success = adminUserService.batchDeleteUser(ids);
            if (success) {
                return R.ok("æ‰¹é‡åˆ é™¤ç”¨æˆ·æˆåŠŸ");
            } else {
                return R.error(500, "æ‰¹é‡åˆ é™¤ç”¨æˆ·å¤±è´¥");
            }
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "æ‰¹é‡åˆ é™¤ç”¨æˆ·å¤±è´¥");
        }
    }

    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€?     */
    @ApiOperation("æ›´æ–°ç”¨æˆ·çŠ¶æ€?)
    @PutMapping("/{id}/status")
    public R updateUserStatus(@ApiParam("ç”¨æˆ·ID") @PathVariable("id") Long id, 
                             @ApiParam("çŠ¶æ€ç  0ç¦ç”¨ 1å¯ç”¨") @RequestParam Integer status) {
        try {
            boolean success = adminUserService.updateUserStatus(id, status);
            if (success) {
                return R.ok("ä¿®æ”¹ç”¨æˆ·çŠ¶æ€æˆåŠ?);
            } else {
                return R.error(500, "ä¿®æ”¹ç”¨æˆ·çŠ¶æ€å¤±è´?);
            }
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "ä¿®æ”¹ç”¨æˆ·çŠ¶æ€å¤±è´?);
        }
    }

    /**
     * ä¿®æ”¹å¯†ç 
     */
    @ApiOperation("ä¿®æ”¹å¯†ç ")
    @PutMapping("/password")
    public R changePassword(@ApiParam("å¯†ç ä¿¡æ¯ï¼ŒåŒ…å«oldPasswordã€newPassword") @RequestBody Map<String, Object> params) {
        Long userId = Long.parseLong(params.get("userId").toString());
        String oldPassword = (String) params.get("oldPassword");
        String newPassword = (String) params.get("newPassword");

        if (oldPassword == null || newPassword == null) {
            return R.error(400, "å¯†ç ä¸èƒ½ä¸ºç©º");
        }

        boolean success = adminUserService.changePassword(userId, oldPassword, newPassword);
        if (success) {
            return R.ok("ä¿®æ”¹å¯†ç æˆåŠŸ");
        } else {
            return R.error(500, "ä¿®æ”¹å¯†ç å¤±è´¥");
        }
    }

    /**
     * é‡ç½®å¯†ç 
     */
    @ApiOperation("é‡ç½®å¯†ç ")
    @PutMapping("/{id}/reset")
    public R resetPassword(@ApiParam("ç”¨æˆ·ID") @PathVariable("id") Long id) {
        boolean success = adminUserService.resetPassword(id);
        if (success) {
            return R.ok("é‡ç½®å¯†ç æˆåŠŸï¼Œé»˜è®¤å¯†ç ï¼š123456");
        } else {
            return R.error(500, "é‡ç½®å¯†ç å¤±è´¥");
        }
    }
}
package com.heikeji.admin.controller;

import com.heikeji.admin.common.R;
import com.heikeji.admin.service.AdminUserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;
import java.util.UUID;
import java.util.concurrent.TimeUnit;

/**
 * ç™»å½•æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/auth")
@Api(tags = "ç™»å½•è®¤è¯")
public class LoginController {

    @Autowired
    private AdminUserService adminUserService;

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    @Value("${admin.security.token.expireTime}")
    private Integer expireTime;

    /**
     * ç®¡ç†å‘˜ç™»å½?     */
    @PostMapping("/login")
    @ApiOperation("ç®¡ç†å‘˜ç™»å½?)
    public R login(@RequestBody Map<String, String> params) {
        try {
            String username = params.get("username");
            String password = params.get("password");
            String captcha = params.get("captcha");
            String uuid = params.get("uuid");

            // éªŒè¯å‚æ•°
            if (username == null || password == null) {
                return R.error(400, "ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º");
            }

            // æ‰§è¡Œç™»å½•
            Map<String, Object> result = adminUserService.login(username, password, captcha, uuid);
            return R.ok().data(result);
        } catch (RuntimeException e) {
            return R.error(401, e.getMessage());
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * ç®¡ç†å‘˜ç™»å‡?     */
    @PostMapping("/logout")
    @ApiOperation("ç®¡ç†å‘˜ç™»å‡?)
    public R logout(HttpServletRequest request) {
        try {
            // ä»è¯·æ±‚å¤´è·å–token
            String token = request.getHeader("Authorization");
            if (token != null && token.startsWith("Bearer ")) {
                token = token.substring(7);
            }

            // æ‰§è¡Œç™»å‡º
            adminUserService.logout(token);
            return R.ok("ç™»å‡ºæˆåŠŸ");
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "ç™»å‡ºå¤±è´¥");
        }
    }

    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/info")
    @ApiOperation("è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯")
    public R getInfo(@RequestParam("userId") Long userId) {
        try {
            // è·å–ç”¨æˆ·ä¿¡æ¯
            Object userInfo = adminUserService.getUserInfo(userId);
            if (userInfo == null) {
                return R.error(404, "ç”¨æˆ·ä¸å­˜åœ?);
            }
            return R.ok().data(userInfo);
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥");
        }
    }

    /**
     * è·å–éªŒè¯ç ?     */
    @GetMapping("/captcha")
    @ApiOperation("è·å–éªŒè¯ç ?)
    public R getCaptcha() {
        try {
            // ç”Ÿæˆç®€å•çš„æ•°å­—éªŒè¯ç ?            String captchaCode = generateSimpleCaptcha(6);
            String uuid = UUID.randomUUID().toString();
            String captchaKey = "captcha:" + uuid;
            
            // å°†éªŒè¯ç å­˜å…¥Redisï¼Œè®¾ç½®è¿‡æœŸæ—¶é—?            redisTemplate.opsForValue().set(captchaKey, captchaCode, expireTime, TimeUnit.MINUTES);
            
            // è¿”å›éªŒè¯ç å’Œå¯¹åº”çš„uuidï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…åº”è¯¥è¿”å›å›¾ç‰‡ï¼‰
            Map<String, Object> result = new HashMap<>(2);
            result.put("uuid", uuid);
            result.put("code", captchaCode); // ä»…ç”¨äºå¼€å‘ç¯å¢ƒæµ‹è¯?            result.put("img", "data:image/png;base64,ç®€åŒ–çš„éªŒè¯ç å›¾ç‰?);
            
            return R.ok().data(result);
        } catch (Exception e) {
            e.printStackTrace();
            return R.error(500, "è·å–éªŒè¯ç å¤±è´?);
        }
    }
    
    /**
     * ç”Ÿæˆç®€å•çš„æ•°å­—éªŒè¯ç ?     */
    private String generateSimpleCaptcha(int length) {
        Random random = new Random();
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < length; i++) {
            sb.append(random.nextInt(10));
        }
        return sb.toString();
    }
}
package com.heikeji.admin.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * ç®¡ç†å‘˜ç”¨æˆ·å®ä½“ç±»
 */
@Data
@TableName("sys_admin_user")
public class AdminUser implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * ç”¨æˆ·ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * ç”¨æˆ·å?     */
    private String username;

    /**
     * å¯†ç 
     */
    private String password;

    /**
     * çœŸå®å§“å
     */
    private String realName;

    /**
     * æ‰‹æœºå?     */
    private String phone;

    /**
     * é‚®ç®±
     */
    private String email;

    /**
     * å¤´åƒ
     */
    private String avatar;

    /**
     * çŠ¶æ€ï¼š0ç¦ç”¨ï¼?å¯ç”¨
     */
    private Integer status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;

    /**
     * æœ€åç™»å½•æ—¶é—?     */
    private Date lastLoginTime;

    /**
     * é€»è¾‘åˆ é™¤ï¼?æœªåˆ é™¤ï¼Œ1å·²åˆ é™?     */
    @TableLogic
    private Integer deleted;

    /**
     * éƒ¨é—¨ID
     */
    private Long deptId;

    /**
     * è§’è‰²IDåˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼?     */
    private String roleIds;
}
package com.heikeji.admin.interceptor;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Enumeration;

/**
 * è¯·æ±‚æ—¥å¿—æ‹¦æˆªå™? * è®°å½•æ‰€æœ‰HTTPè¯·æ±‚çš„è¯¦ç»†ä¿¡æ? */
@Component
public class RequestLogInterceptor implements HandlerInterceptor {

    private static final Logger logger = LoggerFactory.getLogger(RequestLogInterceptor.class);
    private static final ThreadLocal<Long> startTimeThreadLocal = new ThreadLocal<>();
    private static final ThreadLocal<String> requestIdThreadLocal = new ThreadLocal<>();

    /**
     * è¯·æ±‚å¤„ç†å‰?     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—?        startTimeThreadLocal.set(System.currentTimeMillis());
        
        // ç”Ÿæˆè¯·æ±‚ID
        String requestId = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmmssSSS")) + "-" + Thread.currentThread().getId();
        requestIdThreadLocal.set(requestId);
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        StringBuilder logBuilder = new StringBuilder();
        logBuilder.append("[REQUEST] | ID: ").append(requestId)
                 .append(" | URL: ").append(request.getRequestURL().toString())
                 .append(" | METHOD: ").append(request.getMethod())
                 .append(" | IP: ").append(getClientIp(request))
                 .append(" | USER-AGENT: ").append(request.getHeader("User-Agent"));
        
        // è®°å½•è¯·æ±‚å‚æ•°
        Enumeration<String> paramNames = request.getParameterNames();
        if (paramNames.hasMoreElements()) {
            logBuilder.append(" | PARAMS: {");
            boolean first = true;
            while (paramNames.hasMoreElements()) {
                String paramName = paramNames.nextElement();
                String paramValue = request.getParameter(paramName);
                // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
                if (isSensitiveParam(paramName)) {
                    paramValue = "******";
                }
                if (!first) {
                    logBuilder.append(", ");
                }
                logBuilder.append(paramName).append(":").append(paramValue);
                first = false;
            }
            logBuilder.append("}");
        }
        
        logger.info(logBuilder.toString());
        
        // å°†è¯·æ±‚IDè®¾ç½®åˆ°å“åº”å¤´
        response.setHeader("X-Request-ID", requestId);
        
        return true;
    }

    /**
     * è¯·æ±‚å¤„ç†å?     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, 
                          ModelAndView modelAndView) {
        // è¯·æ±‚å¤„ç†åä½†è¿˜æœªè¿”å›å“åº”ä½“æ—¶çš„å¤„ç?    }

    /**
     * è¯·æ±‚å®Œæˆåï¼ˆåŒ…æ‹¬å¼‚å¸¸å¤„ç†å®Œæˆåï¼‰
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) {
        // è®¡ç®—è¯·æ±‚å¤„ç†æ—¶é—´
        Long startTime = startTimeThreadLocal.get();
        if (startTime != null) {
            long endTime = System.currentTimeMillis();
            long executionTime = endTime - startTime;
            
            // è®°å½•å“åº”ä¿¡æ¯
            StringBuilder logBuilder = new StringBuilder();
            logBuilder.append("[RESPONSE] | ID: ").append(requestIdThreadLocal.get())
                     .append(" | STATUS: ").append(response.getStatus())
                     .append(" | TIME: ").append(executionTime).append("ms");
            
            // å¦‚æœæœ‰å¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸ä¿¡æ¯
            if (ex != null) {
                logBuilder.append(" | EXCEPTION: ").append(ex.getMessage());
                logger.error(logBuilder.toString(), ex);
            } else {
                // æ ¹æ®å“åº”æ—¶é—´çº§åˆ«è®°å½•ä¸åŒæ—¥å¿—çº§åˆ«
                if (executionTime > 3000) {
                    logger.warn(logBuilder.toString());
                } else {
                    logger.info(logBuilder.toString());
                }
            }
        }
        
        // æ¸…ç†ThreadLocalï¼Œé¿å…å†…å­˜æ³„æ¼?        startTimeThreadLocal.remove();
        requestIdThreadLocal.remove();
    }

    /**
     * è·å–å®¢æˆ·ç«¯çœŸå®IPåœ°å€
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // å¤šçº§ä»£ç†æ—¶ï¼Œå–ç¬¬ä¸€ä¸ªIP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæ•æ„Ÿå‚æ•?     */
    private boolean isSensitiveParam(String paramName) {
        if (!StringUtils.hasText(paramName)) {
            return false;
        }
        String lowerParamName = paramName.toLowerCase();
        return lowerParamName.contains("password") || 
               lowerParamName.contains("pwd") || 
               lowerParamName.contains("token") || 
               lowerParamName.contains("secret") || 
               lowerParamName.contains("key");
    }
}
package com.heikeji.admin.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.admin.entity.AdminUser;
import org.apache.ibatis.annotations.Mapper;

import java.util.List;
import java.util.Map;

/**
 * ç®¡ç†å‘˜ç”¨æˆ·Mapperæ¥å£
 */
@Mapper
public interface AdminUserMapper extends BaseMapper<AdminUser> {

    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ?     */
    AdminUser selectByUsername(String username);

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    List<AdminUser> selectUserPage(Map<String, Object> params);

    /**
     * æ ¹æ®éƒ¨é—¨IDæŸ¥è¯¢ç”¨æˆ·
     */
    List<AdminUser> selectUserByDeptId(Long deptId);

    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢ç”¨æˆ·
     */
    List<AdminUser> selectUserByRoleId(Long roleId);
}
package com.heikeji.admin.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * JWTè®¤è¯è¿‡æ»¤å™? */
@Component
public class JwtAuthenticationTokenFilter extends OncePerRequestFilter {

    @Value("${admin.security.token.header}")
    private String tokenHeader;

    @Value("${admin.security.token.tokenStartWith}")
    private String tokenStartWith;

    @Autowired
    private UserDetailsService userDetailsService;

    @Autowired
    private TokenService tokenService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {
        // è·å–token
        String token = getToken(request);
        if (token != null) {
            // éªŒè¯token
            String username = tokenService.getUsernameFromToken(token);
            if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                if (tokenService.validateToken(token, userDetails)) {
                    // åˆ›å»ºè®¤è¯å¯¹è±¡
                    UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                            userDetails, null, userDetails.getAuthorities());
                    authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                    // è®¾ç½®è®¤è¯ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
                    SecurityContextHolder.getContext().setAuthentication(authentication);
                }
            }
        }
        chain.doFilter(request, response);
    }

    /**
     * ä»è¯·æ±‚å¤´ä¸­è·å–token
     */
    private String getToken(HttpServletRequest request) {
        String bearerToken = request.getHeader(tokenHeader);
        if (bearerToken != null && bearerToken.startsWith(tokenStartWith)) {
            return bearerToken.substring(tokenStartWith.length());
        }
        return null;
    }
}
package com.heikeji.admin.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * å®‰å…¨é…ç½®ç±? */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {

    /**
     * å¯†ç åŠ å¯†å™?     */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * è®¤è¯ç®¡ç†å™?     */
    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    /**
     * å®‰å…¨è¿‡æ»¤é“?     */
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å…³é—­CSRF
            .csrf().disable()
            // ä¸é€šè¿‡Sessionè·å–SecurityContext
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            // å…è®¸åŒ¿åè®¿é—®çš„æ¥å?            .authorizeRequests()
            .antMatchers("/api/auth/login", "/api/auth/captcha", "/api/auth/logout").permitAll()
            // å…è®¸é™æ€èµ„æº?            .antMatchers("/doc.html", "/swagger-ui/**", "/v3/api-docs/**", "/webjars/**").permitAll()
            // å…¶ä»–æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯?            .anyRequest().authenticated();

        // æ·»åŠ JWTè¿‡æ»¤å™?        http.addFilterBefore(jwtAuthenticationTokenFilter(), UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    /**
     * JWTè®¤è¯è¿‡æ»¤å™?     */
    @Bean
    public JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter() {
        return new JwtAuthenticationTokenFilter();
    }
}
package com.heikeji.admin.security;

import org.springframework.security.core.userdetails.UserDetails;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * TokenæœåŠ¡æ¥å£
 */
public interface TokenService {

    /**
     * ç”Ÿæˆtoken
     */
    String createToken(UserDetails userDetails);

    /**
     * éªŒè¯token
     */
    boolean validateToken(String token, UserDetails userDetails);

    /**
     * ä»tokenä¸­è·å–ç”¨æˆ·å
     */
    String getUsernameFromToken(String token);

    /**
     * åˆ·æ–°token
     */
    String refreshToken(String token);

    /**
     * ä½¿tokenå¤±æ•ˆ
     */
    void invalidateToken(String token);

    /**
     * è·å–å½“å‰ç”¨æˆ·çš„æƒé™ä¿¡æ?     */
    Map<String, Object> getCurrentUserPermissions();
}
package com.heikeji.admin.security.impl;

import com.heikeji.admin.security.TokenService;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * ä»¤ç‰ŒæœåŠ¡å®ç°ç±?- ç®€åŒ–ç‰ˆæœ? */
@Service
public class JwtTokenServiceImpl implements TokenService {

    @Value("${admin.security.token.expireTime}")
    private long expireTime;

    // å­˜å‚¨å·²å¤±æ•ˆçš„tokenï¼Œé˜²æ­¢é‡æ”¾æ”»å‡?    private final Map<String, Date> invalidatedTokens = new ConcurrentHashMap<>();

    @Override
    public String createToken(UserDetails userDetails) {
        // ç”Ÿæˆç®€åŒ–ç‰ˆtokenï¼šusername:timestamp:hash
        String username = userDetails.getUsername();
        long timestamp = System.currentTimeMillis();
        return username + ":" + timestamp;
    }

    @Override
    public boolean validateToken(String token, UserDetails userDetails) {
        // æ£€æŸ¥tokenæ˜¯å¦å·²å¤±æ•?        if (invalidatedTokens.containsKey(token)) {
            return false;
        }

        // è·å–tokenä¸­çš„ç”¨æˆ·å?        String username = getUsernameFromToken(token);
        // éªŒè¯ç”¨æˆ·åå’Œtokenæ˜¯å¦è¿‡æœŸ
        return username != null && username.equals(userDetails.getUsername()) && !isTokenExpired(token);
    }

    @Override
    public String getUsernameFromToken(String token) {
        if (token != null && token.contains(":")) {
            return token.split(":")[0];
        }
        return null;
    }

    @Override
    public String refreshToken(String token) {
        String username = getUsernameFromToken(token);
        if (username != null) {
            // ç”Ÿæˆæ–°çš„token
            return username + ":" + System.currentTimeMillis();
        }
        return null;
    }

    @Override
    public void invalidateToken(String token) {
        invalidatedTokens.put(token, new Date());
    }

    @Override
    public Map<String, Object> getCurrentUserPermissions() {
        // TODO: ä»å½“å‰è®¤è¯çš„ç”¨æˆ·ä¸­è·å–æƒé™ä¿¡æ?        Map<String, Object> permissions = new HashMap<>();
        permissions.put("roles", new String[]{"admin"});
        permissions.put("permissions", new String[]{"*:*:*"});
        return permissions;
    }

    /**
     * æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
     */
    private boolean isTokenExpired(String token) {
        if (token != null && token.contains(":")) {
            try {
                String[] parts = token.split(":");
                if (parts.length >= 2) {
                    long timestamp = Long.parseLong(parts[1]);
                    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆåŸºäºé…ç½®çš„è¿‡æœŸæ—¶é—´ï¼‰
                    return System.currentTimeMillis() > timestamp + (expireTime * 60 * 1000);
                }
            } catch (NumberFormatException e) {
                // æ—¶é—´æˆ³æ ¼å¼é”™è¯¯ï¼Œè§†ä¸ºè¿‡æœŸ
                return true;
            }
        }
        return true;
    }
}
package com.heikeji.admin.security.impl;

import com.heikeji.admin.security.TokenService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Primary;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.TimeUnit;

/**
 * TokenæœåŠ¡å®ç°ç±?- ç®€åŒ–ç‰ˆæœ? */
@Service
@Primary
public class TokenServiceImpl implements TokenService {

    @Value("${admin.security.token.expireTime}")
    private Integer expireTime;

    @Value("${admin.security.token.tokenHead}")
    private String tokenHead;

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç”¨äºå­˜å‚¨å·²æ³¨é”€çš„tokenï¼Œé¿å…é‡å¤éªŒè¯?    private Map<String, Boolean> invalidatedTokens = new ConcurrentHashMap<>();

    /**
     * ç”Ÿæˆtoken
     */
    @Override
    public String createToken(UserDetails userDetails) {
        // ç”Ÿæˆç®€åŒ–ç‰ˆtokenï¼šusername:timestamp
        String username = userDetails.getUsername();
        long timestamp = System.currentTimeMillis();
        String token = username + ":" + timestamp;

        // å°†tokenå­˜å…¥Redisï¼Œç”¨äºå¿«é€Ÿæ ¡éªŒå’Œæ³¨é”€
        String tokenKey = "admin:token:" + token;
        redisTemplate.opsForValue().set(tokenKey, userDetails, expireTime, TimeUnit.MINUTES);

        return token;
    }

    /**
     * éªŒè¯token
     */
    @Override
    public boolean validateToken(String token, UserDetails userDetails) {
        // æ£€æŸ¥tokenæ˜¯å¦å·²æ³¨é”€
        if (invalidatedTokens.containsKey(token)) {
            return false;
        }

        // æ£€æŸ¥Redisä¸­æ˜¯å¦å­˜åœ¨token
        String tokenKey = "admin:token:" + token;
        Object cachedUser = redisTemplate.opsForValue().get(tokenKey);
        if (cachedUser == null) {
            return false;
        }

        // ä»tokenä¸­æå–ç”¨æˆ·åå¹¶éªŒè¯?        String username = getUsernameFromToken(token);
        return StringUtils.hasText(username) && username.equals(userDetails.getUsername()) && !isTokenExpired(token);
    }

    /**
     * ä»tokenä¸­è·å–ç”¨æˆ·å
     */
    @Override
    public String getUsernameFromToken(String token) {
        if (token != null && token.contains(":")) {
            return token.split(":")[0];
        }
        return null;
    }

    /**
     * åˆ·æ–°token
     */
    @Override
    public String refreshToken(String token) {
        try {
            // è·å–åŸå§‹tokençš„ç”¨æˆ·å
            String username = getUsernameFromToken(token);
            if (username == null) {
                return null;
            }

            // ä½¿æ—§tokenå¤±æ•ˆ
            invalidateToken(token);

            // ç”Ÿæˆæ–°token
            long timestamp = System.currentTimeMillis();
            String newToken = username + ":" + timestamp;

            // å°†æ–°tokenå­˜å…¥Redis
            String newTokenKey = "admin:token:" + newToken;
            redisTemplate.opsForValue().set(newTokenKey, username, expireTime, TimeUnit.MINUTES);

            return newToken;
        } catch (Exception e) {
            return null;
        }
    }

    /**
     * ä½¿tokenå¤±æ•ˆ
     */
    @Override
    public void invalidateToken(String token) {
        // æ·»åŠ åˆ°æœ¬åœ°ç¼“å­?        invalidatedTokens.put(token, true);
        
        // ä»Redisä¸­åˆ é™?        String tokenKey = "admin:token:" + token;
        redisTemplate.delete(tokenKey);
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·çš„æƒé™ä¿¡æ?     */
    @Override
    public Map<String, Object> getCurrentUserPermissions() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return Collections.emptyMap();
        }

        Map<String, Object> result = new HashMap<>();
        
        // è·å–ç”¨æˆ·å?        result.put("username", authentication.getName());
        
        // è·å–æƒé™åˆ—è¡¨
        List<String> permissions = new ArrayList<>();
        authentication.getAuthorities().forEach(auth -> permissions.add(auth.getAuthority()));
        result.put("permissions", permissions);
        
        // è·å–è§’è‰²åˆ—è¡¨
        List<String> roles = new ArrayList<>();
        permissions.forEach(perm -> {
            if (perm.startsWith("ROLE_")) {
                roles.add(perm.substring(5));
            }
        });
        result.put("roles", roles);
        
        return result;
    }

    /**
     * ä»è¯·æ±‚å¤´ä¸­è·å–token
     */
    public String getToken(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith(tokenHead)) {
            return bearerToken.substring(tokenHead.length());
        }
        return null;
    }

    /**
     * æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
     */
    private boolean isTokenExpired(String token) {
        if (token != null && token.contains(":")) {
            try {
                String[] parts = token.split(":");
                if (parts.length >= 2) {
                    long timestamp = Long.parseLong(parts[1]);
                    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆåŸºäºé…ç½®çš„è¿‡æœŸæ—¶é—´ï¼‰
                    return System.currentTimeMillis() > timestamp + (expireTime * 60 * 1000);
                }
            } catch (NumberFormatException e) {
                // æ—¶é—´æˆ³æ ¼å¼é”™è¯¯ï¼Œè§†ä¸ºè¿‡æœŸ
                return true;
            }
        }
        return true;
    }
}
package com.heikeji.admin.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.admin.entity.AdminUser;
import org.springframework.security.core.userdetails.UserDetailsService;

import java.util.List;
import java.util.Map;

/**
 * ç®¡ç†å‘˜ç”¨æˆ·æœåŠ¡æ¥å? */
public interface AdminUserService extends IService<AdminUser>, UserDetailsService {

    /**
     * ç”¨æˆ·ç™»å½•
     */
    Map<String, Object> login(String username, String password, String captcha, String uuid);

    /**
     * ç”¨æˆ·ç™»å‡º
     */
    boolean logout(String token);

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    AdminUser getUserInfo(Long userId);

    /**
     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ?     */
    AdminUser getByUsername(String username);

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     */
    Map<String, Object> pageUser(Map<String, Object> params);

    /**
     * æ·»åŠ ç”¨æˆ·
     */
    boolean addUser(AdminUser user);

    /**
     * æ›´æ–°ç”¨æˆ·
     */
    boolean updateUser(AdminUser user);

    /**
     * åˆ é™¤ç”¨æˆ·
     */
    boolean deleteUser(Long userId);

    /**
     * æ‰¹é‡åˆ é™¤ç”¨æˆ·
     */
    boolean batchDeleteUser(List<Long> userIds);

    /**
     * ä¿®æ”¹å¯†ç 
     */
    boolean changePassword(Long userId, String oldPassword, String newPassword);

    /**
     * é‡ç½®å¯†ç 
     */
    boolean resetPassword(Long userId);

    /**
     * æ›´æ–°ç”¨æˆ·çŠ¶æ€?     */
    boolean updateUserStatus(Long userId, Integer status);
}
package com.heikeji.admin.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.admin.entity.AdminUser;
import com.heikeji.admin.mapper.AdminUserMapper;
import com.heikeji.admin.security.TokenService;
import com.heikeji.admin.service.AdminUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.*;
import java.util.concurrent.TimeUnit;

/**
 * ç®¡ç†å‘˜ç”¨æˆ·æœåŠ¡å®ç°ç±»
 */
@Service
public class AdminUserServiceImpl extends ServiceImpl<AdminUserMapper, AdminUser> implements AdminUserService {

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private TokenService tokenService;

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    @Override
    public Map<String, Object> login(String username, String password, String captcha, String uuid) {
        // éªŒè¯ç éªŒè¯é€»è¾‘
        if (!validateCaptcha(captcha, uuid)) {
            throw new RuntimeException("éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœ?);
        }
        
        // æŸ¥è¯¢ç”¨æˆ·
        AdminUser user = getByUsername(username);
        if (user == null) {
            throw new RuntimeException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€?        if (user.getStatus() == 0) {
            throw new RuntimeException("ç”¨æˆ·å·²è¢«ç¦ç”¨");
        }

        // éªŒè¯å¯†ç 
        if (!passwordEncoder.matches(password, user.getPassword())) {
            throw new RuntimeException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }

        // æ›´æ–°æœ€åç™»å½•æ—¶é—?        user.setLastLoginTime(new Date());
        this.updateById(user);

        // ç”Ÿæˆtoken
        UserDetails userDetails = createUserDetails(user);
        String token = tokenService.createToken(userDetails);

        // è¿”å›ç™»å½•ç»“æœ
        Map<String, Object> result = new HashMap<>();
        result.put("token", token);
        result.put("user", user);
        result.put("permissions", tokenService.getCurrentUserPermissions());
        return result;
    }

    /**
     * æ ¡éªŒéªŒè¯ç ?     */
    private boolean validateCaptcha(String captcha, String uuid) {
        if (!StringUtils.hasText(captcha) || !StringUtils.hasText(uuid)) {
            return false;
        }

        String captchaKey = "captcha:" + uuid;
        String redisCaptcha = (String) redisTemplate.opsForValue().get(captchaKey);
        
        if (redisCaptcha == null) {
            return false;
        }

        // ä½¿ç”¨å®Œæ¯•ååˆ é™¤éªŒè¯ç 
        redisTemplate.delete(captchaKey);

        // å¿½ç•¥å¤§å°å†™æ¯”è¾?        return captcha.equalsIgnoreCase(redisCaptcha);
    }

    @Override
    public boolean logout(String token) {
        tokenService.invalidateToken(token);
        return true;
    }

    @Override
    public AdminUser getUserInfo(Long userId) {
        return this.getById(userId);
    }

    @Override
    public AdminUser getByUsername(String username) {
        return this.getOne(new QueryWrapper<AdminUser>().eq("username", username));
    }

    @Override
    public Map<String, Object> pageUser(Map<String, Object> params) {
        Page<AdminUser> page = new Page<>(
                Long.parseLong(params.getOrDefault("page", 1).toString()),
                Long.parseLong(params.getOrDefault("limit", 10).toString())
        );

        QueryWrapper<AdminUser> wrapper = new QueryWrapper<>();
        // æ·»åŠ æŸ¥è¯¢æ¡ä»¶
        if (params.containsKey("username")) {
            wrapper.like("username", params.get("username"));
        }
        if (params.containsKey("status")) {
            wrapper.eq("status", params.get("status"));
        }
        if (params.containsKey("deptId")) {
            wrapper.eq("dept_id", params.get("deptId"));
        }

        IPage<AdminUser> userPage = this.page(page, wrapper);

        Map<String, Object> result = new HashMap<>();
        result.put("total", userPage.getTotal());
        result.put("list", userPage.getRecords());
        return result;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean addUser(AdminUser user) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ?        if (getByUsername(user.getUsername()) != null) {
            throw new RuntimeException("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // å¯†ç åŠ å¯†
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        user.setCreateTime(new Date());
        user.setUpdateTime(new Date());
        user.setStatus(1);
        user.setDeleted(0);

        return this.save(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateUser(AdminUser user) {
        // ä¸å…è®¸ä¿®æ”¹å¯†ç ?        user.setPassword(null);
        user.setUpdateTime(new Date());
        return this.updateById(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deleteUser(Long userId) {
        return this.removeById(userId);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean batchDeleteUser(List<Long> userIds) {
        return this.removeByIds(userIds);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean changePassword(Long userId, String oldPassword, String newPassword) {
        AdminUser user = this.getById(userId);
        if (user == null) {
            throw new RuntimeException("ç”¨æˆ·ä¸å­˜åœ?);
        }

        // éªŒè¯æ—§å¯†ç ?        if (!passwordEncoder.matches(oldPassword, user.getPassword())) {
            throw new RuntimeException("æ—§å¯†ç é”™è¯?);
        }

        // åŠ å¯†æ–°å¯†ç ?        user.setPassword(passwordEncoder.encode(newPassword));
        user.setUpdateTime(new Date());
        return this.updateById(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean resetPassword(Long userId) {
        AdminUser user = this.getById(userId);
        if (user == null) {
            throw new RuntimeException("ç”¨æˆ·ä¸å­˜åœ?);
        }

        // é‡ç½®å¯†ç ä¸?23456
        user.setPassword(passwordEncoder.encode("123456"));
        user.setUpdateTime(new Date());
        return this.updateById(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateUserStatus(Long userId, Integer status) {
        AdminUser user = new AdminUser();
        user.setId(userId);
        user.setStatus(status);
        user.setUpdateTime(new Date());
        return this.updateById(user);
    }

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        AdminUser user = getByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·åä¸å­˜åœ¨");
        }
        return createUserDetails(user);
    }

    /**
     * åˆ›å»ºUserDetailså¯¹è±¡
     */
    private UserDetails createUserDetails(AdminUser user) {
        // TODO: ä»æ•°æ®åº“è·å–ç”¨æˆ·æƒé™
        return User.withUsername(user.getUsername())
                .password(user.getPassword())
                .authorities("ROLE_ADMIN", "*:*:*")
                .accountExpired(false)
                .accountLocked(false)
                .credentialsExpired(false)
                .disabled(user.getStatus() == 0)
                .build();
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;

/**
 * é»‘ç§‘æŠ€å•†åŸå°ç¨‹åºç«¯åº”ç”¨å…¥å£ - æœ€å°åŒ–é…ç½®ç”¨äºæµ‹è¯•
 */
@SpringBootApplication(exclude = {
        DataSourceAutoConfiguration.class
})
@ComponentScan(basePackages = {"com.heikeji.app"}) // åªæ‰«æappåŒ?public class HeikejiAppApplication {
    public static void main(String[] args) {
        SpringApplication.run(HeikejiAppApplication.class, args);
    }
}


package com.heikeji.app;

/**
 * æœ€ç®€å•çš„æµ‹è¯•ç±? */
public class HelloWorld {
    
    public static void main(String[] args) {
        System.out.println("Hello, World!");
        System.out.println("æµ‹è¯•ç¼–è¯‘æ˜¯å¦æ­£å¸¸å·¥ä½œ");
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.FilterType;

/**
 * æœ€å°åŒ–Spring Bootåº”ç”¨ï¼Œä»…ç”¨äºæµ‹è¯•åŸºæœ¬å¯åŠ¨åŠŸèƒ½
 */
@EnableAutoConfiguration(exclude = {
        DataSourceAutoConfiguration.class,
        SecurityAutoConfiguration.class
})
@ComponentScan(excludeFilters = @ComponentScan.Filter(type = FilterType.REGEX, pattern = ".*Controller|.*Service|.*Config"))
public class MinimalApp {

    public static void main(String[] args) {
        System.out.println("å¼€å§‹å¯åŠ¨æœ€å°åŒ–Spring Bootåº”ç”¨...");
        SpringApplication.run(MinimalApp.class, args);
        System.out.println("æœ€å°åŒ–Spring Bootåº”ç”¨å¯åŠ¨æˆåŠŸï¼?);
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration;

/**
 * æœ€å°åŒ–å¯åŠ¨ç±»ï¼Œç”¨äºå®šä½å¯åŠ¨é—®é¢˜
 * æ’é™¤æ‰€æœ‰å¯èƒ½å¯¼è‡´é—®é¢˜çš„è‡ªåŠ¨é…ç½®
 */
@SpringBootApplication(exclude = {
        DataSourceAutoConfiguration.class,
        DataSourceTransactionManagerAutoConfiguration.class,
        HibernateJpaAutoConfiguration.class
})
public class MinimalApplication {
    public static void main(String[] args) {
        SpringApplication.run(MinimalApplication.class, args);
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

/**
 * ç®€å•å¯åŠ¨ç±»ï¼Œä¸æ‰«æå…¶ä»–æ¨¡å—
 */
@SpringBootApplication
@ComponentScan(basePackages = {"com.heikeji.app"})
public class SimpleApplication {
    public static void main(String[] args) {
        SpringApplication.run(SimpleApplication.class, args);
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.FilterType;
import org.springframework.context.annotation.Profile;

/**
 * ç®€åŒ–ç‰ˆSpring Bootå¯åŠ¨ç±»ï¼Œç”¨äºæµ‹è¯•å¯åŠ¨
 */
@SpringBootApplication(exclude = {
        org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration.class,
        org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration.class
})
@ComponentScan(basePackages = "com.heikeji.app",
        excludeFilters = @ComponentScan.Filter(type = FilterType.REGEX, pattern = ".*SecurityConfig.*"))
@Profile("simple")
public class SimpleBootApp {

    public static void main(String[] args) {
        System.setProperty("spring.profiles.active", "simple");
        SpringApplication.run(SimpleBootApp.class, args);
        System.out.println("Spring Bootåº”ç”¨å¯åŠ¨æˆåŠŸï¼?);
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;

/**
 * ç®€åŒ–çš„æµ‹è¯•åº”ç”¨ç¨‹åº
 * ä¸åŠ è½½æ•°æ®åº“é…ç½®ï¼Œä»…ç”¨äºæµ‹è¯•Spring Bootå¯åŠ¨
 */
@SpringBootApplication(exclude = {
        DataSourceAutoConfiguration.class,
        HibernateJpaAutoConfiguration.class
})
public class SimpleTestApp {
    
    public static void main(String[] args) {
        System.out.println("æµ‹è¯•åº”ç”¨ç¨‹åºå¯åŠ¨ä¸?..");
        SpringApplication.run(SimpleTestApp.class, args);
        System.out.println("æµ‹è¯•åº”ç”¨ç¨‹åºå¯åŠ¨æˆåŠŸ!");
    }
}
package com.heikeji.app;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;

/**
 * æµ‹è¯•å¯åŠ¨ç±?- ä»…åŒ…å«æœ€åŸºæœ¬é…ç½®
 */
@Configuration
@EnableAutoConfiguration(exclude = {
        DataSourceAutoConfiguration.class
})
public class TestApplication {

    public static void main(String[] args) {
        SpringApplication.run(TestApplication.class, args);
    }
}
package com.heikeji.app.common;

/**
 * ä¸šåŠ¡å¼‚å¸¸ç±? * ç”¨äºå¤„ç†ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„å¼‚å¸? */
public class BusinessException extends RuntimeException {
    private static final long serialVersionUID = 1L;

    /**
     * é”™è¯¯ç ?     */
    private Integer code;

    /**
     * é”™è¯¯æ¶ˆæ¯
     */
    private String message;

    /**
     * æ„é€ å‡½æ•?     */
    public BusinessException() {
        super();
    }

    /**
     * æ„é€ å‡½æ•?     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public BusinessException(String message) {
        super(message);
        this.message = message;
        this.code = 500; // é»˜è®¤é”™è¯¯ç ?    }

    /**
     * æ„é€ å‡½æ•?     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }

    /**
     * æ„é€ å‡½æ•?     * @param message é”™è¯¯æ¶ˆæ¯
     * @param cause å¼‚å¸¸åŸå› 
     */
    public BusinessException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 500;
    }

    /**
     * æ„é€ å‡½æ•?     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     * @param cause å¼‚å¸¸åŸå› 
     */
    public BusinessException(Integer code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }

    /**
     * è·å–é”™è¯¯ç ?     * @return é”™è¯¯ç ?     */
    public Integer getCode() {
        return code;
    }

    /**
     * è®¾ç½®é”™è¯¯ç ?     * @param code é”™è¯¯ç ?     */
    public void setCode(Integer code) {
        this.code = code;
    }

    /**
     * è·å–é”™è¯¯æ¶ˆæ¯
     * @return é”™è¯¯æ¶ˆæ¯
     */
    @Override
    public String getMessage() {
        return message;
    }

    /**
     * è®¾ç½®é”™è¯¯æ¶ˆæ¯
     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.app.common;

import com.heikeji.common.core.domain.R;
import org.springframework.http.HttpStatus;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.DisabledException;
import org.springframework.security.authentication.LockedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.servlet.NoHandlerFoundException;

import jakarta.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†ç±? * å¤„ç†åº”ç”¨ç«¯æ‰€æœ‰æœªæ•è·çš„å¼‚å¸¸ï¼Œè¿”å›ç»Ÿä¸€æ ¼å¼çš„å“åº? */
@ControllerAdvice
public class GlobalExceptionHandler {

    /**
     * å¤„ç†ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public R handleBusinessException(BusinessException ex) {
        return R.error(ex.getCode(), ex.getMessage());
    }

    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸
     */
    @ExceptionHandler(BadCredentialsException.class)
    @ResponseBody
    public R handleBadCredentialsException(BadCredentialsException ex) {
        return R.error(401, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }

    /**
     * å¤„ç†ç”¨æˆ·ç¦ç”¨å¼‚å¸¸
     */
    @ExceptionHandler(DisabledException.class)
    @ResponseBody
    public R handleDisabledException(DisabledException ex) {
        return R.error(403, "ç”¨æˆ·å·²è¢«ç¦ç”¨");
    }

    /**
     * å¤„ç†ç”¨æˆ·é”å®šå¼‚å¸¸
     */
    @ExceptionHandler(LockedException.class)
    @ResponseBody
    public R handleLockedException(LockedException ex) {
        return R.error(403, "ç”¨æˆ·å·²è¢«é”å®š");
    }

    /**
     * å¤„ç†è®¿é—®æ‹’ç»å¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    @ResponseBody
    public R handleAccessDeniedException(AccessDeniedException ex) {
        return R.error(403, "æƒé™ä¸è¶³ï¼Œæ‹’ç»è®¿é—?);
    }

    /**
     * å¤„ç†æ–¹æ³•å‚æ•°éªŒè¯å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseBody
    public R handleValidationException(MethodArgumentNotValidException ex) {
        StringBuilder errorMsg = new StringBuilder();
        ex.getBindingResult().getFieldErrors().forEach(error -> {
            errorMsg.append(error.getField()).append(":").append(error.getDefaultMessage()).append("; ");
        });
        return R.error(400, errorMsg.toString());
    }

    /**
     * å¤„ç†ç¼ºå°‘è¯·æ±‚å‚æ•°å¼‚å¸¸
     */
    @ExceptionHandler(MissingServletRequestParameterException.class)
    @ResponseBody
    public R handleMissingParamsException(MissingServletRequestParameterException ex) {
        return R.error(400, "ç¼ºå°‘å¿…è¦å‚æ•°: " + ex.getParameterName());
    }

    /**
     * å¤„ç†è¯·æ±‚ä½“æ ¼å¼é”™è¯¯å¼‚å¸?     */
    @ExceptionHandler(HttpMessageNotReadableException.class)
    @ResponseBody
    public R handleHttpMessageNotReadableException(HttpMessageNotReadableException ex) {
        return R.error(400, "è¯·æ±‚ä½“æ ¼å¼é”™è¯? " + ex.getMessage());
    }

    /**
     * å¤„ç†æ‰€æœ‰å…¶ä»–å¼‚å¸?     */
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public R handleAllExceptions(Exception ex) {
        // è®°å½•å¼‚å¸¸æ—¥å¿—
        ex.printStackTrace();
        return R.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }

    /**
     * å¤„ç†HTTP 404å¼‚å¸¸
     */
    @ExceptionHandler(NoHandlerFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    @ResponseBody
    public R handleNotFoundError(HttpServletRequest request, Exception ex) {
        return R.error(404, "è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨: " + request.getRequestURI());
    }

    /**
     * å¤„ç†HTTP 405å¼‚å¸¸
     */
    @ExceptionHandler(org.springframework.web.HttpRequestMethodNotSupportedException.class)
    @ResponseStatus(HttpStatus.METHOD_NOT_ALLOWED)
    @ResponseBody
    public R handleMethodNotAllowedError(HttpServletRequest request, Exception ex) {
        return R.error(405, "ä¸æ”¯æŒçš„è¯·æ±‚æ–¹æ³•: " + request.getMethod());
    }
}
package com.heikeji.app.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.http.converter.HttpMessageConverter;
import org.springframework.http.converter.StringHttpMessageConverter;
import org.springframework.http.converter.json.MappingJackson2HttpMessageConverter;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import java.nio.charset.StandardCharsets;
import java.util.List;

/**
 * å­—ç¬¦ç¼–ç é…ç½®ç±»ï¼Œç¡®ä¿æ‰€æœ‰HTTPå“åº”éƒ½ä½¿ç”¨UTF-8ç¼–ç 
 */
@Configuration
public class CharacterEncodingConfig implements WebMvcConfigurer {

    @Override
    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {
        // è®¾ç½®Stringæ¶ˆæ¯è½¬æ¢å™¨çš„ç¼–ç ä¸ºUTF-8
        converters.add(0, new StringHttpMessageConverter(StandardCharsets.UTF_8));
        
        // ç¡®ä¿Jackson JSONè½¬æ¢å™¨ä½¿ç”¨UTF-8ç¼–ç 
        for (HttpMessageConverter<?> converter : converters) {
            if (converter instanceof MappingJackson2HttpMessageConverter) {
                ((MappingJackson2HttpMessageConverter) converter).setDefaultCharset(StandardCharsets.UTF_8);
            }
        }
    }
}
package com.heikeji.app.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.connection.RedisStandaloneConfiguration;
import org.springframework.data.redis.connection.jedis.JedisConnectionFactory;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.StringRedisSerializer;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;

/**
 * Redisé…ç½®
 */
@Configuration
public class RedisConfig {

    @Bean
    @Primary
    @ConditionalOnProperty(name = "spring.redis.enabled", havingValue = "true", matchIfMissing = true)
    public RedisConnectionFactory redisConnectionFactory() {
        try {
            RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();
            config.setHostName("localhost");
            config.setPort(6379);
            config.setDatabase(0);
            return new JedisConnectionFactory(config);
        } catch (Exception e) {
            // å¦‚æœRedisæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ›å»ºæµ‹è¯•ç”¨çš„è¿æ¥å·¥å?            return new JedisConnectionFactory();
        }
    }

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
package com.heikeji.app.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

import java.util.Arrays;
import java.util.Collections;

/**
 * Spring Security Configuration Class
 * Configure which endpoints require authentication and which don't
 */
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // Disable CSRF
            .csrf(csrf -> csrf.disable())
            // Enable CORS
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            // Disable session, use JWT
            .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            // Authorization configuration
            .authorizeHttpRequests(authorize -> authorize
                // Allow anonymous access to login related endpoints
                .antMatchers("/auth/**", "/user/wechatLogin").permitAll()
                // Allow anonymous access to courier API (development stage)
                .antMatchers("/api/courier/**").permitAll()
                // Allow anonymous access to health check endpoints
                .antMatchers("/api/health/**", "/health/**", "/actuator/**").permitAll()
                // Allow anonymous access to frontend pages and static resources
                .antMatchers("/app/**", "/static/**", "/templates/**", "/css/**", "/js/**", "/images/**", "/fonts/**").permitAll()
                // Other requests require authentication
                .anyRequest().authenticated()
            )
            // Disable default login page
            .formLogin(form -> form.disable())
            .httpBasic(basic -> basic.disable());
            
        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOriginPatterns(Collections.singletonList("*"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Collections.singletonList("*"));
        configuration.setAllowCredentials(true);
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
package com.heikeji.app.config;

import org.springframework.context.annotation.Configuration;

/**
 * Swaggeré…ç½®ç±»ï¼ˆæš‚æ—¶ç¦ç”¨ï¼? * æ³¨é‡Šæ‰Swaggerç›¸å…³ä»£ç ä»¥é¿å…ä¾èµ–é—®é¢? */
@Configuration
public class SwaggerConfig {
    // Swaggeré…ç½®å·²æš‚æ—¶ç¦ç”¨ï¼Œç­‰å¾…ä¾èµ–é—®é¢˜è§£å†³åå†å¯ç”¨
}
package com.heikeji.app.config;

import com.heikeji.app.interceptor.JwtAuthenticationInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.converter.HttpMessageConverter;
import org.springframework.http.converter.StringHttpMessageConverter;
import org.springframework.web.filter.CharacterEncodingFilter;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

import java.nio.charset.StandardCharsets;

/**
 * Webé…ç½®ç±?
 * é…ç½®è·¨åŸŸã€æ‹¦æˆªå™¨ç­‰webç›¸å…³é…ç½®
 */
@Configuration
public class WebConfig implements WebMvcConfigurer {

    // ç§»é™¤RequestLogInterceptorä¾èµ–

    /**
     * é…ç½®è·¨åŸŸè¯·æ±‚
     */
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://localhost:3000", "http://localhost:8080") // å…è®¸ç‰¹å®šæ¥æº
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600); // é¢„æ£€è¯·æ±‚ç»“æœç¼“å­˜æ—¶é—´
    }

    /**
     * æ³¨å†Œæ‹¦æˆªå™?
     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        // æš‚æ—¶æ³¨é‡Šæ‰JWTè®¤è¯æ‹¦æˆªå™¨ï¼Œä»¥ä¾¿å¯åŠ¨æœåŠ¡
        // registry.addInterceptor(new JwtAuthenticationInterceptor())
        //         .addPathPatterns("/**")
        //         .excludePathPatterns("/auth/**", "/health/**", "/user/wechatLogin");
        
        // æ³¨å†Œè¯·æ±‚æ—¥å¿—æ‹¦æˆªå™¨ï¼ˆå¯é€‰ï¼‰
        // registry.addInterceptor(new RequestLogInterceptor())
        //         .addPathPatterns("/**");
    }
    
    /**
     * é…ç½®å­—ç¬¦ç¼–ç è¿‡æ»¤å™?
     */
    @Bean
    public CharacterEncodingFilter characterEncodingFilter() {
        CharacterEncodingFilter filter = new CharacterEncodingFilter();
        filter.setEncoding("UTF-8");
        filter.setForceEncoding(true);
        return filter;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.app.interceptor.JwtAuthenticationInterceptor;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import jakarta.servlet.http.HttpServletRequest;
import java.util.Map;
import java.util.HashMap;

/**
 * åœ°å€ç®¡ç†æ§åˆ¶å™? * å¤„ç†ç”¨æˆ·æ”¶è´§åœ°å€ç›¸å…³è¯·æ±‚
 */

@RestController
@RequestMapping("/app/address")
@Api(tags = "æ”¶è´§åœ°å€ç®¡ç†")
public class AddressController {

    private static final Logger log = LoggerFactory.getLogger(AddressController.class);

    // æš‚æ—¶ä½¿ç”¨Mapæ¥æ¨¡æ‹Ÿåœ°å€æœåŠ¡ï¼Œé¿å…ä¾èµ–é—®é¢?    // @Autowired
    // private MemberReceiveAddressService addressService;

    /**
     * è·å–ç”¨æˆ·åœ°å€åˆ—è¡¨
     */
    @GetMapping("/list")
    @ApiOperation("è·å–ç”¨æˆ·åœ°å€åˆ—è¡¨")
    public R<Map<String, Object>> getUserAddressList(HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            // æ¨¡æ‹Ÿè¿”å›ç©ºåˆ—è¡?            Map<String, Object> result = new HashMap<>();
            result.put("addresses", new Object[0]);
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–åœ°å€åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–åœ°å€åˆ—è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ·»åŠ æ”¶è´§åœ°å€
     */
    @PostMapping("/add")
    @ApiOperation("æ·»åŠ æ”¶è´§åœ°å€")
    public R<String> addAddress(@RequestBody Map<String, Object> addressData, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            // æ¨¡æ‹Ÿæ·»åŠ æ“ä½œ
            log.info("æ·»åŠ åœ°å€ï¼Œç”¨æˆ·IDï¼? + userId + "ï¼Œåœ°å€æ•°æ®ï¼? + addressData);
            return R.success("åœ°å€æ·»åŠ æˆåŠŸ");
        } catch (Exception e) {
            log.error("æ·»åŠ åœ°å€å¤±è´¥", e);
            return R.error("æ›´æ–°åœ°å€å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°æ”¶è´§åœ°å€
     */
    @PostMapping("/update")
    @ApiOperation("æ›´æ–°æ”¶è´§åœ°å€")
    public R<String> updateAddress(@RequestBody Map<String, Object> addressData, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            // æ¨¡æ‹Ÿæ›´æ–°æ“ä½œ
            log.info("æ›´æ–°åœ°å€ï¼Œç”¨æˆ·IDï¼? + userId + "ï¼Œåœ°å€æ•°æ®ï¼? + addressData);
            return R.success("åœ°å€æ›´æ–°æˆåŠŸ");
        } catch (Exception e) {
            log.error("æ›´æ–°åœ°å€å¤±è´¥", e);
            return R.error("æ›´æ–°åœ°å€å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * åˆ é™¤æ”¶è´§åœ°å€
     */
    @PostMapping("/delete/{id}")
    @ApiOperation("åˆ é™¤æ”¶è´§åœ°å€")
    public R<String> deleteAddress(@PathVariable Long id, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            // æ¨¡æ‹Ÿåˆ é™¤æ“ä½œ
            log.info("åˆ é™¤åœ°å€ï¼Œç”¨æˆ·IDï¼? + userId + "ï¼Œåœ°å€IDï¼? + id);
            return R.success("åœ°å€åˆ é™¤æˆåŠŸ");
        } catch (Exception e) {
            log.error("åˆ é™¤åœ°å€å¤±è´¥", e);
            return R.error("åˆ é™¤åœ°å€å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     */
    @PostMapping("/set-default/{id}")
    @ApiOperation("è®¾ç½®é»˜è®¤åœ°å€")
    public R<String> setDefaultAddress(@PathVariable Long id, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            // æ¨¡æ‹Ÿè®¾ç½®é»˜è®¤åœ°å€æ“ä½œ
            log.info("è®¾ç½®é»˜è®¤åœ°å€ï¼Œç”¨æˆ·IDï¼? + userId + "ï¼Œåœ°å€IDï¼? + id);
            return R.success("è®¾ç½®é»˜è®¤åœ°å€æˆåŠŸ");
        } catch (Exception e) {
            log.error("è®¾ç½®é»˜è®¤åœ°å€å¤±è´¥", e);
            return R.error("è®¾ç½®é»˜è®¤åœ°å€å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–ç”¨æˆ·ID
     * ä½¿ç”¨JWTéªŒè¯æ‹¦æˆªå™¨è·å–ç”¨æˆ·ä¿¡æ?     */
    private Long getUserId(HttpServletRequest request) {
        // å°è¯•ä»JWTæ‹¦æˆªå™¨ä¸­è·å–ç”¨æˆ·ID
        Long userId = JwtAuthenticationInterceptor.getCurrentUserId(request);
        
        if (userId != null) {
            log.debug("ä»JWT tokenä¸­è·å–åˆ°ç”¨æˆ·ID: {}", userId);
            return userId;
        }
        
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå°è¯•ä»headerä¸­è·å–ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
        String userIdStr = request.getHeader("X-User-Id");
        if (userIdStr != null && !userIdStr.isEmpty()) {
            try {
                Long parsedUserId = Long.parseLong(userIdStr);
                log.debug("ä»è¯·æ±‚å¤´ä¸­è·å–åˆ°ç”¨æˆ·ID: {}", parsedUserId);
                return parsedUserId;
            } catch (NumberFormatException e) {
                log.warn("ç”¨æˆ·IDæ ¼å¼é”™è¯¯: {}", userIdStr);
            }
        }
        
        // å¦‚æœéƒ½æ— æ³•è·å–ï¼Œè¿”å›é»˜è®¤å€¼ç”¨äºå¼€å‘æµ‹è¯?        log.warn("æ— æ³•ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·IDï¼Œä½¿ç”¨é»˜è®¤å€?);
        return 1L; // é»˜è®¤ç”¨æˆ·IDï¼Œä»…ç”¨äºå¼€å‘æµ‹è¯?    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.app.entity.Cart;
import com.heikeji.app.interceptor.JwtAuthenticationInterceptor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * è´­ç‰©è½¦æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/app/cart")
public class AppCartController {

    private static final Logger log = LoggerFactory.getLogger(AppCartController.class);
    // æ¨¡æ‹Ÿè´­ç‰©è½¦æ•°æ?    private final Map<Long, Cart> mockCartData = new HashMap<>();

    /**
     * è·å–å½“å‰ç”¨æˆ·ID
     * ä½¿ç”¨JWTéªŒè¯æ‹¦æˆªå™¨è·å–ç”¨æˆ·ä¿¡æ?     * @param request HTTPè¯·æ±‚
     * @return ç”¨æˆ·ID
     */
    private Long getUserId(HttpServletRequest request) {
        // å°è¯•ä»JWTæ‹¦æˆªå™¨ä¸­è·å–ç”¨æˆ·ID
        Long userId = JwtAuthenticationInterceptor.getCurrentUserId(request);
        
        if (userId != null) {
            log.debug("ä»JWT tokenä¸­è·å–åˆ°ç”¨æˆ·ID: {}", userId);
            return userId;
        }
        
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå°è¯•ä»headerä¸­è·å–ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
        String userIdStr = request.getHeader("X-User-Id");
        if (userIdStr != null && !userIdStr.isEmpty()) {
            try {
                Long parsedUserId = Long.parseLong(userIdStr);
                log.debug("ä»è¯·æ±‚å¤´ä¸­è·å–åˆ°ç”¨æˆ·ID: {}", parsedUserId);
                return parsedUserId;
            } catch (NumberFormatException e) {
                log.warn("ç”¨æˆ·IDæ ¼å¼é”™è¯¯: {}", userIdStr);
            }
        }
        
        // å¦‚æœéƒ½æ— æ³•è·å–ï¼Œè¿”å›é»˜è®¤å€¼ç”¨äºå¼€å‘æµ‹è¯?        log.warn("æ— æ³•ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·IDï¼Œä½¿ç”¨é»˜è®¤å€?);
        return 1L; // é»˜è®¤ç”¨æˆ·IDï¼Œä»…ç”¨äºå¼€å‘æµ‹è¯?    }

    /**
     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
     */
    @PostMapping("/add")
    public R<Cart> addToCart(@RequestParam Long productId, @RequestParam Integer quantity, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} æ·»åŠ å•†å“ {} åˆ°è´­ç‰©è½¦ï¼Œæ•°é‡ï¼š{}", userId, productId, quantity);
            
            // æ¨¡æ‹Ÿå®ç°
            Cart cart = new Cart();
            // åªè®¾ç½®Cartç±»ä¸­å®é™…å­˜åœ¨çš„å­—æ®?            cart.setId(productId);
            cart.setProductId(productId);
            cart.setUserId(userId);
            cart.setQuantity(quantity);
            mockCartData.put(productId, cart);
            
            return R.success(cart);
        } catch (Exception e) {
            log.error("æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦å¤±è´¥", e);
            return R.error("æ·»åŠ å¤±è´¥");
        }
    }

    /**
     * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @PostMapping("/update")
    public R<Boolean> updateCartQuantity(@RequestParam Long productId, @RequestParam Integer quantity, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} æ›´æ–°è´­ç‰©è½¦å•†å“?{} æ•°é‡ä¸ºï¼š{}", userId, productId, quantity);
            
            // æ¨¡æ‹Ÿå®ç°
            Cart cart = mockCartData.get(productId);
            if (cart != null) {
                cart.setQuantity(quantity);
            }
            
            return R.success(true);
        } catch (Exception e) {
            log.error("æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡å¤±è´?, e);
            return R.error("æ›´æ–°å¤±è´¥");
        }
    }

    /**
     * åˆ é™¤è´­ç‰©è½¦å•†å“?     */
    @PostMapping("/delete")
    public R<Boolean> removeFromCart(@RequestParam Long productId, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} ä»è´­ç‰©è½¦åˆ é™¤å•†å“ï¼š{}", userId, productId);
            
            // æ¨¡æ‹Ÿå®ç°
            mockCartData.remove(productId);
            
            return R.success(true);
        } catch (Exception e) {
            log.error("åˆ é™¤è´­ç‰©è½¦å•†å“å¤±è´?, e);
            return R.error("åˆ é™¤å¤±è´¥");
        }
    }

    /**
     * æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“?     */
    @PostMapping("/batch-delete")
    public R<Boolean> removeBatchFromCart(@RequestBody List<Long> productIds, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“ï¼š{}", userId, productIds);
            
            // æ¨¡æ‹Ÿå®ç°
            for (Long productId : productIds) {
                mockCartData.remove(productId);
            }
            
            return R.success(true);
        } catch (Exception e) {
            log.error("æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“å¤±è´?, e);
            return R.error("æ‰¹é‡åˆ é™¤å¤±è´¥");
        }
    }

    /**
     * æ¸…ç©ºè´­ç‰©è½?     */
    @PostMapping("/clear")
    public R<Boolean> clearCart(HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} æ¸…ç©ºè´­ç‰©è½?, userId);
            
            // æ¨¡æ‹Ÿå®ç°
            mockCartData.clear();
            
            return R.success(true);
        } catch (Exception e) {
            log.error("æ¸…ç©ºè´­ç‰©è½¦å¤±è´?, e);
            return R.error("æ¸…ç©ºå¤±è´¥");
        }
    }

    /**
     * è·å–è´­ç‰©è½¦åˆ—è¡?     */
    @GetMapping("/list")
    public R<List<Cart>> getCartList(HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} è·å–è´­ç‰©è½¦åˆ—è¡?, userId);
            
            // æ¨¡æ‹Ÿå®ç°
            List<Cart> cartList = new java.util.ArrayList<>(mockCartData.values());
            return R.success(cartList);
        } catch (Exception e) {
            log.error("è·å–è´­ç‰©è½¦åˆ—è¡¨å¤±è´?, e);
            return R.error("è·å–å¤±è´¥");
        }
    }

    /**
     * è·å–è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @GetMapping("/count")
    public R<Integer> getCartCount(HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} è·å–è´­ç‰©è½¦å•†å“æ•°é‡?, userId);
            
            // æ¨¡æ‹Ÿå®ç°
            return R.success(mockCartData.size());
        } catch (Exception e) {
            log.error("è·å–è´­ç‰©è½¦å•†å“æ•°é‡å¤±è´?, e);
            return R.error("è·å–å¤±è´¥");
        }
    }
    
    /**
     * æ£€æŸ¥è´­ç‰©è½¦å•†å“åº“å­˜
     */
    @GetMapping("/check-stock")
    public R<List<String>> checkCartStock(HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            log.info("ç”¨æˆ· {} æ£€æŸ¥è´­ç‰©è½¦å•†å“åº“å­˜", userId);
            
            // æ¨¡æ‹Ÿæ‰€æœ‰å•†å“éƒ½æœ‰åº“å­?            return R.success(java.util.Collections.emptyList());
        } catch (Exception e) {
            log.error("æ£€æŸ¥åº“å­˜å¤±è´?, e);
            return R.error("æ£€æŸ¥å¤±è´?);
        }
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.common.security.utils.JwtUtils;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

/**
 * è®¤è¯æ§åˆ¶å™?
 * å¤„ç†ç”¨æˆ·ç™»å½•ã€é€€å‡ºç­‰è®¤è¯ç›¸å…³åŠŸèƒ½
 */
@RestController
@RequestMapping("/auth")
@Api(tags = "ç”¨æˆ·è®¤è¯")
public class AuthController {

    @Value("${jwt.secret:default_secret_key}")
    private String jwtSecret;

    @Value("${jwt.expire_time:86400000}")
    private long jwtExpireTime;

    /**
     * ç”¨æˆ·ç™»å½•
     * æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥éªŒè¯ç”¨æˆ·åå¯†ç ï¼Œå¹¶ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @PostMapping("/login")
    @ApiOperation("ç”¨æˆ·ç™»å½•")
    public R<Map<String, Object>> login(@RequestBody @ApiParam("ç™»å½•è¯·æ±‚å‚æ•°") LoginRequest request) {
        // è¿™é‡Œæ˜¯ç®€åŒ–çš„ç™»å½•éªŒè¯ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ?
        // ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œæˆ‘ä»¬å…è®¸ä»»ä½•ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼Œä½¿ç”¨ç”¨æˆ·åä½œä¸ºç”¨æˆ·ID
        String username = request.getUsername();
        String password = request.getPassword();

        // ç®€å•éªŒè¯ï¼Œå®é™…åº”è¯¥ä»æ•°æ®åº“éªŒè¯
        if (username == null || username.trim().isEmpty()) {
            return R.error(400, "ç”¨æˆ·åä¸èƒ½ä¸ºç©?);
        }

        // ç”Ÿæˆç”¨æˆ·IDï¼Œå®é™…åº”è¯¥ä»æ•°æ®åº“è·å?
        Long userId = generateUserId(username);

        // ç”ŸæˆJWT token
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("username", username);
        String token = JwtUtils.generateCustomToken(claims, jwtExpireTime);

        // æ„å»ºè¿”å›æ•°æ®
        Map<String, Object> data = new HashMap<>();
        data.put("token", token);
        data.put("userId", userId);
        data.put("username", username);
        data.put("expireTime", jwtExpireTime);

        return R.success("ç™»å½•æˆåŠŸ", data);
    }

    /**
     * åˆ·æ–°Token
     */
    @PostMapping("/refresh")
    @ApiOperation("åˆ·æ–°Token")
    public R<Map<String, Object>> refreshToken(@RequestBody @ApiParam("åˆ·æ–°Tokenè¯·æ±‚å‚æ•°") RefreshTokenRequest request) {
        // éªŒè¯refresh token
        // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»æ•°æ®åº“æˆ–ç¼“å­˜ä¸­éªŒè¯refresh token
        String refreshToken = request.getRefreshToken();
        if (refreshToken == null || refreshToken.isEmpty()) {
            return R.error(400, "æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰?);
        }

        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»refresh tokenä¸­è§£æç”¨æˆ·ä¿¡æ?
        Long userId = 1L; // ç¤ºä¾‹ç”¨æˆ·ID
        String username = "user"; // ç¤ºä¾‹ç”¨æˆ·å?

        // ç”Ÿæˆæ–°çš„token
        String newToken = JwtUtils.generateToken(userId, username);

        Map<String, Object> data = new HashMap<>();
        data.put("token", newToken);
        data.put("expireTime", jwtExpireTime);

        return R.success("Tokenåˆ·æ–°æˆåŠŸ", data);
    }

    /**
     * ç”¨æˆ·ç™»å‡º
     */
    @PostMapping("/logout")
    @ApiOperation("ç”¨æˆ·ç™»å‡º")
    public R<?> logout() {
        // å®é™…é¡¹ç›®ä¸­åº”è¯¥å°†tokenåŠ å…¥é»‘åå?
        // æˆ–è€…æ¸…é™¤ç”¨æˆ·ç›¸å…³çš„ä¼šè¯ä¿¡æ¯
        return R.success("ç™»å‡ºæˆåŠŸ");
    }

    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/info")
    @ApiOperation("è·å–ç”¨æˆ·ä¿¡æ¯")
    public R<Map<String, Object>> getUserInfo() {
        // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ä¿¡æ?
        Map<String, Object> userInfo = new HashMap<>();
        userInfo.put("userId", 1L);
        userInfo.put("username", "æµ‹è¯•ç”¨æˆ·");
        userInfo.put("nickname", "æµ‹è¯•ç”¨æˆ·æ˜µç§°");
        userInfo.put("avatar", "https://via.placeholder.com/150");
        
        return R.success("è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ", userInfo);
    }

    /**
     * ç”Ÿæˆç”¨æˆ·IDï¼ˆç¤ºä¾‹æ–¹æ³•ï¼‰
     * å®é™…åº”è¯¥ä»æ•°æ®åº“è·å–ç”¨æˆ·ID
     */
    private Long generateUserId(String username) {
        // ç®€å•å¤„ç†ï¼Œå®é™…åº”è¯¥ä»æ•°æ®åº“æŸ¥è¯¢
        return (long) (username.hashCode() & Integer.MAX_VALUE);
    }

    /**
     * ç™»å½•è¯·æ±‚å‚æ•°
     */
    static class LoginRequest {
        private String username;
        private String password;

        public String getUsername() {
            return username;
        }

        public void setUsername(String username) {
            this.username = username;
        }

        public String getPassword() {
            return password;
        }

        public void setPassword(String password) {
            this.password = password;
        }
    }

    /**
     * åˆ·æ–°Tokenè¯·æ±‚å‚æ•°
     */
    static class RefreshTokenRequest {
        private String refreshToken;

        public String getRefreshToken() {
            return refreshToken;
        }

        public void setRefreshToken(String refreshToken) {
            this.refreshToken = refreshToken;
        }
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.app.entity.Category;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.ArrayList;
import java.util.List;

/**
 * å•†å“åˆ†ç±»æ§åˆ¶å™? * å¤„ç†å•†å“åˆ†ç±»ç›¸å…³çš„å‰ç«¯è¯·æ±? */

@RestController
@RequestMapping("/app/category")
@Api(tags = "å•†å“åˆ†ç±»ç®¡ç†")
public class CategoryController {

    private static final Logger log = LoggerFactory.getLogger(CategoryController.class);

    /**
     * è·å–æ‰€æœ‰å¯ç”¨çŠ¶æ€çš„åˆ†ç±»åˆ—è¡¨
     * @return åˆ†ç±»åˆ—è¡¨
     */
    @GetMapping("/list")
    @ApiOperation("è·å–åˆ†ç±»åˆ—è¡¨")
    public R<List<Category>> getCategoryList() {
        try {
            // æ¨¡æ‹Ÿå®ç°
            List<Category> categories = new ArrayList<>();
            
            // æ·»åŠ æ¨¡æ‹Ÿåˆ†ç±»æ•°æ®
            for (long i = 1; i <= 5; i++) {
                Category category = new Category();
                // åªè®¾ç½®Categoryç±»ä¸­å®é™…å­˜åœ¨çš„å­—æ®?                category.setId(i);
                category.setName("åˆ†ç±»" + i);
                categories.add(category);
            }
            
            return R.success(categories);
        } catch (Exception e) {
            log.error("è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * éª‘æ‰‹ç«¯æ§åˆ¶å™¨
 * å¤„ç†éª‘æ‰‹ç«¯ä»ªè¡¨æ¿ç›¸å…³è¯·æ±‚
 */
@RestController
@RequestMapping("/courier")
@Api(tags = "éª‘æ‰‹ç«¯ç®¡ç?)
public class CourierController {

    private static final Logger log = LoggerFactory.getLogger(CourierController.class);

    /**
     * è·å–éª‘æ‰‹ä»ªè¡¨æ¿æ•°æ?     */
    @GetMapping("/dashboard")
    @ApiOperation("è·å–éª‘æ‰‹ä»ªè¡¨æ¿æ•°æ?)
    public R<Map<String, Object>> getDashboardData(HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿéª‘æ‰‹ä¿¡æ¯
            Map<String, Object> courierInfo = new HashMap<>();
            courierInfo.put("id", courierId);
            courierInfo.put("name", "å¼ é…é€?);
            courierInfo.put("phone", "138****9999");
            courierInfo.put("avatar", "/images/courier-avatar.jpg");
            courierInfo.put("onlineStatus", "online"); // online, offline
            courierInfo.put("rating", 4.9);
            courierInfo.put("totalOrders", 1256);
            courierInfo.put("joinDate", "2024-03-15");
            
            // æ¨¡æ‹Ÿä»Šæ—¥ç»Ÿè®¡æ•°æ®
            Map<String, Object> stats = new HashMap<>();
            stats.put("todayDeliveries", 18);
            stats.put("pendingOrders", 3);
            stats.put("todayIncome", 156.80);
            
            // æ¨¡æ‹Ÿå¾…å¤„ç†è®¢å?            List<Map<String, Object>> pendingOrders = new ArrayList<>();
            for (int i = 0; i < 3; i++) {
                Map<String, Object> order = new HashMap<>();
                order.put("id", "C" + System.currentTimeMillis() + i);
                order.put("orderNo", "ORD" + (10000 + i));
                order.put("type", i == 0 ? "takeout" : (i == 1 ? "pickup" : "buy"));
                order.put("pickupAddress", "é»‘ç§‘é¤å… - 2æ¥¼åŒ…é—?);
                order.put("deliveryAddress", "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Aæ ? + (i + 1) + "å®?);
                order.put("fee", 3.5 + i * 0.5);
                order.put("distance", 0.8 + i * 0.2);
                order.put("estimatedTime", 15 + i * 5);
                order.put("customerName", "å­¦ç”Ÿç”¨æˆ·" + (i + 1));
                order.put("customerPhone", "156****" + String.format("%04d", 1000 + i));
                order.put("createTime", "2025-11-13 " + String.format("%02d:%02d", 16 + i, 30 - i * 10));
                pendingOrders.add(order);
            }
            
            // æ¨¡æ‹Ÿæœ€è¿‘é…é€è®°å½?            List<Map<String, Object>> recentOrders = new ArrayList<>();
            String[] statuses = {"å·²å®Œæˆ?, "å·²å®Œæˆ?, "å·²å®Œæˆ?, "é…é€ä¸­", "å¾…æ¥å?};
            String[] deliveryTimes = {"16:45", "16:20", "15:55", "-", "-"};
            
            for (int i = 0; i < 5; i++) {
                Map<String, Object> order = new HashMap<>();
                order.put("id", "R" + i);
                order.put("orderNo", "ORD" + (9000 + i));
                order.put("pickupAddress", "é»‘ç§‘é¤å…");
                order.put("deliveryAddress", "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Bæ ? + (i + 1) + "å®?);
                order.put("fee", 3.0 + i * 0.3);
                order.put("status", statuses[i]);
                order.put("deliveryTime", deliveryTimes[i]);
                recentOrders.add(order);
            }
            
            // æ„å»ºè¿”å›æ•°æ®
            Map<String, Object> result = new HashMap<>();
            result.put("courierInfo", courierInfo);
            result.put("stats", stats);
            result.put("pendingOrders", pendingOrders);
            result.put("recentOrders", recentOrders);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–éª‘æ‰‹ä»ªè¡¨æ¿æ•°æ®å¤±è´?, e);
            return R.error("è·å–æ•°æ®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–éª‘æ‰‹ä¸ªäººä¿¡æ¯
     */
    @GetMapping("/profile")
    @ApiOperation("è·å–éª‘æ‰‹ä¸ªäººä¿¡æ¯")
    public R<Map<String, Object>> getCourierProfile(HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            Map<String, Object> profile = new HashMap<>();
            profile.put("id", courierId);
            profile.put("name", "å¼ é…é€?);
            profile.put("phone", "138****9999");
            profile.put("avatar", "/images/courier-avatar.jpg");
            profile.put("realName", "å¼ ä¸‰");
            profile.put("idCard", "110101199001011234");
            profile.put("vehicleType", "ç”µåŠ¨è½?);
            profile.put("vehicleNumber", "äº¬A12345");
            profile.put("licenseNumber", "DL123456789");
            profile.put("emergencyContact", "æå››");
            profile.put("emergencyPhone", "139****8888");
            profile.put("onlineStatus", "online");
            profile.put("rating", 4.9);
            profile.put("totalOrders", 1256);
            profile.put("joinDate", "2024-03-15");
            profile.put("lastLoginTime", "2025-11-13 16:30:00");
            
            return R.success(profile);
        } catch (Exception e) {
            log.error("è·å–éª‘æ‰‹ä¸ªäººä¿¡æ¯å¤±è´¥", e);
            return R.error("è·å–ä¿¡æ¯å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°éª‘æ‰‹åœ¨çº¿çŠ¶æ€?     */
    @PostMapping("/status")
    @ApiOperation("æ›´æ–°éª‘æ‰‹åœ¨çº¿çŠ¶æ€?)
    public R<Map<String, Object>> updateOnlineStatus(@RequestParam String status, HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} æ›´æ–°åœ¨çº¿çŠ¶æ€ä¸º: {}", courierId, status);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "çŠ¶æ€æ›´æ–°æˆåŠ?);
            result.put("status", status);
            result.put("updateTime", new Date());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ›´æ–°éª‘æ‰‹åœ¨çº¿çŠ¶æ€å¤±è´?, e);
            return R.error("æ›´æ–°å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–éª‘æ‰‹ä½ç½®ä¿¡æ¯
     */
    @GetMapping("/location")
    @ApiOperation("è·å–éª‘æ‰‹ä½ç½®ä¿¡æ¯")
    public R<Map<String, Object>> getCourierLocation(HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿä½ç½®ä¿¡æ¯
            Map<String, Object> location = new HashMap<>();
            location.put("courierId", courierId);
            location.put("longitude", 116.307484 + Math.random() * 0.01);
            location.put("latitude", 39.904026 + Math.random() * 0.01);
            location.put("address", "é»‘ç§‘æŠ€å¤§å­¦é™„è¿‘");
            location.put("updateTime", new Date());
            location.put("accuracy", 5.0);
            
            return R.success(location);
        } catch (Exception e) {
            log.error("è·å–éª‘æ‰‹ä½ç½®ä¿¡æ¯å¤±è´¥", e);
            return R.error("è·å–ä½ç½®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°éª‘æ‰‹ä½ç½®
     */
    @PostMapping("/location")
    @ApiOperation("æ›´æ–°éª‘æ‰‹ä½ç½®")
    public R<Map<String, Object>> updateCourierLocation(
            @RequestParam Double longitude,
            @RequestParam Double latitude,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} æ›´æ–°ä½ç½®: {}, {}", courierId, longitude, latitude);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "ä½ç½®æ›´æ–°æˆåŠŸ");
            result.put("longitude", longitude);
            result.put("latitude", latitude);
            result.put("updateTime", new Date());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ›´æ–°éª‘æ‰‹ä½ç½®å¤±è´¥", e);
            return R.error("æ›´æ–°ä½ç½®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–éª‘æ‰‹å·¥ä½œç»Ÿè®¡
     */
    @GetMapping("/work-stats")
    @ApiOperation("è·å–éª‘æ‰‹å·¥ä½œç»Ÿè®¡")
    public R<Map<String, Object>> getWorkStats(
            @RequestParam String period, // 7d, 30d, 90d
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            Map<String, Object> workStats = new HashMap<>();
            
            // æ ¹æ®æ—¶é—´æ®µç”Ÿæˆä¸åŒæ•°æ?            switch (period) {
                case "7d":
                    workStats.put("totalOrders", 126);
                    workStats.put("totalIncome", 1260.50);
                    workStats.put("avgDeliveryTime", 22);
                    workStats.put("avgRating", 4.8);
                    workStats.put("onlineHours", 84);
                    break;
                case "30d":
                    workStats.put("totalOrders", 568);
                    workStats.put("totalIncome", 5680.80);
                    workStats.put("avgDeliveryTime", 21);
                    workStats.put("avgRating", 4.9);
                    workStats.put("onlineHours", 360);
                    break;
                case "90d":
                    workStats.put("totalOrders", 1256);
                    workStats.put("totalIncome", 12560.30);
                    workStats.put("avgDeliveryTime", 20);
                    workStats.put("avgRating", 4.9);
                    workStats.put("onlineHours", 1080);
                    break;
                default:
                    workStats.put("totalOrders", 126);
                    workStats.put("totalIncome", 1260.50);
                    workStats.put("avgDeliveryTime", 22);
                    workStats.put("avgRating", 4.8);
                    workStats.put("onlineHours", 84);
            }
            
            // æ¨¡æ‹Ÿè¶‹åŠ¿æ•°æ®
            List<Map<String, Object>> trendData = new ArrayList<>();
            String[] dates = {"11-07", "11-08", "11-09", "11-10", "11-11", "11-12", "11-13"};
            int[] orders = {15, 18, 22, 19, 25, 20, 18};
            double[] income = {150.5, 180.8, 220.2, 190.5, 250.3, 200.8, 156.8};
            
            for (int i = 0; i < dates.length; i++) {
                Map<String, Object> data = new HashMap<>();
                data.put("date", dates[i]);
                data.put("orders", orders[i]);
                data.put("income", income[i]);
                trendData.add(data);
            }
            
            workStats.put("trendData", trendData);
            
            return R.success(workStats);
        } catch (Exception e) {
            log.error("è·å–éª‘æ‰‹å·¥ä½œç»Ÿè®¡å¤±è´¥", e);
            return R.error("è·å–ç»Ÿè®¡å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * ä»è¯·æ±‚ä¸­è·å–éª‘æ‰‹IDï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
     */
    private Long getCourierId(HttpServletRequest request) {
        String courierIdStr = request.getHeader("X-Courier-Id");
        if (courierIdStr != null) {
            try {
                return Long.parseLong(courierIdStr);
            } catch (NumberFormatException e) {
                log.warn("æ— æ•ˆçš„éª‘æ‰‹ID: {}", courierIdStr);
            }
        }
        // é»˜è®¤è¿”å›æµ‹è¯•éª‘æ‰‹ID
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * éª‘æ‰‹ç«¯è®¢å•ç®¡ç†æ§åˆ¶å™¨
 * å¤„ç†éª‘æ‰‹ç«¯è®¢å•ç›¸å…³è¯·æ±? */
@RestController
@RequestMapping("/courier/orders")
@Api(tags = "éª‘æ‰‹ç«¯è®¢å•ç®¡ç?)
public class CourierOrderController {

    private static final Logger log = LoggerFactory.getLogger(CourierOrderController.class);

    /**
     * è·å–è®¢å•åˆ—è¡¨
     */
    @GetMapping
    @ApiOperation("è·å–è®¢å•åˆ—è¡¨")
    public R<Map<String, Object>> getOrderList(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer size,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String dateRange,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿè®¢å•æ•°æ®
            List<Map<String, Object>> orders = generateMockOrders();
            
            // ç­›é€‰é€»è¾‘
            if (status != null && !status.isEmpty()) {
                orders.removeIf(order -> !status.equals(order.get("status")));
            }
            if (type != null && !type.isEmpty()) {
                orders.removeIf(order -> !type.equals(order.get("type")));
            }
            
            // åˆ†é¡µ
            int total = orders.size();
            int start = (page - 1) * size;
            int end = Math.min(start + size, total);
            List<Map<String, Object>> pageOrders = orders.subList(start, end);
            
            // æ¨¡æ‹Ÿè®¢å•ç»Ÿè®¡
            Map<String, Object> stats = new HashMap<>();
            stats.put("total", 126);
            stats.put("pending", 3);
            stats.put("processing", 8);
            stats.put("completed", 115);
            stats.put("totalIncome", 1260.50);
            stats.put("avgDeliveryTime", 22);
            
            Map<String, Object> result = new HashMap<>();
            result.put("orders", pageOrders);
            result.put("total", total);
            result.put("page", page);
            result.put("size", size);
            result.put("stats", stats);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–è®¢å•åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–è®¢å•åˆ—è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/{orderId}")
    @ApiOperation("è·å–è®¢å•è¯¦æƒ…")
    public R<Map<String, Object>> getOrderDetail(@PathVariable String orderId, HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿè®¢å•è¯¦æƒ…
            Map<String, Object> orderDetail = generateMockOrderDetail(orderId);
            
            return R.success(orderDetail);
        } catch (Exception e) {
            log.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ¥å•
     */
    @PostMapping("/{orderId}/accept")
    @ApiOperation("æ¥å•")
    public R<Map<String, Object>> acceptOrder(@PathVariable String orderId, HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} æ¥å•: {}", courierId, orderId);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "æ¥å•æˆåŠŸ");
            result.put("orderId", orderId);
            result.put("acceptTime", new Date());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ¥å•å¤±è´¥", e);
            return R.error("æ¥å•å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/{orderId}/cancel")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Map<String, Object>> cancelOrder(
            @PathVariable String orderId, 
            @RequestParam String reason,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} å–æ¶ˆè®¢å•: {}, åŸå› : {}", courierId, orderId, reason);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "è®¢å•å–æ¶ˆæˆåŠŸ");
            result.put("orderId", orderId);
            result.put("cancelTime", new Date());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("å–æ¶ˆè®¢å•å¤±è´¥", e);
            return R.error("å–æ¶ˆè®¢å•å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å¼€å§‹é…é€?     */
    @PostMapping("/{orderId}/start-delivery")
    @ApiOperation("å¼€å§‹é…é€?)
    public R<Map<String, Object>> startDelivery(@PathVariable String orderId, HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} å¼€å§‹é…é€è®¢å? {}", courierId, orderId);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "å¼€å§‹é…é€æˆåŠ?);
            result.put("orderId", orderId);
            result.put("startTime", new Date());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("å¼€å§‹é…é€å¤±è´?, e);
            return R.error("å¼€å§‹é…é€å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * å®Œæˆé…é€?     */
    @PostMapping("/{orderId}/complete")
    @ApiOperation("å®Œæˆé…é€?)
    public R<Map<String, Object>> completeDelivery(
            @PathVariable String orderId,
            @RequestParam(required = false) String signature,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} å®Œæˆé…é€è®¢å? {}", courierId, orderId);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "é…é€å®Œæˆ?);
            result.put("orderId", orderId);
            result.put("completeTime", new Date());
            result.put("deliveryFee", 3.5);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("å®Œæˆé…é€å¤±è´?, e);
            return R.error("å®Œæˆé…é€å¤±è´¥ï¼š" + e.getMessage());
        }
    }

    /**
     * è·å–é…é€è·¯å¾?     */
    @GetMapping("/{orderId}/route")
    @ApiOperation("è·å–é…é€è·¯å¾?)
    public R<Map<String, Object>> getDeliveryRoute(@PathVariable String orderId, HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿè·¯å¾„æ•°æ®
            List<Map<String, Object>> route = new ArrayList<>();
            
            // èµ·ç‚¹ï¼ˆå•†å®¶ä½ç½®ï¼‰
            Map<String, Object> startPoint = new HashMap<>();
            startPoint.put("lat", 39.904026);
            startPoint.put("lng", 116.307484);
            startPoint.put("address", "é»‘ç§‘é¤å…");
            startPoint.put("type", "pickup");
            route.add(startPoint);
            
            // ç»ˆç‚¹ï¼ˆå®¢æˆ·ä½ç½®ï¼‰
            Map<String, Object> endPoint = new HashMap<>();
            endPoint.put("lat", 39.914026);
            endPoint.put("lng", 116.317484);
            endPoint.put("address", "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Aæ ?);
            endPoint.put("type", "delivery");
            route.add(endPoint);
            
            Map<String, Object> routeInfo = new HashMap<>();
            routeInfo.put("orderId", orderId);
            routeInfo.put("route", route);
            routeInfo.put("totalDistance", 1.2);
            routeInfo.put("estimatedTime", 15);
            
            return R.success(routeInfo);
        } catch (Exception e) {
            log.error("è·å–é…é€è·¯å¾„å¤±è´?, e);
            return R.error("è·å–è·¯å¾„å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * ç”Ÿæˆæ¨¡æ‹Ÿè®¢å•æ•°æ®
     */
    private List<Map<String, Object>> generateMockOrders() {
        List<Map<String, Object>> orders = new ArrayList<>();
        String[] statuses = {"å¾…æ¥å?, "å·²æ¥å?, "å–é¤ä¸?, "é…é€ä¸­", "å·²å®Œæˆ?, "å·²å®Œæˆ?, "å·²å®Œæˆ?, "å·²å®Œæˆ?};
        String[] types = {"takeout", "pickup", "buy", "takeout", "takeout", "pickup", "buy", "takeout"};
        String[] pickupAddresses = {
            "é»‘ç§‘é¤å… - 2æ¥¼åŒ…é—?,
            "åè±å£«ç‚¸é¸¡åº—",
            "ç¾å›¢å¤–å–å–é¤ç‚?,
            "é»‘ç§‘é¤å… - 1æ¥¼å¤§å?,
            "å¥¶èŒ¶åº?
        };
        String[] deliveryAddresses = {
            "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Aæ ?å®?,
            "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Bæ ?å®?, 
            "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Cæ ?å®?,
            "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Aæ ?å®?,
            "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Dæ ?å®?
        };
        
        for (int i = 0; i < 20; i++) {
            Map<String, Object> order = new HashMap<>();
            order.put("id", "C" + (10000 + i));
            order.put("orderNo", "ORD" + (10000 + i));
            order.put("status", statuses[i % statuses.length]);
            order.put("type", types[i % types.length]);
            order.put("pickupAddress", pickupAddresses[i % pickupAddresses.length]);
            order.put("deliveryAddress", deliveryAddresses[i % deliveryAddresses.length]);
            order.put("customerName", "å­¦ç”Ÿç”¨æˆ·" + (i + 1));
            order.put("customerPhone", "156****" + String.format("%04d", 1000 + i));
            order.put("fee", 3.0 + i * 0.2);
            order.put("distance", 0.8 + i * 0.1);
            order.put("estimatedTime", 15 + i * 2);
            order.put("createTime", "2025-11-13 " + String.format("%02d:%02d", 14 + i/2, (i*10)%60));
            order.put("notes", i % 3 == 0 ? "è¯·å°½å¿«é…é€? : "");
            
            orders.add(order);
        }
        
        return orders;
    }

    /**
     * ç”Ÿæˆæ¨¡æ‹Ÿè®¢å•è¯¦æƒ…
     */
    private Map<String, Object> generateMockOrderDetail(String orderId) {
        Map<String, Object> detail = new HashMap<>();
        detail.put("id", orderId);
        detail.put("orderNo", "ORD" + orderId.substring(1));
        detail.put("status", "é…é€ä¸­");
        detail.put("type", "takeout");
        detail.put("pickupAddress", "é»‘ç§‘é¤å… - 2æ¥¼åŒ…é—?);
        detail.put("pickupPhone", "138****8888");
        detail.put("deliveryAddress", "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿå…¬å¯“Aæ ?å®?);
        detail.put("deliveryPhone", "156****1001");
        detail.put("customerName", "å­¦ç”Ÿç”¨æˆ·1");
        detail.put("fee", 3.5);
        detail.put("distance", 1.0);
        detail.put("estimatedTime", 20);
        detail.put("createTime", "2025-11-13 16:30:00");
        detail.put("acceptTime", "2025-11-13 16:35:00");
        detail.put("pickupTime", "2025-11-13 16:40:00");
        detail.put("notes", "è¯·å°½å¿«é…é€ï¼Œè¯¾ç¨‹é©¬ä¸Šå¼€å§?);
        
        // æ¨¡æ‹Ÿå•†å“ä¿¡æ¯
        List<Map<String, Object>> items = new ArrayList<>();
        Map<String, Object> item1 = new HashMap<>();
        item1.put("name", "å®«ä¿é¸¡ä¸");
        item1.put("quantity", 1);
        item1.put("price", 18.0);
        items.add(item1);
        
        Map<String, Object> item2 = new HashMap<>();
        item2.put("name", "ç±³é¥­");
        item2.put("quantity", 2);
        item2.put("price", 2.0);
        items.add(item2);
        
        detail.put("items", items);
        detail.put("totalAmount", 22.0);
        
        return detail;
    }

    /**
     * ä»è¯·æ±‚ä¸­è·å–éª‘æ‰‹IDï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
     */
    private Long getCourierId(HttpServletRequest request) {
        String courierIdStr = request.getHeader("X-Courier-Id");
        if (courierIdStr != null) {
            try {
                return Long.parseLong(courierIdStr);
            } catch (NumberFormatException e) {
                log.warn("æ— æ•ˆçš„éª‘æ‰‹ID: {}", courierIdStr);
            }
        }
        // é»˜è®¤è¿”å›æµ‹è¯•éª‘æ‰‹ID
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * éª‘æ‰‹ç«¯ç»Ÿè®¡æ§åˆ¶å™¨
 * å¤„ç†éª‘æ‰‹ç«¯æ•°æ®ç»Ÿè®¡ç›¸å…³è¯·æ±? */
@RestController
@RequestMapping("/courier/statistics")
@Api(tags = "éª‘æ‰‹ç«¯æ•°æ®ç»Ÿè®?)
public class CourierStatisticsController {

    private static final Logger log = LoggerFactory.getLogger(CourierStatisticsController.class);

    /**
     * è·å–æ¦‚è§ˆç»Ÿè®¡æ•°æ®
     */
    @GetMapping("/overview")
    @ApiOperation("è·å–æ¦‚è§ˆç»Ÿè®¡æ•°æ®")
    public R<Map<String, Object>> getOverviewStats(
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            Map<String, Object> overviewStats = new HashMap<>();
            
            // æ ¹æ®æ—¶é—´æ®µç”Ÿæˆä¸åŒæ•°æ?            switch (period) {
                case "7d":
                    overviewStats.put("totalDeliveries", 126);
                    overviewStats.put("totalIncome", 1260.50);
                    overviewStats.put("avgRating", 4.8);
                    overviewStats.put("avgDeliveryTime", 22);
                    overviewStats.put("deliveryTrend", 12.5);
                    overviewStats.put("incomeTrend", 15.8);
                    overviewStats.put("ratingTrend", 2.1);
                    overviewStats.put("timeTrend", -5.2);
                    break;
                case "30d":
                    overviewStats.put("totalDeliveries", 568);
                    overviewStats.put("totalIncome", 5680.80);
                    overviewStats.put("avgRating", 4.9);
                    overviewStats.put("avgDeliveryTime", 21);
                    overviewStats.put("deliveryTrend", 8.3);
                    overviewStats.put("incomeTrend", 10.2);
                    overviewStats.put("ratingTrend", 1.5);
                    overviewStats.put("timeTrend", -8.7);
                    break;
                case "90d":
                    overviewStats.put("totalDeliveries", 1256);
                    overviewStats.put("totalIncome", 12560.30);
                    overviewStats.put("avgRating", 4.9);
                    overviewStats.put("avgDeliveryTime", 20);
                    overviewStats.put("deliveryTrend", 5.8);
                    overviewStats.put("incomeTrend", 7.2);
                    overviewStats.put("ratingTrend", 0.8);
                    overviewStats.put("timeTrend", -12.3);
                    break;
                default:
                    overviewStats.put("totalDeliveries", 126);
                    overviewStats.put("totalIncome", 1260.50);
                    overviewStats.put("avgRating", 4.8);
                    overviewStats.put("avgDeliveryTime", 22);
                    overviewStats.put("deliveryTrend", 12.5);
                    overviewStats.put("incomeTrend", 15.8);
                    overviewStats.put("ratingTrend", 2.1);
                    overviewStats.put("timeTrend", -5.2);
            }
            
            return R.success(overviewStats);
        } catch (Exception e) {
            log.error("è·å–æ¦‚è§ˆç»Ÿè®¡å¤±è´¥", e);
            return R.error("è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–é…é€è¶‹åŠ¿æ•°æ?     */
    @GetMapping("/delivery-trend")
    @ApiOperation("è·å–é…é€è¶‹åŠ¿æ•°æ?)
    public R<Map<String, Object>> getDeliveryTrend(
            @RequestParam(defaultValue = "daily") String type, // daily, weekly, monthly
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            List<Map<String, Object>> trendData = new ArrayList<>();
            
            if ("daily".equals(type)) {
                // æŒ‰æ—¥æ•°æ®
                String[] dates = {"11-07", "11-08", "11-09", "11-10", "11-11", "11-12", "11-13"};
                int[] deliveries = {15, 18, 22, 19, 25, 20, 18};
                double[] income = {150.5, 180.8, 220.2, 190.5, 250.3, 200.8, 156.8};
                
                for (int i = 0; i < dates.length; i++) {
                    Map<String, Object> data = new HashMap<>();
                    data.put("date", dates[i]);
                    data.put("deliveries", deliveries[i]);
                    data.put("income", income[i]);
                    data.put("avgTime", 20 + i);
                    trendData.add(data);
                }
            } else if ("weekly".equals(type)) {
                // æŒ‰å‘¨æ•°æ®
                String[] weeks = {"ç¬?5å‘?, "ç¬?6å‘?, "ç¬?7å‘?, "ç¬?8å‘?};
                int[] deliveries = {95, 108, 122, 126};
                double[] income = {950.5, 1080.8, 1220.2, 1260.5};
                
                for (int i = 0; i < weeks.length; i++) {
                    Map<String, Object> data = new HashMap<>();
                    data.put("date", weeks[i]);
                    data.put("deliveries", deliveries[i]);
                    data.put("income", income[i]);
                    data.put("avgTime", 22 - i);
                    trendData.add(data);
                }
            } else {
                // æŒ‰æœˆæ•°æ®
                String[] months = {"8æœ?, "9æœ?, "10æœ?, "11æœ?};
                int[] deliveries = {380, 420, 485, 568};
                double[] income = {3800.5, 4200.8, 4850.2, 5680.8};
                
                for (int i = 0; i < months.length; i++) {
                    Map<String, Object> data = new HashMap<>();
                    data.put("date", months[i]);
                    data.put("deliveries", deliveries[i]);
                    data.put("income", income[i]);
                    data.put("avgTime", 25 - i);
                    trendData.add(data);
                }
            }
            
            Map<String, Object> result = new HashMap<>();
            result.put("trendData", trendData);
            result.put("chartType", type);
            result.put("period", period);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–é…é€è¶‹åŠ¿æ•°æ®å¤±è´?, e);
            return R.error("è·å–è¶‹åŠ¿æ•°æ®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–è®¢å•ç±»å‹åˆ†å¸ƒæ•°æ®
     */
    @GetMapping("/order-type-distribution")
    @ApiOperation("è·å–è®¢å•ç±»å‹åˆ†å¸ƒæ•°æ®")
    public R<Map<String, Object>> getOrderTypeDistribution(
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿè®¢å•ç±»å‹åˆ†å¸ƒæ•°æ®
            Map<String, Object> distribution = new HashMap<>();
            distribution.put("å¤–å–é…é€?, 65);
            distribution.put("å–å¿«é€?, 25);
            distribution.put("ä»£è´­å•†å“", 10);
            
            // å¦‚æœæ˜?0å¤©æ•°æ®ï¼Œè°ƒæ•´æ¯”ä¾‹
            if ("30d".equals(period)) {
                distribution.put("å¤–å–é…é€?, 68);
                distribution.put("å–å¿«é€?, 22);
                distribution.put("ä»£è´­å•†å“", 10);
            } else if ("90d".equals(period)) {
                distribution.put("å¤–å–é…é€?, 70);
                distribution.put("å–å¿«é€?, 20);
                distribution.put("ä»£è´­å•†å“", 10);
            }
            
            // è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®æ ¼å¼?            List<Map<String, Object>> chartData = new ArrayList<>();
            for (Map.Entry<String, Object> entry : distribution.entrySet()) {
                Map<String, Object> item = new HashMap<>();
                item.put("name", entry.getKey());
                item.put("value", entry.getValue());
                chartData.add(item);
            }
            
            Map<String, Object> result = new HashMap<>();
            result.put("distribution", distribution);
            result.put("chartData", chartData);
            result.put("total", 126);
            result.put("period", period);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–è®¢å•ç±»å‹åˆ†å¸ƒæ•°æ®å¤±è´¥", e);
            return R.error("è·å–åˆ†å¸ƒæ•°æ®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–æ”¶å…¥åˆ†ææ•°æ®
     */
    @GetMapping("/income-analysis")
    @ApiOperation("è·å–æ”¶å…¥åˆ†ææ•°æ®")
    public R<Map<String, Object>> getIncomeAnalysis(
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿæ”¶å…¥åˆ†ææ•°æ®
            Map<String, Object> incomeAnalysis = new HashMap<>();
            incomeAnalysis.put("totalIncome", 1260.50);
            incomeAnalysis.put("avgIncomePerOrder", 10.0);
            incomeAnalysis.put("avgIncomePerHour", 15.0);
            incomeAnalysis.put("maxDailyIncome", 250.30);
            incomeAnalysis.put("minDailyIncome", 150.50);
            
            // æ—¶æ®µæ”¶å…¥åˆ†å¸ƒ
            Map<String, Double> timeDistribution = new HashMap<>();
            timeDistribution.put("æ—©é¤(6-10ç‚?", 180.50);
            timeDistribution.put("åˆé¤(11-14ç‚?", 420.80);
            timeDistribution.put("ä¸‹åˆèŒ?15-17ç‚?", 150.20);
            timeDistribution.put("æ™šé¤(18-21ç‚?", 380.50);
            timeDistribution.put("å¤œå®µ(22-24ç‚?", 128.50);
            
            incomeAnalysis.put("timeDistribution", timeDistribution);
            
            // æ”¶å…¥è¶‹åŠ¿
            List<Map<String, Object>> incomeTrend = new ArrayList<>();
            String[] dates = {"11-07", "11-08", "11-09", "11-10", "11-11", "11-12", "11-13"};
            double[] incomes = {150.5, 180.8, 220.2, 190.5, 250.3, 200.8, 156.8};
            
            for (int i = 0; i < dates.length; i++) {
                Map<String, Object> data = new HashMap<>();
                data.put("date", dates[i]);
                data.put("income", incomes[i]);
                incomeTrend.add(data);
            }
            
            incomeAnalysis.put("incomeTrend", incomeTrend);
            incomeAnalysis.put("period", period);
            
            return R.success(incomeAnalysis);
        } catch (Exception e) {
            log.error("è·å–æ”¶å…¥åˆ†ææ•°æ®å¤±è´¥", e);
            return R.error("è·å–æ”¶å…¥åˆ†æå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–æ—¶æ®µé…é€åˆ†å¸ƒæ•°æ?     */
    @GetMapping("/time-distribution")
    @ApiOperation("è·å–æ—¶æ®µé…é€åˆ†å¸ƒæ•°æ?)
    public R<Map<String, Object>> getTimeDistribution(
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿæ—¶æ®µé…é€åˆ†å¸ƒæ•°æ?            Map<String, Integer> timeDistribution = new HashMap<>();
            timeDistribution.put("6-8ç‚?, 8);
            timeDistribution.put("8-10ç‚?, 12);
            timeDistribution.put("10-12ç‚?, 18);
            timeDistribution.put("12-14ç‚?, 25);
            timeDistribution.put("14-16ç‚?, 15);
            timeDistribution.put("16-18ç‚?, 20);
            timeDistribution.put("18-20ç‚?, 22);
            timeDistribution.put("20-22ç‚?, 6);
            
            // è½¬æ¢ä¸ºå›¾è¡¨æ•°æ®æ ¼å¼?            List<Map<String, Object>> chartData = new ArrayList<>();
            for (Map.Entry<String, Integer> entry : timeDistribution.entrySet()) {
                Map<String, Object> item = new HashMap<>();
                item.put("timeSlot", entry.getKey());
                item.put("count", entry.getValue());
                item.put("percentage", Math.round(entry.getValue() * 100.0 / 126));
                chartData.add(item);
            }
            
            Map<String, Object> result = new HashMap<>();
            result.put("timeDistribution", timeDistribution);
            result.put("chartData", chartData);
            result.put("peakHours", "12-14ç‚? 16-18ç‚? 18-20ç‚?);
            result.put("period", period);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–æ—¶æ®µé…é€åˆ†å¸ƒæ•°æ®å¤±è´?, e);
            return R.error("è·å–æ—¶æ®µåˆ†å¸ƒå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–è¯¦ç»†æ•°æ®è¡¨æ ¼
     */
    @GetMapping("/detailed-data")
    @ApiOperation("è·å–è¯¦ç»†æ•°æ®è¡¨æ ¼")
    public R<Map<String, Object>> getDetailedData(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer size,
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            // æ¨¡æ‹Ÿè¯¦ç»†æ•°æ®
            List<Map<String, Object>> detailedData = new ArrayList<>();
            
            for (int i = 0; i < 50; i++) {
                Map<String, Object> data = new HashMap<>();
                data.put("id", "D" + (1000 + i));
                data.put("date", "2025-11-" + String.format("%02d", 7 + i/7));
                data.put("orderNo", "ORD" + (10000 + i));
                data.put("type", i % 3 == 0 ? "å¤–å–é…é€? : (i % 3 == 1 ? "å–å¿«é€? : "ä»£è´­å•†å“"));
                data.put("pickupAddress", "é»‘ç§‘é¤å…");
                data.put("deliveryAddress", "å­¦ç”Ÿå…¬å¯“Aæ ? + (i % 5 + 1) + "å®?);
                data.put("distance", 0.8 + i * 0.1);
                data.put("fee", 3.0 + i * 0.2);
                data.put("deliveryTime", 15 + i % 10);
                data.put("rating", 4.5 + (i % 10) * 0.05);
                data.put("status", "å·²å®Œæˆ?);
                detailedData.add(data);
            }
            
            // åˆ†é¡µ
            int total = detailedData.size();
            int start = (page - 1) * size;
            int end = Math.min(start + size, total);
            List<Map<String, Object>> pageData = detailedData.subList(start, end);
            
            Map<String, Object> result = new HashMap<>();
            result.put("data", pageData);
            result.put("total", total);
            result.put("page", page);
            result.put("size", size);
            result.put("period", period);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–è¯¦ç»†æ•°æ®å¤±è´¥", e);
            return R.error("è·å–è¯¦ç»†æ•°æ®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å¯¼å‡ºæŠ¥è¡¨
     */
    @PostMapping("/export")
    @ApiOperation("å¯¼å‡ºæŠ¥è¡¨")
    public R<Map<String, Object>> exportReport(
            @RequestParam String format, // excel, pdf
            @RequestParam(defaultValue = "7d") String period,
            HttpServletRequest request) {
        try {
            Long courierId = getCourierId(request);
            
            log.info("éª‘æ‰‹ {} å¯¼å‡ºæŠ¥è¡¨ï¼Œæ ¼å¼? {}, å‘¨æœŸ: {}", courierId, format, period);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "æŠ¥è¡¨å¯¼å‡ºæˆåŠŸ");
            result.put("downloadUrl", "/api/courier/statistics/download/" + courierId + "_" + period + "." + format);
            result.put("expireTime", new Date(System.currentTimeMillis() + 24 * 60 * 60 * 1000)); // 24å°æ—¶åè¿‡æœ?            
            return R.success(result);
        } catch (Exception e) {
            log.error("å¯¼å‡ºæŠ¥è¡¨å¤±è´¥", e);
            return R.error("å¯¼å‡ºæŠ¥è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * ä»è¯·æ±‚ä¸­è·å–éª‘æ‰‹IDï¼ˆæ¨¡æ‹Ÿå®ç°ï¼‰
     */
    private Long getCourierId(HttpServletRequest request) {
        String courierIdStr = request.getHeader("X-Courier-Id");
        if (courierIdStr != null) {
            try {
                return Long.parseLong(courierIdStr);
            } catch (NumberFormatException e) {
                log.warn("æ— æ•ˆçš„éª‘æ‰‹ID: {}", courierIdStr);
            }
        }
        // é»˜è®¤è¿”å›æµ‹è¯•éª‘æ‰‹ID
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.app.entity.DeliveryLocker;
import org.springframework.web.bind.annotation.*;
import jakarta.validation.Valid;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * å¤–å–æŸœæ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/app/delivery-locker")
public class DeliveryLockerController {

    // æ¨¡æ‹Ÿå¤–å–æŸœæ•°æ?    private final Map<String, DeliveryLocker> mockLockerData = new HashMap<>();

    /**
     * è·å–æ‰€æœ‰å¯ç”¨å¤–å–æŸœ
     */
    @GetMapping("/list")
    public R<List<DeliveryLocker>> getAvailableLockers() {
        // æ¨¡æ‹Ÿå®ç°
        List<DeliveryLocker> lockers = new ArrayList<>();
        
        // æ·»åŠ æ¨¡æ‹Ÿæ•°æ®
        for (int i = 1; i <= 3; i++) {
            DeliveryLocker locker = new DeliveryLocker();
            locker.setId((long)i);
            locker.setLockerCode("LOCKER" + i);
            locker.setLocation("ä½ç½®" + i);
            locker.setStatus(1); // å¯ç”¨çŠ¶æ€?            lockers.add(locker);
            mockLockerData.put("LOCKER" + i, locker);
        }
        
        return R.success(lockers);
    }

    /**
     * æ ¹æ®ç¼–ç æŸ¥è¯¢å¤–å–æŸ?     */
    @GetMapping("/{lockerCode}")
    public R<DeliveryLocker> getLocker(@PathVariable String lockerCode) {
        // æ¨¡æ‹Ÿå®ç°
        DeliveryLocker locker = mockLockerData.get(lockerCode);
        if (locker == null) {
            locker = new DeliveryLocker();
            locker.setLockerCode(lockerCode);
            locker.setLocation("é»˜è®¤ä½ç½®");
            locker.setStatus(1);
            mockLockerData.put(lockerCode, locker);
        }
        return R.success(locker);
    }

    /** æ–°å¢å¤–å–æŸ?*/
    @PostMapping("/create")
    public R<Boolean> create(@Valid @RequestBody DeliveryLocker locker) {
        // æ¨¡æ‹Ÿå®ç°
        if (locker != null && locker.getLockerCode() != null) {
            mockLockerData.put(locker.getLockerCode(), locker);
            return R.success(true);
        }
        return R.error("æ–°å¢å¤±è´¥");
    }

    /** ç¼–è¾‘å¤–å–æŸ?*/
    @PostMapping("/update")
    public R<Boolean> update(@Valid @RequestBody DeliveryLocker locker) {
        // æ¨¡æ‹Ÿå®ç°
        if (locker != null && locker.getLockerCode() != null) {
            mockLockerData.put(locker.getLockerCode(), locker);
            return R.success(true);
        }
        return R.error("æ›´æ–°å¤±è´¥");
    }
}


package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.Map;

/**
 * å¥åº·æ£€æŸ¥æ§åˆ¶å™¨
 * ç”¨äºéªŒè¯åº”ç”¨è¿è¡ŒçŠ¶æ€å’Œæ•°æ®åº“è¿æ? */
@RestController
@RequestMapping("/health")
public class HealthController {

    private static final Logger log = LoggerFactory.getLogger(HealthController.class);

    @Autowired(required = false)
    private JdbcTemplate jdbcTemplate;

    /**
     * ç®€å•å¥åº·æ£€æŸ¥ï¼Œä¸æ£€æŸ¥æ•°æ®åº“
     */
    @GetMapping("/ping")
    public R<String> ping() {
        log.info("Health check ping called");
        return R.success("pong");
    }

    /**
     * æ•°æ®åº“è¿æ¥æ£€æŸ?     */
    @GetMapping("/db")
    public R<Map<String, Object>> checkDatabase() {
        log.info("Database health check called");
        Map<String, Object> result = new HashMap<>();
        
        try {
            if (jdbcTemplate == null) {
                result.put("status", "error");
                result.put("message", "JdbcTemplate not available");
                return R.success(result);
            }
            
            // æ‰§è¡Œç®€å•çš„SQLæŸ¥è¯¢éªŒè¯æ•°æ®åº“è¿æ?            String sql = "SELECT 1 FROM DUAL";
            Integer testResult = jdbcTemplate.queryForObject(sql, Integer.class);
            
            result.put("status", "success");
            result.put("message", "Database connection successful");
            result.put("testResult", testResult);
            
        } catch (Exception e) {
            log.error("Database connection failed", e);
            result.put("status", "error");
            result.put("message", "Database connection failed: " + e.getMessage());
        }
        
        return R.success(result);
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import java.util.HashMap;
import java.util.Map;
import java.util.ArrayList;
import java.util.List;

/**
 * é¦–é¡µæ§åˆ¶å™? * è´Ÿè´£å¤„ç†é¦–é¡µç›¸å…³çš„è¯·æ±? */
@Controller
@RequestMapping("/app")
public class IndexController {

    // ç§»é™¤ProductServiceä¾èµ–

    /**
     * è·³è½¬é¦–é¡µ
     */
    @GetMapping("/index")
    public String index() {
        return "index";
    }

    /**
     * è·å–é¦–é¡µæ•°æ®
     * åŒ…æ‹¬çƒ­é—¨æ¨èå•†å“å’Œæ–°å“ä¸Šæ¶å•†å“?     */
    @GetMapping("/index/data")
    @ResponseBody
    public R<Map<String, Object>> getIndexData() {
        try {
            // æ¨¡æ‹Ÿå®ç°
            Map<String, Object> data = new HashMap<>();
            
            // æ¨¡æ‹Ÿçƒ­é—¨å•†å“æ•°æ®
            List<Map<String, Object>> hotProducts = new ArrayList<>();
            for (int i = 1; i <= 8; i++) {
                Map<String, Object> product = new HashMap<>();
                product.put("id", (long)i);
                product.put("name", "çƒ­é—¨å•†å“" + i);
                product.put("price", 99.99 + i);
                product.put("image", "/images/product" + i + ".jpg");
                product.put("sales", 1000 + i * 100);
                hotProducts.add(product);
            }
            
            // æ¨¡æ‹Ÿæ–°å“ä¸Šæ¶æ•°æ®
            List<Map<String, Object>> newProducts = new ArrayList<>();
            for (int i = 1; i <= 6; i++) {
                Map<String, Object> product = new HashMap<>();
                product.put("id", (long)(i + 100));
                product.put("name", "æ–°å“" + i);
                product.put("price", 199.99 + i);
                product.put("image", "/images/new-product" + i + ".jpg");
                product.put("createTime", "2024-11-10");
                newProducts.add(product);
            }
            
            data.put("hotProducts", hotProducts);
            data.put("newProducts", newProducts);
            data.put("bannerImages", new String[]{"/images/banner1.jpg", "/images/banner2.jpg", "/images/banner3.jpg"});
            
            return R.success(data);
        } catch (Exception e) {
            e.printStackTrace();
            return R.error("è·å–é¦–é¡µæ•°æ®å¤±è´¥");
        }
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * å•†å®¶ç«¯æ§åˆ¶å™¨
 * å¤„ç†å•†å®¶ç«¯ä»ªè¡¨æ¿ç›¸å…³è¯·æ±‚
 */
@RestController
@RequestMapping("/merchant")
@Api(tags = "å•†å®¶ç«¯ç®¡ç?)
public class MerchantController {

    private static final Logger log = LoggerFactory.getLogger(MerchantController.class);

    /**
     * è·å–å•†å®¶ä»ªè¡¨æ¿æ•°æ?     */
    @GetMapping("/dashboard")
    @ApiOperation("è·å–å•†å®¶ä»ªè¡¨æ¿æ•°æ?)
    public R<Map<String, Object>> getDashboardData(HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            // æ¨¡æ‹Ÿå•†å®¶ä¿¡æ¯
            Map<String, Object> merchantInfo = new HashMap<>();
            merchantInfo.put("id", merchantId);
            merchantInfo.put("name", "é»‘ç§‘é¤å…");
            merchantInfo.put("type", "ä¸­å¼å¿«é¤");
            merchantInfo.put("status", "è¥ä¸šä¸?);
            merchantInfo.put("avatar", "/images/merchant-avatar.jpg");
            merchantInfo.put("lastUpdate", "2025-11-13 16:30:00");
            
            // æ¨¡æ‹Ÿä»Šæ—¥ç»Ÿè®¡æ•°æ®
            Map<String, Object> todayStats = new HashMap<>();
            todayStats.put("revenue", 2580.50);
            todayStats.put("orders", 45);
            todayStats.put("rating", 4.8);
            todayStats.put("visitors", 128);
            
            // æ¨¡æ‹Ÿè¥æ”¶è¶‹åŠ¿æ•°æ®
            List<Map<String, Object>> revenueTrend = new ArrayList<>();
            String[] dates = {"11-07", "11-08", "11-09", "11-10", "11-11", "11-12", "11-13"};
            double[] revenues = {1200.5, 1450.8, 1680.2, 1920.5, 2100.3, 2350.8, 2580.5};
            for (int i = 0; i < dates.length; i++) {
                Map<String, Object> data = new HashMap<>();
                data.put("date", dates[i]);
                data.put("revenue", revenues[i]);
                revenueTrend.add(data);
            }
            
            // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€åˆ†å¸?            Map<String, Integer> orderStats = new HashMap<>();
            orderStats.put("å¾…æ¥å?, 5);
            orderStats.put("åˆ¶ä½œä¸?, 8);
            orderStats.put("å¾…é…é€?, 12);
            orderStats.put("å·²å®Œæˆ?, 85);
            orderStats.put("å·²å–æ¶?, 2);
            
            // æ¨¡æ‹Ÿæœ€è¿‘è®¢å?            List<Map<String, Object>> recentOrders = new ArrayList<>();
            for (int i = 0; i < 5; i++) {
                Map<String, Object> order = new HashMap<>();
                order.put("id", "ORD" + System.currentTimeMillis() + i);
                order.put("orderNo", "ORD" + System.currentTimeMillis() + i);
                order.put("createTime", "2025-11-13 " + String.format("%02d:%02d", 16 - i, 30 - i * 5));
                order.put("customerName", "ç”¨æˆ·" + (i + 1));
                order.put("customerPhone", "138****" + String.format("%04d", 1000 + i));
                order.put("amount", 25.8 + i * 5);
                order.put("status", i < 2 ? "å¾…æ¥å? : "åˆ¶ä½œä¸?);
                order.put("payType", "å¾®ä¿¡æ”¯ä»˜");
                
                List<Map<String, Object>> items = new ArrayList<>();
                for (int j = 0; j < 2; j++) {
                    Map<String, Object> item = new HashMap<>();
                    item.put("name", "èœå“" + (j + 1));
                    item.put("quantity", j + 1);
                    items.add(item);
                }
                order.put("items", items);
                
                recentOrders.add(order);
            }
            
            // æ„å»ºè¿”å›æ•°æ®
            Map<String, Object> result = new HashMap<>();
            result.put("merchantInfo", merchantInfo);
            result.put("todayStats", todayStats);
            result.put("revenueTrend", revenueTrend);
            result.put("orderStats", orderStats);
            result.put("recentOrders", recentOrders);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–å•†å®¶ä»ªè¡¨æ¿æ•°æ®å¤±è´?, e);
            return R.error("è·å–æ•°æ®å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–å•†å®¶åŸºç¡€ä¿¡æ¯
     */
    @GetMapping("/info")
    @ApiOperation("è·å–å•†å®¶åŸºç¡€ä¿¡æ¯")
    public R<Map<String, Object>> getMerchantInfo(HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            Map<String, Object> merchantInfo = new HashMap<>();
            merchantInfo.put("id", merchantId);
            merchantInfo.put("name", "é»‘ç§‘é¤å…");
            merchantInfo.put("type", "ä¸­å¼å¿«é¤");
            merchantInfo.put("description", "æä¾›æ­£å®—ä¸­å¼å¿«é¤ï¼Œç¾å‘³å¥åº?);
            merchantInfo.put("phone", "138****8888");
            merchantInfo.put("address", "é»‘ç§‘æŠ€å¤§å­¦å­¦ç”Ÿé£Ÿå ‚2æ¥?);
            merchantInfo.put("longitude", 116.307484);
            merchantInfo.put("latitude", 39.904026);
            merchantInfo.put("avatar", "/images/merchant-avatar.jpg");
            merchantInfo.put("cover", "/images/merchant-cover.jpg");
            merchantInfo.put("businessHours", Arrays.asList("08:00", "22:00"));
            merchantInfo.put("deliveryMethods", Arrays.asList("å¤–å–é…é€?, "åˆ°åº—è‡ªå–"));
            merchantInfo.put("deliveryFee", 2.5);
            merchantInfo.put("minOrderAmount", 20.0);
            merchantInfo.put("deliveryDistance", 3.0);
            merchantInfo.put("estimatedDeliveryTime", 30);
            merchantInfo.put("status", "è¥ä¸šä¸?);
            merchantInfo.put("rating", 4.8);
            merchantInfo.put("totalOrders", 1234);
            merchantInfo.put("totalRevenue", 45680.5);
            
            return R.success(merchantInfo);
        } catch (Exception e) {
            log.error("è·å–å•†å®¶ä¿¡æ¯å¤±è´¥", e);
            return R.error("è·å–ä¿¡æ¯å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°å•†å®¶è¥ä¸šçŠ¶æ€?     */
    @PostMapping("/status")
    @ApiOperation("æ›´æ–°å•†å®¶è¥ä¸šçŠ¶æ€?)
    public R<Map<String, Object>> updateBusinessStatus(@RequestParam String status, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ›´æ–°è¥ä¸šçŠ¶æ€ä¸º: {}", merchantId, status);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "è¥ä¸šçŠ¶æ€æ›´æ–°æˆåŠ?);
            result.put("status", status);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ›´æ–°è¥ä¸šçŠ¶æ€å¤±è´?, e);
            return R.error("æ›´æ–°å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–å•†å®¶ç»Ÿè®¡æŠ¥è¡¨
     */
    @GetMapping("/statistics")
    @ApiOperation("è·å–å•†å®¶ç»Ÿè®¡æŠ¥è¡¨")
    public R<Map<String, Object>> getStatistics(
            @RequestParam String period,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            Map<String, Object> statistics = new HashMap<>();
            
            // æ ¹æ®æ—¶é—´æ®µç”Ÿæˆä¸åŒæ•°æ?            switch (period) {
                case "7d":
                    statistics.put("totalRevenue", 15800.5);
                    statistics.put("totalOrders", 298);
                    statistics.put("avgOrderValue", 53.02);
                    statistics.put("customerCount", 156);
                    break;
                case "30d":
                    statistics.put("totalRevenue", 68920.8);
                    statistics.put("totalOrders", 1298);
                    statistics.put("avgOrderValue", 53.12);
                    statistics.put("customerCount", 687);
                    break;
                case "90d":
                    statistics.put("totalRevenue", 198750.3);
                    statistics.put("totalOrders", 3756);
                    statistics.put("avgOrderValue", 52.91);
                    statistics.put("customerCount", 1987);
                    break;
                default:
                    statistics.put("totalRevenue", 2580.5);
                    statistics.put("totalOrders", 45);
                    statistics.put("avgOrderValue", 57.34);
                    statistics.put("customerCount", 38);
            }
            
            // æ¨¡æ‹Ÿè¶‹åŠ¿æ•°æ®
            List<Map<String, Object>> trendData = new ArrayList<>();
            for (int i = 0; i < 7; i++) {
                Map<String, Object> data = new HashMap<>();
                data.put("date", "2025-11-" + (7 + i));
                data.put("revenue", 1500 + i * 200 + Math.random() * 500);
                data.put("orders", 30 + i * 5 + (int)(Math.random() * 10));
                trendData.add(data);
            }
            statistics.put("trendData", trendData);
            
            return R.success(statistics);
        } catch (Exception e) {
            log.error("è·å–ç»Ÿè®¡æŠ¥è¡¨å¤±è´¥", e);
            return R.error("è·å–æŠ¥è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–å•†å®¶IDï¼ˆæ¨¡æ‹Ÿä»tokenä¸­è§£æï¼‰
     */
    private Long getMerchantId(HttpServletRequest request) {
        // è¿™é‡Œåº”è¯¥ä»JWT tokenæˆ–sessionä¸­è·å–å®é™…çš„å•†å®¶ID
        // æ¨¡æ‹Ÿè¿”å›å›ºå®šå•†å®¶ID
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * å•†å®¶ç«¯è®¢å•æ§åˆ¶å™¨
 * å¤„ç†å•†å®¶ç«¯è®¢å•ç®¡ç†ç›¸å…³è¯·æ±? */
@RestController
@RequestMapping("/merchant/orders")
@Api(tags = "å•†å®¶è®¢å•ç®¡ç†")
public class MerchantOrderController {

    private static final Logger log = LoggerFactory.getLogger(MerchantOrderController.class);

    // æ¨¡æ‹Ÿè®¢å•æ•°æ®
    private List<Map<String, Object>> mockOrders = new ArrayList<>();

    public MerchantOrderController() {
        initMockData();
    }

    /**
     * åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ?     */
    private void initMockData() {
        String[] statuses = {"å¾…æ¥å?, "åˆ¶ä½œä¸?, "å·²å®Œæˆåˆ¶ä½?, "é…é€ä¸­", "å·²å®Œæˆ?, "å·²å–æ¶?};
        String[] payTypes = {"å¾®ä¿¡æ”¯ä»˜", "æ”¯ä»˜å®?, "ç°é‡‘"};
        
        for (int i = 0; i < 100; i++) {
            Map<String, Object> order = new HashMap<>();
            order.put("id", "ORD" + System.currentTimeMillis() + i);
            order.put("orderNo", "ORD" + System.currentTimeMillis() + i);
            order.put("createTime", "2025-11-13 " + String.format("%02d:%02d:%02d", 16 - i/10, (i*7)%60, (i*13)%60));
            order.put("customerName", "ç”¨æˆ·" + (i + 1));
            order.put("customerPhone", "138****" + String.format("%04d", 1000 + i));
            order.put("amount", 25.8 + (i % 30) * 2.5);
            order.put("status", statuses[i % statuses.length]);
            order.put("payType", payTypes[i % payTypes.length]);
            
            List<Map<String, Object>> items = new ArrayList<>();
            for (int j = 0; j < 2; j++) {
                Map<String, Object> item = new HashMap<>();
                item.put("name", "èœå“" + ((i + j) % 10 + 1));
                item.put("quantity", (j + 1));
                items.add(item);
            }
            order.put("items", items);
            order.put("deliveryAddress", "é»‘ç§‘æŠ€å¤§å­¦" + ((i % 5) + 1) + "å·æ¥¼");
            order.put("deliveryTime", "é¢„è®¡" + (30 + i % 20) + "åˆ†é’Ÿé€è¾¾");
            
            mockOrders.add(order);
        }
    }

    /**
     * è·å–å•†å®¶è®¢å•åˆ—è¡¨
     */
    @GetMapping
    @ApiOperation("è·å–å•†å®¶è®¢å•åˆ—è¡¨")
    public R<Map<String, Object>> getOrders(
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String orderNo,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer limit,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            // ç­›é€‰è®¢å?            List<Map<String, Object>> filteredOrders = new ArrayList<>(mockOrders);
            
            if (status != null && !status.isEmpty()) {
                filteredOrders.removeIf(order -> !order.get("status").equals(status));
            }
            
            if (orderNo != null && !orderNo.isEmpty()) {
                filteredOrders.removeIf(order -> !order.get("orderNo").toString().contains(orderNo));
            }
            
            // åˆ†é¡µ
            int start = (page - 1) * limit;
            int end = Math.min(start + limit, filteredOrders.size());
            List<Map<String, Object>> pageOrders = start < end ? filteredOrders.subList(start, end) : new ArrayList<>();
            
            // ç»Ÿè®¡è®¢å•çŠ¶æ€?            Map<String, Integer> orderStats = calculateOrderStats(filteredOrders);
            
            // è®¡ç®—æ€»æ”¶å…?            double totalRevenue = filteredOrders.stream()
                .filter(order -> "å·²å®Œæˆ?.equals(order.get("status")))
                .mapToDouble(order -> Double.parseDouble(order.get("amount").toString()))
                .sum();
            
            Map<String, Object> result = new HashMap<>();
            result.put("orders", pageOrders);
            result.put("total", filteredOrders.size());
            result.put("page", page);
            result.put("limit", limit);
            result.put("orderStats", orderStats);
            result.put("totalRevenue", String.format("%.2f", totalRevenue));
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–è®¢å•åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–è®¢å•åˆ—è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ¥å•æ“ä½œ
     */
    @PostMapping("/accept/{orderNo}")
    @ApiOperation("æ¥å•")
    public R<Map<String, Object>> acceptOrder(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ¥æ”¶è®¢å• {}", merchantId, orderNo);
            
            // æ¨¡æ‹Ÿæ¥å•æˆåŠŸ
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "æ¥å•æˆåŠŸ");
            result.put("orderNo", orderNo);
            result.put("newStatus", "åˆ¶ä½œä¸?);
            result.put("estimatedTime", "20åˆ†é’Ÿ");
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ¥å•å¤±è´¥", e);
            return R.error("æ¥å•å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°è®¢å•çŠ¶æ€?     */
    @PostMapping("/status")
    @ApiOperation("æ›´æ–°è®¢å•çŠ¶æ€?)
    public R<Map<String, Object>> updateOrderStatus(
            @RequestParam String orderNo,
            @RequestParam String status,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ›´æ–°è®¢å• {} çŠ¶æ€ä¸º {}", merchantId, orderNo, status);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "è®¢å•çŠ¶æ€æ›´æ–°æˆåŠ?);
            result.put("orderNo", orderNo);
            result.put("newStatus", status);
            result.put("updateTime", new Date());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ›´æ–°è®¢å•çŠ¶æ€å¤±è´?, e);
            return R.error("æ›´æ–°å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/cancel/{orderNo}")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Map<String, Object>> cancelOrder(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} å–æ¶ˆè®¢å• {}", merchantId, orderNo);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "è®¢å•å–æ¶ˆæˆåŠŸ");
            result.put("orderNo", orderNo);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("å–æ¶ˆè®¢å•å¤±è´¥", e);
            return R.error("å–æ¶ˆå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/detail/{orderNo}")
    @ApiOperation("è·å–è®¢å•è¯¦æƒ…")
    public R<Map<String, Object>> getOrderDetail(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            // æ¨¡æ‹ŸæŸ¥æ‰¾è®¢å•è¯¦æƒ…
            Map<String, Object> orderDetail = mockOrders.stream()
                .filter(order -> order.get("orderNo").equals(orderNo))
                .findFirst()
                .orElse(null);
            
            if (orderDetail == null) {
                return R.error("è®¢å•ä¸å­˜åœ?);
            }
            
            return R.success(orderDetail);
        } catch (Exception e) {
            log.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–è¯¦æƒ…å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ‰¹é‡æ“ä½œè®¢å•
     */
    @PostMapping("/batch")
    @ApiOperation("æ‰¹é‡æ“ä½œè®¢å•")
    public R<Map<String, Object>> batchOperateOrders(
            @RequestParam List<String> orderNos,
            @RequestParam String operation,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ‰¹é‡æ“ä½œè®¢å•: {}ï¼Œæ“ä½? {}", merchantId, orderNos, operation);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "æ‰¹é‡æ“ä½œæˆåŠŸ");
            result.put("processedCount", orderNos.size());
            result.put("operation", operation);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ‰¹é‡æ“ä½œè®¢å•å¤±è´¥", e);
            return R.error("æ“ä½œå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å¯¼å‡ºè®¢å•æ•°æ®
     */
    @GetMapping("/export")
    @ApiOperation("å¯¼å‡ºè®¢å•æ•°æ®")
    public R<Map<String, Object>> exportOrders(
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} å¯¼å‡ºè®¢å•æ•°æ®", merchantId);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "è®¢å•æ•°æ®å¯¼å‡ºæˆåŠŸ");
            result.put("downloadUrl", "/api/merchant/orders/download/excel");
            result.put("exportTime", new Date());
            result.put("totalRecords", mockOrders.size());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("å¯¼å‡ºè®¢å•å¤±è´¥", e);
            return R.error("å¯¼å‡ºå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è®¡ç®—è®¢å•ç»Ÿè®¡
     */
    private Map<String, Integer> calculateOrderStats(List<Map<String, Object>> orders) {
        Map<String, Integer> stats = new HashMap<>();
        
        for (String status : new String[]{"å¾…æ¥å?, "åˆ¶ä½œä¸?, "å·²å®Œæˆåˆ¶ä½?, "é…é€ä¸­", "å·²å®Œæˆ?, "å·²å–æ¶?}) {
            stats.put(status, (int) orders.stream().filter(order -> order.get("status").equals(status)).count());
        }
        
        stats.put("æ€»è®¢å?, orders.size());
        
        return stats;
    }

    /**
     * è·å–å•†å®¶ID
     */
    private Long getMerchantId(HttpServletRequest request) {
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * å•†å®¶ç«¯å•†å“æ§åˆ¶å™¨
 * å¤„ç†å•†å®¶ç«¯å•†å“ç®¡ç†ç›¸å…³è¯·æ±? */
@RestController
@RequestMapping("/merchant/products")
@Api(tags = "å•†å®¶å•†å“ç®¡ç†")
public class MerchantProductController {

    private static final Logger log = LoggerFactory.getLogger(MerchantProductController.class);

    // æ¨¡æ‹Ÿå•†å“æ•°æ®
    private List<Map<String, Object>> mockProducts = new ArrayList<>();

    public MerchantProductController() {
        initMockData();
    }

    /**
     * åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ?     */
    private void initMockData() {
        String[] categories = {"ä¸»é£Ÿ", "å°åƒ", "é¥®å“", "æ±¤å“", "ç”œç‚¹", "å‡‰èœ", "çƒ­èœ", "çƒ§çƒ¤"};
        String[] statuses = {"åœ¨å”®", "ä¸‹æ¶", "å”®ç½„"};
        
        for (int i = 0; i < 50; i++) {
            Map<String, Object> product = new HashMap<>();
            product.put("id", "P" + (i + 1));
            product.put("name", getProductName(i));
            product.put("category", categories[i % categories.length]);
            product.put("price", 15.8 + (i % 20) * 2.5);
            product.put("originalPrice", 18.8 + (i % 20) * 2.5);
            product.put("sales", (i + 1) * 5);
            product.put("stock", (i + 1) * 10);
            product.put("status", statuses[i % statuses.length]);
            product.put("image", "https://via.placeholder.com/150x150?text=Product+" + (i + 1));
            product.put("createTime", "2025-11-12 " + String.format("%02d:%02d:%02d", 16 - i/10, (i*7)%60, (i*13)%60));
            
            Map<String, Object> nutrition = new HashMap<>();
            nutrition.put("calories", (300 + i * 20) + "kcal");
            nutrition.put("protein", String.format("%.1f", 8.5 + i * 0.5) + "g");
            nutrition.put("carbs", String.format("%.1f", 25.0 + i * 1.2) + "g");
            nutrition.put("fat", String.format("%.1f", 12.0 + i * 0.8) + "g");
            product.put("nutrition", nutrition);
            
            product.put("description", getProductDescription(i));
            product.put("specifications", "è§„æ ¼ï¼?ä»½ï¼Œ" + (300 + i * 10) + "g");
            
            mockProducts.add(product);
        }
    }

    /**
     * è·å–å•†å“åç§°
     */
    private String getProductName(int i) {
        String[] names = {
            "å®«ä¿é¸¡ä¸", "é±¼é¦™è‚‰ä¸", "éº»å©†è±†è…", "çº¢çƒ§è‚?, "ç³–é†‹é‡Œè„Š", "æ¸…è’¸é²ˆé±¼", "æ°´ç…®é±?, "ä¸œå¡è‚?,
            "å›é”…è‚?, "é’æ¤’è‚‰ä¸", "è’œè‹”è‚‰ä¸", "é’æ¤’åœŸè±†ä¸?, "é†‹æºœç™½èœ", "é…¸è¾£åœŸè±†ä¸?, "å‡‰æ‹Œé»„ç“œ",
            "è¥¿çº¢æŸ¿é¸¡è›?, "ç´«èœè›‹èŠ±æ±?, "é…¸è¾£æ±?, "çš®è›‹ç˜¦è‚‰ç²?, "å°ç¬¼åŒ?, "è’¸é¥º", "ç…é¥º", "ç‚¸é…±é?,
            "ç‰›è‚‰é?, "ç‚¸é¸¡æ?, "è–¯æ¡", "æ±‰å ¡åŒ?, "é¸¡è…¿å ?, "é¸¡ç¿…", "é¸¡ç±³èŠ?, "å¯ä¹", "æ©™æ±", "æŸ æª¬èŒ?,
            "æŸ æª¬èœ‚èœœèŒ?, "å’–å•¡", "å¥¶èŒ¶", "çç å¥¶èŒ¶", "çº¢è±†å†?, "ç»¿è±†æ±?, "é“¶è€³è²å­æ±¤", "åŒçš®å¥?,
            "å¸ƒä¸", "è›‹ç³•", "é¥¼å¹²", "é¢åŒ…", "åšæœ", "ç‰›è‚‰å¹?, "è¾£æ¡", "è–¯ç‰‡", "èŠ±ç”Ÿ", "ç“œå­"
        };
        return names[i % names.length];
    }

    /**
     * è·å–å•†å“æè¿°
     */
    private String getProductDescription(int i) {
        String[] descriptions = {
            "ç²¾é€‰ä¼˜è´¨é£Ÿæï¼Œçƒ¹é¥ªç²¾ç»†ï¼Œè‰²æ³½è¯±äººï¼Œå£æ„Ÿä¸°å¯Œ",
            "ä¼ ç»Ÿå·¥è‰ºåˆ¶ä½œï¼Œä¿ç•™é£ŸæåŸæ±åŸå‘³ï¼Œè¥å…»ä¸°å¯Œ",
            "ç§˜åˆ¶è°ƒæ–™ï¼Œå£æ„Ÿå±‚æ¬¡ä¸°å¯Œï¼Œå›å‘³æ— ç©·",
            "æ–°é²œé‡‡è´­ï¼Œç°åšç°å–ï¼Œä¿è¯é£Ÿææ–°é²œåº?,
            "è¥å…»æ­é…åˆç†ï¼Œå¥åº·ç¾å‘³ï¼Œé€‚åˆå„ç±»äººç¾¤",
            "ç²¾å¿ƒè°ƒå‘³ï¼Œé¦™æ°”æ‰‘é¼»ï¼Œè®©æ‚¨æ¬²ç½¢ä¸èƒ½",
            "ä»½é‡å……è¶³ï¼Œç‰©ç¾ä»·å»‰ï¼Œæ˜¯æ‚¨ç”¨é¤çš„æœ€ä½³é€‰æ‹©",
            "é‡‡ç”¨ä¼ ç»Ÿé…æ–¹ï¼Œç»“åˆç°ä»£å·¥è‰ºï¼Œå£æ„Ÿæ›´ä½³",
            "å£æ„Ÿé²œç¾ï¼Œè¥å…»ä¸°å¯Œï¼Œæ˜¯æ‚¨ä¸å¯é”™è¿‡çš„ç¾å‘?,
            "ç²¾é€‰ä¸Šç­‰åŸæ–™ï¼Œåˆ¶ä½œå·¥è‰ºç²¾æ¹›ï¼Œå€¼å¾—å“å°"
        };
        return descriptions[i % descriptions.length];
    }

    /**
     * è·å–å•†å®¶å•†å“åˆ—è¡¨
     */
    @GetMapping
    @ApiOperation("è·å–å•†å®¶å•†å“åˆ—è¡¨")
    public R<Map<String, Object>> getProducts(
            @RequestParam(required = false) String category,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "é”€é‡?) String sort,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer limit,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            // ç­›é€‰å•†å“?            List<Map<String, Object>> filteredProducts = new ArrayList<>(mockProducts);
            
            if (category != null && !category.isEmpty()) {
                filteredProducts.removeIf(product -> !product.get("category").equals(category));
            }
            
            if (status != null && !status.isEmpty()) {
                filteredProducts.removeIf(product -> !product.get("status").equals(status));
            }
            
            if (keyword != null && !keyword.isEmpty()) {
                filteredProducts.removeIf(product -> 
                    !product.get("name").toString().contains(keyword)
                );
            }
            
            // æ’åº
            filteredProducts.sort((p1, p2) -> {
                switch (sort) {
                    case "é”€é‡?:
                        return Integer.compare(
                            Integer.parseInt(p2.get("sales").toString()),
                            Integer.parseInt(p1.get("sales").toString())
                        );
                    case "ä»·æ ¼-ä½åˆ°é«?:
                        return Double.compare(
                            Double.parseDouble(p1.get("price").toString()),
                            Double.parseDouble(p2.get("price").toString())
                        );
                    case "ä»·æ ¼-é«˜åˆ°ä½?:
                        return Double.compare(
                            Double.parseDouble(p2.get("price").toString()),
                            Double.parseDouble(p1.get("price").toString())
                        );
                    case "æ–°å“":
                        return p2.get("createTime").toString().compareTo(p1.get("createTime").toString());
                    default:
                        return 0;
                }
            });
            
            // åˆ†é¡µ
            int start = (page - 1) * limit;
            int end = Math.min(start + limit, filteredProducts.size());
            List<Map<String, Object>> pageProducts = start < end ? filteredProducts.subList(start, end) : new ArrayList<>();
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            Map<String, Object> statistics = calculateProductStatistics(filteredProducts);
            
            Map<String, Object> result = new HashMap<>();
            result.put("products", pageProducts);
            result.put("total", filteredProducts.size());
            result.put("page", page);
            result.put("limit", limit);
            result.put("categories", getAllCategories());
            result.put("statistics", statistics);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–å•†å“åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–å•†å“åˆ—è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–å•†å“è¯¦æƒ…
     */
    @GetMapping("/{productId}")
    @ApiOperation("è·å–å•†å“è¯¦æƒ…")
    public R<Map<String, Object>> getProductDetail(@PathVariable String productId, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            Map<String, Object> product = mockProducts.stream()
                .filter(p -> p.get("id").equals(productId))
                .findFirst()
                .orElse(null);
            
            if (product == null) {
                return R.error("å•†å“ä¸å­˜åœ?);
            }
            
            return R.success(product);
        } catch (Exception e) {
            log.error("è·å–å•†å“è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–è¯¦æƒ…å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ·»åŠ å•†å“
     */
    @PostMapping
    @ApiOperation("æ·»åŠ å•†å“")
    public R<Map<String, Object>> addProduct(@RequestBody Map<String, Object> product, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ·»åŠ å•†å“: {}", merchantId, product.get("name"));
            
            Map<String, Object> newProduct = new HashMap<>();
            newProduct.put("id", "P" + (mockProducts.size() + 1));
            newProduct.put("name", product.get("name"));
            newProduct.put("category", product.get("category"));
            newProduct.put("price", product.get("price"));
            newProduct.put("originalPrice", product.get("originalPrice"));
            newProduct.put("stock", product.get("stock"));
            newProduct.put("status", "åœ¨å”®");
            newProduct.put("image", product.get("image"));
            newProduct.put("createTime", new Date());
            newProduct.put("sales", 0);
            newProduct.put("description", product.get("description"));
            newProduct.put("specifications", product.get("specifications"));
            newProduct.put("nutrition", product.get("nutrition"));
            
            mockProducts.add(0, newProduct);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "å•†å“æ·»åŠ æˆåŠŸ");
            result.put("product", newProduct);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ·»åŠ å•†å“å¤±è´¥", e);
            return R.error("æ·»åŠ å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°å•†å“
     */
    @PutMapping("/{productId}")
    @ApiOperation("æ›´æ–°å•†å“")
    public R<Map<String, Object>> updateProduct(
            @PathVariable String productId,
            @RequestBody Map<String, Object> product,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ›´æ–°å•†å“ {}", merchantId, productId);
            
            Map<String, Object> existingProduct = mockProducts.stream()
                .filter(p -> p.get("id").equals(productId))
                .findFirst()
                .orElse(null);
            
            if (existingProduct == null) {
                return R.error("å•†å“ä¸å­˜åœ?);
            }
            
            // æ›´æ–°å•†å“ä¿¡æ¯
            existingProduct.putAll(product);
            existingProduct.put("updateTime", new Date());
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "å•†å“æ›´æ–°æˆåŠŸ");
            result.put("product", existingProduct);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ›´æ–°å•†å“å¤±è´¥", e);
            return R.error("æ›´æ–°å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * åˆ é™¤å•†å“
     */
    @DeleteMapping("/{productId}")
    @ApiOperation("åˆ é™¤å•†å“")
    public R<Map<String, Object>> deleteProduct(@PathVariable String productId, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} åˆ é™¤å•†å“ {}", merchantId, productId);
            
            boolean removed = mockProducts.removeIf(product -> product.get("id").equals(productId));
            
            if (!removed) {
                return R.error("å•†å“ä¸å­˜åœ?);
            }
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "å•†å“åˆ é™¤æˆåŠŸ");
            
            return R.success(result);
        } catch (Exception e) {
            log.error("åˆ é™¤å•†å“å¤±è´¥", e);
            return R.error("åˆ é™¤å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ‰¹é‡æ“ä½œå•†å“
     */
    @PostMapping("/batch")
    @ApiOperation("æ‰¹é‡æ“ä½œå•†å“")
    public R<Map<String, Object>> batchOperateProducts(
            @RequestParam List<String> productIds,
            @RequestParam String operation,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ‰¹é‡æ“ä½œå•†å“: {}ï¼Œæ“ä½? {}", merchantId, productIds, operation);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "æ‰¹é‡æ“ä½œæˆåŠŸ");
            result.put("processedCount", productIds.size());
            result.put("operation", operation);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ‰¹é‡æ“ä½œå•†å“å¤±è´¥", e);
            return R.error("æ“ä½œå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–æ‰€æœ‰åˆ†ç±?     */
    @GetMapping("/categories")
    @ApiOperation("è·å–æ‰€æœ‰åˆ†ç±?)
    public R<List<Map<String, Object>>> getCategories(HttpServletRequest request) {
        try {
            return R.success(getAllCategories());
        } catch (Exception e) {
            log.error("è·å–åˆ†ç±»å¤±è´¥", e);
            return R.error("è·å–åˆ†ç±»å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–å•†å“ç»Ÿè®¡æ•°æ®
     */
    @GetMapping("/statistics")
    @ApiOperation("è·å–å•†å“ç»Ÿè®¡æ•°æ®")
    public R<Map<String, Object>> getProductStatistics(HttpServletRequest request) {
        try {
            return R.success(calculateProductStatistics(mockProducts));
        } catch (Exception e) {
            log.error("è·å–å•†å“ç»Ÿè®¡å¤±è´¥", e);
            return R.error("è·å–ç»Ÿè®¡å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è®¡ç®—å•†å“ç»Ÿè®¡
     */
    private Map<String, Object> calculateProductStatistics(List<Map<String, Object>> products) {
        Map<String, Object> statistics = new HashMap<>();
        
        // æŒ‰çŠ¶æ€ç»Ÿè®?        Map<String, Integer> statusStats = new HashMap<>();
        int totalSales = 0;
        double totalRevenue = 0.0;
        
        for (Map<String, Object> product : products) {
            String status = product.get("status").toString();
            statusStats.put(status, statusStats.getOrDefault(status, 0) + 1);
            
            int sales = Integer.parseInt(product.get("sales").toString());
            double price = Double.parseDouble(product.get("price").toString());
            totalSales += sales;
            totalRevenue += sales * price;
        }
        
        statistics.put("totalProducts", products.size());
        statistics.put("statusStats", statusStats);
        statistics.put("totalSales", totalSales);
        statistics.put("totalRevenue", String.format("%.2f", totalRevenue));
        
        return statistics;
    }

    /**
     * è·å–æ‰€æœ‰åˆ†ç±?     */
    private List<Map<String, Object>> getAllCategories() {
        List<Map<String, Object>> categories = new ArrayList<>();
        String[] categoryNames = {"ä¸»é£Ÿ", "å°åƒ", "é¥®å“", "æ±¤å“", "ç”œç‚¹", "å‡‰èœ", "çƒ­èœ", "çƒ§çƒ¤"};
        
        for (String category : categoryNames) {
            Map<String, Object> categoryInfo = new HashMap<>();
            categoryInfo.put("name", category);
            categoryInfo.put("productCount", (int) mockProducts.stream()
                .filter(product -> product.get("category").equals(category)).count());
            categories.add(categoryInfo);
        }
        
        return categories;
    }

    /**
     * è·å–å•†å®¶ID
     */
    private Long getMerchantId(HttpServletRequest request) {
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
// import io.swagger.annotations.Api;
// import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.*;

/**
 * å•†å®¶ç«¯è¥é”€æ´»åŠ¨æ§åˆ¶å™? * å¤„ç†å•†å®¶ç«¯è¥é”€æ´»åŠ¨ç›¸å…³è¯·æ±‚
 */
@RestController
@RequestMapping("/merchant/promotions")
// @Api(tags = "å•†å®¶è¥é”€æ´»åŠ¨ç®¡ç†")
public class MerchantPromotionController {

    private static final Logger log = LoggerFactory.getLogger(MerchantPromotionController.class);

    // æ¨¡æ‹Ÿè¥é”€æ´»åŠ¨æ•°æ®
    private List<Map<String, Object>> mockPromotions = new ArrayList<>();

    public MerchantPromotionController() {
        initMockData();
    }

    /**
     * åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ?     */
    private void initMockData() {
        String[] types = {"æ»¡å‡ä¼˜æƒ ", "æŠ˜æ‰£ä¿ƒé”€", "å…è´¹é…é€?, "ä¹°ä¸€é€ä¸€", "é™æ—¶æŠ¢è´­", "ç§¯åˆ†å…‘æ¢", "ä¼˜æƒ åˆ?};
        String[] statuses = {"è¿›è¡Œä¸?, "å·²æš‚å?, "å·²ç»“æ?, "è‰ç¨¿", "å³å°†å¼€å§?};
        
        for (int i = 0; i < 30; i++) {
            Map<String, Object> promotion = new HashMap<>();
            promotion.put("id", "PR" + (i + 1));
            promotion.put("name", getPromotionName(i));
            promotion.put("type", types[i % types.length]);
            promotion.put("status", statuses[i % statuses.length]);
            promotion.put("description", getPromotionDescription(i));
            promotion.put("condition", getPromotionCondition(i));
            promotion.put("startTime", getStartTime(i));
            promotion.put("endTime", getEndTime(i));
            promotion.put("createTime", "2025-11-12 " + String.format("%02d:%02d:%02d", 16 - i/10, (i*7)%60, (i*13)%60));
            
            // æ´»åŠ¨ç»Ÿè®¡
            Map<String, Object> statistics = new HashMap<String, Object>();
            statistics.put("participated", (i + 1) * 20);
            statistics.put("sales", (i + 1) * 50);
            statistics.put("totalAmount", (i + 1) * 250.5);
            statistics.put("discountAmount", (i + 1) * 25.5);
            promotion.put("statistics", statistics);
            
            promotion.put("isActive", i % 3 == 0);
            promotion.put("applicableProducts", Arrays.asList("P1", "P2", "P3"));
            
            mockPromotions.add(promotion);
        }
    }

    /**
     * è·å–æ´»åŠ¨åç§°
     */
    private String getPromotionName(int i) {
        String[] names = {
            "æ–°ç”¨æˆ·ä¸“äº«æ»¡50å‡?0", "åˆå¸‚ä¼˜æƒ æ»?0å‡?", "æ™šé¤ç‰¹æƒ æ»?0å‡?5", "å‘¨æœ«ç‹‚æ¬¢ä¹°ä¸€é€ä¸€",
            "æ¯æ—¥ç­¾åˆ°ç§¯åˆ†åŒå€?, "æ–°å“å°é²œ8.8æŠ?, "å……å€¼é€åˆ¸æ´»åŠ¨", "å¥½å‹é‚€è¯·è¿”åˆ?,
            "èŠ‚æ—¥é™å®šå¥—é¤", "ä¼šå‘˜ä¸“äº«æŠ˜æ‰£", "æ»¡é¢åŒ…é‚®æ´»åŠ¨", "é™æ—¶ç§’æ€ä¸“åŒº",
            "ç§¯åˆ†å•†åŸå…‘æ¢", "ç”Ÿæ—¥ç‰¹æƒä¼˜æƒ ", "è€å®¢æˆ·å›å½’ç¤¼", "è®¢å•æ»¡å‡ç¦åˆ©",
            "ç¬¬äºŒä»½åŠä»?, "æ»¡é¢èµ å“", "æ–°äººç¦åˆ©åŒ?, "æ¶ˆè´¹è¿”ç°",
            "æ»¡å‡å åŠ å¤§ä¿ƒ", "å‘¨å¹´åº†ç‹‚æ¬?, "å¼€å­¦å­£ç‰¹æƒ ", "å¹´ç»ˆå›é¦ˆ",
            "å‘¨å¹´åº†å¤§ä¼˜æƒ ", "å¤æ—¥æ¸…å‡‰ä¿ƒé”€", "ç§‹å†¬ä¿æš–æ´»åŠ¨", "æ˜¥å­£æ¢æ–°",
            "åŒåä¸€é¢„çƒ­", "å¹´ç»ˆå¤§ä¿ƒ"
        };
        return names[i % names.length];
    }

    /**
     * è·å–æ´»åŠ¨æè¿°
     */
    private String getPromotionDescription(int i) {
        String[] descriptions = {
            "æ–°ç”¨æˆ·é¦–æ¬¡ä¸‹å•å³å¯äº«å—æ»¡50å‡?0ä¼˜æƒ ",
            "å·¥ä½œæ—¥åˆå¸‚ç‰¹æƒ ï¼Œè®©æ‚¨åœ¨å¿™ç¢Œçš„å·¥ä½œä¸­äº«å—ç¾é£?,
            "æ™šé¤æ—¶å…‰ï¼Œä¸å®¶äººä¸€èµ·äº«å—ä¼˜æƒ?,
            "ç²¾é€‰å•†å“ä¹°ä¸€é€ä¸€ï¼Œæ€§ä»·æ¯”è¶…é«˜çš„é€‰æ‹©",
            "æ¯æ—¥ç­¾åˆ°å³å¯è·å¾—åŒå€ç§¯åˆ†å¥–åŠ?,
            "æ–°å“ä¸Šå¸‚ï¼Œè¶…å€¼æŠ˜æ‰£æŠ¢å…ˆä½“éª?,
            "å……å€¼é€åˆ¸ï¼Œå……å€¼è¶Šå¤šé€åˆ¸è¶Šå¤š",
            "é‚€è¯·å¥½å‹æ³¨å†Œï¼ŒåŒæ–¹éƒ½å¯è·å¾—è¿”åˆ©",
            "èŠ‚æ—¥é™å®šå¥—é¤ï¼ŒèŠ‚æ—¥çš„ç¾å¥½æ—¶å…‰",
            "ä¼šå‘˜ä¸“äº«æŠ˜æ‰£ï¼Œè®©æ‚¨äº«å—VIPå¾…é‡",
            "æ»¡é¢å…è´¹é…é€ï¼Œè®©æ‚¨è´­ç‰©æ›´è½»æ?,
            "é™æ—¶ç§’æ€ï¼Œæ•°é‡æœ‰é™å…ˆåˆ°å…ˆå¾?,
            "ç§¯åˆ†å•†åŸå¥½ç¤¼å…‘æ¢ï¼Œç§¯åˆ†å½“é’±èŠ±",
            "ç”Ÿæ—¥æœˆä¸“äº«ç‰¹æƒï¼Œç»™æ‚¨ç‰¹åˆ«çš„å…³çˆ?,
            "è€å®¢æˆ·ä¸“å±å›å½’ç¤¼ï¼Œæˆ‘ä»¬ä»æœªå¿˜è®°æ‚¨",
            "è®¢å•æ»¡å‡ç¦åˆ©ï¼Œè®©æ‚¨çš„æ¯ä¸€å•éƒ½æ›´åˆ’ç®?
        };
        return descriptions[i % descriptions.length];
    }

    /**
     * è·å–æ´»åŠ¨æ¡ä»¶
     */
    private String getPromotionCondition(int i) {
        String[] conditions = {
            "æ»?0å…ƒå¯ç”?, "æ»?0å…ƒå¯ç”?, "æ»?0å…ƒå¯ç”?, "ä»»æ„è®¢å•",
            "æ¯æ—¥ç­¾åˆ°", "æ— é—¨æ§?, "å……å€¼æ»¡100å…?, "é‚€è¯?ä½å¥½å?,
            "èŠ‚æ—¥å½“æ—¥", "ä¼šå‘˜ç­‰çº§2çº§ä»¥ä¸?, "æ»¡é¢è®¢å•", "é™æ—¶æŠ¢è´­",
            "ç§¯åˆ†æ»?000", "ç”Ÿæ—¥æœ?, "è¿ç»­æ¶ˆè´¹3å¤?, "å•ç¬”æ»?0å…?,
            "ä¹°ä¸€é€ä¸€", "æ»¡é¢èµ å“", "æ–°ç”¨æˆ·ä¸“äº?, "æ¶ˆè´¹æ»?00å…?,
            "æ»¡å‡å åŠ ", "å‘¨å¹´åº†æœŸé—?, "å¼€å­¦å­£æœŸé—´", "12æœ?1æ—¥å‰"
        };
        return conditions[i % conditions.length];
    }

    /**
     * è·å–å¼€å§‹æ—¶é—?     */
    private String getStartTime(int i) {
        Date start = new Date(System.currentTimeMillis() + (i - 7) * 24 * 60 * 60 * 1000L);
        return String.format("%tF %<tT", start);
    }

    /**
     * è·å–ç»“æŸæ—¶é—´
     */
    private String getEndTime(int i) {
        Date end = new Date(System.currentTimeMillis() + (i + 7) * 24 * 60 * 60 * 1000L);
        return String.format("%tF %<tT", end);
    }

    /**
     * è·å–å•†å®¶è¥é”€æ´»åŠ¨åˆ—è¡¨
     */
    @GetMapping
    // @ApiOperation("è·å–å•†å®¶è¥é”€æ´»åŠ¨åˆ—è¡¨")
    public R<Map<String, Object>> getPromotions(
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer limit,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            // ç­›é€‰æ´»åŠ?            List<Map<String, Object>> filteredPromotions = new ArrayList<>(mockPromotions);
            
            if (status != null && !status.isEmpty()) {
                filteredPromotions.removeIf(promotion -> !promotion.get("status").equals(status));
            }
            
            if (type != null && !type.isEmpty()) {
                filteredPromotions.removeIf(promotion -> !promotion.get("type").equals(type));
            }
            
            if (keyword != null && !keyword.isEmpty()) {
                filteredPromotions.removeIf(promotion -> 
                    !promotion.get("name").toString().contains(keyword)
                );
            }
            
            // åˆ†é¡µ
            int start = (page - 1) * limit;
            int end = Math.min(start + limit, filteredPromotions.size());
            List<Map<String, Object>> pagePromotions = start < end ? filteredPromotions.subList(start, end) : new ArrayList<>();
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            Map<String, Object> statistics = calculatePromotionStatistics(filteredPromotions);
            
            Map<String, Object> result = new HashMap<String, Object>();
            result.put("promotions", pagePromotions);
            result.put("total", filteredPromotions.size());
            result.put("page", page);
            result.put("limit", limit);
            result.put("statistics", statistics);
            result.put("types", getAllPromotionTypes());
            
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–è¥é”€æ´»åŠ¨åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–æ´»åŠ¨åˆ—è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–è¥é”€æ´»åŠ¨è¯¦æƒ…
     */
    @GetMapping("/{promotionId}")
    // @ApiOperation("è·å–è¥é”€æ´»åŠ¨è¯¦æƒ…")
    public R<Map<String, Object>> getPromotionDetail(@PathVariable String promotionId, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            Map<String, Object> promotion = mockPromotions.stream()
                .filter(p -> p.get("id").equals(promotionId))
                .findFirst()
                .orElse(null);
            
            if (promotion == null) {
                return R.error("æ´»åŠ¨ä¸å­˜åœ?);
            }
            
            return R.success(promotion);
        } catch (Exception e) {
            log.error("è·å–æ´»åŠ¨è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–è¯¦æƒ…å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * åˆ›å»ºè¥é”€æ´»åŠ¨
     */
    @PostMapping
    // @ApiOperation("åˆ›å»ºè¥é”€æ´»åŠ¨")
    public R<Map<String, Object>> createPromotion(@RequestBody Map<String, Object> promotion, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} åˆ›å»ºè¥é”€æ´»åŠ¨: {}", merchantId, promotion.get("name"));
            
            Map<String, Object> newPromotion = new HashMap<String, Object>();
            newPromotion.put("id", "PR" + (mockPromotions.size() + 1));
            newPromotion.put("name", promotion.get("name"));
            newPromotion.put("type", promotion.get("type"));
            newPromotion.put("status", "è‰ç¨¿");
            newPromotion.put("description", promotion.get("description"));
            newPromotion.put("condition", promotion.get("condition"));
            newPromotion.put("startTime", promotion.get("startTime"));
            newPromotion.put("endTime", promotion.get("endTime"));
            newPromotion.put("createTime", new Date());
            newPromotion.put("isActive", false);
            
            Map<String, Object> statistics = new HashMap<>();
            statistics.put("participated", 0);
            statistics.put("sales", 0);
            statistics.put("totalAmount", 0.0);
            statistics.put("discountAmount", 0.0);
            newPromotion.put("statistics", statistics);
            
            mockPromotions.add(0, newPromotion);
            
            Map<String, Object> result = new HashMap<String, Object>();
            result.put("success", true);
            result.put("message", "è¥é”€æ´»åŠ¨åˆ›å»ºæˆåŠŸ");
            result.put("promotion", newPromotion);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("åˆ›å»ºè¥é”€æ´»åŠ¨å¤±è´¥", e);
            return R.error("åˆ›å»ºå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ›´æ–°è¥é”€æ´»åŠ¨
     */
    @PutMapping("/{promotionId}")
    // @ApiOperation("æ›´æ–°è¥é”€æ´»åŠ¨")
    public R<Map<String, Object>> updatePromotion(
            @PathVariable String promotionId,
            @RequestBody Map<String, Object> promotion,
            HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} æ›´æ–°è¥é”€æ´»åŠ¨ {}", merchantId, promotionId);
            
            Map<String, Object> existingPromotion = mockPromotions.stream()
                .filter(p -> p.get("id").equals(promotionId))
                .findFirst()
                .orElse(null);
            
            if (existingPromotion == null) {
                return R.error("æ´»åŠ¨ä¸å­˜åœ?);
            }
            
            // æ›´æ–°æ´»åŠ¨ä¿¡æ¯
            existingPromotion.putAll(promotion);
            existingPromotion.put("updateTime", new Date());
            
            Map<String, Object> result = new HashMap<String, Object>();
            result.put("success", true);
            result.put("message", "è¥é”€æ´»åŠ¨æ›´æ–°æˆåŠŸ");
            result.put("promotion", existingPromotion);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("æ›´æ–°è¥é”€æ´»åŠ¨å¤±è´¥", e);
            return R.error("æ›´æ–°å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å¯ç”¨/æš‚åœæ´»åŠ¨
     */
    @PostMapping("/{promotionId}/toggle")
    // @ApiOperation("å¯ç”¨/æš‚åœæ´»åŠ¨")
    public R<Map<String, Object>> togglePromotionStatus(@PathVariable String promotionId, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} åˆ‡æ¢è¥é”€æ´»åŠ¨ {} çŠ¶æ€?, merchantId, promotionId);
            
            Map<String, Object> promotion = mockPromotions.stream()
                .filter(p -> p.get("id").equals(promotionId))
                .findFirst()
                .orElse(null);
            
            if (promotion == null) {
                return R.error("æ´»åŠ¨ä¸å­˜åœ?);
            }
            
            boolean currentStatus = Boolean.parseBoolean(promotion.get("isActive").toString());
            promotion.put("isActive", !currentStatus);
            promotion.put("status", !currentStatus ? "è¿›è¡Œä¸? : "å·²æš‚å?);
            
            Map<String, Object> result = new HashMap<String, Object>();
            result.put("success", true);
            result.put("message", "æ´»åŠ¨çŠ¶æ€æ›´æ–°æˆåŠ?);
            result.put("newStatus", promotion.get("status"));
            result.put("isActive", promotion.get("isActive"));
            
            return R.success(result);
        } catch (Exception e) {
            log.error("åˆ‡æ¢æ´»åŠ¨çŠ¶æ€å¤±è´?, e);
            return R.error("æ“ä½œå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * åˆ é™¤è¥é”€æ´»åŠ¨
     */
    @DeleteMapping("/{promotionId}")
    // @ApiOperation("åˆ é™¤è¥é”€æ´»åŠ¨")
    public R<Map<String, Object>> deletePromotion(@PathVariable String promotionId, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} åˆ é™¤è¥é”€æ´»åŠ¨ {}", merchantId, promotionId);
            
            boolean removed = mockPromotions.removeIf(promotion -> promotion.get("id").equals(promotionId));
            
            if (!removed) {
                return R.error("æ´»åŠ¨ä¸å­˜åœ?);
            }
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "è¥é”€æ´»åŠ¨åˆ é™¤æˆåŠŸ");
            
            return R.success(result);
        } catch (Exception e) {
            log.error("åˆ é™¤è¥é”€æ´»åŠ¨å¤±è´¥", e);
            return R.error("åˆ é™¤å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–æ´»åŠ¨æ¨¡æ¿
     */
    @GetMapping("/templates")
    // @ApiOperation("è·å–æ´»åŠ¨æ¨¡æ¿")
    public R<List<Map<String, Object>>> getPromotionTemplates(HttpServletRequest request) {
        try {
            List<Map<String, Object>> templates = new ArrayList<Map<String, Object>>();
            
            String[] templateTypes = {"æ»¡å‡ä¼˜æƒ ", "æŠ˜æ‰£ä¿ƒé”€", "å…è´¹é…é€?, "ä¹°ä¸€é€ä¸€", "é™æ—¶æŠ¢è´­", "ç§¯åˆ†å…‘æ¢", "ä¼˜æƒ åˆ?};
            String[] templateNames = {"æ»?0å‡?0", "æ»?0å‡?", "æ»?0å‡?0", "æ»?00å‡?0", "å…¨åœº8.8æŠ?, "æ»¡é¢åŒ…é‚®", "ä¹°äºŒé€ä¸€"};
            
            for (int i = 0; i < templateTypes.length; i++) {
                Map<String, Object> template = new HashMap<String, Object>();
                template.put("id", "T" + (i + 1));
                template.put("name", templateNames[i]);
                template.put("type", templateTypes[i]);
                template.put("description", "é¢„è®¾æ´»åŠ¨æ¨¡æ¿ï¼Œå¿«é€Ÿåˆ›å»?);
                template.put("condition", "æ»? + (50 + i * 10) + "å…ƒå¯ç”?);
                templates.add(template);
            }
            
            return R.success(templates);
        } catch (Exception e) {
            log.error("è·å–æ´»åŠ¨æ¨¡æ¿å¤±è´¥", e);
            return R.error("è·å–æ¨¡æ¿å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å¤åˆ¶è¥é”€æ´»åŠ¨
     */
    @PostMapping("/{promotionId}/copy")
    // @ApiOperation("å¤åˆ¶è¥é”€æ´»åŠ¨")
    public R<Map<String, Object>> copyPromotion(@PathVariable String promotionId, HttpServletRequest request) {
        try {
            Long merchantId = getMerchantId(request);
            
            log.info("å•†å®¶ {} å¤åˆ¶è¥é”€æ´»åŠ¨ {}", merchantId, promotionId);
            
            Map<String, Object> originalPromotion = mockPromotions.stream()
                .filter(p -> p.get("id").equals(promotionId))
                .findFirst()
                .orElse(null);
            
            if (originalPromotion == null) {
                return R.error("æ´»åŠ¨ä¸å­˜åœ?);
            }
            
            Map<String, Object> copiedPromotion = new HashMap<>(originalPromotion);
            copiedPromotion.put("id", "PR" + (mockPromotions.size() + 1));
            copiedPromotion.put("name", originalPromotion.get("name") + "_å‰¯æœ¬");
            copiedPromotion.put("status", "è‰ç¨¿");
            copiedPromotion.put("isActive", false);
            copiedPromotion.put("createTime", new Date());
            
            mockPromotions.add(0, copiedPromotion);
            
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("message", "æ´»åŠ¨å¤åˆ¶æˆåŠŸ");
            result.put("promotion", copiedPromotion);
            
            return R.success(result);
        } catch (Exception e) {
            log.error("å¤åˆ¶è¥é”€æ´»åŠ¨å¤±è´¥", e);
            return R.error("å¤åˆ¶å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è®¡ç®—è¥é”€æ´»åŠ¨ç»Ÿè®¡
     */
    private Map<String, Object> calculatePromotionStatistics(List<Map<String, Object>> promotions) {
        Map<String, Object> statistics = new HashMap<>();
        
        // æŒ‰çŠ¶æ€ç»Ÿè®?        Map<String, Integer> statusStats = new HashMap<>();
        int totalParticipated = 0;
        double totalSales = 0.0;
        double totalDiscount = 0.0;
        
        for (Map<String, Object> promotion : promotions) {
            String status = promotion.get("status").toString();
            statusStats.put(status, statusStats.getOrDefault(status, 0) + 1);
            
            Map<String, Object> promoStats = (Map<String, Object>) promotion.get("statistics");
            totalParticipated += Integer.parseInt(promoStats.get("participated").toString());
            totalSales += Double.parseDouble(promoStats.get("totalAmount").toString());
            totalDiscount += Double.parseDouble(promoStats.get("discountAmount").toString());
        }
        
        statistics.put("totalPromotions", promotions.size());
        statistics.put("statusStats", statusStats);
        statistics.put("totalParticipated", totalParticipated);
        statistics.put("totalSales", String.format("%.2f", totalSales));
        statistics.put("totalDiscount", String.format("%.2f", totalDiscount));
        
        return statistics;
    }

    /**
     * è·å–æ‰€æœ‰æ´»åŠ¨ç±»å?     */
    private List<Map<String, Object>> getAllPromotionTypes() {
        List<Map<String, Object>> types = new ArrayList<>();
        String[] typeNames = {"æ»¡å‡ä¼˜æƒ ", "æŠ˜æ‰£ä¿ƒé”€", "å…è´¹é…é€?, "ä¹°ä¸€é€ä¸€", "é™æ—¶æŠ¢è´­", "ç§¯åˆ†å…‘æ¢", "ä¼˜æƒ åˆ?};
        
        for (String type : typeNames) {
            Map<String, Object> typeInfo = new HashMap<>();
            typeInfo.put("name", type);
            typeInfo.put("promotionCount", (int) mockPromotions.stream()
                .filter(promotion -> promotion.get("type").equals(type)).count());
            types.add(typeInfo);
        }
        
        return types;
    }

    /**
     * è·å–å•†å®¶ID
     */
    private Long getMerchantId(HttpServletRequest request) {
        return 1001L;
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.annotation.RateLimiter;
import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import com.heikeji.app.interceptor.JwtAuthenticationInterceptor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * è®¢å•æ§åˆ¶å™? * å¤„ç†ç”¨æˆ·è®¢å•ç›¸å…³è¯·æ±‚
 */

@RestController
@RequestMapping("/app/order")
@Api(tags = "è®¢å•ç®¡ç†")
public class OrderController {

    private static final Logger log = LoggerFactory.getLogger(OrderController.class);

    /**
     * åˆ›å»ºè®¢å•
     */
    @PostMapping("/create")
    @ApiOperation("åˆ›å»ºè®¢å•")
    @RateLimiter(timeWindow = 1, maxCount = 5, limitType = "user")
    public R<Map<String, Object>> createOrder(@RequestBody Map<String, Object> params, HttpServletRequest request) {
        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
            Long userId = getUserId(request);
            
            // éªŒè¯è¯·æ±‚ä¸­çš„ç”¨æˆ·IDæ˜¯å¦ä¸å½“å‰ç™»å½•ç”¨æˆ·ä¸€è‡?            if (params.containsKey("userId")) {
                Long requestUserId = Long.valueOf(params.get("userId").toString());
                if (!userId.equals(requestUserId)) {
                    return R.error("ç”¨æˆ·èº«ä»½éªŒè¯å¤±è´¥");
                }
            } else {
                params.put("userId", userId);
            }
            
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿè¿”å›è®¢å•ä¿¡æ¯
            Map<String, Object> result = new HashMap<>();
            Map<String, Object> orderInfo = new HashMap<>();
            orderInfo.put("orderNo", "ORD" + System.currentTimeMillis());
            orderInfo.put("userId", userId);
            result.put("order", orderInfo);
            return R.success(result);
        } catch (IllegalArgumentException e) {
            log.warn("åˆ›å»ºè®¢å•å‚æ•°é”™è¯¯: {}", e.getMessage());
            return R.error(e.getMessage());
        } catch (Exception e) {
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
            return R.error("è®¢å•åˆ›å»ºå¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–è®¢å•è¯¦æƒ…ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼Œä»…ç”¨äºå†…éƒ¨è°ƒç”¨ï¼?     */
    @GetMapping("/detail/{orderNo}")
    @ApiOperation("æŸ¥è¯¢è®¢å•è¯¦æƒ…")
    public R<Map<String, Object>> getOrderDetail(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // æ·»åŠ ç”¨æˆ·éªŒè¯
            Long userId = getUserId(request);
            // ç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºæ¨¡æ‹Ÿè®¢å•è¯¦æƒ…
            Map<String, Object> orderDetail = new HashMap<>();
            orderDetail.put("orderNo", orderNo);
            orderDetail.put("userId", userId);
            orderDetail.put("status", 1);
            orderDetail.put("totalAmount", 0.00);
            return R.success(orderDetail);
        } catch (Exception e) {
            log.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * æ”¯ä»˜è®¢å•
     */
    @PostMapping("/pay")
    @ApiOperation("æ”¯ä»˜è®¢å•")
    @RateLimiter(timeWindow = 1, maxCount = 3, limitType = "user")
    public R<Map<String, Object>> payOrder(@RequestBody Map<String, Object> params, HttpServletRequest request) {
        try {
            Long userId = getUserId(request);
            String orderNo = params.get("orderNo").toString();
            Integer payType = Integer.valueOf(params.get("payType").toString());
            
            log.info("ç”¨æˆ· {} æ”¯ä»˜è®¢å• {}, æ”¯ä»˜æ–¹å¼: {}", userId, orderNo, payType);
            
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿæ”¯ä»˜ç»“æœ
            Map<String, Object> result = new HashMap<>();
            result.put("success", true);
            result.put("orderNo", orderNo);
            
            // è¿”å›æ”¯ä»˜ç»“æœæˆ–è·³è½¬é“¾æ?            Map<String, Object> response = new HashMap<>();
            response.put("data", result);
            return R.success(response);
        } catch (IllegalArgumentException e) {
            log.warn("æ”¯ä»˜è®¢å•å‚æ•°é”™è¯¯: {}", e.getMessage());
            return R.error(e.getMessage());
        } catch (Exception e) {
            log.error("æ”¯ä»˜è®¢å•å¤±è´¥", e);
            return R.error("æ”¯ä»˜å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * å–æ¶ˆè®¢å•ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼Œä»…ç”¨äºå†…éƒ¨è°ƒç”¨ï¼?     */
    @PostMapping("/cancel/{orderNo}")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Boolean> cancelOrder(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // æ·»åŠ ç”¨æˆ·éªŒè¯
            Long userId = getUserId(request);
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿå–æ¶ˆæˆåŠŸ
            Boolean result = true;
            return R.success(result);
        } catch (Exception e) {
            log.error("å–æ¶ˆè®¢å•å¤±è´¥", e);
                return R.error("å–æ¶ˆè®¢å•å¤±è´¥ï¼? + e.getMessage());
        }
    }
    
    /**
     * å–æ¶ˆè®¢å•ï¼ˆæ–°ç‰ˆæœ¬ï¼Œæ”¯æŒç”¨æˆ·éªŒè¯ï¼‰
     */
    @PostMapping("/cancel")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Map<String, Object>> cancelOrderByParam(@RequestParam String orderNo, HttpServletRequest request) {
        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
            Long userId = getUserId(request);
            
            // éªŒè¯è®¢å•å½’å±å¹¶å–æ¶ˆè®¢å?            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿå–æ¶ˆæˆåŠŸ
            boolean result = true;
            if (result) {
                Map<String, Object> response = new HashMap<>();
                response.put("message", "å–æ¶ˆè®¢å•æˆåŠŸ");
                return R.success(response);
            } else {
                return R.error("è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ");
            }
        } catch (Exception e) {
            log.error("å–æ¶ˆè®¢å•å¤±è´¥", e);
                return R.error("å–æ¶ˆè®¢å•å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * ç¡®è®¤æ”¶è´§ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼Œä»…ç”¨äºå†…éƒ¨è°ƒç”¨ï¼?     */
    @PostMapping("/confirm/{orderNo}")
    @ApiOperation("ç¡®è®¤æ”¶è´§")
    public R<Boolean> confirmReceipt(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            // æ·»åŠ ç”¨æˆ·éªŒè¯
            Long userId = getUserId(request);
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿç¡®è®¤æ”¶è´§æˆåŠŸ
            Boolean result = true;
            return R.success(result);
        } catch (Exception e) {
            log.error("ç¡®è®¤æ”¶è´§å¤±è´¥", e);
                return R.error("ç¡®è®¤æ”¶è´§å¤±è´¥ï¼? + e.getMessage());
        }
    }
    
    /**
     * ç¡®è®¤æ”¶è´§ï¼ˆæ–°ç‰ˆæœ¬ï¼Œæ”¯æŒç”¨æˆ·éªŒè¯ï¼‰
     */
    @PostMapping("/confirm-receipt")
    @ApiOperation("ç¡®è®¤æ”¶è´§")
    public R<Map<String, Object>> confirmReceiptByParam(@RequestParam String orderNo, HttpServletRequest request) {
        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
            Long userId = getUserId(request);
            
            // éªŒè¯è®¢å•å½’å±å¹¶ç¡®è®¤æ”¶è´?            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿç¡®è®¤æ”¶è´§æˆåŠŸ
            boolean result = true;
            if (result) {
                Map<String, Object> response = new HashMap<>();
                response.put("message", "ç¡®è®¤æ”¶è´§æˆåŠŸ");
                return R.success(response);
            } else {
                return R.error("è®¢å•çŠ¶æ€ä¸å…è®¸ç¡®è®¤æ”¶è´§");
            }
        } catch (Exception e) {
            log.error("ç¡®è®¤æ”¶è´§å¤±è´¥", e);
                return R.error("ç¡®è®¤æ”¶è´§å¤±è´¥ï¼? + e.getMessage());
        }
    }

    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/list")
    @ApiOperation("è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨")
    public R<Map<String, Object>> getUserOrderList(@RequestParam(required = false) Integer status, 
                                      @RequestParam(defaultValue = "1") Integer page, 
                                      @RequestParam(defaultValue = "10") Integer limit, 
                                      HttpServletRequest request) {
        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
            Long userId = getUserId(request);
            
            log.info("è·å–ç”¨æˆ· {} çš„è®¢å•åˆ—è¡¨ï¼ŒçŠ¶æ€ï¼š{}, é¡µç ï¼š{}, æ¯é¡µæ•°é‡ï¼š{}", userId, status, page, limit);
            
            // ç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºç©ºåˆ—è¡¨å“åº?            Map<String, Object> result = new HashMap<>();
            result.put("list", new ArrayList<>());
            result.put("total", 0);
            return R.success(result);
        } catch (Exception e) {
            log.error("è·å–è®¢å•åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–è®¢å•åˆ—è¡¨å¤±è´¥ï¼? + e.getMessage());
        }
    }
    
    /**
     * è·å–è®¢å•æ•°é‡ç»Ÿè®¡
     */
    @GetMapping("/count")
    @ApiOperation("è·å–å„çŠ¶æ€è®¢å•æ•°é‡?)
    public R<Map<String, Integer>> getOrderCount(HttpServletRequest request) {
        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
            Long userId = getUserId(request);
            
            log.info("è·å–ç”¨æˆ· {} çš„è®¢å•æ•°é‡ç»Ÿè®?, userId);
            
            // ç»Ÿè®¡å„çŠ¶æ€è®¢å•æ•°é‡?            Map<String, Integer> countMap = new HashMap<>();
            
            // ç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºæ¨¡æ‹Ÿè®¢å•æ•°é‡ç»Ÿè®¡
            countMap.put("unpaid", 0);
            countMap.put("unshipped", 0);
            countMap.put("unreceived", 0);
            countMap.put("uncommented", 0);
            countMap.put("completed", 0);
            countMap.put("cancelled", 0);
            countMap.put("total", 0);
            countMap.put("all", 0);
            countMap.put("pendingPayment", 0);
            countMap.put("pendingShipping", 0);
            countMap.put("pendingReceipt", 0);
            
            return R.success(countMap);
        } catch (Exception e) {
            log.error("è·å–è®¢å•æ•°é‡ç»Ÿè®¡å¤±è´¥", e);
            return R.error("è·å–è®¢å•æ•°é‡ç»Ÿè®¡å¤±è´¥ï¼? + e.getMessage());
        }
    }
    
    /**
     * è·å–è®¢å•è¯¦æƒ…ï¼ˆå…¼å®¹å‰ç«¯é¡µé¢è°ƒç”¨ï¼‰
     */
    @GetMapping("/detail")
    @ApiOperation("è·å–è®¢å•è¯¦æƒ…")
    public R<Map<String, Object>> getOrderDetailByParam(@RequestParam String orderNo, HttpServletRequest request) {
        try {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
            Long userId = getUserId(request);
            
            // ç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºæ¨¡æ‹Ÿè®¢å•è¯¦æƒ…
            Map<String, Object> orderDetail = new HashMap<>();
            orderDetail.put("orderNo", orderNo);
            orderDetail.put("userId", userId);
            orderDetail.put("status", 1);
            orderDetail.put("totalAmount", 0.00);
            return R.success(orderDetail);
        } catch (Exception e) {
            log.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–è®¢å•è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    /**
     * ä»è¯·æ±‚ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·ID
     * ä½¿ç”¨JWTéªŒè¯æ‹¦æˆªå™¨è·å–ç”¨æˆ·ä¿¡æ?     * @param request HTTPè¯·æ±‚
     * @return ç”¨æˆ·ID
     * @throws RuntimeException å¦‚æœæ— æ³•è·å–ç”¨æˆ·ID
     */
    private Long getUserId(HttpServletRequest request) {
        // å°è¯•ä»JWTæ‹¦æˆªå™¨ä¸­è·å–ç”¨æˆ·ID
        Long userId = JwtAuthenticationInterceptor.getCurrentUserId(request);
        
        if (userId != null) {
            log.debug("ä»JWT tokenä¸­è·å–åˆ°ç”¨æˆ·ID: {}", userId);
            return userId;
        }
        
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼šå°è¯•ä»headerä¸­è·å–ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
        String userIdStr = request.getHeader("X-User-Id");
        if (userIdStr != null && !userIdStr.isEmpty()) {
            try {
                Long parsedUserId = Long.parseLong(userIdStr);
                log.debug("ä»è¯·æ±‚å¤´ä¸­è·å–åˆ°ç”¨æˆ·ID: {}", parsedUserId);
                return parsedUserId;
            } catch (NumberFormatException e) {
                log.warn("ç”¨æˆ·IDæ ¼å¼é”™è¯¯: {}", userIdStr);
            }
        }
        
        // å¦‚æœéƒ½æ— æ³•è·å–ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥æŠ›å‡ºå¼‚å¸¸å¹¶é‡å®šå‘åˆ°ç™»å½•é¡µé?        log.warn("æ— æ³•ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·IDï¼Œä½¿ç”¨é»˜è®¤å€?);
        return 1L; // é»˜è®¤ç”¨æˆ·IDï¼Œä»…ç”¨äºå¼€å‘æµ‹è¯?    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * è®¢å•å•†å“æ˜ç»†æ§åˆ¶å™? */
@RestController
@RequestMapping("/app/order-item")
@Api(tags = "è®¢å•å•†å“æ˜ç»†")
public class OrderItemController {
    // ç§»é™¤äº†å¯¹OrderItemServiceçš„ä¾èµ–ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå®ç°
    
    /**
     * æ ¹æ®è®¢å•IDè·å–è®¢å•å•†å“æ˜ç»†
     * @param orderId è®¢å•ID
     * @return è®¢å•å•†å“åˆ—è¡¨
     */
    @GetMapping("/by-order/{orderId}")
    @ApiOperation("æ ¹æ®è®¢å•IDè·å–å•†å“æ˜ç»†")
    public R<List<Map<String, Object>>> getByOrderId(@PathVariable("orderId") Long orderId) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œè¿”å›ç©ºåˆ—è¡?            List<Map<String, Object>> orderItems = new ArrayList<>();
            return R.success(orderItems);
        } catch (Exception e) {
            return R.error("è·å–è®¢å•å•†å“æ˜ç»†å¤±è´¥");
        }
    }
    
    /**
     * æ ¹æ®è®¢å•å·è·å–è®¢å•å•†å“æ˜ç»?     * @param orderNo è®¢å•å?     * @return è®¢å•å•†å“åˆ—è¡¨
     */
    @GetMapping("/by-order-no/{orderNo}")
    @ApiOperation("æ ¹æ®è®¢å•å·è·å–å•†å“æ˜ç»?)
    public R<List<Map<String, Object>>> getByOrderNo(@PathVariable("orderNo") String orderNo) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œè¿”å›ç©ºåˆ—è¡?            List<Map<String, Object>> orderItems = new ArrayList<>();
            return R.success(orderItems);
        } catch (Exception e) {
            return R.error("è·å–è®¢å•å•†å“æ˜ç»†å¤±è´¥");
        }
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import java.util.HashMap;
import java.util.Map;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.Map;

/**
 * æ”¯ä»˜æ§åˆ¶å™? */
@RestController
@RequestMapping("/app/payment")
@Api(tags = "æ”¯ä»˜ç®¡ç†")
public class PaymentController {

    // ç§»é™¤äº†å¯¹PaymentServiceçš„ä¾èµ–ï¼Œä½¿ç”¨æ¨¡æ‹Ÿå®ç°

    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     */
    @PostMapping("/create")
    @ApiOperation("åˆ›å»ºæ”¯ä»˜è®¢å•")
    public R<Map<String, Object>> createPayment(@RequestBody Map<String, Object> params) {
        try {
            String orderNo = params.get("orderNo").toString();
            BigDecimal amount = new BigDecimal(params.get("amount").toString());
            
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿæ”¯ä»˜è®¢å•åˆ›å»º
            Map<String, Object> payment = new HashMap<>();
            payment.put("id", 1L);
            payment.put("orderNo", orderNo);
            payment.put("amount", amount);
            payment.put("status", 0);
            return R.success(payment);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * è·å–å¾®ä¿¡æ”¯ä»˜å‚æ•°
     */
    @GetMapping("/wechat/params")
    @ApiOperation("è·å–å¾®ä¿¡æ”¯ä»˜å‚æ•°")
    public R<Map<String, Object>> getWechatPayParams(@RequestParam Long paymentId) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜å‚æ•°
            Map<String, Object> payParams = new HashMap<>();
            payParams.put("appId", "wx1234567890123456");
            payParams.put("timeStamp", String.valueOf(System.currentTimeMillis() / 1000));
            payParams.put("nonceStr", "abcdefg123456");
            payParams.put("package", "prepay_id=wx1234567890123456");
            payParams.put("signType", "MD5");
            payParams.put("paySign", "abcdefg12345678901234567890123456");
            return R.success(payParams);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ
     */
    @PostMapping("/wechat/notify")
    @ApiOperation("å¾®ä¿¡æ”¯ä»˜å›è°ƒæ¥å£")
    public String wechatPayNotify(@RequestBody Map<String, String> notifyData) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œå§‹ç»ˆè¿”å›æˆåŠŸ
            return "<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>";
        } catch (Exception e) {
            return "<xml><return_code><![CDATA[FAIL]]></return_code><return_msg><![CDATA[" + e.getMessage() + "]]></return_msg></xml>";
        }
    }

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?     */
    @GetMapping("/status")
    @ApiOperation("æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?)
    public R<Integer> getPaymentStatus(@RequestParam String orderNo) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œè¿”å›æ¨¡æ‹Ÿæ”¯ä»˜çŠ¶æ€?            Integer status = 0; // 0: æœªæ”¯ä»?            return R.success(status);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * ç”³è¯·é€€æ¬?     */
    @PostMapping("/refund")
    @ApiOperation("ç”³è¯·é€€æ¬?)
    public R<Boolean> refund(@RequestBody Map<String, Object> params) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿé€€æ¬¾æˆåŠ?            return R.success(true);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢æ”¯ä»˜è¯¦æƒ?     */
    @GetMapping("/order/{orderNo}")
    @ApiOperation("æ ¹æ®è®¢å•å·æŸ¥è¯¢æ”¯ä»˜è¯¦æƒ?)
    public R<Map<String, Object>> getPaymentByOrderNo(@PathVariable String orderNo) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿæ”¯ä»˜è¯¦æƒ…
            Map<String, Object> payment = new HashMap<>();
            payment.put("id", 1L);
            payment.put("orderNo", orderNo);
            payment.put("status", 0);
            return R.success(payment);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }
}
package com.heikeji.app.controller;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.common.core.domain.R;
import com.heikeji.app.entity.Product;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import java.util.*;
import java.util.stream.Collectors;

/**
 * å•†å“æ§åˆ¶å™?
 * å¤„ç†å•†å“ç›¸å…³çš„å‰ç«¯è¯·æ±?
 */
@RestController
@RequestMapping("/app/product")
@Api(tags = "å•†å“ç®¡ç†")
public class ProductController {
    private static final Logger log = LoggerFactory.getLogger(ProductController.class);

    // ç§»é™¤ProductServiceä¾èµ–
    
    // æ¨¡æ‹Ÿå•†å“æ•°æ®
    private List<Product> mockProducts = new ArrayList<>();
    
    // åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ?
    public ProductController() {
        for (long i = 1; i <= 50; i++) {
            Product product = new Product();
            product.setId(i);
            product.setName("å•†å“" + i);
            product.setSubtitle("è¿™æ˜¯å•†å“" + i + "çš„å‰¯æ ‡é¢˜");
            product.setPrice(new java.math.BigDecimal(99.99 + i * 10));
            product.setCategoryId(Long.valueOf((i % 5) + 1));
            product.setSales(Integer.valueOf((int)(i * 100)));
            product.setStock(1000);
            product.setImages("/images/product" + i + ".jpg");
            // ç§»é™¤ä¸å­˜åœ¨çš„setDescriptionæ–¹æ³•
            product.setStatus(1);
            product.setDelFlag(0);
            product.setCreateTime(new Date());
            mockProducts.add(product);
        }
    }

    /**
     * è·å–å•†å“è¯¦æƒ…
     * @param productId å•†å“ID
     * @return å•†å“ä¿¡æ¯
     */
    @GetMapping("/detail/{productId}")
    @ApiOperation("è·å–å•†å“è¯¦æƒ…")
    public R<Product> getProductDetail(@PathVariable Long productId) {
        try {
            // æ¨¡æ‹Ÿä»åˆ—è¡¨ä¸­æŸ¥æ‰¾å•†å“
            Optional<Product> optionalProduct = mockProducts.stream()
                    .filter(p -> p.getId().equals(productId))
                    .findFirst();
            
            if (!optionalProduct.isPresent()) {
                return R.error("å•†å“ä¸å­˜åœ?);
            }
            
            return R.success(optionalProduct.get());
        } catch (Exception e) {
            log.error("è·å–å•†å“è¯¦æƒ…å¤±è´¥", e);
            return R.error("è·å–å•†å“è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * è·å–å•†å“åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
     */
    @GetMapping("/list")
    @ApiOperation("è·å–å•†å“åˆ—è¡¨")
    public R<Page<Product>> getProductList(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer limit,
            @RequestParam(required = false) Long categoryId,
            @RequestParam(required = false) String keyword,
            @RequestParam(required = false, defaultValue = "default") String sortType) {
        try {
            // æ¨¡æ‹ŸæŸ¥è¯¢è¿‡æ»¤
            List<Product> filteredProducts = new ArrayList<>(mockProducts);
            
            // åˆ†ç±»ç­›é€?
            if (categoryId != null && categoryId > 0) {
                filteredProducts = filteredProducts.stream()
                        .filter(p -> p.getCategoryId().equals(categoryId))
                        .collect(Collectors.toList());
            }
            
            // å…³é”®è¯æœç´?
            if (keyword != null && !keyword.isEmpty()) {
                final String lowerKeyword = keyword.toLowerCase();
                filteredProducts = filteredProducts.stream()
                        .filter(p -> p.getName().toLowerCase().contains(lowerKeyword) || 
                                (p.getSubtitle() != null && p.getSubtitle().toLowerCase().contains(lowerKeyword)))
                        .collect(Collectors.toList());
            }
            
            // æ’åº
            switch (sortType) {
                case "sales":
                    filteredProducts.sort((p1, p2) -> p2.getSales().compareTo(p1.getSales()));
                    break;
                case "price-asc":
                    filteredProducts.sort(Comparator.comparing(Product::getPrice));
                    break;
                case "price-desc":
                    filteredProducts.sort(Comparator.comparing(Product::getPrice).reversed());
                    break;
                case "newest":
                    filteredProducts.sort((p1, p2) -> p2.getCreateTime().compareTo(p1.getCreateTime()));
                    break;
                default:
                    // é»˜è®¤æ’åº
                    break;
            }
            
            // æ¨¡æ‹Ÿåˆ†é¡µ
            int start = (page - 1) * limit;
            int end = Math.min(start + limit, filteredProducts.size());
            List<Product> pageContent = start < end ? filteredProducts.subList(start, end) : new ArrayList<>();
            
            Page<Product> resultPage = new Page<>(page, limit);
            resultPage.setRecords(pageContent);
            resultPage.setTotal(filteredProducts.size());
            
            return R.success(resultPage);
        } catch (Exception e) {
            log.error("è·å–å•†å“åˆ—è¡¨å¤±è´¥", e);
            return R.error("è·å–å•†å“åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * è·å–çƒ­é—¨å•†å“
     */
    @GetMapping("/hot")
    @ApiOperation("è·å–çƒ­é—¨å•†å“")
    public R<List<Product>> getHotProducts(@RequestParam(defaultValue = "10") Integer limit) {
        try {
            // æ¨¡æ‹ŸæŒ‰é”€é‡æ’åºå¹¶é™åˆ¶æ•°é‡
            List<Product> hotProducts = new ArrayList<>(mockProducts);
            hotProducts.sort((p1, p2) -> p2.getSales().compareTo(p1.getSales()));
            
            int actualLimit = Math.min(limit, hotProducts.size());
            return R.success(hotProducts.subList(0, actualLimit));
        } catch (Exception e) {
            log.error("è·å–çƒ­é—¨å•†å“å¤±è´¥", e);
            return R.error("è·å–çƒ­é—¨å•†å“å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * æ‰¹é‡è·å–å•†å“ä¿¡æ¯
     */
    @PostMapping("/batch")
    @ApiOperation("æ‰¹é‡è·å–å•†å“ä¿¡æ¯")
    public R<List<Product>> getProductsByIds(@RequestBody List<Long> productIds) {
        try {
            // æ¨¡æ‹Ÿæ‰¹é‡æŸ¥è¯¢
            List<Product> products = mockProducts.stream()
                    .filter(p -> productIds.contains(p.getId()))
                    .collect(Collectors.toList());
            
            return R.success(products);
        } catch (Exception e) {
            log.error("æ‰¹é‡è·å–å•†å“ä¿¡æ¯å¤±è´¥", e);
            return R.error("æ‰¹é‡è·å–å•†å“ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.app.dto.TakeoutOrderDTO;
import com.heikeji.app.entity.TakeoutOrder;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import lombok.extern.slf4j.Slf4j;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.AtomicLong;

/**
 * å¤–å–è®¢å•æ§åˆ¶å™¨ï¼ˆå°ç¨‹åºç«¯ï¼? */
@Slf4j
@RestController
@RequestMapping("/app/takeout")
public class TakeoutController {

    // ç§»é™¤TakeoutOrderServiceä¾èµ–
    
    // æ¨¡æ‹Ÿè®¢å•æ•°æ®å­˜å‚¨
    private Map<String, TakeoutOrder> mockOrders = new HashMap<>();
    private AtomicLong orderIdGenerator = new AtomicLong(1);
    
    /**
     * åˆ›å»ºå¤–å–è®¢å•
     */
    @PostMapping("/order/create")
    public R<String> createOrder(@Valid @RequestBody TakeoutOrderDTO dto, HttpServletRequest request) {
        try {
            Long userId = 1L; // æ¨¡æ‹Ÿç”¨æˆ·ID
            String orderNo = "TO" + System.currentTimeMillis();
            
            TakeoutOrder order = new TakeoutOrder();
            order.setId(orderIdGenerator.getAndIncrement());
            order.setOrderNo(orderNo);
            order.setUserId(userId);
            // ç§»é™¤ä¸å­˜åœ¨çš„setTotalAmountæ–¹æ³•
            // ç§»é™¤ä¸å­˜åœ¨çš„setDeliveryAddresså’ŒsetPhoneæ–¹æ³•
            order.setStatus(1); // å¾…æ”¯ä»?            order.setCreateTime(new Date());
            
            mockOrders.put(orderNo, order);
            
            return R.success("è®¢å•åˆ›å»ºæˆåŠŸ", orderNo);
        } catch (Exception e) {
            log.error("åˆ›å»ºå¤–å–è®¢å•å¤±è´¥", e);
            return R.error("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * æŸ¥è¯¢å¤–å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/order/{orderNo}")
    public R<TakeoutOrder> getOrder(@PathVariable String orderNo) {
        try {
            TakeoutOrder order = mockOrders.get(orderNo);
            if (order == null) {
                return R.error("è®¢å•ä¸å­˜åœ?);
            }
            return R.success(order);
        } catch (Exception e) {
            log.error("æŸ¥è¯¢å¤–å–è®¢å•è¯¦æƒ…å¤±è´¥", e);
            return R.error("æŸ¥è¯¢è®¢å•è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢å¤–å–è®¢å•
     */
    @GetMapping("/order/page")
    public R<Page<TakeoutOrder>> page(@RequestParam(defaultValue = "1") long pageNo,
                                     @RequestParam(defaultValue = "10") long pageSize,
                                     @RequestParam(required = false) String orderNo,
                                     HttpServletRequest request) {
        try {
            Long userId = 1L; // æ¨¡æ‹Ÿç”¨æˆ·ID
            
            // æ¨¡æ‹Ÿè®¢å•åˆ—è¡¨
            List<TakeoutOrder> orderList = new ArrayList<>(mockOrders.values());
            
            // è®¢å•å·ç­›é€?            if (orderNo != null && !orderNo.isEmpty()) {
                orderList.removeIf(order -> !order.getOrderNo().contains(orderNo));
            }
            
            // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
            orderList.sort((o1, o2) -> o2.getCreateTime().compareTo(o1.getCreateTime()));
            
            // æ¨¡æ‹Ÿåˆ†é¡µ
            Page<TakeoutOrder> page = new Page<>(pageNo, pageSize);
            int start = (int) ((pageNo - 1) * pageSize);
            int end = Math.min(start + (int) pageSize, orderList.size());
            
            if (start < orderList.size()) {
                page.setRecords(orderList.subList(start, end));
            } else {
                page.setRecords(new ArrayList<>());
            }
            
            page.setTotal(orderList.size());
            
            return R.success(page);
        } catch (Exception e) {
            log.error("åˆ†é¡µæŸ¥è¯¢å¤–å–è®¢å•å¤±è´¥", e);
            return R.error("æŸ¥è¯¢è®¢å•åˆ—è¡¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/order/cancel/{orderNo}")
    public R<Boolean> cancelOrder(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            TakeoutOrder order = mockOrders.get(orderNo);
            if (order == null) {
                return R.error("è®¢å•ä¸å­˜åœ?);
            }
            
            // æ¨¡æ‹Ÿå–æ¶ˆè®¢å•
            order.setStatus(4); // å·²å–æ¶?            order.setUpdateTime(new Date());
            
            return R.success(true);
        } catch (Exception e) {
            log.error("å–æ¶ˆè®¢å•å¤±è´¥", e);
            return R.error("å–æ¶ˆè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * æ¥å—è®¢å•ï¼ˆé…é€å‘˜ï¼?     */
    @PostMapping("/order/accept/{orderNo}")
    public R<Boolean> acceptOrder(@PathVariable String orderNo, HttpServletRequest request) {
        try {
            TakeoutOrder order = mockOrders.get(orderNo);
            if (order == null) {
                return R.error("è®¢å•ä¸å­˜åœ?);
            }
            
            // æ¨¡æ‹Ÿæ¥å—è®¢å•
            order.setStatus(3); // é…é€ä¸­
            order.setUpdateTime(new Date());
            // ç§»é™¤ä¸å­˜åœ¨çš„setDeliveryIdæ–¹æ³•
            
            return R.success(true);
        } catch (Exception e) {
            log.error("æ¥å—è®¢å•å¤±è´¥", e);
            return R.error("æ¥å—è®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * ç¡®è®¤æ”¶è´§
     */
    @PostMapping("/order/confirm/{orderNo}")
    public R<Boolean> confirmDelivery(@PathVariable String orderNo) {
        try {
            TakeoutOrder order = mockOrders.get(orderNo);
            if (order == null) {
                return R.error("è®¢å•ä¸å­˜åœ?);
            }
            
            // æ¨¡æ‹Ÿç¡®è®¤æ”¶è´§
            order.setStatus(5); // å·²å®Œæˆ?            order.setUpdateTime(new Date());
            
            return R.success(true);
        } catch (Exception e) {
            log.error("ç¡®è®¤æ”¶è´§å¤±è´¥", e);
            return R.error("ç¡®è®¤æ”¶è´§å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    /**
     * æ¨¡æ‹Ÿä»tokenè·å–ç”¨æˆ·ID
     */
    private Long getUserIdFromToken(HttpServletRequest request) {
        // è¿™é‡Œè¿”å›å›ºå®šå€¼ï¼Œå®é™…åº”è¯¥ä»tokenä¸­è§£æ?        return 1L;
    }
}


package com.heikeji.app.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.app.dto.TakeoutOrderDTO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

/**
 * å¤–å–è®¢å•æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/order")
@Api(tags = "å¤–å–è®¢å•ç®¡ç†")
public class TakeoutOrderController {

    // ç§»é™¤TakeoutOrderServiceä¾èµ–

    /**
     * åˆ›å»ºå¤–å–è®¢å•
     */
    @PostMapping("/create")
    @ApiOperation("åˆ›å»ºå¤–å–è®¢å•")
    public R<?> createOrder(@RequestBody TakeoutOrderDTO orderDTO) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œç”Ÿæˆæ¨¡æ‹Ÿè®¢å•ID
            String orderId = "TO" + System.currentTimeMillis();
            System.out.println("åˆ›å»ºå¤–å–è®¢å•: " + orderId);
            return R.success(orderId);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * æŸ¥è¯¢è®¢å•è¯¦æƒ…
     */
    @GetMapping("/detail/{orderId}")
    @ApiOperation("æŸ¥è¯¢è®¢å•è¯¦æƒ…")
    public R<?> getOrderDetail(@PathVariable String orderId) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºæ¨¡æ‹Ÿè®¢å•è¯¦æƒ…
            java.util.Map<String, Object> detail = new java.util.HashMap<>();
            detail.put("orderId", orderId);
            detail.put("status", 1);
            detail.put("createTime", new java.util.Date());
            return R.success(detail);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * éª‘æ‰‹æ¥å•
     */
    @PostMapping("/accept/{orderId}")
    @ApiOperation("éª‘æ‰‹æ¥å•")
    public R<?> acceptOrder(@PathVariable String orderId, @RequestParam String riderId) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿæ¥å•æˆåŠŸ
            System.out.println("éª‘æ‰‹æ¥å•: orderId=" + orderId + ", riderId=" + riderId);
            return R.success();
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * æ›´æ–°é…é€çŠ¶æ€?     */
    @PostMapping("/update-status")
    @ApiOperation("æ›´æ–°é…é€çŠ¶æ€?)
    public R<?> updateDeliveryStatus(@RequestParam String orderId, @RequestParam Integer status) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿæ›´æ–°çŠ¶æ€?            System.out.println("æ›´æ–°è®¢å•çŠ¶æ€? orderId=" + orderId + ", status=" + status);
            return R.success();
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/cancel/{orderId}")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<?> cancelOrder(@PathVariable String orderId, @RequestParam String reason) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿå–æ¶ˆè®¢å•
            System.out.println("å–æ¶ˆè®¢å•: orderId=" + orderId + ", reason=" + reason);
            return R.success();
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * åˆ†é…å¤–å–æŸœæ ¼å?     */
    @PostMapping("/allocate-locker")
    @ApiOperation("åˆ†é…å¤–å–æŸœæ ¼å?)
    public R<?> allocateLocker(@RequestParam String orderId, @RequestParam String lockerCode) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œæ¨¡æ‹Ÿåˆ†é…æˆåŠŸ
            String cellNo = "A1";
            System.out.println("åˆ†é…å¤–å–æŸ? orderId=" + orderId + ", lockerCode=" + lockerCode + ", cellNo=" + cellNo);
            return R.success(cellNo);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }

    /**
     * æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/user/list")
    @ApiOperation("æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨")
    public R<?> getUserOrders(@RequestParam String userId, 
                                   @RequestParam(required = false) Integer status, 
                                   @RequestParam(defaultValue = "1") Integer page, 
                                   @RequestParam(defaultValue = "10") Integer size) {
        try {
            // ç®€åŒ–å¤„ç†ï¼Œåˆ›å»ºç©ºçš„å“åº”å¯¹è±¡
            java.util.Map<String, Object> result = new java.util.HashMap<>();
            result.put("list", new java.util.ArrayList<>());
            result.put("total", 0);
            return R.success(result);
        } catch (Exception e) {
            return R.error(e.getMessage());
        }
    }
}
package com.heikeji.app.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

/**
 * å¤–å–è®¢å•DTO
 */
@Data
public class TakeoutOrderDTO {
    
    /** å•†å®¶ID */
    private Long merchantId;
    
    /** é…é€æ–¹å¼ï¼š1-å¤–å–æŸœï¼Œ2-ç‰¹æ®Šåœ°ç‚¹ï¼?-é€åˆ°å¯å®¤ */
    private Integer deliveryType;
    
    /** å¤–å–æŸœç¼–ç ï¼ˆé…é€æ–¹å¼ä¸ºå¤–å–æŸœæ—¶ä½¿ç”¨ï¼?*/
    private String deliveryLockerCode;
    
    /** ç‰¹æ®Šé…é€åœ°ç‚¹æè¿?*/
    private String deliverySpecialPlace;
    
    /** å¯å®¤æ¥¼æ ‹ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormBuilding;
    
    /** å¯å®¤æˆ¿é—´å·ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormRoom;
    
    /** æ”¶è´§äººå§“å?*/
    private String receiverName;
    
    /** æ”¶è´§äººç”µè¯?*/
    private String receiverPhone;
    
    /** æ”¶è´§åœ°å€ */
    private String receiverAddress;
    
    /** è®¢å•å•†å“åˆ—è¡¨ */
    private List<OrderItemDTO> orderItems;
    
    /** è®¢å•å¤‡æ³¨ */
    private String remark;
    
    /** è®¢å•å•†å“DTO */
    @Data
    public static class OrderItemDTO {
        private Long productId;
        private Integer quantity;
        private BigDecimal price;
    }
}
package com.heikeji.app.entity;

import lombok.Data;

import java.io.Serializable;

/**
 * è´­ç‰©è½¦å®ä½“ç±»
 */
@Data
public class Cart implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * ID
     */
    private Long id;
    
    /**
     * ç”¨æˆ·ID
     */
    private Long userId;
    
    /**
     * å•†å“ID
     */
    private Long productId;
    
    /**
     * å•†å“æ•°é‡
     */
    private Integer quantity;
}
package com.heikeji.app.entity;

import lombok.Data;

import java.util.Date;

/**
 * å•†å“åˆ†ç±»å®ä½“ç±? */
@Data
public class Category {
    private Long id;
    private String name;
    private String icon;
    private Integer sortOrder;
    private Integer status;
    private Date createTime;
    private Date updateTime;
    private Integer delFlag;
}
package com.heikeji.app.entity;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * å¤–å–æŸœå®ä½? */
@Data
public class DeliveryLocker implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    
    /** å¤–å–æŸœç¼–ç ?*/
    private String lockerCode;
    
    /** å¤–å–æŸœåç§?*/
    private String name;
    
    /** ä½ç½®æè¿° */
    private String location;
    
    /** æ ¡åŒº */
    private String campusArea;
    
    /** æ€»æ ¼å£æ•° */
    private Integer totalCells;
    
    /** å¯ç”¨æ ¼å£æ•?*/
    private Integer availableCells;
    
    /** çŠ¶æ€ï¼š0-æ­£å¸¸ï¼?-æ•…éšœ */
    private Integer status;
    
    /** åˆ›å»ºæ—¶é—´ */
    private Date createTime;
    
    /** æ›´æ–°æ—¶é—´ */
    private Date updateTime;
}
package com.heikeji.app.entity;

import lombok.Data;

import java.math.BigDecimal;
import java.util.Date;

/**
 * å•†å“å®ä½“ç±? */
@Data
public class Product {
    private Long id;
    private Long merchantId;
    private Long categoryId;
    private String name;
    private String subtitle;
    private String mainImage;
    private String images;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer stock;
    private Integer sales;
    private String detail;
    private Integer status;
    private Integer sortOrder;
    private Date createTime;
    private Date updateTime;
    private Integer delFlag;
}
package com.heikeji.app.entity;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * å¤–å–è®¢å•å®ä½“
 */
@Data
public class TakeoutOrder implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    
    /** å…³è”è®¢å•ID */
    private Long orderId;
    
    /** è®¢å•å?*/
    private String orderNo;
    
    /** å•†å®¶ID */
    private Long merchantId;
    
    /** ç”¨æˆ·ID */
    private Long userId;
    
    /** é…é€æ–¹å¼ï¼š1-å¤–å–æŸœï¼Œ2-ç‰¹æ®Šåœ°ç‚¹ï¼?-é€åˆ°å¯å®¤ */
    private Integer deliveryType;
    
    /** å¤–å–æŸœç¼–ç ï¼ˆé…é€æ–¹å¼ä¸ºå¤–å–æŸœæ—¶ä½¿ç”¨ï¼?*/
    private String deliveryLockerCode;
    
    /** ç‰¹æ®Šé…é€åœ°ç‚¹æè¿°ï¼ˆå¦‚ï¼šå¯å®¤æ¥¼é—¨å£é¥®æ–™æœºï¼?*/
    private String deliverySpecialPlace;
    
    /** å¯å®¤æ¥¼æ ‹ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormBuilding;
    
    /** å¯å®¤æˆ¿é—´å·ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormRoom;
    
    /** é…é€å‘˜ID */
    private Long deliveryPersonId;
    
    /** é…é€å‘˜å§“å */
    private String deliveryPersonName;
    
    /** é…é€å‘˜ç”µè¯ */
    private String deliveryPersonPhone;
    
    /** æ”¶è´§äººå§“å?*/
    private String receiverName;
    
    /** æ”¶è´§äººç”µè¯?*/
    private String receiverPhone;
    
    /** æ”¶è´§åœ°å€ */
    private String receiverAddress;
    
    /** é¢„è®¡é€è¾¾æ—¶é—´ */
    private Date estimatedTime;
    
    /** å®é™…é€è¾¾æ—¶é—´ */
    private Date actualTime;
    
    /** é…é€çŠ¶æ€ï¼š0-å¾…æ¥å•ï¼Œ1-å·²æ¥å•ï¼Œ2-é…é€ä¸­ï¼?-å·²é€è¾¾ï¼?-å·²å–æ¶?*/
    private Integer status;
    
    /** å¤‡æ³¨ */
    private String remark;
    
    /** åˆ›å»ºæ—¶é—´ */
    private Date createTime;
    
    /** æ›´æ–°æ—¶é—´ */
    private Date updateTime;
}
package com.heikeji.app.interceptor;

import com.heikeji.common.security.utils.JwtUtils;
import io.jsonwebtoken.Claims;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.servlet.HandlerInterceptor;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

/**
 * JWTè®¤è¯æ‹¦æˆªå™? * éªŒè¯è¯·æ±‚ä¸­çš„JWT tokenï¼Œæå–ç”¨æˆ·ä¿¡æ? */
public class JwtAuthenticationInterceptor implements HandlerInterceptor {

    private static final Logger log = LoggerFactory.getLogger(JwtAuthenticationInterceptor.class);
    
    // JWT tokenåœ¨headerä¸­çš„key
    private static final String AUTHORIZATION_HEADER = "Authorization";
    // Bearer tokenå‰ç¼€
    private static final String BEARER_PREFIX = "Bearer ";
    // è¯·æ±‚å±æ€§ä¸­å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ?    private static final String USER_INFO_ATTRIBUTE = "userInfo";
    // è¯·æ±‚å±æ€§ä¸­å­˜å‚¨çš„ç”¨æˆ·ID
    private static final String USER_ID_ATTRIBUTE = "userId";

    /**
     * åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰éªŒè¯JWT token
     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        try {
            // è·å–Authorization header
            String authorizationHeader = request.getHeader(AUTHORIZATION_HEADER);
            
            if (authorizationHeader == null || !authorizationHeader.startsWith(BEARER_PREFIX)) {
                log.debug("è¯·æ±‚ä¸­ç¼ºå°‘æœ‰æ•ˆçš„Authorization header");
                return true; // ç»§ç»­å¤„ç†ï¼Œè®©æ§åˆ¶å™¨å†³å®šæ˜¯å¦éœ€è¦è®¤è¯?            }
            
            // æå–token
            String token = authorizationHeader.substring(BEARER_PREFIX.length());
            
            if (token.isEmpty()) {
                log.debug("Authorization headerä¸­çš„tokenä¸ºç©º");
                return true;
            }
            
            // éªŒè¯tokenå¹¶è·å–ç”¨æˆ·ä¿¡æ?            Claims claims = JwtUtils.getClaimsFromToken(token);
            
            if (claims != null) {
                // å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°è¯·æ±‚å±æ€§ä¸­
                request.setAttribute(USER_INFO_ATTRIBUTE, claims);
                
                // æå–å¹¶å­˜å‚¨ç”¨æˆ·ID
                Object userIdObj = claims.get("userId");
                if (userIdObj != null) {
                    try {
                        Long userId = Long.valueOf(userIdObj.toString());
                        request.setAttribute(USER_ID_ATTRIBUTE, userId);
                        log.debug("JWTéªŒè¯æˆåŠŸï¼Œç”¨æˆ·ID: {}", userId);
                    } catch (NumberFormatException e) {
                        log.warn("æ— æ³•è§£æç”¨æˆ·ID: {}", userIdObj);
                    }
                }
                
                // è®°å½•æˆåŠŸéªŒè¯çš„è¯·æ±?                log.debug("JWT tokenéªŒè¯æˆåŠŸ");
            } else {
                log.debug("JWT tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
            }
            
        } catch (Exception e) {
            // è®°å½•JWTéªŒè¯è¿‡ç¨‹ä¸­çš„å¼‚å¸¸ï¼Œä½†ä¸é˜»æ­¢è¯·æ±‚ç»§ç»­å¤„ç?            log.warn("JWTéªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸? {}", e.getMessage());
        }
        
        return true; // ç»§ç»­å¤„ç†è¯·æ±‚
    }

    /**
     * ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·ID
     */
    public static Long getCurrentUserId(HttpServletRequest request) {
        Object userId = request.getAttribute(USER_ID_ATTRIBUTE);
        if (userId instanceof Long) {
            return (Long) userId;
        }
        return null;
    }

    /**
     * ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
     */
    public static Claims getCurrentUserInfo(HttpServletRequest request) {
        Object userInfo = request.getAttribute(USER_INFO_ATTRIBUTE);
        if (userInfo instanceof Claims) {
            return (Claims) userInfo;
        }
        return null;
    }

    /**
     * æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²è®¤è¯
     */
    public static boolean isAuthenticated(HttpServletRequest request) {
        return getCurrentUserId(request) != null;
    }
}
package com.heikeji.app.interceptor;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.servlet.HandlerInterceptor;
import org.springframework.web.servlet.ModelAndView;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;
import java.util.UUID;

/**
 * è¯·æ±‚æ—¥å¿—æ‹¦æˆªå™? * è®°å½•è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯·æ±‚è·¯å¾„ã€å‚æ•°ã€å¤„ç†æ—¶é—´ç­‰
 * æš‚æ—¶ä¸æ³¨å†Œä¸ºSpring Beanä»¥é¿å…ä¾èµ–é—®é¢? */
public class RequestLogInterceptor implements HandlerInterceptor {

    private static final Logger log = LoggerFactory.getLogger(RequestLogInterceptor.class);
    
    // è¯·æ±‚å¼€å§‹æ—¶é—´çš„å±æ€§å
    private static final String REQUEST_START_TIME = "requestStartTime";
    // è¯·æ±‚IDçš„å±æ€§å
    private static final String REQUEST_ID = "requestId";
    
    // æ•æ„Ÿå‚æ•°åˆ—è¡¨ï¼Œè¿™äº›å‚æ•°ä¸ä¼šè¢«æ—¥å¿—è®°å½•
    private static final Set<String> SENSITIVE_PARAMS = new HashSet<>(Arrays.asList(
            "password", "token", "auth", "secret", "key"
    ));

    /**
     * è¯·æ±‚å¤„ç†å‰è°ƒç”?     */
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // ç”Ÿæˆè¯·æ±‚ID
        String requestId = UUID.randomUUID().toString().substring(0, 8);
        request.setAttribute(REQUEST_ID, requestId);
        
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—?        long startTime = System.currentTimeMillis();
        request.setAttribute(REQUEST_START_TIME, startTime);
        
        // è·å–å®¢æˆ·ç«¯IP
        String clientIp = getClientIp(request);
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯ï¼Œä½†ä¸è®°å½•æ•æ„Ÿå‚æ•?        StringBuilder logMessage = new StringBuilder();
        logMessage.append("[è¯·æ±‚å¼€å§‹] [ID:")
                .append(requestId)
                .append("] [æ—¶é—´:")
                .append(LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME))
                .append("] [IP:")
                .append(clientIp)
                .append("] [æ–¹æ³•:")
                .append(request.getMethod())
                .append("] [è·¯å¾„:")
                .append(request.getRequestURI());
        
        // è®°å½•æŸ¥è¯¢å‚æ•°ï¼Œä½†è¿‡æ»¤æ•æ„Ÿå‚æ•°
        String queryString = request.getQueryString();
        if (queryString != null && !queryString.isEmpty()) {
            logMessage.append("?").append(filterSensitiveParams(queryString));
        }
        
        log.info(logMessage.toString());
        
        return true;
    }

    /**
     * è¯·æ±‚å¤„ç†åè°ƒç”¨ï¼Œä½†åœ¨è§†å›¾æ¸²æŸ“ä¹‹å‰
     */
    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, 
                           ModelAndView modelAndView) {
        // è¿™é‡Œå¯ä»¥åœ¨æ§åˆ¶å™¨å¤„ç†å®Œè¯·æ±‚åæ‰§è¡Œä¸€äº›æ“ä½?        // ä½†é€šå¸¸ä¸éœ€è¦åœ¨è¿™é‡Œè®°å½•æ—¥å¿—ï¼Œä¸»è¦æ—¥å¿—åœ¨afterCompletionä¸­è®°å½?    }

    /**
     * è¯·æ±‚å¤„ç†å®Œæˆåè°ƒç”¨ï¼ŒåŒ…æ‹¬è§†å›¾æ¸²æŸ“å®Œæˆ
     */
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, 
                               Exception ex) {
        // è·å–è¯·æ±‚å¼€å§‹æ—¶é—?        Long startTime = (Long) request.getAttribute(REQUEST_START_TIME);
        if (startTime == null) {
            startTime = System.currentTimeMillis();
        }
        
        // è®¡ç®—å¤„ç†æ—¶é—´
        long endTime = System.currentTimeMillis();
        long processTime = endTime - startTime;
        
        // è·å–è¯·æ±‚ID
        String requestId = (String) request.getAttribute(REQUEST_ID);
        if (requestId == null) {
            requestId = "unknown";
        }
        
        // è·å–å“åº”çŠ¶æ€ç 
        int statusCode = response.getStatus();
        
        // è®°å½•æ—¥å¿—
        StringBuilder logMessage = new StringBuilder();
        logMessage.append("[è¯·æ±‚ç»“æŸ] [ID:")
                .append(requestId)
                .append("] [è€—æ—¶:")
                .append(processTime)
                .append("ms] [çŠ¶æ€?")
                .append(statusCode);
        
        // å¦‚æœæœ‰å¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸ä¿¡æ¯
        if (ex != null) {
            logMessage.append("] [å¼‚å¸¸:")
                    .append(ex.getClass().getSimpleName())
                    .append(":")
                    .append(ex.getMessage());
            log.error(logMessage.toString(), ex);
        } else {
            logMessage.append("]");
            // æ ¹æ®å“åº”çŠ¶æ€ç å†³å®šæ—¥å¿—çº§åˆ«
            if (statusCode >= 500) {
                log.error(logMessage.toString());
            } else if (statusCode >= 400) {
                log.warn(logMessage.toString());
            } else {
                log.info(logMessage.toString());
            }
        }
    }

    /**
     * è·å–å®¢æˆ·ç«¯çœŸå®IPåœ°å€
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        
        // å¦‚æœæ˜¯å¤šçº§ä»£ç†ï¼Œå–ç¬¬ä¸€ä¸ªIP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        
        return ip;
    }

    /**
     * è¿‡æ»¤æŸ¥è¯¢å‚æ•°ä¸­çš„æ•æ„Ÿä¿¡æ¯
     */
    private String filterSensitiveParams(String queryString) {
        StringBuilder filteredQuery = new StringBuilder();
        String[] params = queryString.split("&");
        
        for (int i = 0; i < params.length; i++) {
            String param = params[i];
            String[] keyValue = param.split("=", 2);
            
            if (keyValue.length > 0) {
                String key = keyValue[0];
                
                if (isSensitiveParam(key)) {
                    filteredQuery.append(key).append("=***");
                } else {
                    filteredQuery.append(param);
                }
                
                if (i < params.length - 1) {
                    filteredQuery.append("&");
                }
            }
        }
        
        return filteredQuery.toString();
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæ•æ„Ÿå‚æ•?     */
    private boolean isSensitiveParam(String paramName) {
        return SENSITIVE_PARAMS.contains(paramName.toLowerCase());
    }
}
package com.heikeji.mall.app.constant;

import java.util.HashMap;
import java.util.Map;

/**
 * è®¢å•ç›¸å…³å¸¸é‡ç±? */
public class OrderConstants {
    // è®¢å•çŠ¶æ€?    public static final Integer ORDER_STATUS_UNPAID = 0; // å¾…ä»˜æ¬?    public static final Integer ORDER_STATUS_PAID = 1; // å·²ä»˜æ¬?    public static final Integer ORDER_STATUS_SHIPPED = 2; // å·²å‘è´?    public static final Integer ORDER_STATUS_COMPLETED = 3; // å·²å®Œæˆ?    public static final Integer ORDER_STATUS_CANCELLED = 4; // å·²å–æ¶?    public static final Integer ORDER_STATUS_REFUNDED = 5; // å·²é€€æ¬?    
    // æ”¯ä»˜çŠ¶æ€?    public static final Integer PAY_STATUS_UNPAID = 0; // æœªæ”¯ä»?    public static final Integer PAY_STATUS_PAID = 1; // å·²æ”¯ä»?    public static final Integer PAY_STATUS_REFUNDED = 2; // å·²é€€æ¬?    
    // æ”¯ä»˜æ–¹å¼
    public static final Integer PAY_TYPE_ALIPAY = 1; // æ”¯ä»˜å®?    public static final Integer PAY_TYPE_WECHAT = 2; // å¾®ä¿¡æ”¯ä»˜
    
    // é…é€æ–¹å¼?    public static final Integer DELIVERY_TYPE_NORMAL = 1; // æ™®é€šå¿«é€?    public static final Integer DELIVERY_TYPE_TAKEOUT = 2; // å¤–å–é…é€?    
    // è®¢å•çŠ¶æ€æ–‡æœ¬æ˜ å°?    public static final Map<Integer, String> ORDER_STATUS_MAP = new HashMap<Integer, String>() {{
        put(ORDER_STATUS_UNPAID, "å¾…ä»˜æ¬?);
        put(ORDER_STATUS_PAID, "å·²ä»˜æ¬?);
        put(ORDER_STATUS_SHIPPED, "å·²å‘è´?);
        put(ORDER_STATUS_COMPLETED, "å·²å®Œæˆ?);
        put(ORDER_STATUS_CANCELLED, "å·²å–æ¶?);
        put(ORDER_STATUS_REFUNDED, "å·²é€€æ¬?);
    }};
    
    // æ”¯ä»˜æ–¹å¼æ–‡æœ¬æ˜ å°„
    public static final Map<Integer, String> PAY_TYPE_MAP = new HashMap<Integer, String>() {{
        put(PAY_TYPE_ALIPAY, "æ”¯ä»˜å®?);
        put(PAY_TYPE_WECHAT, "å¾®ä¿¡æ”¯ä»˜");
    }};
    
    // é…é€æ–¹å¼æ–‡æœ¬æ˜ å°?    public static final Map<Integer, String> DELIVERY_TYPE_MAP = new HashMap<Integer, String>() {{
        put(DELIVERY_TYPE_NORMAL, "æ™®é€šå¿«é€?);
        put(DELIVERY_TYPE_TAKEOUT, "å¤–å–é…é€?);
    }};
    
    /**
     * è·å–è®¢å•çŠ¶æ€æ–‡æœ?     * @param status è®¢å•çŠ¶æ€?     * @return è®¢å•çŠ¶æ€æ–‡æœ?     */
    public static String getOrderStatusText(Integer status) {
        return ORDER_STATUS_MAP.getOrDefault(status, "æœªçŸ¥çŠ¶æ€?);
    }
    
    /**
     * è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬
     * @param payType æ”¯ä»˜æ–¹å¼
     * @return æ”¯ä»˜æ–¹å¼æ–‡æœ¬
     */
    public static String getPayTypeText(Integer payType) {
        return PAY_TYPE_MAP.getOrDefault(payType, "æœªçŸ¥æ–¹å¼");
    }
    
    /**
     * è·å–é…é€æ–¹å¼æ–‡æœ?     * @param deliveryType é…é€æ–¹å¼?     * @return é…é€æ–¹å¼æ–‡æœ?     */
    public static String getDeliveryTypeText(Integer deliveryType) {
        return DELIVERY_TYPE_MAP.getOrDefault(deliveryType, "æœªçŸ¥æ–¹å¼");
    }
}
package com.heikeji.common.api;

import lombok.Data;
import java.io.Serializable;

/**
 * ç»Ÿä¸€å“åº”æ¶ˆæ¯ä½? * ç”¨äºAPIæ¥å£è¿”å›æ ‡å‡†æ ¼å¼çš„æ•°æ? */
@Data
public class ResponseMessage<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * çŠ¶æ€ç 
     */
    private Integer code;

    /**
     * æ¶ˆæ¯å†…å®¹
     */
    private String message;

    /**
     * æ•°æ®å¯¹è±¡
     */
    private T data;

    /**
     * æ—¶é—´æˆ?     */
    private long timestamp;

    public ResponseMessage() {
        this.timestamp = System.currentTimeMillis();
    }

    /**
     * æˆåŠŸå“åº”
     */
    public static <T> ResponseMessage<T> success(T data) {
        ResponseMessage<T> response = new ResponseMessage<>();
        response.setCode(200);
        response.setMessage("success");
        response.setData(data);
        return response;
    }

    /**
     * æˆåŠŸå“åº”ï¼ˆæ— æ•°æ®ï¼?     */
    public static <T> ResponseMessage<T> success() {
        return success(null);
    }

    /**
     * é”™è¯¯å“åº”
     */
    public static <T> ResponseMessage<T> error(Integer code, String message) {
        ResponseMessage<T> response = new ResponseMessage<>();
        response.setCode(code);
        response.setMessage(message);
        return response;
    }

    /**
     * é”™è¯¯å“åº”ï¼ˆé»˜è®¤é”™è¯¯ç ï¼?     */
    public static <T> ResponseMessage<T> error(String message) {
        return error(500, message);
    }
}
package com.heikeji.common.api;

/**
 * ç»“æœç æšä¸¾ç±»
 * å®šä¹‰APIæ¥å£è¿”å›çš„æ ‡å‡†çŠ¶æ€ç 
 */
public enum ResultCode {
    /**
     * æˆåŠŸ
     */
    SUCCESS(200, "æ“ä½œæˆåŠŸ"),
    
    /**
     * å¤±è´¥
     */
    FAIL(500, "æ“ä½œå¤±è´¥"),
    
    /**
     * æœªæˆæ?     */
    UNAUTHORIZED(401, "æœªæˆæ?),
    
    /**
     * ç¦æ­¢è®¿é—®
     */
    FORBIDDEN(403, "ç¦æ­¢è®¿é—®"),
    
    /**
     * èµ„æºä¸å­˜åœ?     */
    NOT_FOUND(404, "èµ„æºä¸å­˜åœ?),
    
    /**
     * è¯·æ±‚å‚æ•°é”™è¯¯
     */
    PARAM_ERROR(400, "è¯·æ±‚å‚æ•°é”™è¯¯"),
    
    /**
     * ç³»ç»Ÿå†…éƒ¨é”™è¯¯
     */
    SYSTEM_ERROR(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    
    private final int code;
    private final String message;
    
    ResultCode(int code, String message) {
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public String getMessage() {
        return message;
    }
}
package com.heikeji.common.core.annotation;

import java.lang.annotation.*;

/**
 * æ¥å£é™æµæ³¨è§£
 * ç”¨äºæ ‡è®°éœ€è¦é™æµçš„æ¥å£æ–¹æ³•
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RateLimiter {
    /**
     * é™æµæ—¶é—´çª—å£ï¼ˆç§’ï¼?     */
    int timeWindow() default 1;
    
    /**
     * æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°
     */
    int maxCount() default 10;
    
    /**
     * é™æµæç¤ºä¿¡æ¯
     */
    String message() default "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•";
    
    /**
     * é™æµç±»å‹ï¼šipã€userã€method
     */
    String limitType() default "ip";
}
package com.heikeji.common.core.annotation;

import java.lang.annotation.*;

/**
 * æƒé™éªŒè¯æ³¨è§£
 * ç”¨äºæ ‡è®°éœ€è¦æƒé™éªŒè¯çš„æ¥å£æ–¹æ³•
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RequiresPermission {
    /**
     * æƒé™ç¼–ç 
     * æ ¼å¼ï¼šæ¨¡å?æ“ä½œ:å¯¹è±¡ï¼Œä¾‹å¦‚ï¼šuser:add:admin
     */
    String[] value() default {};
    
    /**
     * æƒé™ç±»å‹
     * - single: éœ€è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæƒé™?     * - all: éœ€è¦æ»¡è¶³æ‰€æœ‰æƒé™?     */
    String type() default "single";
    
    /**
     * éªŒè¯å¤±è´¥æç¤ºä¿¡æ¯
     */
    String message() default "æ— æƒé™è®¿é—®æ­¤èµ„æº";
}
package com.heikeji.common.core.aspect;

import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.Objects;

/**
 * APIæ¥å£æ€§èƒ½ç›‘æ§åˆ‡é¢
 * ç›‘æ§æ‰€æœ‰Controlleræ–¹æ³•çš„æ‰§è¡Œæ—¶é—´å’Œå‚æ•°ä¿¡æ¯
 */
@Slf4j
@Aspect
@Component
public class ApiPerformanceAspect {

    // å®šä¹‰åˆ‡ç‚¹ï¼šç›‘æ§æ‰€æœ‰ControlleråŒ…ä¸‹çš„æ–¹æ³?    @Pointcut("execution(* com.heikeji.*.*.controller..*.*(..))")
    public void apiPointCut() {
    }

    // æ‰§è¡Œç¯ç»•é€šçŸ¥
    @Around("apiPointCut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        // è·å–è¯·æ±‚ä¿¡æ¯
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        
        // è·å–æ–¹æ³•ç­¾å
        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();
        String className = method.getDeclaringClass().getName();
        String methodName = method.getName();
        String uri = request.getRequestURI();
        String methodType = request.getMethod();
        String ip = getClientIp(request);
        
        // è®°å½•è¯·æ±‚å¼€å§?        if (log.isDebugEnabled()) {
            log.debug("[API-START] URI: {}, Method: {}, IP: {}, Class: {}, Method: {}, Params: {}",
                    uri, methodType, ip, className, methodName, Arrays.toString(point.getArgs()));
        }
        
        // æ‰§è¡Œç›®æ ‡æ–¹æ³•
        Object result;
        try {
            result = point.proceed();
        } catch (Exception e) {
            // è®°å½•å¼‚å¸¸ä¿¡æ¯
            long endTime = System.currentTimeMillis();
            long executionTime = endTime - startTime;
            log.error("[API-ERROR] URI: {}, Method: {}, Execution Time: {}ms, Error: {}",
                    uri, methodType, executionTime, e.getMessage(), e);
            throw e;
        }
        
        // è®¡ç®—æ‰§è¡Œæ—¶é—´
        long endTime = System.currentTimeMillis();
        long executionTime = endTime - startTime;
        
        // æ ¹æ®æ‰§è¡Œæ—¶é—´è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿?        if (executionTime > 5000) {
            // æ‰§è¡Œæ—¶é—´è¶…è¿‡5ç§’ï¼Œè®°å½•è­¦å‘Šæ—¥å¿—
            log.warn("[API-SLOW] URI: {}, Method: {}, IP: {}, Execution Time: {}ms",
                    uri, methodType, ip, executionTime);
        } else if (executionTime > 1000) {
            // æ‰§è¡Œæ—¶é—´è¶…è¿‡1ç§’ï¼Œè®°å½•infoæ—¥å¿—
            log.info("[API-WARNING] URI: {}, Method: {}, IP: {}, Execution Time: {}ms",
                    uri, methodType, ip, executionTime);
        } else if (log.isDebugEnabled()) {
            // æ­£å¸¸æ‰§è¡Œæ—¶é—´ï¼Œè®°å½•debugæ—¥å¿—
            log.debug("[API-END] URI: {}, Method: {}, IP: {}, Execution Time: {}ms",
                    uri, methodType, ip, executionTime);
        }
        
        return result;
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯çœŸå®IP
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // å¤šçº§ä»£ç†æƒ…å†µä¸‹ï¼Œå–ç¬¬ä¸€ä¸ªIP
        if (ip != null && ip.indexOf(",") > 0) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }
}
package com.heikeji.common.core.aspect;

import cn.hutool.core.util.StrUtil;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.*;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

/**
 * æ—¥å¿—åˆ‡é¢
 * ç”¨äºè®°å½•ç³»ç»Ÿå…³é”®æ“ä½œçš„æ—¥å¿—ä¿¡æ? */
@Slf4j
@Aspect
@Component
public class LogAspect {

    @Autowired
    private ObjectMapper objectMapper;

    /**
     * å®šä¹‰åˆ‡ç‚¹ - æ‹¦æˆªæ‰€æœ‰controllerå±‚æ–¹æ³?     */
    @Pointcut("execution(* com.heikeji.app.controller.*.*(..)) || execution(* com.heikeji.mall.*.controller.*.*(..))")
    public void logPointCut() {
    }

    /**
     * å®šä¹‰åˆ‡ç‚¹ - æ‹¦æˆªæ‰€æœ‰serviceå±‚æ–¹æ³?     */
    @Pointcut("execution(* com.heikeji.mall.*.service.impl.*.*(..))")
    public void serviceLogPointCut() {
    }

    /**
     * å‰ç½®é€šçŸ¥ - è®°å½•è¯·æ±‚ä¿¡æ¯
     */
    @Before("logPointCut()")
    public void doBefore(JoinPoint joinPoint) {
        try {
            // è·å–è¯·æ±‚ä¿¡æ¯
            HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();

            // è®°å½•è¯·æ±‚ä¿¡æ¯
            log.info("[REQUEST] è¯·æ±‚URL: {}", request.getRequestURL().toString());
            log.info("[REQUEST] è¯·æ±‚æ–¹æ³•: {}", request.getMethod());
            log.info("[REQUEST] è¯·æ±‚IP: {}", request.getRemoteAddr());
            log.info("[REQUEST] æ–¹æ³•è·¯å¾„: {}.{}", method.getDeclaringClass().getName(), method.getName());
            
            // è®°å½•è¯·æ±‚å‚æ•°ï¼ˆè¿‡æ»¤æ•æ„Ÿä¿¡æ¯ï¼‰
            Object[] args = joinPoint.getArgs();
            if (args != null && args.length > 0) {
                // è¿‡æ»¤æ‰request/responseç­‰å¯¹è±?                Object[] filteredArgs = Arrays.stream(args)
                        .filter(arg -> !(arg instanceof HttpServletRequest || arg instanceof javax.servlet.http.HttpServletResponse))
                        .toArray();
                if (filteredArgs.length > 0) {
                    String argsJson = objectMapper.writeValueAsString(filteredArgs);
                    // é™åˆ¶æ—¥å¿—é•¿åº¦ï¼Œé¿å…æ—¥å¿—è¿‡å¤?                    if (argsJson.length() > 1000) {
                        argsJson = argsJson.substring(0, 1000) + "... [çœç•¥éƒ¨åˆ†å‚æ•°]";
                    }
                    log.info("[REQUEST] è¯·æ±‚å‚æ•°: {}", argsJson);
                }
            }
        } catch (Exception e) {
            log.error("è®°å½•è¯·æ±‚æ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * ç¯ç»•é€šçŸ¥ - è®°å½•æ–¹æ³•æ‰§è¡Œæ—¶é—´
     */
    @Around("serviceLogPointCut()")
    public Object aroundService(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.nanoTime();
        Object result;
        
        try {
            // æ‰§è¡ŒåŸæ–¹æ³?            result = joinPoint.proceed();
            
            // è®¡ç®—æ‰§è¡Œæ—¶é—´
            long endTime = System.nanoTime();
            long executionTime = TimeUnit.NANOSECONDS.toMillis(endTime - startTime);
            
            // è·å–æ–¹æ³•ä¿¡æ¯
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            Method method = signature.getMethod();
            String methodName = method.getDeclaringClass().getName() + "." + method.getName();
            
            // è®°å½•æ‰§è¡Œæ—¶é—´
            if (executionTime > 1000) {
                // æ…¢æ–¹æ³•è­¦å‘?                log.warn("[SLOW_METHOD] æ–¹æ³•: {}, æ‰§è¡Œæ—¶é—´: {}ms", methodName, executionTime);
            } else {
                log.debug("[METHOD_EXECUTION] æ–¹æ³•: {}, æ‰§è¡Œæ—¶é—´: {}ms", methodName, executionTime);
            }
            
            return result;
        } catch (Throwable throwable) {
            // è®°å½•å¼‚å¸¸ä¿¡æ¯
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            log.error("[METHOD_EXCEPTION] æ–¹æ³•: {}.{} æ‰§è¡Œå¼‚å¸¸", 
                     signature.getDeclaringType().getName(), 
                     signature.getName(), 
                     throwable);
            throw throwable;
        }
    }

    /**
     * åç½®é€šçŸ¥ - è®°å½•å“åº”ä¿¡æ¯
     */
    @AfterReturning(returning = "result", pointcut = "logPointCut()")
    public void doAfterReturning(JoinPoint joinPoint, Object result) {
        try {
            // è®°å½•å“åº”ç»“æœï¼ˆé™åˆ¶é•¿åº¦ï¼‰
            if (result != null) {
                String resultJson = objectMapper.writeValueAsString(result);
                if (resultJson.length() > 500) {
                    resultJson = resultJson.substring(0, 500) + "... [çœç•¥éƒ¨åˆ†å“åº”]";
                }
                log.info("[RESPONSE] å“åº”ç»“æœ: {}", resultJson);
            }
        } catch (Exception e) {
            log.error("è®°å½•å“åº”æ—¥å¿—å¤±è´¥", e);
        }
    }

    /**
     * å¼‚å¸¸é€šçŸ¥ - è®°å½•å¼‚å¸¸ä¿¡æ¯
     */
    @AfterThrowing(value = "logPointCut()", throwing = "e")
    public void doAfterThrowing(JoinPoint joinPoint, Exception e) {
        try {
            HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
            MethodSignature signature = (MethodSignature) joinPoint.getSignature();
            
            // æ„å»ºå¼‚å¸¸ä¿¡æ¯
            Map<String, Object> errorInfo = new HashMap<>();
            errorInfo.put("url", request.getRequestURL().toString());
            errorInfo.put("method", request.getMethod());
            errorInfo.put("ip", request.getRemoteAddr());
            errorInfo.put("className", signature.getDeclaringTypeName());
            errorInfo.put("methodName", signature.getName());
            errorInfo.put("exception", e.getClass().getName());
            errorInfo.put("message", e.getMessage());
            
            log.error("[REQUEST_ERROR] é”™è¯¯ä¿¡æ¯: {}, å¼‚å¸¸å †æ ˆ: ", 
                     objectMapper.writeValueAsString(errorInfo), e);
        } catch (Exception ex) {
            log.error("è®°å½•å¼‚å¸¸æ—¥å¿—å¤±è´¥", ex);
        }
    }
}
package com.heikeji.common.core.aspect;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.heikeji.common.core.constant.CommonConstants;
import com.heikeji.common.core.utils.LogUtils;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.lang.reflect.Method;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;

/**
 * æ“ä½œæ—¥å¿—åˆ‡é¢
 * è®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—ï¼ŒåŒ…æ‹¬æ“ä½œæ—¶é—´ã€æ“ä½œäººã€æ“ä½œå†…å®¹ã€IPåœ°å€ç­‰ä¿¡æ? */
@Aspect
@Component
public class OperationLogAspect {

    private static final Logger log = LoggerFactory.getLogger("operation");
    private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    @Autowired
    private ObjectMapper objectMapper;

    /**
     * å®šä¹‰åˆ‡ç‚¹ - æ‹¦æˆªæ‰€æœ‰Controlleræ–¹æ³•
     */
    @Pointcut("execution(* com.heikeji.app.controller.*.*(..)) || execution(* com.heikeji.mall.*.controller.*.*(..))")
    public void operationLogPointCut() {
    }

    /**
     * ç¯ç»•é€šçŸ¥ - è®°å½•æ“ä½œæ—¥å¿—
     */
    @Around("operationLogPointCut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        long startTime = System.currentTimeMillis();
        Object result = null;
        String errorMsg = null;

        try {
            // æ‰§è¡ŒåŸæ–¹æ³?            result = point.proceed();
            return result;
        } catch (Exception e) {
            errorMsg = getErrorStackTrace(e);
            throw e;
        } finally {
            try {
                // è®°å½•æ“ä½œæ—¥å¿—
                recordOperationLog(point, startTime, System.currentTimeMillis(), errorMsg, result);
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
                LogUtils.error(LoggerFactory.getLogger(OperationLogAspect.class), "è®°å½•æ“ä½œæ—¥å¿—å¤±è´¥", e);
            }
        }
    }

    /**
     * è®°å½•æ“ä½œæ—¥å¿—
     */
    private void recordOperationLog(ProceedingJoinPoint point, long startTime, long endTime, String errorMsg, Object result) {
        HttpServletRequest request = getRequest();
        if (request == null) {
            return;
        }

        // è·å–æ–¹æ³•ç­¾å
        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();

        // æ„å»ºæ—¥å¿—ä¿¡æ¯
        Map<String, Object> logInfo = new HashMap<>();
        logInfo.put("timestamp", LocalDateTime.now().format(DATE_TIME_FORMATTER));
        logInfo.put("costTime", endTime - startTime);
        logInfo.put("ip", getIp(request));
        logInfo.put("method", request.getMethod());
        logInfo.put("uri", request.getRequestURI());
        logInfo.put("userAgent", request.getHeader("User-Agent"));
        logInfo.put("className", method.getDeclaringClass().getName());
        logInfo.put("methodName", method.getName());
        logInfo.put("userId", getCurrentUserId());
        logInfo.put("username", getCurrentUsername());
        logInfo.put("params", getRequestParams(point));
        logInfo.put("success", errorMsg == null);
        logInfo.put("errorMsg", errorMsg);

        // è®°å½•ç»“æœï¼Œé™åˆ¶é•¿åº?        if (result != null) {
            String resultStr = result.toString();
            if (resultStr.length() > 500) {
                resultStr = resultStr.substring(0, 500) + "...";
            }
            logInfo.put("result", resultStr);
        }

        try {
            String logJson = objectMapper.writeValueAsString(logInfo);
            if (errorMsg != null) {
                log.error(logJson);
            } else {
                log.info(logJson);
            }
        } catch (Exception e) {
            LogUtils.error(LoggerFactory.getLogger(OperationLogAspect.class), "åºåˆ—åŒ–æ“ä½œæ—¥å¿—å¤±è´?, e);
        }
    }

    /**
     * è·å–å½“å‰è¯·æ±‚
     */
    private HttpServletRequest getRequest() {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes != null) {
            return attributes.getRequest();
        }
        return null;
    }

    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     */
    private String getIp(HttpServletRequest request) {
        String ip = request.getHeader("x-forwarded-for");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // å¤šçº§ä»£ç†æƒ…å†µä¸‹ï¼Œå–ç¬¬ä¸€ä¸ªIP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }

    /**
     * è·å–è¯·æ±‚å‚æ•°
     */
    private String getRequestParams(ProceedingJoinPoint point) {
        Object[] args = point.getArgs();
        if (args == null || args.length == 0) {
            return "[]";
        }
        
        try {
            String paramsJson = objectMapper.writeValueAsString(args);
            // é™åˆ¶å‚æ•°é•¿åº¦
            if (paramsJson.length() > 1000) {
                paramsJson = paramsJson.substring(0, 1000) + "... [çœç•¥éƒ¨åˆ†å‚æ•°]";
            }
            return paramsJson;
        } catch (Exception e) {
            return "[å‚æ•°åºåˆ—åŒ–å¤±è´¥]";
        }
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·ID
     * è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„ç”¨æˆ·è®¤è¯æ–¹å¼è¿›è¡Œå®ç°
     */
    private String getCurrentUserId() {
        // ä»çº¿ç¨‹ä¸Šä¸‹æ–‡æˆ–è¯·æ±‚å¤´è·å–ç”¨æˆ·ID
        HttpServletRequest request = getRequest();
        if (request != null) {
            String userId = request.getHeader("X-User-Id");
            if (userId != null && !userId.isEmpty()) {
                return userId;
            }
        }
        // é»˜è®¤è¿”å›æœªè®¤è¯?        return "unauthorized";
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·å?     */
    private String getCurrentUsername() {
        HttpServletRequest request = getRequest();
        if (request != null) {
            String username = request.getHeader("X-Username");
            if (username != null && !username.isEmpty()) {
                return username;
            }
        }
        return "unauthorized";
    }

    /**
     * è·å–å¼‚å¸¸å †æ ˆä¿¡æ¯
     */
    private String getErrorStackTrace(Exception e) {
        StringWriter sw = new StringWriter();
        PrintWriter pw = new PrintWriter(sw);
        e.printStackTrace(pw);
        String stackTrace = sw.toString();
        
        // é™åˆ¶å¼‚å¸¸ä¿¡æ¯é•¿åº¦
        if (stackTrace.length() > 500) {
            stackTrace = stackTrace.substring(0, 500) + "... [çœç•¥éƒ¨åˆ†å¼‚å¸¸ä¿¡æ¯]";
        }
        
        return stackTrace;
    }
}
package com.heikeji.common.core.aspect;

import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.stereotype.Component;
import org.springframework.validation.BindingResult;
import org.springframework.validation.ObjectError;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;
import java.lang.reflect.Method;
import java.lang.reflect.Parameter;
import java.util.Arrays;
import java.util.regex.Pattern;

/**
 * å‚æ•°æ ¡éªŒåˆ‡é¢
 * ç”¨äºæ‹¦æˆªControlleræ–¹æ³•çš„å‚æ•°ï¼Œè¿›è¡Œç»Ÿä¸€æ ¡éªŒå’Œé˜²SQLæ³¨å…¥æ£€æŸ? */
@Slf4j
@Aspect
@Component
public class ParamValidateAspect {

    // SQLæ³¨å…¥å…³é”®å­—æ­£åˆ™è¡¨è¾¾å¼
    private static final Pattern SQL_INJECTION_PATTERN = Pattern.compile(
            "(?i)(select|update|insert|delete|drop|truncate|alter|exec|execute|union|create|grant|revoke|\\s+--|\\bor\\s+|\\band\\s+|\\bxor\\s+|;|\\/\\*|\\*\\/)\\s*");
    
    // SQLç‰¹æ®Šå­—ç¬¦æ­£åˆ™è¡¨è¾¾å¼?    private static final Pattern SQL_SPECIAL_CHARS_PATTERN = Pattern.compile(
            "[\\s\\n\\r]*(?i)(exec|execute|xp_cmdshell|sp_executesql|sp_stored_procedures|sp_help)\\s+");

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šæ‹¦æˆªæ‰€æœ‰Controlleræ–¹æ³•
     */
    @Pointcut("execution(* com.heikeji.*.*.controller..*.*(..))")
    public void paramValidatePointCut() {
    }

    /**
     * æ‰§è¡Œç¯ç»•é€šçŸ¥ï¼Œè¿›è¡Œå‚æ•°æ ¡éª?     */
    @Around("paramValidatePointCut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        // è·å–æ–¹æ³•ç­¾å
        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();
        String className = method.getDeclaringClass().getName();
        String methodName = method.getName();
        
        // è·å–è¯·æ±‚ä¿¡æ¯
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        String uri = request.getRequestURI();
        String methodType = request.getMethod();
        
        // è·å–æ–¹æ³•å‚æ•°
        Object[] args = point.getArgs();
        Parameter[] parameters = method.getParameters();
        
        // è®°å½•è¯·æ±‚å‚æ•°ä¿¡æ¯
        if (log.isDebugEnabled()) {
            log.debug("[PARAM-VALIDATE] URI: {}, Method: {}, Class: {}, Method: {}, Params: {}",
                    uri, methodType, className, methodName, Arrays.toString(args));
        }
        
        // æ£€æŸ¥å‚æ•°ä¸­çš„BindingResultï¼ˆSpring Validationç»“æœï¼?        for (Object arg : args) {
            if (arg instanceof BindingResult) {
                BindingResult result = (BindingResult) arg;
                if (result.hasErrors()) {
                    StringBuilder errorMsg = new StringBuilder();
                    for (ObjectError error : result.getAllErrors()) {
                        errorMsg.append(error.getDefaultMessage()).append("; ");
                    }
                    log.warn("[PARAM-VALIDATE-ERROR] URI: {}, Validation Errors: {}", uri, errorMsg.toString());
                    throw new RuntimeException("å‚æ•°éªŒè¯å¤±è´¥: " + errorMsg.toString());
                }
            }
        }
        
        // å¯¹å­—ç¬¦ä¸²å‚æ•°è¿›è¡ŒSQLæ³¨å…¥æ£€æŸ?        for (int i = 0; i < args.length && i < parameters.length; i++) {
            Object arg = args[i];
            if (arg != null && arg instanceof String) {
                String paramValue = (String) arg;
                // æ£€æŸ¥SQLæ³¨å…¥é£é™©
                if (containsSqlInjection(paramValue)) {
                    log.warn("[SQL-INJECTION-DETECTED] URI: {}, Parameter: {}, Value: {}", 
                            uri, parameters[i].getName(), paramValue);
                    throw new RuntimeException("å‚æ•°åŒ…å«éæ³•å­—ç¬¦ï¼Œè¯·æ£€æŸ¥è¾“å…?);
                }
            }
        }
        
        // å¯¹è¯·æ±‚å‚æ•°è¿›è¡ŒSQLæ³¨å…¥æ£€æŸ?        request.getParameterMap().forEach((paramName, paramValues) -> {
            if (paramValues != null) {
                for (String paramValue : paramValues) {
                    if (containsSqlInjection(paramValue)) {
                        log.warn("[SQL-INJECTION-DETECTED] URI: {}, Request Parameter: {}, Value: {}", 
                                uri, paramName, paramValue);
                        throw new RuntimeException("è¯·æ±‚å‚æ•°åŒ…å«éæ³•å­—ç¬¦ï¼Œè¯·æ£€æŸ¥è¾“å…?);
                    }
                }
            }
        });
        
        // å‚æ•°æ ¡éªŒé€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œç›®æ ‡æ–¹æ³?        return point.proceed();
    }
    
    /**
     * æ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«SQLæ³¨å…¥é£é™©
     */
    private boolean containsSqlInjection(String input) {
        if (input == null || input.trim().isEmpty()) {
            return false;
        }
        
        // æ£€æŸ¥SQLå…³é”®å­?        if (SQL_INJECTION_PATTERN.matcher(input).find()) {
            return true;
        }
        
        // æ£€æŸ¥SQLç‰¹æ®Šå­—ç¬¦å’Œå‘½ä»?        if (SQL_SPECIAL_CHARS_PATTERN.matcher(input).find()) {
            return true;
        }
        
        // æ£€æŸ¥å±é™©çš„SQLè¯­æ³•ï¼Œå¦‚--æ³¨é‡Šã€?**/æ³¨é‡Šç­?        if (input.contains("'--") || input.contains("'/**") || input.contains("*/")) {
            return true;
        }
        
        // æ£€æŸ¥å¤šè¯­å¥æ‰§è¡Œï¼ˆåˆ†å·åˆ†éš”ï¼‰
        if (input.contains(";")) {
            // å…è®¸éƒ¨åˆ†åˆæ³•çš„åˆ†å·ä½¿ç”¨ï¼Œæ¯”å¦‚åœ¨JSONæˆ–æŸäº›ç‰¹å®šæ ¼å¼ä¸­
            // è¿™é‡Œåšç®€å•å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ›´ç²¾ç¡®çš„åˆ¤æ–?            if (!isValidSemicolonUsage(input)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * åˆ¤æ–­åˆ†å·ä½¿ç”¨æ˜¯å¦åˆæ³•
     */
    private boolean isValidSemicolonUsage(String input) {
        // æ£€æŸ¥æ˜¯å¦åœ¨å¼•å·å†…çš„åˆ†å·ï¼ˆå¯èƒ½æ˜¯JSONæˆ–æ–‡æœ¬å†…å®¹ï¼‰
        boolean inSingleQuote = false;
        boolean inDoubleQuote = false;
        
        for (char c : input.toCharArray()) {
            if (c == '\'' && !inDoubleQuote) {
                inSingleQuote = !inSingleQuote;
            } else if (c == '"' && !inSingleQuote) {
                inDoubleQuote = !inDoubleQuote;
            }
            
            // å¦‚æœåˆ†å·åœ¨å¼•å·å¤–ï¼Œå¯èƒ½æ˜¯å¤šè¯­å¥æ‰§è¡?            if (c == ';' && !inSingleQuote && !inDoubleQuote) {
                // æ£€æŸ¥åˆ†å·å‰åæ˜¯å¦æœ‰SQLå…³é”®å­?                String[] parts = input.split(Pattern.quote(";"));
                for (String part : parts) {
                    if (part.trim().length() > 0) {
                        // å¦‚æœæœ‰å¤šä¸ªéç©ºéƒ¨åˆ†ï¼Œå¯èƒ½æ˜¯å¤šè¯­å¥æ‰§è¡Œ
                        return false;
                    }
                }
            }
        }
        
        return true;
    }
}
package com.heikeji.common.core.aspect;

import com.heikeji.common.api.ResultCode;
import com.heikeji.common.api.ResponseMessage;
import com.heikeji.common.core.annotation.RequiresPermission;
import com.heikeji.common.core.service.PermissionService;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

import java.lang.reflect.Method;
import java.util.Set;

/**
 * æƒé™æ ¡éªŒåˆ‡é¢
 * ç”¨äºæ‹¦æˆªå¸¦æœ‰RequiresPermissionæ³¨è§£çš„æ–¹æ³•è¿›è¡Œæƒé™éªŒè¯? */
@Slf4j
@Aspect
@Component
public class PermissionAspect {

    @Autowired
    private PermissionService permissionService;

    /**
     * å®šä¹‰åˆ‡ç‚¹ï¼šæ‹¦æˆªæ‰€æœ‰å¸¦æœ‰RequiresPermissionæ³¨è§£çš„æ–¹æ³?     */
    @Pointcut("@annotation(com.heikeji.common.core.annotation.RequiresPermission)")
    public void permissionPointCut() {
    }

    /**
     * æ‰§è¡Œç¯ç»•é€šçŸ¥ï¼Œè¿›è¡Œæƒé™æ ¡éª?     */
    @Around("permissionPointCut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        // è·å–æ–¹æ³•ç­¾å
        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();
        
        // è·å–RequiresPermissionæ³¨è§£
        RequiresPermission requiresPermission = method.getAnnotation(RequiresPermission.class);
        if (requiresPermission == null) {
            return point.proceed();
        }
        
        // è·å–æƒé™ä¿¡æ¯
        String[] permissions = requiresPermission.value();
        String type = requiresPermission.type();
        String message = requiresPermission.message();
        
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            throw new RuntimeException("ç”¨æˆ·æœªè®¤è¯?);
        }
        
        // è·å–ç”¨æˆ·IDï¼ˆå‡è®¾Principalä¸­åŒ…å«ç”¨æˆ·IDä¿¡æ¯ï¼?        Long userId = null;
        Object principal = authentication.getPrincipal();
        if (principal instanceof Long) {
            userId = (Long) principal;
        } else if (principal instanceof String) {
            try {
                userId = Long.parseLong((String) principal);
            } catch (NumberFormatException e) {
                // å¦‚æœæ— æ³•è§£æï¼Œå¯èƒ½éœ€è¦ä»å…¶ä»–åœ°æ–¹è·å–ç”¨æˆ·ID
                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦æ ¹æ®æƒ…å†µè°ƒæ•?                throw new RuntimeException("æ— æ³•è·å–ç”¨æˆ·ID");
            }
        } else {
            // å°è¯•ä»è®¤è¯ä¿¡æ¯ä¸­è·å–ç”¨æˆ·ID
            // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“çš„è®¤è¯å®ç°è¿›è¡Œè°ƒæ•´
            throw new RuntimeException("æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯");
        }
        
        // è·å–ç”¨æˆ·çš„æƒé™ç¼–ç åˆ—è¡?        Set<String> userPermissionCodes = permissionService.getPermissionCodesByUserId(userId);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™
        boolean hasPermission = false;
        
        if ("single".equals(type)) {
            // åªéœ€è¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæƒé™?            for (String permission : permissions) {
                if (userPermissionCodes.contains(permission)) {
                    hasPermission = true;
                    break;
                }
            }
        } else if ("all".equals(type)) {
            // éœ€è¦æ»¡è¶³æ‰€æœ‰æƒé™?            hasPermission = true;
            for (String permission : permissions) {
                if (!userPermissionCodes.contains(permission)) {
                    hasPermission = false;
                    break;
                }
            }
        }
        
        // å¦‚æœæ²¡æœ‰æƒé™ï¼ŒæŠ›å‡ºå¼‚å¸?        if (!hasPermission) {
            log.warn("ç”¨æˆ·[{}]å°è¯•è®¿é—®æœªæˆæƒèµ„æºï¼š{}.{}", userId, method.getDeclaringClass().getName(), method.getName());
            throw new RuntimeException(message);
        }
        
        // æœ‰æƒé™ï¼Œç»§ç»­æ‰§è¡Œç›®æ ‡æ–¹æ³•
        return point.proceed();
    }
}
package com.heikeji.common.core.aspect;

import com.heikeji.common.core.annotation.RateLimiter;
import com.heikeji.common.core.exception.BaseException;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;
import java.lang.reflect.Method;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.ConcurrentHashMap;
import java.util.Map;

/**
 * é™æµåˆ‡é¢å®ç°
 */
@Slf4j
@Aspect
@Component
public class RateLimiterAspect {

    @Autowired(required = false)
    private RedisTemplate<String, AtomicInteger> redisTemplate;
    
    // æœ¬åœ°ç¼“å­˜ä½œä¸ºRedisçš„åå¤?    private final Map<String, CacheEntry> localCache = new ConcurrentHashMap<>();
    
    private static class CacheEntry {
        private final AtomicInteger count;
        private final long expireTime;
        
        public CacheEntry(AtomicInteger count, long expireTime) {
            this.count = count;
            this.expireTime = expireTime;
        }
        
        public AtomicInteger getCount() {
            return count;
        }
        
        public long getExpireTime() {
            return expireTime;
        }
        
        public boolean isExpired() {
            return System.currentTimeMillis() > expireTime;
        }
    }

    /**
     * å®šä¹‰åˆ‡ç‚¹
     */
    @Pointcut("@annotation(com.heikeji.common.core.annotation.RateLimiter)")
    public void rateLimitPointCut() {
    }

    /**
     * ç¯ç»•é€šçŸ¥ï¼Œå®ç°é™æµé€»è¾‘
     */
    @Around("rateLimitPointCut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        // è·å–æ–¹æ³•ç­¾åå’Œæ³¨è§£ä¿¡æ?        MethodSignature signature = (MethodSignature) point.getSignature();
        Method method = signature.getMethod();
        RateLimiter rateLimiter = method.getAnnotation(RateLimiter.class);
        
        // æ„å»ºé™æµé”?        String key = generateKey(point, rateLimiter);
        int maxCount = rateLimiter.maxCount();
        int timeWindow = rateLimiter.timeWindow();
        String message = rateLimiter.message();
        
        // æ‰§è¡Œé™æµé€»è¾‘
        if (!tryAcquire(key, maxCount, timeWindow)) {
            log.warn("æ¥å£é™æµè§¦å‘ï¼Œæ–¹æ³? {}.{}, é™æµé”? {}", 
                     method.getDeclaringClass().getName(), method.getName(), key);
            throw new BaseException(message);
        }
        
        // æ‰§è¡ŒåŸæ–¹æ³?        return point.proceed();
    }

    /**
     * ç”Ÿæˆé™æµé”?     */
    private String generateKey(ProceedingJoinPoint point, RateLimiter rateLimiter) {
        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        StringBuilder key = new StringBuilder("rate_limit:");
        
        // æ ¹æ®é™æµç±»å‹æ„å»ºé”?        String limitType = rateLimiter.limitType();
        if ("ip".equals(limitType)) {
            // IPé™æµ
            key.append("ip:").append(request.getRemoteAddr());
        } else if ("user".equals(limitType)) {
            // ç”¨æˆ·é™æµï¼ˆå¯ä»¥ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·IDï¼?            key.append("user:").append(getCurrentUserId());
        }
        
        // åŠ ä¸Šæ–¹æ³•ä¿¡æ¯
        MethodSignature signature = (MethodSignature) point.getSignature();
        key.append(":").append(signature.getDeclaringType().getName())
           .append(":").append(signature.getName());
        
        return key.toString();
    }

    /**
     * å°è¯•è·å–ä»¤ç‰Œ
     */
    private boolean tryAcquire(String key, int maxCount, int timeWindow) {
        // æ¸…ç†è¿‡æœŸçš„æœ¬åœ°ç¼“å­?        cleanExpiredEntries();
        
        // ä½¿ç”¨Redisæˆ–æœ¬åœ°ç¼“å­?        if (redisTemplate != null) {
            return tryAcquireWithRedis(key, maxCount, timeWindow);
        } else {
            return tryAcquireWithLocalCache(key, maxCount, timeWindow);
        }
    }
    
    /**
     * ä½¿ç”¨Redisè¿›è¡Œé™æµ
     */
    private boolean tryAcquireWithRedis(String key, int maxCount, int timeWindow) {
        try {
            // è·å–å½“å‰è®¡æ•°
            AtomicInteger count = redisTemplate.opsForValue().get(key);
            if (count == null) {
                // ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œåˆå§‹åŒ–è®¡æ•?                count = new AtomicInteger(1);
                redisTemplate.opsForValue().set(key, count, timeWindow, TimeUnit.SECONDS);
                return true;
            }
            
            // å°è¯•å¢åŠ è®¡æ•°
            int currentCount = count.incrementAndGet();
            if (currentCount > maxCount) {
                return false;
            }
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è®¾ç½®è¿‡æœŸæ—¶é—?            if (currentCount == 1) {
                redisTemplate.expire(key, timeWindow, TimeUnit.SECONDS);
            }
            
            return true;
        } catch (Exception e) {
            log.warn("Redisæ“ä½œå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­? {}", e.getMessage());
            return tryAcquireWithLocalCache(key, maxCount, timeWindow);
        }
    }
    
    /**
     * ä½¿ç”¨æœ¬åœ°ç¼“å­˜è¿›è¡Œé™æµ
     */
    private boolean tryAcquireWithLocalCache(String key, int maxCount, int timeWindow) {
        CacheEntry entry = localCache.get(key);
        
        if (entry == null || entry.isExpired()) {
            // ç¬¬ä¸€æ¬¡è®¿é—®æˆ–å·²è¿‡æœŸï¼Œåˆå§‹åŒ–è®¡æ•?            AtomicInteger count = new AtomicInteger(1);
            long expireTime = System.currentTimeMillis() + (timeWindow * 1000L);
            localCache.put(key, new CacheEntry(count, expireTime));
            return true;
        }
        
        // å°è¯•å¢åŠ è®¡æ•°
        int currentCount = entry.getCount().incrementAndGet();
        if (currentCount > maxCount) {
            return false;
        }
        
        return true;
    }
    
    /**
     * æ¸…ç†è¿‡æœŸçš„æœ¬åœ°ç¼“å­˜æ¡ç›?     */
    private void cleanExpiredEntries() {
        localCache.entrySet().removeIf(entry -> entry.getValue().isExpired());
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·æ ‡è¯†ï¼Œä½¿ç”¨IPåœ°å€ä½œä¸ºé»˜è®¤æ ‡è¯†
     * @return ç”¨æˆ·æ ‡è¯†ï¼ˆIPåœ°å€ï¼?     */
    private String getCurrentUserId() {
        
        // å¦‚æœæ— æ³•ä»SecurityContextè·å–ï¼Œåˆ™å°è¯•ä»è¯·æ±‚å¤´ä¸­è·å–Tokenå¹¶è§£æ?        try {
            HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
            String token = request.getHeader("Authorization");
            if (token != null && token.startsWith("Bearer ")) {
                token = token.substring(7);
                // è§£æTokenè·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™é‡Œéœ€è¦æ ¹æ®é¡¹ç›®å®é™…çš„Tokenè§£æé€»è¾‘å®ç°
                // ç®€åŒ–å®ç°ï¼šç›´æ¥è¿”å›tokençš„å‰8ä½ä½œä¸ºæ ‡è¯?                return token.length() > 8 ? token.substring(0, 8) : token;
            }
            // å¦‚æœæ²¡æœ‰tokenï¼Œè¿”å›IPåœ°å€
            return getClientIp(request);
        } catch (Exception e) {
            log.warn("è·å–è¯·æ±‚ä¿¡æ¯å¤±è´¥", e);
        }
        
        // å…œåº•è¿”å›ï¼Œé¿å…ç©ºæŒ‡é’ˆ
        return "anonymous";
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     * @param request HTTPè¯·æ±‚
     * @return IPåœ°å€
     */
    private String getClientIp(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("WL-Proxy-Client-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        // å¤šçº§ä»£ç†çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªIPä¸ºå®¢æˆ·ç«¯çœŸå®IP
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        return ip;
    }
}
package com.heikeji.common.core.aspect;

import com.heikeji.common.core.trace.TraceContext;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import jakarta.servlet.http.HttpServletRequest;

/**
 * é“¾è·¯è¿½è¸ªåˆ‡é¢
 * è‡ªåŠ¨æ‹¦æˆªHTTPè¯·æ±‚ï¼Œå¤„ç†é“¾è·¯è¿½è¸ªçš„å¼€å§‹å’Œç»“æŸ
 */
@Aspect
@Component
public class TraceAspect {

    private static final Logger log = LoggerFactory.getLogger("trace");
    
    /**
     * è·Ÿè¸ªIDè¯·æ±‚å¤?     */
    private static final String TRACE_ID_HEADER = "X-Trace-Id";
    
    /**
     * çˆ¶Span IDè¯·æ±‚å¤?     */
    private static final String PARENT_SPAN_ID_HEADER = "X-Parent-Span-Id";

    /**
     * å®šä¹‰åˆ‡ç‚¹ - æ‹¦æˆªæ‰€æœ‰Controlleræ–¹æ³•
     */
    @Pointcut("execution(* com.heikeji.app.controller.*.*(..)) || execution(* com.heikeji.mall.*.controller.*.*(..))")
    public void tracePointCut() {
    }

    /**
     * ç¯ç»•é€šçŸ¥ - å¤„ç†é“¾è·¯è¿½è¸ª
     */
    @Around("tracePointCut()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        long startTime = System.currentTimeMillis();
        String traceId = null;
        String spanId = null;
        
        try {
            // ä»è¯·æ±‚å¤´è·å–è·Ÿè¸ªä¿¡æ¯æˆ–åˆ›å»ºæ–°çš?            initTraceContext();
            
            traceId = TraceContext.getTraceId();
            spanId = TraceContext.getSpanId();
            
            // è®°å½•è¯·æ±‚å¼€å§?            log.info("[TRACE START] traceId={}, spanId={}, method={}, uri={}", 
                    traceId, spanId, getRequestMethod(), getRequestUri());
            
            // æ‰§è¡ŒåŸæ–¹æ³?            Object result = point.proceed();
            
            // è®°å½•è¯·æ±‚ç»“æŸ
            long costTime = System.currentTimeMillis() - startTime;
            log.info("[TRACE END] traceId={}, spanId={}, costTime={}ms", 
                    traceId, spanId, costTime);
            
            return result;
        } catch (Exception e) {
            // è®°å½•å¼‚å¸¸
            log.error("[TRACE ERROR] traceId={}, spanId={}", traceId, spanId, e);
            throw e;
        } finally {
            // æ¸…ç†è·Ÿè¸ªä¸Šä¸‹æ–?            TraceContext.clear();
        }
    }

    /**
     * åˆå§‹åŒ–è·Ÿè¸ªä¸Šä¸‹æ–‡
     */
    private void initTraceContext() {
        HttpServletRequest request = getRequest();
        if (request != null) {
            // ä»è¯·æ±‚å¤´è·å–è·Ÿè¸ªä¿¡æ¯
            String traceId = request.getHeader(TRACE_ID_HEADER);
            String parentSpanId = request.getHeader(PARENT_SPAN_ID_HEADER);
            
            // å¼€å§‹è·Ÿè¸?            TraceContext.startTrace(traceId, parentSpanId);
            
            // å°†è·Ÿè¸ªä¿¡æ¯è®¾ç½®åˆ°å“åº”å¤´ä¸­
            request.setAttribute(TRACE_ID_HEADER, TraceContext.getTraceId());
            request.setAttribute(PARENT_SPAN_ID_HEADER, TraceContext.getParentSpanId());
        } else {
            // å¦‚æœæ²¡æœ‰è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš„è·Ÿè¸?            TraceContext.startTrace();
        }
    }

    /**
     * è·å–å½“å‰è¯·æ±‚
     */
    private HttpServletRequest getRequest() {
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        if (attributes != null) {
            return attributes.getRequest();
        }
        return null;
    }

    /**
     * è·å–è¯·æ±‚æ–¹æ³•
     */
    private String getRequestMethod() {
        HttpServletRequest request = getRequest();
        return request != null ? request.getMethod() : "UNKNOWN";
    }

    /**
     * è·å–è¯·æ±‚URI
     */
    private String getRequestUri() {
        HttpServletRequest request = getRequest();
        return request != null ? request.getRequestURI() : "UNKNOWN";
    }
}
package com.heikeji.common.core.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.SpringBootVersion;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.env.Environment;
import org.springframework.util.StringUtils;

import java.util.*;

/**
 * åŸºç¡€Swaggeré…ç½®ç±»ï¼Œæä¾›ç»Ÿä¸€çš„Swaggeré…ç½®æ¨¡æ¿
 */
@Configuration
public abstract class BaseSwaggerConfig {

    @Value("${swagger.enable:false}")
    private boolean enable;

    @Value("${swagger.title:APIæ¥å£æ–‡æ¡£}")
    private String title;

    @Value("${swagger.description:ç³»ç»ŸAPIæ¥å£æ–‡æ¡£}")
    private String description;

    @Value("${swagger.version:1.0.0}")
    private String version;

    @Value("${swagger.base-package:}")
    private String basePackage;

    @Value("${swagger.author:ç³»ç»Ÿå¼€å‘å›¢é˜Ÿ}")
    private String author;

    @Value("${swagger.email:}")
    private String email;

    @Value("${swagger.url:}")
    private String url;

    /**
     * åˆ›å»ºAPIæ–‡æ¡£é…ç½® - æš‚æ—¶æ³¨é‡Šæ‰ï¼Œç­‰å¾…Swaggerä¾èµ–é—®é¢˜è§£å†³
     */
    /*
    @Bean
    public Object createRestApi() {
        // æš‚æ—¶è¿”å›nullï¼Œé¿å…ä¾èµ–é—®é¢?        return null;
    }
    
    // ä»¥ä¸‹æ–¹æ³•æš‚æ—¶æ³¨é‡Šï¼Œç­‰å¾…Swaggerä¾èµ–é—®é¢˜è§£å†³
    // private ApiInfo apiInfo() { ... }
    // private List<SecurityScheme> securitySchemes() { ... }
    // private List<SecurityContext> securityContexts() { ... }
    // private List<SecurityReference> defaultAuth() { ... }
    // private List<ResponseMessage> getGlobalResponseMessage() { ... }
    */
}
package com.heikeji.common.core.config;

import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.env.EnvironmentPostProcessor;
import org.springframework.core.env.ConfigurableEnvironment;
import org.springframework.core.env.MutablePropertySources;
import org.springframework.core.env.PropertiesPropertySource;
import org.springframework.core.io.FileSystemResource;
import org.springframework.core.io.Resource;
import org.springframework.util.StringUtils;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Properties;

/**
 * ç¯å¢ƒå˜é‡é…ç½®å¤„ç†å™¨ï¼Œç”¨äºä»?envæ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡
 */
@Slf4j
public class EnvironmentConfig implements EnvironmentPostProcessor {

    private static final String DOT_ENV_PREFIX = ".env.";
    private static final String DOT_ENV = ".env";
    private static final String PROFILES_ACTIVE = "spring.profiles.active";

    @Override
    public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {
        try {
            // è·å–æ´»åŠ¨çš„ç¯å¢ƒé…ç½?            String activeProfile = environment.getProperty(PROFILES_ACTIVE, "dev");
            log.info("å½“å‰æ´»åŠ¨ç¯å¢ƒ: {}", activeProfile);

            // åŠ è½½ç¯å¢ƒå˜é‡æ–‡ä»¶
            loadEnvFile(environment, DOT_ENV);  // åŠ è½½é€šç”¨é…ç½®
            loadEnvFile(environment, DOT_ENV_PREFIX + activeProfile);  // åŠ è½½ç‰¹å®šç¯å¢ƒé…ç½®
        } catch (Exception e) {
            log.error("åŠ è½½ç¯å¢ƒå˜é‡é…ç½®å¤±è´¥", e);
        }
    }

    /**
     * åŠ è½½ç¯å¢ƒå˜é‡æ–‡ä»¶
     */
    private void loadEnvFile(ConfigurableEnvironment environment, String fileName) {
        // å°è¯•ä»å¤šä¸ªä½ç½®åŠ è½?envæ–‡ä»¶
        String[] searchLocations = new String[]{
                "./" + fileName,  // å½“å‰å·¥ä½œç›®å½•
                System.getProperty("user.dir") + File.separator + fileName,  // ç”¨æˆ·ç›®å½•
                "/etc/heikeji/" + fileName,  // Linuxæ ‡å‡†é…ç½®ç›®å½•
                "C:/heikeji/config/" + fileName  // Windowsæ ‡å‡†é…ç½®ç›®å½•
        };

        for (String location : searchLocations) {
            File envFile = new File(location);
            if (envFile.exists() && envFile.isFile()) {
                try {
                    Properties properties = loadPropertiesFromEnvFile(envFile);
                    if (!properties.isEmpty()) {
                        MutablePropertySources propertySources = environment.getPropertySources();
                        propertySources.addFirst(new PropertiesPropertySource(fileName, properties));
                        log.info("å·²æˆåŠŸåŠ è½½ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»? {}", location);
                        return;
                    }
                } catch (Exception e) {
                    log.warn("åŠ è½½ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶å¤±è´¥: {}", location, e);
                }
            }
        }

        log.info("æœªæ‰¾åˆ°ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»? {}", fileName);
    }

    /**
     * ä»?envæ–‡ä»¶åŠ è½½å±æ€?     */
    private Properties loadPropertiesFromEnvFile(File envFile) throws IOException {
        Properties properties = new Properties();
        
        Files.lines(Paths.get(envFile.getAbsolutePath()))
                .filter(line -> !line.trim().startsWith("#") && line.contains("="))
                .forEach(line -> {
                    try {
                        // è§£æé”®å€¼å¯¹ï¼Œæ”¯æŒæ³¨é‡?                        int commentIndex = line.indexOf('#');
                        String actualLine = commentIndex > 0 ? line.substring(0, commentIndex) : line;
                        
                        int equalsIndex = actualLine.indexOf('=');
                        if (equalsIndex > 0) {
                            String key = actualLine.substring(0, equalsIndex).trim();
                            String value = actualLine.substring(equalsIndex + 1).trim();
                            
                            // ç§»é™¤å¼•å·
                            if ((value.startsWith("\"") && value.endsWith("\"")) || 
                                (value.startsWith("'") && value.endsWith("'"))) {
                                value = value.substring(1, value.length() - 1);
                            }
                            
                            if (StringUtils.hasText(key)) {
                                properties.setProperty(key, value);
                                // åŒæ—¶è®¾ç½®åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿å…¶ä»–ç»„ä»¶ä½¿ç”¨
                                System.setProperty(key, value);
                            }
                        }
                    } catch (Exception e) {
                        log.warn("è§£æç¯å¢ƒå˜é‡è¡Œå¤±è´? {}", line, e);
                    }
                });
        
        return properties;
    }
}
package com.heikeji.common.core.config;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Configuration;

import jakarta.annotation.PostConstruct;

/**
 * ç†”æ–­é™çº§é…ç½®ç±? * æ³¨æ„ï¼šå½“å‰æš‚æœªä½¿ç”¨Netflix Hystrixï¼Œåç»­å¯æ ¹æ®éœ€è¦é›†æˆSpring Cloud Circuit Breaker
 */
@Configuration
public class HystrixConfig {

    private static final Logger logger = LoggerFactory.getLogger(HystrixConfig.class);

    /**
     * åˆå§‹åŒ–é…ç½?     * æ³¨æ„ï¼šå½“å‰ä¸ºäº†ç¼–è¯‘é€šè¿‡ï¼Œæš‚æ—¶ç®€åŒ–å®ç?     */
    @PostConstruct
    public void init() {
        logger.info("ç†”æ–­å™¨é…ç½®åˆå§‹åŒ–å®Œæˆï¼ˆå½“å‰ä¸ºç®€åŒ–ç‰ˆå®ç°ï¼?);
        // åç»­å¯é›†æˆSpring Cloud Circuit Breakeræˆ–å…¶ä»–ç†”æ–­ç»„ä»?    }
    
    /**
     * æœåŠ¡é…ç½®ä¿¡æ¯
     * ä¿å­˜å„æœåŠ¡çš„é»˜è®¤è¶…æ—¶å’Œå¹¶å‘é…ç½®ï¼Œä¾›åç»­é›†æˆç†”æ–­å™¨ä½¿ç”¨
     */
    public static class ServiceConfig {
        // å•†å“æœåŠ¡é…ç½®
        public static final int PRODUCT_TIMEOUT_MS = 3000;
        public static final int PRODUCT_MAX_CONCURRENT = 30;
        
        // è®¢å•æœåŠ¡é…ç½®
        public static final int ORDER_TIMEOUT_MS = 6000;
        public static final int ORDER_MAX_CONCURRENT = 20;
        
        // æ”¯ä»˜æœåŠ¡é…ç½®
        public static final int PAYMENT_TIMEOUT_MS = 4000;
        public static final int PAYMENT_MAX_CONCURRENT = 15;
        public static final int PAYMENT_ERROR_THRESHOLD = 30;
    }
}
package com.heikeji.common.core.config;

import ch.qos.logback.classic.encoder.PatternLayoutEncoder;
import ch.qos.logback.core.rolling.RollingFileAppender;
import ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.io.File;

/**
 * æ—¥å¿—å¢å¼ºé…ç½®ç±? * æä¾›æ›´å®Œå–„çš„æ—¥å¿—æ–‡ä»¶è¾“å‡ºã€è½®è½¬ç­–ç•¥å’Œæ—¥å¿—æ ¼å¼é…ç½®
 */
@Configuration
@ConfigurationProperties(prefix = "logging.enhance")
public class LogEnhanceConfig {

    private String logDir = "./logs";
    private String maxFileSize = "100MB";
    private String maxHistory = "30";
    private String totalSizeCap = "1GB";
    private boolean consolePrint = true;
    private String encoding = "UTF-8";

    /**
     * è‡ªå®šä¹‰æ—¥å¿—æ–‡ä»¶è·¯å¾?     */
    @Bean
    public String logFilePath() {
        File logDirectory = new File(logDir);
        if (!logDirectory.exists()) {
            logDirectory.mkdirs();
        }
        return logDir;
    }

    /**
     * è·å–åº”ç”¨æ—¥å¿—æ–‡ä»¶å?     */
    public String getApplicationLogFileName() {
        return logDir + File.separator + "application.log";
    }

    /**
     * è·å–é”™è¯¯æ—¥å¿—æ–‡ä»¶å?     */
    public String getErrorLogFileName() {
        return logDir + File.separator + "error.log";
    }

    /**
     * è·å–ä¸šåŠ¡æ—¥å¿—æ–‡ä»¶å?     */
    public String getBusinessLogFileName() {
        return logDir + File.separator + "business.log";
    }

    /**
     * è·å–è®¿é—®æ—¥å¿—æ–‡ä»¶å?     */
    public String getAccessLogFileName() {
        return logDir + File.separator + "access.log";
    }

    // getter and setter methods

    public String getLogDir() {
        return logDir;
    }

    public void setLogDir(String logDir) {
        this.logDir = logDir;
    }

    public String getMaxFileSize() {
        return maxFileSize;
    }

    public void setMaxFileSize(String maxFileSize) {
        this.maxFileSize = maxFileSize;
    }

    public String getMaxHistory() {
        return maxHistory;
    }

    public void setMaxHistory(String maxHistory) {
        this.maxHistory = maxHistory;
    }

    public String getTotalSizeCap() {
        return totalSizeCap;
    }

    public void setTotalSizeCap(String totalSizeCap) {
        this.totalSizeCap = totalSizeCap;
    }

    public boolean isConsolePrint() {
        return consolePrint;
    }

    public void setConsolePrint(boolean consolePrint) {
        this.consolePrint = consolePrint;
    }

    public String getEncoding() {
        return encoding;
    }

    public void setEncoding(String encoding) {
        this.encoding = encoding;
    }
}
package com.heikeji.common.core.config;

import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.cache.RedisCacheConfiguration;
import org.springframework.data.redis.cache.RedisCacheManager;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializationContext;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.time.Duration;
import java.util.HashMap;
import java.util.Map;

/**
 * Redisç¼“å­˜é…ç½®
 */
@Configuration
@EnableCaching
@ConditionalOnProperty(name = "spring.redis.host", havingValue = "localhost", matchIfMissing = true)
public class RedisCacheConfig {

    /**
     * é…ç½®Redisç¼“å­˜ç®¡ç†å™?     */
    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
        // é»˜è®¤ç¼“å­˜é…ç½®
        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(10)) // é»˜è®¤è¿‡æœŸæ—¶é—´10åˆ†é’Ÿ
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer()))
                .disableCachingNullValues(); // ä¸ç¼“å­˜nullå€?        
        // è‡ªå®šä¹‰ç¼“å­˜é…ç½?        Map<String, RedisCacheConfiguration> cacheConfigurations = new HashMap<>();
        
        // å•†å“ä¿¡æ¯ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—?0åˆ†é’Ÿ
        cacheConfigurations.put("productCache", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30))
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—?å°æ—¶
        cacheConfigurations.put("userCache", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofHours(1))
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        // è®¢å•ä¿¡æ¯ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—?åˆ†é’Ÿ
        cacheConfigurations.put("orderCache", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(5))
                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(new GenericJackson2JsonRedisSerializer())));
        
        return RedisCacheManager.builder(factory)
                .cacheDefaults(defaultConfig)
                .withInitialCacheConfigurations(cacheConfigurations)
                .build();
    }
}
package com.heikeji.common.core.constant;

/**
 * é€šç”¨å¸¸é‡ç±? * @author system
 */
public interface CommonConstants {
    
    /**
     * æˆåŠŸæ ‡è®°
     */
    Integer SUCCESS = 200;
    
    /**
     * å¤±è´¥æ ‡è®°
     */
    Integer FAIL = 500;
    
    /**
     * æœªæˆæƒæ ‡è®?     */
    Integer UNAUTHORIZED = 401;
    
    /**
     * æœªæ‰¾åˆ°èµ„æºæ ‡è®?     */
    Integer NOT_FOUND = 404;
    
    /**
     * ç¦æ­¢è®¿é—®æ ‡è®°
     */
    Integer FORBIDDEN = 403;
    
    /**
     * è¯·æ±‚å‚æ•°é”™è¯¯æ ‡è®°
     */
    Integer PARAMETER_ERROR = 400;
    
    /**
     * å“åº”æ¶ˆæ¯æˆåŠŸç ?     */
    String MSG_SUCCESS = "success";
    
    /**
     * å“åº”æ¶ˆæ¯å¤±è´¥ç ?     */
    String MSG_FAIL = "fail";
}
package com.heikeji.common.core.constant;

/**
 * é€šç”¨å¸¸é‡
 */
public class Constants {
    /** æˆåŠŸçŠ¶æ€ç  */
    public static final Integer SUCCESS = 200;
    
    /** å¤±è´¥çŠ¶æ€ç  */
    public static final Integer FAIL = 500;

    /** åˆ é™¤æ ‡å¿— - æ­£å¸¸ */
    public static final Integer DEL_FLAG_NORMAL = 0;
    
    /** åˆ é™¤æ ‡å¿— - åˆ é™¤ */
    public static final Integer DEL_FLAG_DELETE = 1;

    /** ç”¨æˆ·çŠ¶æ€?- æ­£å¸¸ */
    public static final Integer USER_STATUS_NORMAL = 0;
    
    /** ç”¨æˆ·çŠ¶æ€?- ç¦ç”¨ */
    public static final Integer USER_STATUS_DISABLE = 1;

    /** è®¢å•çŠ¶æ€?- å¾…æ”¯ä»?*/
    public static final Integer ORDER_STATUS_UNPAID = 0;
    
    /** è®¢å•çŠ¶æ€?- å·²æ”¯ä»?*/
    public static final Integer ORDER_STATUS_PAID = 1;
    
    /** è®¢å•çŠ¶æ€?- å·²å‘è´?*/
    public static final Integer ORDER_STATUS_SHIPPED = 2;
    
    /** è®¢å•çŠ¶æ€?- å·²å®Œæˆ?*/
    public static final Integer ORDER_STATUS_COMPLETED = 3;
    
    /** è®¢å•çŠ¶æ€?- å·²å–æ¶?*/
    public static final Integer ORDER_STATUS_CANCELLED = 4;

    /** é…é€æ–¹å¼?- å¤–å–æŸ?*/
    public static final Integer DELIVERY_TYPE_LOCKER = 1;
    
    /** é…é€æ–¹å¼?- ç‰¹æ®Šåœ°ç‚¹ */
    public static final Integer DELIVERY_TYPE_SPECIAL = 2;
    
    /** é…é€æ–¹å¼?- é€åˆ°å¯å®¤ */
    public static final Integer DELIVERY_TYPE_DORM = 3;
}




package com.heikeji.common.core.domain;

import com.heikeji.common.core.constant.Constants;
import lombok.Data;
import java.io.Serializable;

/**
 * ç»Ÿä¸€å“åº”ç»“æœ
 */
@Data
public class R<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    private Integer code;
    private String msg;
    private T data;
    private Long timestamp;

    public R() {
        this.timestamp = System.currentTimeMillis();
    }

    /**
     * åˆ¤æ–­å“åº”æ˜¯å¦æˆåŠŸ
     */
    public boolean isSuccess() {
        return Constants.SUCCESS.equals(code);
    }

    /**
     * æˆåŠŸè¿”å›ç»“æœ
     */
    public static <T> R<T> success() {
        return success(null);
    }

    /**
     * æˆåŠŸè¿”å›ç»“æœ
     */
    public static <T> R<T> success(T data) {
        R<T> r = new R<>();
        r.setCode(Constants.SUCCESS);
        r.setMsg("æ“ä½œæˆåŠŸ");
        r.setData(data);
        return r;
    }
    
    /**
     * æˆåŠŸè¿”å›ç»“æœï¼ˆåˆ«åæ–¹æ³•ï¼‰
     */
    public static <T> R<T> ok(T data) {
        return success(data);
    }
    
    /**
     * æˆåŠŸè¿”å›ç»“æœï¼ˆåˆ«åæ–¹æ³•ï¼‰
     */
    public static <T> R<T> ok() {
        return success(null);
    }

    /**
     * æˆåŠŸè¿”å›ç»“æœ
     */
    public static <T> R<T> success(String msg, T data) {
        R<T> r = new R<>();
        r.setCode(Constants.SUCCESS);
        r.setMsg(msg);
        r.setData(data);
        return r;
    }

    /**
     * é”™è¯¯è¿”å›ç»“æœ
     */
    public static <T> R<T> error() {
        return error("æ“ä½œå¤±è´¥");
    }

    /**
     * é”™è¯¯è¿”å›ç»“æœ
     */
    public static <T> R<T> error(String msg) {
        R<T> r = new R<>();
        r.setCode(Constants.FAIL);
        r.setMsg(msg);
        return r;
    }

    /**
     * é”™è¯¯è¿”å›ç»“æœ
     */
    public static <T> R<T> error(Integer code, String msg) {
        R<T> r = new R<>();
        r.setCode(code);
        r.setMsg(msg);
        return r;
    }

    /**
     * é“¾å¼è°ƒç”¨è®¾ç½®æ•°æ®
     */
    public R<T> setDataAndReturn(T data) {
        this.setData(data);
        return this;
    }

    /**
     * é“¾å¼è°ƒç”¨è®¾ç½®æ¶ˆæ¯
     */
    public R<T> setMsgAndReturn(String msg) {
        this.setMsg(msg);
        return this;
    }

    /**
     * é“¾å¼è°ƒç”¨è®¾ç½®çŠ¶æ€ç 
     */
    public R<T> setCodeAndReturn(Integer code) {
        this.setCode(code);
        return this;
    }
}




package com.heikeji.common.core.exception;

import com.heikeji.common.core.constant.Constants;

/**
 * åŸºç¡€å¼‚å¸¸ç±?
 */
public class BaseException extends RuntimeException {
    private static final long serialVersionUID = 1L;

    private Integer code;
    private String message;
    private Object[] args;

    /**
     * æ„é€ ä¸€ä¸ªæ²¡æœ‰è¯¦ç»†ä¿¡æ¯çš„BaseException
     */
    public BaseException() {
        this.code = Constants.FAIL;
        this.message = "æœªçŸ¥é”™è¯¯";
    }

    /**
     * ä½¿ç”¨æŒ‡å®šçš„é”™è¯¯æ¶ˆæ¯æ„é€ BaseException
     */
    public BaseException(String message) {
        super(message);
        this.code = Constants.FAIL;
        this.message = message;
    }

    /**
     * ä½¿ç”¨æŒ‡å®šçš„é”™è¯¯ç å’Œæ¶ˆæ¯æ„é€ BaseException
     */
    public BaseException(String message, Integer code) {
        super(message);
        this.code = code;
        this.message = message;
    }

    /**
     * ä½¿ç”¨æŒ‡å®šçš„é”™è¯¯æ¶ˆæ¯å’ŒåŸå› æ„é€ BaseException
     */
    public BaseException(String message, Throwable cause) {
        super(message, cause);
        this.code = Constants.FAIL;
        this.message = message;
    }

    /**
     * ä½¿ç”¨æŒ‡å®šçš„é”™è¯¯ç ã€æ¶ˆæ¯å’ŒåŸå› æ„é€ BaseException
     */
    public BaseException(String message, Integer code, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }

    /**
     * ä½¿ç”¨æŒ‡å®šçš„åŸå› æ„é€ BaseException
     */
    public BaseException(Throwable cause) {
        super(cause);
        this.code = Constants.FAIL;
        this.message = cause.getMessage();
    }

    /**
     * æ„é€ ä¸€ä¸ªå¸¦æ ¼å¼åŒ–æ¶ˆæ¯çš„BaseException
     */
    public BaseException(String message, Object... args) {
        super(String.format(message, args));
        this.code = Constants.FAIL;
        this.message = String.format(message, args);
        this.args = args;
    }

    @Override
    public String getMessage() {
        return message;
    }

    public Integer getCode() {
        return code;
    }

    public Object[] getArgs() {
        return args;
    }

    /**
     * é“¾å¼è°ƒç”¨è®¾ç½®é”™è¯¯ç ?
     */
    public BaseException setCode(Integer code) {
        this.code = code;
        return this;
    }

    /**
     * é“¾å¼è°ƒç”¨è®¾ç½®é”™è¯¯æ¶ˆæ¯
     */
    public BaseException setMessage(String message) {
        this.message = message;
        return this;
    }
}




package com.heikeji.common.core.health;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import jakarta.annotation.Resource;
import javax.sql.DataSource;
import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.ResultSet;
import java.util.HashMap;
import java.util.Map;

/**
 * æ•°æ®åº“å¥åº·æ£€æŸ¥æŒ‡ç¤ºå™¨
 * ç”¨äºæ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
 */
@Component
public class DatabaseHealthIndicator {

    private static final Logger log = LoggerFactory.getLogger(DatabaseHealthIndicator.class);

    @Resource
    private DataSource dataSource;

    /**
     * æ‰§è¡Œå¥åº·æ£€æŸ?     * æš‚æ—¶ä¸ä¾èµ–Spring Boot Actuatorå’ŒJdbcTemplate
     */
    public Map<String, Object> checkHealth() {
        Map<String, Object> healthInfo = new HashMap<>();
        
        if (dataSource == null) {
            healthInfo.put("status", "DOWN");
            healthInfo.put("error", "DataSource not available");
            return healthInfo;
        }

        try (Connection connection = dataSource.getConnection()) {
            // è·å–æ•°æ®åº“å…ƒä¿¡æ¯
            DatabaseMetaData metaData = connection.getMetaData();
            
            // æ”¶é›†æ•°æ®åº“åŸºæœ¬ä¿¡æ?            Map<String, Object> dbDetails = new HashMap<>();
            dbDetails.put("database_product", metaData.getDatabaseProductName());
            dbDetails.put("database_version", metaData.getDatabaseProductVersion());
            dbDetails.put("driver_name", metaData.getDriverName());
            dbDetails.put("driver_version", metaData.getDriverVersion());
            dbDetails.put("url", metaData.getURL());
            
            // æ‰§è¡Œç®€å•çš„æŸ¥è¯¢æµ‹è¯•ï¼ˆä½¿ç”¨çº¯JDBCï¼?            long startTime = System.currentTimeMillis();
            boolean querySuccess = false;
            try (ResultSet rs = connection.createStatement().executeQuery("SELECT 1 FROM DUAL")) {
                if (rs.next()) {
                    int result = rs.getInt(1);
                    querySuccess = result == 1;
                }
            }
            long queryTime = System.currentTimeMillis() - startTime;
            
            dbDetails.put("query_test", querySuccess ? "success" : "failed");
            dbDetails.put("query_time_ms", queryTime);
            dbDetails.put("connection_valid", connection.isValid(5));
            dbDetails.put("data_source_type", dataSource.getClass().getName());
            
            // æ ¹æ®æŸ¥è¯¢æ—¶é—´åˆ¤æ–­æ•°æ®åº“æ€§èƒ½çŠ¶æ€?            String performanceStatus = "normal";
            if (queryTime > 500) {
                performanceStatus = "slow";
            }
            dbDetails.put("performance_status", performanceStatus);
            
            healthInfo.put("status", "UP");
            healthInfo.putAll(dbDetails);
                    
            log.debug("Database health check passed: {}", dbDetails);
            
        } catch (Exception e) {
            log.error("Database health check failed", e);
            healthInfo.put("status", "DOWN");
            healthInfo.put("error", e.getMessage());
            healthInfo.put("exception", e.getClass().getName());
        }
        
        return healthInfo;
    }
}
package com.heikeji.common.core.health;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.redis.connection.RedisConnection;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.stereotype.Component;

import jakarta.annotation.Resource;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

/**
 * Rediså¥åº·æ£€æŸ¥æŒ‡ç¤ºå™¨
 * ç”¨äºæ£€æŸ¥Redisè¿æ¥çŠ¶æ€å’ŒåŸºæœ¬æ“ä½œ
 */
@Component
public class RedisHealthIndicator {

    private static final Logger log = LoggerFactory.getLogger(RedisHealthIndicator.class);

    @Resource
    private RedisConnectionFactory redisConnectionFactory;

    /**
     * æ‰§è¡Œå¥åº·æ£€æŸ?     * æš‚æ—¶ä¸ä¾èµ–Spring Boot Actuator
     */
    public Map<String, Object> checkHealth() {
        Map<String, Object> healthInfo = new HashMap<>();
        
        if (redisConnectionFactory == null) {
            healthInfo.put("status", "DOWN");
            healthInfo.put("error", "Redis connection factory not available");
            return healthInfo;
        }

        try (RedisConnection connection = redisConnectionFactory.getConnection()) {
            // æµ‹è¯•Redisè¿æ¥
            // æ³¨æ„ï¼šæŸäº›Rediså®¢æˆ·ç«¯çš„pingæ–¹æ³•å¯èƒ½è¿”å›String
            Object pingResultObj = connection.ping();
            String result;
            if (pingResultObj instanceof byte[]) {
                result = new String((byte[]) pingResultObj, java.nio.charset.StandardCharsets.UTF_8);
            } else if (pingResultObj instanceof String) {
                result = (String) pingResultObj;
            } else {
                result = "PONG"; // é»˜è®¤å€?            }
            
            // æµ‹è¯•åŸºæœ¬æ“ä½œ - è®¾ç½®ä¸€ä¸ªä¸´æ—¶é”®å€¼å¯¹
            byte[] key = "health_check_test".getBytes();
            byte[] value = String.valueOf(System.currentTimeMillis()).getBytes();
            connection.set(key, value);
            
            // æµ‹è¯•è¯»å–æ“ä½œ
            byte[] getValue = connection.get(key);
            
            // æµ‹è¯•åˆ é™¤æ“ä½œ
            connection.del(key);
            
            // æ£€æŸ¥è¿æ¥æ± ç»Ÿè®¡ä¿¡æ¯
            Map<String, Object> redisDetails = new HashMap<>();
            redisDetails.put("ping_result", result);
            redisDetails.put("read_write_test", Arrays.equals(value, getValue));
            redisDetails.put("connection_string", redisConnectionFactory.toString());
            
            healthInfo.put("status", "UP");
            healthInfo.putAll(redisDetails);
                    
            log.debug("Redis health check passed: {}", redisDetails);
            
        } catch (Exception e) {
            log.error("Redis health check failed", e);
            healthInfo.put("status", "DOWN");
            healthInfo.put("error", e.getMessage());
            healthInfo.put("exception", e.getClass().getName());
        }
        
        return healthInfo;
    }
}
package com.heikeji.common.core.monitor;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

/**
 * ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†å™? * ç”¨äºæ”¶é›†å’Œç»Ÿè®¡å…³é”®ä¸šåŠ¡æŒ‡æ ‡æ•°æ? */
@Component
public class MetricsCollector {

    private static final Logger log = LoggerFactory.getLogger("metrics");
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyyMMdd");
    private static final DateTimeFormatter TIME_FORMATTER = DateTimeFormatter.ofPattern("HH");

    @Autowired(required = false)
    private RedisTemplate<String, String> redisTemplate;

    /**
     * è®¡æ•°å™¨å‰ç¼€
     */
    private static final String COUNTER_PREFIX = "metrics:counter:";
    
    /**
     * ç»Ÿè®¡æ•°æ®å‰ç¼€
     */
    private static final String STATS_PREFIX = "metrics:stats:";
    
    /**
     * è®°å½•ç”¨æˆ·æ³¨å†Œæ•°é‡
     */
    public void recordUserRegister() {
        incrementCounter("user:register");
    }
    
    /**
     * è®°å½•è®¢å•åˆ›å»ºæ•°é‡
     */
    public void recordOrderCreate() {
        incrementCounter("order:create");
    }
    
    /**
     * è®°å½•è®¢å•æ”¯ä»˜æ•°é‡
     */
    public void recordOrderPay() {
        incrementCounter("order:pay");
    }
    
    /**
     * è®°å½•è®¢å•å–æ¶ˆæ•°é‡
     */
    public void recordOrderCancel() {
        incrementCounter("order:cancel");
    }
    
    /**
     * è®°å½•å•†å“æµè§ˆé‡?     * @param productId å•†å“ID
     */
    public void recordProductView(Long productId) {
        incrementCounter("product:view:" + productId);
    }
    
    /**
     * è®°å½•å•†å“è´­ä¹°é‡?     * @param productId å•†å“ID
     */
    public void recordProductBuy(Long productId) {
        incrementCounter("product:buy:" + productId);
    }
    
    /**
     * è®°å½•æ¥å£è°ƒç”¨æ¬¡æ•°
     * @param apiName æ¥å£åç§°
     */
    public void recordApiCall(String apiName) {
        incrementCounter("api:call:" + apiName);
    }
    
    /**
     * è®°å½•æ¥å£è°ƒç”¨è€—æ—¶
     * @param apiName æ¥å£åç§°
     * @param costTime è€—æ—¶(æ¯«ç§’)
     */
    public void recordApiCostTime(String apiName, long costTime) {
        String dateStr = LocalDate.now().format(DATE_FORMATTER);
        String hourStr = LocalDateTime.now().format(TIME_FORMATTER);
        String key = STATS_PREFIX + "api:cost:" + apiName + ":" + dateStr + ":" + hourStr;
        
        // è®°å½•æ¥å£è€—æ—¶ä¿¡æ¯
        recordStats(key, costTime);
        
        // è®°å½•æ…¢æ¥å£å‘Šè­?        if (costTime > 1000) { // 1ç§’ä»¥ä¸Šè§†ä¸ºæ…¢æ¥å£
            log.warn("æ…¢æ¥å£å‘Šè­? {} è€—æ—¶ {}ms", apiName, costTime);
        }
    }
    
    /**
     * è®°å½•ç³»ç»Ÿé”™è¯¯
     * @param errorType é”™è¯¯ç±»å‹
     */
    public void recordSystemError(String errorType) {
        incrementCounter("system:error:" + errorType);
    }
    
    /**
     * è®°å½•ç¼“å­˜å‘½ä¸­ç?     * @param cacheName ç¼“å­˜åç§°
     * @param hit æ˜¯å¦å‘½ä¸­
     */
    public void recordCacheHit(String cacheName, boolean hit) {
        if (hit) {
            incrementCounter("cache:hit:" + cacheName);
        } else {
            incrementCounter("cache:miss:" + cacheName);
        }
    }
    
    /**
     * å¢åŠ è®¡æ•°å™?     * @param key è®¡æ•°å™¨é”®
     */
    private void incrementCounter(String key) {
        String dateStr = LocalDate.now().format(DATE_FORMATTER);
        String counterKey = COUNTER_PREFIX + key + ":" + dateStr;
        
        try {
            // å¦‚æœæœ‰Redisï¼Œåˆ™ä½¿ç”¨Redisè¿›è¡Œè®¡æ•°
            if (redisTemplate != null) {
                redisTemplate.opsForValue().increment(counterKey);
                // è®¾ç½®è¿‡æœŸæ—¶é—´ä¸?å¤?                redisTemplate.expire(counterKey, 7, TimeUnit.DAYS);
            } else {
                // å¦‚æœæ²¡æœ‰Redisï¼Œè®°å½•åˆ°æ—¥å¿—
                log.info("Counter increment: {}", counterKey);
            }
        } catch (Exception e) {
            log.error("Increment counter failed: {}", key, e);
        }
    }
    
    /**
     * è®°å½•ç»Ÿè®¡æ•°æ®
     * @param key ç»Ÿè®¡é”?     * @param value ç»Ÿè®¡å€?     */
    private void recordStats(String key, long value) {
        try {
            if (redisTemplate != null) {
                // ä½¿ç”¨Listå­˜å‚¨ç»Ÿè®¡æ•°æ®
                redisTemplate.opsForList().leftPush(key, String.valueOf(value));
                // è®¾ç½®è¿‡æœŸæ—¶é—´ä¸?å¤?                redisTemplate.expire(key, 7, TimeUnit.DAYS);
                
                // ç»´æŠ¤æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰ç»Ÿè®¡ä¿¡æ¯
                String maxKey = key + ":max";
                String minKey = key + ":min";
                String sumKey = key + ":sum";
                String countKey = key + ":count";
                
                // æ¯”è¾ƒå¹¶æ›´æ–°æœ€å¤§å€?                String currentMax = redisTemplate.opsForValue().get(maxKey);
                if (currentMax == null || value > Long.parseLong(currentMax)) {
                    redisTemplate.opsForValue().set(maxKey, String.valueOf(value));
                    redisTemplate.expire(maxKey, 7, TimeUnit.DAYS);
                }
                
                // æ¯”è¾ƒå¹¶æ›´æ–°æœ€å°å€?                String currentMin = redisTemplate.opsForValue().get(minKey);
                if (currentMin == null || value < Long.parseLong(currentMin)) {
                    redisTemplate.opsForValue().set(minKey, String.valueOf(value));
                    redisTemplate.expire(minKey, 7, TimeUnit.DAYS);
                }
                
                // æ›´æ–°æ€»å’Œå’Œè®¡æ•?                redisTemplate.opsForValue().increment(sumKey, value);
                redisTemplate.expire(sumKey, 7, TimeUnit.DAYS);
                
                redisTemplate.opsForValue().increment(countKey);
                redisTemplate.expire(countKey, 7, TimeUnit.DAYS);
            } else {
                // å¦‚æœæ²¡æœ‰Redisï¼Œè®°å½•åˆ°æ—¥å¿—
                log.info("Stats record: {} = {}", key, value);
            }
        } catch (Exception e) {
            log.error("Record stats failed: {}", key, e);
        }
    }
    
    /**
     * è·å–å½“æ—¥ç»Ÿè®¡æ•°æ®
     * @param metricName æŒ‡æ ‡åç§°
     * @return ç»Ÿè®¡æ•°æ®
     */
    public Map<String, Object> getDailyStats(String metricName) {
        Map<String, Object> result = new HashMap<>();
        String dateStr = LocalDate.now().format(DATE_FORMATTER);
        String counterKey = COUNTER_PREFIX + metricName + ":" + dateStr;
        
        try {
            if (redisTemplate != null) {
                String value = redisTemplate.opsForValue().get(counterKey);
                result.put("count", value != null ? Long.parseLong(value) : 0);
            } else {
                result.put("count", 0);
                result.put("message", "Redis not available");
            }
        } catch (Exception e) {
            log.error("Get daily stats failed: {}", metricName, e);
            result.put("count", 0);
            result.put("error", e.getMessage());
        }
        
        return result;
    }
    
    /**
     * è·å–æ¥å£è€—æ—¶ç»Ÿè®¡
     * @param apiName æ¥å£åç§°
     * @return è€—æ—¶ç»Ÿè®¡æ•°æ®
     */
    public Map<String, Object> getApiCostStats(String apiName) {
        Map<String, Object> result = new HashMap<>();
        String dateStr = LocalDate.now().format(DATE_FORMATTER);
        String hourStr = LocalDateTime.now().format(TIME_FORMATTER);
        String key = STATS_PREFIX + "api:cost:" + apiName + ":" + dateStr + ":" + hourStr;
        
        try {
            if (redisTemplate != null) {
                String maxValue = redisTemplate.opsForValue().get(key + ":max");
                String minValue = redisTemplate.opsForValue().get(key + ":min");
                String sumValue = redisTemplate.opsForValue().get(key + ":sum");
                String countValue = redisTemplate.opsForValue().get(key + ":count");
                
                result.put("max", maxValue != null ? Long.parseLong(maxValue) : 0);
                result.put("min", minValue != null ? Long.parseLong(minValue) : 0);
                result.put("sum", sumValue != null ? Long.parseLong(sumValue) : 0);
                result.put("count", countValue != null ? Long.parseLong(countValue) : 0);
                
                if (countValue != null && Long.parseLong(countValue) > 0) {
                    result.put("avg", Long.parseLong(sumValue) / Long.parseLong(countValue));
                } else {
                    result.put("avg", 0);
                }
            } else {
                result.put("max", 0);
                result.put("min", 0);
                result.put("avg", 0);
                result.put("sum", 0);
                result.put("count", 0);
                result.put("message", "Redis not available");
            }
        } catch (Exception e) {
            log.error("Get api cost stats failed: {}", apiName, e);
            result.put("error", e.getMessage());
        }
        
        return result;
    }
}
package com.heikeji.common.core.service;

import java.util.Set;

/**
 * æƒé™æœåŠ¡æ¥å£
 * å®šä¹‰æƒé™ç›¸å…³çš„é€šç”¨æœåŠ¡æ–¹æ³•ï¼Œç”±å…·ä½“ä¸šåŠ¡æ¨¡å—å®ç°
 */
public interface PermissionService {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·æ‹¥æœ‰çš„æƒé™ç¼–ç åˆ—è¡?     * @param userId ç”¨æˆ·ID
     * @return æƒé™ç¼–ç é›†åˆ
     */
    Set<String> getPermissionCodesByUserId(Long userId);
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™?     * @param userId ç”¨æˆ·ID
     * @param permissionCode æƒé™ç¼–ç 
     * @return æ˜¯å¦æ‹¥æœ‰æƒé™
     */
    boolean hasPermission(Long userId, String permissionCode);
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰å¤šä¸ªæŒ‡å®šæƒé™ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ˆORå…³ç³»ï¼?     * @param userId ç”¨æˆ·ID
     * @param permissionCodes æƒé™ç¼–ç æ•°ç»„
     * @return æ˜¯å¦æ‹¥æœ‰è‡³å°‘ä¸€ä¸ªæƒé™?     */
    boolean hasAnyPermission(Long userId, String[] permissionCodes);
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰æŒ‡å®šæƒé™ï¼ˆANDå…³ç³»ï¼?     * @param userId ç”¨æˆ·ID
     * @param permissionCodes æƒé™ç¼–ç æ•°ç»„
     * @return æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰æƒé™?     */
    boolean hasAllPermissions(Long userId, String[] permissionCodes);
}
package com.heikeji.common.core.trace;

import org.slf4j.MDC;
import org.springframework.util.StringUtils;

import java.util.UUID;

/**
 * é“¾è·¯è¿½è¸ªä¸Šä¸‹æ–? * ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è·Ÿè¸ªè¯·æ±‚è°ƒç”¨é“¾
 */
public class TraceContext {

    /**
     * è·Ÿè¸ªIDçš„é”®å?     */
    public static final String TRACE_ID_KEY = "traceId";
    
    /**
     * çˆ¶Span IDçš„é”®å?     */
    public static final String PARENT_SPAN_ID_KEY = "parentSpanId";
    
    /**
     * å½“å‰Span IDçš„é”®å?     */
    public static final String SPAN_ID_KEY = "spanId";

    /**
     * ç”Ÿæˆæ–°çš„è·Ÿè¸ªID
     */
    public static String generateTraceId() {
        return UUID.randomUUID().toString().replace("-", "");
    }

    /**
     * ç”Ÿæˆæ–°çš„Span ID
     */
    public static String generateSpanId() {
        return UUID.randomUUID().toString().substring(0, 16);
    }

    /**
     * å¼€å§‹ä¸€ä¸ªæ–°çš„è·Ÿè¸ªä¸Šä¸‹æ–‡
     * å¦‚æœå·²æœ‰è·Ÿè¸ªIDåˆ™ç»§ç»­ä½¿ç”¨ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„
     */
    public static void startTrace(String traceId, String parentSpanId) {
        // å¦‚æœæ²¡æœ‰æä¾›traceIdï¼Œç”Ÿæˆæ–°çš?        if (!StringUtils.hasText(traceId)) {
            traceId = generateTraceId();
        }
        
        // å¦‚æœæ²¡æœ‰æä¾›parentSpanIdï¼Œè®¾ç½®ä¸ºç©?        if (!StringUtils.hasText(parentSpanId)) {
            parentSpanId = "";
        }
        
        // ç”Ÿæˆå½“å‰spanId
        String spanId = generateSpanId();
        
        // è®¾ç½®åˆ°MDCä¸?        MDC.put(TRACE_ID_KEY, traceId);
        MDC.put(PARENT_SPAN_ID_KEY, parentSpanId);
        MDC.put(SPAN_ID_KEY, spanId);
    }

    /**
     * å¼€å§‹ä¸€ä¸ªæ–°çš„è·Ÿè¸ªä¸Šä¸‹æ–‡
     */
    public static void startTrace() {
        startTrace(null, null);
    }

    /**
     * å¼€å§‹ä¸€ä¸ªå­Span
     */
    public static void startChildSpan() {
        String traceId = getTraceId();
        String parentSpanId = getSpanId();
        
        if (StringUtils.hasText(traceId)) {
            String newSpanId = generateSpanId();
            MDC.put(PARENT_SPAN_ID_KEY, parentSpanId);
            MDC.put(SPAN_ID_KEY, newSpanId);
        } else {
            // å¦‚æœæ²¡æœ‰å½“å‰è·Ÿè¸ªä¸Šä¸‹æ–‡ï¼Œå¼€å§‹ä¸€ä¸ªæ–°çš?            startTrace();
        }
    }

    /**
     * è·å–å½“å‰è·Ÿè¸ªID
     */
    public static String getTraceId() {
        return MDC.get(TRACE_ID_KEY);
    }

    /**
     * è·å–çˆ¶Span ID
     */
    public static String getParentSpanId() {
        return MDC.get(PARENT_SPAN_ID_KEY);
    }

    /**
     * è·å–å½“å‰Span ID
     */
    public static String getSpanId() {
        return MDC.get(SPAN_ID_KEY);
    }

    /**
     * è®¾ç½®è·Ÿè¸ªID
     */
    public static void setTraceId(String traceId) {
        if (StringUtils.hasText(traceId)) {
            MDC.put(TRACE_ID_KEY, traceId);
        }
    }

    /**
     * æ¸…ç†è·Ÿè¸ªä¸Šä¸‹æ–?     */
    public static void clear() {
        MDC.remove(TRACE_ID_KEY);
        MDC.remove(PARENT_SPAN_ID_KEY);
        MDC.remove(SPAN_ID_KEY);
    }

    /**
     * æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„è·Ÿè¸ªä¸Šä¸‹æ–‡
     */
    public static boolean isActive() {
        return StringUtils.hasText(getTraceId());
    }

    /**
     * è·å–è·Ÿè¸ªä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”¨äºä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
     */
    public static TraceInfo getTraceInfo() {
        TraceInfo info = new TraceInfo();
        info.setTraceId(getTraceId());
        info.setParentSpanId(getSpanId()); // ä¸‹æ¸¸çš„parentSpanIdæ˜¯å½“å‰çš„spanId
        return info;
    }

    /**
     * è·Ÿè¸ªä¿¡æ¯å¯¹è±¡
     * ç”¨äºåœ¨æœåŠ¡é—´ä¼ é€’è·Ÿè¸ªä¸Šä¸‹æ–‡
     */
    public static class TraceInfo {
        private String traceId;
        private String parentSpanId;

        public String getTraceId() {
            return traceId;
        }

        public void setTraceId(String traceId) {
            this.traceId = traceId;
        }

        public String getParentSpanId() {
            return parentSpanId;
        }

        public void setParentSpanId(String parentSpanId) {
            this.parentSpanId = parentSpanId;
        }

        @Override
        public String toString() {
            return "TraceInfo{" +
                    "traceId='" + traceId + '\'' +
                    ", parentSpanId='" + parentSpanId + '\'' +
                    '}';
        }
    }
}
package com.heikeji.common.core.utils;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.heikeji.common.core.domain.R;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

/**
 * APIå“åº”å·¥å…·ç±»ï¼Œæä¾›ç»Ÿä¸€çš„APIå“åº”æ ¼å¼å¤„ç†
 */
public class ApiResultUtils {

    private static final ObjectMapper objectMapper = new ObjectMapper();

    /**
     * æˆåŠŸå“åº”
     * @param data å“åº”æ•°æ®
     * @return R å¯¹è±¡
     */
    public static <T> R<T> success(T data) {
        return R.ok(data);
    }

    /**
     * æˆåŠŸå“åº”ï¼Œæ— æ•°æ®
     * @return R å¯¹è±¡
     */
    public static <T> R<T> success() {
        return R.ok();
    }

    /**
     * é”™è¯¯å“åº”
     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> error(int code, String message) {
        return R.error(code, message);
    }

    /**
     * é”™è¯¯å“åº”ï¼Œä½¿ç”¨é»˜è®¤é”™è¯¯ç 
     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> error(String message) {
        return R.error(message);
    }

    /**
     * å“åº”400é”™è¯¯
     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> badRequest(String message) {
        return R.error(400, message);
    }

    /**
     * å“åº”401é”™è¯¯
     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> unauthorized(String message) {
        return R.error(401, message);
    }

    /**
     * å“åº”403é”™è¯¯
     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> forbidden(String message) {
        return R.error(403, message);
    }

    /**
     * å“åº”404é”™è¯¯
     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> notFound(String message) {
        return R.error(404, message);
    }

    /**
     * å“åº”500é”™è¯¯
     * @param message é”™è¯¯æ¶ˆæ¯
     * @return R å¯¹è±¡
     */
    public static <T> R<T> serverError(String message) {
        return R.error(500, message);
    }

    /**
     * å°†Rå¯¹è±¡è½¬æ¢ä¸ºResponseEntity
     * @param r Rå¯¹è±¡
     * @return ResponseEntityå¯¹è±¡
     */
    public static <T> ResponseEntity<R<T>> toResponseEntity(R<T> r) {
        HttpStatus status = r.getCode() == 200 ? HttpStatus.OK : HttpStatus.INTERNAL_SERVER_ERROR;
        if (r.getCode() >= 400 && r.getCode() < 500) {
            try {
                status = HttpStatus.valueOf(r.getCode());
            } catch (IllegalArgumentException e) {
                status = HttpStatus.BAD_REQUEST;
            }
        }
        return new ResponseEntity<>(r, status);
    }

    /**
     * ç›´æ¥è¾“å‡ºJSONå“åº”åˆ°HttpServletResponse
     * @param response HttpServletResponse
     * @param data å“åº”æ•°æ®
     */
    public static void writeJson(HttpServletResponse response, Object data) {
        response.setContentType("application/json;charset=UTF-8");
        response.setCharacterEncoding("UTF-8");
        try (PrintWriter writer = response.getWriter()) {
            writer.write(objectMapper.writeValueAsString(data));
            writer.flush();
        } catch (IOException e) {
            throw new RuntimeException("è¾“å‡ºJSONå“åº”å¤±è´¥", e);
        }
    }

    /**
     * ç›´æ¥è¾“å‡ºé”™è¯¯JSONå“åº”
     * @param response HttpServletResponse
     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public static void writeErrorJson(HttpServletResponse response, int code, String message) {
        response.setContentType("application/json;charset=UTF-8");
        response.setCharacterEncoding("UTF-8");
        response.setStatus(code);
        writeJson(response, error(code, message));
    }
}
package com.heikeji.common.core.utils;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.time.*;
import java.time.format.DateTimeFormatter;
import java.time.temporal.TemporalAdjusters;
import java.util.Calendar;
import java.util.Date;
import java.util.TimeZone;

/**
 * æ—¥æœŸå·¥å…·ç±? */
public class DateUtils {
    // å¸¸ç”¨æ—¥æœŸæ ¼å¼
    public static final String DATE_FORMAT_YMD = "yyyy-MM-dd";
    public static final String DATE_FORMAT_YMD_HM = "yyyy-MM-dd HH:mm";
    public static final String DATE_FORMAT_YMD_HMS = "yyyy-MM-dd HH:mm:ss";
    public static final String DATE_FORMAT_YM = "yyyy-MM";
    public static final String DATE_FORMAT_MD = "MM-dd";
    public static final String DATE_FORMAT_HM = "HH:mm";
    public static final String DATE_FORMAT_HMS = "HH:mm:ss";

    /**
     * è·å–å½“å‰æ—¥æœŸ
     */
    public static Date getNowDate() {
        return new Date();
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸä¸ºå­—ç¬¦ä¸?     */
    public static String formatDate(Date date, String format) {
        if (date == null || format == null) {
            return null;
        }
        SimpleDateFormat sdf = new SimpleDateFormat(format);
        return sdf.format(date);
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸä¸ºé»˜è®¤æ ¼å¼ï¼šyyyy-MM-dd HH:mm:ss
     */
    public static String formatDate(Date date) {
        return formatDate(date, DATE_FORMAT_YMD_HMS);
    }

    /**
     * å°†å­—ç¬¦ä¸²è§£æä¸ºæ—¥æœ?     */
    public static Date parseDate(String dateStr, String format) {
        if (dateStr == null || format == null) {
            return null;
        }
        SimpleDateFormat sdf = new SimpleDateFormat(format);
        try {
            return sdf.parse(dateStr);
        } catch (ParseException e) {
            throw new RuntimeException("æ—¥æœŸè§£æå¼‚å¸¸: " + dateStr, e);
        }
    }

    /**
     * æ·»åŠ å¤©æ•°
     */
    public static Date addDays(Date date, int days) {
        if (date == null) {
            return null;
        }
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.add(Calendar.DAY_OF_MONTH, days);
        return calendar.getTime();
    }

    /**
     * æ·»åŠ å°æ—¶
     */
    public static Date addHours(Date date, int hours) {
        if (date == null) {
            return null;
        }
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.add(Calendar.HOUR_OF_DAY, hours);
        return calendar.getTime();
    }

    /**
     * è·å–ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°å·®
     */
    public static long getDaysDiff(Date startDate, Date endDate) {
        if (startDate == null || endDate == null) {
            return 0;
        }
        long diff = endDate.getTime() - startDate.getTime();
        return diff / (24 * 60 * 60 * 1000);
    }

    /**
     * è·å–å½“å‰æ—¥æœŸçš„å¼€å§‹æ—¶é—´ï¼ˆ00:00:00ï¼?     */
    public static Date getStartOfDay(Date date) {
        if (date == null) {
            return null;
        }
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.set(Calendar.HOUR_OF_DAY, 0);
        calendar.set(Calendar.MINUTE, 0);
        calendar.set(Calendar.SECOND, 0);
        calendar.set(Calendar.MILLISECOND, 0);
        return calendar.getTime();
    }

    /**
     * è·å–å½“å‰æ—¥æœŸçš„ç»“æŸæ—¶é—´ï¼ˆ23:59:59ï¼?     */
    public static Date getEndOfDay(Date date) {
        if (date == null) {
            return null;
        }
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.set(Calendar.HOUR_OF_DAY, 23);
        calendar.set(Calendar.MINUTE, 59);
        calendar.set(Calendar.SECOND, 59);
        calendar.set(Calendar.MILLISECOND, 999);
        return calendar.getTime();
    }

    /**
     * è·å–å½“å‰æœˆä»½çš„ç¬¬ä¸€å¤?     */
    public static Date getFirstDayOfMonth(Date date) {
        if (date == null) {
            return null;
        }
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.set(Calendar.DAY_OF_MONTH, 1);
        return getStartOfDay(calendar.getTime());
    }

    /**
     * è·å–å½“å‰æœˆä»½çš„æœ€åä¸€å¤?     */
    public static Date getLastDayOfMonth(Date date) {
        if (date == null) {
            return null;
        }
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.set(Calendar.DAY_OF_MONTH, calendar.getActualMaximum(Calendar.DAY_OF_MONTH));
        return getEndOfDay(calendar.getTime());
    }

    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€å¤?     */
    public static boolean isSameDay(Date date1, Date date2) {
        if (date1 == null || date2 == null) {
            return false;
        }
        Calendar cal1 = Calendar.getInstance();
        Calendar cal2 = Calendar.getInstance();
        cal1.setTime(date1);
        cal2.setTime(date2);
        return cal1.get(Calendar.YEAR) == cal2.get(Calendar.YEAR) &&
                cal1.get(Calendar.MONTH) == cal2.get(Calendar.MONTH) &&
                cal1.get(Calendar.DAY_OF_MONTH) == cal2.get(Calendar.DAY_OF_MONTH);
    }

    /**
     * è½¬æ¢ä¸ºLocalDateTime
     */
    public static LocalDateTime dateToLocalDateTime(Date date) {
        if (date == null) {
            return null;
        }
        return LocalDateTime.ofInstant(date.toInstant(), ZoneId.systemDefault());
    }

    /**
     * è½¬æ¢ä¸ºDate
     */
    public static Date localDateTimeToDate(LocalDateTime localDateTime) {
        if (localDateTime == null) {
            return null;
        }
        return Date.from(localDateTime.atZone(ZoneId.systemDefault()).toInstant());
    }

    /**
     * æ ¼å¼åŒ–LocalDateTime
     */
    public static String formatLocalDateTime(LocalDateTime localDateTime, String format) {
        if (localDateTime == null || format == null) {
            return null;
        }
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(format);
        return localDateTime.format(formatter);
    }

    /**
     * è§£æå­—ç¬¦ä¸²ä¸ºLocalDateTime
     */
    public static LocalDateTime parseLocalDateTime(String dateStr, String format) {
        if (dateStr == null || format == null) {
            return null;
        }
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(format);
        return LocalDateTime.parse(dateStr, formatter);
    }

    /**
     * è·å–æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
     */
    public static long getTimestampSeconds() {
        return System.currentTimeMillis() / 1000;
    }

    /**
     * è·å–æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼?     */
    public static long getTimestampMillis() {
        return System.currentTimeMillis();
    }

    /**
     * è·å–ç›¸å¯¹æ—¶é—´æè¿°ï¼ˆå¦‚ï¼šåˆšåˆšã€?åˆ†é’Ÿå‰ã€?å°æ—¶å‰ç­‰ï¼?     */
    public static String getRelativeTimeString(Date date) {
        if (date == null) {
            return "";
        }
        long currentTime = System.currentTimeMillis();
        long diff = currentTime - date.getTime();
        
        if (diff < 60 * 1000) { // 1åˆ†é’Ÿå†?            return "åˆšåˆš";
        } else if (diff < 60 * 60 * 1000) { // 1å°æ—¶å†?            long minutes = diff / (60 * 1000);
            return minutes + "åˆ†é’Ÿå‰?;
        } else if (diff < 24 * 60 * 60 * 1000) { // 1å¤©å†…
            long hours = diff / (60 * 60 * 1000);
            return hours + "å°æ—¶å‰?;
        } else if (diff < 30 * 24 * 60 * 60 * 1000) { // 30å¤©å†…
            long days = diff / (24 * 60 * 60 * 1000);
            return days + "å¤©å‰";
        } else {
            return formatDate(date, DATE_FORMAT_YMD);
        }
    }
}
package com.heikeji.common.core.utils;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.reflect.MethodSignature;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.reflect.Method;
import java.util.Arrays;

/**
 * æ—¥å¿—å·¥å…·ç±? * @author system
 */
public class LogUtils {
    
    private static final Logger logger = LoggerFactory.getLogger(LogUtils.class);
    
    /**
     * è·å–æ—¥å¿—è®°å½•å™?     * @param clazz ç±?     * @return Logger
     */
    public static Logger getLogger(Class<?> clazz) {
        return LoggerFactory.getLogger(clazz);
    }
    
    /**
     * è·å–æ–¹æ³•ç­¾åä¿¡æ¯
     * @param joinPoint åˆ‡ç‚¹
     * @return æ–¹æ³•ç­¾åä¿¡æ¯
     */
    public static String getMethodSignature(ProceedingJoinPoint joinPoint) {
        MethodSignature signature = (MethodSignature) joinPoint.getSignature();
        Method method = signature.getMethod();
        String className = joinPoint.getTarget().getClass().getName();
        String methodName = method.getName();
        String params = Arrays.toString(joinPoint.getArgs());
        return className + "." + methodName + "(" + params + ")";
    }
    
    /**
     * è®°å½•æ“ä½œæ—¥å¿—
     * @param module æ¨¡å—åç§°
     * @param operation æ“ä½œæè¿°
     * @param username ç”¨æˆ·å?     * @param params å‚æ•°
     */
    public static void recordOperationLog(String module, String operation, String username, String params) {
        logger.info("[æ“ä½œæ—¥å¿—] æ¨¡å—: {}, æ“ä½œ: {}, ç”¨æˆ·å? {}, å‚æ•°: {}", 
                module, operation, username, params != null ? params : "æ—?);
    }
    
    /**
     * è®°å½•é”™è¯¯æ—¥å¿—
     */
    public static void error(Logger logger, String message, Exception e) {
        if (logger != null) {
            logger.error(message, e);
        }
    }
}
package com.heikeji.common.core.utils;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * å­—ç¬¦ä¸²å·¥å…·ç±»
 */
public class StringUtils {
    private static final Pattern PHONE_PATTERN = Pattern.compile("^1[3-9]\\d{9}$");
    private static final Pattern EMAIL_PATTERN = Pattern.compile("^[\\w-]+(\\.[\\w-]+)*@[\\w-]+(\\.[\\w-]+)+$");
    private static final Pattern ID_CARD_PATTERN = Pattern.compile("^[1-9]\\d{5}(19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[\\dXx]$");

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©?     */
    public static boolean isEmpty(CharSequence cs) {
        return cs == null || cs.length() == 0;
    }

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ä¸ºç©º
     */
    public static boolean isNotEmpty(CharSequence cs) {
        return !isEmpty(cs);
    }

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºç™½ï¼ˆnullã€ç©ºå­—ç¬¦ä¸²æˆ–åªåŒ…å«ç©ºæ ¼ï¼‰
     */
    public static boolean isBlank(CharSequence cs) {
        if (cs == null || cs.length() == 0) {
            return true;
        }
        for (int i = 0; i < cs.length(); i++) {
            if (!Character.isWhitespace(cs.charAt(i))) {
                return false;
            }
        }
        return true;
    }

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ä¸ºç©ºç™?     */
    public static boolean isNotBlank(CharSequence cs) {
        return !isBlank(cs);
    }

    /**
     * å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„ç©ºç™½
     */
    public static String trim(String str) {
        return str == null ? null : str.trim();
    }

    /**
     * å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„ç©ºç™½ï¼Œå¦‚æœç»“æœä¸ºç©ºå­—ç¬¦ä¸²åˆ™è¿”å›null
     */
    public static String trimToNull(String str) {
        String result = trim(str);
        return isEmpty(result) ? null : result;
    }

    /**
     * å»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„ç©ºç™½ï¼Œå¦‚æœç»“æœä¸ºnullåˆ™è¿”å›ç©ºå­—ç¬¦ä¸?     */
    public static String trimToEmpty(String str) {
        return str == null ? "" : str.trim();
    }

    /**
     * æˆªå–å­—ç¬¦ä¸²ï¼Œè¶…å‡ºéƒ¨åˆ†ç”¨æŒ‡å®šå­—ç¬¦æ›¿æ?     */
    public static String truncate(String str, int maxLength, String suffix) {
        if (str == null || str.length() <= maxLength) {
            return str;
        }
        return str.substring(0, maxLength - suffix.length()) + suffix;
    }

    /**
     * æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆç±»ä¼¼String.formatï¼Œä½†nullå®‰å…¨ï¼?     */
    public static String format(String format, Object... args) {
        if (format == null) {
            return null;
        }
        if (args == null) {
            return format;
        }
        return String.format(format, args);
    }

    /**
     * æ‹¼æ¥å­—ç¬¦ä¸²æ•°ç»?     */
    public static String join(Object[] array, String separator) {
        if (array == null) {
            return null;
        }
        return join(Arrays.asList(array), separator);
    }

    /**
     * æ‹¼æ¥å­—ç¬¦ä¸²é›†å?     */
    public static String join(Iterable<?> iterable, String separator) {
        if (iterable == null) {
            return null;
        }
        StringBuilder sb = new StringBuilder();
        boolean first = true;
        for (Object obj : iterable) {
            if (first) {
                first = false;
            } else {
                sb.append(separator);
            }
            if (obj != null) {
                sb.append(obj);
            }
        }
        return sb.toString();
    }

    /**
     * åˆ†å‰²å­—ç¬¦ä¸?     */
    public static String[] split(String str, String separatorChars) {
        if (str == null) {
            return null;
        }
        if (isEmpty(separatorChars)) {
            return new String[] { str };
        }
        return str.split(Pattern.quote(separatorChars));
    }

    /**
     * åˆ†å‰²å­—ç¬¦ä¸²å¹¶è½¬æ¢ä¸ºList
     */
    public static List<String> splitToList(String str, String separatorChars) {
        String[] array = split(str, separatorChars);
        return array == null ? new ArrayList<>() : Arrays.asList(array);
    }

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦åŒ…å«æŒ‡å®šå­—ç¬¦åºåˆ?     */
    public static boolean contains(String str, CharSequence searchStr) {
        if (str == null || searchStr == null) {
            return false;
        }
        return str.contains(searchStr);
    }

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šå‰ç¼€å¼€å¤?     */
    public static boolean startsWith(String str, String prefix) {
        if (str == null || prefix == null) {
            return false;
        }
        return str.startsWith(prefix);
    }

    /**
     * åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä»¥æŒ‡å®šåç¼€ç»“å°¾
     */
    public static boolean endsWith(String str, String suffix) {
        if (str == null || suffix == null) {
            return false;
        }
        return str.endsWith(suffix);
    }

    /**
     * æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰åŒ¹é…é¡¹
     */
    public static String replaceAll(String str, String regex, String replacement) {
        if (str == null) {
            return null;
        }
        return str.replaceAll(regex, replacement);
    }

    /**
     * æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹
     */
    public static String replaceFirst(String str, String regex, String replacement) {
        if (str == null) {
            return null;
        }
        return str.replaceFirst(regex, replacement);
    }

    /**
     * è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
     */
    public static String escapeHtml(String str) {
        if (str == null) {
            return null;
        }
        return str.replace("\u0026", "\u0026amp;")
                .replace("\u003c", "\u0026lt;")
                .replace("\u003e", "\u0026gt;")
                .replace("\"", "\u0026quot;")
                .replace("'", "\u0026apos;");
    }

    /**
     * éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼ˆä¸­å›½å¤§é™†æ‰‹æœºå·ï¼‰
     */
    public static boolean isValidPhone(String phone) {
        if (isBlank(phone)) {
            return false;
        }
        return PHONE_PATTERN.matcher(phone).matches();
    }

    /**
     * éªŒè¯é‚®ç®±æ ¼å¼
     */
    public static boolean isValidEmail(String email) {
        if (isBlank(email)) {
            return false;
        }
        return EMAIL_PATTERN.matcher(email).matches();
    }

    /**
     * éªŒè¯èº«ä»½è¯å·æ ¼å¼ï¼ˆä¸­å›½å¤§é™†èº«ä»½è¯å·ï¼‰
     */
    public static boolean isValidIdCard(String idCard) {
        if (isBlank(idCard)) {
            return false;
        }
        return ID_CARD_PATTERN.matcher(idCard).matches();
    }

    /**
     * éšè—æ‰‹æœºå·ä¸­é—?ä½?     */
    public static String hidePhone(String phone) {
        if (isBlank(phone) || !isValidPhone(phone)) {
            return phone;
        }
        return phone.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
    }

    /**
     * éšè—é‚®ç®±å‰ç¼€
     */
    public static String hideEmail(String email) {
        if (isBlank(email) || !isValidEmail(email)) {
            return email;
        }
        int atIndex = email.lastIndexOf('@');
        if (atIndex < 3) {
            // é‚®ç®±å‰ç¼€å¤ªçŸ­ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä½?            return email.substring(0, 1) + "***" + email.substring(atIndex);
        } else {
            // é‚®ç®±å‰ç¼€è¾ƒé•¿ï¼Œæ˜¾ç¤ºå‰ä¸¤ä½
            return email.substring(0, 2) + "***" + email.substring(atIndex);
        }
    }

    /**
     * éšè—èº«ä»½è¯å·ä¸­é—´éƒ¨åˆ†
     */
    public static String hideIdCard(String idCard) {
        if (isBlank(idCard) || idCard.length() < 8) {
            return idCard;
        }
        int length = idCard.length();
        return idCard.substring(0, 4) + "********" + idCard.substring(length - 4);
    }

    /**
     * ç”Ÿæˆéšæœºå­—ç¬¦ä¸?     */
    public static String randomString(int length) {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < length; i++) {
            int index = (int) (Math.random() * chars.length());
            sb.append(chars.charAt(index));
        }
        return sb.toString();
    }

    /**
     * ç”Ÿæˆéšæœºæ•°å­—å­—ç¬¦ä¸?     */
    public static String randomNumberString(int length) {
        String chars = "0123456789";
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < length; i++) {
            int index = (int) (Math.random() * chars.length());
            sb.append(chars.charAt(index));
        }
        return sb.toString();
    }

    /**
     * é¦–å­—æ¯å¤§å†?     */
    public static String capitalize(String str) {
        if (isEmpty(str)) {
            return str;
        }
        return Character.toUpperCase(str.charAt(0)) + str.substring(1);
    }

    /**
     * é¦–å­—æ¯å°å†?     */
    public static String uncapitalize(String str) {
        if (isEmpty(str)) {
            return str;
        }
        return Character.toLowerCase(str.charAt(0)) + str.substring(1);
    }

    /**
     * é©¼å³°è½¬ä¸‹åˆ’çº¿
     */
    public static String camelToUnderline(String str) {
        if (isEmpty(str)) {
            return str;
        }
        Pattern pattern = Pattern.compile("[A-Z]");
        Matcher matcher = pattern.matcher(str);
        StringBuffer sb = new StringBuffer();
        while (matcher.find()) {
            matcher.appendReplacement(sb, "_" + matcher.group(0).toLowerCase());
        }
        matcher.appendTail(sb);
        if (sb.charAt(0) == '_') {
            sb.deleteCharAt(0);
        }
        return sb.toString();
    }

    /**
     * ä¸‹åˆ’çº¿è½¬é©¼å³°
     */
    public static String underlineToCamel(String str) {
        if (isEmpty(str)) {
            return str;
        }
        StringBuilder sb = new StringBuilder();
        boolean needUpperCase = false;
        for (int i = 0; i < str.length(); i++) {
            char c = str.charAt(i);
            if (c == '_') {
                needUpperCase = true;
            } else {
                if (needUpperCase) {
                    sb.append(Character.toUpperCase(c));
                    needUpperCase = false;
                } else {
                    sb.append(c);
                }
            }
        }
        return sb.toString();
    }
}
package com.heikeji.common.core.test;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.ResultActions;
import org.springframework.test.web.servlet.result.MockMvcResultMatchers;

import java.util.Map;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;

/**
 * æµ‹è¯•åŸºç±»ï¼Œæä¾›é€šç”¨çš„æµ‹è¯•æ–¹æ³•å’Œé…ç½®
 */
@ExtendWith(MockitoExtension.class)
@SpringBootTest
@AutoConfigureMockMvc
public abstract class BaseTest {

    @Autowired
    protected MockMvc mockMvc;

    protected ObjectMapper objectMapper = new ObjectMapper();

    /**
     * æµ‹è¯•å‰çš„å‡†å¤‡å·¥ä½œ
     */
    @BeforeEach
    public void setUp() {
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šç”¨çš„æµ‹è¯•å‰å‡†å¤‡é€»è¾‘
    }

    /**
     * æ‰§è¡ŒGETè¯·æ±‚
     * @param url è¯·æ±‚URL
     * @return ResultActions
     */
    protected ResultActions getRequest(String url) throws Exception {
        return mockMvc.perform(get(url)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON));
    }

    /**
     * æ‰§è¡Œå¸¦å‚æ•°çš„GETè¯·æ±‚
     * @param url è¯·æ±‚URL
     * @param params è¯·æ±‚å‚æ•°
     * @return ResultActions
     */
    protected ResultActions getRequest(String url, Map<String, String> params) throws Exception {
        StringBuilder urlBuilder = new StringBuilder(url);
        if (params != null && !params.isEmpty()) {
            urlBuilder.append("?");
            params.forEach((key, value) -> {
                urlBuilder.append(key).append("=").append(value).append("&");
            });
            urlBuilder.deleteCharAt(urlBuilder.length() - 1);
        }
        return getRequest(urlBuilder.toString());
    }

    /**
     * æ‰§è¡ŒPOSTè¯·æ±‚
     * @param url è¯·æ±‚URL
     * @param content è¯·æ±‚ä½?     * @return ResultActions
     */
    protected ResultActions postRequest(String url, Object content) throws Exception {
        return mockMvc.perform(post(url)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(content)));
    }

    /**
     * æ‰§è¡ŒPUTè¯·æ±‚
     * @param url è¯·æ±‚URL
     * @param content è¯·æ±‚ä½?     * @return ResultActions
     */
    protected ResultActions putRequest(String url, Object content) throws Exception {
        return mockMvc.perform(put(url)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(content)));
    }

    /**
     * æ‰§è¡ŒDELETEè¯·æ±‚
     * @param url è¯·æ±‚URL
     * @return ResultActions
     */
    protected ResultActions deleteRequest(String url) throws Exception {
        return mockMvc.perform(delete(url)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON));
    }

    /**
     * æ‰§è¡Œå¸¦è®¤è¯çš„è¯·æ±‚
     * @param url è¯·æ±‚URL
     * @param token JWT token
     * @return ResultActions
     */
    protected ResultActions getRequestWithAuth(String url, String token) throws Exception {
        return mockMvc.perform(get(url)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON)
                .header("Authorization", "Bearer " + token));
    }

    /**
     * éªŒè¯å“åº”çŠ¶æ€ç 
     * @param resultActions å“åº”ç»“æœ
     * @param statusCode çŠ¶æ€ç 
     * @return ResultActions
     */
    protected ResultActions verifyStatusCode(ResultActions resultActions, int statusCode) throws Exception {
        return resultActions.andExpect(MockMvcResultMatchers.status().is(statusCode));
    }

    /**
     * éªŒè¯å“åº”å†…å®¹åŒ…å«æŒ‡å®šå­—ç¬¦ä¸?     * @param resultActions å“åº”ç»“æœ
     * @param content è¦éªŒè¯çš„å†…å®¹
     * @return ResultActions
     */
    protected ResultActions verifyContentContains(ResultActions resultActions, String content) throws Exception {
        return resultActions.andExpect(MockMvcResultMatchers.content().string(org.hamcrest.Matchers.containsString(content)));
    }

    /**
     * æ¨¡æ‹Ÿé™æ€æ–¹æ³?     * @param clazz åŒ…å«é™æ€æ–¹æ³•çš„ç±?     * @return MockedStaticå¯¹è±¡
     */
    protected <T> MockedStatic<T> mockStatic(Class<T> clazz) {
        return Mockito.mockStatic(clazz);
    }

    /**
     * å°†å¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸?     * @param object è¦è½¬æ¢çš„å¯¹è±¡
     * @return JSONå­—ç¬¦ä¸?     */
    protected String toJson(Object object) throws Exception {
        return objectMapper.writeValueAsString(object);
    }
}
package com.heikeji.common.security.utils;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.apache.commons.lang3.StringUtils;

import java.security.Key;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

/**
 * JWTå·¥å…·ç±?
 */
public class JwtUtils {
    // JWTç­¾åå¯†é’¥ï¼Œå»ºè®®ä»é…ç½®æ–‡ä»¶è¯»å–
    private static final String SECRET = "heikeji-mall-secret-key-2024-black-technology-university-campus-mall-system";
    // é»˜è®¤è¿‡æœŸæ—¶é—´ï¼?å¤?
    private static final Long DEFAULT_EXPIRATION = 7 * 24 * 60 * 60 * 1000L;
    // çŸ­æœŸè¿‡æœŸæ—¶é—´ï¼?å°æ—¶ï¼ˆç”¨äºç‰¹æ®Šåœºæ™¯ï¼‰
    private static final Long SHORT_EXPIRATION = 2 * 60 * 60 * 1000L;
    // JWTå¯†é’¥å®ä¾‹
    private static final Key key = Keys.hmacShaKeyFor(SECRET.getBytes());
    // Tokenå‰ç¼€
    public static final String TOKEN_PREFIX = "Bearer ";
    // Tokenè¯·æ±‚å¤´åç§?
    public static final String TOKEN_HEADER = "Authorization";

    /**
     * ç”Ÿæˆtoken
     * 
     * @param userId ç”¨æˆ·ID
     * @param openId å¾®ä¿¡OpenID
     * @return JWT token
     */
    public static String generateToken(Long userId, String openId) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("openId", openId);
        return createToken(claims, DEFAULT_EXPIRATION);
    }

    /**
     * ç”ŸæˆçŸ­æœŸtokenï¼ˆç”¨äºç‰¹æ®Šåœºæ™¯ï¼‰
     * 
     * @param userId ç”¨æˆ·ID
     * @param openId å¾®ä¿¡OpenID
     * @return JWT token
     */
    public static String generateShortToken(Long userId, String openId) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("openId", openId);
        return createToken(claims, SHORT_EXPIRATION);
    }

    /**
     * ç”Ÿæˆè‡ªå®šä¹‰token
     * 
     * @param claims è‡ªå®šä¹‰å£°æ˜?
     * @param expiration è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * @return JWT token
     */
    public static String generateCustomToken(Map<String, Object> claims, Long expiration) {
        return createToken(claims, expiration);
    }

    /**
     * åˆ›å»ºtoken
     */
    private static String createToken(Map<String, Object> claims, Long expiration) {
        Date now = new Date();
        Date expireDate = new Date(now.getTime() + expiration);
        
        return Jwts.builder()
                .setClaims(claims)
                .setIssuedAt(now)
                .setExpiration(expireDate)
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }

    /**
     * ä»tokenä¸­è·å–Claims
     */
    public static Claims getClaimsFromToken(String token) {
        if (StringUtils.isBlank(token)) {
            throw new IllegalArgumentException("Token cannot be blank");
        }
        
        // ç§»é™¤å¯èƒ½çš„Bearerå‰ç¼€
        if (token.startsWith(TOKEN_PREFIX)) {
            token = token.substring(TOKEN_PREFIX.length());
        }
        
        return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    /**
     * ä»tokenä¸­è·å–userId
     */
    public static Long getUserIdFromToken(String token) {
        Claims claims = getClaimsFromToken(token);
        return claims.get("userId", Long.class);
    }

    /**
     * ä»tokenä¸­è·å–openId
     */
    public static String getOpenIdFromToken(String token) {
        Claims claims = getClaimsFromToken(token);
        return claims.get("openId", String.class);
    }

    /**
     * ä»tokenä¸­è·å–æŒ‡å®šå£°æ˜çš„å€?
     */
    public static <T> T getClaimFromToken(String token, String claimName, Class<T> requiredType) {
        Claims claims = getClaimsFromToken(token);
        return claims.get(claimName, requiredType);
    }

    /**
     * è·å–tokençš„è¿‡æœŸæ—¶é—?
     */
    public static Date getExpirationDateFromToken(String token) {
        Claims claims = getClaimsFromToken(token);
        return claims.getExpiration();
    }

    /**
     * è·å–tokençš„åˆ›å»ºæ—¶é—?
     */
    public static Date getIssuedAtFromToken(String token) {
        Claims claims = getClaimsFromToken(token);
        return claims.getIssuedAt();
    }

    /**
     * éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public static Boolean validateToken(String token) {
        try {
            Claims claims = getClaimsFromToken(token);
            return claims.getExpiration().after(new Date());
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * åˆ·æ–°token
     * 
     * @param token åŸtoken
     * @return æ–°token
     */
    public static String refreshToken(String token) {
        Claims claims = getClaimsFromToken(token);
        claims.setIssuedAt(new Date());
        claims.setExpiration(new Date(System.currentTimeMillis() + DEFAULT_EXPIRATION));
        return Jwts.builder()
                .setClaims(claims)
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }

    /**
     * æ£€æŸ¥tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆé»˜è®?0åˆ†é’Ÿå†…è¿‡æœŸè§†ä¸ºå³å°†è¿‡æœŸï¼‰
     */
    public static boolean isTokenExpiringSoon(String token) {
        try {
            Claims claims = getClaimsFromToken(token);
            Date expiration = claims.getExpiration();
            long timeUntilExpiration = expiration.getTime() - System.currentTimeMillis();
            // 30åˆ†é’Ÿ = 30 * 60 * 1000 æ¯«ç§’
            return timeUntilExpiration < 30 * 60 * 1000L && timeUntilExpiration > 0;
        } catch (Exception e) {
            return false;
        }
    }

    /**
     * æ¸…ç†tokenå‰ç¼€
     */
    public static String cleanTokenPrefix(String token) {
        if (StringUtils.isNotBlank(token) && token.startsWith(TOKEN_PREFIX)) {
            return token.substring(TOKEN_PREFIX.length());
        }
        return token;
    }
}




package com.heikeji.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;

/**
 * é»‘ç§‘æ˜“è´­APIæ¥å£æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
@EnableDiscoveryClient
@EnableFeignClients(basePackages = "com.heikeji.api.feign")
@ComponentScan(basePackages = {"com.heikeji.api", "com.heikeji.common"})
public class ApiApplication {

    public static void main(String[] args) {
        SpringApplication.run(ApiApplication.class, args);
    }

}
package com.heikeji.api.common;

import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * åˆ†é¡µå“åº”ç»“æœç±? */
@Data
public class PageResult<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    private Integer code;
    private String message;
    private List<T> data;
    private Long total;
    private Integer pageNum;
    private Integer pageSize;

    public PageResult() {
    }

    public PageResult(Integer code, String message, List<T> data, Long total, Integer pageNum, Integer pageSize) {
        this.code = code;
        this.message = message;
        this.data = data;
        this.total = total;
        this.pageNum = pageNum;
        this.pageSize = pageSize;
    }

    public static <T> PageResult<T> success(List<T> data, Long total, Integer pageNum, Integer pageSize) {
        return new PageResult<>(200, "success", data, total, pageNum, pageSize);
    }

    public static <T> PageResult<T> error() {
        return new PageResult<>(500, "error", null, 0L, 1, 10);
    }

    public static <T> PageResult<T> error(String message) {
        return new PageResult<>(500, message, null, 0L, 1, 10);
    }
}
package com.heikeji.api.common;

import lombok.Data;

import java.io.Serializable;

/**
 * é€šç”¨å“åº”ç»“æœç±? */
@Data
public class Result<T> implements Serializable {
    private static final long serialVersionUID = 1L;

    private Integer code;
    private String message;
    private T data;

    public Result() {
    }

    public Result(Integer code, String message, T data) {
        this.code = code;
        this.message = message;
        this.data = data;
    }

    public static <T> Result<T> success() {
        return new Result<>(200, "success", null);
    }

    public static <T> Result<T> success(T data) {
        return new Result<>(200, "success", data);
    }

    public static <T> Result<T> success(String message, T data) {
        return new Result<>(200, message, data);
    }

    public static <T> Result<T> error() {
        return new Result<>(500, "error", null);
    }

    public static <T> Result<T> error(String message) {
        return new Result<>(500, message, null);
    }

    public static <T> Result<T> error(Integer code, String message) {
        return new Result<>(code, message, null);
    }
}
package com.heikeji.api.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

/**
 * è·¨åŸŸé…ç½®ç±? * é…ç½®è·¨åŸŸèµ„æºå…±äº«ï¼Œå…è®¸å‰ç«¯è·¨åŸŸè®¿é—®APIæ¥å£
 */
@Configuration
public class CorsConfig {

    /**
     * æ„å»ºè·¨åŸŸé…ç½®
     * @return è·¨åŸŸé…ç½®å¯¹è±¡
     */
    private CorsConfiguration buildConfig() {
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        
        // å…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®é™åˆ¶å…·ä½“åŸŸåï¼?        corsConfiguration.addAllowedOrigin("*");
        
        // å…è®¸å‡­è¯ï¼ˆå¦‚cookiesï¼?        corsConfiguration.setAllowCredentials(true);
        
        // å…è®¸æ‰€æœ‰HTTPæ–¹æ³•
        corsConfiguration.addAllowedMethod("GET");
        corsConfiguration.addAllowedMethod("POST");
        corsConfiguration.addAllowedMethod("PUT");
        corsConfiguration.addAllowedMethod("DELETE");
        corsConfiguration.addAllowedMethod("OPTIONS");
        
        // å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
        corsConfiguration.addAllowedHeader("*");
        
        // æš´éœ²å“åº”å¤´ä¿¡æ?        corsConfiguration.addExposedHeader("Content-Type");
        corsConfiguration.addExposedHeader("X-Requested-With");
        corsConfiguration.addExposedHeader("Authorization");
        
        // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼?        corsConfiguration.setMaxAge(3600L);
        
        return corsConfiguration;
    }

    /**
     * åˆ›å»ºè·¨åŸŸè¿‡æ»¤å™?     * @return è·¨åŸŸè¿‡æ»¤å™?     */
    @Bean
    public CorsFilter corsFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        // æ³¨å†Œè·¨åŸŸé…ç½®ï¼Œåº”ç”¨åˆ°æ‰€æœ‰è·¯å¾?        source.registerCorsConfiguration("/**", buildConfig());
        return new CorsFilter(source);
    }
}
package com.heikeji.api.config;

import com.heikeji.common.core.domain.R;
import com.heikeji.common.core.exception.BaseException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.validation.BindingResult;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.servlet.NoHandlerFoundException;

import jakarta.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†ç±? * ç»Ÿä¸€å¤„ç†å„ç±»å¼‚å¸¸ï¼Œè¿”å›æ ‡å‡†æ ¼å¼å“åº? */
@RestControllerAdvice
public class GlobalExceptionHandler {

    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);

    /**
     * å¤„ç†åŸºç¡€ä¸šåŠ¡å¼‚å¸¸
     * @param e åŸºç¡€å¼‚å¸¸
     * @param request è¯·æ±‚å¯¹è±¡
     * @return æ ‡å‡†å“åº”
     */
    @ExceptionHandler(BaseException.class)
    public R<?> handleBaseException(BaseException e, HttpServletRequest request) {
        logger.error("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage(), e);
        return R.error(e.getCode(), e.getMessage());
    }

    /**
     * å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸
     * @param e å‚æ•°æ ¡éªŒå¼‚å¸¸
     * @return æ ‡å‡†å“åº”
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public R<?> handleValidationException(MethodArgumentNotValidException e) {
        BindingResult bindingResult = e.getBindingResult();
        Map<String, String> fieldErrors = new HashMap<>();
        
        for (FieldError error : bindingResult.getFieldErrors()) {
            fieldErrors.put(error.getField(), error.getDefaultMessage());
        }
        
        logger.warn("å‚æ•°æ ¡éªŒå¤±è´¥: {}", fieldErrors);
        // åˆ›å»ºåŒ…å«é”™è¯¯ä¿¡æ¯çš„å“åº”å¯¹è±?        return R.error("å‚æ•°æ ¡éªŒå¤±è´¥: " + fieldErrors);
    }

    /**
     * å¤„ç†è¿è¡Œæ—¶å¼‚å¸?     * @param e è¿è¡Œæ—¶å¼‚å¸?     * @param request è¯·æ±‚å¯¹è±¡
     * @return æ ‡å‡†å“åº”
     */
    @ExceptionHandler(RuntimeException.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public R<?> handleRuntimeException(RuntimeException e, HttpServletRequest request) {
        logger.error("è¿è¡Œæ—¶å¼‚å¸? {}", e.getMessage(), e);
        return R.error(HttpStatus.INTERNAL_SERVER_ERROR.value(), e.getMessage());
    }

    /**
     * å¤„ç†IOå¼‚å¸¸
     * @param e IOå¼‚å¸¸
     * @param request è¯·æ±‚å¯¹è±¡
     * @return æ ‡å‡†å“åº”
     */
    @ExceptionHandler(IOException.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public R<?> handleIOException(IOException e, HttpServletRequest request) {
        logger.error("IOå¼‚å¸¸: {}", e.getMessage(), e);
        return R.error(HttpStatus.INTERNAL_SERVER_ERROR.value(), "IOå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
    }

    /**
     * å¤„ç†è·¯å¾„ä¸å­˜åœ¨å¼‚å¸?     * @param e è·¯å¾„ä¸å­˜åœ¨å¼‚å¸?     * @return æ ‡å‡†å“åº”
     */
    @ExceptionHandler(NoHandlerFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public R<?> handleNoHandlerFoundException(NoHandlerFoundException e) {
        logger.warn("è¯·æ±‚è·¯å¾„ä¸å­˜åœ? {}", e.getRequestURL());
        return R.error(HttpStatus.NOT_FOUND.value(), "è¯·æ±‚è·¯å¾„ä¸å­˜åœ?);
    }

    /**
     * å¤„ç†æ‰€æœ‰å¼‚å¸?     * @param e å¼‚å¸¸
     * @param request è¯·æ±‚å¯¹è±¡
     * @return æ ‡å‡†å“åº”
     */
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public R<?> handleException(Exception e, HttpServletRequest request) {
        logger.error("æœªçŸ¥å¼‚å¸¸: {}", e.getMessage(), e);
        return R.error(HttpStatus.INTERNAL_SERVER_ERROR.value(), "ç³»ç»Ÿå¼‚å¸¸");
    }
}
package com.heikeji.api.config;

// import org.springframework.context.annotation.Bean;
// import org.springframework.context.annotation.Configuration;
// import springfox.documentation.builders.ApiInfoBuilder;
// import springfox.documentation.builders.PathSelectors;
// import springfox.documentation.builders.RequestHandlerSelectors;
// import springfox.documentation.service.ApiInfo;
// import springfox.documentation.service.Contact;
// import springfox.documentation.spi.DocumentationType;
// import springfox.documentation.spring.web.plugins.Docket;
// import springfox.documentation.swagger2.annotations.EnableSwagger2;

/**
 * Swaggeré…ç½®ç±»ï¼ˆæš‚æ—¶ç¦ç”¨ï¼?
 * æ³¨é‡Šæ‰Swaggerç›¸å…³ä»£ç ä»¥é¿å…Spring Boot 2.7.14å…¼å®¹æ€§é—®é¢?
 */
// @Configuration
// @EnableSwagger2
public class SwaggerConfig {

    /**
     * åˆ›å»ºAPIæ–‡æ¡£ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
     */
//    @Bean
    public Docket createRestApi() {
        return null; // æš‚æ—¶è¿”å›nullï¼Œé¿å…ä¾èµ–é—®é¢?
        /*
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(apiInfo())
                .enable(true)
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.heikeji.api.controller"))
                .paths(PathSelectors.any())
                .build()
                .groupName("é»‘ç§‘æ˜“è´­æ ¸å¿ƒAPI");
        */
    }

    /**
     * æ„å»ºAPIä¿¡æ¯ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
     */
//    private ApiInfo apiInfo() {
//        return new ApiInfoBuilder()
//                .title("é»‘ç§‘æ˜“è´­APIæ¥å£æ–‡æ¡£")
//                .description("é»‘ç§‘æ˜“è´­å•†åŸç³»ç»ŸAPIæ¥å£æ–‡æ¡£ï¼ŒåŒ…å«ç”¨æˆ·ã€å•†å“ã€è®¢å•ã€è´­ç‰©è½¦å’Œæ”¯ä»˜ç­‰æ ¸å¿ƒåŠŸèƒ½æ¨¡å—")
//                .version("1.0.0")
//                .contact(new Contact("é»‘ç§‘æ˜“è´­å›¢é˜Ÿ", "https://www.heikeji.com", "support@heikeji.com"))
//                .build();
//    }
}
package com.heikeji.api.controller;

import com.heikeji.api.dto.OrderDTO;
import com.heikeji.api.feign.OrderFeignClient;
import com.heikeji.api.vo.OrderVO;
import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;
import java.util.Map;

/**
 * è®¢å•æ§åˆ¶å™? */
@RestController
@RequestMapping("/order")
@Api(tags = "è®¢å•ç®¡ç†")
@Validated
public class OrderController {

    @Autowired
    private OrderFeignClient orderFeignClient;

    @ApiOperation("åˆ›å»ºè®¢å•")
    @PostMapping("/create")
    public R<Map<String, Object>> createOrder(@Valid @RequestBody OrderDTO orderDTO) {
        Map<String, Object> result = orderFeignClient.createOrder(orderDTO);
        return R.success(result);
    }

    @ApiOperation("è·å–è®¢å•è¯¦æƒ…")
    @GetMapping("/{orderId}")
    public R<OrderVO> getOrderDetail(@ApiParam(value = "è®¢å•ID", required = true) @PathVariable("orderId") String orderId) {
        OrderVO orderVO = orderFeignClient.getOrderDetail(orderId);
        return R.success(orderVO);
    }

    @ApiOperation("è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨")
    @GetMapping("/list")
    public R getUserOrderList(@ApiParam(value = "ç”¨æˆ·ID", required = true) @RequestParam("userId") Long userId, 
                             @RequestParam Map<String, Object> params) {
        Map<String, Object> result = orderFeignClient.getUserOrderList(userId, params);
        return R.success(result);
    }

    @ApiOperation("å–æ¶ˆè®¢å•")
    @PutMapping("/{orderId}/cancel")
    public R<Boolean> cancelOrder(@ApiParam(value = "è®¢å•ID", required = true) @PathVariable("orderId") String orderId, 
                                @ApiParam(value = "ç”¨æˆ·ID", required = true) @RequestParam("userId") Long userId) {
        Boolean result = orderFeignClient.cancelOrder(orderId, userId);
        return R.success(result);
    }

    @ApiOperation("ç¡®è®¤æ”¶è´§")
    @PutMapping("/{orderId}/confirm")
    public R<Boolean> confirmReceipt(@ApiParam(value = "è®¢å•ID", required = true) @PathVariable("orderId") String orderId, 
                                  @ApiParam(value = "ç”¨æˆ·ID", required = true) @RequestParam("userId") Long userId) {
        Boolean result = orderFeignClient.confirmReceipt(orderId, userId);
        return R.success(result);
    }

    @ApiOperation("åˆ é™¤è®¢å•")
    @DeleteMapping("/{orderId}")
    public R<Boolean> deleteOrder(@ApiParam(value = "è®¢å•ID", required = true) @PathVariable("orderId") String orderId, 
                                @ApiParam(value = "ç”¨æˆ·ID", required = true) @RequestParam("userId") Long userId) {
        Boolean result = orderFeignClient.deleteOrder(orderId, userId);
        return R.success(result);
    }

    @ApiOperation("è·å–è®¢å•çŠ¶æ€ç»Ÿè®?)
    @GetMapping("/status/count")
    public R<Map<String, Integer>> getOrderStatusCount(@ApiParam(value = "ç”¨æˆ·ID", required = true) @RequestParam("userId") Long userId) {
        Map<String, Integer> result = orderFeignClient.getOrderStatusCount(userId);
        return R.success(result);
    }

    @ApiOperation("è®¡ç®—è®¢å•é‡‘é¢")
    @PostMapping("/calculate")
    public R<Map<String, Object>> calculateOrder(@Valid @RequestBody OrderDTO orderDTO) {
        Map<String, Object> result = orderFeignClient.calculateOrder(orderDTO);
        return R.success(result);
    }

    @ApiOperation("æ‰¹é‡è·å–è®¢å•è¯¦æƒ…")
    @PostMapping("/batch/detail")
    public R<List<OrderVO>> getBatchOrderDetail(@ApiParam(value = "è®¢å•IDåˆ—è¡¨", required = true) @RequestBody List<String> orderIds) {
        List<OrderVO> result = orderFeignClient.getBatchOrderDetail(orderIds);
        return R.success(result);
    }
}
package com.heikeji.api.controller;

import com.heikeji.api.dto.PaymentDTO;
import com.heikeji.api.feign.PaymentFeignClient;
import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.Map;

/**
 * æ”¯ä»˜æ§åˆ¶å™? */
@RestController
@RequestMapping("/payment")
@Api(tags = "æ”¯ä»˜ç®¡ç†")
@Validated
public class PaymentController {

    @Autowired
    private PaymentFeignClient paymentFeignClient;

    @ApiOperation("åˆ›å»ºæ”¯ä»˜è®¢å•")
    @PostMapping("/create")
    public R<Map<String, Object>> createPayment(@Valid @RequestBody PaymentDTO paymentDTO) {
        Map<String, Object> result = paymentFeignClient.createPayment(paymentDTO);
        return R.success(result);
    }

    @ApiOperation("æ”¯ä»˜å›è°ƒ")
    @PostMapping("/callback/{paymentType}")
    public R<Map<String, Object>> paymentCallback(@ApiParam(value = "æ”¯ä»˜ç±»å‹", required = true) @PathVariable("paymentType") String paymentType, 
                                                          @RequestBody Map<String, String> params) {
        Map<String, Object> result = paymentFeignClient.paymentCallback(paymentType, params);
        return R.success(result);
    }

    @ApiOperation("æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?)
    @GetMapping("/status/{orderId}")
    public R<Map<String, Object>> queryPaymentStatus(@ApiParam(value = "è®¢å•ID", required = true) @PathVariable("orderId") String orderId) {
        Map<String, Object> result = paymentFeignClient.queryPaymentStatus(orderId);
        return R.success(result);
    }

    @ApiOperation("å…³é—­æ”¯ä»˜è®¢å•")
    @PutMapping("/close/{orderId}")
    public R<Boolean> closePayment(@ApiParam(value = "è®¢å•ID", required = true) @PathVariable("orderId") String orderId) {
        Boolean result = paymentFeignClient.closePayment(orderId);
        return R.success(result);
    }

    @ApiOperation("ç”³è¯·é€€æ¬?)
    @PostMapping("/refund")
    public R<Map<String, Object>> applyRefund(@Valid @RequestBody PaymentDTO paymentDTO) {
        Map<String, Object> result = paymentFeignClient.applyRefund(paymentDTO);
        return R.success(result);
    }

    @ApiOperation("æŸ¥è¯¢é€€æ¬¾çŠ¶æ€?)
    @GetMapping("/refund/status/{refundId}")
    public R<Map<String, Object>> queryRefundStatus(@ApiParam(value = "é€€æ¬¾ID", required = true) @PathVariable("refundId") String refundId) {
        Map<String, Object> result = paymentFeignClient.queryRefundStatus(refundId);
        return R.success(result);
    }

    @ApiOperation("è·å–æ”¯ä»˜æ–¹å¼åˆ—è¡¨")
    @GetMapping("/methods")
    public R<Map<String, Object>> getPaymentMethods() {
        Map<String, Object> result = paymentFeignClient.getPaymentMethods();
        return R.success(result);
    }

    @ApiOperation("è·å–æ”¯ä»˜é…ç½®")
    @GetMapping("/config/{paymentType}")
    public R<Map<String, Object>> getPaymentConfig(@ApiParam(value = "æ”¯ä»˜ç±»å‹", required = true) @PathVariable("paymentType") String paymentType) {
        Map<String, Object> result = paymentFeignClient.getPaymentConfig(paymentType);
        return R.success(result);
    }
}
package com.heikeji.api.controller;

import com.heikeji.api.feign.ProductFeignClient;
import com.heikeji.api.vo.ProductVO;
import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * å•†å“æ§åˆ¶å™? */
@RestController
@RequestMapping("/product")
@Api(tags = "å•†å“ç®¡ç†")
@Validated
public class ProductController {

    @Autowired
    private ProductFeignClient productFeignClient;

    @ApiOperation("è·å–å•†å“åˆ—è¡¨")
    @GetMapping("/list")
    public R getProductList(@RequestParam Map<String, Object> params) {
        Map<String, Object> result = productFeignClient.getProductList(params);
        return R.success(result);
    }

    @ApiOperation("è·å–å•†å“è¯¦æƒ…")
    @GetMapping("/{id}")
    public R<ProductVO> getProductDetail(@ApiParam(value = "å•†å“ID", required = true) @PathVariable("id") Long productId) {
        ProductVO productVO = productFeignClient.getProductDetail(productId);
        return R.success(productVO);
    }

    @ApiOperation("è·å–å•†å“åˆ†ç±»")
    @GetMapping("/category/list")
    public R<List<Map<String, Object>>> getCategoryList() {
        List<Map<String, Object>> categories = productFeignClient.getCategoryList();
        return R.success(categories);
    }

    @ApiOperation("æ ¹æ®åˆ†ç±»è·å–å•†å“")
    @GetMapping("/category/{categoryId}")
    public R getProductsByCategory(@ApiParam(value = "åˆ†ç±»ID", required = true) @PathVariable("categoryId") Long categoryId, 
                                 @RequestParam Map<String, Object> params) {
        Map<String, Object> result = productFeignClient.getProductsByCategory(categoryId, params);
        return R.success(result);
    }

    @ApiOperation("æœç´¢å•†å“")
    @GetMapping("/search")
    public R searchProducts(@RequestParam Map<String, Object> params) {
        Map<String, Object> result = productFeignClient.searchProducts(params);
        return R.success(result);
    }

    @ApiOperation("è·å–çƒ­é—¨å•†å“")
    @GetMapping("/hot")
    public R<List<ProductVO>> getHotProducts(@RequestParam(value = "limit", defaultValue = "10") Integer limit) {
        List<ProductVO> products = productFeignClient.getHotProducts(limit);
        return R.success(products);
    }

    @ApiOperation("è·å–æ¨èå•†å“")
    @GetMapping("/recommend")
    public R<List<ProductVO>> getRecommendProducts(@RequestParam(value = "limit", defaultValue = "10") Integer limit) {
        List<ProductVO> products = productFeignClient.getRecommendProducts(limit);
        return R.success(products);
    }

    @ApiOperation("è·å–å•†å“åº“å­˜")
    @GetMapping("/stock/{productId}")
    public R<Integer> getProductStock(@ApiParam(value = "å•†å“ID", required = true) @PathVariable("productId") Long productId) {
        Integer stock = productFeignClient.getProductStock(productId);
        return R.success(stock);
    }
}
package com.heikeji.api.controller;

import com.heikeji.api.dto.CartItemDTO;
import com.heikeji.api.feign.ShoppingCartFeignClient;
import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;
import java.util.Map;

/**
 * è´­ç‰©è½¦æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/cart")
@Api(tags = "è´­ç‰©è½¦ç®¡ç?)
@Validated
public class ShoppingCartController {

    @Autowired
    private ShoppingCartFeignClient shoppingCartFeignClient;

    @ApiOperation("æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦")
    @PostMapping("/add")
    public R<Map<String, Object>> addToCart(@Valid @RequestBody CartItemDTO cartItemDTO) {
        Map<String, Object> result = shoppingCartFeignClient.addToCart(cartItemDTO);
        return R.success(result);
    }

    @ApiOperation("è·å–è´­ç‰©è½¦åˆ—è¡?)
    @GetMapping("/list/{userId}")
    public R<Map<String, Object>> getCartList(@ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable("userId") Long userId) {
        Map<String, Object> result = shoppingCartFeignClient.getCartList(userId);
        return R.success(result);
    }

    @ApiOperation("æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?)
    @PutMapping("/update")
    public R<Map<String, Object>> updateCartItem(@Valid @RequestBody CartItemDTO cartItemDTO) {
        Map<String, Object> result = shoppingCartFeignClient.updateCartItem(cartItemDTO);
        return R.success(result);
    }

    @ApiOperation("åˆ é™¤è´­ç‰©è½¦å•†å“?)
    @DeleteMapping("/delete/{userId}")
    public R<Boolean> deleteCartItems(@ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable("userId") Long userId, 
                                          @ApiParam(value = "å•†å“é¡¹IDåˆ—è¡¨", required = true) @RequestParam("itemIds") List<Long> itemIds) {
        Boolean result = shoppingCartFeignClient.deleteCartItems(userId, itemIds);
        return R.success(result);
    }

    @ApiOperation("æ¸…ç©ºè´­ç‰©è½?)
    @DeleteMapping("/clear/{userId}")
    public R<Boolean> clearCart(@ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable("userId") Long userId) {
        Boolean result = shoppingCartFeignClient.clearCart(userId);
        return R.success(result);
    }

    @ApiOperation("é€‰æ‹©/å–æ¶ˆé€‰æ‹©å•†å“")
    @PutMapping("/select")
    public R<Map<String, Object>> selectCartItems(@Valid @RequestBody CartItemDTO cartItemDTO) {
        Map<String, Object> result = shoppingCartFeignClient.selectCartItems(cartItemDTO);
        return R.success(result);
    }

    @ApiOperation("è·å–è´­ç‰©è½¦å•†å“æ•°é‡?)
    @GetMapping("/count/{userId}")
    public R<Integer> getCartItemCount(@ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable("userId") Long userId) {
        Integer result = shoppingCartFeignClient.getCartItemCount(userId);
        return R.success(result);
    }

    @ApiOperation("æ‰¹é‡è·å–è´­ç‰©è½¦å•†å“è¯¦æƒ?)
    @PostMapping("/batch/detail")
    public R<Map<String, Object>> getBatchCartItems(@ApiParam(value = "å•†å“é¡¹IDåˆ—è¡¨", required = true) @RequestBody List<Long> itemIds) {
        Map<String, Object> result = shoppingCartFeignClient.getBatchCartItems(itemIds);
        return R.success(result);
    }

    @ApiOperation("åˆå¹¶è´­ç‰©è½?)
    @PostMapping("/merge")
    public R<Map<String, Object>> mergeCart(@ApiParam(value = "ç”¨æˆ·ID", required = true) @RequestParam("userId") Long userId, 
                                                        @ApiParam(value = "è´­ç‰©è½¦å•†å“åˆ—è¡?, required = true) @RequestBody List<CartItemDTO> cartItems) {
        Map<String, Object> result = shoppingCartFeignClient.mergeCart(userId, cartItems);
        return R.success(result);
    }
}
package com.heikeji.api.controller;

import com.heikeji.api.dto.UserDTO;
import com.heikeji.api.feign.UserFeignClient;
import com.heikeji.api.vo.UserVO;
import com.heikeji.common.core.domain.R;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;
import java.util.HashMap;
import java.util.Map;

/**
 * ç”¨æˆ·æ§åˆ¶å™? */
@RestController
@RequestMapping("/user")
@Api(tags = "ç”¨æˆ·ç®¡ç†")
@Validated
public class UserController {

    @Autowired
    private UserFeignClient userFeignClient;

    @ApiOperation("ç”¨æˆ·ç™»å½•")
    @PostMapping("/login")
    public R<Map<String, Object>> login(@Valid @RequestBody UserDTO userDTO) {
        Map<String, String> params = new HashMap<>();
        params.put("username", userDTO.getUsername());
        params.put("password", userDTO.getPassword());
        Map<String, Object> result = userFeignClient.login(params);
        return R.success(result);
    }

    @ApiOperation("ç”¨æˆ·æ³¨å†Œ")
    @PostMapping("/register")
    public R<Map<String, Object>> register(@Valid @RequestBody UserDTO userDTO) {
        Map<String, Object> result = userFeignClient.register(userDTO);
        return R.success(result);
    }

    @ApiOperation("è·å–ç”¨æˆ·ä¿¡æ¯")
    @GetMapping("/info/{userId}")
    public R<UserVO> getUserInfo(@ApiParam(value = "ç”¨æˆ·ID", required = true) @PathVariable("userId") Long userId) {
        UserVO userVO = userFeignClient.getUserInfo(userId);
        return R.success(userVO);
    }

    @ApiOperation("æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
    @PutMapping("/update")
    public R<Boolean> updateUserInfo(@Valid @RequestBody UserDTO userDTO) {
        Boolean result = userFeignClient.updateUserInfo(userDTO);
        return R.success(result);
    }

    @ApiOperation("ä¿®æ”¹å¯†ç ")
    @PutMapping("/password/update")
    public R<Boolean> updatePassword(@Valid @RequestBody UserDTO userDTO) {
        Map<String, String> params = new HashMap<>();
        // ç”±äºUserDTOæ²¡æœ‰å¯¹åº”çš„getteræ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨ç©ºå‚æ•°
        // å®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®UserDTOçš„å®é™…å±æ€§è¿›è¡Œè°ƒæ•?        Boolean result = userFeignClient.changePassword(params);
        return R.success(result);
    }

    @ApiOperation("å‘é€éªŒè¯ç ")
    @GetMapping("/code/send")
    public R<Boolean> sendVerificationCode(@ApiParam(value = "æ‰‹æœºå·ç ", required = true) @RequestParam("phone") String phone) {
        Boolean result = userFeignClient.sendCode(phone);
        return R.success(result);
    }

    @ApiOperation("éªŒè¯éªŒè¯ç ?)
    @PostMapping("/code/verify")
    public R<Boolean> verifyVerificationCode(@Valid @RequestBody UserDTO userDTO) {
        Map<String, String> params = new HashMap<>();
        params.put("phone", userDTO.getPhone());
        // Remove call to potentially non-existent getCode() method
        Boolean result = userFeignClient.verifyCode(params);
        return R.success(result);
    }

    @ApiOperation("é€€å‡ºç™»å½?)
    @PostMapping("/logout")
    public R<Boolean> logout(HttpServletRequest request) {
        // ç”±äºUserFeignClientæ¥å£ä¸­æ²¡æœ‰logoutæ–¹æ³•ï¼Œè¿™é‡Œç›´æ¥è¿”å›æˆåŠ?        return R.success(true);
    }
}
package com.heikeji.api.dto;

import lombok.Data;

import java.io.Serializable;

/**
 * è´­ç‰©è½¦é¡¹DTOç±? */
@Data
public class CartItemDTO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private Long userId;
    private Long productId;
    private Integer quantity;
    private Boolean checked;
    private String specAttributes;
    private String productName;
    private String productImage;
    private String productSn;
}
package com.heikeji.api.dto;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * è®¢å•DTOç±? */
@Data
public class OrderDTO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long userId;
    private String orderNo;
    private String receiverName;
    private String receiverPhone;
    private String receiverProvince;
    private String receiverCity;
    private String receiverDistrict;
    private String receiverAddress;
    private String receiverZip;
    private BigDecimal payment;
    private Integer paymentType;
    private Integer postage;
    private Integer status;
    private List<OrderItemDTO> orderItems;
    private String message;
    private String deliveryTime;
    private String paymentTime;
    private String endTime;
    private String closeTime;
    private String shippingTime;
    private String confirmTime;
}
package com.heikeji.api.dto;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * è®¢å•é¡¹DTOç±? */
@Data
public class OrderItemDTO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long productId;
    private String productName;
    private String productImage;
    private BigDecimal currentUnitPrice;
    private Integer quantity;
    private BigDecimal totalPrice;
    private String specAttributes;
    private String productSn;
}
package com.heikeji.api.dto;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * æ”¯ä»˜DTOç±? */
@Data
public class PaymentDTO implements Serializable {
    private static final long serialVersionUID = 1L;

    private String orderId;
    private Long userId;
    private BigDecimal amount;
    private String paymentType;
    private String subject;
    private String body;
    private String returnUrl;
    private String notifyUrl;
    private String clientIp;
    private String refundId;
    private BigDecimal refundAmount;
    private String refundReason;
}
package com.heikeji.api.dto;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.List;

/**
 * å•†å“DTOç±? */
@Data
public class ProductDTO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private String name;
    private String description;
    private String subtitle;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer stock;
    private Long categoryId;
    private Integer status;
    private String mainImage;
    private List<String> imageList;
    private Integer sales;
    private Integer sortOrder;
    private String specItems;
    private String attributeItems;
}
package com.heikeji.api.dto;

import lombok.Data;

import java.io.Serializable;

/**
 * ç”¨æˆ·DTOç±? */
@Data
public class UserDTO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private String username;
    private String password;
    private String phone;
    private String email;
    private String nickname;
    private String avatar;
    private Integer gender;
    private String birthday;
    private String address;
    private String verificationCode;
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.OrderDTO;
import com.heikeji.api.vo.OrderVO;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(value = "service-order", fallback = OrderFeignClientFallback.class)
public interface OrderFeignClient {

    /**
     * åˆ›å»ºè®¢å•
     */
    @PostMapping("/order/create")
    Map<String, Object> createOrder(@RequestBody OrderDTO orderDTO);

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/order/{orderId}")
    OrderVO getOrderDetail(@PathVariable("orderId") String orderId);

    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/order/list")
    Map<String, Object> getUserOrderList(@RequestParam("userId") Long userId, @RequestParam Map<String, Object> params);

    /**
     * å–æ¶ˆè®¢å•
     */
    @PutMapping("/order/{orderId}/cancel")
    Boolean cancelOrder(@PathVariable("orderId") String orderId, @RequestParam("userId") Long userId);

    /**
     * ç¡®è®¤æ”¶è´§
     */
    @PutMapping("/order/{orderId}/confirm")
    Boolean confirmReceipt(@PathVariable("orderId") String orderId, @RequestParam("userId") Long userId);

    /**
     * åˆ é™¤è®¢å•
     */
    @DeleteMapping("/order/{orderId}")
    Boolean deleteOrder(@PathVariable("orderId") String orderId, @RequestParam("userId") Long userId);

    /**
     * è·å–è®¢å•çŠ¶æ€ç»Ÿè®?     */
    @GetMapping("/order/status/count")
    Map<String, Integer> getOrderStatusCount(@RequestParam("userId") Long userId);

    /**
     * è®¡ç®—è®¢å•é‡‘é¢
     */
    @PostMapping("/order/calculate")
    Map<String, Object> calculateOrder(@RequestBody OrderDTO orderDTO);

    /**
     * æ‰¹é‡è·å–è®¢å•è¯¦æƒ…
     */
    @PostMapping("/order/batch/detail")
    List<OrderVO> getBatchOrderDetail(@RequestBody List<String> orderIds);
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.OrderDTO;
import com.heikeji.api.vo.OrderVO;
import org.springframework.stereotype.Component;

import java.util.*;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class OrderFeignClientFallback implements OrderFeignClient {

    @Override
    public Map<String, Object> createOrder(OrderDTO orderDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è®¢å•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public OrderVO getOrderDetail(String orderId) {
        return null;
    }

    @Override
    public Map<String, Object> getUserOrderList(Long userId, Map<String, Object> params) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è®¢å•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        result.put("data", Collections.emptyList());
        result.put("total", 0);
        return result;
    }

    @Override
    public Boolean cancelOrder(String orderId, Long userId) {
        return false;
    }

    @Override
    public Boolean confirmReceipt(String orderId, Long userId) {
        return false;
    }

    @Override
    public Boolean deleteOrder(String orderId, Long userId) {
        return false;
    }

    @Override
    public Map<String, Integer> getOrderStatusCount(Long userId) {
        return Collections.emptyMap();
    }

    @Override
    public Map<String, Object> calculateOrder(OrderDTO orderDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è®¢å•æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public List<OrderVO> getBatchOrderDetail(List<String> orderIds) {
        return Collections.emptyList();
    }
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.PaymentDTO;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

/**
 * æ”¯ä»˜æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(value = "service-payment", fallback = PaymentFeignClientFallback.class)
public interface PaymentFeignClient {

    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     */
    @PostMapping("/payment/create")
    Map<String, Object> createPayment(@RequestBody PaymentDTO paymentDTO);

    /**
     * æ”¯ä»˜å›è°ƒ
     */
    @PostMapping("/payment/callback/{paymentType}")
    Map<String, Object> paymentCallback(@PathVariable("paymentType") String paymentType, @RequestBody Map<String, String> params);

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?     */
    @GetMapping("/payment/status/{orderId}")
    Map<String, Object> queryPaymentStatus(@PathVariable("orderId") String orderId);

    /**
     * å…³é—­æ”¯ä»˜è®¢å•
     */
    @PutMapping("/payment/close/{orderId}")
    Boolean closePayment(@PathVariable("orderId") String orderId);

    /**
     * ç”³è¯·é€€æ¬?     */
    @PostMapping("/payment/refund")
    Map<String, Object> applyRefund(@RequestBody PaymentDTO paymentDTO);

    /**
     * æŸ¥è¯¢é€€æ¬¾çŠ¶æ€?     */
    @GetMapping("/payment/refund/status/{refundId}")
    Map<String, Object> queryRefundStatus(@PathVariable("refundId") String refundId);

    /**
     * è·å–æ”¯ä»˜æ–¹å¼åˆ—è¡¨
     */
    @GetMapping("/payment/methods")
    Map<String, Object> getPaymentMethods();

    /**
     * è·å–æ”¯ä»˜é…ç½®
     */
    @GetMapping("/payment/config/{paymentType}")
    Map<String, Object> getPaymentConfig(@PathVariable("paymentType") String paymentType);
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.PaymentDTO;
import org.springframework.stereotype.Component;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

/**
 * æ”¯ä»˜æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class PaymentFeignClientFallback implements PaymentFeignClient {

    @Override
    public Map<String, Object> createPayment(PaymentDTO paymentDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public Map<String, Object> paymentCallback(String paymentType, Map<String, String> params) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public Map<String, Object> queryPaymentStatus(String orderId) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public Boolean closePayment(String orderId) {
        return false;
    }

    @Override
    public Map<String, Object> applyRefund(PaymentDTO paymentDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public Map<String, Object> queryRefundStatus(String refundId) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public Map<String, Object> getPaymentMethods() {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        result.put("data", Collections.emptyList());
        return result;
    }

    @Override
    public Map<String, Object> getPaymentConfig(String paymentType) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.ProductDTO;
import com.heikeji.api.vo.ProductVO;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(value = "service-product", fallback = ProductFeignClientFallback.class)
public interface ProductFeignClient {

    /**
     * è·å–å•†å“åˆ—è¡¨
     */
    @GetMapping("/product/list")
    Map<String, Object> getProductList(@RequestParam Map<String, Object> params);

    /**
     * è·å–å•†å“è¯¦æƒ…
     */
    @GetMapping("/product/{id}")
    ProductVO getProductDetail(@PathVariable("id") Long productId);

    /**
     * è·å–å•†å“åˆ†ç±»
     */
    @GetMapping("/product/category/list")
    List<Map<String, Object>> getCategoryList();

    /**
     * æ ¹æ®åˆ†ç±»è·å–å•†å“
     */
    @GetMapping("/product/category/{categoryId}")
    Map<String, Object> getProductsByCategory(@PathVariable("categoryId") Long categoryId, @RequestParam Map<String, Object> params);

    /**
     * æœç´¢å•†å“
     */
    @GetMapping("/product/search")
    Map<String, Object> searchProducts(@RequestParam Map<String, Object> params);

    /**
     * è·å–çƒ­é—¨å•†å“
     */
    @GetMapping("/product/hot")
    List<ProductVO> getHotProducts(@RequestParam(value = "limit", defaultValue = "10") Integer limit);

    /**
     * è·å–æ¨èå•†å“
     */
    @GetMapping("/product/recommend")
    List<ProductVO> getRecommendProducts(@RequestParam(value = "limit", defaultValue = "10") Integer limit);

    /**
     * è·å–å•†å“åº“å­˜
     */
    @GetMapping("/product/stock/{productId}")
    Integer getProductStock(@PathVariable("productId") Long productId);
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.ProductDTO;
import com.heikeji.api.vo.ProductVO;
import org.springframework.stereotype.Component;

import java.util.*;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class ProductFeignClientFallback implements ProductFeignClient {

    @Override
    public Map<String, Object> getProductList(Map<String, Object> params) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        result.put("data", Collections.emptyList());
        result.put("total", 0);
        return result;
    }

    @Override
    public ProductVO getProductDetail(Long productId) {
        return null;
    }

    @Override
    public List<Map<String, Object>> getCategoryList() {
        return Collections.emptyList();
    }

    @Override
    public Map<String, Object> getProductsByCategory(Long categoryId, Map<String, Object> params) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        result.put("data", Collections.emptyList());
        result.put("total", 0);
        return result;
    }

    @Override
    public Map<String, Object> searchProducts(Map<String, Object> params) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "å•†å“æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        result.put("data", Collections.emptyList());
        result.put("total", 0);
        return result;
    }

    @Override
    public List<ProductVO> getHotProducts(Integer limit) {
        return Collections.emptyList();
    }

    @Override
    public List<ProductVO> getRecommendProducts(Integer limit) {
        return Collections.emptyList();
    }

    @Override
    public Integer getProductStock(Long productId) {
        return 0;
    }
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.CartItemDTO;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * è´­ç‰©è½¦æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(value = "service-cart", fallback = ShoppingCartFeignClientFallback.class)
public interface ShoppingCartFeignClient {

    /**
     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
     */
    @PostMapping("/cart/add")
    Map<String, Object> addToCart(@RequestBody CartItemDTO cartItemDTO);

    /**
     * è·å–è´­ç‰©è½¦åˆ—è¡?     */
    @GetMapping("/cart/list/{userId}")
    Map<String, Object> getCartList(@PathVariable("userId") Long userId);

    /**
     * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @PutMapping("/cart/update")
    Map<String, Object> updateCartItem(@RequestBody CartItemDTO cartItemDTO);

    /**
     * åˆ é™¤è´­ç‰©è½¦å•†å“?     */
    @DeleteMapping("/cart/delete/{userId}")
    Boolean deleteCartItems(@PathVariable("userId") Long userId, @RequestParam("itemIds") List<Long> itemIds);

    /**
     * æ¸…ç©ºè´­ç‰©è½?     */
    @DeleteMapping("/cart/clear/{userId}")
    Boolean clearCart(@PathVariable("userId") Long userId);

    /**
     * é€‰æ‹©/å–æ¶ˆé€‰æ‹©å•†å“
     */
    @PutMapping("/cart/select")
    Map<String, Object> selectCartItems(@RequestBody CartItemDTO cartItemDTO);

    /**
     * è·å–è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @GetMapping("/cart/count/{userId}")
    Integer getCartItemCount(@PathVariable("userId") Long userId);

    /**
     * æ‰¹é‡è·å–è´­ç‰©è½¦å•†å“è¯¦æƒ?     */
    @PostMapping("/cart/batch/detail")
    Map<String, Object> getBatchCartItems(@RequestBody List<Long> itemIds);

    /**
     * åˆå¹¶è´­ç‰©è½¦ï¼ˆç™»å½•åï¼‰
     */
    @PostMapping("/cart/merge")
    Map<String, Object> mergeCart(@RequestParam("userId") Long userId, @RequestBody List<CartItemDTO> cartItems);
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.CartItemDTO;
import org.springframework.stereotype.Component;

import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * è´­ç‰©è½¦æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class ShoppingCartFeignClientFallback implements ShoppingCartFeignClient {

    @Override
    public Map<String, Object> addToCart(CartItemDTO cartItemDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è´­ç‰©è½¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        return result;
    }

    @Override
    public Map<String, Object> getCartList(Long userId) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è´­ç‰©è½¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        result.put("data", Collections.emptyList());
        return result;
    }

    @Override
    public Map<String, Object> updateCartItem(CartItemDTO cartItemDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è´­ç‰©è½¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        return result;
    }

    @Override
    public Boolean deleteCartItems(Long userId, List<Long> itemIds) {
        return false;
    }

    @Override
    public Boolean clearCart(Long userId) {
        return false;
    }

    @Override
    public Map<String, Object> selectCartItems(CartItemDTO cartItemDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è´­ç‰©è½¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        return result;
    }

    @Override
    public Integer getCartItemCount(Long userId) {
        return 0;
    }

    @Override
    public Map<String, Object> getBatchCartItems(List<Long> itemIds) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è´­ç‰©è½¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        result.put("data", Collections.emptyList());
        return result;
    }

    @Override
    public Map<String, Object> mergeCart(Long userId, List<CartItemDTO> cartItems) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "è´­ç‰©è½¦æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        return result;
    }
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.UserDTO;
import com.heikeji.api.vo.UserVO;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

/**
 * ç”¨æˆ·æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(value = "service-user", fallback = UserFeignClientFallback.class)
public interface UserFeignClient {

    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/user/login")
    Map<String, Object> login(@RequestBody Map<String, String> params);

    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/user/register")
    Map<String, Object> register(@RequestBody UserDTO userDTO);

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/user/info")
    UserVO getUserInfo(@RequestParam("userId") Long userId);

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    @PutMapping("/user/update")
    Boolean updateUserInfo(@RequestBody UserDTO userDTO);

    /**
     * ä¿®æ”¹å¯†ç 
     */
    @PutMapping("/user/password")
    Boolean changePassword(@RequestBody Map<String, String> params);

    /**
     * å‘é€éªŒè¯ç 
     */
    @PostMapping("/user/sendCode")
    Boolean sendCode(@RequestParam("phone") String phone);

    /**
     * éªŒè¯éªŒè¯ç ?     */
    @PostMapping("/user/verifyCode")
    Boolean verifyCode(@RequestBody Map<String, String> params);
}
package com.heikeji.api.feign;

import com.heikeji.api.dto.UserDTO;
import com.heikeji.api.vo.UserVO;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Map;

/**
 * ç”¨æˆ·æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class UserFeignClientFallback implements UserFeignClient {

    @Override
    public Map<String, Object> login(Map<String, String> params) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public Map<String, Object> register(UserDTO userDTO) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯?);
        return result;
    }

    @Override
    public UserVO getUserInfo(Long userId) {
        return null;
    }

    @Override
    public Boolean updateUserInfo(UserDTO userDTO) {
        return false;
    }

    @Override
    public Boolean changePassword(Map<String, String> params) {
        return false;
    }

    @Override
    public Boolean sendCode(String phone) {
        return false;
    }

    @Override
    public Boolean verifyCode(Map<String, String> params) {
        return false;
    }
}
package com.heikeji.api.vo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;

/**
 * è®¢å•é¡¹VOç±? */
@Data
public class OrderItemVO implements Serializable {
    private static final long serialVersionUID = 1L;

    private String orderNo;
    private Long productId;
    private String productName;
    private String productImage;
    private BigDecimal currentUnitPrice;
    private Integer quantity;
    private BigDecimal totalPrice;
    private String specAttributes;
    private String productSn;
}
package com.heikeji.api.vo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

/**
 * è®¢å•VOç±? */
@Data
public class OrderVO implements Serializable {
    private static final long serialVersionUID = 1L;

    private String orderNo;
    private Long userId;
    private String receiverName;
    private String receiverPhone;
    private String receiverProvince;
    private String receiverCity;
    private String receiverDistrict;
    private String receiverAddress;
    private String receiverZip;
    private BigDecimal payment;
    private Integer paymentType;
    private String paymentTypeDesc;
    private Integer postage;
    private Integer status;
    private String statusDesc;
    private List<OrderItemVO> orderItems;
    private String message;
    private Date createTime;
    private Date paymentTime;
    private Date endTime;
    private Date closeTime;
    private Date shippingTime;
    private Date confirmTime;
    private Date updateTime;
}
package com.heikeji.api.vo;

import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;
import java.util.List;
import java.util.Map;

/**
 * å•†å“VOç±? */
@Data
public class ProductVO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private String name;
    private String description;
    private String subtitle;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer stock;
    private Long categoryId;
    private String categoryName;
    private Integer status;
    private String mainImage;
    private List<String> imageList;
    private Integer sales;
    private String productSn;
    private Integer sortOrder;
    private List<Map<String, Object>> specList;
    private List<Map<String, Object>> attributeList;
    private Date createTime;
    private Date updateTime;
}
package com.heikeji.api.vo;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * ç”¨æˆ·VOç±? */
@Data
public class UserVO implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private String username;
    private String nickname;
    private String phone;
    private String email;
    private String avatar;
    private Integer gender;
    private String birthday;
    private String address;
    private Integer status;
    private Date createTime;
    private Date updateTime;
}
package com.heikeji.job;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.scheduling.annotation.EnableScheduling;

/**
 * å®šæ—¶ä»»åŠ¡æ¨¡å—å¯åŠ¨ç±? * 
 * @author heikeji
 */
@SpringBootApplication
@EnableFeignClients
@EnableScheduling
public class JobApplication {

    public static void main(String[] args) {
        SpringApplication.run(JobApplication.class, args);
    }

}
package com.heikeji.job.config;

import org.quartz.Job;
import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.quartz.JobListener;
import org.quartz.Scheduler;
import org.quartz.Trigger;
import org.quartz.TriggerListener;
// import org.quartz.listeners.StdJobListener;
// import org.quartz.listeners.StdTriggerListener;
import org.quartz.plugins.management.ShutdownHookPlugin;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.ClassPathResource;
import org.springframework.scheduling.quartz.SchedulerFactoryBean;

import javax.sql.DataSource;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;

/**
 * Quartzå®šæ—¶ä»»åŠ¡é…ç½®ç±? * é…ç½®Quartzè°ƒåº¦å™¨çš„å„é¡¹å‚æ•°å’Œç›‘å¬å™¨
 * 
 * @author heikeji
 */
@Configuration
public class QuartzConfig {

    /**
     * åˆ›å»ºä»»åŠ¡ç›‘å¬å™?     * @return ä»»åŠ¡ç›‘å¬å™¨åˆ—è¡?     */
    @Bean
    public List<JobListener> jobListeners() {
        List<JobListener> listeners = new ArrayList<>();
        // æ·»åŠ è‡ªå®šä¹‰ä»»åŠ¡ç›‘å¬å™¨
        listeners.add(new DefaultJobListener());
        return listeners;
    }

    /**
     * åˆ›å»ºè§¦å‘å™¨ç›‘å¬å™¨
     * @return è§¦å‘å™¨ç›‘å¬å™¨åˆ—è¡¨
     */
    @Bean
    public List<TriggerListener> triggerListeners() {
        List<TriggerListener> listeners = new ArrayList<>();
        // æ·»åŠ è‡ªå®šä¹‰è§¦å‘å™¨ç›‘å¬å™?        listeners.add(new DefaultTriggerListener());
        return listeners;
    }

    /**
     * è‡ªå®šä¹‰ä»»åŠ¡ç›‘å¬å™¨
     */
    public static class DefaultJobListener implements JobListener {
        @Override
        public String getName() {
            return "defaultJobListener";
        }

        @Override
        public void jobToBeExecuted(JobExecutionContext context) {
            System.out.println("ä»»åŠ¡å³å°†æ‰§è¡Œ: " + context.getJobDetail().getKey());
        }

        @Override
        public void jobExecutionVetoed(JobExecutionContext context) {
            System.out.println("ä»»åŠ¡æ‰§è¡Œè¢«æ‹’ç»? " + context.getJobDetail().getKey());
        }

        @Override
        public void jobWasExecuted(JobExecutionContext context, JobExecutionException jobException) {
            System.out.println("ä»»åŠ¡æ‰§è¡Œå®Œæˆ: " + context.getJobDetail().getKey());
            if (jobException != null) {
                System.out.println("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸: " + jobException.getMessage());
            }
        }
    }

    /**
     * è‡ªå®šä¹‰è§¦å‘å™¨ç›‘å¬å™?     */
    public static class DefaultTriggerListener implements TriggerListener {
        @Override
        public String getName() {
            return "defaultTriggerListener";
        }

        @Override
        public void triggerFired(Trigger trigger, JobExecutionContext context) {
            System.out.println("è§¦å‘å™¨è§¦å? " + trigger.getKey());
        }

        @Override
        public boolean vetoJobExecution(Trigger trigger, JobExecutionContext context) {
            return false;
        }

        @Override
        public void triggerMisfired(Trigger trigger) {
            System.out.println("è§¦å‘å™¨é”™è¿‡è§¦å? " + trigger.getKey());
        }

        @Override
        public void triggerComplete(Trigger trigger, JobExecutionContext context, Trigger.CompletedExecutionInstruction triggerInstructionCode) {
            System.out.println("è§¦å‘å™¨æ‰§è¡Œå®Œæˆ? " + trigger.getKey());
        }
    }

    /**
     * é…ç½®SchedulerFactoryBean
     * 
     * @param dataSource æ•°æ®æºï¼ˆå¯é€‰ï¼Œå†…å­˜æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰
     * @return SchedulerFactoryBean
     */
    @Bean
    public SchedulerFactoryBean schedulerFactoryBean(DataSource dataSource, 
                                                    List<JobListener> jobListeners, 
                                                    List<TriggerListener> triggerListeners) {
        SchedulerFactoryBean factory = new SchedulerFactoryBean();
        
        // ä»»åŠ¡å­˜å‚¨æ–¹å¼ä¸ºæ•°æ®åº“æ—¶è®¾ç½®æ•°æ®æº
        if (dataSource != null) {
            factory.setDataSource(dataSource);
        }
        
        // å»¶æ—¶å¯åŠ¨ï¼Œåº”ç”¨å¯åŠ?ç§’ååˆå§‹åŒ?        factory.setStartupDelay(3);
        
        // å…è®¸è¦†ç›–å·²å­˜åœ¨çš„ä»»åŠ¡
        factory.setOverwriteExistingJobs(true);
        
        // æ³¨å†Œè§¦å‘å™¨ç›‘å?        factory.setGlobalTriggerListeners(triggerListeners.toArray(new TriggerListener[0]));
        
        // æ³¨å†Œä»»åŠ¡ç›‘å¬
        factory.setGlobalJobListeners(jobListeners.toArray(new JobListener[0]));
        
        // é…ç½®Quartzå±æ€?        factory.setQuartzProperties(quartzProperties());
        
        // æ·»åŠ å…³é—­é’©å­æ’ä»¶ï¼Œç¡®ä¿åº”ç”¨ä¼˜é›…å…³é—­æ—¶ä»»åŠ¡èƒ½å¤Ÿæ­£ç¡®ç»ˆæ­¢
        factory.setWaitForJobsToCompleteOnShutdown(true);
        
        return factory;
    }

    /**
     * é…ç½®Quartzå±æ€?     * @return Quartzå±æ€?     */
    private Properties quartzProperties() {
        Properties properties = new Properties();
        // çº¿ç¨‹æ± é…ç½?        properties.setProperty("org.quartz.threadPool.threadCount", "10");
        properties.setProperty("org.quartz.threadPool.threadPriority", "5");
        properties.setProperty("org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread", "true");
        
        // è°ƒåº¦å™¨é…ç½?        properties.setProperty("org.quartz.scheduler.instanceId", "AUTO");
        properties.setProperty("org.quartz.scheduler.makeSchedulerThreadDaemon", "true");
        
        // ä½œä¸šå­˜å‚¨é…ç½®
        properties.setProperty("org.quartz.jobStore.misfireThreshold", "60000");
        
        return properties;
    }

    /**
     * åˆ›å»ºSchedulerå®ä¾‹
     * 
     * @param schedulerFactoryBean Schedulerå·¥å‚
     * @return Scheduler
     */
    @Bean
    public Scheduler scheduler(SchedulerFactoryBean schedulerFactoryBean) {
        return schedulerFactoryBean.getScheduler();
    }

}
package com.heikeji.job.config;

import com.heikeji.job.service.JobService;
import org.quartz.Scheduler;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;

import jakarta.annotation.PostConstruct;

/**
 * Quartzè°ƒåº¦å™¨é…ç½®ç±»
 * ç”¨äºå°†JobServiceæ³¨å†Œåˆ°SchedulerContextä¸­ï¼Œä¾›Quartzä»»åŠ¡ä½¿ç”¨
 * 
 * @author heikeji
 */
@Configuration
public class QuartzSchedulerConfig {

    @Autowired
    private Scheduler scheduler;

    @Autowired
    private JobService jobService;

    /**
     * åˆå§‹åŒ–æ—¶å°†JobServiceæ³¨å†Œåˆ°SchedulerContext
     */
    @PostConstruct
    public void init() {
        try {
            // å°†JobServiceæ³¨å†Œåˆ°SchedulerContextä¸?            scheduler.getContext().put("jobService", jobService);
        } catch (Exception e) {
            throw new RuntimeException("Failed to initialize Quartz scheduler context", e);
        }
    }

}
package com.heikeji.job.controller;

import com.heikeji.job.scheduler.QuartzJobScheduler;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.quartz.JobDataMap;
import org.quartz.SchedulerException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Date;

/**
 * ä»»åŠ¡ç®¡ç†æ§åˆ¶å™? * æä¾›RESTful APIæ¥å£ç”¨äºç®¡ç†å®šæ—¶ä»»åŠ¡
 * 
 * @author heikeji
 */
@RestController
@RequestMapping("/job")
@Api(tags = "ä»»åŠ¡ç®¡ç†")
@Slf4j
public class JobController {

    @Autowired
    private QuartzJobScheduler quartzJobScheduler;

    /**
     * æ·»åŠ å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @param jobClassName ä»»åŠ¡ç±»å…¨é™å®šå?     * @param cronExpression cronè¡¨è¾¾å¼?     * @return å“åº”ç»“æœ
     */
    @PostMapping("/add")
    @ApiOperation("æ·»åŠ å®šæ—¶ä»»åŠ¡")
    public ResponseEntity<String> addJob(@RequestParam String jobName,
                                        @RequestParam String jobGroup,
                                        @RequestParam String triggerName,
                                        @RequestParam String triggerGroup,
                                        @RequestParam String jobClassName,
                                        @RequestParam String cronExpression) {
        try {
            // éªŒè¯cronè¡¨è¾¾å¼å’Œä»»åŠ¡ç±?            if (!isValidCronExpression(cronExpression)) {
                return ResponseEntity.badRequest().body("æ— æ•ˆçš„cronè¡¨è¾¾å¼?);
            }

            // åŠ è½½ä»»åŠ¡ç±?            Class<?> jobClass;
            try {
                jobClass = Class.forName(jobClassName);
                if (!org.quartz.Job.class.isAssignableFrom(jobClass)) {
                    return ResponseEntity.badRequest().body("ä»»åŠ¡ç±»å¿…é¡»å®ç°org.quartz.Jobæ¥å£");
                }
            } catch (ClassNotFoundException e) {
                return ResponseEntity.badRequest().body("æ‰¾ä¸åˆ°æŒ‡å®šçš„ä»»åŠ¡ç±? " + jobClassName);
            }

            // æ·»åŠ ä»»åŠ¡
            quartzJobScheduler.addJob(jobName, jobGroup, triggerName, triggerGroup,
                    jobClass.asSubclass(org.quartz.Job.class), cronExpression, new JobDataMap());
            
            return ResponseEntity.ok("æ·»åŠ å®šæ—¶ä»»åŠ¡æˆåŠŸ");
        } catch (SchedulerException e) {
            log.error("æ·»åŠ å®šæ—¶ä»»åŠ¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("æ·»åŠ å®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æ›´æ–°å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @param cronExpression cronè¡¨è¾¾å¼?     * @return å“åº”ç»“æœ
     */
    @PostMapping("/update")
    @ApiOperation("æ›´æ–°å®šæ—¶ä»»åŠ¡")
    public ResponseEntity<String> updateJob(@RequestParam String jobName,
                                          @RequestParam String jobGroup,
                                          @RequestParam String triggerName,
                                          @RequestParam String triggerGroup,
                                          @RequestParam String cronExpression) {
        try {
            // éªŒè¯cronè¡¨è¾¾å¼?            if (!isValidCronExpression(cronExpression)) {
                return ResponseEntity.badRequest().body("æ— æ•ˆçš„cronè¡¨è¾¾å¼?);
            }

            // éªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨
            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                return ResponseEntity.badRequest().body("ä»»åŠ¡ä¸å­˜åœ?);
            }

            // æ›´æ–°ä»»åŠ¡
            quartzJobScheduler.updateJob(jobName, jobGroup, triggerName, triggerGroup, cronExpression);
            
            return ResponseEntity.ok("æ›´æ–°å®šæ—¶ä»»åŠ¡æˆåŠŸ");
        } catch (SchedulerException e) {
            log.error("æ›´æ–°å®šæ—¶ä»»åŠ¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("æ›´æ–°å®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * åˆ é™¤å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @return å“åº”ç»“æœ
     */
    @PostMapping("/delete")
    @ApiOperation("åˆ é™¤å®šæ—¶ä»»åŠ¡")
    public ResponseEntity<String> deleteJob(@RequestParam String jobName,
                                          @RequestParam String jobGroup,
                                          @RequestParam String triggerName,
                                          @RequestParam String triggerGroup) {
        try {
            // éªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨
            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                return ResponseEntity.badRequest().body("ä»»åŠ¡ä¸å­˜åœ?);
            }

            // åˆ é™¤ä»»åŠ¡
            quartzJobScheduler.deleteJob(jobName, jobGroup, triggerName, triggerGroup);
            
            return ResponseEntity.ok("åˆ é™¤å®šæ—¶ä»»åŠ¡æˆåŠŸ");
        } catch (SchedulerException e) {
            log.error("åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æš‚åœå®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @return å“åº”ç»“æœ
     */
    @PostMapping("/pause")
    @ApiOperation("æš‚åœå®šæ—¶ä»»åŠ¡")
    public ResponseEntity<String> pauseJob(@RequestParam String jobName,
                                         @RequestParam String jobGroup) {
        try {
            // éªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨
            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                return ResponseEntity.badRequest().body("ä»»åŠ¡ä¸å­˜åœ?);
            }

            // æš‚åœä»»åŠ¡
            quartzJobScheduler.pauseJob(jobName, jobGroup);
            
            return ResponseEntity.ok("æš‚åœå®šæ—¶ä»»åŠ¡æˆåŠŸ");
        } catch (SchedulerException e) {
            log.error("æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("æš‚åœå®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æ¢å¤å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @return å“åº”ç»“æœ
     */
    @PostMapping("/resume")
    @ApiOperation("æ¢å¤å®šæ—¶ä»»åŠ¡")
    public ResponseEntity<String> resumeJob(@RequestParam String jobName,
                                          @RequestParam String jobGroup) {
        try {
            // éªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨
            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                return ResponseEntity.badRequest().body("ä»»åŠ¡ä¸å­˜åœ?);
            }

            // æ¢å¤ä»»åŠ¡
            quartzJobScheduler.resumeJob(jobName, jobGroup);
            
            return ResponseEntity.ok("æ¢å¤å®šæ—¶ä»»åŠ¡æˆåŠŸ");
        } catch (SchedulerException e) {
            log.error("æ¢å¤å®šæ—¶ä»»åŠ¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("æ¢å¤å®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @return å“åº”ç»“æœ
     */
    @PostMapping("/trigger")
    @ApiOperation("ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡")
    public ResponseEntity<String> triggerJob(@RequestParam String jobName,
                                           @RequestParam String jobGroup) {
        try {
            // éªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨
            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                return ResponseEntity.badRequest().body("ä»»åŠ¡ä¸å­˜åœ?);
            }

            // ç«‹å³æ‰§è¡Œä»»åŠ¡
            quartzJobScheduler.triggerJob(jobName, jobGroup);
            
            return ResponseEntity.ok("ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡æˆåŠŸ");
        } catch (SchedulerException e) {
            log.error("ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å­˜åœ?     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @return å“åº”ç»“æœ
     */
    @GetMapping("/check")
    @ApiOperation("æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å­˜åœ?)
    public ResponseEntity<Boolean> checkJob(@RequestParam String jobName,
                                          @RequestParam String jobGroup) {
        try {
            boolean exists = quartzJobScheduler.checkJobExists(jobName, jobGroup);
            return ResponseEntity.ok(exists);
        } catch (SchedulerException e) {
            log.error("æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å­˜åœ¨å¤±è´?, e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(false);
        }
    }

    /**
     * è·å–ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
     * 
     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @return å“åº”ç»“æœ
     */
    @GetMapping("/next-fire-time")
    @ApiOperation("è·å–ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´")
    public ResponseEntity<String> getNextFireTime(@RequestParam String triggerName,
                                                @RequestParam String triggerGroup) {
        try {
            Date nextFireTime = quartzJobScheduler.getNextFireTime(triggerName, triggerGroup);
            if (nextFireTime != null) {
                return ResponseEntity.ok(nextFireTime.toString());
            } else {
                return ResponseEntity.ok("æš‚æ— ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´");
            }
        } catch (SchedulerException e) {
            log.error("è·å–ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´å¤±è´¥", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("è·å–ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * éªŒè¯cronè¡¨è¾¾å¼æ˜¯å¦æœ‰æ•?     * 
     * @param cronExpression cronè¡¨è¾¾å¼?     * @return æ˜¯å¦æœ‰æ•ˆ
     */
    private boolean isValidCronExpression(String cronExpression) {
        try {
            // ç®€å•éªŒè¯cronè¡¨è¾¾å¼æ ¼å¼?            if (cronExpression == null || cronExpression.trim().isEmpty()) {
                return false;
            }
            
            // ä½¿ç”¨Quartzçš„CronExpressionéªŒè¯
            org.quartz.CronExpression.validateExpression(cronExpression);
            return true;
        } catch (Exception e) {
            log.warn("æ— æ•ˆçš„cronè¡¨è¾¾å¼? {}", cronExpression, e);
            return false;
        }
    }
}
package com.heikeji.job.controller;

import com.heikeji.job.entity.JobLog;
import com.heikeji.job.service.JobLogService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * ä»»åŠ¡æ—¥å¿—æ§åˆ¶å™? * æä¾›APIæ¥å£ç”¨äºæŸ¥è¯¢å’Œç®¡ç†ä»»åŠ¡æ—¥å¿? * 
 * @author heikeji
 */
@RestController
@RequestMapping("/job-log")
@Api(tags = "ä»»åŠ¡æ—¥å¿—ç®¡ç†")
public class JobLogController {

    @Autowired
    private JobLogService jobLogService;

    /**
     * æ ¹æ®IDæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—
     * 
     * @param id æ—¥å¿—ID
     * @return ä»»åŠ¡æ—¥å¿—
     */
    @GetMapping("/{id}")
    @ApiOperation("æ ¹æ®IDæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—")
    public ResponseEntity<JobLog> getJobLogById(@PathVariable Long id) {
        JobLog jobLog = jobLogService.getJobLogById(id);
        if (jobLog != null) {
            return ResponseEntity.ok(jobLog);
        } else {
            return ResponseEntity.notFound().build();
        }
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—
     * 
     * @param jobName ä»»åŠ¡åç§°ï¼ˆå¯é€‰ï¼‰
     * @param jobGroup ä»»åŠ¡ç»„ï¼ˆå¯é€‰ï¼‰
     * @param status æ‰§è¡ŒçŠ¶æ€ï¼ˆå¯é€‰ï¼Œ0-æˆåŠŸï¼?-å¤±è´¥ï¼?     * @param startTime å¼€å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼?     * @param endTime ç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼Œæ ¼å¼ï¼šyyyy-MM-dd HH:mm:ssï¼?     * @param pageNum é¡µç 
     * @param pageSize æ¯é¡µæ•°é‡
     * @return åˆ†é¡µç»“æœ
     */
    @GetMapping("/page")
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—")
    public ResponseEntity<Map<String, Object>> pageJobLogs(
            @RequestParam(required = false) String jobName,
            @RequestParam(required = false) String jobGroup,
            @RequestParam(required = false) Integer status,
            @RequestParam(required = false) String startTime,
            @RequestParam(required = false) String endTime,
            @RequestParam(defaultValue = "1") int pageNum,
            @RequestParam(defaultValue = "10") int pageSize) {
        try {
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            Map<String, Object> params = new HashMap<>();
            if (jobName != null && !jobName.trim().isEmpty()) {
                params.put("jobName", jobName);
            }
            if (jobGroup != null && !jobGroup.trim().isEmpty()) {
                params.put("jobGroup", jobGroup);
            }
            if (status != null) {
                params.put("status", status);
            }
            
            // å¤„ç†æ—¶é—´å‚æ•°
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            if (startTime != null && !startTime.trim().isEmpty()) {
                try {
                    params.put("startTime", sdf.parse(startTime));
                } catch (ParseException e) {
                    return ResponseEntity.badRequest().body(null);
                }
            }
            if (endTime != null && !endTime.trim().isEmpty()) {
                try {
                    params.put("endTime", sdf.parse(endTime));
                } catch (ParseException e) {
                    return ResponseEntity.badRequest().body(null);
                }
            }
            
            // éªŒè¯åˆ†é¡µå‚æ•°
            if (pageNum < 1) {
                pageNum = 1;
            }
            if (pageSize < 1 || pageSize > 100) {
                pageSize = 10;
            }
            
            // æŸ¥è¯¢åˆ†é¡µæ•°æ®
            Map<String, Object> result = jobLogService.pageJobLogs(params, pageNum, pageSize);
            return ResponseEntity.ok(result);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
        }
    }

    /**
     * åˆ é™¤ä»»åŠ¡æ—¥å¿—
     * 
     * @param ids æ—¥å¿—IDåˆ—è¡¨
     * @return å“åº”ç»“æœ
     */
    @DeleteMapping("/batch")
    @ApiOperation("æ‰¹é‡åˆ é™¤ä»»åŠ¡æ—¥å¿—")
    public ResponseEntity<String> deleteJobLogs(@RequestBody List<Long> ids) {
        if (ids == null || ids.isEmpty()) {
            return ResponseEntity.badRequest().body("è¯·é€‰æ‹©è¦åˆ é™¤çš„æ—¥å¿—");
        }
        
        int count = jobLogService.deleteJobLogs(ids);
        return ResponseEntity.ok("æˆåŠŸåˆ é™¤ " + count + " æ¡æ—¥å¿?);
    }

    /**
     * æ¸…ç†è¿‡æœŸçš„ä»»åŠ¡æ—¥å¿?     * 
     * @param days ä¿ç•™å¤©æ•°
     * @return å“åº”ç»“æœ
     */
    @PostMapping("/clean")
    @ApiOperation("æ¸…ç†è¿‡æœŸä»»åŠ¡æ—¥å¿—")
    public ResponseEntity<String> cleanJobLogs(@RequestParam(defaultValue = "30") int days) {
        if (days < 1) {
            return ResponseEntity.badRequest().body("ä¿ç•™å¤©æ•°ä¸èƒ½å°äº1");
        }
        
        int count = jobLogService.cleanJobLogs(days);
        return ResponseEntity.ok("æˆåŠŸæ¸…ç† " + count + " æ¡è¿‡æœŸæ—¥å¿?);
    }

    /**
     * è·å–ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
     * 
     * @return ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/statistics")
    @ApiOperation("è·å–ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯")
    public ResponseEntity<Map<String, Object>> getJobLogStatistics() {
        try {
            Map<String, Object> statistics = jobLogService.getJobLogStatistics();
            return ResponseEntity.ok(statistics);
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(null);
        }
    }
}
package com.heikeji.job.entity;

import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * ä»»åŠ¡æ—¥å¿—å®ä½“ç±? * è®°å½•å®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†? * 
 * @author heikeji
 */
@Data
public class JobLog implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * ä»»åŠ¡æ—¥å¿—ID
     */
    private Long id;

    /**
     * ä»»åŠ¡åç§°
     */
    private String jobName;

    /**
     * ä»»åŠ¡ç»?     */
    private String jobGroup;

    /**
     * ä»»åŠ¡å‚æ•°
     */
    private String jobParams;

    /**
     * æ‰§è¡Œå¼€å§‹æ—¶é—?     */
    private Date startTime;

    /**
     * æ‰§è¡Œç»“æŸæ—¶é—´
     */
    private Date endTime;

    /**
     * æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
     */
    private Long executeTime;

    /**
     * æ‰§è¡ŒçŠ¶æ€ï¼š0-æˆåŠŸï¼?-å¤±è´¥
     */
    private Integer status;

    /**
     * æ‰§è¡Œç»“æœ
     */
    private String result;

    /**
     * é”™è¯¯ä¿¡æ¯
     */
    private String errorMsg;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;
}
package com.heikeji.job.exception;

import com.heikeji.job.entity.JobLog;
import com.heikeji.job.service.JobLogService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Date;

/**
 * å®šæ—¶ä»»åŠ¡å¼‚å¸¸å¤„ç†å™? * ç»Ÿä¸€å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—å¹¶è¿›è¡Œå¿…è¦çš„æ¢å¤å¤„ç? * 
 * @author heikeji
 */
@Component
@Slf4j
public class JobExceptionHandler {

    @Autowired
    private JobLogService jobLogService;

    /**
     * å¤„ç†ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
     * 
     * @param jobName     ä»»åŠ¡åç§°
     * @param jobGroup    ä»»åŠ¡ç»„å
     * @param jobParams   ä»»åŠ¡å‚æ•°
     * @param startTime   ä»»åŠ¡å¼€å§‹æ—¶é—?     * @param exception   å¼‚å¸¸å¯¹è±¡
     */
    public void handleException(String jobName, String jobGroup, String jobParams, Date startTime, Exception exception) {
        log.error("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼Œä»»åŠ¡åç§? {}, ä»»åŠ¡ç»? {}", jobName, jobGroup, exception);
        
        // è®°å½•ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
        try {
            JobLog jobLog = new JobLog();
            jobLog.setJobName(jobName);
            jobLog.setJobGroup(jobGroup);
            jobLog.setJobParams(jobParams);
            jobLog.setStartTime(startTime);
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            jobLog.setStatus(1); // æ‰§è¡Œå¤±è´¥
            jobLog.setErrorMsg(exception.getMessage());
            jobLog.setResult("ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼? + exception.getMessage());
            
            jobLogService.saveJobLog(jobLog);
        } catch (Exception e) {
            log.error("ä¿å­˜ä»»åŠ¡å¼‚å¸¸æ—¥å¿—å¤±è´¥", e);
        }
        
        // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œå¦‚ï¼?        // 1. å‘é€å‘Šè­¦é€šçŸ¥
        // 2. è§¦å‘å¤±è´¥é‡è¯•æœºåˆ¶
        // 3. å…¶ä»–ä¸šåŠ¡æ¢å¤é€»è¾‘
    }

    /**
     * è®°å½•ä»»åŠ¡æ‰§è¡ŒæˆåŠŸæ—¥å¿—
     * 
     * @param jobName     ä»»åŠ¡åç§°
     * @param jobGroup    ä»»åŠ¡ç»„å
     * @param jobParams   ä»»åŠ¡å‚æ•°
     * @param startTime   ä»»åŠ¡å¼€å§‹æ—¶é—?     * @param result      æ‰§è¡Œç»“æœ
     */
    public void recordSuccessLog(String jobName, String jobGroup, String jobParams, Date startTime, String result) {
        try {
            JobLog jobLog = new JobLog();
            jobLog.setJobName(jobName);
            jobLog.setJobGroup(jobGroup);
            jobLog.setJobParams(jobParams);
            jobLog.setStartTime(startTime);
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            jobLog.setStatus(0); // æ‰§è¡ŒæˆåŠŸ
            jobLog.setResult(result);
            
            jobLogService.saveJobLog(jobLog);
        } catch (Exception e) {
            log.error("ä¿å­˜ä»»åŠ¡æˆåŠŸæ—¥å¿—å¤±è´¥", e);
        }
    }
}
package com.heikeji.job.feign;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«? * ç”¨äºè°ƒç”¨è®¢å•æœåŠ¡çš„æ¥å? * 
 * @author heikeji
 */
@FeignClient(name = "heikeji-service-order", fallback = OrderFeignClientFallback.class)
public interface OrderFeignClient {

    /**
     * å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•
     * 
     * @param minutes è¶…æ—¶åˆ†é’Ÿæ•?     * @return å–æ¶ˆçš„è®¢å•æ•°é‡?     */
    @PostMapping("/order/auto-cancel")
    Integer cancelTimeoutOrders(@RequestParam("minutes") Integer minutes);

    /**
     * è‡ªåŠ¨ç¡®è®¤è¶…æ—¶æœªæ”¶è´§çš„è®¢å•
     * 
     * @param days è¶…æ—¶å¤©æ•°
     * @return ç¡®è®¤æ”¶è´§çš„è®¢å•æ•°é‡?     */
    @PostMapping("/order/auto-confirm")
    Integer confirmTimeoutOrders(@RequestParam("days") Integer days);

}
package com.heikeji.job.feign;

import org.springframework.stereotype.Component;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å¤„ç†ç±»
 * å½“è®¢å•æœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†
 * 
 * @author heikeji
 */
@Component
public class OrderFeignClientFallback implements OrderFeignClient {

    @Override
    public Integer cancelTimeoutOrders(Integer minutes) {
        System.out.println("è®¢å•æœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•å–æ¶ˆè¶…æ—¶è®¢å•");
        return 0;
    }

    @Override
    public Integer confirmTimeoutOrders(Integer days) {
        System.out.println("è®¢å•æœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•ç¡®è®¤è¶…æ—¶è®¢å•");
        return 0;
    }

}
package com.heikeji.job.feign;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«? * ç”¨äºè°ƒç”¨å•†å“æœåŠ¡çš„æ¥å? * 
 * @author heikeji
 */
@FeignClient(name = "heikeji-service-product", fallback = ProductFeignClientFallback.class)
public interface ProductFeignClient {

    /**
     * æ£€æŸ¥å•†å“åº“å­˜é¢„è­?     * 
     * @param threshold åº“å­˜é¢„è­¦é˜ˆå€?     * @return é¢„è­¦å•†å“æ•°é‡
     */
    @PostMapping("/product/stock-warning")
    Integer checkStockWarning(@RequestParam("threshold") Integer threshold);

}
package com.heikeji.job.feign;

import org.springframework.stereotype.Component;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å¤„ç†ç±»
 * å½“å•†å“æœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†
 * 
 * @author heikeji
 */
@Component
public class ProductFeignClientFallback implements ProductFeignClient {

    @Override
    public Integer checkStockWarning(Integer threshold) {
        System.out.println("å•†å“æœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•æ£€æŸ¥åº“å­˜é¢„è­?);
        return 0;
    }

}
package com.heikeji.job.feign;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * ç³»ç»ŸæœåŠ¡Feignå®¢æˆ·ç«? * ç”¨äºè°ƒç”¨ç³»ç»ŸæœåŠ¡çš„æ¥å? * 
 * @author heikeji
 */
@FeignClient(name = "heikeji-system", fallback = SystemFeignClientFallback.class)
public interface SystemFeignClient {

    /**
     * æ¸…ç†ç³»ç»Ÿæ—¥å¿—
     * 
     * @param days æ¸…ç†å¤©æ•°
     * @return æ¸…ç†çš„æ—¥å¿—æ•°é‡?     */
    @PostMapping("/system/log/clean")
    Integer cleanSystemLogs(@RequestParam("days") Integer days);

    /**
     * æ‰§è¡Œæ•°æ®ç»Ÿè®¡
     * 
     * @param date ç»Ÿè®¡æ—¥æœŸï¼Œæ ¼å¼ï¼šyyyy-MM-dd
     * @return ç»Ÿè®¡ç»“æœ
     */
    @PostMapping("/system/statistics/execute")
    Boolean executeStatistics(@RequestParam("date") String date);

}
package com.heikeji.job.feign;

import org.springframework.stereotype.Component;

/**
 * ç³»ç»ŸæœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å¤„ç†ç±»
 * å½“ç³»ç»ŸæœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†
 * 
 * @author heikeji
 */
@Component
public class SystemFeignClientFallback implements SystemFeignClient {

    @Override
    public Integer cleanSystemLogs(Integer days) {
        System.out.println("ç³»ç»ŸæœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•æ¸…ç†æ—¥å¿—");
        return 0;
    }

    @Override
    public Boolean executeStatistics(String date) {
        System.out.println("ç³»ç»ŸæœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•æ‰§è¡Œç»Ÿè®¡");
        return false;
    }

}
package com.heikeji.job.feign.fallback;

import com.heikeji.job.feign.OrderFeignClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§ç±»
 * ç”¨äºæœåŠ¡ç†”æ–­æ—¶æä¾›é™çº§å¤„ç? * 
 * @author heikeji
 */
@Component
@Slf4j
public class OrderFeignClientFallback implements OrderFeignClient {

    /**
     * å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜çš„è®¢å• - é™çº§å®ç°
     * 
     * @param minutes è¶…æ—¶åˆ†é’Ÿæ•?     * @return 0
     */
    @Override
    public Integer cancelTimeoutOrders(Integer minutes) {
        log.error("è°ƒç”¨è®¢å•æœåŠ¡å–æ¶ˆè¶…æ—¶è®¢å•å¤±è´¥ï¼Œæ‰§è¡Œé™çº§å¤„ç?);
        return 0;
    }

    /**
     * è‡ªåŠ¨ç¡®è®¤è¶…æ—¶æœªæ”¶è´§çš„è®¢å• - é™çº§å®ç°
     * 
     * @param days è¶…æ—¶å¤©æ•°
     * @return 0
     */
    @Override
    public Integer confirmTimeoutOrders(Integer days) {
        log.error("è°ƒç”¨è®¢å•æœåŠ¡è‡ªåŠ¨ç¡®è®¤æ”¶è´§å¤±è´¥ï¼Œæ‰§è¡Œé™çº§å¤„ç?);
        return 0;
    }

}
package com.heikeji.job.feign.fallback;

import com.heikeji.job.feign.ProductFeignClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§ç±»
 * ç”¨äºæœåŠ¡ç†”æ–­æ—¶æä¾›é™çº§å¤„ç? * 
 * @author heikeji
 */
@Component
@Slf4j
public class ProductFeignClientFallback implements ProductFeignClient {

    /**
     * æ£€æŸ¥å•†å“åº“å­˜é¢„è­?- é™çº§å®ç°
     * 
     * @param threshold åº“å­˜é¢„è­¦é˜ˆå€?     * @return 0
     */
    @Override
    public Integer checkStockWarning(Integer threshold) {
        log.error("è°ƒç”¨å•†å“æœåŠ¡æ£€æŸ¥åº“å­˜é¢„è­¦å¤±è´¥ï¼Œæ‰§è¡Œé™çº§å¤„ç†");
        return 0;
    }

}
package com.heikeji.job.feign.fallback;

import com.heikeji.job.feign.SystemFeignClient;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * ç³»ç»ŸæœåŠ¡Feignå®¢æˆ·ç«¯é™çº§ç±»
 * ç”¨äºæœåŠ¡ç†”æ–­æ—¶æä¾›é™çº§å¤„ç? * 
 * @author heikeji
 */
@Component
@Slf4j
public class SystemFeignClientFallback implements SystemFeignClient {

    /**
     * æ¸…ç†ç³»ç»Ÿæ—¥å¿— - é™çº§å®ç°
     * 
     * @param days æ¸…ç†å¤©æ•°
     * @return 0
     */
    @Override
    public Integer cleanSystemLogs(Integer days) {
        log.error("è°ƒç”¨ç³»ç»ŸæœåŠ¡æ¸…ç†æ—¥å¿—å¤±è´¥ï¼Œæ‰§è¡Œé™çº§å¤„ç?);
        return 0;
    }

    /**
     * æ‰§è¡Œæ•°æ®ç»Ÿè®¡ - é™çº§å®ç°
     * 
     * @param date ç»Ÿè®¡æ—¥æœŸ
     * @return false
     */
    @Override
    public Boolean executeStatistics(String date) {
        log.error("è°ƒç”¨ç³»ç»ŸæœåŠ¡æ‰§è¡Œæ•°æ®ç»Ÿè®¡å¤±è´¥ï¼Œæ‰§è¡Œé™çº§å¤„ç?);
        return false;
    }

}
package com.heikeji.job.scheduler;

import com.heikeji.job.scheduler.job.DataStatisticsJob;
import com.heikeji.job.scheduler.job.LogCleanupJob;
import com.heikeji.job.scheduler.job.OrderAutoCancelJob;
import com.heikeji.job.scheduler.job.OrderAutoConfirmJob;
import com.heikeji.job.scheduler.job.ProductStockWarningJob;
import lombok.extern.slf4j.Slf4j;
import org.quartz.SchedulerException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.stereotype.Component;

/**
 * ä»»åŠ¡åˆå§‹åŒ–ç±»
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–æ‰€æœ‰å®šæ—¶ä»»åŠ? * 
 * @author heikeji
 */
@Component
@Slf4j
public class JobInitializer implements ApplicationRunner {

    @Autowired
    private QuartzJobScheduler quartzJobScheduler;

    /**
     * åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡
     * 
     * @param args åº”ç”¨å¯åŠ¨å‚æ•°
     */
    @Override
    public void run(ApplicationArguments args) {
        try {
            log.info("å¼€å§‹åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡...");
            
            // åˆå§‹åŒ–è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡ï¼ˆæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
            initOrderAutoCancelJob();
            
            // åˆå§‹åŒ–è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œï¼‰
            initOrderAutoConfirmJob();
            
            // åˆå§‹åŒ–å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡ï¼ˆæ¯å¤©ä¸Šåˆ9ç‚¹æ‰§è¡Œï¼‰
            initProductStockWarningJob();
            
            // åˆå§‹åŒ–æ—¥å¿—æ¸…ç†ä»»åŠ¡ï¼ˆæ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼‰
            initLogCleanupJob();
            
            // åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼‰
            initDataStatisticsJob();
            
            // å¯åŠ¨è°ƒåº¦å™?            quartzJobScheduler.startScheduler();
            
            log.info("æ‰€æœ‰å®šæ—¶ä»»åŠ¡åˆå§‹åŒ–å®Œæˆï¼ŒQuartzè°ƒåº¦å™¨å¯åŠ¨æˆåŠ?);
        } catch (Exception e) {
            log.error("åˆå§‹åŒ–å®šæ—¶ä»»åŠ¡å¤±è´?, e);
        }
    }

    /**
     * åˆå§‹åŒ–è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ?     */
    private void initOrderAutoCancelJob() {
        try {
            String jobName = "orderAutoCancelJob";
            String jobGroup = "orderJobGroup";
            String triggerName = jobName + "Trigger";
            String triggerGroup = jobGroup;
            String cronExpression = "0 0/1 * * * ?";
            
            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ?            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                quartzJobScheduler.addJob(jobName, jobGroup, triggerName, triggerGroup, 
                        OrderAutoCancelJob.class, cronExpression);
                log.info("åˆå§‹åŒ–è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æˆåŠ?);
            } else {
                log.info("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ?);
            }
        } catch (SchedulerException e) {
            log.error("åˆå§‹åŒ–è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡å¤±è´?, e);
        }
    }

    /**
     * åˆå§‹åŒ–è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ?     */
    private void initOrderAutoConfirmJob() {
        try {
            String jobName = "orderAutoConfirmJob";
            String jobGroup = "orderJobGroup";
            String triggerName = jobName + "Trigger";
            String triggerGroup = jobGroup;
            String cronExpression = "0 0 1 * * ?";
            
            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ?            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                quartzJobScheduler.addJob(jobName, jobGroup, triggerName, triggerGroup, 
                        OrderAutoConfirmJob.class, cronExpression);
                log.info("åˆå§‹åŒ–è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æˆåŠ?);
            } else {
                log.info("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ?);
            }
        } catch (SchedulerException e) {
            log.error("åˆå§‹åŒ–è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡å¤±è´?, e);
        }
    }

    /**
     * åˆå§‹åŒ–å•†å“åº“å­˜é¢„è­¦ä»»åŠ?     */
    private void initProductStockWarningJob() {
        try {
            String jobName = "productStockWarningJob";
            String jobGroup = "productJobGroup";
            String triggerName = jobName + "Trigger";
            String triggerGroup = jobGroup;
            String cronExpression = "0 0 9 * * ?";
            
            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ?            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                quartzJobScheduler.addJob(jobName, jobGroup, triggerName, triggerGroup, 
                        ProductStockWarningJob.class, cronExpression);
                log.info("åˆå§‹åŒ–å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æˆåŠ?);
            } else {
                log.info("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ?);
            }
        } catch (SchedulerException e) {
            log.error("åˆå§‹åŒ–å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡å¤±è´?, e);
        }
    }

    /**
     * åˆå§‹åŒ–æ—¥å¿—æ¸…ç†ä»»åŠ?     */
    private void initLogCleanupJob() {
        try {
            String jobName = "logCleanupJob";
            String jobGroup = "systemJobGroup";
            String triggerName = jobName + "Trigger";
            String triggerGroup = jobGroup;
            String cronExpression = "0 0 3 ? * 1";
            
            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ?            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                quartzJobScheduler.addJob(jobName, jobGroup, triggerName, triggerGroup, 
                        LogCleanupJob.class, cronExpression);
                log.info("åˆå§‹åŒ–æ—¥å¿—æ¸…ç†ä»»åŠ¡æˆåŠ?);
            } else {
                log.info("æ—¥å¿—æ¸…ç†ä»»åŠ¡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ?);
            }
        } catch (SchedulerException e) {
            log.error("åˆå§‹åŒ–æ—¥å¿—æ¸…ç†ä»»åŠ¡å¤±è´?, e);
        }
    }

    /**
     * åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡ä»»åŠ?     */
    private void initDataStatisticsJob() {
        try {
            String jobName = "dataStatisticsJob";
            String jobGroup = "statisticsJobGroup";
            String triggerName = jobName + "Trigger";
            String triggerGroup = jobGroup;
            String cronExpression = "0 0 2 * * ?";
            
            // æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ?            if (!quartzJobScheduler.checkJobExists(jobName, jobGroup)) {
                quartzJobScheduler.addJob(jobName, jobGroup, triggerName, triggerGroup, 
                        DataStatisticsJob.class, cronExpression);
                log.info("åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡ä»»åŠ¡æˆåŠ?);
            } else {
                log.info("æ•°æ®ç»Ÿè®¡ä»»åŠ¡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ?);
            }
        } catch (SchedulerException e) {
            log.error("åˆå§‹åŒ–æ•°æ®ç»Ÿè®¡ä»»åŠ¡å¤±è´?, e);
        }
    }
}
package com.heikeji.job.scheduler;

import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

/**
 * å®šæ—¶ä»»åŠ¡è°ƒåº¦ç±? * ä½¿ç”¨Springçš„@Scheduledæ³¨è§£å®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦
 * 
 * @author heikeji
 */
@Component
@Slf4j
public class JobScheduler {

    @Autowired
    private JobService jobService;

    /**
     * è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
     * æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬?     */
    @Scheduled(cron = "0 0/1 * * * ?")
    public void orderAutoCancelJob() {
        jobService.executeOrderAutoCancel();
    }

    /**
     * è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡
     * æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡?     */
    @Scheduled(cron = "0 0 1 * * ?")
    public void orderAutoConfirmJob() {
        jobService.executeOrderAutoConfirm();
    }

    /**
     * å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡
     * æ¯å¤©ä¸Šåˆ9ç‚¹æ‰§è¡?     */
    @Scheduled(cron = "0 0 9 * * ?")
    public void productStockWarningJob() {
        jobService.executeProductStockWarning();
    }

    /**
     * æ—¥å¿—æ¸…ç†ä»»åŠ¡
     * æ¯å‘¨æ—¥å‡Œæ™?ç‚¹æ‰§è¡?     */
    @Scheduled(cron = "0 0 3 ? * 1")
    public void logCleanupJob() {
        jobService.executeLogCleanup();
    }

    /**
     * æ•°æ®ç»Ÿè®¡ä»»åŠ¡
     * æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡?     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void dataStatisticsJob() {
        jobService.executeDataStatistics();
    }

}
package com.heikeji.job.scheduler;

import lombok.extern.slf4j.Slf4j;
import org.quartz.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Date;

/**
 * QuartzåŠ¨æ€ä»»åŠ¡è°ƒåº¦å™¨
 * æä¾›åŠ¨æ€æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å’ŒæŸ¥è¯¢ä»»åŠ¡çš„èƒ½åŠ? * 
 * @author heikeji
 */
@Component
@Slf4j
public class QuartzJobScheduler {

    @Autowired
    private Scheduler scheduler;

    /**
     * æ·»åŠ å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @param jobClass ä»»åŠ¡ç±?     * @param cronExpression  cronè¡¨è¾¾å¼?     * @param jobDataMap ä»»åŠ¡å‚æ•°
     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void addJob(String jobName, String jobGroup, String triggerName, String triggerGroup,
                      Class<? extends Job> jobClass, String cronExpression, JobDataMap jobDataMap)
            throws SchedulerException {
        // åˆ›å»ºJobDetail
        JobDetail jobDetail = JobBuilder.newJob(jobClass)
                .withIdentity(jobName, jobGroup)
                .setJobData(jobDataMap)
                .build();

        // åˆ›å»ºCronTrigger
        CronTrigger trigger = TriggerBuilder.newTrigger()
                .withIdentity(triggerName, triggerGroup)
                .withSchedule(CronScheduleBuilder.cronSchedule(cronExpression))
                .build();

        // è°ƒåº¦ä»»åŠ¡
        scheduler.scheduleJob(jobDetail, trigger);
        log.info("æ·»åŠ å®šæ—¶ä»»åŠ¡æˆåŠŸ: jobName={}, jobGroup={}, triggerName={}, triggerGroup={}",
                jobName, jobGroup, triggerName, triggerGroup);
    }

    /**
     * æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ— å‚æ•°ï¼?     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @param jobClass ä»»åŠ¡ç±?     * @param cronExpression cronè¡¨è¾¾å¼?     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void addJob(String jobName, String jobGroup, String triggerName, String triggerGroup,
                      Class<? extends Job> jobClass, String cronExpression)
            throws SchedulerException {
        addJob(jobName, jobGroup, triggerName, triggerGroup, jobClass, cronExpression, new JobDataMap());
    }

    /**
     * æ›´æ–°å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @param cronExpression cronè¡¨è¾¾å¼?     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void updateJob(String jobName, String jobGroup, String triggerName, String triggerGroup,
                         String cronExpression)
            throws SchedulerException {
        // è·å–è§¦å‘å™?        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);
        CronTrigger trigger = (CronTrigger) scheduler.getTrigger(triggerKey);

        if (trigger != null) {
            // æ›´æ–°è§¦å‘å™¨çš„cronè¡¨è¾¾å¼?            CronScheduleBuilder scheduleBuilder = CronScheduleBuilder.cronSchedule(cronExpression);
            trigger = trigger.getTriggerBuilder()
                    .withSchedule(scheduleBuilder)
                    .build();

            // é‡æ–°è°ƒåº¦ä»»åŠ¡
            scheduler.rescheduleJob(triggerKey, trigger);
            log.info("æ›´æ–°å®šæ—¶ä»»åŠ¡æˆåŠŸ: jobName={}, jobGroup={}, triggerName={}, triggerGroup={}",
                    jobName, jobGroup, triggerName, triggerGroup);
        }
    }

    /**
     * åˆ é™¤å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void deleteJob(String jobName, String jobGroup, String triggerName, String triggerGroup)
            throws SchedulerException {
        // åœæ­¢è§¦å‘å™?        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);
        scheduler.pauseTrigger(triggerKey);
        // åˆ é™¤è§¦å‘å™?        scheduler.unscheduleJob(triggerKey);
        // åˆ é™¤ä»»åŠ¡
        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);
        scheduler.deleteJob(jobKey);
        log.info("åˆ é™¤å®šæ—¶ä»»åŠ¡æˆåŠŸ: jobName={}, jobGroup={}", jobName, jobGroup);
    }

    /**
     * æš‚åœå®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void pauseJob(String jobName, String jobGroup) throws SchedulerException {
        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);
        scheduler.pauseJob(jobKey);
        log.info("æš‚åœå®šæ—¶ä»»åŠ¡æˆåŠŸ: jobName={}, jobGroup={}", jobName, jobGroup);
    }

    /**
     * æ¢å¤å®šæ—¶ä»»åŠ¡
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void resumeJob(String jobName, String jobGroup) throws SchedulerException {
        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);
        scheduler.resumeJob(jobKey);
        log.info("æ¢å¤å®šæ—¶ä»»åŠ¡æˆåŠŸ: jobName={}, jobGroup={}", jobName, jobGroup);
    }

    /**
     * ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆä¸å½±å“åŸè°ƒåº¦è®¡åˆ’ï¼‰
     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void triggerJob(String jobName, String jobGroup) throws SchedulerException {
        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);
        scheduler.triggerJob(jobKey);
        log.info("ç«‹å³æ‰§è¡Œå®šæ—¶ä»»åŠ¡æˆåŠŸ: jobName={}, jobGroup={}", jobName, jobGroup);
    }

    /**
     * æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å­˜åœ?     * 
     * @param jobName ä»»åŠ¡åç§°
     * @param jobGroup ä»»åŠ¡ç»?     * @return æ˜¯å¦å­˜åœ¨
     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public boolean checkJobExists(String jobName, String jobGroup) throws SchedulerException {
        JobKey jobKey = JobKey.jobKey(jobName, jobGroup);
        return scheduler.checkExists(jobKey);
    }

    /**
     * å¯åŠ¨è°ƒåº¦å™?     * 
     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void startScheduler() throws SchedulerException {
        if (!scheduler.isStarted()) {
            scheduler.start();
            log.info("Quartzè°ƒåº¦å™¨å¯åŠ¨æˆåŠ?);
        }
    }

    /**
     * å…³é—­è°ƒåº¦å™?     * 
     * @param waitForJobsToComplete æ˜¯å¦ç­‰å¾…ä»»åŠ¡å®Œæˆ
     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public void shutdownScheduler(boolean waitForJobsToComplete) throws SchedulerException {
        if (!scheduler.isShutdown()) {
            scheduler.shutdown(waitForJobsToComplete);
            log.info("Quartzè°ƒåº¦å™¨å…³é—­æˆåŠŸï¼Œç­‰å¾…ä»»åŠ¡å®Œæˆ: {}", waitForJobsToComplete);
        }
    }

    /**
     * è·å–ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
     * 
     * @param triggerName è§¦å‘å™¨åç§?     * @param triggerGroup è§¦å‘å™¨ç»„
     * @return ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
     * @throws SchedulerException è°ƒåº¦å™¨å¼‚å¸?     */
    public Date getNextFireTime(String triggerName, String triggerGroup) throws SchedulerException {
        TriggerKey triggerKey = TriggerKey.triggerKey(triggerName, triggerGroup);
        Trigger trigger = scheduler.getTrigger(triggerKey);
        if (trigger != null) {
            return trigger.getNextFireTime();
        }
        return null;
    }
}
package com.heikeji.job.scheduler.job;

import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.quartz.*;

import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * æ•°æ®ç»Ÿè®¡ä»»åŠ¡
 * æ‰§è¡Œç³»ç»Ÿæ•°æ®ç»Ÿè®¡ï¼Œç”Ÿæˆå„ç±»ç»Ÿè®¡æŠ¥è¡? * 
 * @author heikeji
 */
@DisallowConcurrentExecution
@Slf4j
public class DataStatisticsJob implements Job {

    /**
     * æ‰§è¡Œæ•°æ®ç»Ÿè®¡ä»»åŠ¡
     * 
     * @param context ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–?     * @throws JobExecutionException ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
     */
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        log.info("å¼€å§‹æ‰§è¡Œæ•°æ®ç»Ÿè®¡ä»»åŠ?);
        SchedulerContext schedulerContext;
        try {
            // ä»SchedulerContextè·å–JobService
            schedulerContext = context.getScheduler().getContext();
            JobService jobService = (JobService) schedulerContext.get("jobService");
            
            if (jobService == null) {
                throw new JobExecutionException("æ— æ³•è·å–JobServiceå®ä¾‹");
            }
            
            // æ‰§è¡Œæ•°æ®ç»Ÿè®¡ä¸šåŠ¡é€»è¾‘
            jobService.executeDataStatistics();
            log.info("æ•°æ®ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
        } catch (SchedulerException e) {
            log.error("è·å–JobServiceå¤±è´¥", e);
            throw new JobExecutionException("æ•°æ®ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } catch (Exception e) {
            log.error("æ•°æ®ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw new JobExecutionException("æ•°æ®ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }
}
package com.heikeji.job.scheduler.job;

import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.quartz.*;

/**
 * æ—¥å¿—æ¸…ç†ä»»åŠ¡
 * æ¸…ç†æŒ‡å®šå¤©æ•°å‰çš„ç³»ç»Ÿæ—¥å¿—ï¼Œä¼˜åŒ–æ•°æ®åº“æ€§èƒ½
 * 
 * @author heikeji
 */
@DisallowConcurrentExecution
@Slf4j
public class LogCleanupJob implements Job {

    /**
     * æ‰§è¡Œæ—¥å¿—æ¸…ç†ä»»åŠ¡
     * 
     * @param context ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–?     * @throws JobExecutionException ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
     */
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        log.info("å¼€å§‹æ‰§è¡Œæ—¥å¿—æ¸…ç†ä»»åŠ?);
        SchedulerContext schedulerContext;
        try {
            // ä»SchedulerContextè·å–JobService
            schedulerContext = context.getScheduler().getContext();
            JobService jobService = (JobService) schedulerContext.get("jobService");
            
            if (jobService == null) {
                throw new JobExecutionException("æ— æ³•è·å–JobServiceå®ä¾‹");
            }
            
            // æ‰§è¡Œæ—¥å¿—æ¸…ç†ä¸šåŠ¡é€»è¾‘
            jobService.executeLogCleanup();
            log.info("æ—¥å¿—æ¸…ç†ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
        } catch (SchedulerException e) {
            log.error("è·å–JobServiceå¤±è´¥", e);
            throw new JobExecutionException("æ—¥å¿—æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } catch (Exception e) {
            log.error("æ—¥å¿—æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw new JobExecutionException("æ—¥å¿—æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }
}
package com.heikeji.job.scheduler.job;

import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.quartz.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import jakarta.annotation.PostConstruct;
import jakarta.annotation.PreDestroy;
import java.util.concurrent.atomic.AtomicBoolean;

/**
 * è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
 * å¤„ç†è¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•ï¼Œè‡ªåŠ¨å°†å…¶å–æ¶? * 
 * @author heikeji
 */
@DisallowConcurrentExecution
@Slf4j
public class OrderAutoCancelJob implements Job {

    /**
     * æ‰§è¡Œè®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
     * 
     * @param context ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–?     * @throws JobExecutionException ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
     */
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        log.info("å¼€å§‹æ‰§è¡Œè®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ?);
        SchedulerContext schedulerContext;
        try {
            // ä»SchedulerContextè·å–JobService
            schedulerContext = context.getScheduler().getContext();
            JobService jobService = (JobService) schedulerContext.get("jobService");
            
            if (jobService == null) {
                throw new JobExecutionException("æ— æ³•è·å–JobServiceå®ä¾‹");
            }
            
            // æ‰§è¡Œè®¢å•è‡ªåŠ¨å–æ¶ˆä¸šåŠ¡é€»è¾‘
            jobService.executeOrderAutoCancel();
            log.info("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå®Œæˆ");
        } catch (SchedulerException e) {
            log.error("è·å–JobServiceå¤±è´¥", e);
            throw new JobExecutionException("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } catch (Exception e) {
            log.error("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw new JobExecutionException("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }
}
package com.heikeji.job.scheduler.job;

import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.quartz.*;

/**
 * è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡
 * å¤„ç†è¶…æ—¶æœªç¡®è®¤æ”¶è´§çš„è®¢å•ï¼Œè‡ªåŠ¨å°†å…¶æ ‡è®°ä¸ºå·²æ”¶è´? * 
 * @author heikeji
 */
@DisallowConcurrentExecution
@Slf4j
public class OrderAutoConfirmJob implements Job {

    /**
     * æ‰§è¡Œè®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡
     * 
     * @param context ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–?     * @throws JobExecutionException ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
     */
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        log.info("å¼€å§‹æ‰§è¡Œè®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ?);
        SchedulerContext schedulerContext;
        try {
            // ä»SchedulerContextè·å–JobService
            schedulerContext = context.getScheduler().getContext();
            JobService jobService = (JobService) schedulerContext.get("jobService");
            
            if (jobService == null) {
                throw new JobExecutionException("æ— æ³•è·å–JobServiceå®ä¾‹");
            }
            
            // æ‰§è¡Œè®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä¸šåŠ¡é€»è¾‘
            jobService.executeOrderAutoConfirm();
            log.info("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
        } catch (SchedulerException e) {
            log.error("è·å–JobServiceå¤±è´¥", e);
            throw new JobExecutionException("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } catch (Exception e) {
            log.error("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw new JobExecutionException("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }
}
package com.heikeji.job.scheduler.job;

import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.quartz.*;

/**
 * å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡
 * æ£€æŸ¥åº“å­˜ä½äºé˜ˆå€¼çš„å•†å“ï¼Œå¹¶è¿›è¡Œé¢„è­¦å¤„ç†
 * 
 * @author heikeji
 */
@DisallowConcurrentExecution
@Slf4j
public class ProductStockWarningJob implements Job {

    /**
     * æ‰§è¡Œå•†å“åº“å­˜é¢„è­¦ä»»åŠ¡
     * 
     * @param context ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–?     * @throws JobExecutionException ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸
     */
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        log.info("å¼€å§‹æ‰§è¡Œå•†å“åº“å­˜é¢„è­¦ä»»åŠ?);
        SchedulerContext schedulerContext;
        try {
            // ä»SchedulerContextè·å–JobService
            schedulerContext = context.getScheduler().getContext();
            JobService jobService = (JobService) schedulerContext.get("jobService");
            
            if (jobService == null) {
                throw new JobExecutionException("æ— æ³•è·å–JobServiceå®ä¾‹");
            }
            
            // æ‰§è¡Œå•†å“åº“å­˜é¢„è­¦ä¸šåŠ¡é€»è¾‘
            jobService.executeProductStockWarning();
            log.info("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
        } catch (SchedulerException e) {
            log.error("è·å–JobServiceå¤±è´¥", e);
            throw new JobExecutionException("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } catch (Exception e) {
            log.error("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw new JobExecutionException("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        }
    }
}
package com.heikeji.job.service;

import com.heikeji.job.entity.JobLog;

import java.util.List;
import java.util.Map;

/**
 * ä»»åŠ¡æ—¥å¿—æœåŠ¡æ¥å£
 * æä¾›ä»»åŠ¡æ‰§è¡Œæ—¥å¿—çš„è®°å½•å’ŒæŸ¥è¯¢åŠŸèƒ½
 * 
 * @author heikeji
 */
public interface JobLogService {

    /**
     * è®°å½•ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
     * 
     * @param jobLog ä»»åŠ¡æ—¥å¿—
     * @return å½±å“è¡Œæ•°
     */
    int saveJobLog(JobLog jobLog);

    /**
     * æ ¹æ®IDæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—
     * 
     * @param id æ—¥å¿—ID
     * @return ä»»åŠ¡æ—¥å¿—
     */
    JobLog getJobLogById(Long id);

    /**
     * æŸ¥è¯¢ä»»åŠ¡æ—¥å¿—åˆ—è¡¨
     * 
     * @param params æŸ¥è¯¢å‚æ•°
     * @return ä»»åŠ¡æ—¥å¿—åˆ—è¡¨
     */
    List<JobLog> listJobLogs(Map<String, Object> params);

    /**
     * åˆ†é¡µæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—
     * 
     * @param params æŸ¥è¯¢å‚æ•°
     * @param pageNum é¡µç 
     * @param pageSize æ¯é¡µæ•°é‡
     * @return åˆ†é¡µç»“æœ
     */
    Map<String, Object> pageJobLogs(Map<String, Object> params, int pageNum, int pageSize);

    /**
     * åˆ é™¤ä»»åŠ¡æ—¥å¿—
     * 
     * @param ids æ—¥å¿—IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int deleteJobLogs(List<Long> ids);

    /**
     * æ¸…ç†è¿‡æœŸçš„ä»»åŠ¡æ—¥å¿?     * 
     * @param days ä¿ç•™å¤©æ•°
     * @return æ¸…ç†æ•°é‡
     */
    int cleanJobLogs(int days);

    /**
     * è·å–ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
     * 
     * @return ç»Ÿè®¡ä¿¡æ¯
     */
    Map<String, Object> getJobLogStatistics();
}
package com.heikeji.job.service;

/**
 * å®šæ—¶ä»»åŠ¡æœåŠ¡æ¥å£
 * 
 * @author heikeji
 */
public interface JobService {

    /**
     * æ‰§è¡Œè®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
     */
    void executeOrderAutoCancel();

    /**
     * æ‰§è¡Œè®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡
     */
    void executeOrderAutoConfirm();

    /**
     * æ‰§è¡Œå•†å“åº“å­˜é¢„è­¦ä»»åŠ¡
     */
    void executeProductStockWarning();

    /**
     * æ‰§è¡Œæ—¥å¿—æ¸…ç†ä»»åŠ¡
     */
    void executeLogCleanup();

    /**
     * æ‰§è¡Œæ•°æ®ç»Ÿè®¡ä»»åŠ¡
     */
    void executeDataStatistics();

}
package com.heikeji.job.service.impl;

import com.heikeji.job.entity.JobLog;
import com.heikeji.job.service.JobLogService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

/**
 * ä»»åŠ¡æ—¥å¿—æœåŠ¡å®ç°ç±? * ä½¿ç”¨Redisä½œä¸ºä¸´æ—¶å­˜å‚¨ï¼Œè®°å½•ä»»åŠ¡æ‰§è¡Œæƒ…å†? * 
 * @author heikeji
 */
@Service
@Slf4j
public class JobLogServiceImpl implements JobLogService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    /**
     * Redisä¸­ä»»åŠ¡æ—¥å¿—çš„é”®å‰ç¼€
     */
    private static final String JOB_LOG_KEY_PREFIX = "job:log:";

    /**
     * ä»»åŠ¡æ—¥å¿—åˆ—è¡¨çš„é”®
     */
    private static final String JOB_LOG_LIST_KEY = "job:log:list";

    /**
     * ä»»åŠ¡æ—¥å¿—çš„è¿‡æœŸæ—¶é—´ï¼ˆå°æ—¶ï¼?     */
    private static final int JOB_LOG_EXPIRE_HOURS = 72;

    /**
     * è®°å½•ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
     * 
     * @param jobLog ä»»åŠ¡æ—¥å¿—
     * @return å½±å“è¡Œæ•°
     */
    @Override
    public int saveJobLog(JobLog jobLog) {
        try {
            // ç”Ÿæˆå”¯ä¸€ID
            Long id = redisTemplate.opsForValue().increment("job:log:id");
            jobLog.setId(id);
            
            // è®¾ç½®åˆ›å»ºæ—¶é—´
            if (jobLog.getCreateTime() == null) {
                jobLog.setCreateTime(new Date());
            }
            
            // è®¡ç®—æ‰§è¡Œæ—¶é—´
            if (jobLog.getStartTime() != null && jobLog.getEndTime() != null) {
                jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            }
            
            // ä¿å­˜æ—¥å¿—è¯¦æƒ…
            String logKey = JOB_LOG_KEY_PREFIX + id;
            redisTemplate.opsForValue().set(logKey, jobLog, JOB_LOG_EXPIRE_HOURS, TimeUnit.HOURS);
            
            // å°†æ—¥å¿—IDæ·»åŠ åˆ°åˆ—è¡¨ä¸­
            redisTemplate.opsForList().leftPush(JOB_LOG_LIST_KEY, id);
            
            // è®¾ç½®åˆ—è¡¨è¿‡æœŸæ—¶é—´
            redisTemplate.expire(JOB_LOG_LIST_KEY, JOB_LOG_EXPIRE_HOURS, TimeUnit.HOURS);
            
            log.info("ä¿å­˜ä»»åŠ¡æ—¥å¿—æˆåŠŸï¼Œä»»åŠ¡åç§? {}, æ‰§è¡ŒçŠ¶æ€? {}", 
                    jobLog.getJobName(), jobLog.getStatus() == 0 ? "æˆåŠŸ" : "å¤±è´¥");
            return 1;
        } catch (Exception e) {
            log.error("ä¿å­˜ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            // å¤±è´¥æ—¶è®°å½•åˆ°æœ¬åœ°æ—¥å¿—
            log.error("ä»»åŠ¡æ—¥å¿—è¯¦æƒ…: jobName={}, jobGroup={}, status={}, errorMsg={}",
                    jobLog.getJobName(), jobLog.getJobGroup(), jobLog.getStatus(), jobLog.getErrorMsg());
            return 0;
        }
    }

    /**
     * æ ¹æ®IDæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—
     * 
     * @param id æ—¥å¿—ID
     * @return ä»»åŠ¡æ—¥å¿—
     */
    @Override
    public JobLog getJobLogById(Long id) {
        try {
            String logKey = JOB_LOG_KEY_PREFIX + id;
            return (JobLog) redisTemplate.opsForValue().get(logKey);
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ä»»åŠ¡æ—¥å¿—å¤±è´¥ï¼ŒID: {}", id, e);
            return null;
        }
    }

    /**
     * æŸ¥è¯¢ä»»åŠ¡æ—¥å¿—åˆ—è¡¨
     * 
     * @param params æŸ¥è¯¢å‚æ•°
     * @return ä»»åŠ¡æ—¥å¿—åˆ—è¡¨
     */
    @Override
    public List<JobLog> listJobLogs(Map<String, Object> params) {
        try {
            // è·å–æ‰€æœ‰æ—¥å¿—ID
            List<Long> logIds = redisTemplate.opsForList().range(JOB_LOG_LIST_KEY, 0, -1)
                    .stream()
                    .map(id -> Long.valueOf(id.toString()))
                    .collect(Collectors.toList());
            
            // æŸ¥è¯¢æ—¥å¿—è¯¦æƒ…
            List<JobLog> jobLogs = new ArrayList<>();
            for (Long id : logIds) {
                JobLog jobLog = getJobLogById(id);
                if (jobLog != null) {
                    // åº”ç”¨è¿‡æ»¤æ¡ä»¶
                    if (applyFilter(jobLog, params)) {
                        jobLogs.add(jobLog);
                    }
                }
            }
            
            // æ’åºï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼?            jobLogs.sort(Comparator.comparing(JobLog::getCreateTime).reversed());
            
            return jobLogs;
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ä»»åŠ¡æ—¥å¿—åˆ—è¡¨å¤±è´¥", e);
            return new ArrayList<>();
        }
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—
     * 
     * @param params æŸ¥è¯¢å‚æ•°
     * @param pageNum é¡µç 
     * @param pageSize æ¯é¡µæ•°é‡
     * @return åˆ†é¡µç»“æœ
     */
    @Override
    public Map<String, Object> pageJobLogs(Map<String, Object> params, int pageNum, int pageSize) {
        try {
            // æŸ¥è¯¢æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ—¥å¿—
            List<JobLog> allLogs = listJobLogs(params);
            
            // è®¡ç®—æ€»æ•°
            int total = allLogs.size();
            
            // è®¡ç®—åˆ†é¡µç´¢å¼•
            int start = (pageNum - 1) * pageSize;
            int end = Math.min(start + pageSize, total);
            
            // è·å–åˆ†é¡µæ•°æ®
            List<JobLog> pageLogs = new ArrayList<>();
            if (start < total) {
                pageLogs = allLogs.subList(start, end);
            }
            
            // æ„å»ºè¿”å›ç»“æœ
            Map<String, Object> result = new HashMap<>();
            result.put("total", total);
            result.put("pageNum", pageNum);
            result.put("pageSize", pageSize);
            result.put("list", pageLogs);
            
            return result;
        } catch (Exception e) {
            log.error("åˆ†é¡µæŸ¥è¯¢ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            Map<String, Object> result = new HashMap<>();
            result.put("total", 0);
            result.put("pageNum", pageNum);
            result.put("pageSize", pageSize);
            result.put("list", new ArrayList<>());
            return result;
        }
    }

    /**
     * åˆ é™¤ä»»åŠ¡æ—¥å¿—
     * 
     * @param ids æ—¥å¿—IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    @Override
    public int deleteJobLogs(List<Long> ids) {
        try {
            int count = 0;
            for (Long id : ids) {
                String logKey = JOB_LOG_KEY_PREFIX + id;
                if (redisTemplate.delete(logKey)) {
                    count++;
                }
                // ä»åˆ—è¡¨ä¸­ç§»é™¤
                redisTemplate.opsForList().remove(JOB_LOG_LIST_KEY, 0, id);
            }
            log.info("åˆ é™¤ä»»åŠ¡æ—¥å¿—æˆåŠŸï¼Œæ•°é‡? {}", count);
            return count;
        } catch (Exception e) {
            log.error("åˆ é™¤ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            return 0;
        }
    }

    /**
     * æ¸…ç†è¿‡æœŸçš„ä»»åŠ¡æ—¥å¿?     * 
     * @param days ä¿ç•™å¤©æ•°
     * @return æ¸…ç†æ•°é‡
     */
    @Override
    public int cleanJobLogs(int days) {
        try {
            // è®¡ç®—æ¸…ç†æ—¶é—´ç‚?            long cleanTime = System.currentTimeMillis() - (long) days * 24 * 60 * 60 * 1000;
            
            // è·å–æ‰€æœ‰æ—¥å¿—ID
            List<Long> logIds = redisTemplate.opsForList().range(JOB_LOG_LIST_KEY, 0, -1)
                    .stream()
                    .map(id -> Long.valueOf(id.toString()))
                    .collect(Collectors.toList());
            
            // æ¸…ç†è¿‡æœŸæ—¥å¿—
            int cleanCount = 0;
            for (Long id : logIds) {
                JobLog jobLog = getJobLogById(id);
                if (jobLog != null && jobLog.getCreateTime().getTime() < cleanTime) {
                    String logKey = JOB_LOG_KEY_PREFIX + id;
                    if (redisTemplate.delete(logKey)) {
                        cleanCount++;
                    }
                    // ä»åˆ—è¡¨ä¸­ç§»é™¤
                    redisTemplate.opsForList().remove(JOB_LOG_LIST_KEY, 0, id);
                }
            }
            
            log.info("æ¸…ç†è¿‡æœŸä»»åŠ¡æ—¥å¿—æˆåŠŸï¼Œæ•°é‡? {}", cleanCount);
            return cleanCount;
        } catch (Exception e) {
            log.error("æ¸…ç†è¿‡æœŸä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            return 0;
        }
    }

    /**
     * è·å–ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯
     * 
     * @return ç»Ÿè®¡ä¿¡æ¯
     */
    @Override
    public Map<String, Object> getJobLogStatistics() {
        try {
            // æŸ¥è¯¢æœ€è¿‘çš„ä»»åŠ¡æ—¥å¿—
            List<JobLog> jobLogs = listJobLogs(Collections.emptyMap());
            
            // ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥çš„ä»»åŠ¡æ•?            long successCount = jobLogs.stream().filter(log -> log.getStatus() == 0).count();
            long failCount = jobLogs.stream().filter(log -> log.getStatus() == 1).count();
            
            // ç»Ÿè®¡å„ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µ
            Map<String, Long> jobCountMap = jobLogs.stream()
                    .collect(Collectors.groupingBy(
                            log -> log.getJobGroup() + ":" + log.getJobName(),
                            Collectors.counting()
                    ));
            
            // æ„å»ºç»Ÿè®¡ç»“æœ
            Map<String, Object> statistics = new HashMap<>();
            statistics.put("totalCount", jobLogs.size());
            statistics.put("successCount", successCount);
            statistics.put("failCount", failCount);
            statistics.put("jobCountMap", jobCountMap);
            
            return statistics;
        } catch (Exception e) {
            log.error("è·å–ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯å¤±è´¥", e);
            Map<String, Object> statistics = new HashMap<>();
            statistics.put("totalCount", 0);
            statistics.put("successCount", 0);
            statistics.put("failCount", 0);
            statistics.put("jobCountMap", new HashMap<>());
            return statistics;
        }
    }

    /**
     * åº”ç”¨è¿‡æ»¤æ¡ä»¶
     * 
     * @param jobLog ä»»åŠ¡æ—¥å¿—
     * @param params æŸ¥è¯¢å‚æ•°
     * @return æ˜¯å¦ç¬¦åˆæ¡ä»¶
     */
    private boolean applyFilter(JobLog jobLog, Map<String, Object> params) {
        // ä»»åŠ¡åç§°è¿‡æ»¤
        if (params.containsKey("jobName")) {
            String jobName = (String) params.get("jobName");
            if (!jobLog.getJobName().contains(jobName)) {
                return false;
            }
        }
        
        // ä»»åŠ¡ç»„è¿‡æ»?        if (params.containsKey("jobGroup")) {
            String jobGroup = (String) params.get("jobGroup");
            if (!jobLog.getJobGroup().equals(jobGroup)) {
                return false;
            }
        }
        
        // æ‰§è¡ŒçŠ¶æ€è¿‡æ»?        if (params.containsKey("status")) {
            Integer status = (Integer) params.get("status");
            if (!jobLog.getStatus().equals(status)) {
                return false;
            }
        }
        
        // æ—¶é—´èŒƒå›´è¿‡æ»¤
        if (params.containsKey("startTime")) {
            Date startTime = (Date) params.get("startTime");
            if (jobLog.getCreateTime().before(startTime)) {
                return false;
            }
        }
        
        if (params.containsKey("endTime")) {
            Date endTime = (Date) params.get("endTime");
            if (jobLog.getCreateTime().after(endTime)) {
                return false;
            }
        }
        
        return true;
    }
}
package com.heikeji.job.service.impl;

import com.heikeji.job.entity.JobLog;
import com.heikeji.job.feign.OrderFeignClient;
import com.heikeji.job.feign.ProductFeignClient;
import com.heikeji.job.feign.SystemFeignClient;
import com.heikeji.job.service.JobLogService;
import com.heikeji.job.service.JobService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * å®šæ—¶ä»»åŠ¡æœåŠ¡å®ç°ç±? * 
 * @author heikeji
 */
@Service
@Slf4j
public class JobServiceImpl implements JobService {

    @Value("${job.orderAutoCancel}")
    private Integer orderAutoCancelMinutes;

    @Value("${job.orderAutoConfirm}")
    private Integer orderAutoConfirmDays;

    @Value("${job.logCleanup}")
    private Integer logCleanupDays;

    // é»˜è®¤åº“å­˜é¢„è­¦é˜ˆå€?    private static final Integer DEFAULT_STOCK_WARNING_THRESHOLD = 10;

    @Autowired
    private OrderFeignClient orderFeignClient;

    @Autowired
    private ProductFeignClient productFeignClient;

    @Autowired
    private SystemFeignClient systemFeignClient;

    @Autowired
    private JobLogService jobLogService;

    /**
     * æ‰§è¡Œè®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡
     * å–æ¶ˆè¶…æ—¶æœªæ”¯ä»˜çš„è®¢å•
     */
    @Override
    public void executeOrderAutoCancel() {
        JobLog jobLog = new JobLog();
        jobLog.setJobName("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡");
        jobLog.setJobGroup("orderJobGroup");
        jobLog.setJobParams("{\"orderAutoCancelMinutes\": " + orderAutoCancelMinutes + "}");
        jobLog.setStartTime(new Date());
        jobLog.setStatus(0); // é»˜è®¤ä¸ºæˆåŠ?
        log.info("å¼€å§‹æ‰§è¡Œè®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡ï¼Œè¶…æ—¶æ—¶é—´: {}åˆ†é’Ÿ", orderAutoCancelMinutes);
        try {
            Integer result = orderFeignClient.cancelTimeoutOrders(orderAutoCancelMinutes);
            jobLog.setResult("æˆåŠŸå–æ¶ˆ" + result + "ä¸ªè¶…æ—¶è®¢å?);
            log.info("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå®Œæˆï¼ŒæˆåŠŸå–æ¶?{} ä¸ªè¶…æ—¶è®¢å?, result);
        } catch (Exception e) {
            jobLog.setStatus(1); // æ‰§è¡Œå¤±è´¥
            jobLog.setErrorMsg(e.getMessage());
            log.error("è®¢å•è‡ªåŠ¨å–æ¶ˆä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } finally {
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            try {
                jobLogService.saveJobLog(jobLog);
            } catch (Exception e) {
                log.error("ä¿å­˜ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            }
        }
    }

    /**
     * æ‰§è¡Œè®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡
     * è‡ªåŠ¨ç¡®è®¤è¶…æ—¶æœªæ”¶è´§çš„è®¢å•
     */
    @Override
    public void executeOrderAutoConfirm() {
        JobLog jobLog = new JobLog();
        jobLog.setJobName("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡");
        jobLog.setJobGroup("orderJobGroup");
        jobLog.setJobParams("{\"orderAutoConfirmDays\": " + orderAutoConfirmDays + "}");
        jobLog.setStartTime(new Date());
        jobLog.setStatus(0); // é»˜è®¤ä¸ºæˆåŠ?
        log.info("å¼€å§‹æ‰§è¡Œè®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡ï¼Œè¶…æ—¶æ—¶é—´: {}å¤?, orderAutoConfirmDays);
        try {
            Integer result = orderFeignClient.confirmTimeoutOrders(orderAutoConfirmDays);
            jobLog.setResult("æˆåŠŸç¡®è®¤æ”¶è´§" + result + "ä¸ªè¶…æ—¶è®¢å?);
            log.info("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼ŒæˆåŠŸç¡®è®¤æ”¶è´?{} ä¸ªè¶…æ—¶è®¢å?, result);
        } catch (Exception e) {
            jobLog.setStatus(1); // æ‰§è¡Œå¤±è´¥
            jobLog.setErrorMsg(e.getMessage());
            log.error("è®¢å•è‡ªåŠ¨ç¡®è®¤æ”¶è´§ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } finally {
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            try {
                jobLogService.saveJobLog(jobLog);
            } catch (Exception e) {
                log.error("ä¿å­˜ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            }
        }
    }

    /**
     * æ‰§è¡Œå•†å“åº“å­˜é¢„è­¦ä»»åŠ¡
     * æ£€æŸ¥åº“å­˜ä¸è¶³çš„å•†å“å¹¶å‘é€é¢„è­?     */
    @Override
    public void executeProductStockWarning() {
        JobLog jobLog = new JobLog();
        jobLog.setJobName("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡");
        jobLog.setJobGroup("productJobGroup");
        jobLog.setJobParams("{\"warningThreshold\": " + DEFAULT_STOCK_WARNING_THRESHOLD + "}");
        jobLog.setStartTime(new Date());
        jobLog.setStatus(0); // é»˜è®¤ä¸ºæˆåŠ?
        log.info("å¼€å§‹æ‰§è¡Œå•†å“åº“å­˜é¢„è­¦ä»»åŠ¡ï¼Œé¢„è­¦é˜ˆå€? {}", DEFAULT_STOCK_WARNING_THRESHOLD);
        try {
            Integer result = productFeignClient.checkStockWarning(DEFAULT_STOCK_WARNING_THRESHOLD);
            jobLog.setResult("å‘ç°" + result + "ä¸ªåº“å­˜ä¸è¶³å•†å“?);
            log.info("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå‘ç?{} ä¸ªåº“å­˜ä¸è¶³å•†å“?, result);
        } catch (Exception e) {
            jobLog.setStatus(1); // æ‰§è¡Œå¤±è´¥
            jobLog.setErrorMsg(e.getMessage());
            log.error("å•†å“åº“å­˜é¢„è­¦ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } finally {
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            try {
                jobLogService.saveJobLog(jobLog);
            } catch (Exception e) {
                log.error("ä¿å­˜ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            }
        }
    }

    /**
     * æ‰§è¡Œæ—¥å¿—æ¸…ç†ä»»åŠ¡
     * æ¸…ç†è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ—¥å¿?     */
    @Override
    public void executeLogCleanup() {
        JobLog jobLog = new JobLog();
        jobLog.setJobName("æ—¥å¿—æ¸…ç†ä»»åŠ¡");
        jobLog.setJobGroup("systemJobGroup");
        jobLog.setJobParams("{\"logCleanupDays\": " + logCleanupDays + "}");
        jobLog.setStartTime(new Date());
        jobLog.setStatus(0); // é»˜è®¤ä¸ºæˆåŠ?
        log.info("å¼€å§‹æ‰§è¡Œæ—¥å¿—æ¸…ç†ä»»åŠ¡ï¼Œæ¸…ç†{}å¤©å‰çš„æ—¥å¿?, logCleanupDays);
        try {
            Integer result = systemFeignClient.cleanSystemLogs(logCleanupDays);
            jobLog.setResult("æˆåŠŸæ¸…ç†" + result + "æ¡æ—¥å¿?);
            log.info("æ—¥å¿—æ¸…ç†ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼ŒæˆåŠŸæ¸…ç?{} æ¡æ—¥å¿?, result);
        } catch (Exception e) {
            jobLog.setStatus(1); // æ‰§è¡Œå¤±è´¥
            jobLog.setErrorMsg(e.getMessage());
            log.error("æ—¥å¿—æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } finally {
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            try {
                jobLogService.saveJobLog(jobLog);
            } catch (Exception e) {
                log.error("ä¿å­˜ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            }
        }
    }

    /**
     * æ‰§è¡Œæ•°æ®ç»Ÿè®¡ä»»åŠ¡
     * ç»Ÿè®¡è®¢å•ã€é”€å”®ç­‰æ•°æ®
     */
    @Override
    public void executeDataStatistics() {
        JobLog jobLog = new JobLog();
        jobLog.setJobName("æ•°æ®ç»Ÿè®¡ä»»åŠ¡");
        jobLog.setJobGroup("statisticsJobGroup");
        jobLog.setStartTime(new Date());
        jobLog.setStatus(0); // é»˜è®¤ä¸ºæˆåŠ?
        log.info("å¼€å§‹æ‰§è¡Œæ•°æ®ç»Ÿè®¡ä»»åŠ?);
        try {
            // è·å–å‰ä¸€å¤©çš„æ—¥æœŸ
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
            Date yesterday = new Date(System.currentTimeMillis() - 24 * 60 * 60 * 1000);
            String date = sdf.format(yesterday);
            
            jobLog.setJobParams("{\"date\": \"" + date + "\"}");
            
            Boolean result = systemFeignClient.executeStatistics(date);
            jobLog.setResult("æ•°æ®ç»Ÿè®¡æ‰§è¡Œ" + (result ? "æˆåŠŸ" : "å¤±è´¥"));
            log.info("æ•°æ®ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œç»Ÿè®¡æ—¥æœ? {}ï¼Œæ‰§è¡Œç»“æ? {}", date, result);
        } catch (Exception e) {
            jobLog.setStatus(1); // æ‰§è¡Œå¤±è´¥
            jobLog.setErrorMsg(e.getMessage());
            log.error("æ•°æ®ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        } finally {
            jobLog.setEndTime(new Date());
            jobLog.setExecuteTime(jobLog.getEndTime().getTime() - jobLog.getStartTime().getTime());
            try {
                jobLogService.saveJobLog(jobLog);
            } catch (Exception e) {
                log.error("ä¿å­˜ä»»åŠ¡æ—¥å¿—å¤±è´¥", e);
            }
        }
    }

}
package com.heikeji.mall.campus;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

/**
 * æ ¡åŒºæœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
@EnableDiscoveryClient
public class CampusApplication {

    public static void main(String[] args) {
        SpringApplication.run(CampusApplication.class, args);
    }

}
package com.heikeji.mall.campus.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis-Plusé…ç½®ç±? */
@Configuration
public class MyBatisPlusConfig {

    /**
     * é…ç½®åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
package com.heikeji.mall.campus.controller;

import com.heikeji.mall.campus.entity.Building;
import com.heikeji.mall.campus.service.BuildingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * æ¥¼æ ‹æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/building")
public class BuildingController {

    @Autowired
    private BuildingService buildingService;

    /**
     * è·å–æ‰€æœ‰æ¥¼æ ?     * @return æ¥¼æ ‹åˆ—è¡¨
     */
    @GetMapping("/list")
    public List<Building> getBuildingList() {
        return buildingService.getAllBuildings();
    }

    /**
     * æ ¹æ®æ ¡åŒºIDè·å–æ¥¼æ ‹
     * @param campusId æ ¡åŒºID
     * @return æ¥¼æ ‹åˆ—è¡¨
     */
    @GetMapping("/by-campus/{campusId}")
    public List<Building> getBuildingsByCampusId(@PathVariable Long campusId) {
        return buildingService.getBuildingsByCampusId(campusId);
    }

    /**
     * è·å–å¯ç”¨çš„æ¥¼æ ?     * @return å¯ç”¨çš„æ¥¼æ ‹åˆ—è¡?     */
    @GetMapping("/enabled")
    public List<Building> getEnabledBuildings() {
        return buildingService.getEnabledBuildings();
    }

    /**
     * æ ¹æ®IDè·å–æ¥¼æ ‹
     * @param id æ¥¼æ ‹ID
     * @return æ¥¼æ ‹ä¿¡æ¯
     */
    @GetMapping("/{id}")
    public Building getBuildingById(@PathVariable Long id) {
        return buildingService.getBuildingById(id);
    }

    /**
     * æ ¹æ®ç¼–ç è·å–æ¥¼æ ‹
     * @param code æ¥¼æ ‹ç¼–ç 
     * @return æ¥¼æ ‹ä¿¡æ¯
     */
    @GetMapping("/code/{code}")
    public Building getBuildingByCode(@PathVariable String code) {
        return buildingService.getBuildingByCode(code);
    }

    /**
     * æ–°å¢æ¥¼æ ‹
     * @param building æ¥¼æ ‹ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping
    public boolean addBuilding(@RequestBody Building building) {
        return buildingService.addBuilding(building);
    }

    /**
     * æ›´æ–°æ¥¼æ ‹
     * @param building æ¥¼æ ‹ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PutMapping
    public boolean updateBuilding(@RequestBody Building building) {
        return buildingService.updateBuilding(building);
    }

    /**
     * æ›´æ–°æ¥¼æ ‹çŠ¶æ€?     * @param id æ¥¼æ ‹ID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    @PutMapping("/{id}/status")
    public boolean updateBuildingStatus(@PathVariable Long id, @RequestParam Byte status) {
        return buildingService.updateBuildingStatus(id, status);
    }
}
package com.heikeji.mall.campus.controller;

import com.heikeji.mall.campus.entity.Campus;
import com.heikeji.mall.campus.service.CampusService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * æ ¡åŒºæ§åˆ¶å™? */
@RestController
@RequestMapping("/api/campus")
public class CampusController {

    @Autowired
    private CampusService campusService;

    /**
     * è·å–æ‰€æœ‰æ ¡åŒ?     * @return æ ¡åŒºåˆ—è¡¨
     */
    @GetMapping("/list")
    public List<Campus> getCampusList() {
        return campusService.getAllCampuses();
    }

    /**
     * è·å–å¯ç”¨çš„æ ¡åŒ?     * @return å¯ç”¨çš„æ ¡åŒºåˆ—è¡?     */
    @GetMapping("/enabled")
    public List<Campus> getEnabledCampuses() {
        return campusService.getEnabledCampuses();
    }

    /**
     * æ ¹æ®IDè·å–æ ¡åŒº
     * @param id æ ¡åŒºID
     * @return æ ¡åŒºä¿¡æ¯
     */
    @GetMapping("/{id}")
    public Campus getCampusById(@PathVariable Long id) {
        return campusService.getCampusById(id);
    }

    /**
     * æ ¹æ®ç¼–ç è·å–æ ¡åŒº
     * @param code æ ¡åŒºç¼–ç 
     * @return æ ¡åŒºä¿¡æ¯
     */
    @GetMapping("/code/{code}")
    public Campus getCampusByCode(@PathVariable String code) {
        return campusService.getCampusByCode(code);
    }

    /**
     * æ–°å¢æ ¡åŒº
     * @param campus æ ¡åŒºä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PostMapping
    public boolean addCampus(@RequestBody Campus campus) {
        return campusService.addCampus(campus);
    }

    /**
     * æ›´æ–°æ ¡åŒº
     * @param campus æ ¡åŒºä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    @PutMapping
    public boolean updateCampus(@RequestBody Campus campus) {
        return campusService.updateCampus(campus);
    }

    /**
     * æ›´æ–°æ ¡åŒºçŠ¶æ€?     * @param id æ ¡åŒºID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    @PutMapping("/{id}/status")
    public boolean updateCampusStatus(@PathVariable Long id, @RequestParam Byte status) {
        return campusService.updateCampusStatus(id, status);
    }
}
package com.heikeji.mall.campus.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * æ¥¼æ ‹è¡? */
@Data
@TableName("building")
public class Building implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * æ¥¼æ ‹ID
     */
    @TableId
    private Long id;

    /**
     * æ ¡åŒºID
     */
    private Long campusId;

    /**
     * æ¥¼æ ‹åç§°
     */
    private String buildingName;

    /**
     * æ¥¼æ ‹ç¼–ç 
     */
    private String buildingCode;

    /**
     * æ¥¼æ ‹ç±»å‹ï¼?-å­¦ç”Ÿå…¬å¯“ï¼?-æ•™å­¦æ¥¼ï¼Œ3-åŠå…¬æ¥¼ï¼Œ4-å…¶ä»–
     */
    private Byte buildingType;

    /**
     * æ’åº
     */
    private Integer sort;

    /**
     * çŠ¶æ€ï¼š0-æ­£å¸¸ï¼?-ç¦ç”¨
     */
    private Byte status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date updateTime;
}
package com.heikeji.mall.campus.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * æ ¡åŒºè¡? */
@Data
@TableName("campus")
public class Campus implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * æ ¡åŒºID
     */
    @TableId
    private Long id;

    /**
     * æ ¡åŒºåç§°
     */
    private String campusName;

    /**
     * æ ¡åŒºç¼–ç 
     */
    private String campusCode;

    /**
     * æ ¡åŒºåœ°å€
     */
    private String address;

    /**
     * æ’åº
     */
    private Integer sort;

    /**
     * çŠ¶æ€ï¼š0-æ­£å¸¸ï¼?-ç¦ç”¨
     */
    private Byte status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date updateTime;
}
package com.heikeji.mall.campus.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.campus.entity.Building;
import java.util.List;

/**
 * æ¥¼æ ‹Mapper
 */
public interface BuildingMapper extends BaseMapper<Building> {

    /**
     * æ ¹æ®æ ¡åŒºIDæŸ¥è¯¢æ¥¼æ ‹åˆ—è¡¨
     * @param campusId æ ¡åŒºID
     * @return æ¥¼æ ‹åˆ—è¡¨
     */
    List<Building> selectByCampusId(Long campusId);

    /**
     * æŸ¥è¯¢å¯ç”¨çš„æ¥¼æ ‹åˆ—è¡?     * @return æ¥¼æ ‹åˆ—è¡¨
     */
    List<Building> selectEnabledBuildings();

    /**
     * æ ¹æ®ç¼–ç æŸ¥è¯¢æ¥¼æ ‹
     * @param buildingCode æ¥¼æ ‹ç¼–ç 
     * @return æ¥¼æ ‹ä¿¡æ¯
     */
    Building selectByBuildingCode(String buildingCode);
}
package com.heikeji.mall.campus.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.campus.entity.Campus;
import java.util.List;

/**
 * æ ¡åŒºMapper
 */
public interface CampusMapper extends BaseMapper<Campus> {

    /**
     * æŸ¥è¯¢å¯ç”¨çš„æ ¡åŒºåˆ—è¡?     * @return æ ¡åŒºåˆ—è¡¨
     */
    List<Campus> selectEnabledCampuses();

    /**
     * æ ¹æ®ç¼–ç æŸ¥è¯¢æ ¡åŒº
     * @param campusCode æ ¡åŒºç¼–ç 
     * @return æ ¡åŒºä¿¡æ¯
     */
    Campus selectByCampusCode(String campusCode);
}
package com.heikeji.mall.campus.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.campus.entity.Building;
import java.util.List;

/**
 * æ¥¼æ ‹æœåŠ¡æ¥å£
 */
public interface BuildingService extends IService<Building> {

    /**
     * è·å–æ‰€æœ‰æ¥¼æ ‹åˆ—è¡?     * @return æ¥¼æ ‹åˆ—è¡¨
     */
    List<Building> getAllBuildings();

    /**
     * æ ¹æ®æ ¡åŒºIDè·å–æ¥¼æ ‹åˆ—è¡¨
     * @param campusId æ ¡åŒºID
     * @return æ¥¼æ ‹åˆ—è¡¨
     */
    List<Building> getBuildingsByCampusId(Long campusId);

    /**
     * è·å–å¯ç”¨çš„æ¥¼æ ‹åˆ—è¡?     * @return å¯ç”¨çš„æ¥¼æ ‹åˆ—è¡?     */
    List<Building> getEnabledBuildings();

    /**
     * æ ¹æ®IDè·å–æ¥¼æ ‹
     * @param id æ¥¼æ ‹ID
     * @return æ¥¼æ ‹ä¿¡æ¯
     */
    Building getBuildingById(Long id);

    /**
     * æ ¹æ®ç¼–ç è·å–æ¥¼æ ‹
     * @param buildingCode æ¥¼æ ‹ç¼–ç 
     * @return æ¥¼æ ‹ä¿¡æ¯
     */
    Building getBuildingByCode(String buildingCode);

    /**
     * æ–°å¢æ¥¼æ ‹
     * @param building æ¥¼æ ‹ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean addBuilding(Building building);

    /**
     * æ›´æ–°æ¥¼æ ‹
     * @param building æ¥¼æ ‹ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateBuilding(Building building);

    /**
     * æ›´æ–°æ¥¼æ ‹çŠ¶æ€?     * @param id æ¥¼æ ‹ID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateBuildingStatus(Long id, Byte status);
}
package com.heikeji.mall.campus.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.campus.entity.Campus;
import java.util.List;

/**
 * æ ¡åŒºæœåŠ¡æ¥å£
 */
public interface CampusService extends IService<Campus> {

    /**
     * è·å–æ‰€æœ‰æ ¡åŒºåˆ—è¡?     * @return æ ¡åŒºåˆ—è¡¨
     */
    List<Campus> getAllCampuses();

    /**
     * è·å–å¯ç”¨çš„æ ¡åŒºåˆ—è¡?     * @return å¯ç”¨çš„æ ¡åŒºåˆ—è¡?     */
    List<Campus> getEnabledCampuses();

    /**
     * æ ¹æ®IDè·å–æ ¡åŒº
     * @param id æ ¡åŒºID
     * @return æ ¡åŒºä¿¡æ¯
     */
    Campus getCampusById(Long id);

    /**
     * æ ¹æ®ç¼–ç è·å–æ ¡åŒº
     * @param campusCode æ ¡åŒºç¼–ç 
     * @return æ ¡åŒºä¿¡æ¯
     */
    Campus getCampusByCode(String campusCode);

    /**
     * æ–°å¢æ ¡åŒº
     * @param campus æ ¡åŒºä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean addCampus(Campus campus);

    /**
     * æ›´æ–°æ ¡åŒº
     * @param campus æ ¡åŒºä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateCampus(Campus campus);

    /**
     * æ›´æ–°æ ¡åŒºçŠ¶æ€?     * @param id æ ¡åŒºID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateCampusStatus(Long id, Byte status);
}
package com.heikeji.mall.campus.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.campus.entity.Building;
import com.heikeji.mall.campus.mapper.BuildingMapper;
import com.heikeji.mall.campus.service.BuildingService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;

/**
 * æ¥¼æ ‹æœåŠ¡å®ç°ç±? */
@Service
public class BuildingServiceImpl extends ServiceImpl<BuildingMapper, Building> implements BuildingService {

    @Autowired
    private BuildingMapper buildingMapper;

    @Override
    public List<Building> getAllBuildings() {
        return list();
    }

    @Override
    public List<Building> getBuildingsByCampusId(Long campusId) {
        return buildingMapper.selectByCampusId(campusId);
    }

    @Override
    public List<Building> getEnabledBuildings() {
        return buildingMapper.selectEnabledBuildings();
    }

    @Override
    public Building getBuildingById(Long id) {
        return getById(id);
    }

    @Override
    public Building getBuildingByCode(String buildingCode) {
        return buildingMapper.selectByBuildingCode(buildingCode);
    }

    @Transactional
    @Override
    public boolean addBuilding(Building building) {
        building.setCreateTime(new Date());
        building.setUpdateTime(new Date());
        return save(building);
    }

    @Transactional
    @Override
    public boolean updateBuilding(Building building) {
        building.setUpdateTime(new Date());
        return updateById(building);
    }

    @Transactional
    @Override
    public boolean updateBuildingStatus(Long id, Byte status) {
        Building building = new Building();
        building.setId(id);
        building.setStatus(status);
        building.setUpdateTime(new Date());
        return updateById(building);
    }
}
package com.heikeji.mall.campus.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.campus.entity.Campus;
import com.heikeji.mall.campus.mapper.CampusMapper;
import com.heikeji.mall.campus.service.CampusService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;

/**
 * æ ¡åŒºæœåŠ¡å®ç°ç±? */
@Service
public class CampusServiceImpl extends ServiceImpl<CampusMapper, Campus> implements CampusService {

    @Autowired
    private CampusMapper campusMapper;

    @Override
    public List<Campus> getAllCampuses() {
        return list();
    }

    @Override
    public List<Campus> getEnabledCampuses() {
        return campusMapper.selectEnabledCampuses();
    }

    @Override
    public Campus getCampusById(Long id) {
        return getById(id);
    }

    @Override
    public Campus getCampusByCode(String campusCode) {
        return campusMapper.selectByCampusCode(campusCode);
    }

    @Transactional
    @Override
    public boolean addCampus(Campus campus) {
        campus.setCreateTime(new Date());
        campus.setUpdateTime(new Date());
        return save(campus);
    }

    @Transactional
    @Override
    public boolean updateCampus(Campus campus) {
        campus.setUpdateTime(new Date());
        return updateById(campus);
    }

    @Transactional
    @Override
    public boolean updateCampusStatus(Long id, Byte status) {
        Campus campus = new Campus();
        campus.setId(id);
        campus.setStatus(status);
        campus.setUpdateTime(new Date());
        return updateById(campus);
    }
}
package com.heikeji.mall.delivery;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * è·‘è…¿æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication(scanBasePackages = {"com.heikeji.mall.delivery", "com.heikeji.common"})
public class DeliveryApplication {

    public static void main(String[] args) {
        SpringApplication.run(DeliveryApplication.class, args);
    }

}
package com.heikeji.mall.delivery.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis Plusé…ç½®
 */
@Configuration
public class MyBatisPlusConfig {

    /**
     * åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }

}
package com.heikeji.mall.delivery.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.delivery.domain.vo.DeliveryOrderVO;
import com.heikeji.mall.delivery.dto.DeliveryOrderDTO;
import com.heikeji.mall.delivery.service.DeliveryOrderService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.ArrayList;

/**
 * è·‘è…¿è®¢å•æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/delivery/order")
@Api(tags = "è·‘è…¿è®¢å•ç®¡ç†")
public class DeliveryOrderController {

    @Autowired
    private DeliveryOrderService deliveryOrderService;

    /**
     * åˆ›å»ºè·‘è…¿è®¢å•
     */
    @PostMapping
    @ApiOperation("åˆ›å»ºè·‘è…¿è®¢å•")
    public R<String> createOrder(@RequestBody DeliveryOrderDTO dto) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        String orderNo = deliveryOrderService.createOrder(userId, dto);
        return R.success(orderNo);
    }

    /**
     * è®¢å•æ”¯ä»˜
     */
    @PostMapping("/pay/{orderNo}")
    @ApiOperation("è®¢å•æ”¯ä»˜")
    public R<Boolean> payOrder(@PathVariable String orderNo, @RequestParam Integer payType) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        boolean result = deliveryOrderService.payOrder(orderNo, payType, userId);
        return R.success(result);
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/cancel/{orderNo}")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Boolean> cancelOrder(@PathVariable String orderNo) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        boolean result = deliveryOrderService.cancelOrder(orderNo, userId);
        return R.success(result);
    }

    /**
     * æ¥å•
     */
    @PostMapping("/accept/{orderNo}")
    @ApiOperation("æ¥å•")
    public R<Boolean> acceptOrder(@PathVariable String orderNo) {
        Long deliveryUserId = 1L; // ç®€åŒ–å¤„ç?        boolean result = deliveryOrderService.acceptOrder(orderNo, deliveryUserId);
        return R.success(result);
    }

    /**
     * å¼€å§‹é…é€?     */
    @PostMapping("/start/{orderNo}")
    @ApiOperation("å¼€å§‹é…é€?)
    public R<Boolean> startDelivery(@PathVariable String orderNo) {
        Long deliveryUserId = 1L; // ç®€åŒ–å¤„ç?        boolean result = deliveryOrderService.startDelivery(orderNo, deliveryUserId);
        return R.success(result);
    }

    /**
     * å®Œæˆé…é€?     */
    @PostMapping("/complete/{orderNo}")
    @ApiOperation("å®Œæˆé…é€?)
    public R<Boolean> completeOrder(@PathVariable String orderNo) {
        Long deliveryUserId = 1L; // ç®€åŒ–å¤„ç?        boolean result = deliveryOrderService.completeOrder(orderNo, deliveryUserId);
        return R.success(result);
    }

    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/user/list")
    @ApiOperation("è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨")
    public R<?> getUserOrderList(@RequestParam(required = false) Integer status) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        List<DeliveryOrderVO> orderList = deliveryOrderService.getUserOrderList(userId, status);
        return R.success(orderList);
    }

    /**
     * è·å–è·‘è…¿å‘˜è®¢å•åˆ—è¡?     */
    @GetMapping("/delivery/list")
    @ApiOperation("è·å–è·‘è…¿å‘˜è®¢å•åˆ—è¡?)
    public R<?> getDeliveryOrderList(@RequestParam(required = false) Integer status) {
        Long deliveryUserId = 1L; // ç®€åŒ–å¤„ç?        List<DeliveryOrderVO> orderList = deliveryOrderService.getDeliveryUserOrderList(deliveryUserId, status);
        return R.success(orderList);
    }

    /**
     * è·å–å¾…æ¥å•åˆ—è¡?     */
    @GetMapping("/pending/list")
    @ApiOperation("è·å–å¾…æ¥å•åˆ—è¡?)
    public R<?> getPendingOrders() {
        List<DeliveryOrderVO> orderList = deliveryOrderService.getPendingOrders();
        return R.success(orderList);
    }

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/detail/{orderNo}")
    @ApiOperation("è·å–è®¢å•è¯¦æƒ…")
    public R<?> getOrderDetail(@PathVariable String orderNo) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        DeliveryOrderVO orderDetail = deliveryOrderService.getOrderDetail(orderNo, userId);
        return R.success(orderDetail);
    }

}
package com.heikeji.mall.delivery.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.delivery.entity.DeliveryUser;
import com.heikeji.mall.delivery.service.DeliveryUserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * é…é€ç”¨æˆ·æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/delivery/user")
@Api(tags = "é…é€å‘˜ç®¡ç†")
public class DeliveryUserController {

    @Autowired
    private DeliveryUserService deliveryUserService;

    /**
     * è·å–å½“å‰ç”¨æˆ·çš„é…é€å‘˜ä¿¡æ¯
     */
    @GetMapping("/info")
    @ApiOperation("è·å–å½“å‰ç”¨æˆ·çš„é…é€å‘˜ä¿¡æ¯")
    public R<?> getDeliveryUserInfo() {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        DeliveryUser deliveryUser = deliveryUserService.getByUserId(userId);
        return deliveryUser != null ? R.success(deliveryUser) : R.error("æœªç”³è¯·é…é€å‘˜");
    }

    /**
     * æ³¨å†Œé…é€å‘˜
     */
    @PostMapping("/register")
    @ApiOperation("æ³¨å†Œé…é€å‘˜")
    public R<?> registerDeliveryUser(@RequestBody DeliveryUser deliveryUser) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        deliveryUser.setUserId(userId);
        boolean result = deliveryUserService.registerDeliveryUser(deliveryUser);
        return result ? R.success(true) : R.error("æ³¨å†Œå¤±è´¥ï¼Œå¯èƒ½å·²ç»æ³¨å†Œè¿‡");
    }

    /**
     * æ›´æ–°é…é€å‘˜ä¿¡æ¯
     */
    @PutMapping("/info")
    @ApiOperation("æ›´æ–°é…é€å‘˜ä¿¡æ¯")
    public R<?> updateDeliveryUser(@RequestBody DeliveryUser deliveryUser) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        DeliveryUser existing = deliveryUserService.getByUserId(userId);
        if (existing == null) {
            return R.error("é…é€å‘˜ä¸å­˜åœ?);
        }
        deliveryUser.setId(existing.getId());
        deliveryUser.setUserId(userId);
        boolean result = deliveryUserService.updateDeliveryUser(deliveryUser);
        return R.success(result);
    }

    /**
     * éªŒè¯é…é€å‘˜èº«ä»½
     */
    @PostMapping("/verify")
    @ApiOperation("éªŒè¯é…é€å‘˜èº«ä»½")
    public R<?> verifyDeliveryUser(
            @RequestParam String realName,
            @RequestParam String idCard,
            @RequestParam String phone) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        boolean result = deliveryUserService.verifyDeliveryUser(userId, realName, idCard, phone);
        return result ? R.success(true) : R.error("èº«ä»½éªŒè¯å¤±è´¥");
    }

    /**
     * æ›´æ–°é…é€çŠ¶æ€ï¼ˆæ¥å•/ä¼‘æ¯ï¼?     */
    @PutMapping("/status")
    @ApiOperation("æ›´æ–°é…é€çŠ¶æ€?)
    public R<?> updateStatus(@RequestParam Integer status) {
        Long userId = 1L; // ç®€åŒ–å¤„ç?        DeliveryUser deliveryUser = deliveryUserService.getByUserId(userId);
        if (deliveryUser == null) {
            return R.error("é…é€å‘˜ä¸å­˜åœ?);
        }
        boolean result = deliveryUserService.updateStatus(deliveryUser.getId(), status);
        return R.success(result);
    }
}
package com.heikeji.mall.delivery.domain.vo;

import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;

/**
 * è·‘è…¿è®¢å•è§†å›¾å¯¹è±¡
 */
@Data
public class DeliveryOrderVO {

    /**
     * è®¢å•ç¼–å·
     */
    private String orderNo;

    /**
     * è®¢å•ç±»å‹
     */
    private Integer orderType;

    /**
     * è®¢å•ç±»å‹åç§°
     */
    private String orderTypeName;

    /**
     * èµ·å§‹åœ°ç‚¹
     */
    private String startLocation;

    /**
     * ç›®æ ‡åœ°ç‚¹
     */
    private String endLocation;

    /**
     * ç‰©å“æè¿°
     */
    private String itemDescription;

    /**
     * æœŸæœ›å®Œæˆæ—¶é—´
     */
    private Date expectedTime;

    /**
     * è®¢å•é‡‘é¢
     */
    private BigDecimal amount;

    /**
     * å°è´¹
     */
    private BigDecimal tip;

    /**
     * è®¢å•çŠ¶æ€?     */
    private Integer status;

    /**
     * è®¢å•çŠ¶æ€åç§?     */
    private String statusName;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * ä¸‹å•ç”¨æˆ·ä¿¡æ¯
     */
    private UserInfoVO userInfo;

    /**
     * è·‘è…¿å‘˜ä¿¡æ?     */
    private UserInfoVO deliveryUserInfo;

    /**
     * ç”¨æˆ·ä¿¡æ¯å†…éƒ¨ç±?     */
    @Data
    public static class UserInfoVO {
        private Long userId;
        private String nickname;
        private String avatar;
    }

}
package com.heikeji.mall.delivery.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;

/**
 * è·‘è…¿è®¢å•è¯·æ±‚DTO
 */
@Data
public class DeliveryOrderDTO {

    /**
     * è®¢å•ç±»å‹ï¼?-ä»£å–å¿«é€?2-ä»£ä¹°å•†å“ 3-å…¶ä»–
     */
    private Integer orderType;

    /**
     * èµ·å§‹åœ°ç‚¹
     */
    private String startLocation;

    /**
     * ç›®æ ‡åœ°ç‚¹
     */
    private String endLocation;

    /**
     * ç‰©å“æè¿°
     */
    private String itemDescription;

    /**
     * æœŸæœ›å®Œæˆæ—¶é—´
     */
    private Date expectedTime;

    /**
     * è®¢å•é‡‘é¢
     */
    private BigDecimal amount;

    /**
     * å°è´¹
     */
    private BigDecimal tip;

    /**
     * æ”¯ä»˜æ–¹å¼ï¼?-å¾®ä¿¡æ”¯ä»˜ 2-ä½™é¢æ”¯ä»˜
     */
    private Integer payType;

    /**
     * å¤‡æ³¨
     */
    private String remark;

}
package com.heikeji.mall.delivery.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * è·‘è…¿è®¢å•å®ä½“ç±? */
@Data
@TableName("delivery_order")
public class DeliveryOrder implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * è®¢å•ç¼–å·
     */
    private String orderNo;

    /**
     * ç”¨æˆ·IDï¼ˆä¸‹å•äººï¼?     */
    private Long userId;

    /**
     * è·‘è…¿å‘˜ID
     */
    private Long deliveryUserId;

    /**
     * è®¢å•ç±»å‹ï¼?-ä»£å–å¿«é€?2-ä»£ä¹°å•†å“ 3-å…¶ä»–
     */
    private Integer orderType;

    /**
     * èµ·å§‹åœ°ç‚¹
     */
    private String startLocation;

    /**
     * ç›®æ ‡åœ°ç‚¹
     */
    private String endLocation;

    /**
     * ç‰©å“æè¿°
     */
    private String itemDescription;

    /**
     * æœŸæœ›å®Œæˆæ—¶é—´
     */
    private Date expectedTime;

    /**
     * è®¢å•é‡‘é¢
     */
    private BigDecimal amount;

    /**
     * å°è´¹
     */
    private BigDecimal tip;

    /**
     * è®¢å•çŠ¶æ€ï¼š0-å¾…æ¥å?1-å·²æ¥å?2-é…é€ä¸­ 3-å·²å®Œæˆ?4-å·²å–æ¶?     */
    private Integer status;

    /**
     * æ”¯ä»˜çŠ¶æ€ï¼š0-æœªæ”¯ä»?1-å·²æ”¯ä»?     */
    private Integer payStatus;

    /**
     * æ”¯ä»˜æ–¹å¼ï¼?-å¾®ä¿¡æ”¯ä»˜ 2-ä½™é¢æ”¯ä»˜
     */
    private Integer payType;

    /**
     * å¤‡æ³¨
     */
    private String remark;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.delivery.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * è·‘è…¿å‘˜ä¿¡æ¯å®ä½“ç±»
 */
@Data
@TableName("delivery_user")
public class DeliveryUser implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * çœŸå®å§“å
     */
    private String realName;

    /**
     * èº«ä»½è¯å·
     */
    private String idCard;

    /**
     * çŠ¶æ€ï¼š0-å¾…å®¡æ ?1-å·²é€šè¿‡ 2-å·²æ‹’ç»?     */
    private Integer status;

    /**
     * æ‹’ç»åŸå› 
     */
    private String rejectReason;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.delivery.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.delivery.entity.DeliveryOrder;
import org.apache.ibatis.annotations.Param;

import java.util.Date;
import java.util.List;

/**
 * é…é€è®¢å•Mapperæ¥å£
 */
public interface DeliveryOrderMapper extends BaseMapper<DeliveryOrder> {

    /**
     * æ ¹æ®è®¢å•ç¼–å·æŸ¥è¯¢è®¢å•
     */
    DeliveryOrder selectByOrderNo(String orderNo);

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨
     */
    List<DeliveryOrder> selectByUserId(@Param("userId") Long userId, @Param("status") Integer status);

    /**
     * æŸ¥è¯¢å¾…æ¥å•çš„è®¢å•åˆ—è¡¨
     */
    List<DeliveryOrder> selectPendingOrders();

    /**
     * æ ¹æ®è·‘è…¿å‘˜IDæŸ¥è¯¢è®¢å•åˆ—è¡¨
     */
    List<DeliveryOrder> selectByDeliveryUserId(@Param("deliveryUserId") Long deliveryUserId, @Param("status") Integer status);
    
    /**
     * æ ¹æ®è®¢å•IDæŸ¥è¯¢é…é€è®¢å?     */
    DeliveryOrder getByOrderId(Long orderId);

    /**
     * æ ¹æ®é…é€å‘˜IDæŸ¥è¯¢é…é€è®¢å•åˆ—è¡?     */
    List<DeliveryOrder> getByDeliveryUserId(Long deliveryUserId);

    /**
     * æ›´æ–°é…é€è®¢å•çŠ¶æ€?     */
    int updateStatus(Long id, Integer status, Long deliveryUserId);

    /**
     * æ›´æ–°é…é€ä¿¡æ?     */
    int updateDeliveryInfo(Long id, Date deliveryTime, Date completeTime, Integer status);

    /**
     * æŸ¥è¯¢å¾…æ¥å•çš„é…é€è®¢å?     */
    List<DeliveryOrder> getPendingDeliveryOrders();
}
package com.heikeji.mall.delivery.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.delivery.entity.DeliveryUser;
import org.apache.ibatis.annotations.Mapper;

/**
 * é…é€ç”¨æˆ·Mapper
 */
@Mapper
public interface DeliveryUserMapper extends BaseMapper<DeliveryUser> {

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢é…é€å‘˜ä¿¡æ¯
     */
    DeliveryUser getByUserId(Long userId);

    /**
     * æ›´æ–°é…é€å‘˜çŠ¶æ€?     */
    int updateStatus(Long id, Integer status);
}
package com.heikeji.mall.delivery.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.delivery.domain.vo.DeliveryOrderVO;
import com.heikeji.mall.delivery.dto.DeliveryOrderDTO;
import com.heikeji.mall.delivery.entity.DeliveryOrder;

import java.util.List;
import java.util.Map;

/**
 * è·‘è…¿è®¢å•æœåŠ¡æ¥å£
 */
public interface DeliveryOrderService extends IService<DeliveryOrder> {

    /**
     * åˆ›å»ºè·‘è…¿è®¢å•
     */
    String createOrder(Long userId, DeliveryOrderDTO dto);

    /**
     * æ ¹æ®è®¢å•ç¼–å·æŸ¥è¯¢è®¢å•
     */
    DeliveryOrder getByOrderNo(String orderNo);

    /**
     * æ ¹æ®è®¢å•ç¼–å·å’Œç”¨æˆ·IDæŸ¥è¯¢è®¢å•
     */
    DeliveryOrder getByOrderNoAndUserId(String orderNo, Long userId);

    /**
     * è®¢å•æ”¯ä»˜
     */
    boolean payOrder(String orderNo, Integer payType, Long userId);

    /**
     * å–æ¶ˆè®¢å•
     */
    boolean cancelOrder(String orderNo, Long userId);

    /**
     * æ¥å•
     */
    boolean acceptOrder(String orderNo, Long deliveryUserId);

    /**
     * å¼€å§‹é…é€?     */
    boolean startDelivery(String orderNo, Long deliveryUserId);

    /**
     * å®Œæˆé…é€?     */
    boolean completeOrder(String orderNo, Long deliveryUserId);

    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    List<DeliveryOrderVO> getUserOrderList(Long userId, Integer status);

    /**
     * è·å–è·‘è…¿å‘˜è®¢å•åˆ—è¡?     */
    List<DeliveryOrderVO> getDeliveryUserOrderList(Long deliveryUserId, Integer status);

    /**
     * è·å–å¾…æ¥å•åˆ—è¡?     */
    List<DeliveryOrderVO> getPendingOrders();

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    DeliveryOrderVO getOrderDetail(String orderNo, Long userId);

    /**
     * ç”Ÿæˆè®¢å•å?     */
    String generateOrderNo();

}
package com.heikeji.mall.delivery.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.delivery.entity.DeliveryUser;

/**
 * é…é€ç”¨æˆ·æœåŠ? */
public interface DeliveryUserService extends IService<DeliveryUser> {

    /**
     * æ ¹æ®ç”¨æˆ·IDè·å–é…é€å‘˜ä¿¡æ¯
     */
    DeliveryUser getByUserId(Long userId);

    /**
     * æ³¨å†Œé…é€å‘˜
     */
    boolean registerDeliveryUser(DeliveryUser deliveryUser);

    /**
     * æ›´æ–°é…é€å‘˜çŠ¶æ€?     */
    boolean updateStatus(Long id, Integer status);

    /**
     * æ›´æ–°é…é€å‘˜ä¿¡æ¯
     */
    boolean updateDeliveryUser(DeliveryUser deliveryUser);

    /**
     * éªŒè¯é…é€å‘˜èº«ä»½
     */
    boolean verifyDeliveryUser(Long userId, String realName, String idCard, String phone);
}
package com.heikeji.mall.delivery.service.impl;

import com.heikeji.common.core.exception.BaseException;
import com.heikeji.mall.delivery.entity.DeliveryOrder;
import com.heikeji.mall.delivery.mapper.DeliveryOrderMapper;
import com.heikeji.mall.delivery.service.DeliveryOrderService;
import com.heikeji.mall.delivery.domain.vo.DeliveryOrderVO;
import com.heikeji.mall.delivery.dto.DeliveryOrderDTO;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.Random;
import java.text.SimpleDateFormat;

/**
 * è·‘è…¿è®¢å•æœåŠ¡å®ç°ç±? */
@Service
public class DeliveryOrderServiceImpl extends ServiceImpl<DeliveryOrderMapper, DeliveryOrder> implements DeliveryOrderService {

    @Autowired
    private DeliveryOrderMapper deliveryOrderMapper;

    // @Autowired
    // private PaymentService paymentService;

    // @Autowired
    // private UserService userService;

    @Override
    @Transactional(rollbackFor = Exception.class)
    public String createOrder(Long userId, DeliveryOrderDTO dto) {
        // ç”Ÿæˆè®¢å•å?        String orderNo = generateOrderNo();

        // åˆ›å»ºè®¢å•
        DeliveryOrder order = new DeliveryOrder();
        order.setOrderNo(orderNo);
        order.setUserId(userId);
        order.setOrderType(dto.getOrderType());
        order.setStartLocation(dto.getStartLocation());
        order.setEndLocation(dto.getEndLocation());
        order.setItemDescription(dto.getItemDescription());
        order.setExpectedTime(dto.getExpectedTime());
        order.setAmount(dto.getAmount());
        order.setTip(dto.getTip() != null ? dto.getTip() : new java.math.BigDecimal("0"));
        order.setStatus(0); // å¾…æ¥å?        order.setPayStatus(0); // æœªæ”¯ä»?        order.setPayType(dto.getPayType());
        order.setRemark(dto.getRemark());
        order.setCreateTime(new Date());
        order.setUpdateTime(new Date());

        if (!this.save(order)) {
            throw new BaseException("è®¢å•åˆ›å»ºå¤±è´¥");
        }

        return orderNo;
    }

    @Override
    public DeliveryOrder getByOrderNo(String orderNo) {
        return deliveryOrderMapper.selectByOrderNo(orderNo);
    }

    @Override
    public DeliveryOrder getByOrderNoAndUserId(String orderNo, Long userId) {
        DeliveryOrder order = getByOrderNo(orderNo);
        if (order != null && order.getUserId().equals(userId)) {
            return order;
        }
        return null;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean payOrder(String orderNo, Integer payType, Long userId) {
        DeliveryOrder order = getByOrderNoAndUserId(orderNo, userId);
        if (order == null) {
            throw new BaseException("è®¢å•ä¸å­˜åœ?);
        }

        if (order.getStatus() != 0) {
            throw new BaseException("è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜");
        }

        // ç®€åŒ–å¤„ç†ï¼šç›´æ¥æ ‡è®°ä¸ºå·²æ”¯ä»˜
        order.setPayStatus(1);
        order.setUpdateTime(new Date());
        return this.updateById(order);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean cancelOrder(String orderNo, Long userId) {
        DeliveryOrder order = getByOrderNoAndUserId(orderNo, userId);
        if (order == null) {
            throw new BaseException("è®¢å•ä¸å­˜åœ?);
        }

        if (order.getStatus() != 0) {
            throw new BaseException("è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ");
        }

        order.setStatus(4); // å·²å–æ¶?        order.setUpdateTime(new Date());
        return this.updateById(order);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean acceptOrder(String orderNo, Long deliveryUserId) {
        DeliveryOrder order = getByOrderNo(orderNo);
        if (order == null) {
            throw new BaseException("è®¢å•ä¸å­˜åœ?);
        }

        if (order.getStatus() != 0) {
            throw new BaseException("è®¢å•å·²è¢«æ¥å•");
        }

        order.setDeliveryUserId(deliveryUserId);
        order.setStatus(1); // å·²æ¥å?        order.setUpdateTime(new Date());
        return this.updateById(order);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean startDelivery(String orderNo, Long deliveryUserId) {
        DeliveryOrder order = getByOrderNo(orderNo);
        if (order == null || !order.getDeliveryUserId().equals(deliveryUserId)) {
            throw new BaseException("è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ");
        }

        if (order.getStatus() != 1) {
            throw new BaseException("è®¢å•çŠ¶æ€ä¸å…è®¸å¼€å§‹é…é€?);
        }

        order.setStatus(2); // é…é€ä¸­
        order.setUpdateTime(new Date());
        return this.updateById(order);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean completeOrder(String orderNo, Long deliveryUserId) {
        DeliveryOrder order = getByOrderNo(orderNo);
        if (order == null || !order.getDeliveryUserId().equals(deliveryUserId)) {
            throw new BaseException("è®¢å•ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ");
        }

        if (order.getStatus() != 2) {
            throw new BaseException("è®¢å•çŠ¶æ€ä¸å…è®¸å®Œæˆé…é€?);
        }

        order.setStatus(3); // å·²å®Œæˆ?        order.setUpdateTime(new Date());
        return this.updateById(order);
    }

    @Override
    public List<DeliveryOrderVO> getUserOrderList(Long userId, Integer status) {
        List<DeliveryOrder> orders = deliveryOrderMapper.selectByUserId(userId, status);
        return convertToVOList(orders);
    }

    @Override
    public List<DeliveryOrderVO> getDeliveryUserOrderList(Long deliveryUserId, Integer status) {
        List<DeliveryOrder> orders = deliveryOrderMapper.selectByDeliveryUserId(deliveryUserId, status);
        return convertToVOList(orders);
    }

    @Override
    public List<DeliveryOrderVO> getPendingOrders() {
        List<DeliveryOrder> orders = deliveryOrderMapper.selectPendingOrders();
        return convertToVOList(orders);
    }

    @Override
    public DeliveryOrderVO getOrderDetail(String orderNo, Long userId) {
        DeliveryOrder order = getByOrderNo(orderNo);
        if (order != null) {
            return convertToVO(order);
        }
        return null;
    }

    @Override
    public String generateOrderNo() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");
        String dateStr = sdf.format(new Date());
        Random random = new Random();
        String randomStr = String.format("%04d", random.nextInt(10000));
        return "DO" + dateStr + randomStr;
    }

    /**
     * è½¬æ¢ä¸ºVOå¯¹è±¡
     */
    private DeliveryOrderVO convertToVO(DeliveryOrder order) {
        DeliveryOrderVO vo = new DeliveryOrderVO();
        vo.setOrderNo(order.getOrderNo());
        vo.setOrderType(order.getOrderType());
        vo.setOrderTypeName(getOrderTypeName(order.getOrderType()));
        vo.setStartLocation(order.getStartLocation());
        vo.setEndLocation(order.getEndLocation());
        vo.setItemDescription(order.getItemDescription());
        vo.setExpectedTime(order.getExpectedTime());
        vo.setAmount(order.getAmount());
        vo.setTip(order.getTip());
        vo.setStatus(order.getStatus());
        vo.setStatusName(getStatusName(order.getStatus()));
        vo.setCreateTime(order.getCreateTime());
        vo.setUpdateTime(order.getUpdateTime());

        // ç®€åŒ–å¤„ç†ï¼šä¸è®¾ç½®ç”¨æˆ·ä¿¡æ?        return vo;
    }

    /**
     * æ‰¹é‡è½¬æ¢ä¸ºVOå¯¹è±¡
     */
    private List<DeliveryOrderVO> convertToVOList(List<DeliveryOrder> orders) {
        return orders.stream().map(this::convertToVO).collect(java.util.stream.Collectors.toList());
    }

    /**
     * è·å–è®¢å•ç±»å‹åç§°
     */
    private String getOrderTypeName(Integer orderType) {
        switch (orderType) {
            case 1: return "ä»£å–å¿«é€?;
            case 2: return "ä»£ä¹°å•†å“";
            case 3: return "å…¶ä»–";
            default: return "æœªçŸ¥";
        }
    }

    /**
     * è·å–çŠ¶æ€åç§?     */
    private String getStatusName(Integer status) {
        switch (status) {
            case 0: return "å¾…æ¥å?;
            case 1: return "å·²æ¥å?;
            case 2: return "é…é€ä¸­";
            case 3: return "å·²å®Œæˆ?;
            case 4: return "å·²å–æ¶?;
            default: return "æœªçŸ¥";
        }
    }

}
package com.heikeji.mall.delivery.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.delivery.entity.DeliveryUser;
import com.heikeji.mall.delivery.mapper.DeliveryUserMapper;
import com.heikeji.mall.delivery.service.DeliveryUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * é…é€ç”¨æˆ·æœåŠ¡å®ç? */
@Service
public class DeliveryUserServiceImpl extends ServiceImpl<DeliveryUserMapper, DeliveryUser> implements DeliveryUserService {

    @Autowired
    private DeliveryUserMapper deliveryUserMapper;

    @Override
    public DeliveryUser getByUserId(Long userId) {
        return deliveryUserMapper.getByUserId(userId);
    }

    @Override
    @Transactional
    public boolean registerDeliveryUser(DeliveryUser deliveryUser) {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ³¨å†Œè¿‡é…é€å‘˜
        DeliveryUser existing = getByUserId(deliveryUser.getUserId());
        if (existing != null) {
            return false;
        }
        // è®¾ç½®åˆå§‹çŠ¶æ€?        deliveryUser.setStatus(0); // å¾…å®¡æ ?        return save(deliveryUser);
    }

    @Override
    @Transactional
    public boolean updateStatus(Long id, Integer status) {
        return deliveryUserMapper.updateStatus(id, status) > 0;
    }

    @Override
    @Transactional
    public boolean updateDeliveryUser(DeliveryUser deliveryUser) {
        return updateById(deliveryUser);
    }

    @Override
    public boolean verifyDeliveryUser(Long userId, String realName, String idCard, String phone) {
        DeliveryUser user = getByUserId(userId);
        if (user != null) {
            // ç®€åŒ–å¤„ç†ï¼šåªéªŒè¯å§“åå’Œèº«ä»½è¯å·
            return user.getRealName().equals(realName) 
                    && user.getIdCard().equals(idCard);
        }
        return false;
    }
}
package com.heikeji.mall.delivery.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.delivery.entity.DeliveryPerson;
import com.heikeji.mall.delivery.service.DeliveryPersonService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.util.Optional;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * DeliveryPersonControllerå•å…ƒæµ‹è¯•
 */
@ExtendWith(MockitoExtension.class)
public class DeliveryPersonControllerTest {

    private MockMvc mockMvc;

    @Mock
    private DeliveryPersonService deliveryPersonService;

    @InjectMocks
    private DeliveryPersonController deliveryPersonController;

    @BeforeEach
    public void setup() {
        mockMvc = MockMvcBuilders.standaloneSetup(deliveryPersonController).build();
    }

    @Test
    public void testGetDeliveryPersonByPhone_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String phone = "13900139000";
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(1L);
        deliveryPerson.setPhone(phone);
        deliveryPerson.setName("æµ‹è¯•é…é€å‘˜");
        
        when(deliveryPersonService.getDeliveryPersonByPhone(phone)).thenReturn(Optional.of(deliveryPerson));

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/delivery/person/phone/{phone}", phone))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.name").value("æµ‹è¯•é…é€å‘˜"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).getDeliveryPersonByPhone(phone);
    }

    @Test
    public void testGetDeliveryPersonByPhone_NotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String phone = "13900139000";
        when(deliveryPersonService.getDeliveryPersonByPhone(phone)).thenReturn(Optional.empty());

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/delivery/person/phone/{phone}", phone))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("é…é€å‘˜ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).getDeliveryPersonByPhone(phone);
    }

    @Test
    public void testCreateDeliveryPerson_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setPhone("13900139000");
        deliveryPerson.setName("æµ‹è¯•é…é€å‘˜");
        
        when(deliveryPersonService.createDeliveryPerson(any(DeliveryPerson.class))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/delivery/person/create")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"phone\":\"13900139000\",\"name\":\"æµ‹è¯•é…é€å‘˜\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).createDeliveryPerson(any(DeliveryPerson.class));
    }

    @Test
    public void testCreateDeliveryPerson_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setPhone("13900139000");
        deliveryPerson.setName("æµ‹è¯•é…é€å‘˜");
        
        when(deliveryPersonService.createDeliveryPerson(any(DeliveryPerson.class))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/delivery/person/create")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"phone\":\"13900139000\",\"name\":\"æµ‹è¯•é…é€å‘˜\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).createDeliveryPerson(any(DeliveryPerson.class));
    }

    @Test
    public void testUpdateDeliveryPersonStatus_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        String status = "ACTIVE";
        when(deliveryPersonService.updateDeliveryPersonStatus(eq(id), eq(status))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/delivery/person/status/{id}", id)
                .param("status", status))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).updateDeliveryPersonStatus(id, status);
    }

    @Test
    public void testUpdateDeliveryPersonStatus_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        String status = "ACTIVE";
        when(deliveryPersonService.updateDeliveryPersonStatus(eq(id), eq(status))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/delivery/person/status/{id}", id)
                .param("status", status))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).updateDeliveryPersonStatus(id, status);
    }

    @Test
    public void testGetDeliveryPersonInfo_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(id);
        deliveryPerson.setName("æµ‹è¯•é…é€å‘˜");
        
        when(deliveryPersonService.getDeliveryPersonInfo(id)).thenReturn(Optional.of(deliveryPerson));

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/delivery/person/info/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.name").value("æµ‹è¯•é…é€å‘˜"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).getDeliveryPersonInfo(id);
    }

    @Test
    public void testGetDeliveryPersonInfo_NotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        when(deliveryPersonService.getDeliveryPersonInfo(id)).thenReturn(Optional.empty());

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/delivery/person/info/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("é…é€å‘˜ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).getDeliveryPersonInfo(id);
    }

    @Test
    public void testUpdateDeliveryPerson_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(id);
        deliveryPerson.setName("æ›´æ–°çš„é…é€å‘˜");
        
        when(deliveryPersonService.updateDeliveryPerson(any(DeliveryPerson.class))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/delivery/person/update/{id}", id)
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"id\":1,\"name\":\"æ›´æ–°çš„é…é€å‘˜\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).updateDeliveryPerson(any(DeliveryPerson.class));
    }

    @Test
    public void testUpdateDeliveryPerson_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(id);
        
        when(deliveryPersonService.updateDeliveryPerson(any(DeliveryPerson.class))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/delivery/person/update/{id}", id)
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"id\":1,\"name\":\"æ›´æ–°çš„é…é€å‘˜\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(deliveryPersonService).updateDeliveryPerson(any(DeliveryPerson.class));
    }
}
package com.heikeji.mall.member;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * ä¼šå‘˜æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication
public class MemberApplication {

    public static void main(String[] args) {
        SpringApplication.run(MemberApplication.class, args);
    }

}
package com.heikeji.mall.member.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis-Plusé…ç½®ç±? */
@Configuration
public class MyBatisPlusConfig {

    /**
     * æ·»åŠ åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
package com.heikeji.mall.member.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.member.entity.MemberReceiveAddress;
import com.heikeji.mall.member.service.MemberReceiveAddressService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * ä¼šå‘˜æ”¶è´§åœ°å€æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/member/address")
@Api(tags = "æ”¶è´§åœ°å€ç®¡ç†")
public class MemberReceiveAddressController {

    @Autowired
    private MemberReceiveAddressService memberReceiveAddressService;

    /**
     * è·å–ç”¨æˆ·åœ°å€åˆ—è¡¨
     */
    @GetMapping("/list")
    @ApiOperation("è·å–ç”¨æˆ·åœ°å€åˆ—è¡¨")
    public R<List<MemberReceiveAddress>> getAddressList() {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        List<MemberReceiveAddress> addressList = memberReceiveAddressService.listByUserId(userId);
        return R.success(addressList);
    }

    /**
     * è·å–åœ°å€è¯¦æƒ…
     */
    @GetMapping("/{id}")
    @ApiOperation("è·å–åœ°å€è¯¦æƒ…")
    public R<MemberReceiveAddress> getAddressDetail(@PathVariable Long id) {
        MemberReceiveAddress address = memberReceiveAddressService.getById(id);
        if (address == null) {
            return R.error("åœ°å€ä¸å­˜åœ?);
        }
        return R.success(address);
    }

    /**
     * æ·»åŠ æ”¶è´§åœ°å€
     */
    @PostMapping
    @ApiOperation("æ·»åŠ æ”¶è´§åœ°å€")
    public R<Boolean> addAddress(@RequestBody MemberReceiveAddress address) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        address.setUserId(userId);
        boolean result = memberReceiveAddressService.saveAddress(address);
        return result ? R.success(true) : R.error("æ·»åŠ å¤±è´¥");
    }

    /**
     * æ›´æ–°æ”¶è´§åœ°å€
     */
    @PutMapping
    @ApiOperation("æ›´æ–°æ”¶è´§åœ°å€")
    public R<Boolean> updateAddress(@RequestBody MemberReceiveAddress address) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        address.setUserId(userId);
        boolean result = memberReceiveAddressService.updateAddress(address);
        return result ? R.success(true) : R.error("æ›´æ–°å¤±è´¥");
    }

    /**
     * åˆ é™¤æ”¶è´§åœ°å€
     */
    @DeleteMapping("/{id}")
    @ApiOperation("åˆ é™¤æ”¶è´§åœ°å€")
    public R<Boolean> deleteAddress(@PathVariable Long id) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        boolean result = memberReceiveAddressService.deleteAddress(id, userId);
        return result ? R.success(true) : R.error("åˆ é™¤å¤±è´¥");
    }

    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     */
    @PutMapping("/default/{id}")
    @ApiOperation("è®¾ç½®é»˜è®¤åœ°å€")
    public R<Boolean> setDefaultAddress(@PathVariable Long id) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        boolean result = memberReceiveAddressService.setDefaultAddress(id, userId);
        return result ? R.success(true) : R.error("è®¾ç½®å¤±è´¥");
    }

    /**
     * è·å–ç”¨æˆ·é»˜è®¤åœ°å€
     */
    @GetMapping("/default")
    @ApiOperation("è·å–ç”¨æˆ·é»˜è®¤åœ°å€")
    public R<MemberReceiveAddress> getDefaultAddress() {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        MemberReceiveAddress defaultAddress = memberReceiveAddressService.getDefaultAddressByUserId(userId);
        return defaultAddress != null ? R.success(defaultAddress) : R.error("æš‚æ— é»˜è®¤åœ°å€");
    }
}
package com.heikeji.mall.member.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * ä¼šå‘˜æ”¶è´§åœ°å€å®ä½“ç±? */
@Data
@TableName("member_receive_address")
public class MemberReceiveAddress implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * åœ°å€ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * æ”¶è´§äººå§“å?     */
    private String name;

    /**
     * æ‰‹æœºå·ç 
     */
    private String phone;

    /**
     * çœä»½
     */
    private String province;

    /**
     * åŸå¸‚
     */
    private String city;

    /**
     * åŒºå¿
     */
    private String region;

    /**
     * è¯¦ç»†åœ°å€
     */
    private String detailAddress;

    /**
     * æ˜¯å¦é»˜è®¤åœ°å€
     */
    private Integer defaultStatus;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * åˆ é™¤æ ‡è®°
     */
    private Integer delFlag;
}
package com.heikeji.mall.member.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.member.entity.MemberReceiveAddress;
import org.apache.ibatis.annotations.Mapper;

import java.util.List;

/**
 * ä¼šå‘˜æ”¶è´§åœ°å€Mapper
 */
@Mapper
public interface MemberReceiveAddressMapper extends BaseMapper<MemberReceiveAddress> {

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢åœ°å€åˆ—è¡¨
     */
    List<MemberReceiveAddress> listByUserId(Long userId);

    /**
     * æŸ¥è¯¢ç”¨æˆ·é»˜è®¤åœ°å€
     */
    MemberReceiveAddress getDefaultAddressByUserId(Long userId);
}
package com.heikeji.mall.member.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.member.entity.MemberReceiveAddress;
import java.util.List;

/**
 * ä¼šå‘˜æ”¶è´§åœ°å€æœåŠ¡
 */
public interface MemberReceiveAddressService extends IService<MemberReceiveAddress> {

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢åœ°å€åˆ—è¡¨
     */
    List<MemberReceiveAddress> listByUserId(Long userId);

    /**
     * æ ¹æ®IDè·å–åœ°å€
     */
    MemberReceiveAddress getById(Long id);

    /**
     * ä¿å­˜åœ°å€
     */
    boolean saveAddress(MemberReceiveAddress address);

    /**
     * æ›´æ–°åœ°å€
     */
    boolean updateAddress(MemberReceiveAddress address);

    /**
     * åˆ é™¤åœ°å€
     */
    boolean deleteAddress(Long id, Long userId);

    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     */
    boolean setDefaultAddress(Long id, Long userId);

    /**
     * è·å–ç”¨æˆ·é»˜è®¤åœ°å€
     */
    MemberReceiveAddress getDefaultAddressByUserId(Long userId);
}
package com.heikeji.mall.member.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.member.entity.MemberReceiveAddress;
import com.heikeji.mall.member.mapper.MemberReceiveAddressMapper;
import com.heikeji.mall.member.service.MemberReceiveAddressService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

/**
 * ä¼šå‘˜æ”¶è´§åœ°å€æœåŠ¡å®ç°
 */
@Service
public class MemberReceiveAddressServiceImpl extends ServiceImpl<MemberReceiveAddressMapper, MemberReceiveAddress> implements MemberReceiveAddressService {

    @Autowired
    private MemberReceiveAddressMapper addressMapper;

    @Override
    public List<MemberReceiveAddress> listByUserId(Long userId) {
        return addressMapper.listByUserId(userId);
    }

    @Override
    public MemberReceiveAddress getById(Long id) {
        return super.getById(id);
    }

    @Override
    @Transactional
    public boolean saveAddress(MemberReceiveAddress address) {
        // å¦‚æœæ˜¯é»˜è®¤åœ°å€ï¼Œå…ˆå°†ç”¨æˆ·å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®?        if (address.getDefaultStatus() == 1) {
            updateOtherAddressesNotDefault(address.getUserId());
        }
        return save(address);
    }

    @Override
    @Transactional
    public boolean updateAddress(MemberReceiveAddress address) {
        // å¦‚æœæ˜¯é»˜è®¤åœ°å€ï¼Œå…ˆå°†ç”¨æˆ·å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®?        if (address.getDefaultStatus() == 1) {
            updateOtherAddressesNotDefault(address.getUserId());
        }
        return updateById(address);
    }

    @Override
    public boolean deleteAddress(Long id, Long userId) {
        // ç¡®ä¿åªèƒ½åˆ é™¤è‡ªå·±çš„åœ°å€
        MemberReceiveAddress address = getById(id);
        if (address != null && address.getUserId().equals(userId)) {
            return removeById(id);
        }
        return false;
    }

    @Override
    @Transactional
    public boolean setDefaultAddress(Long id, Long userId) {
        // ç¡®ä¿åªèƒ½è®¾ç½®è‡ªå·±çš„åœ°å€ä¸ºé»˜è®?        MemberReceiveAddress address = getById(id);
        if (address != null && address.getUserId().equals(userId)) {
            // å°†å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®?            updateOtherAddressesNotDefault(userId);
            // è®¾ç½®å½“å‰åœ°å€ä¸ºé»˜è®?            address.setDefaultStatus(1);
            return updateById(address);
        }
        return false;
    }

    @Override
    public MemberReceiveAddress getDefaultAddressByUserId(Long userId) {
        return addressMapper.getDefaultAddressByUserId(userId);
    }

    /**
     * å°†ç”¨æˆ·çš„å…¶ä»–åœ°å€è®¾ç½®ä¸ºéé»˜è®¤
     */
    private void updateOtherAddressesNotDefault(Long userId) {
        List<MemberReceiveAddress> addresses = listByUserId(userId);
        for (MemberReceiveAddress address : addresses) {
            if (address.getDefaultStatus() == 1) {
                address.setDefaultStatus(0);
                updateById(address);
            }
        }
    }
}
package com.heikeji.mall.order;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

/**
 * è®¢å•æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication
@ComponentScan({
    "com.heikeji.mall.order",
    "com.heikeji.common.core"
})
@MapperScan("com.heikeji.mall.order.mapper")
public class OrderApplication {

    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }
}
package com.heikeji.mall.order.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis Plusé…ç½®ç±? */
@Configuration
@MapperScan("com.heikeji.mall.order.mapper")
public class MyBatisPlusConfig {

    /**
     * åˆ†é¡µæ’ä»¶é…ç½®
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        PaginationInnerInterceptor paginationInterceptor = new PaginationInnerInterceptor();
        // è®¾ç½®è¯·æ±‚çš„é¡µé¢å¤§äºæœ€å¤§é¡µåæ“ä½œï¼Œtrueè°ƒå›åˆ°é¦–é¡µï¼Œfalseç»§ç»­è¯·æ±‚ï¼Œé»˜è®¤false
        paginationInterceptor.setOverflow(false);
        // è®¾ç½®æœ€å¤§å•é¡µé™åˆ¶æ•°é‡?        paginationInterceptor.setMaxLimit(100L);
        // è®¾ç½®æ•°æ®åº“ç±»å?        paginationInterceptor.setDbType(DbType.MYSQL);
        interceptor.addInnerInterceptor(paginationInterceptor);
        return interceptor;
    }
}
package com.heikeji.mall.order.constant;

/**
 * è®¢å•ç›¸å…³å¸¸é‡
 */
public class OrderConstant {
    
    // è®¢å•ç±»å‹
    public static final Integer ORDER_TYPE_NORMAL = 1; // æ™®é€šè®¢å?    public static final Integer ORDER_TYPE_TAKEOUT = 2; // å¤–å–è®¢å•
    public static final Integer ORDER_TYPE_RUNNER = 3; // è·‘è…¿è®¢å•
    
    // è®¢å•çŠ¶æ€?    public static final Integer ORDER_STATUS_PENDING_PAYMENT = 0; // å¾…æ”¯ä»?    public static final Integer ORDER_STATUS_PAID = 1; // å·²æ”¯ä»?    public static final Integer ORDER_STATUS_PENDING_DELIVERY = 2; // å¾…å‘è´?    public static final Integer ORDER_STATUS_PENDING_RECEIVE = 3; // å¾…æ”¶è´?    public static final Integer ORDER_STATUS_COMPLETED = 4; // å·²å®Œæˆ?    public static final Integer ORDER_STATUS_CANCELLED = 5; // å·²å–æ¶?    public static final Integer ORDER_STATUS_REFUNDING = 6; // é€€æ¬¾ä¸­
    public static final Integer ORDER_STATUS_REFUNDED = 7; // å·²é€€æ¬?    
    // æ”¯ä»˜çŠ¶æ€?    public static final Integer PAY_STATUS_UNPAID = 0; // æœªæ”¯ä»?    public static final Integer PAY_STATUS_PAID = 1; // å·²æ”¯ä»?    public static final Integer PAY_STATUS_FAILED = 2; // æ”¯ä»˜å¤±è´¥
    
    // æ”¯ä»˜æ–¹å¼
    public static final Integer PAY_TYPE_WECHAT = 1; // å¾®ä¿¡æ”¯ä»˜
    public static final Integer PAY_TYPE_ALIPAY = 2; // æ”¯ä»˜å®?    public static final Integer PAY_TYPE_BALANCE = 3; // ä½™é¢æ”¯ä»˜
    
    // è®¢å•è¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šåˆ†é’Ÿï¼?    public static final Integer ORDER_TIMEOUT = 30;
}
package com.heikeji.mall.order.controller;

import com.heikeji.common.core.annotation.RateLimiter;
import com.heikeji.common.core.domain.R;
import com.heikeji.mall.order.domain.vo.OrderDetailVO;
import com.heikeji.mall.order.domain.vo.OrderListVO;
import com.heikeji.mall.order.entity.Order;
import com.heikeji.mall.order.service.OrderService;
import com.heikeji.mall.takeout.dto.TakeoutOrderDTO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * è®¢å•æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/order")
@Api(tags = "è®¢å•ç®¡ç†")
public class OrderController {

    @Autowired
    private OrderService orderService;

    /**
     * åˆ›å»ºå¤–å–è®¢å•
     */
    @PostMapping("/takeout")
    @ApiOperation("åˆ›å»ºå¤–å–è®¢å•")
    @RateLimiter(timeWindow = 1, maxCount = 10)
    public R<Long> createTakeoutOrder(@RequestBody TakeoutOrderDTO dto) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L; // æ¨¡æ‹Ÿç”¨æˆ·ID
        String orderNo = generateOrderNo(); // å®é™…åº”è¯¥ç”±æœåŠ¡å±‚ç”Ÿæˆ
        Long orderId = orderService.createTakeoutOrder(userId, orderNo, dto);
        return R.success(orderId);
    }

    /**
     * åˆ›å»ºå•†å“è®¢å•
     */
    @PostMapping
    @ApiOperation("åˆ›å»ºå•†å“è®¢å•")
    @RateLimiter(timeWindow = 1, maxCount = 10)
    public R<Order> createOrder(
            @RequestParam Long addressId,
            @RequestParam(required = false) Integer payType,
            @RequestParam(required = false) String orderRemark,
            @RequestParam(required = false) String couponCode) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        
        if (payType == null) {
            payType = 1; // é»˜è®¤æ”¯ä»˜æ–¹å¼
        }
        
        Order order = orderService.createOrder(userId, addressId, payType, orderRemark, couponCode);
        return R.success(order);
    }

    /**
     * ç›´æ¥è´­ä¹°å•†å“
     */
    @PostMapping("/direct-buy")
    @ApiOperation("ç›´æ¥è´­ä¹°å•†å“")
    @RateLimiter(timeWindow = 1, maxCount = 10)
    public R<Order> directBuyOrder(
            @RequestParam Long productId,
            @RequestParam Integer productNum,
            @RequestParam Long addressId,
            @RequestParam(required = false) Integer payType,
            @RequestParam(required = false) String orderRemark,
            @RequestParam(required = false) String couponCode) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        
        if (payType == null) {
            payType = 1; // é»˜è®¤æ”¯ä»˜æ–¹å¼
        }
        
        Order order = orderService.createDirectBuyOrder(userId, addressId, productId, productNum, payType, orderRemark, couponCode);
        return R.success(order);
    }

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/detail/{orderNo}")
    @ApiOperation("è·å–è®¢å•è¯¦æƒ…")
    public R<OrderDetailVO> getOrderDetail(@PathVariable String orderNo) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        OrderDetailVO orderDetail = orderService.getOrderDetailByOrderNo(orderNo, userId);
        return R.success(orderDetail);
    }

    /**
     * ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/user/list")
    @ApiOperation("ç”¨æˆ·è®¢å•åˆ—è¡¨")
    public R<Map<String, Object>> getUserOrders(
            @RequestParam(required = false) Integer status,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "10") Integer limit) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        Map<String, Object> result = orderService.getUserOrderList(userId, status, page, limit);
        return R.success(result);
    }

    /**
     * æ ¹æ®çŠ¶æ€è·å–ç”¨æˆ·è®¢å•åˆ—è¡?     */
    @GetMapping("/user/status/list")
    @ApiOperation("æ ¹æ®çŠ¶æ€è·å–ç”¨æˆ·è®¢å•åˆ—è¡?)
    public R<List<OrderListVO>> getUserOrdersByStatus(
            @RequestParam(required = false) Integer status) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        List<OrderListVO> orders = orderService.getOrderListByUserIdAndStatus(userId, status);
        return R.success(orders);
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PutMapping("/cancel/{orderNo}")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Boolean> cancelOrder(@PathVariable String orderNo) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        Boolean result = orderService.cancelOrder(orderNo, userId);
        return R.success(result);
    }

    /**
     * ç¡®è®¤æ”¶è´§
     */
    @PutMapping("/confirm/{orderNo}")
    @ApiOperation("ç¡®è®¤æ”¶è´§")
    public R<Boolean> confirmReceive(@PathVariable String orderNo) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        Boolean result = orderService.confirmReceipt(orderNo, userId);
        return R.success(result);
    }

    /**
     * è®¢å•æ”¯ä»˜
     */
    @PostMapping("/pay")
    @ApiOperation("è®¢å•æ”¯ä»˜")
    @RateLimiter(timeWindow = 1, maxCount = 5)
    public R<Map<String, Object>> payOrder(
            @RequestParam String orderNo,
            @RequestParam Integer payType) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ä»tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ID
        Long userId = 1L;
        Map<String, Object> result = orderService.payOrder(orderNo, payType, userId);
        return R.success(result);
    }
    
    /**
     * æ ¹æ®è®¢å•å·è·å–ç”¨æˆ·IDï¼ˆä¾›å…¶ä»–æœåŠ¡è°ƒç”¨ï¼?     */
    @GetMapping("/getUserIdByOrderNo")
    @ApiOperation("æ ¹æ®è®¢å•å·è·å–ç”¨æˆ·ID")
    public R<Map<String, Long>> getUserIdByOrderNo(@RequestParam String orderNo) {
        Order order = orderService.getByOrderNo(orderNo);
        if (order == null) {
            return R.error("è®¢å•ä¸å­˜åœ?);
        }
        Map<String, Long> result = new HashMap<>();
        result.put("userId", order.getUserId());
        return R.success(result);
    }
    
    /**
     * ç”Ÿæˆè®¢å•å·ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    private String generateOrderNo() {
        String timestamp = String.valueOf(System.currentTimeMillis());
        String random = String.valueOf((int)(Math.random() * 10000));
        return "ORD" + timestamp + random;
    }
}
package com.heikeji.mall.order.domain.vo;

import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

/**
 * è®¢å•è¯¦æƒ…VOç±? * ç”¨äºè®¢å•è¯¦æƒ…é¡µé¢çš„æ•°æ®å±•ç¤? */
@Data
public class OrderDetailVO {
    /**
     * è®¢å•ID
     */
    private Long id;
    
    /**
     * è®¢å•å?     */
    private String orderNo;
    
    /**
     * è®¢å•ç±»å‹
     */
    private Integer orderType;
    
    /**
     * è®¢å•çŠ¶æ€?     */
    private Integer status;
    
    /**
     * æ”¯ä»˜çŠ¶æ€?     */
    private Integer payStatus;
    
    /**
     * æ”¯ä»˜æ–¹å¼
     */
    private Integer paymentMethod;
    
    /**
     * æ”¯ä»˜æµæ°´å?     */
    private String paymentNo;
    
    /**
     * å•†å“æ€»é‡‘é¢?     */
    private BigDecimal totalAmount;
    
    /**
     * å®é™…æ”¯ä»˜é‡‘é¢
     */
    private BigDecimal payAmount;
    
    /**
     * è¿è´¹é‡‘é¢
     */
    private BigDecimal freightAmount;
    
    /**
     * æ”¶è´§äººå§“å?     */
    private String receiverName;
    
    /**
     * æ”¶è´§äººç”µè¯?     */
    private String receiverPhone;
    
    /**
     * æ”¶è´§äººçœä»?     */
    private String receiverProvince;
    
    /**
     * æ”¶è´§äººåŸå¸?     */
    private String receiverCity;
    
    /**
     * æ”¶è´§äººåŒºå?     */
    private String receiverDistrict;
    
    /**
     * è¯¦ç»†åœ°å€
     */
    private String receiverAddress;
    
    /**
     * é…é€æ–¹å¼?     */
    private Integer deliveryType;
    
    /**
     * ç‰©æµå…¬å¸
     */
    private String logisticsCompany;
    
    /**
     * ç‰©æµå•å·
     */
    private String trackingNumber;
    
    /**
     * è®¢å•å¤‡æ³¨
     */
    private String remark;
    
    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;
    
    /**
     * æ”¯ä»˜æ—¶é—´
     */
    private Date payTime;
    
    /**
     * å‘è´§æ—¶é—´
     */
    private Date shipTime;
    
    /**
     * å®Œæˆæ—¶é—´
     */
    private Date completeTime;
    
    /**
     * è®¢å•å•†å“åˆ—è¡¨
     */
    private List<OrderItemVO> orderItems;
    
    /**
     * è®¢å•å•†å“æ˜ç»†VOç±?     */
    @Data
    public static class OrderItemVO {
        /**
         * å•†å“ID
         */
        private Long productId;
        
        /**
         * å•†å“åç§°
         */
        private String productName;
        
        /**
         * å•†å“å›¾ç‰‡
         */
        private String productImage;
        
        /**
         * å•†å“ä»·æ ¼
         */
        private BigDecimal price;
        
        /**
         * è´­ä¹°æ•°é‡
         */
        private Integer quantity;
        
        /**
         * å•†å“æ€»é‡‘é¢?         */
        private BigDecimal totalPrice;
    }
}
package com.heikeji.mall.order.domain.vo;

import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

/**
 * è®¢å•åˆ—è¡¨VOç±? * ç”¨äºè®¢å•åˆ—è¡¨é¡µé¢çš„æ•°æ®å±•ç¤? */
@Data
public class OrderListVO {
    /**
     * è®¢å•ID
     */
    private Long id;
    
    /**
     * è®¢å•å?     */
    private String orderNo;
    
    /**
     * è®¢å•çŠ¶æ€?     */
    private Integer status;
    
    /**
     * è®¢å•æ€»é‡‘é¢?     */
    private BigDecimal totalAmount;
    
    /**
     * è¿è´¹é‡‘é¢
     */
    private BigDecimal freightAmount;
    
    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;
    
    /**
     * è®¢å•å•†å“åˆ—è¡¨
     */
    private List<OrderItemVO> orderItems;
    
    /**
     * è®¢å•å•†å“æ˜ç»†VOç±?     */
    @Data
    public static class OrderItemVO {
        /**
         * å•†å“ID
         */
        private Long productId;
        
        /**
         * å•†å“åç§°
         */
        private String productName;
        
        /**
         * å•†å“å›¾ç‰‡
         */
        private String productImage;
        
        /**
         * å•†å“ä»·æ ¼
         */
        private BigDecimal price;
        
        /**
         * è´­ä¹°æ•°é‡
         */
        private Integer quantity;
    }
}
package com.heikeji.mall.order.dto;

import com.heikeji.mall.order.entity.OrderItem;
import lombok.Data;

import java.util.List;

/**
 * è®¢å•åˆ›å»ºè¯·æ±‚DTO
 */
@Data
public class OrderDTO {
    
    /**
     * å•†å®¶ID
     */
    private Long merchantId;
    
    /**
     * è®¢å•ç±»å‹ï¼?-æ™®é€šè®¢å•ï¼Œ2-å¤–å–è®¢å•ï¼?-è·‘è…¿è®¢å•
     */
    private Integer orderType;
    
    /**
     * æ”¶è´§äººå§“å?     */
    private String receiverName;
    
    /**
     * æ”¶è´§äººç”µè¯?     */
    private String receiverPhone;
    
    /**
     * æ”¶è´§åœ°å€
     */
    private String receiverAddress;
    
    /**
     * è®¢å•å¤‡æ³¨
     */
    private String remark;
    
    /**
     * è®¢å•å•†å“åˆ—è¡¨
     */
    private List<OrderItem> orderItems;
}
package com.heikeji.mall.order.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;

/**
 * è®¢å•ä¸»è¡¨å®ä½“ç±?
 */
@Data
@TableName("order")
public class Order {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String orderNo;
    private Long userId;
    private Long merchantId;
    private Integer orderType;
    private BigDecimal totalAmount;
    private BigDecimal payAmount;
    private BigDecimal freightAmount;
    private Long addressId;
    private String receiverName;
    private String receiverPhone;
    private String receiverAddress;
    private Integer deliveryType;
    private String deliveryLockerCode;
    private String deliverySpecialPlace;
    private Integer status;
    private Integer payStatus;
    private Date payTime;
    private Date deliveryTime;
    private Date completeTime;
    private String remark;
    private Date createTime;
    private Date updateTime;
    @TableField("version")
    private Integer version;
}
package com.heikeji.mall.order.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;

/**
 * è®¢å•å•†å“æ˜ç»†è¡¨å®ä½“ç±»
 */
@Data
@TableName("order_item")
public class OrderItem {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long orderId;
    private String orderNo;
    private Long productId;
    private String productName;
    private String productImage;
    private BigDecimal productPrice;
    private Integer quantity;
    private BigDecimal totalPrice;
    private Date createTime;
}
package com.heikeji.mall.order.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.order.entity.OrderItem;

/**
 * è®¢å•å•†å“æ˜ç»†Mapperæ¥å£
 */
public interface OrderItemMapper extends BaseMapper<OrderItem> {
}
package com.heikeji.mall.order.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.order.entity.Order;
import org.apache.ibatis.annotations.Mapper;

import java.util.List;
import java.util.Map;

/**
 * è®¢å•Mapperæ¥å£
 */
@Mapper
public interface OrderMapper extends BaseMapper<Order> {
    
    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å?     * @param orderNo è®¢å•å?     * @return è®¢å•ä¿¡æ¯
     */
    Order selectByOrderNo(String orderNo);
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @return è®¢å•åˆ—è¡¨
     */
    List<Order> selectByUserId(Long userId);
    
    /**
     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢è®¢å•åˆ—è¡¨
     * @param merchantId å•†å®¶ID
     * @return è®¢å•åˆ—è¡¨
     */
    List<Order> selectByMerchantId(Long merchantId);
    
    /**
     * æ›´æ–°è®¢å•çŠ¶æ€?     * @param params æ›´æ–°å‚æ•°
     * @return æ›´æ–°ç»“æœ
     */
    int updateOrderStatus(Map<String, Object> params);
    
    /**
     * æŸ¥è¯¢å¾…å¤„ç†è®¢å?     * @param status è®¢å•çŠ¶æ€?     * @return è®¢å•åˆ—è¡¨
     */
    List<Order> selectPendingOrders(Integer status);
}
package com.heikeji.mall.order.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.order.entity.OrderItem;

import java.util.List;

/**
 * è®¢å•å•†å“æ˜ç»†æœåŠ¡æ¥å£
 */
public interface OrderItemService extends IService<OrderItem> {
    
    /**
     * æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å•å•†å“æ˜ç»†åˆ—è¡¨
     * @param orderId è®¢å•ID
     * @return è®¢å•å•†å“æ˜ç»†åˆ—è¡¨
     */
    List<OrderItem> getByOrderId(Long orderId);
    
    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•å•†å“æ˜ç»†åˆ—è¡?     * @param orderNo è®¢å•å?     * @return è®¢å•å•†å“æ˜ç»†åˆ—è¡¨
     */
    List<OrderItem> getByOrderNo(String orderNo);
    
    /**
     * æ‰¹é‡ä¿å­˜è®¢å•å•†å“æ˜ç»†
     * @param orderItems è®¢å•å•†å“æ˜ç»†åˆ—è¡¨
     * @return æ˜¯å¦ä¿å­˜æˆåŠŸ
     */
    boolean saveBatchOrderItems(List<OrderItem> orderItems);
}
package com.heikeji.mall.order.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.order.domain.vo.OrderDetailVO;
import com.heikeji.mall.order.domain.vo.OrderListVO;
import com.heikeji.mall.order.entity.Order;
import com.heikeji.mall.order.entity.OrderItem;
import com.heikeji.mall.takeout.dto.TakeoutOrderDTO;

import java.util.List;
import java.util.Map;

/**
 * è®¢å•æœåŠ¡æ¥å£
 */
public interface OrderService extends IService<Order> {

    /**
     * åˆ›å»ºå¤–å–è®¢å•
     * @param userId ç”¨æˆ·ID
     * @param orderNo è®¢å•å?     * @param dto å¤–å–è®¢å•DTO
     * @return è®¢å•ID
     */
    Long createTakeoutOrder(Long userId, String orderNo, TakeoutOrderDTO dto);

    /**
     * åˆ›å»ºè®¢å•å•†å“æ˜ç»†
     * @param orderId è®¢å•ID
     * @param orderNo è®¢å•å?     * @param items è®¢å•å•†å“åˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean createOrderItems(Long orderId, String orderNo, List<TakeoutOrderDTO.OrderItemDTO> items);

    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å?     * @param orderNo è®¢å•å?     * @return è®¢å•ä¿¡æ¯
     */
    Order getByOrderNo(String orderNo);
    
    /**
     * æ ¹æ®è®¢å•å·å’Œç”¨æˆ·IDæŸ¥è¯¢è®¢å•
     * @param orderNo è®¢å•å?     * @param userId ç”¨æˆ·ID
     * @return è®¢å•ä¿¡æ¯
     */
    Order getByOrderNoAndUserId(String orderNo, Long userId);

    /**
     * æ›´æ–°è®¢å•çŠ¶æ€?     * @param orderNo è®¢å•å?     * @param status è®¢å•çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean updateOrderStatus(String orderNo, Integer status);

    /**
     * æ”¯ä»˜è®¢å•
     * @param orderNo è®¢å•å?     * @param payType æ”¯ä»˜æ–¹å¼
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean payOrder(String orderNo, Integer payType);
    
    /**
     * æ”¯ä»˜è®¢å•ï¼ˆå¸¦ç”¨æˆ·éªŒè¯ï¼?     * @param orderNo è®¢å•å?     * @param payType æ”¯ä»˜æ–¹å¼
     * @param userId ç”¨æˆ·ID
     * @return æ”¯ä»˜ç»“æœä¿¡æ¯
     */
    Map<String, Object> payOrder(String orderNo, Integer payType, Long userId);

    /**
     * å–æ¶ˆè®¢å•
     * @param orderNo è®¢å•å?     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean cancelOrder(String orderNo);
    
    /**
     * å–æ¶ˆè®¢å•ï¼ˆå¸¦ç”¨æˆ·éªŒè¯ï¼?     * @param orderNo è®¢å•å?     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean cancelOrder(String orderNo, Long userId);
    
    /**
     * åˆ›å»ºå•†å“è®¢å•
     * @param userId ç”¨æˆ·ID
     * @param addressId åœ°å€ID
     * @return è®¢å•ä¿¡æ¯
     */
    Order createOrder(Long userId, Long addressId);
    
    /**
     * åˆ›å»ºå•†å“è®¢å•ï¼ˆæ‰©å±•ç‰ˆæœ¬ï¼Œæ”¯æŒæ›´å¤šå‚æ•°ï¼?     * @param userId ç”¨æˆ·ID
     * @param addressId åœ°å€ID
     * @param payType æ”¯ä»˜æ–¹å¼
     * @param orderRemark è®¢å•å¤‡æ³¨
     * @param couponCode ä¼˜æƒ ç ?     * @return è®¢å•ä¿¡æ¯
     */
    Order createOrder(Long userId, Long addressId, Integer payType, String orderRemark, String couponCode);
    
    /**
     * ç›´æ¥è´­ä¹°å•†å“åˆ›å»ºè®¢å•
     * @param userId ç”¨æˆ·ID
     * @param addressId åœ°å€ID
     * @param productId å•†å“ID
     * @param productNum å•†å“æ•°é‡
     * @param payType æ”¯ä»˜æ–¹å¼
     * @param orderRemark è®¢å•å¤‡æ³¨
     * @param couponCode ä¼˜æƒ ç ?     * @return è®¢å•ä¿¡æ¯
     */
    Order createDirectBuyOrder(Long userId, Long addressId, Long productId, Integer productNum, Integer payType, String orderRemark, String couponCode);
    
    /**
     * ç¡®è®¤æ”¶è´§
     * @param orderNo è®¢å•å?     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean confirmReceipt(String orderNo);
    
    /**
     * ç¡®è®¤æ”¶è´§ï¼ˆå¸¦ç”¨æˆ·éªŒè¯ï¼?     * @param orderNo è®¢å•å?     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean confirmReceipt(String orderNo, Long userId);
    
    /**
     * æ ¹æ®ç”¨æˆ·IDå’ŒçŠ¶æ€è·å–è®¢å•åˆ—è¡?     * @param userId ç”¨æˆ·ID
     * @param status è®¢å•çŠ¶æ€?     * @return è®¢å•åˆ—è¡¨
     */
    List<OrderListVO> getOrderListByUserIdAndStatus(Long userId, Integer status);
    
    /**
     * æ ¹æ®è®¢å•å·å’Œç”¨æˆ·IDè·å–è®¢å•è¯¦æƒ…
     * @param orderNo è®¢å•å?     * @param userId ç”¨æˆ·ID
     * @return è®¢å•è¯¦æƒ…
     */
    OrderDetailVO getOrderDetailByOrderNo(String orderNo, Long userId);
    
    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ†é¡µåˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @param status è®¢å•çŠ¶æ€?     * @param page é¡µç 
     * @param limit æ¯é¡µæ•°é‡
     * @return åˆ†é¡µè®¢å•æ•°æ®
     */
    Map<String, Object> getUserOrderList(Long userId, Integer status, Integer page, Integer limit);
    
    /**
     * è·å–å¾…å¤„ç†è®¢å•åˆ—è¡?     * @return å¾…å¤„ç†è®¢å•åˆ—è¡?     */
    List<Order> getPendingOrders();
}
package com.heikeji.mall.order.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.order.entity.OrderItem;
import com.heikeji.mall.order.mapper.OrderItemMapper;
import com.heikeji.mall.order.service.OrderItemService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * è®¢å•å•†å“æ˜ç»†æœåŠ¡å®ç°ç±? */
@Service
public class OrderItemServiceImpl extends ServiceImpl<OrderItemMapper, OrderItem> implements OrderItemService {

    /**
     * æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å•å•†å“æ˜ç»†åˆ—è¡¨
     */
    @Override
    public List<OrderItem> getByOrderId(Long orderId) {
        QueryWrapper<OrderItem> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("order_id", orderId);
        return this.list(queryWrapper);
    }

    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢è®¢å•å•†å“æ˜ç»†åˆ—è¡?     */
    @Override
    public List<OrderItem> getByOrderNo(String orderNo) {
        QueryWrapper<OrderItem> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("order_no", orderNo);
        return this.list(queryWrapper);
    }

    /**
     * æ‰¹é‡ä¿å­˜è®¢å•å•†å“æ˜ç»†
     */
    @Override
    public boolean saveBatchOrderItems(List<OrderItem> orderItems) {
        return this.saveBatch(orderItems);
    }
}
package com.heikeji.mall.order.service.impl;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import jakarta.annotation.Resource;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.heikeji.common.core.constant.Constants;
import com.heikeji.common.core.exception.BaseException;
import com.heikeji.mall.order.domain.vo.OrderDetailVO;
import com.heikeji.mall.order.domain.vo.OrderListVO;
import com.heikeji.mall.order.entity.Order;
import com.heikeji.mall.order.entity.OrderItem;
import com.heikeji.mall.order.mapper.OrderItemMapper;
import com.heikeji.mall.order.mapper.OrderMapper;
import com.heikeji.mall.order.service.OrderItemService;
import com.heikeji.mall.order.service.OrderService;
import com.heikeji.mall.product.service.ProductService;

/**
 * è®¢å•æœåŠ¡å®ç°ç±? */
@Slf4j
@Service
public class OrderServiceImpl extends ServiceImpl<OrderMapper, Order> implements OrderService {

    @Resource
    private OrderItemMapper orderItemMapper;
    
    @Resource
    private ProductService productService;
    
    @Resource
    private OrderItemService orderItemService;
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Order createOrder(Long userId, Long addressId) {
        log.warn("ç”±äºservice-cartæ¨¡å—ä¸å­˜åœ¨ï¼ŒcreateOrderæ–¹æ³•ä½¿ç”¨ç®€åŒ–å®ç?);
        return null;
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Order createOrder(Long userId, Long addressId, Integer payType, String orderRemark, String couponCode) {
        log.warn("ç”±äºservice-cartæ¨¡å—ä¸å­˜åœ¨ï¼ŒcreateOrderæ–¹æ³•ä½¿ç”¨ç®€åŒ–å®ç?);
        return null;
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Order createDirectBuyOrder(Long userId, Long addressId, Long productId, Integer productNum, Integer payType, String orderRemark, String couponCode) {
        log.warn("ç”±äºservice-cartæ¨¡å—ä¸å­˜åœ¨ï¼ŒcreateDirectBuyOrderæ–¹æ³•ä½¿ç”¨ç®€åŒ–å®ç?);
        return null;
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long createTakeoutOrder(Long userId, String orderNo, com.heikeji.mall.takeout.dto.TakeoutOrderDTO dto) {
        Order order = new Order();
        order.setOrderNo(orderNo);
        order.setUserId(userId);
        order.setStatus(0);
        order.setPayStatus(0);
        order.setCreateTime(new Date());
        order.setUpdateTime(new Date());
        
        // ç®€åŒ–ä»·æ ¼è®¾ç½?        order.setTotalAmount(new BigDecimal(100));
        
        this.save(order);
        log.info("åˆ›å»ºå¤–å–è®¢å•æˆåŠŸ: {}", orderNo);
        return order.getId();
    }
    
    @Override
    public Boolean createOrderItems(Long orderId, String orderNo, List<com.heikeji.mall.takeout.dto.TakeoutOrderDTO.OrderItemDTO> items) {
        // ç®€åŒ–å®ç?        return true;
    }
    
    @Override
    public Order getByOrderNo(String orderNo) {
        LambdaQueryWrapper<Order> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(Order::getOrderNo, orderNo);
        return this.getOne(queryWrapper);
    }
    
    @Override
    public Boolean updateOrderStatus(String orderNo, Integer status) {
        // ç®€åŒ–å®ç?        return true;
    }
    
    @Override
    public Boolean payOrder(String orderNo, Integer payType) {
        // ç®€åŒ–å®ç?        return true;
    }
    
    @Override
    public Boolean cancelOrder(String orderNo) {
        // ç®€åŒ–å®ç?        return true;
    }
    
    @Override
    public Boolean confirmReceipt(String orderNo) {
        // ç®€åŒ–å®ç?        return true;
    }
    
    @Override
    public Boolean confirmReceipt(String orderNo, Long userId) {
        // ç®€åŒ–å®ç?        return true;
    }
    
    @Override
    public OrderDetailVO getOrderDetailByOrderNo(String orderNo, Long userId) {
        Order order = getByOrderNoAndUserId(orderNo, userId);
        if (order == null) {
            return null;
        }
        
        OrderDetailVO vo = new OrderDetailVO();
        // åªè®¾ç½®OrderDetailVOä¸­å­˜åœ¨çš„å±æ€?        vo.setOrderNo(order.getOrderNo());
        vo.setStatus(order.getStatus());
        vo.setTotalAmount(order.getTotalAmount());
        
        // ç®€åŒ–å¤„ç†ï¼Œè¿”å›åŸºæœ¬ä¿¡æ¯
        return vo;
    }
    
    @Override
    public List<OrderListVO> getOrderListByUserIdAndStatus(Long userId, Integer status) {
        // ç®€åŒ–å®ç?        return new ArrayList<>();
    }
    
    @Override
    public Map<String, Object> getUserOrderList(Long userId, Integer status, Integer page, Integer limit) {
        // ç®€åŒ–å®ç?        Map<String, Object> result = new HashMap<>();
        result.put("list", new ArrayList<>());
        result.put("total", 0);
        result.put("page", page != null ? page : 1);
        result.put("limit", limit != null ? limit : 10);
        return result;
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean cancelOrder(String orderNo, Long userId) {
        Order order = getByOrderNoAndUserId(orderNo, userId);
        if (order != null && order.getStatus() == 0) {
            order.setStatus(-1); // å–æ¶ˆçŠ¶æ€?            order.setUpdateTime(new Date());
            return this.updateById(order);
        }
        return false;
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    // æ ‡è®°ä¸ºéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡æ”¯æŒ
    public Map<String, Object> payOrder(String orderNo, Integer payType, Long userId) {
        // ç®€åŒ–å®ç°ï¼Œé¿å…ä¾èµ–é—®é¢˜
        log.info("æ”¯ä»˜è®¢å•: {}, ç”¨æˆ·ID: {}", orderNo, userId);
        Map<String, Object> result = new HashMap<>();
        result.put("success", true);
        result.put("orderNo", orderNo);
        result.put("message", "æ”¯ä»˜å¤„ç†ä¸?);
        return result;
    }
    
    /**
     * è®¡ç®—è®¢å•æ€»é‡‘é¢?     * @param items è®¢å•å•†å“åˆ—è¡¨
     * @return æ€»é‡‘é¢?     */
    private BigDecimal calculateTotalAmount(List<Map<String, Object>> items) {
        BigDecimal total = BigDecimal.ZERO;
        for (Map<String, Object> item : items) {
            // ç®€åŒ–å®ç?            total = total.add(new BigDecimal(100));
        }
        return total;
    }
    
    @Override
    public List<Order> getPendingOrders() {
        // ç®€åŒ–å®ç?        return new ArrayList<>();
    }
    
    @Override
    public Order getByOrderNoAndUserId(String orderNo, Long userId) {
        LambdaQueryWrapper<Order> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(Order::getOrderNo, orderNo);
        queryWrapper.eq(Order::getUserId, userId);
        return this.getOne(queryWrapper);
    }
    
    /**
     * ç”Ÿæˆè®¢å•å?     */
    private String generateOrderNo() {
        String timestamp = String.valueOf(System.currentTimeMillis());
        return "ORDER" + timestamp;
    }
}
package com.heikeji.mall.order.util;

import org.springframework.stereotype.Component;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Random;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * ç»Ÿä¸€è®¢å•å·ç”Ÿæˆå™¨
 * ç”Ÿæˆæ ¼å¼ï¼šyyyyMMddHHmmss + 4ä½éšæœºæ•° + 3ä½åºåˆ—å·
 */
@Component
public class OrderNoGenerator {

    private static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat("yyyyMMddHHmmss");
    private static final Random RANDOM = new Random();
    private static final AtomicInteger SEQUENCE = new AtomicInteger(0);
    private static String lastTimeStr = "";
    private static final Object LOCK = new Object();

    /**
     * ç”Ÿæˆè®¢å•å?     * @return å”¯ä¸€è®¢å•å?     */
    public String generateOrderNo() {
        synchronized (LOCK) {
            String currentTimeStr = DATE_FORMAT.format(new Date());
            int randomNum = RANDOM.nextInt(10000);
            String randomStr = String.format("%04d", randomNum);
            
            // å¦‚æœæ˜¯åŒä¸€æ—¶é—´æˆ³ï¼Œåºåˆ—å·è‡ªå¢ï¼Œå¦åˆ™é‡ç½®ä¸?
            if (!currentTimeStr.equals(lastTimeStr)) {
                SEQUENCE.set(0);
                lastTimeStr = currentTimeStr;
            }
            
            // åºåˆ—å·å–æ¨¡ç¡®ä¿ä¸è¶…è¿‡3ä½?            int sequenceNum = SEQUENCE.getAndIncrement() % 1000;
            String sequenceStr = String.format("%03d", sequenceNum);
            
            return currentTimeStr + randomStr + sequenceStr;
        }
    }
    
    /**
     * ç”Ÿæˆå¸¦å‰ç¼€çš„è®¢å•å·
     * @param prefix è®¢å•å‰ç¼€ï¼ˆå¦‚ï¼šP-æ™®é€šè®¢å•ï¼ŒD-é…é€è®¢å•ï¼ŒT-å¤–å–è®¢å•ï¼?     * @return å¸¦å‰ç¼€çš„è®¢å•å·
     */
    public String generateOrderNoWithPrefix(String prefix) {
        return prefix + "-" + generateOrderNo();
    }
}
package com.heikeji.mall.payment;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * æ”¯ä»˜æœåŠ¡ä¸»åº”ç”? */
@SpringBootApplication(scanBasePackages = {"com.heikeji.mall.payment", "com.heikeji.common.core"})
public class PaymentApplication {

    public static void main(String[] args) {
        SpringApplication.run(PaymentApplication.class, args);
    }

}
package com.heikeji.mall.payment.config;

import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis Plus é…ç½®ç±? */
@Configuration
public class MyBatisPlusConfig {

    /**
     * åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        return interceptor;
    }
}
package com.heikeji.mall.payment.constants;

/**
 * æ”¯ä»˜ç›¸å…³å¸¸é‡
 */
public class PaymentConstants {
    
    /**
     * æ”¯ä»˜çŠ¶æ€?     */
    public static final class PAYMENT_STATUS {
        // å¾…æ”¯ä»?        public static final Integer WAITING = 0;
        // å·²æ”¯ä»?        public static final Integer PAID = 1;
        // å·²é€€æ¬?        public static final Integer REFUNDED = 2;
    }
    
    /**
     * æ”¯ä»˜æ–¹å¼
     */
    public static final class PAYMENT_TYPE {
        // å¾®ä¿¡æ”¯ä»˜
        public static final Integer WECHAT_PAY = 1;
        // ä½™é¢æ”¯ä»˜
        public static final Integer BALANCE_PAY = 2;
    }
    
    /**
     * å¾®ä¿¡æ”¯ä»˜ç›¸å…³å¸¸é‡
     */
    public static final class WECHAT_PAY {
        // äº¤æ˜“ç±»å‹ - JSAPIæ”¯ä»˜
        public static final String TRADE_TYPE_JSAPI = "JSAPI";
        // äº¤æ˜“ç±»å‹ - NATIVEæ”¯ä»˜
        public static final String TRADE_TYPE_NATIVE = "NATIVE";
        // äº¤æ˜“ç±»å‹ - APPæ”¯ä»˜
        public static final String TRADE_TYPE_APP = "APP";
        // æˆåŠŸçŠ¶æ€ç 
        public static final String SUCCESS_CODE = "SUCCESS";
        // å¤±è´¥çŠ¶æ€ç 
        public static final String FAIL_CODE = "FAIL";
    }
}
package com.heikeji.mall.payment.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.payment.entity.Payment;
import com.heikeji.mall.payment.service.PaymentService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.Map;

/**
 * æ”¯ä»˜æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/payment")
@Api(tags = "æ”¯ä»˜ç®¡ç†")
public class PaymentController {

    @Autowired
    private PaymentService paymentService;

    /**
     * ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜å‚æ•°
     */
    @GetMapping("/wechat/{paymentId}")
    @ApiOperation("ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜å‚æ•°")
    public R<Map<String, Object>> generateWechatPayParams(@PathVariable Long paymentId) {
        Map<String, Object> payParams = paymentService.generateWechatPayParams(paymentId);
        return R.success(payParams);
    }

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?     */
    @GetMapping("/status/{orderNo}")
    @ApiOperation("æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?)
    public R<Integer> queryPaymentStatus(@PathVariable String orderNo) {
        Integer status = paymentService.queryPaymentStatus(orderNo);
        return R.success(status);
    }

    /**
     * é€€æ¬?     */
    @PostMapping("/refund")
    @ApiOperation("é€€æ¬?)
    public R<Boolean> refund(@RequestParam String orderNo, @RequestParam BigDecimal refundAmount) {
        boolean result = paymentService.refund(orderNo, refundAmount);
        return R.success(result);
    }

    /**
     * å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ
     * æ³¨æ„ï¼šå®é™…é¡¹ç›®ä¸­éœ€è¦ä½¿ç”¨@RequestBodyæ¥æ”¶XMLæ ¼å¼çš„å›è°ƒæ•°æ?     */
    @PostMapping("/notify/wechat")
    @ApiOperation("å¾®ä¿¡æ”¯ä»˜å›è°ƒ")
    public String processWechatPayNotify(@RequestBody Map<String, String> notifyData) {
        boolean result = paymentService.processWechatPayNotify(notifyData);
        return result ? "<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>" : 
               "<xml><return_code><![CDATA[FAIL]]></return_code><return_msg><![CDATA[å¤„ç†å¤±è´¥]]></return_msg></xml>";
    }
    
    /**
     * ä½™é¢æ”¯ä»˜
     */
    @PostMapping("/balance/pay")
    @ApiOperation("ä½™é¢æ”¯ä»˜")
    public R<Boolean> balancePay(@RequestParam Long paymentId) {
        boolean result = paymentService.balancePay(paymentId);
        return R.success(result);
    }
    
    /**
     * åˆ›å»ºå……å€¼è®¢å?     */
    @PostMapping("/recharge")
    @ApiOperation("åˆ›å»ºå……å€¼è®¢å?)
    public R<Payment> recharge(@RequestParam BigDecimal amount, @RequestParam Integer paymentType) {
        Payment payment = paymentService.recharge(amount, paymentType);
        return R.success(payment);
    }
    
    /**
     * è·å–æ”¯ä»˜è®°å½•åˆ—è¡¨
     */
    @GetMapping("/list")
    @ApiOperation("è·å–æ”¯ä»˜è®°å½•åˆ—è¡¨")
    public R<Map<String, Object>> getPaymentList(@RequestParam(defaultValue = "1") Integer page, 
                                               @RequestParam(defaultValue = "10") Integer size) {
        Map<String, Object> paymentList = paymentService.getPaymentList(page, size);
        return R.success(paymentList);
    }
}
package com.heikeji.mall.payment.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * æ”¯ä»˜è®°å½•è¡¨å®ä½“ç±»
 */
@Data
@TableName("payment")
public class Payment implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * æ”¯ä»˜è®°å½•ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * è®¢å•ID
     */
    private Long orderId;

    /**
     * è®¢å•å?     */
    private String orderNo;

    /**
     * æ”¯ä»˜æµæ°´å?     */
    private String paymentNo;

    /**
     * æ”¯ä»˜æ–¹å¼ï¼?-å¾®ä¿¡æ”¯ä»˜ï¼?-ä½™é¢æ”¯ä»˜
     */
    private Integer paymentType;

    /**
     * æ”¯ä»˜é‡‘é¢
     */
    private BigDecimal amount;

    /**
     * æ”¯ä»˜çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æ”¯ä»˜ï¼Œ2-å·²é€€æ¬?     */
    private Integer status;

    /**
     * æ”¯ä»˜æ—¶é—´
     */
    private Date payTime;

    /**
     * å¾®ä¿¡äº¤æ˜“å?     */
    private String transactionId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;
    
    /**
     * ç‰ˆæœ¬å·ï¼Œç”¨äºä¹è§‚é”?     */
    @TableField("version")
    private Integer version;
}
package com.heikeji.mall.payment.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.payment.entity.Payment;
import org.apache.ibatis.annotations.Mapper;

/**
 * æ”¯ä»˜è®°å½•Mapperæ¥å£
 */
@Mapper
public interface PaymentMapper extends BaseMapper<Payment> {
    
    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢æ”¯ä»˜è®°å½?     * @param orderNo è®¢å•å?     * @return æ”¯ä»˜è®°å½•
     */
    Payment selectByOrderNo(String orderNo);
    
    /**
     * æ ¹æ®æ”¯ä»˜æµæ°´å·æŸ¥è¯¢æ”¯ä»˜è®°å½?     * @param paymentNo æ”¯ä»˜æµæ°´å?     * @return æ”¯ä»˜è®°å½•
     */
    Payment selectByPaymentNo(String paymentNo);
}
package com.heikeji.mall.payment.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.payment.entity.Payment;

import java.math.BigDecimal;
import java.util.Map;

/**
 * æ”¯ä»˜æœåŠ¡æ¥å£
 */
public interface PaymentService extends IService<Payment> {
    
    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     * @param orderId è®¢å•ID
     * @param orderNo è®¢å•å?     * @param amount æ”¯ä»˜é‡‘é¢
     * @param paymentType æ”¯ä»˜æ–¹å¼
     * @return æ”¯ä»˜è®¢å•
     */
    Payment createPayment(Long orderId, String orderNo, BigDecimal amount, Integer paymentType);
    
    /**
     * ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜å‚æ•°
     * @param paymentId æ”¯ä»˜è®¢å•ID
     * @return å¾®ä¿¡æ”¯ä»˜å‚æ•°
     */
    Map<String, Object> generateWechatPayParams(Long paymentId);
    
    /**
     * å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ
     * @param notifyData å›è°ƒæ•°æ®
     * @return å¤„ç†ç»“æœ
     */
    boolean processWechatPayNotify(Map<String, String> notifyData);
    
    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?     * @param orderNo è®¢å•å?     * @return æ”¯ä»˜çŠ¶æ€?     */
    Integer queryPaymentStatus(String orderNo);
    
    /**
     * é€€æ¬?     * @param orderNo è®¢å•å?     * @param refundAmount é€€æ¬¾é‡‘é¢?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean refund(String orderNo, BigDecimal refundAmount);
    
    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢æ”¯ä»˜è®°å½?     * @param orderNo è®¢å•å?     * @return æ”¯ä»˜è®°å½•
     */
    Payment getByOrderNo(String orderNo);
    
    /**
     * ä½™é¢æ”¯ä»˜
     * @param paymentId æ”¯ä»˜ID
     * @return æ˜¯å¦æ”¯ä»˜æˆåŠŸ
     */
    boolean balancePay(Long paymentId);
    
    /**
     * å……å€?     * @param amount å……å€¼é‡‘é¢?     * @param paymentType æ”¯ä»˜æ–¹å¼
     * @return æ”¯ä»˜è®¢å•
     */
    Payment recharge(BigDecimal amount, Integer paymentType);
    
    /**
     * è·å–æ”¯ä»˜è®°å½•åˆ—è¡¨
     * @param page é¡µç 
     * @param size æ¯é¡µå¤§å°
     * @return æ”¯ä»˜è®°å½•åˆ—è¡¨
     */
    Map<String, Object> getPaymentList(Integer page, Integer size);
}
package com.heikeji.mall.payment.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.payment.entity.Payment;
import com.heikeji.mall.payment.mapper.PaymentMapper;
import com.heikeji.mall.payment.service.PaymentService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.client.RestTemplate;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Random;
import org.springframework.http.ResponseEntity;

/**
 * æ”¯ä»˜æœåŠ¡å®ç°ç±? */
@Slf4j
@Service
public class PaymentServiceImpl extends ServiceImpl<PaymentMapper, Payment> implements PaymentService {

    @Autowired
    private PaymentMapper paymentMapper;
    
    @Autowired
    private RestTemplate restTemplate;

    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Payment createPayment(Long orderId, String orderNo, BigDecimal amount, Integer paymentType) {
        // ç”Ÿæˆæ”¯ä»˜è®¢å•å?        String paymentNo = generatePaymentNo();
        
        Payment payment = new Payment();
        payment.setOrderId(orderId);
        payment.setOrderNo(orderNo);
        payment.setPaymentNo(paymentNo);
        payment.setPaymentType(paymentType);
        payment.setAmount(amount);
        payment.setStatus(0); // å¾…æ”¯ä»?        payment.setCreateTime(new Date());
        payment.setUpdateTime(new Date());
        
        this.save(payment);
        return payment;
    }

    /**
     * ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜å‚æ•°
     */
    @Override
    public Map<String, Object> generateWechatPayParams(Long paymentId) {
        Payment payment = this.getById(paymentId);
        if (payment == null) {
            throw new RuntimeException("æ”¯ä»˜è®¢å•ä¸å­˜åœ?);
        }
        
        // æ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜å‚æ•°ï¼Œå®é™…éœ€è¦è°ƒç”¨å¾®ä¿¡æ”¯ä»˜SDK
        Map<String, Object> payParams = new HashMap<>();
        payParams.put("appid", "wx_appid");
        payParams.put("partnerid", "wx_mch_id");
        payParams.put("prepayid", "wx_prepay_id_" + System.currentTimeMillis());
        payParams.put("package", "Sign=WXPay");
        payParams.put("noncestr", generateNonceStr());
        payParams.put("timestamp", String.valueOf(System.currentTimeMillis() / 1000));
        payParams.put("sign", generateSign(payParams));
        
        return payParams;
    }

    /**
     * å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒ
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean processWechatPayNotify(Map<String, String> notifyData) {
        // éªŒè¯ç­¾å
        if (!verifySign(notifyData)) {
            log.error("å¾®ä¿¡æ”¯ä»˜å›è°ƒç­¾åéªŒè¯å¤±è´¥");
            return false;
        }
        
        String orderNo = notifyData.get("out_trade_no");
        String transactionId = notifyData.get("transaction_id");
        
        // æ›´æ–°æ”¯ä»˜çŠ¶æ€?        Payment payment = paymentMapper.selectByOrderNo(orderNo);
        if (payment != null && payment.getStatus() == 0) {
            // ä½¿ç”¨ä¹è§‚é”æ›´æ–°æ”¯ä»˜çŠ¶æ€?            Integer currentVersion = payment.getVersion() != null ? payment.getVersion() : 0;
            
            // æ„å»ºæ›´æ–°æ¡ä»¶ï¼ŒåŒ…å«ç‰ˆæœ¬å·
            QueryWrapper<Payment> updateWrapper = new QueryWrapper<>();
            updateWrapper.eq("id", payment.getId())
                       .eq("version", currentVersion)
                       .eq("status", 0); // å†æ¬¡æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼Œç¡®ä¿æ˜¯å¾…æ”¯ä»˜çŠ¶æ€?            
            // æ„å»ºæ›´æ–°å¯¹è±¡
            Payment updatePayment = new Payment();
            updatePayment.setStatus(1); // å·²æ”¯ä»?            updatePayment.setPayTime(new Date());
            updatePayment.setTransactionId(transactionId);
            updatePayment.setUpdateTime(new Date());
            updatePayment.setVersion(currentVersion + 1);
            
            // æ‰§è¡Œæ›´æ–°æ“ä½œ
            boolean result = this.update(updatePayment, updateWrapper);
            
            if (!result) {
                // æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å¹¶å‘å†²çª?                log.error("æ›´æ–°æ”¯ä»˜çŠ¶æ€å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å¹¶å‘å†²çªï¼Œè®¢å•å·ï¼š{}ï¼Œå½“å‰ç‰ˆæœ¬ï¼š{}", orderNo, currentVersion);
                return false;
            }
            
            return true;
        }
        
        return false;
    }

    /**
     * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€?     */
    @Override
    public Integer queryPaymentStatus(String orderNo) {
        Payment payment = paymentMapper.selectByOrderNo(orderNo);
        return payment != null ? payment.getStatus() : null;
    }

    /**
     * é€€æ¬?     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean refund(String orderNo, BigDecimal refundAmount) {
        Payment payment = paymentMapper.selectByOrderNo(orderNo);
        if (payment == null || payment.getStatus() != 1) {
            throw new RuntimeException("è®¢å•æœªæ”¯ä»˜æˆ–æ”¯ä»˜è®°å½•ä¸å­˜åœ?);
        }
        
        // æ¨¡æ‹Ÿé€€æ¬¾é€»è¾‘ï¼Œå®é™…éœ€è¦è°ƒç”¨å¾®ä¿¡é€€æ¬¾æ¥å?        payment.setStatus(2); // å·²é€€æ¬?        payment.setUpdateTime(new Date());
        
        return this.updateById(payment);
    }

    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢æ”¯ä»˜è®°å½?     */
    @Override
    public Payment getByOrderNo(String orderNo) {
        return paymentMapper.selectByOrderNo(orderNo);
    }
    
    /**
     * ä½™é¢æ”¯ä»˜
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean balancePay(Long paymentId) {
        // 1. æ£€æŸ¥æ”¯ä»˜è®°å½?        Payment payment = this.getById(paymentId);
        if (payment == null || payment.getStatus() != 0) {
            log.error("æ”¯ä»˜è®°å½•æ— æ•ˆæˆ–å·²æ”¯ä»˜: paymentId={}", paymentId);
            return false;
        }
        
        // 2. ä»è®¢å•ä¿¡æ¯ä¸­è·å–ç”¨æˆ·ID
        // æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨è®¢å•æœåŠ¡è·å–ç”¨æˆ·ID
        // è¿™é‡Œæš‚æ—¶ä¿æŒç®€å•å®ç°ï¼Œä½†ç§»é™¤ç¡¬ç¼–ç 
        Long userId = getUserIdFromOrder(payment.getOrderNo());
        if (userId == null) {
            log.error("æ— æ³•è·å–è®¢å•å¯¹åº”çš„ç”¨æˆ·ID: orderNo={}", payment.getOrderNo());
            return false;
        }
        boolean hasEnoughBalance = false;
        try {
            // è°ƒç”¨ç”¨æˆ·æœåŠ¡APIæ£€æŸ¥ä½™é¢?            String checkBalanceUrl = "http://service-user/api/user/balance/check?userId=" + userId + "&amount=" + payment.getAmount();
            ResponseEntity<Map> response = restTemplate.getForEntity(checkBalanceUrl, Map.class);
            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                hasEnoughBalance = Boolean.TRUE.equals(response.getBody().get("hasEnough"));
            }
        } catch (Exception e) {
            log.error("è°ƒç”¨ç”¨æˆ·æœåŠ¡æ£€æŸ¥ä½™é¢å¤±è´? userId={}, amount={}", userId, payment.getAmount(), e);
            return false;
        }
        
        if (!hasEnoughBalance) {
            log.error("ç”¨æˆ·ä½™é¢ä¸è¶³: userId={}, required={}", userId, payment.getAmount());
            return false;
        }
        
        // 3. è°ƒç”¨ç”¨æˆ·æœåŠ¡æ‰£å‡ä½™é¢
        try {
            // è°ƒç”¨ç”¨æˆ·æœåŠ¡APIæ‰£å‡ä½™é¢
            String deductUrl = "http://service-user/api/user/balance/deduct/" + userId;
            Map<String, Object> requestBody = new HashMap<>();
            requestBody.put("amount", payment.getAmount());
            // ä½¿ç”¨exchangeæ–¹æ³•æ›¿ä»£putForEntityï¼Œæ›´å…¼å®¹
            ResponseEntity<Map> response = restTemplate.exchange(
                deductUrl,
                org.springframework.http.HttpMethod.PUT,
                new org.springframework.http.HttpEntity<>(requestBody),
                Map.class
            );
            if (!response.getStatusCode().is2xxSuccessful() || response.getBody() == null) {
                log.error("è°ƒç”¨ç”¨æˆ·æœåŠ¡æ‰£å‡ä½™é¢å¤±è´¥: userId={}, amount={}", userId, payment.getAmount());
                return false;
            }
        } catch (Exception e) {
            log.error("è°ƒç”¨ç”¨æˆ·æœåŠ¡æ‰£å‡ä½™é¢å¼‚å¸¸: userId={}, amount={}", userId, payment.getAmount(), e);
            return false;
        }
        
        // 4. æ›´æ–°æ”¯ä»˜çŠ¶æ€ä¸ºå·²æ”¯ä»?        payment.setStatus(1);
        payment.setPayTime(new Date());
        payment.setUpdateTime(new Date());
        
        boolean updateResult = this.updateById(payment);
        
        if (updateResult) {
            log.info("ä½™é¢æ”¯ä»˜æˆåŠŸ: paymentId={}, amount={}", paymentId, payment.getAmount());
        } else {
            log.error("æ›´æ–°æ”¯ä»˜çŠ¶æ€å¤±è´? paymentId={}", paymentId);
        }
        
        return updateResult;
    }
    
    /**
     * ä»è®¢å•å·è·å–ç”¨æˆ·ID
     * å®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨è®¢å•æœåŠ¡è·å?     */
    private Long getUserIdFromOrder(String orderNo) {
        try {
            // å®é™…åº”ç”¨ä¸­åº”è¯¥è°ƒç”¨è®¢å•æœåŠ¡APIè·å–ç”¨æˆ·ID
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾å¯ä»¥é€šè¿‡è®¢å•æœåŠ¡è·å–ç”¨æˆ·ID
            String getUserUrl = "http://service-order/api/order/getUserIdByOrderNo?orderNo=" + orderNo;
            ResponseEntity<Map> response = restTemplate.getForEntity(getUserUrl, Map.class);
            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                return Long.valueOf(response.getBody().get("userId").toString());
            }
        } catch (Exception e) {
            log.error("è°ƒç”¨è®¢å•æœåŠ¡è·å–ç”¨æˆ·IDå¤±è´¥: orderNo={}", orderNo, e);
        }
        // é™çº§å¤„ç†ï¼šå¦‚æœæ— æ³•è·å–ç”¨æˆ·IDï¼Œè¿”å›null
        return null;
    }
    
    /**
     * å……å€?     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Payment recharge(BigDecimal amount, Integer paymentType) {
        // ç”Ÿæˆå……å€¼è®¢å•å·
        String rechargeNo = generateRechargeNo();
        
        Payment payment = new Payment();
        payment.setOrderId(0L); // å……å€¼è®¢å•IDä¸?
        payment.setOrderNo(rechargeNo);
        payment.setPaymentNo(generatePaymentNo());
        payment.setPaymentType(paymentType);
        payment.setAmount(amount);
        payment.setStatus(0); // å¾…æ”¯ä»?        payment.setCreateTime(new Date());
        payment.setUpdateTime(new Date());
        
        this.save(payment);
        return payment;
    }
    
    /**
     * è·å–æ”¯ä»˜è®°å½•åˆ—è¡¨
     */
    @Override
    public Map<String, Object> getPaymentList(Integer page, Integer size) {
        // ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦å…³è”æŸ¥è¯¢ç”¨æˆ·çš„è®¢å•
        Page<Payment> paymentPage = new Page<>(page, size);
        
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢å…¶ç›¸å…³çš„æ”¯ä»˜è®°å½•
        QueryWrapper<Payment> queryWrapper = new QueryWrapper<>();
        queryWrapper.orderByDesc("create_time");
        
        Page<Payment> result = this.page(paymentPage, queryWrapper);
        
        Map<String, Object> response = new HashMap<>();
        response.put("records", result.getRecords());
        response.put("total", result.getTotal());
        response.put("pages", result.getPages());
        response.put("current", result.getCurrent());
        response.put("size", result.getSize());
        
        return response;
    }
    
    /**
     * ç”Ÿæˆå……å€¼è®¢å•å·
     */
    private String generateRechargeNo() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");
        String dateStr = sdf.format(new Date());
        String randomStr = String.format("%06d", new Random().nextInt(1000000));
        return "RCG" + dateStr + randomStr;
    }

    /**
     * ç”Ÿæˆæ”¯ä»˜æµæ°´å?     */
    private String generatePaymentNo() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");
        String dateStr = sdf.format(new Date());
        String randomStr = String.format("%06d", new Random().nextInt(1000000));
        return "PAY" + dateStr + randomStr;
    }

    /**
     * ç”Ÿæˆéšæœºå­—ç¬¦ä¸?     */
    private String generateNonceStr() {
        String chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        StringBuilder sb = new StringBuilder();
        Random random = new Random();
        for (int i = 0; i < 32; i++) {
            sb.append(chars.charAt(random.nextInt(chars.length())));
        }
        return sb.toString();
    }

    /**
     * ç”Ÿæˆç­¾å
     */
    private String generateSign(Map<String, Object> params) {
        // ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦æŒ‰ç…§å¾®ä¿¡æ”¯ä»˜è¦æ±‚ç”Ÿæˆç­¾å?        return "sign_" + System.currentTimeMillis();
    }

    /**
     * éªŒè¯ç­¾å
     */
    private boolean verifySign(Map<String, String> notifyData) {
        // ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦æŒ‰ç…§å¾®ä¿¡æ”¯ä»˜è¦æ±‚éªŒè¯ç­¾å?        return true;
    }
}
package com.heikeji.mall.payment.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.payment.entity.Payment;
import com.heikeji.mall.payment.service.PaymentService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.Map;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * PaymentControllerå•å…ƒæµ‹è¯•
 */
@ExtendWith(MockitoExtension.class)
public class PaymentControllerTest {

    private MockMvc mockMvc;

    @Mock
    private PaymentService paymentService;

    @InjectMocks
    private PaymentController paymentController;

    @BeforeEach
    public void setup() {
        mockMvc = MockMvcBuilders.standaloneSetup(paymentController).build();
    }

    @Test
    public void testGenerateWechatPayParams_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long paymentId = 1L;
        Map<String, Object> payParams = new HashMap<>();
        payParams.put("appId", "wx123456");
        payParams.put("timeStamp", "1625184000");
        payParams.put("nonceStr", "abc123");
        payParams.put("package", "prepay_id=wx123456");
        payParams.put("signType", "RSA");
        payParams.put("paySign", "xyz789");
        
        when(paymentService.generateWechatPayParams(eq(paymentId))).thenReturn(payParams);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/payment/wechat/{paymentId}", paymentId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.appId").value("wx123456"))
                .andExpect(jsonPath("$.data.timeStamp").value("1625184000"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).generateWechatPayParams(paymentId);
    }

    @Test
    public void testGenerateWechatPayParams_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long paymentId = 1L;
        when(paymentService.generateWechatPayParams(eq(paymentId))).thenReturn(new HashMap<>());

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/payment/wechat/{paymentId}", paymentId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).generateWechatPayParams(paymentId);
    }

    @Test
    public void testQueryPaymentStatus_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String orderNo = "ORDER123";
        Integer status = 1;
        when(paymentService.queryPaymentStatus(orderNo)).thenReturn(status);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/payment/status/{orderNo}", orderNo))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(1));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).queryPaymentStatus(orderNo);
    }

    @Test
    public void testRefund_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String orderNo = "ORDER123";
        BigDecimal refundAmount = new BigDecimal("100.00");
        when(paymentService.refund(eq(orderNo), eq(refundAmount))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/payment/refund")
                .param("orderNo", orderNo)
                .param("refundAmount", refundAmount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).refund(orderNo, refundAmount);
    }

    @Test
    public void testRefund_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String orderNo = "ORDER123";
        BigDecimal refundAmount = new BigDecimal("100.00");
        when(paymentService.refund(eq(orderNo), eq(refundAmount))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/payment/refund")
                .param("orderNo", orderNo)
                .param("refundAmount", refundAmount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).refund(orderNo, refundAmount);
    }

    @Test
    public void testBalancePay_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long paymentId = 1L;
        when(paymentService.balancePay(eq(paymentId))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/payment/balance/pay")
                .param("paymentId", paymentId.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).balancePay(paymentId);
    }

    @Test
    public void testBalancePay_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long paymentId = 1L;
        when(paymentService.balancePay(eq(paymentId))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/payment/balance/pay")
                .param("paymentId", paymentId.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).balancePay(paymentId);
    }

    @Test
    public void testRecharge_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        BigDecimal amount = new BigDecimal("100.00");
        Integer paymentType = 1;
        Payment payment = new Payment();
        payment.setId(1L);
        payment.setAmount(amount);
        
        when(paymentService.recharge(eq(amount), eq(paymentType))).thenReturn(payment);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/payment/recharge")
                .param("amount", amount.toString())
                .param("paymentType", paymentType.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.amount").value(100.00));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).recharge(amount, paymentType);
    }

    @Test
    public void testRecharge_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        BigDecimal amount = new BigDecimal("100.00");
        Integer paymentType = 1;
        when(paymentService.recharge(eq(amount), eq(paymentType))).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/payment/recharge")
                .param("amount", amount.toString())
                .param("paymentType", paymentType.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).recharge(amount, paymentType);
    }

    @Test
    public void testGetPaymentList_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Integer page = 1;
        Integer size = 10;
        Map<String, Object> paymentList = new HashMap<>();
        paymentList.put("records", java.util.Collections.singletonList(new Payment()));
        paymentList.put("total", 1L);
        
        when(paymentService.getPaymentList(eq(page), eq(size))).thenReturn(paymentList);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/payment/list")
                .param("page", page.toString())
                .param("size", size.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").isMap());

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).getPaymentList(page, size);
    }

    @Test
    public void testGetPaymentList_Empty() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Integer page = 1;
        Integer size = 10;
        Map<String, Object> paymentList = new HashMap<>();
        paymentList.put("records", java.util.Collections.emptyList());
        paymentList.put("total", 0L);
        
        when(paymentService.getPaymentList(eq(page), eq(size))).thenReturn(paymentList);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/payment/list")
                .param("page", page.toString())
                .param("size", size.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").isMap());

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(paymentService).getPaymentList(page, size);
    }
}
package com.heikeji.mall.product;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

/**
 * å•†å“æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication
@ComponentScan({
    "com.heikeji.mall.product",
    "com.heikeji.common.core"
})
@MapperScan("com.heikeji.mall.product.mapper")
public class ProductApplication {

    public static void main(String[] args) {
        SpringApplication.run(ProductApplication.class, args);
    }
}
package com.heikeji.mall.product.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis Plusé…ç½®ç±? */
@Configuration
public class MyBatisPlusConfig {

    /**
     * é…ç½®åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // æ·»åŠ åˆ†é¡µæ’ä»¶ï¼ŒæŒ‡å®šæ•°æ®åº“ç±»å‹ä¸ºMySQL
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
package com.heikeji.mall.product.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.product.entity.Cart;
import com.heikeji.mall.product.service.CartService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * è´­ç‰©è½¦æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/cart")
@Api(tags = "è´­ç‰©è½¦ç®¡ç?)
public class CartController {

    @Autowired
    private CartService cartService;

    /**
     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
     */
    @PostMapping
    @ApiOperation("æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦")
    public R<Cart> addToCart(@RequestParam Long userId, @RequestParam Long productId, @RequestParam Integer quantity) {
        Cart cart = cartService.addToCart(userId, productId, quantity);
        return R.success(cart);
    }

    /**
     * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @PutMapping("/quantity")
    @ApiOperation("æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?)
    public R<Boolean> updateQuantity(@RequestParam Long userId, @RequestParam Long productId, @RequestParam Integer quantity) {
        boolean result = cartService.updateCartQuantity(userId, productId, quantity);
        return R.success(result);
    }

    /**
     * ä»è´­ç‰©è½¦åˆ é™¤å•†å“
     */
    @DeleteMapping("/{productId}")
    @ApiOperation("åˆ é™¤è´­ç‰©è½¦å•†å“?)
    public R<Boolean> removeFromCart(@PathVariable Long productId, @RequestParam Long userId) {
        boolean result = cartService.removeFromCart(userId, productId);
        return R.success(result);
    }

    /**
     * æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“?     */
    @DeleteMapping("/batch")
    @ApiOperation("æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“?)
    public R<Boolean> removeBatchFromCart(@RequestBody List<Long> productIds, @RequestParam Long userId) {
        boolean result = cartService.removeBatchFromCart(userId, productIds);
        return R.success(result);
    }

    /**
     * æ¸…ç©ºè´­ç‰©è½?     */
    @DeleteMapping
    @ApiOperation("æ¸…ç©ºè´­ç‰©è½?)
    public R<Boolean> clearCart(@RequestParam Long userId) {
        boolean result = cartService.clearCart(userId);
        return R.success(result);
    }

    /**
     * è·å–ç”¨æˆ·è´­ç‰©è½¦åˆ—è¡?     */
    @GetMapping
    @ApiOperation("è·å–è´­ç‰©è½¦åˆ—è¡?)
    public R<List<Cart>> getCartList(@RequestParam Long userId) {
        List<Cart> cartList = cartService.getUserCartList(userId);
        return R.success(cartList);
    }

    /**
     * è·å–è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @GetMapping("/count")
    @ApiOperation("è·å–è´­ç‰©è½¦å•†å“æ•°é‡?)
    public R<Integer> getCartItemCount(@RequestParam Long userId) {
        Integer count = cartService.getCartItemCount(userId);
        return R.success(count);
    }

    /**
     * æ£€æŸ¥è´­ç‰©è½¦å•†å“åº“å­˜
     */
    @GetMapping("/check-stock")
    @ApiOperation("æ£€æŸ¥è´­ç‰©è½¦å•†å“åº“å­˜")
    public R<List<String>> checkCartStock(@RequestParam Long userId) {
        List<String> outOfStockItems = cartService.checkCartStock(userId);
        return R.success(outOfStockItems);
    }
}
package com.heikeji.mall.product.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.product.entity.Category;
import com.heikeji.mall.product.service.CategoryService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å•†å“åˆ†ç±»æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/category")
@Api(tags = "å•†å“åˆ†ç±»ç®¡ç†")
public class CategoryController {

    @Autowired
    private CategoryService categoryService;

    /**
     * è·å–æ‰€æœ‰åˆ†ç±»åˆ—è¡¨ï¼ˆæŒ‰æ’åºå­—æ®µæ’åºï¼‰
     */
    @GetMapping
    @ApiOperation("è·å–æ‰€æœ‰åˆ†ç±»åˆ—è¡?)
    public R<List<Category>> getAllCategories() {
        List<Category> categories = categoryService.getCategoriesBySort();
        return R.success(categories);
    }

    /**
     * è·å–åˆ†ç±»æ ‘ç»“æ?     */
    @GetMapping("/tree")
    @ApiOperation("è·å–åˆ†ç±»æ ‘ç»“æ?)
    public R<List<Category>> getCategoryTree() {
        // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦å®ç°æ ‘ç»“æ„çš„é€»è¾‘
        List<Category> categories = categoryService.getCategoriesBySort();
        return R.success(categories);
    }

    /**
     * æ ¹æ®çˆ¶åˆ†ç±»IDè·å–å­åˆ†ç±?     */
    @GetMapping("/parent/{parentId}")
    @ApiOperation("è·å–å­åˆ†ç±?)
    public R<List<Category>> getCategoriesByParentId(@PathVariable Long parentId) {
        // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦å®ç°çˆ¶åˆ†ç±»æŸ¥è¯¢é€»è¾‘
        List<Category> categories = categoryService.getCategoriesBySort();
        return R.success(categories);
    }

    /**
     * è·å–å¯ç”¨çŠ¶æ€çš„åˆ†ç±»åˆ—è¡¨
     */
    @GetMapping("/enabled")
    @ApiOperation("è·å–å¯ç”¨çš„åˆ†ç±?)
    public R<List<Category>> getEnabledCategories() {
        List<Category> categories = categoryService.getEnabledCategories();
        return R.success(categories);
    }

    /**
     * æ ¹æ®IDè·å–åˆ†ç±»è¯¦æƒ…
     */
    @GetMapping("/{id}")
    @ApiOperation("è·å–åˆ†ç±»è¯¦æƒ…")
    public R<Category> getCategoryById(@PathVariable Long id) {
        Category category = categoryService.getById(id);
        return R.success(category);
    }

    /**
     * æ–°å¢åˆ†ç±»
     */
    @PostMapping
    @ApiOperation("æ–°å¢åˆ†ç±»")
    public R<Boolean> addCategory(@RequestBody Category category) {
        boolean result = categoryService.save(category);
        return R.success(result);
    }

    /**
     * æ›´æ–°åˆ†ç±»
     */
    @PutMapping
    @ApiOperation("æ›´æ–°åˆ†ç±»")
    public R<Boolean> updateCategory(@RequestBody Category category) {
        boolean result = categoryService.updateById(category);
        return R.success(result);
    }

    /**
     * å¯ç”¨åˆ†ç±»
     */
    @PutMapping("/enable/{id}")
    @ApiOperation("å¯ç”¨åˆ†ç±»")
    public R<Boolean> enableCategory(@PathVariable Long id) {
        boolean result = categoryService.enableCategory(id);
        return R.success(result);
    }
    
    /**
     * ç¦ç”¨åˆ†ç±»
     */
    @PutMapping("/disable/{id}")
    @ApiOperation("ç¦ç”¨åˆ†ç±»")
    public R<Boolean> disableCategory(@PathVariable Long id) {
        boolean result = categoryService.disableCategory(id);
        return R.success(result);
    }

    /**
     * åˆ é™¤åˆ†ç±»
     */
    @DeleteMapping("/{id}")
    @ApiOperation("åˆ é™¤åˆ†ç±»")
    public R<Boolean> deleteCategory(@PathVariable Long id) {
        boolean result = categoryService.removeById(id);
        return R.success(result);
    }
    
    /**
     * æ‰¹é‡åˆ é™¤åˆ†ç±»
     */
    @DeleteMapping("/batch")
    @ApiOperation("æ‰¹é‡åˆ é™¤åˆ†ç±»")
    public R<Boolean> deleteCategories(@RequestBody List<Long> ids) {
        boolean result = categoryService.removeByIds(ids);
        return R.success(result);
    }
}
package com.heikeji.mall.product.controller;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.common.core.annotation.RateLimiter;
import com.heikeji.common.core.domain.R;
import com.heikeji.mall.product.entity.Product;
import com.heikeji.mall.product.service.ProductService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å•†å“æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/product")
@Api(tags = "å•†å“ç®¡ç†")
public class ProductController {

    @Autowired
    private ProductService productService;

    /**
     * åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    @GetMapping("/page")
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨")
    @RateLimiter(timeWindow = 1, maxCount = 30)
    public R<Page<Product>> pageQuery(
            @RequestParam Integer pageNo,
            @RequestParam Integer pageSize,
            @RequestParam(required = false) String keyword,
            @RequestParam(required = false) Long categoryId,
            @RequestParam(required = false) Long merchantId,
            @RequestParam(required = false) Integer status) {
        Page<Product> page = new Page<>(pageNo, pageSize);
        Product product = new Product();
        product.setName(keyword);
        product.setCategoryId(categoryId);
        product.setMerchantId(merchantId);
        product.setStatus(status);
        Page<Product> result = productService.pageProduct(page, product);
        return R.success(result);
    }

    /**
     * æŸ¥è¯¢å•†å“è¯¦æƒ…
     */
    @GetMapping("/detail/{id}")
    @ApiOperation("æŸ¥è¯¢å•†å“è¯¦æƒ…")
    @RateLimiter(timeWindow = 1, maxCount = 50)
    public R<Product> getProductDetail(@PathVariable Long id) {
        Product product = productService.getById(id);
        return R.success(product);
    }

    /**
     * æ ¹æ®åˆ†ç±»IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    @GetMapping("/category/{categoryId}")
    @ApiOperation("æ ¹æ®åˆ†ç±»æŸ¥è¯¢å•†å“")
    @RateLimiter(timeWindow = 1, maxCount = 40)
    public R<List<Product>> getProductsByCategory(@PathVariable Long categoryId) {
        List<Product> products = productService.getByCategoryId(categoryId);
        return R.success(products);
    }

    /**
     * è·å–çƒ­é—¨å’Œæ–°å“å•†å“?     */
    @GetMapping("/hot")
    @ApiOperation("è·å–çƒ­é—¨å’Œæ–°å“å•†å“?)
    @RateLimiter(timeWindow = 1, maxCount = 30)
    public R<?> getHotProducts(@RequestParam(defaultValue = "10") Integer limit) {
        return R.success(productService.getHotProducts(limit));
    }

    /**
     * æ–°å¢å•†å“
     */
    @PostMapping
    @ApiOperation("æ–°å¢å•†å“")
    @RateLimiter(timeWindow = 1, maxCount = 10)
    public R<Boolean> addProduct(@RequestBody Product product) {
        product.setDelFlag(0);
        product.setStatus(0);
        boolean result = productService.save(product);
        return R.success(result);
    }

    /**
     * æ›´æ–°å•†å“ä¿¡æ¯
     */
    @PutMapping
    @ApiOperation("æ›´æ–°å•†å“ä¿¡æ¯")
    @RateLimiter(timeWindow = 1, maxCount = 10)
    public R<Boolean> updateProduct(@RequestBody Product product) {
        boolean result = productService.updateById(product);
        return R.success(result);
    }

    /**
     * å•†å“ä¸Šæ¶
     */
    @PutMapping("/putOn/{id}")
    @ApiOperation("å•†å“ä¸Šæ¶")
    @RateLimiter(timeWindow = 1, maxCount = 20)
    public R<Boolean> putOn(@PathVariable Long id) {
        boolean result = productService.putOn(id);
        return R.success(result);
    }
    
    /**
     * å•†å“ä¸‹æ¶
     */
    @PutMapping("/putOff/{id}")
    @ApiOperation("å•†å“ä¸‹æ¶")
    @RateLimiter(timeWindow = 1, maxCount = 20)
    public R<Boolean> putOff(@PathVariable Long id) {
        boolean result = productService.putOff(id);
        return R.success(result);
    }

    /**
     * åˆ é™¤å•†å“ï¼ˆé€»è¾‘åˆ é™¤ï¼?     */
    @DeleteMapping("/{id}")
    @ApiOperation("åˆ é™¤å•†å“")
    @RateLimiter(timeWindow = 1, maxCount = 10)
    public R<Boolean> deleteProduct(@PathVariable Long id) {
        Product product = new Product();
        product.setId(id);
        product.setDelFlag(1);
        boolean result = productService.updateById(product);
        return R.success(result);
    }

    /**
     * æ‰¹é‡åˆ é™¤å•†å“ï¼ˆé€»è¾‘åˆ é™¤ï¼?     */
    @DeleteMapping("/batch")
    @ApiOperation("æ‰¹é‡åˆ é™¤å•†å“")
    @RateLimiter(timeWindow = 1, maxCount = 5)
    public R<Boolean> deleteBatch(@RequestBody List<Long> ids) {
        for (Long id : ids) {
            Product product = new Product();
            product.setId(id);
            product.setDelFlag(1);
            productService.updateById(product);
        }
        return R.success(true);
    }
}
package com.heikeji.mall.product.dto;

import lombok.Data;

/**
 * åˆ†ç±»DTOç±? */
@Data
public class CategoryDTO {
    private Long id;
    private String name;
    private String icon;
    private Integer sortOrder;
    private Integer status;
    private String statusStr;
    
    // è¾…åŠ©æ–¹æ³•
    public String getStatusStr() {
        if (status == null) return "";
        switch (status) {
            case 0: return "ç¦ç”¨";
            case 1: return "å¯ç”¨";
            default: return "æœªçŸ¥";
        }
    }
}
package com.heikeji.mall.product.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.util.List;

/**
 * å•†å“DTOç±? */
@Data
public class ProductDTO {
    private Long id;
    private Long merchantId;
    private Long categoryId;
    private String name;
    private String subtitle;
    private String mainImage;
    private String images;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer stock;
    private Integer sales;
    private String detail;
    private Integer status;
    private Integer sortOrder;
    
    // æ‰©å±•å­—æ®µ
    private String merchantName;
    private String categoryName;
    private String statusStr;
    
    // è¾…åŠ©æ–¹æ³•
    public String getStatusStr() {
        if (status == null) return "";
        switch (status) {
            case 0: return "ä¸‹æ¶";
            case 1: return "ä¸Šæ¶";
            default: return "æœªçŸ¥";
        }
    }
}
package com.heikeji.mall.product.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.util.Date;

/**
 * è´­ç‰©è½¦å®ä½“ç±»
 */
@Data
@TableName("cart")
public class Cart {
    /**
     * è´­ç‰©è½¦ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;
    
    /**
     * ç”¨æˆ·ID
     */
    private Long userId;
    
    /**
     * å•†å“ID
     */
    private Long productId;
    
    /**
     * æ•°é‡
     */
    private Integer quantity;
    
    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;
    
    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;
}
package com.heikeji.mall.product.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.util.Date;

/**
 * å•†å“åˆ†ç±»å®ä½“ç±? */
@Data
@TableName("category")
public class Category {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String name;
    private String icon;
    private Integer sortOrder;
    private Integer status;
    private Date createTime;
    private Date updateTime;
    private Integer delFlag;
}
package com.heikeji.mall.product.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableField;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.math.BigDecimal;
import java.util.Date;

/**
 * å•†å“å®ä½“ç±? */
@Data
@TableName("product")
public class Product {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long merchantId;
    private Long categoryId;
    private String name;
    private String subtitle;
    private String mainImage;
    private String images;
    private BigDecimal price;
    private BigDecimal originalPrice;
    private Integer stock;
    private Integer sales;
    private String detail;
    private Integer status;
    private Integer sortOrder;
    private Date createTime;
    private Date updateTime;
    private Integer delFlag;
    @TableField("version")
    private Integer version;
}
package com.heikeji.mall.product.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.product.entity.Cart;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * è´­ç‰©è½¦Mapperæ¥å£
 */
public interface CartMapper extends BaseMapper<Cart> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDå’Œå•†å“IDæŸ¥è¯¢è´­ç‰©è½¦è®°å½?     * @param userId ç”¨æˆ·ID
     * @param productId å•†å“ID
     * @return è´­ç‰©è½¦è®°å½?     */
    Cart selectByUserIdAndProductId(@Param("userId") Long userId, @Param("productId") Long productId);
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è´­ç‰©è½¦åˆ—è¡?     * @param userId ç”¨æˆ·ID
     * @return è´­ç‰©è½¦åˆ—è¡?     */
    List<Cart> selectByUserId(Long userId);
    
    /**
     * æ ¹æ®ç”¨æˆ·IDåˆ é™¤è´­ç‰©è½¦è®°å½?     * @param userId ç”¨æˆ·ID
     * @return åˆ é™¤æ•°é‡
     */
    int deleteByUserId(Long userId);
    
    /**
     * æ ¹æ®ç”¨æˆ·IDå’Œå•†å“IDåˆ—è¡¨åˆ é™¤è´­ç‰©è½¦è®°å½?     * @param userId ç”¨æˆ·ID
     * @param productIds å•†å“IDåˆ—è¡¨
     * @return åˆ é™¤æ•°é‡
     */
    int deleteByUserIdAndProductIds(@Param("userId") Long userId, @Param("productIds") List<Long> productIds);
}
package com.heikeji.mall.product.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.product.entity.Category;

import java.util.List;

/**
 * å•†å“åˆ†ç±»Mapperæ¥å£
 */
public interface CategoryMapper extends BaseMapper<Category> {

    /**
     * æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çŠ¶æ€çš„åˆ†ç±»
     */
    List<Category> selectEnabledCategories();

    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢åˆ†ç±?     */
    List<Category> selectByStatus(Integer status);

    /**
     * æŒ‰æ’åºé¡ºåºæŸ¥è¯¢åˆ†ç±»åˆ—è¡?     */
    List<Category> selectOrderBySort();
}
package com.heikeji.mall.product.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.mall.product.entity.Product;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * å•†å“Mapperæ¥å£
 */
public interface ProductMapper extends BaseMapper<Product> {

    /**
     * åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    Page<Product> selectProductPage(Page<Product> page, 
                                   @Param("categoryId") Long categoryId,
                                   @Param("keyword") String keyword,
                                   @Param("status") Integer status);

    /**
     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    List<Product> selectByMerchantId(@Param("merchantId") Long merchantId);

    /**
     * æ ¹æ®åˆ†ç±»IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    List<Product> selectByCategoryId(@Param("categoryId") Long categoryId);

    /**
     * æ›´æ–°å•†å“åº“å­˜
     */
    int updateStock(@Param("id") Long id, @Param("quantity") Integer quantity);

    /**
     * æ›´æ–°å•†å“é”€é‡?     */
    int updateSales(@Param("id") Long id, @Param("sales") Integer sales);
}
package com.heikeji.mall.product.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.product.entity.Cart;

import java.util.List;

/**
 * è´­ç‰©è½¦æœåŠ¡æ¥å? */
public interface CartService extends IService<Cart> {
    
    /**
     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
     * @param userId ç”¨æˆ·ID
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     * @return è´­ç‰©è½¦è®°å½?     */
    Cart addToCart(Long userId, Long productId, Integer quantity);
    
    /**
     * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?     * @param userId ç”¨æˆ·ID
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     * @return æ˜¯å¦æ›´æ–°æˆåŠŸ
     */
    boolean updateCartQuantity(Long userId, Long productId, Integer quantity);
    
    /**
     * ä»è´­ç‰©è½¦åˆ é™¤å•†å“
     * @param userId ç”¨æˆ·ID
     * @param productId å•†å“ID
     * @return æ˜¯å¦åˆ é™¤æˆåŠŸ
     */
    boolean removeFromCart(Long userId, Long productId);
    
    /**
     * æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“?     * @param userId ç”¨æˆ·ID
     * @param productIds å•†å“IDåˆ—è¡¨
     * @return æ˜¯å¦åˆ é™¤æˆåŠŸ
     */
    boolean removeBatchFromCart(Long userId, List<Long> productIds);
    
    /**
     * æ¸…ç©ºè´­ç‰©è½?     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æ¸…ç©ºæˆåŠŸ
     */
    boolean clearCart(Long userId);
    
    /**
     * è·å–ç”¨æˆ·è´­ç‰©è½¦åˆ—è¡?     * @param userId ç”¨æˆ·ID
     * @return è´­ç‰©è½¦åˆ—è¡?     */
    List<Cart> getUserCartList(Long userId);
    
    /**
     * è·å–è´­ç‰©è½¦å•†å“æ•°é‡?     * @param userId ç”¨æˆ·ID
     * @return å•†å“æ•°é‡æ€»å’Œ
     */
    Integer getCartItemCount(Long userId);
    
    /**
     * æ£€æŸ¥è´­ç‰©è½¦å•†å“åº“å­˜
     * @param userId ç”¨æˆ·ID
     * @return åº“å­˜ä¸è¶³çš„å•†å“ä¿¡æ?     */
    List<String> checkCartStock(Long userId);
}
package com.heikeji.mall.product.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.product.entity.Category;

import java.util.List;

/**
 * å•†å“åˆ†ç±»æœåŠ¡æ¥å£
 */
public interface CategoryService extends IService<Category> {

    /**
     * è·å–æ‰€æœ‰å¯ç”¨çŠ¶æ€çš„åˆ†ç±»åˆ—è¡¨
     * @return åˆ†ç±»åˆ—è¡¨
     */
    List<Category> getEnabledCategories();
    
    /**
     * æ ¹æ®çŠ¶æ€æŸ¥è¯¢åˆ†ç±»åˆ—è¡?     * @param status çŠ¶æ€ï¼ˆ0-ç¦ç”¨ï¼?-å¯ç”¨ï¼?     * @return åˆ†ç±»åˆ—è¡¨
     */
    List<Category> getByStatus(Integer status);
    
    /**
     * è·å–æ‰€æœ‰åˆ†ç±»ï¼ŒæŒ‰æ’åºå­—æ®µæ’åº?     * @return åˆ†ç±»åˆ—è¡¨
     */
    List<Category> getCategoriesBySort();
    
    /**
     * å¯ç”¨åˆ†ç±»
     * @param categoryId åˆ†ç±»ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean enableCategory(Long categoryId);
    
    /**
     * ç¦ç”¨åˆ†ç±»
     * @param categoryId åˆ†ç±»ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean disableCategory(Long categoryId);
}
package com.heikeji.mall.product.service;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.product.entity.Product;
import java.util.List;
import java.util.Map;

/**
 * å•†å“æœåŠ¡æ¥å£
 */
public interface ProductService extends IService<Product> {

    /**
     * æ ¹æ®å•†å“IDæŸ¥è¯¢å•†å“ä¿¡æ¯
     * @param productId å•†å“ID
     * @return å•†å“ä¿¡æ¯
     */
    Product getById(Long productId);

    /**
     * æ ¹æ®å•†å“IDåˆ—è¡¨æŸ¥è¯¢å•†å“ä¿¡æ¯
     * @param productIds å•†å“IDåˆ—è¡¨
     * @return å•†å“ä¿¡æ¯åˆ—è¡¨
     */
    List<Product> getByIds(List<Long> productIds);

    /**
     * è·å–çƒ­é—¨æ¨èå•†å“å’Œæ–°å“ä¸Šæ¶å•†å“?     * @param limit é™åˆ¶æ•°é‡
     * @return å•†å“æ•°æ®æ˜ å°„
     */
    Map<String, Object> getHotProducts(Integer limit);

    /**
     * æ‰£å‡å•†å“åº“å­˜
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean deductStock(Long productId, Integer quantity);

    /**
     * æ¢å¤å•†å“åº“å­˜
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean restoreStock(Long productId, Integer quantity);

    /**
     * æ ¡éªŒå•†å“åº“å­˜æ˜¯å¦å……è¶³
     * @param productId å•†å“ID
     * @param quantity æ•°é‡
     * @return æ˜¯å¦å……è¶³
     */
    Boolean checkStock(Long productId, Integer quantity);
    
    /**
     * åˆ†é¡µæŸ¥è¯¢å•†å“åˆ—è¡¨
     * @param page åˆ†é¡µå‚æ•°
     * @param product æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µå•†å“åˆ—è¡¨
     */
    Page<Product> pageProduct(Page<Product> page, Product product);
    
    /**
     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     * @param merchantId å•†å®¶ID
     * @return å•†å“åˆ—è¡¨
     */
    List<Product> getByMerchantId(Long merchantId);
    
    /**
     * æ ¹æ®åˆ†ç±»IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     * @param categoryId åˆ†ç±»ID
     * @return å•†å“åˆ—è¡¨
     */
    List<Product> getByCategoryId(Long categoryId);
    
    /**
     * å•†å“ä¸Šæ¶
     * @param productId å•†å“ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean putOn(Long productId);
    
    /**
     * å•†å“ä¸‹æ¶
     * @param productId å•†å“ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean putOff(Long productId);
}
package com.heikeji.mall.product.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.product.entity.Cart;
import com.heikeji.mall.product.entity.Product;
import com.heikeji.mall.product.mapper.CartMapper;
import com.heikeji.mall.product.service.CartService;
import com.heikeji.mall.product.service.ProductService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

/**
 * è´­ç‰©è½¦æœåŠ¡å®ç°ç±»
 */
@Service
public class CartServiceImpl extends ServiceImpl<CartMapper, Cart> implements CartService {

    @Autowired
    private CartMapper cartMapper;
    
    @Autowired
    private ProductService productService;

    /**
     * æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Cart addToCart(Long userId, Long productId, Integer quantity) {
        // éªŒè¯å•†å“æ˜¯å¦å­˜åœ¨
        Product product = productService.getById(productId);
        if (product == null) {
            throw new RuntimeException("å•†å“ä¸å­˜åœ?);
        }
        
        // æ£€æŸ¥åº“å­?        if (product.getStock() < quantity) {
            throw new RuntimeException("å•†å“åº“å­˜ä¸è¶³");
        }
        
        // æŸ¥è¯¢è´­ç‰©è½¦ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥å•†å“
        Cart existingCart = cartMapper.selectByUserIdAndProductId(userId, productId);
        if (existingCart != null) {
            // å·²å­˜åœ¨åˆ™æ›´æ–°æ•°é‡
            existingCart.setQuantity(existingCart.getQuantity() + quantity);
            this.updateById(existingCart);
            return existingCart;
        } else {
            // ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°è®°å½?            Cart cart = new Cart();
            cart.setUserId(userId);
            cart.setProductId(productId);
            cart.setQuantity(quantity);
            this.save(cart);
            return cart;
        }
    }

    /**
     * æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateCartQuantity(Long userId, Long productId, Integer quantity) {
        if (quantity <= 0) {
            throw new RuntimeException("å•†å“æ•°é‡å¿…é¡»å¤§äº0");
        }
        
        // æ£€æŸ¥åº“å­?        Product product = productService.getById(productId);
        if (product == null) {
            throw new RuntimeException("å•†å“ä¸å­˜åœ?);
        }
        if (product.getStock() < quantity) {
            throw new RuntimeException("å•†å“åº“å­˜ä¸è¶³");
        }
        
        // æ›´æ–°æ•°é‡
        Cart cart = cartMapper.selectByUserIdAndProductId(userId, productId);
        if (cart != null) {
            cart.setQuantity(quantity);
            return this.updateById(cart);
        }
        return false;
    }

    /**
     * ä»è´­ç‰©è½¦åˆ é™¤å•†å“
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean removeFromCart(Long userId, Long productId) {
        QueryWrapper<Cart> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("user_id", userId)
                   .eq("product_id", productId);
        return this.remove(queryWrapper);
    }

    /**
     * æ‰¹é‡åˆ é™¤è´­ç‰©è½¦å•†å“?     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean removeBatchFromCart(Long userId, List<Long> productIds) {
        return cartMapper.deleteByUserIdAndProductIds(userId, productIds) > 0;
    }

    /**
     * æ¸…ç©ºè´­ç‰©è½?     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean clearCart(Long userId) {
        return cartMapper.deleteByUserId(userId) > 0;
    }

    /**
     * è·å–ç”¨æˆ·è´­ç‰©è½¦åˆ—è¡?     */
    @Override
    public List<Cart> getUserCartList(Long userId) {
        return cartMapper.selectByUserId(userId);
    }

    /**
     * è·å–è´­ç‰©è½¦å•†å“æ•°é‡?     */
    @Override
    public Integer getCartItemCount(Long userId) {
        List<Cart> cartList = cartMapper.selectByUserId(userId);
        return cartList.stream().mapToInt(Cart::getQuantity).sum();
    }

    /**
     * æ£€æŸ¥è´­ç‰©è½¦å•†å“åº“å­˜
     */
    @Override
    public List<String> checkCartStock(Long userId) {
        List<Cart> cartList = cartMapper.selectByUserId(userId);
        List<String> stockErrorList = new ArrayList<>();
        
        for (Cart cart : cartList) {
            Product product = productService.getById(cart.getProductId());
            if (product != null && product.getStock() < cart.getQuantity()) {
                stockErrorList.add(product.getName() + " åº“å­˜ä¸è¶³");
            }
        }
        
        return stockErrorList;
    }
}
package com.heikeji.mall.product.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.product.entity.Category;
import com.heikeji.mall.product.mapper.CategoryMapper;
import com.heikeji.mall.product.service.CategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * å•†å“åˆ†ç±»æœåŠ¡å®ç°ç±? */
@Service
public class CategoryServiceImpl extends ServiceImpl<CategoryMapper, Category> implements CategoryService {

    @Autowired
    private CategoryMapper categoryMapper;

    @Override
    public List<Category> getEnabledCategories() {
        return categoryMapper.selectEnabledCategories();
    }

    @Override
    public List<Category> getByStatus(Integer status) {
        return categoryMapper.selectByStatus(status);
    }

    @Override
    public List<Category> getCategoriesBySort() {
        return categoryMapper.selectOrderBySort();
    }

    @Override
    public Boolean enableCategory(Long categoryId) {
        Category category = this.getById(categoryId);
        if (category != null) {
            category.setStatus(1);
            return this.updateById(category);
        }
        return false;
    }

    @Override
    public Boolean disableCategory(Long categoryId) {
        Category category = this.getById(categoryId);
        if (category != null) {
            category.setStatus(0);
            return this.updateById(category);
        }
        return false;
    }
}
package com.heikeji.mall.product.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.common.core.exception.BaseException;
import com.heikeji.mall.product.entity.Product;
import com.heikeji.mall.product.mapper.ProductMapper;
import com.heikeji.mall.product.service.ProductService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * å•†å“æœåŠ¡å®ç°ç±? */
@Slf4j
@Service
public class ProductServiceImpl extends ServiceImpl<ProductMapper, Product> implements ProductService {

    @Override
    @Cacheable(value = "productCache", key = "#productId", unless = "#result == null")
    public Product getById(Long productId) {
        log.info("ä»æ•°æ®åº“è·å–å•†å“ä¿¡æ¯ï¼Œå•†å“ID: {}", productId);
        Product product = super.getById(productId);
        if (product == null || product.getDelFlag() == 1) {
            throw new BaseException("å•†å“ä¸å­˜åœ?);
        }
        if (product.getStatus() != 1) {
            throw new BaseException("å•†å“å·²ä¸‹æ?);
        }
        return product;
    }

    @Override
    @Cacheable(value = "productCache", key = "#productIds", unless = "#result == null or #result.isEmpty()")
    public List<Product> getByIds(List<Long> productIds) {
        if (productIds == null || productIds.isEmpty()) {
            return null;
        }
        
        log.info("æ‰¹é‡è·å–å•†å“ä¿¡æ¯ï¼Œå•†å“IDåˆ—è¡¨: {}", productIds);
        // æŸ¥è¯¢æ‰€æœ‰å•†å“?        List<Product> products = this.listByIds(productIds);
        
        // è¿‡æ»¤å‡ºæœ‰æ•ˆçš„å•†å“ï¼ˆæœªåˆ é™¤ä¸”å·²ä¸Šæ¶ï¼?        products.removeIf(product -> product == null || product.getDelFlag() == 1 || product.getStatus() != 1);
        
        return products;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    @CacheEvict(value = "productCache", allEntries = true)
    public Boolean deductStock(Long productId, Integer quantity) {
        // è·å–å½“å‰å•†å“ä¿¡æ¯
        Product product = this.getById(productId);
        
        // æ£€æŸ¥åº“å­?        if (product.getStock() < quantity) {
            log.error("å•†å“åº“å­˜ä¸è¶³ï¼Œå•†å“IDï¼š{}ï¼Œåº“å­˜ï¼š{}ï¼Œéœ€è¦ï¼š{}", productId, product.getStock(), quantity);
            throw new BaseException("å•†å“åº“å­˜ä¸è¶³");
        }
        
        // ä½¿ç”¨ä¹è§‚é”æœºåˆ¶æ›´æ–°åº“å­?        Integer currentVersion = product.getVersion() != null ? product.getVersion() : 0;
        
        // æ„å»ºæ›´æ–°æ¡ä»¶ï¼ŒåŒ…å«ç‰ˆæœ¬å·å’Œåº“å­˜æ£€æŸ?        QueryWrapper<Product> updateWrapper = new QueryWrapper<>();
        updateWrapper.eq("id", productId)
                   .eq("version", currentVersion)
                   .ge("stock", quantity); // å†æ¬¡æ£€æŸ¥åº“å­˜ï¼Œç¡®ä¿å¹¶å‘å®‰å…¨
        
        // æ„å»ºæ›´æ–°å¯¹è±¡
        Product updateProduct = new Product();
        updateProduct.setStock(product.getStock() - quantity);
        updateProduct.setSales(product.getSales() + quantity);
        updateProduct.setVersion(currentVersion + 1);
        updateProduct.setUpdateTime(new Date());
        
        // æ‰§è¡Œæ›´æ–°æ“ä½œ
        boolean result = this.update(updateProduct, updateWrapper);
        
        if (!result) {
            // æ›´æ–°å¤±è´¥ï¼Œå¯èƒ½æ˜¯åº“å­˜ä¸è¶³æˆ–å¹¶å‘å†²çª?            log.error("å•†å“åº“å­˜æ‰£å‡å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å¹¶å‘å†²çªï¼Œå•†å“IDï¼š{}ï¼Œå½“å‰ç‰ˆæœ¬ï¼š{}", productId, currentVersion);
            throw new BaseException("å•†å“åº“å­˜æ‰£å‡å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
        
        log.info("æ‰£å‡å•†å“åº“å­˜æˆåŠŸï¼Œå•†å“IDï¼š{}ï¼Œæ‰£å‡æ•°é‡ï¼š{}ï¼Œå½“å‰ç‰ˆæœ¬ï¼š{}", productId, quantity, currentVersion + 1);
        return true;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    @CacheEvict(value = "productCache", allEntries = true)
    public Boolean restoreStock(Long productId, Integer quantity) {
        Product product = this.getById(productId);
        
        // æ¢å¤åº“å­˜
        product.setStock(product.getStock() + quantity);
        product.setSales(product.getSales() - quantity);
        if (product.getSales() < 0) {
            product.setSales(0);
        }
        
        log.info("æ¢å¤å•†å“åº“å­˜ï¼Œå•†å“IDï¼š{}ï¼Œæ¢å¤æ•°é‡ï¼š{}", productId, quantity);
        return this.updateById(product);
    }

    @Override
    public Boolean checkStock(Long productId, Integer quantity) {
        Product product = this.getById(productId);
        boolean result = product.getStock() >= quantity;
        log.info("æ£€æŸ¥å•†å“åº“å­˜ï¼Œå•†å“IDï¼š{}ï¼Œè¯·æ±‚æ•°é‡ï¼š{}ï¼Œåº“å­˜ï¼š{}ï¼Œç»“æœï¼š{}", 
                 productId, quantity, product.getStock(), result);
        return result;
    }

    @Override
    @Cacheable(value = "productCache", key = "'hotProducts:' + #limit", unless = "#result == null")
    public Map<String, Object> getHotProducts(Integer limit) {
        Map<String, Object> result = new HashMap<>();
        
        // æŸ¥è¯¢æ¡ä»¶ï¼šæœªåˆ é™¤ã€å·²ä¸Šæ¶
        QueryWrapper<Product> wrapper = new QueryWrapper<>();
        wrapper.eq("del_flag", 0)
               .eq("status", 1);
        
        // è·å–çƒ­é—¨æ¨èå•†å“ï¼ˆæŒ‰é”€é‡é™åºï¼‰
        QueryWrapper<Product> hotWrapper = new QueryWrapper<Product>();
        hotWrapper.eq("del_flag", 0)
                 .eq("status", 1)
                 .orderByDesc("sales")
                 .last("LIMIT " + limit);
        List<Product> hotProducts = this.list(hotWrapper);
        
        // è·å–æ–°å“ä¸Šæ¶å•†å“ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´é™åºï¼?        QueryWrapper<Product> newWrapper = new QueryWrapper<Product>();
        newWrapper.eq("del_flag", 0)
                 .eq("status", 1)
                 .orderByDesc("create_time")
                 .last("LIMIT " + limit);
        List<Product> newProducts = this.list(newWrapper);
        
        result.put("hotProducts", hotProducts);
        result.put("newProducts", newProducts);
        
        return result;
    }

    @Override
    public Page<Product> pageProduct(Page<Product> page, Product product) {
        QueryWrapper<Product> wrapper = new QueryWrapper<>();
        wrapper.eq("del_flag", 0);
        
        if (product != null) {
            if (product.getMerchantId() != null) {
                wrapper.eq("merchant_id", product.getMerchantId());
            }
            if (product.getCategoryId() != null) {
                wrapper.eq("category_id", product.getCategoryId());
            }
            if (product.getStatus() != null) {
                wrapper.eq("status", product.getStatus());
            }
            if (product.getName() != null && !product.getName().isEmpty()) {
                wrapper.like("name", product.getName());
            }
        }
        
        wrapper.orderByDesc("update_time");
        return this.page(page, wrapper);
    }

    @Override
    public List<Product> getByMerchantId(Long merchantId) {
        QueryWrapper<Product> wrapper = new QueryWrapper<>();
        wrapper.eq("merchant_id", merchantId)
               .eq("del_flag", 0)
               .eq("status", 1)
               .orderByDesc("update_time");
        return this.list(wrapper);
    }

    @Override
    @Cacheable(value = "productCache", key = "'category:' + #categoryId", unless = "#result == null or #result.isEmpty()")
    public List<Product> getByCategoryId(Long categoryId) {
        QueryWrapper<Product> wrapper = new QueryWrapper<>();
        wrapper.eq("category_id", categoryId)
               .eq("del_flag", 0)
               .eq("status", 1)
               .orderByDesc("sales");
        return this.list(wrapper);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    @CacheEvict(value = "productCache", allEntries = true)
    public Boolean putOn(Long productId) {
        Product product = this.getById(productId);
        if (product == null || product.getDelFlag() == 1) {
            throw new BaseException("å•†å“ä¸å­˜åœ?);
        }
        
        product.setStatus(1);
        log.info("å•†å“ä¸Šæ¶ï¼Œå•†å“IDï¼š{}", productId);
        return this.updateById(product);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    @CacheEvict(value = "productCache", allEntries = true)
    public Boolean putOff(Long productId) {
        Product product = this.getById(productId);
        if (product == null || product.getDelFlag() == 1) {
            throw new BaseException("å•†å“ä¸å­˜åœ?);
        }
        
        product.setStatus(0);
        log.info("å•†å“ä¸‹æ¶ï¼Œå•†å“IDï¼š{}", productId);
        return this.updateById(product);
    }
}
package com.heikeji.mall.takeout;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

/**
 * å¤–å–æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication(scanBasePackages = {"com.heikeji.mall.takeout", "com.heikeji.common"})
public class TakeoutApplication {

    public static void main(String[] args) {
        SpringApplication.run(TakeoutApplication.class, args);
    }

}
package com.heikeji.mall.takeout.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis Plus é…ç½®ç±? */
@Configuration
public class MyBatisPlusConfig {

    /**
     * é…ç½®åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }

}
package com.heikeji.mall.takeout.config;

import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Configuration;

/**
 * å¤–å–æœåŠ¡é…ç½®ç±? */
@Configuration
@MapperScan("com.heikeji.mall.takeout.mapper")
public class TakeoutConfig {
}
package com.heikeji.mall.takeout.constants;

/**
 * å¤–å–æœåŠ¡å¸¸é‡ç±? */
public class TakeoutConstants {
    // é…é€æ–¹å¼?    public static final String DELIVERY_METHOD_LOCKER = "locker"; // å¤–å–æŸ?    public static final String DELIVERY_METHOD_SPECIAL_PLACE = "special_place"; // ç‰¹æ®Šåœ°ç‚¹
    public static final String DELIVERY_METHOD_DORMITORY = "dormitory"; // å¯å®¤

    // è®¢å•çŠ¶æ€?    public static final String ORDER_STATUS_PENDING = "pending"; // å¾…æ¥å?    public static final String ORDER_STATUS_ACCEPTED = "accepted"; // å·²æ¥å?    public static final String ORDER_STATUS_DELIVERING = "delivering"; // é…é€ä¸­
    public static final String ORDER_STATUS_DELIVERED = "delivered"; // å·²é€è¾¾
    public static final String ORDER_STATUS_CANCELLED = "cancelled"; // å·²å–æ¶?
    // å¤–å–æŸœçŠ¶æ€?    public static final Integer LOCKER_STATUS_NORMAL = 0; // æ­£å¸¸
    public static final Integer LOCKER_STATUS_MALFUNCTION = 1; // æ•…éšœ

    // åˆ†é¡µé»˜è®¤å‚æ•°
    public static final Integer DEFAULT_PAGE_SIZE = 10;
    public static final Integer DEFAULT_PAGE_NUM = 1;

    // é”™è¯¯ç ?    public static final Integer ERROR_CODE_ORDER_NOT_FOUND = 404;
    public static final Integer ERROR_CODE_INVALID_STATUS = 400;
    public static final Integer ERROR_CODE_LOCKER_NOT_AVAILABLE = 400;
    public static final Integer ERROR_CODE_CANNOT_CANCEL = 400;
}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.DeliveryLocker;
import com.heikeji.mall.takeout.service.DeliveryLockerService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¤–å–æŸœæ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/takeout/locker")
@Api(tags = "å¤–å–æŸœç®¡ç?)
public class DeliveryLockerController {

    @Autowired
    private DeliveryLockerService deliveryLockerService;

    /**
     * è·å–æ‰€æœ‰å¯ç”¨çš„å¤–å–æŸ?     */
    @GetMapping("/available")
    @ApiOperation("è·å–å¯ç”¨å¤–å–æŸœåˆ—è¡?)
    public R<List<DeliveryLocker>> getAvailableLockers() {
        List<DeliveryLocker> lockers = deliveryLockerService.getAvailableLockers();
        return R.success(lockers);
    }

    /**
     * æ ¹æ®ç¼–ç æŸ¥è¯¢å¤–å–æŸ?     */
    @GetMapping("/detail")
    @ApiOperation("æŸ¥è¯¢å¤–å–æŸœè¯¦æƒ?)
    public R<DeliveryLocker> getLockerByCode(@RequestParam String lockerCode) {
        DeliveryLocker locker = deliveryLockerService.getByCode(lockerCode);
        return R.success(locker);
    }

    /**
     * åˆ†é…æ ¼å£
     */
    @PostMapping("/allocate")
    @ApiOperation("åˆ†é…å¤–å–æŸœæ ¼å?)
    public R<String> allocateCell(@RequestParam String lockerCode) {
        String cellNo = deliveryLockerService.allocateCell(lockerCode);
        if (cellNo == null) {
            return R.error("å¤–å–æŸœå·²æ»¡æˆ–ä¸å­˜åœ?);
        }
        return R.success(cellNo);
    }

    /**
     * é‡Šæ”¾æ ¼å£
     */
    @PostMapping("/release")
    @ApiOperation("é‡Šæ”¾å¤–å–æŸœæ ¼å?)
    public R<Boolean> releaseCell(@RequestParam String lockerCode, @RequestParam String cellNo) {
        Boolean result = deliveryLockerService.releaseCell(lockerCode, cellNo);
        return R.success(result);
    }

    /**
     * æ–°å¢å¤–å–æŸœï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
     */
    @PostMapping("/create")
    @ApiOperation("æ–°å¢å¤–å–æŸ?)
    public R<Boolean> createLocker(@RequestBody DeliveryLocker locker) {
        boolean result = deliveryLockerService.create(locker);
        return R.success(result);
    }

    /**
     * ç¼–è¾‘å¤–å–æŸœï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
     */
    @PostMapping("/update")
    @ApiOperation("ç¼–è¾‘å¤–å–æŸ?)
    public R<Boolean> updateLocker(@RequestBody DeliveryLocker locker) {
        boolean result = deliveryLockerService.update(locker);
        return R.success(result);
    }
}
package com.heikeji.mall.takeout.controller;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.Merchant;
import com.heikeji.mall.takeout.service.MerchantService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å•†å®¶æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/merchant")
@Api(tags = "å¤–å–å•†å®¶ç®¡ç†")
public class MerchantController {

    @Autowired
    private MerchantService merchantService;

    /**
     * è·å–è¥ä¸šä¸­çš„å•†å®¶åˆ—è¡¨
     */
    @GetMapping("/active")
    @ApiOperation("è·å–è¥ä¸šä¸­çš„å•†å®¶åˆ—è¡¨")
    public R<List<Merchant>> getActiveMerchants() {
        List<Merchant> merchants = merchantService.getActiveMerchants();
        return R.success(merchants);
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢å•†å®¶
     */
    @GetMapping("/page")
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢å•†å®¶")
    public R<Page<Merchant>> pageMerchants(@RequestParam Integer pageNum, @RequestParam Integer pageSize) {
        Page<Merchant> page = new Page<>(pageNum, pageSize);
        Page<Merchant> merchantPage = merchantService.pageMerchants(page);
        return R.success(merchantPage);
    }

    /**
     * æœç´¢å•†å®¶
     */
    @GetMapping("/search")
    @ApiOperation("æœç´¢å•†å®¶")
    public R<List<Merchant>> searchMerchants(@RequestParam String keyword) {
        List<Merchant> merchants = merchantService.searchMerchants(keyword);
        return R.success(merchants);
    }

    /**
     * è·å–å•†å®¶è¯¦æƒ…
     */
    @GetMapping("/{id}")
    @ApiOperation("è·å–å•†å®¶è¯¦æƒ…")
    public R<Merchant> getMerchantById(@PathVariable Long id) {
        Merchant merchant = merchantService.getById(id);
        return R.success(merchant);
    }

}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.TakeoutCategory;
import com.heikeji.mall.takeout.service.TakeoutCategoryService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¤–å–å•†å“åˆ†ç±»æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/category")
@Api(tags = "å¤–å–å•†å“åˆ†ç±»ç®¡ç†")
public class TakeoutCategoryController {

    @Autowired
    private TakeoutCategoryService takeoutCategoryService;

    /**
     * æ ¹æ®å•†å®¶IDè·å–åˆ†ç±»åˆ—è¡¨
     */
    @GetMapping("/merchant/{merchantId}")
    @ApiOperation("æ ¹æ®å•†å®¶IDè·å–åˆ†ç±»åˆ—è¡¨")
    public R<List<TakeoutCategory>> getCategoriesByMerchantId(@PathVariable Long merchantId) {
        List<TakeoutCategory> categories = takeoutCategoryService.getCategoriesByMerchantId(merchantId);
        return R.success(categories);
    }

}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.dto.CreateTakeoutOrderDTO;
import com.heikeji.mall.takeout.dto.TakeoutOrderResponseDTO;
import com.heikeji.mall.takeout.entity.TakeoutOrder;
import com.heikeji.mall.takeout.entity.DeliveryLocker;
import com.heikeji.mall.takeout.enums.OrderStatusEnum;
import com.heikeji.mall.takeout.service.TakeoutService;
import com.heikeji.mall.takeout.utils.ResultUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Date;
import java.util.stream.Collectors;
import java.time.LocalDateTime;
import java.time.ZoneId;

/**
 * å¤–å–è®¢å•Controller
 */
@RestController
@RequestMapping("/api/takeout")
public class TakeoutController {

    @Autowired
    private TakeoutService takeoutService;

    /**
     * åˆ›å»ºå¤–å–è®¢å•
     */
    @PostMapping("/order")
    public R createOrder(@RequestBody CreateTakeoutOrderDTO dto) {
        try {
            // éªŒè¯é…é€ä¿¡æ?            validateDTO(dto);
            
            // è½¬æ¢ä¸ºå®ä½“ç±»
            TakeoutOrder order = convertToEntity(dto);
            
            // åˆ›å»ºè®¢å•
              TakeoutOrder createdOrder = takeoutService.createTakeoutOrder(order);
              return ResultUtil.success(convertToResponseDTO(createdOrder));
          } catch (IllegalArgumentException e) {
              return ResultUtil.error(e.getMessage());
          } catch (Exception e) {
              return ResultUtil.error("åˆ›å»ºè®¢å•å¤±è´¥");
          }
    }

    /**
     * è·å–è®¢å•è¯¦æƒ…
     */
    @GetMapping("/order/{id}")
    public R getOrderDetail(@PathVariable Long id) {
        TakeoutOrder order = takeoutService.getTakeoutOrderById(id);
        if (order == null) {
              return ResultUtil.error("è®¢å•ä¸å­˜åœ?);
          }
        return ResultUtil.success(convertToResponseDTO(order));
    }

    /**
     * è·å–ç”¨æˆ·è®¢å•åˆ—è¡¨
     */
    @GetMapping("/user/orders")
    public R getUserOrders(@RequestParam Long userId, @RequestParam(required = false) Integer status) {
        List<TakeoutOrder> orders = takeoutService.getUserTakeoutOrders(userId, status);
        List<TakeoutOrderResponseDTO> responseDTOs = orders.stream()
                .map(this::convertToResponseDTO)
                .collect(Collectors.toList());
        return ResultUtil.success(responseDTOs);
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/order/{id}/cancel")
    public R cancelOrder(@PathVariable Long id, @RequestParam Long userId) {
        boolean result = takeoutService.cancelOrder(id, userId);
          return result ? ResultUtil.success(true) : ResultUtil.error("å–æ¶ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¢å•çŠ¶æ€?);
    }

    /**
     * è·å–å¯ç”¨å¤–å–æŸœåˆ—è¡?     */
    @GetMapping("/lockers/available")
    public R getAvailableLockers() {
        List<DeliveryLocker> lockers = takeoutService.getAvailableLockers();
        return ResultUtil.success(lockers);
    }

    /**
     * é…é€å‘˜æ¥å•
     */
    @PostMapping("/order/{id}/accept")
    public R acceptOrder(@PathVariable Long id, @RequestParam Long deliveryPersonId) {
        boolean result = takeoutService.acceptOrder(id, deliveryPersonId);
          return result ? ResultUtil.success(true) : ResultUtil.error("æ¥å•å¤±è´¥");
    }

    /**
     * æ›´æ–°è®¢å•çŠ¶æ€?     */
    @PutMapping("/order/{id}/status")
    public R updateOrderStatus(@PathVariable Long id, @RequestParam Integer status) {
        boolean result = takeoutService.updateOrderStatus(id, status);
          return result ? ResultUtil.success(true) : ResultUtil.error("æ›´æ–°å¤±è´¥");
    }

    /**
     * æ›´æ–°é…é€ä¿¡æ?     */
    @PutMapping("/order/{id}/delivery")
    public R updateDeliveryInfo(@PathVariable Long id,
                               @RequestParam Long deliveryPersonId,
                               @RequestParam String deliveryPersonName,
                               @RequestParam String deliveryPersonPhone) {
        boolean result = takeoutService.updateDeliveryInfo(id, deliveryPersonId, deliveryPersonName, deliveryPersonPhone);
          return result ? ResultUtil.success(true) : ResultUtil.error("æ›´æ–°é…é€ä¿¡æ¯å¤±è´?);
    }

    /**
     * æ ‡è®°è®¢å•ä¸ºå·²é€è¾¾
     */
    @PutMapping("/order/{id}/delivered")
    public R markAsDelivered(@PathVariable Long id) {
        boolean result = takeoutService.markAsDelivered(id);
          return result ? ResultUtil.success(true) : ResultUtil.error("æ ‡è®°å¤±è´¥");
    }

    /**
     * éªŒè¯DTO
     */
    private void validateDTO(CreateTakeoutOrderDTO dto) {
        if (dto == null) {
            throw new IllegalArgumentException("è®¢å•ä¿¡æ¯ä¸èƒ½ä¸ºç©º");
        }
        if (dto.getMerchantId() == null) {
            throw new IllegalArgumentException("å•†å®¶IDä¸èƒ½ä¸ºç©º");
        }
        if (dto.getDeliveryType() == null) {
            throw new IllegalArgumentException("é…é€æ–¹å¼ä¸èƒ½ä¸ºç©?);
        }
        // éªŒè¯é…é€æ–¹å¼?        switch (dto.getDeliveryType()) {
            case 1: // å¤–å–æŸ?                if (dto.getDeliveryLockerCode() == null || dto.getDeliveryLockerCode().isEmpty()) {
                    throw new IllegalArgumentException("å¤–å–æŸœé…é€å¿…é¡»é€‰æ‹©å¤–å–æŸ?);
                }
                // éªŒè¯å¤–å–æŸœæ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
                DeliveryLocker locker = takeoutService.getLockerByCode(dto.getDeliveryLockerCode());
                if (locker == null || locker.getStatus() != 0 || locker.getAvailableCells() <= 0) {
                    throw new IllegalArgumentException("æ‰€é€‰å¤–å–æŸœä¸å¯ç”?);
                }
                break;
            case 2: // ç‰¹æ®Šåœ°ç‚¹
                if (dto.getDeliverySpecialPlace() == null || dto.getDeliverySpecialPlace().isEmpty()) {
                    throw new IllegalArgumentException("è¯·å¡«å†™ç‰¹æ®Šé…é€åœ°ç‚?);
                }
                break;
            case 3: // é€åˆ°å¯å®¤
                if (dto.getDeliveryDormBuilding() == null || dto.getDeliveryDormBuilding().isEmpty()) {
                    throw new IllegalArgumentException("è¯·å¡«å†™å¯å®¤æ¥¼æ ?);
                }
                if (dto.getDeliveryDormRoom() == null || dto.getDeliveryDormRoom().isEmpty()) {
                    throw new IllegalArgumentException("è¯·å¡«å†™å¯å®¤æˆ¿é—´å·");
                }
                break;
            default:
                throw new IllegalArgumentException("ä¸æ”¯æŒçš„é…é€æ–¹å¼?);
        }
        if (dto.getReceiverName() == null || dto.getReceiverName().isEmpty()) {
            throw new IllegalArgumentException("æ”¶è´§äººå§“åä¸èƒ½ä¸ºç©?);
        }
        if (dto.getReceiverPhone() == null || dto.getReceiverPhone().isEmpty()) {
            throw new IllegalArgumentException("æ”¶è´§äººç”µè¯ä¸èƒ½ä¸ºç©?);
        }
        // éªŒè¯è®¢å•å•†å“
        if (dto.getOrderItems() == null || dto.getOrderItems().isEmpty()) {
            throw new IllegalArgumentException("è¯·æ·»åŠ å•†å“?);
        }
        for (CreateTakeoutOrderDTO.OrderItemDTO item : dto.getOrderItems()) {
            if (item.getProductId() == null || item.getQuantity() == null || item.getQuantity() <= 0) {
                throw new IllegalArgumentException("å•†å“ä¿¡æ¯æ— æ•ˆ");
            }
        }
    }

    /**
     * è½¬æ¢DTOä¸ºå®ä½“ç±»
     */
    private TakeoutOrder convertToEntity(CreateTakeoutOrderDTO dto) {
        TakeoutOrder order = new TakeoutOrder();
        order.setMerchantId(dto.getMerchantId());
        order.setDeliveryType(dto.getDeliveryType());
        order.setDeliveryLockerCode(dto.getDeliveryLockerCode());
        order.setDeliverySpecialPlace(dto.getDeliverySpecialPlace());
        order.setDeliveryDormBuilding(dto.getDeliveryDormBuilding());
        order.setDeliveryDormRoom(dto.getDeliveryDormRoom());
        order.setReceiverName(dto.getReceiverName());
        order.setReceiverPhone(dto.getReceiverPhone());
        order.setReceiverAddress(dto.getReceiverAddress());
        order.setRemark(dto.getRemark());
        
        // è¿™é‡Œåº”è¯¥ä»ç”¨æˆ·ä¼šè¯ä¸­è·å–ç”¨æˆ·IDï¼Œä¸´æ—¶ç¡¬ç¼–ç 
        order.setUserId(1L);
        
        // è®¾ç½®åˆ›å»ºå’Œæ›´æ–°æ—¶é—´ä¸ºå½“å‰æ—¶é—´
        Date now = new Date();
        order.setCreateTime(now);
        order.setUpdateTime(now);
        
        return order;
    }

    /**
     * è½¬æ¢å®ä½“ç±»ä¸ºå“åº”DTO
     */
    private TakeoutOrderResponseDTO convertToResponseDTO(TakeoutOrder order) {
        if (order == null) {
            return null;
        }
        
        TakeoutOrderResponseDTO dto = new TakeoutOrderResponseDTO();
        dto.setId(order.getId());
        dto.setOrderSn(order.getOrderNo());
        dto.setMerchantId(order.getMerchantId());
        dto.setUserId(order.getUserId());
        dto.setDeliveryStatus(String.valueOf(order.getStatus()));
        dto.setDeliveryStatusText(getStatusText(order.getStatus()));
        dto.setCourierId(order.getDeliveryPersonId());
        dto.setCourierName(order.getDeliveryPersonName());
        dto.setReceiverName(order.getReceiverName());
        dto.setReceiverPhone(order.getReceiverPhone());
        // å°†Dateè½¬æ¢ä¸ºLocalDateTime
        if (order.getCreateTime() != null) {
            dto.setCreateTime(order.getCreateTime().toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime());
        }
        if (order.getUpdateTime() != null) {
            dto.setUpdateTime(order.getUpdateTime().toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime());
        }
        
        // è®¾ç½®é…é€æ–¹å¼æ–‡æœ?        if (order.getDeliveryType() != null) {
            switch (order.getDeliveryType()) {
                case 1: dto.setDeliveryMethod("locker"); break;
                case 2: dto.setDeliveryMethod("special_place"); break;
                case 3: dto.setDeliveryMethod("dormitory"); break;
            }
        }
        
        return dto;
    }

    /**
     * è·å–çŠ¶æ€æ–‡æœ?     */
    private String getStatusText(Integer status) {
        switch (status) {
            case 0: return "å¾…æ¥å?;
            case 1: return "å·²æ¥å?;
            case 2: return "é…é€ä¸­";
            case 3: return "å·²é€è¾¾";
            case 4: return "å·²å–æ¶?;
            default: return "æœªçŸ¥çŠ¶æ€?;
        }
    }
}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.TakeoutLocker;
import com.heikeji.mall.takeout.service.TakeoutLockerService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¤–å–æŸœæ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/takeout/locker")
@Api(tags = "å¤–å–æŸœç®¡ç?)
public class TakeoutLockerController {

    @Autowired
    private TakeoutLockerService takeoutLockerService;

    /**
     * è·å–å¯ç”¨çš„å¤–å–æŸœåˆ—è¡¨
     */
    @GetMapping("/available")
    @ApiOperation("è·å–å¯ç”¨çš„å¤–å–æŸœåˆ—è¡¨")
    public R<List<TakeoutLocker>> getAvailableLockers() {
        List<TakeoutLocker> lockers = takeoutLockerService.getAvailableLockers();
        return R.success(lockers);
    }

    /**
     * æ ¹æ®ç¼–ç è·å–å¤–å–æŸ?     */
    @GetMapping("/code/{lockerCode}")
    @ApiOperation("æ ¹æ®ç¼–ç è·å–å¤–å–æŸ?)
    public R<TakeoutLocker> getLockerByCode(@PathVariable String lockerCode) {
        TakeoutLocker locker = takeoutLockerService.getLockerByCode(lockerCode);
        return R.success(locker);
    }

    /**
     * å ç”¨å¤–å–æŸœæ ¼å­?     */
    @PostMapping("/occupy")
    @ApiOperation("å ç”¨å¤–å–æŸœæ ¼å­?)
    public R<Boolean> occupySlot(@RequestParam String lockerCode) {
        boolean result = takeoutLockerService.occupySlot(lockerCode);
        return R.success(result);
    }

    /**
     * é‡Šæ”¾å¤–å–æŸœæ ¼å­?     */
    @PostMapping("/release")
    @ApiOperation("é‡Šæ”¾å¤–å–æŸœæ ¼å­?)
    public R<Boolean> releaseSlot(@RequestParam String lockerCode) {
        boolean result = takeoutLockerService.releaseSlot(lockerCode);
        return R.success(result);
    }

    /**
     * æ›´æ–°å¤–å–æŸœçŠ¶æ€?     */
    @PutMapping("/status")
    @ApiOperation("æ›´æ–°å¤–å–æŸœçŠ¶æ€?)
    public R<Boolean> updateLockerStatus(@RequestParam String lockerCode, @RequestParam Integer status) {
        boolean result = takeoutLockerService.updateLockerStatus(lockerCode, status);
        return R.success(result);
    }

    /**
     * è·å–æ‰€æœ‰å¤–å–æŸœ
     */
    @GetMapping("/list")
    @ApiOperation("è·å–æ‰€æœ‰å¤–å–æŸœ")
    public R<List<TakeoutLocker>> getAllLockers() {
        List<TakeoutLocker> lockers = takeoutLockerService.list();
        return R.success(lockers);
    }

}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.dto.TakeoutOrderDTO;
import com.heikeji.mall.takeout.entity.TakeoutOrder;
import com.heikeji.mall.takeout.service.TakeoutOrderService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

/**
 * å¤–å–è®¢å•æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/order")
@Api(tags = "å¤–å–è®¢å•ç®¡ç†")
@Slf4j
public class TakeoutOrderController {

    @Autowired
    private TakeoutOrderService takeoutOrderService;

    /**
     * åˆ›å»ºå¤–å–è®¢å•
     */
    @PostMapping("/create")
    @ApiOperation("åˆ›å»ºå¤–å–è®¢å•")
    public R<String> createOrder(@RequestBody TakeoutOrderDTO dto) {
        // ä¸´æ—¶ä½¿ç”¨å›ºå®šuserIdï¼Œå®é™…åº”ä»è®¤è¯ä¸Šä¸‹æ–‡ä¸­è·å?        Long userId = 1L;
        String orderNo = takeoutOrderService.createTakeoutOrder(userId, dto);
        return R.success(orderNo);
    }

    /**
     * æŸ¥è¯¢è®¢å•è¯¦æƒ…
     */
    @GetMapping("/detail")
    @ApiOperation("æŸ¥è¯¢è®¢å•è¯¦æƒ…")
    public R<TakeoutOrder> getOrderDetail(@RequestParam String orderNo) {
        TakeoutOrder order = takeoutOrderService.getByOrderNo(orderNo);
        return R.success(order);
    }

    /**
     * å–æ¶ˆè®¢å•
     */
    @PostMapping("/cancel")
    @ApiOperation("å–æ¶ˆè®¢å•")
    public R<Boolean> cancelOrder(@RequestParam String orderNo) {
        // ä¸´æ—¶ä½¿ç”¨å›ºå®šuserIdï¼Œå®é™…åº”ä»è®¤è¯ä¸Šä¸‹æ–‡ä¸­è·å?        Long userId = 1L;
        Boolean result = takeoutOrderService.cancelOrder(orderNo, userId);
        return R.success(result);
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢è®¢å•åˆ—è¡¨
     */
    @GetMapping("/page")
    @ApiOperation("åˆ†é¡µæŸ¥è¯¢è®¢å•åˆ—è¡¨")
    public R<com.baomidou.mybatisplus.extension.plugins.pagination.Page<TakeoutOrder>> pageQuery(
            @RequestParam long pageNo,
            @RequestParam long pageSize,
            @RequestParam(required = false) String orderNo) {
        // ä¸´æ—¶ä½¿ç”¨å›ºå®šuserIdï¼Œå®é™…åº”ä»è®¤è¯ä¸Šä¸‹æ–‡ä¸­è·å?        Long userId = 1L;
        com.baomidou.mybatisplus.extension.plugins.pagination.Page<TakeoutOrder> page = 
                takeoutOrderService.pageQuery(userId, pageNo, pageSize, orderNo);
        return R.success(page);
    }

    /**
     * é…é€å‘˜æ¥å•
     */
    @PostMapping("/accept")
    @ApiOperation("é…é€å‘˜æ¥å•")
    public R<Boolean> acceptOrder(@RequestBody AcceptOrderRequest request) {
        Boolean result = takeoutOrderService.acceptOrder(
                request.getOrderNo(),
                request.getDeliveryPersonId(),
                request.getDeliveryPersonName(),
                request.getDeliveryPersonPhone());
        return R.success(result);
    }

    /**
     * æ›´æ–°é…é€çŠ¶æ€?     */
    @PostMapping("/update/status")
    @ApiOperation("æ›´æ–°é…é€çŠ¶æ€?)
    public R<Boolean> updateStatus(@RequestBody UpdateStatusRequest request) {
        Boolean result = takeoutOrderService.updateDeliveryStatus(request.getOrderNo(), request.getStatus());
        return R.success(result);
    }

    /**
     * ç¡®è®¤é€è¾¾
     */
    @PostMapping("/confirm")
    @ApiOperation("ç¡®è®¤é€è¾¾")
    public R<Boolean> confirmDelivery(@RequestParam String orderNo) {
        Boolean result = takeoutOrderService.confirmDelivery(orderNo);
        return R.success(result);
    }

    /**
     * å†…éƒ¨è¯·æ±‚ç±?     */
    static class AcceptOrderRequest {
        private String orderNo;
        private Long deliveryPersonId;
        private String deliveryPersonName;
        private String deliveryPersonPhone;

        // Getters and Setters
        public String getOrderNo() {
            return orderNo;
        }

        public void setOrderNo(String orderNo) {
            this.orderNo = orderNo;
        }

        public Long getDeliveryPersonId() {
            return deliveryPersonId;
        }

        public void setDeliveryPersonId(Long deliveryPersonId) {
            this.deliveryPersonId = deliveryPersonId;
        }

        public String getDeliveryPersonName() {
            return deliveryPersonName;
        }

        public void setDeliveryPersonName(String deliveryPersonName) {
            this.deliveryPersonName = deliveryPersonName;
        }

        public String getDeliveryPersonPhone() {
            return deliveryPersonPhone;
        }

        public void setDeliveryPersonPhone(String deliveryPersonPhone) {
            this.deliveryPersonPhone = deliveryPersonPhone;
        }
    }

    static class UpdateStatusRequest {
        private String orderNo;
        private Integer status;

        // Getters and Setters
        public String getOrderNo() {
            return orderNo;
        }

        public void setOrderNo(String orderNo) {
            this.orderNo = orderNo;
        }

        public Integer getStatus() {
            return status;
        }

        public void setStatus(Integer status) {
            this.status = status;
        }
    }
}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.TakeoutOrderItem;
import com.heikeji.mall.takeout.service.TakeoutOrderItemService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¤–å–è®¢å•å•†å“è¯¦æƒ…æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/order-item")
@Api(tags = "å¤–å–è®¢å•å•†å“è¯¦æƒ…ç®¡ç†")
public class TakeoutOrderItemController {

    @Autowired
    private TakeoutOrderItemService takeoutOrderItemService;

    /**
     * æ ¹æ®è®¢å•IDè·å–è®¢å•å•†å“åˆ—è¡¨
     */
    @GetMapping("/order/{orderId}")
    @ApiOperation("æ ¹æ®è®¢å•IDè·å–è®¢å•å•†å“åˆ—è¡¨")
    public R<List<TakeoutOrderItem>> getOrderItemsByOrderId(@PathVariable Long orderId) {
        List<TakeoutOrderItem> orderItems = takeoutOrderItemService.getOrderItemsByOrderId(orderId);
        return R.success(orderItems);
    }

    /**
     * æ‰¹é‡ä¿å­˜è®¢å•å•†å“
     */
    @PostMapping("/batch")
    @ApiOperation("æ‰¹é‡ä¿å­˜è®¢å•å•†å“")
    public R<Boolean> saveBatchOrderItems(@RequestBody List<TakeoutOrderItem> orderItems) {
        boolean result = takeoutOrderItemService.saveBatchOrderItems(orderItems);
        return R.success(result);
    }

}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.TakeoutProduct;
import com.heikeji.mall.takeout.service.TakeoutProductService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¤–å–å•†å“æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/product")
@Api(tags = "å¤–å–å•†å“ç®¡ç†")
public class TakeoutProductController {

    @Autowired
    private TakeoutProductService takeoutProductService;

    /**
     * æ ¹æ®å•†å®¶IDè·å–å•†å“åˆ—è¡¨
     */
    @GetMapping("/merchant/{merchantId}")
    @ApiOperation("æ ¹æ®å•†å®¶IDè·å–å•†å“åˆ—è¡¨")
    public R<List<TakeoutProduct>> getProductsByMerchantId(@PathVariable Long merchantId) {
        List<TakeoutProduct> products = takeoutProductService.getProductsByMerchantId(merchantId);
        return R.success(products);
    }

    /**
     * æ ¹æ®åˆ†ç±»IDè·å–å•†å“åˆ—è¡¨
     */
    @GetMapping("/category/{categoryId}")
    @ApiOperation("æ ¹æ®åˆ†ç±»IDè·å–å•†å“åˆ—è¡¨")
    public R<List<TakeoutProduct>> getProductsByCategoryId(@PathVariable Long categoryId) {
        List<TakeoutProduct> products = takeoutProductService.getProductsByCategoryId(categoryId);
        return R.success(products);
    }

    /**
     * è·å–æ¨èå•†å“
     */
    @GetMapping("/recommended/{merchantId}")
    @ApiOperation("è·å–æ¨èå•†å“")
    public R<List<TakeoutProduct>> getRecommendedProducts(@PathVariable Long merchantId, @RequestParam(defaultValue = "6") Integer limit) {
        List<TakeoutProduct> products = takeoutProductService.getRecommendedProducts(merchantId, limit);
        return R.success(products);
    }

    /**
     * è·å–å•†å“è¯¦æƒ…
     */
    @GetMapping("/{id}")
    @ApiOperation("è·å–å•†å“è¯¦æƒ…")
    public R<TakeoutProduct> getProductById(@PathVariable Long id) {
        TakeoutProduct product = takeoutProductService.getById(id);
        return R.success(product);
    }

}
package com.heikeji.mall.takeout.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.takeout.entity.TakeoutReview;
import com.heikeji.mall.takeout.service.TakeoutReviewService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * å¤–å–è¯„ä»·æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/takeout/review")
@Api(tags = "å¤–å–è¯„ä»·ç®¡ç†")
public class TakeoutReviewController {

    @Autowired
    private TakeoutReviewService takeoutReviewService;

    /**
     * åˆ›å»ºè¯„ä»·
     */
    @PostMapping
    @ApiOperation("åˆ›å»ºè¯„ä»·")
    public R<TakeoutReview> createReview(@RequestBody TakeoutReview review) {
        TakeoutReview createdReview = takeoutReviewService.createReview(review);
        return R.success(createdReview);
    }

    /**
     * æ ¹æ®å•†å®¶IDè·å–è¯„ä»·åˆ—è¡¨
     */
    @GetMapping("/merchant/{merchantId}")
    @ApiOperation("æ ¹æ®å•†å®¶IDè·å–è¯„ä»·åˆ—è¡¨")
    public R<List<TakeoutReview>> getReviewsByMerchantId(@PathVariable Long merchantId) {
        List<TakeoutReview> reviews = takeoutReviewService.getReviewsByMerchantId(merchantId);
        return R.success(reviews);
    }

    /**
     * æ ¹æ®ç”¨æˆ·IDè·å–è¯„ä»·åˆ—è¡¨
     */
    @GetMapping("/user/{userId}")
    @ApiOperation("æ ¹æ®ç”¨æˆ·IDè·å–è¯„ä»·åˆ—è¡¨")
    public R<List<TakeoutReview>> getReviewsByUserId(@PathVariable Long userId) {
        List<TakeoutReview> reviews = takeoutReviewService.getReviewsByUserId(userId);
        return R.success(reviews);
    }

    /**
     * æ ¹æ®è®¢å•IDè·å–è¯„ä»·
     */
    @GetMapping("/order/{orderId}")
    @ApiOperation("æ ¹æ®è®¢å•IDè·å–è¯„ä»·")
    public R<TakeoutReview> getReviewByOrderId(@PathVariable Long orderId) {
        TakeoutReview review = takeoutReviewService.getReviewByOrderId(orderId);
        return R.success(review);
    }

    /**
     * è·å–é«˜åˆ†è¯„ä»·
     */
    @GetMapping("/high-rating/{merchantId}")
    @ApiOperation("è·å–é«˜åˆ†è¯„ä»·")
    public R<List<TakeoutReview>> getHighRatingReviews(@PathVariable Long merchantId, @RequestParam(defaultValue = "5") Integer limit) {
        List<TakeoutReview> reviews = takeoutReviewService.getHighRatingReviews(merchantId, limit);
        return R.success(reviews);
    }

    /**
     * å•†å®¶å›å¤è¯„ä»·
     */
    @PutMapping("/reply")
    @ApiOperation("å•†å®¶å›å¤è¯„ä»·")
    public R<Boolean> replyReview(@RequestParam Long reviewId, @RequestParam String reply) {
        boolean result = takeoutReviewService.replyReview(reviewId, reply);
        return R.success(result);
    }

}
package com.heikeji.mall.takeout.dto;

import lombok.Data;
import java.math.BigDecimal;
import java.util.List;

/**
 * åˆ›å»ºå¤–å–è®¢å•è¯·æ±‚DTO
 */
@Data
public class CreateTakeoutOrderDTO {
    
    /** å•†å®¶ID */
    private Long merchantId;
    
    /** é…é€æ–¹å¼ï¼š1-å¤–å–æŸœï¼Œ2-ç‰¹æ®Šåœ°ç‚¹ï¼?-é€åˆ°å¯å®¤ */
    private Integer deliveryType;
    
    /** å¤–å–æŸœç¼–ç ï¼ˆé…é€æ–¹å¼ä¸ºå¤–å–æŸœæ—¶ä½¿ç”¨ï¼?*/
    private String deliveryLockerCode;
    
    /** ç‰¹æ®Šé…é€åœ°ç‚¹æè¿°ï¼ˆå¦‚ï¼šå¯å®¤æ¥¼é—¨å£é¥®æ–™æœºï¼?*/
    private String deliverySpecialPlace;
    
    /** å¯å®¤æ¥¼æ ‹ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormBuilding;
    
    /** å¯å®¤æˆ¿é—´å·ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormRoom;
    
    /** æ”¶è´§äººå§“å?*/
    private String receiverName;
    
    /** æ”¶è´§äººç”µè¯?*/
    private String receiverPhone;
    
    /** æ”¶è´§åœ°å€ */
    private String receiverAddress;
    
    /** è®¢å•å•†å“åˆ—è¡¨ */
    private List<OrderItemDTO> orderItems;
    
    /** å¤‡æ³¨ */
    private String remark;
    
    /** è®¢å•å•†å“é¡?*/
    @Data
    public static class OrderItemDTO {
        private Long productId;
        private Integer quantity;
        private BigDecimal price;
    }
}
package com.heikeji.mall.takeout.dto;

import lombok.Data;
import jakarta.validation.constraints.NotNull;
import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

/**
 * å¤–å–è®¢å•DTO
 */
@Data
public class TakeoutOrderDTO {
    
    /** å•†å®¶ID */
    @NotNull(message = "å•†å®¶IDä¸èƒ½ä¸ºç©º")
    private Long merchantId;
    
    /** é…é€æ–¹å¼ï¼š1-å¤–å–æŸœï¼Œ2-ç‰¹æ®Šåœ°ç‚¹ï¼?-é€åˆ°å¯å®¤ */
    @NotNull(message = "é…é€æ–¹å¼ä¸èƒ½ä¸ºç©?)
    private Integer deliveryType;
    
    /** å¤–å–æŸœç¼–ç ï¼ˆé…é€æ–¹å¼ä¸ºå¤–å–æŸœæ—¶ä½¿ç”¨ï¼?*/
    private String deliveryLockerCode;
    
    /** ç‰¹æ®Šé…é€åœ°ç‚¹æè¿?*/
    private String deliverySpecialPlace;
    
    /** å¯å®¤æ¥¼æ ‹ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormBuilding;
    
    /** å¯å®¤æˆ¿é—´å·ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormRoom;
    
    /** æ”¶è´§äººå§“å?*/
    @NotNull(message = "æ”¶è´§äººå§“åä¸èƒ½ä¸ºç©?)
    private String receiverName;
    
    /** æ”¶è´§äººç”µè¯?*/
    @NotNull(message = "æ”¶è´§äººç”µè¯ä¸èƒ½ä¸ºç©?)
    private String receiverPhone;
    
    /** æ”¶è´§åœ°å€ */
    @NotNull(message = "æ”¶è´§åœ°å€ä¸èƒ½ä¸ºç©º")
    private String receiverAddress;
    
    /** è®¢å•å•†å“åˆ—è¡¨ */
    @NotNull(message = "è®¢å•å•†å“ä¸èƒ½ä¸ºç©º")
    private List<OrderItemDTO> orderItems;
    
    /** è®¢å•å¤‡æ³¨ */
    private String remark;
    
    /** è®¢å•å•†å“DTO */
    @Data
    public static class OrderItemDTO {
        private Long productId;
        private Integer quantity;
        private BigDecimal price;
    }
}




package com.heikeji.mall.takeout.dto;

import lombok.Data;

import java.math.BigDecimal;
import java.time.LocalDateTime;

/**
 * å¤–å–è®¢å•å“åº”DTO
 */
@Data
public class TakeoutOrderResponseDTO {
    private Long id;
    private String orderSn;
    private Long merchantId;
    private String merchantName;
    private Long userId;
    private String deliveryMethod;
    private String deliveryLocation;
    private String receiverName;
    private String receiverPhone;
    private String deliveryStatus;
    private String deliveryStatusText;
    private Long courierId;
    private String courierName;
    private BigDecimal totalAmount;
    private LocalDateTime estimatedDeliveryTime;
    private LocalDateTime actualDeliveryTime;
    private LocalDateTime createTime;
    private LocalDateTime updateTime;
}
package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * å¤–å–æŸœå®ä½?
 */
@Data
@TableName("delivery_locker")
public class DeliveryLocker implements Serializable {
    private static final long serialVersionUID = 1L;

    @TableId(type = IdType.AUTO)
    private Long id;
    
    /** å¤–å–æŸœç¼–ç ?*/
    private String lockerCode;
    
    /** å¤–å–æŸœåç§?*/
    private String name;
    
    /** ä½ç½®æè¿° */
    private String location;
    
    /** æ ¡åŒº */
    private String campusArea;
    
    /** æ€»æ ¼å£æ•° */
    private Integer totalCells;
    
    /** å¯ç”¨æ ¼å£æ•?*/
    private Integer availableCells;
    
    /** çŠ¶æ€ï¼š0-æ­£å¸¸ï¼?-æ•…éšœ */
    private Integer status;
    
    /** åˆ›å»ºæ—¶é—´ */
    private Date createTime;
    
    /** æ›´æ–°æ—¶é—´ */
    private Date updateTime;
}




package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * å¤–å–å•†å®¶å®ä½“ç±? */
@Data
@TableName("merchant")
public class Merchant implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * å•†å®¶åç§°
     */
    private String name;

    /**
     * å•†å®¶æè¿°
     */
    private String description;

    /**
     * å•†å®¶logo
     */
    private String logo;

    /**
     * å•†å®¶åœ°å€
     */
    private String address;

    /**
     * è”ç³»ç”µè¯
     */
    private String phone;

    /**
     * è¥ä¸šæ—¶é—´
     */
    private String businessHours;

    /**
     * èµ·é€ä»·
     */
    private BigDecimal minPrice;

    /**
     * é…é€è´¹
     */
    private BigDecimal deliveryFee;

    /**
     * å¹³å‡è¯„åˆ†
     */
    private BigDecimal rating;

    /**
     * é”€é‡?     */
    private Integer sales;

    /**
     * çŠ¶æ€ï¼š0-ä¼‘æ¯ä¸?1-è¥ä¸šä¸?     */
    private Integer status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * å¤–å–å•†å“åˆ†ç±»å®ä½“ç±? */
@Data
@TableName("takeout_category")
public class TakeoutCategory implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * å•†å®¶ID
     */
    private Long merchantId;

    /**
     * åˆ†ç±»åç§°
     */
    private String name;

    /**
     * æ’åº
     */
    private Integer sort;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * å¤–å–æŸœå®ä½“ç±»
 */
@Data
@TableName("takeout_locker")
public class TakeoutLocker implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * å¤–å–æŸœç¼–ç ?     */
    private String lockerCode;

    /**
     * å¤–å–æŸœåç§?     */
    private String name;

    /**
     * ä½ç½®æè¿°
     */
    private String location;

    /**
     * æ€»æ ¼å­æ•°
     */
    private Integer totalSlots;

    /**
     * ç©ºé—²æ ¼å­æ•?     */
    private Integer availableSlots;

    /**
     * çŠ¶æ€ï¼š0-ç¦»çº¿ 1-åœ¨çº¿
     */
    private Integer status;

    /**
     * æœ€ååœ¨çº¿æ—¶é—?     */
    private Date lastOnlineTime;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * å¤–å–è®¢å•å®ä½“
 */
@Data
@TableName("takeout_order")
public class TakeoutOrder implements Serializable {
    private static final long serialVersionUID = 1L;

    @TableId(type = IdType.AUTO)
    private Long id;
    
    /** å…³è”è®¢å•ID */
    private Long orderId;
    
    /** è®¢å•å?*/
    private String orderNo;
    
    /** å•†å®¶ID */
    private Long merchantId;
    
    /** ç”¨æˆ·ID */
    private Long userId;
    
    /** é…é€æ–¹å¼ï¼š1-å¤–å–æŸœï¼Œ2-ç‰¹æ®Šåœ°ç‚¹ï¼?-é€åˆ°å¯å®¤ */
    private Integer deliveryType;
    
    /** å¤–å–æŸœç¼–ç ï¼ˆé…é€æ–¹å¼ä¸ºå¤–å–æŸœæ—¶ä½¿ç”¨ï¼?*/
    private String deliveryLockerCode;
    
    /** ç‰¹æ®Šé…é€åœ°ç‚¹æè¿°ï¼ˆå¦‚ï¼šå¯å®¤æ¥¼é—¨å£é¥®æ–™æœºï¼?*/
    private String deliverySpecialPlace;
    
    /** å¯å®¤æ¥¼æ ‹ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormBuilding;
    
    /** å¯å®¤æˆ¿é—´å·ï¼ˆé€åˆ°å¯å®¤æ—¶ä½¿ç”¨ï¼‰ */
    private String deliveryDormRoom;
    
    /** é…é€å‘˜ID */
    private Long deliveryPersonId;
    
    /** é…é€å‘˜å§“å */
    private String deliveryPersonName;
    
    /** é…é€å‘˜ç”µè¯ */
    private String deliveryPersonPhone;
    
    /** æ”¶è´§äººå§“å?*/
    private String receiverName;
    
    /** æ”¶è´§äººç”µè¯?*/
    private String receiverPhone;
    
    /** æ”¶è´§åœ°å€ */
    private String receiverAddress;
    
    /** é¢„è®¡é€è¾¾æ—¶é—´ */
    private Date estimatedTime;
    
    /** å®é™…é€è¾¾æ—¶é—´ */
    private Date actualTime;
    
    /** é…é€çŠ¶æ€ï¼š0-å¾…æ¥å•ï¼Œ1-å·²æ¥å•ï¼Œ2-é…é€ä¸­ï¼?-å·²é€è¾¾ï¼?-å·²å–æ¶?*/
    private Integer status;
    
    /** å¤‡æ³¨ */
    private String remark;
    
    /** åˆ›å»ºæ—¶é—´ */
    private Date createTime;
    
    /** æ›´æ–°æ—¶é—´ */
    private Date updateTime;
}




package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * å¤–å–è®¢å•å•†å“è¯¦æƒ…å®ä½“ç±? */
@Data
@TableName("takeout_order_item")
public class TakeoutOrderItem implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * è®¢å•ID
     */
    private Long orderId;

    /**
     * å•†å“ID
     */
    private Long productId;

    /**
     * å•†å“åç§°
     */
    private String productName;

    /**
     * å•†å“å›¾ç‰‡
     */
    private String productImage;

    /**
     * è´­ä¹°æ•°é‡
     */
    private Integer quantity;

    /**
     * å•†å“å•ä»·
     */
    private BigDecimal price;

    /**
     * å•†å“æ€»é‡‘é¢?     */
    private BigDecimal totalAmount;

    /**
     * å•†å“è§„æ ¼ï¼ˆå¦‚æœ‰ï¼‰
     */
    private String specifications;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * å¤–å–å•†å“å®ä½“ç±? */
@Data
@TableName("takeout_product")
public class TakeoutProduct implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * å•†å®¶ID
     */
    private Long merchantId;

    /**
     * åˆ†ç±»ID
     */
    private Long categoryId;

    /**
     * å•†å“åç§°
     */
    private String name;

    /**
     * å•†å“æè¿°
     */
    private String description;

    /**
     * å•†å“å›¾ç‰‡
     */
    private String image;

    /**
     * å•†å“ä»·æ ¼
     */
    private BigDecimal price;

    /**
     * åŸä»·
     */
    private BigDecimal originalPrice;

    /**
     * é”€é‡?     */
    private Integer sales;

    /**
     * åº“å­˜
     */
    private Integer stock;

    /**
     * å•†å“çŠ¶æ€ï¼š0-ä¸‹æ¶ 1-ä¸Šæ¶
     */
    private Integer status;

    /**
     * æ˜¯å¦æ¨èï¼?-å?1-æ˜?     */
    private Integer isRecommended;

    /**
     * æ’åº
     */
    private Integer sort;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.takeout.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * å¤–å–è¯„ä»·å®ä½“ç±? */
@Data
@TableName("takeout_review")
public class TakeoutReview implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * è®¢å•ID
     */
    private Long orderId;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * å•†å®¶ID
     */
    private Long merchantId;

    /**
     * è¯„åˆ†ï¼?-5æ˜?     */
    private Integer rating;

    /**
     * è¯„ä»·å†…å®¹
     */
    private String content;

    /**
     * è¯„ä»·å›¾ç‰‡ï¼ˆJSONæ ¼å¼ï¼?     */
    private String images;

    /**
     * è¯„ä»·ç±»å‹ï¼?-å•†å“è¯„ä»· 1-å•†å®¶è¯„ä»·
     */
    private Integer type;

    /**
     * æ˜¯å¦åŒ¿åï¼?-å?1-æ˜?     */
    private Integer isAnonymous;

    /**
     * å•†å®¶å›å¤
     */
    private String reply;

    /**
     * å›å¤æ—¶é—´
     */
    private Date replyTime;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

}
package com.heikeji.mall.takeout.enums;

import lombok.AllArgsConstructor;
import lombok.Getter;

/**
 * è®¢å•çŠ¶æ€æšä¸? */
@Getter
@AllArgsConstructor
public enum OrderStatusEnum {
    PENDING("pending", "å¾…æ¥å?),
    ACCEPTED("accepted", "å·²æ¥å?),
    DELIVERING("delivering", "é…é€ä¸­"),
    DELIVERED("delivered", "å·²é€è¾¾"),
    CANCELLED("cancelled", "å·²å–æ¶?);

    private final String value;
    private final String text;

    /**
     * æ ¹æ®å€¼è·å–å¯¹åº”çš„æšä¸¾
     */
    public static OrderStatusEnum getByValue(String value) {
        for (OrderStatusEnum status : values()) {
            if (status.value.equals(value)) {
                return status;
            }
        }
        return null;
    }

    /**
     * æ ¹æ®å€¼è·å–çŠ¶æ€æ–‡æœ?     */
    public static String getTextByValue(String value) {
        OrderStatusEnum status = getByValue(value);
        return status != null ? status.text : "æœªçŸ¥çŠ¶æ€?;
    }
}
package com.heikeji.mall.takeout.exception;

/**
 * å¤–å–æœåŠ¡è‡ªå®šä¹‰å¼‚å¸¸ç±»
 */
public class TakeoutException extends RuntimeException {
    private Integer code;

    public TakeoutException(Integer code, String message) {
        super(message);
        this.code = code;
    }

    public TakeoutException(String message) {
        super(message);
        this.code = 500;
    }

    public Integer getCode() {
        return code;
    }

    public void setCode(Integer code) {
        this.code = code;
    }
}
package com.heikeji.mall.takeout.exception;

import com.heikeji.common.core.domain.R;
import org.springframework.web.bind.annotation.ControllerAdvice;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * å¤–å–æœåŠ¡å¼‚å¸¸å¤„ç†å™? */
@ControllerAdvice
public class TakeoutExceptionHandler {

    /**
     * å¤„ç†ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(TakeoutException.class)
    @ResponseBody
    public R handleTakeoutException(TakeoutException e) {
        return R.error(e.getCode(), e.getMessage());
    }

    /**
     * å¤„ç†å‚æ•°å¼‚å¸¸
     */
    @ExceptionHandler(IllegalArgumentException.class)
    @ResponseBody
    public R handleIllegalArgumentException(IllegalArgumentException e) {
        return R.error(400, e.getMessage());
    }

    /**
     * å¤„ç†ç³»ç»Ÿå¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    @ResponseBody
    public R handleException(Exception e) {
        e.printStackTrace();
        return R.error(500, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }
}
package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.DeliveryLocker;
import org.apache.ibatis.annotations.Mapper;

/**
 * å¤–å–æŸœMapper
 */
@Mapper
public interface DeliveryLockerMapper extends BaseMapper<DeliveryLocker> {
}





package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.Merchant;

/**
 * å•†å®¶Mapperæ¥å£
 */
public interface MerchantMapper extends BaseMapper<Merchant> {

}
package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.TakeoutCategory;

import java.util.List;

/**
 * å¤–å–å•†å“åˆ†ç±»Mapperæ¥å£
 */
public interface TakeoutCategoryMapper extends BaseMapper<TakeoutCategory> {

    /**
     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢åˆ†ç±»åˆ—è¡¨
     */
    List<TakeoutCategory> selectByMerchantId(Long merchantId);

}
package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.TakeoutLocker;

import java.util.List;

/**
 * å¤–å–æŸœMapperæ¥å£
 */
public interface TakeoutLockerMapper extends BaseMapper<TakeoutLocker> {

    /**
     * æŸ¥è¯¢åœ¨çº¿ä¸”æœ‰ç©ºé—²æ ¼å­çš„å¤–å–æŸœ
     */
    List<TakeoutLocker> selectAvailableLockers();

    /**
     * æ ¹æ®ç¼–ç æŸ¥è¯¢å¤–å–æŸ?     */
    TakeoutLocker selectByLockerCode(String lockerCode);

}
package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.TakeoutOrderItem;

import java.util.List;

/**
 * å¤–å–è®¢å•å•†å“è¯¦æƒ…Mapperæ¥å£
 */
public interface TakeoutOrderItemMapper extends BaseMapper<TakeoutOrderItem> {

    /**
     * æ ¹æ®è®¢å•IDæŸ¥è¯¢è®¢å•å•†å“åˆ—è¡¨
     */
    List<TakeoutOrderItem> selectByOrderId(Long orderId);

    /**
     * æ ¹æ®å•†å“IDæŸ¥è¯¢é”€å”®è®°å½?     */
    List<TakeoutOrderItem> selectByProductId(Long productId);

}
package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.TakeoutOrder;
import org.apache.ibatis.annotations.Mapper;

/**
 * å¤–å–è®¢å•Mapper
 */
@Mapper
public interface TakeoutOrderMapper extends BaseMapper<TakeoutOrder> {
}




package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.TakeoutProduct;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * å¤–å–å•†å“Mapperæ¥å£
 */
public interface TakeoutProductMapper extends BaseMapper<TakeoutProduct> {

    /**
     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    List<TakeoutProduct> selectByMerchantId(Long merchantId);

    /**
     * æ ¹æ®åˆ†ç±»IDæŸ¥è¯¢å•†å“åˆ—è¡¨
     */
    List<TakeoutProduct> selectByCategoryId(Long categoryId);

    /**
     * æŸ¥è¯¢æ¨èå•†å“
     */
    List<TakeoutProduct> selectRecommendedProducts(@Param("merchantId") Long merchantId, @Param("limit") Integer limit);

}
package com.heikeji.mall.takeout.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.takeout.entity.TakeoutReview;

import java.util.List;

/**
 * å¤–å–è¯„ä»·Mapperæ¥å£
 */
public interface TakeoutReviewMapper extends BaseMapper<TakeoutReview> {

    /**
     * æ ¹æ®å•†å®¶IDæŸ¥è¯¢è¯„ä»·åˆ—è¡¨
     */
    List<TakeoutReview> selectByMerchantId(Long merchantId);

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è¯„ä»·åˆ—è¡¨
     */
    List<TakeoutReview> selectByUserId(Long userId);

    /**
     * æ ¹æ®è®¢å•IDæŸ¥è¯¢è¯„ä»·
     */
    TakeoutReview selectByOrderId(Long orderId);

    /**
     * æŸ¥è¯¢é«˜åˆ†è¯„ä»·
     */
    List<TakeoutReview> selectHighRatingReviews(Long merchantId, Integer limit);

}
package com.heikeji.mall.takeout.service;

import com.heikeji.mall.takeout.entity.DeliveryLocker;
import java.util.List;

/**
 * å¤–å–æŸœæœåŠ¡æ¥å? */
public interface DeliveryLockerService {
    
    /**
     * è·å–æ‰€æœ‰å¯ç”¨çš„å¤–å–æŸ?     * @return å¤–å–æŸœåˆ—è¡?     */
    List<DeliveryLocker> getAvailableLockers();
    
    /**
     * æ ¹æ®ç¼–ç æŸ¥è¯¢å¤–å–æŸ?     * @param lockerCode å¤–å–æŸœç¼–ç ?     * @return å¤–å–æŸ?     */
    DeliveryLocker getByCode(String lockerCode);
    
    /**
     * åˆ†é…æ ¼å£
     * @param lockerCode å¤–å–æŸœç¼–ç ?     * @return æ ¼å£å?     */
    String allocateCell(String lockerCode);
    
    /**
     * é‡Šæ”¾æ ¼å£
     * @param lockerCode å¤–å–æŸœç¼–ç ?     * @param cellNo æ ¼å£å?     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean releaseCell(String lockerCode, String cellNo);

    /** æ–°å¢å¤–å–æŸ?*/
    boolean create(DeliveryLocker locker);

    /** ç¼–è¾‘å¤–å–æŸ?*/
    boolean update(DeliveryLocker locker);
}


package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.mall.takeout.entity.Merchant;

import java.util.List;

/**
 * å•†å®¶æœåŠ¡æ¥å£
 */
public interface MerchantService extends IService<Merchant> {

    /**
     * è·å–è¥ä¸šä¸­çš„å•†å®¶åˆ—è¡¨
     */
    List<Merchant> getActiveMerchants();

    /**
     * åˆ†é¡µæŸ¥è¯¢å•†å®¶
     */
    Page<Merchant> pageMerchants(Page<Merchant> page);

    /**
     * æœç´¢å•†å®¶
     */
    List<Merchant> searchMerchants(String keyword);

}
package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.takeout.entity.TakeoutCategory;

import java.util.List;

/**
 * å¤–å–å•†å“åˆ†ç±»æœåŠ¡æ¥å£
 */
public interface TakeoutCategoryService extends IService<TakeoutCategory> {

    /**
     * æ ¹æ®å•†å®¶IDè·å–åˆ†ç±»åˆ—è¡¨
     */
    List<TakeoutCategory> getCategoriesByMerchantId(Long merchantId);

}
package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.takeout.entity.TakeoutLocker;

import java.util.List;

/**
 * å¤–å–æŸœæœåŠ¡æ¥å? */
public interface TakeoutLockerService extends IService<TakeoutLocker> {

    /**
     * è·å–å¯ç”¨çš„å¤–å–æŸœåˆ—è¡¨
     */
    List<TakeoutLocker> getAvailableLockers();

    /**
     * æ ¹æ®ç¼–ç è·å–å¤–å–æŸ?     */
    TakeoutLocker getLockerByCode(String lockerCode);

    /**
     * å ç”¨å¤–å–æŸœæ ¼å­?     */
    boolean occupySlot(String lockerCode);

    /**
     * é‡Šæ”¾å¤–å–æŸœæ ¼å­?     */
    boolean releaseSlot(String lockerCode);

    /**
     * æ›´æ–°å¤–å–æŸœçŠ¶æ€?     */
    boolean updateLockerStatus(String lockerCode, Integer status);

}
package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.takeout.entity.TakeoutOrderItem;

import java.util.List;

/**
 * å¤–å–è®¢å•å•†å“è¯¦æƒ…æœåŠ¡æ¥å£
 */
public interface TakeoutOrderItemService extends IService<TakeoutOrderItem> {

    /**
     * æ ¹æ®è®¢å•IDè·å–è®¢å•å•†å“åˆ—è¡¨
     */
    List<TakeoutOrderItem> getOrderItemsByOrderId(Long orderId);

    /**
     * æ‰¹é‡ä¿å­˜è®¢å•å•†å“
     */
    boolean saveBatchOrderItems(List<TakeoutOrderItem> orderItems);

}
package com.heikeji.mall.takeout.service;

import com.heikeji.mall.takeout.dto.TakeoutOrderDTO;
import com.heikeji.mall.takeout.entity.TakeoutOrder;

/**
 * å¤–å–è®¢å•æœåŠ¡æ¥å£
 */
public interface TakeoutOrderService {
    
    /**
     * åˆ›å»ºå¤–å–è®¢å•
     * @param userId ç”¨æˆ·ID
     * @param dto è®¢å•DTO
     * @return è®¢å•å?     */
    String createTakeoutOrder(Long userId, TakeoutOrderDTO dto);
    
    /**
     * æ ¹æ®è®¢å•å·æŸ¥è¯¢å¤–å–è®¢å?     * @param orderNo è®¢å•å?     * @return å¤–å–è®¢å•
     */
    TakeoutOrder getByOrderNo(String orderNo);
    
    /**
     * æ¥å•ï¼ˆé…é€å‘˜æ¥å•ï¼?     * @param orderNo è®¢å•å?     * @param deliveryPersonId é…é€å‘˜ID
     * @param deliveryPersonName é…é€å‘˜å§“å
     * @param deliveryPersonPhone é…é€å‘˜ç”µè¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean acceptOrder(String orderNo, Long deliveryPersonId, String deliveryPersonName, String deliveryPersonPhone);
    
    /**
     * æ›´æ–°é…é€çŠ¶æ€?     * @param orderNo è®¢å•å?     * @param status é…é€çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean updateDeliveryStatus(String orderNo, Integer status);
    
    /**
     * ç¡®è®¤é€è¾¾
     * @param orderNo è®¢å•å?     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean confirmDelivery(String orderNo);
    
    /**
     * å–æ¶ˆè®¢å•
     * @param orderNo è®¢å•å?     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    Boolean cancelOrder(String orderNo, Long userId);

    /**
     * åˆ†é¡µæŸ¥è¯¢å½“å‰ç”¨æˆ·å¤–å–è®¢å•
     */
    com.baomidou.mybatisplus.extension.plugins.pagination.Page<TakeoutOrder> pageQuery(Long userId, long pageNo, long pageSize, String orderNo);
}


package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.takeout.entity.TakeoutProduct;

import java.util.List;

/**
 * å¤–å–å•†å“æœåŠ¡æ¥å£
 */
public interface TakeoutProductService extends IService<TakeoutProduct> {

    /**
     * æ ¹æ®å•†å®¶IDè·å–å•†å“åˆ—è¡¨
     */
    List<TakeoutProduct> getProductsByMerchantId(Long merchantId);

    /**
     * æ ¹æ®åˆ†ç±»IDè·å–å•†å“åˆ—è¡¨
     */
    List<TakeoutProduct> getProductsByCategoryId(Long categoryId);

    /**
     * è·å–æ¨èå•†å“
     */
    List<TakeoutProduct> getRecommendedProducts(Long merchantId, Integer limit);

}
package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.takeout.entity.TakeoutReview;

import java.util.List;

/**
 * å¤–å–è¯„ä»·æœåŠ¡æ¥å£
 */
public interface TakeoutReviewService extends IService<TakeoutReview> {

    /**
     * åˆ›å»ºè¯„ä»·
     */
    TakeoutReview createReview(TakeoutReview review);

    /**
     * æ ¹æ®å•†å®¶IDè·å–è¯„ä»·åˆ—è¡¨
     */
    List<TakeoutReview> getReviewsByMerchantId(Long merchantId);

    /**
     * æ ¹æ®ç”¨æˆ·IDè·å–è¯„ä»·åˆ—è¡¨
     */
    List<TakeoutReview> getReviewsByUserId(Long userId);

    /**
     * æ ¹æ®è®¢å•IDè·å–è¯„ä»·
     */
    TakeoutReview getReviewByOrderId(Long orderId);

    /**
     * è·å–é«˜åˆ†è¯„ä»·
     */
    List<TakeoutReview> getHighRatingReviews(Long merchantId, Integer limit);

    /**
     * å•†å®¶å›å¤è¯„ä»·
     */
    boolean replyReview(Long reviewId, String reply);

}
package com.heikeji.mall.takeout.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.takeout.entity.TakeoutOrder;
import com.heikeji.mall.takeout.entity.DeliveryLocker;

import java.util.List;
import java.util.Map;

/**
 * å¤–å–æœåŠ¡æ¥å£
 */
public interface TakeoutService extends IService<TakeoutOrder> {
    
    /**
     * åˆ›å»ºå¤–å–è®¢å•
     */
    TakeoutOrder createTakeoutOrder(TakeoutOrder order);
    
    /**
     * è·å–å¤–å–è®¢å•è¯¦æƒ…
     */
    TakeoutOrder getTakeoutOrderById(Long id);
    
    /**
     * è·å–ç”¨æˆ·çš„å¤–å–è®¢å•åˆ—è¡?     */
    List<TakeoutOrder> getUserTakeoutOrders(Long userId, Integer status);
    
    /**
     * æ›´æ–°å¤–å–è®¢å•çŠ¶æ€?     */
    boolean updateOrderStatus(Long orderId, Integer status);
    
    /**
     * å–æ¶ˆå¤–å–è®¢å•
     */
    boolean cancelOrder(Long orderId, Long userId);
    
    /**
     * é…é€å‘˜æ¥å•
     */
    boolean acceptOrder(Long orderId, Long deliveryPersonId);
    
    /**
     * æ›´æ–°è®¢å•é…é€ä¿¡æ?     */
    boolean updateDeliveryInfo(Long orderId, Long deliveryPersonId, String deliveryPersonName, String deliveryPersonPhone);
    
    /**
     * æ ‡è®°è®¢å•å·²é€è¾¾
     */
    boolean markAsDelivered(Long orderId);
    
    /**
     * è·å–å¯ç”¨çš„å¤–å–æŸœåˆ—è¡¨
     */
    List<DeliveryLocker> getAvailableLockers();
    
    /**
     * æ ¹æ®ç¼–ç è·å–å¤–å–æŸ?     */
    DeliveryLocker getLockerByCode(String lockerCode);
    
    /**
     * å ç”¨å¤–å–æŸœæ ¼å?     */
    boolean occupyLockerCell(String lockerCode);
    
    /**
     * é‡Šæ”¾å¤–å–æŸœæ ¼å?     */
    boolean releaseLockerCell(String lockerCode);
}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.DeliveryLocker;
import com.heikeji.mall.takeout.mapper.DeliveryLockerMapper;
import com.heikeji.mall.takeout.service.DeliveryLockerService;
import org.springframework.stereotype.Service;

import java.util.Collections;
import java.util.List;

/**
 * å¤–å–æŸœæœåŠ¡å®ç? */
@Service
public class DeliveryLockerServiceImpl extends ServiceImpl<DeliveryLockerMapper, DeliveryLocker>
        implements DeliveryLockerService {

    @Override
    public List<DeliveryLocker> getAvailableLockers() {
        LambdaQueryWrapper<DeliveryLocker> qw = new LambdaQueryWrapper<>();
        qw.gt(DeliveryLocker::getAvailableCells, 0);
        return this.list(qw);
    }

    @Override
    public DeliveryLocker getByCode(String lockerCode) {
        LambdaQueryWrapper<DeliveryLocker> qw = new LambdaQueryWrapper<>();
        qw.eq(DeliveryLocker::getLockerCode, lockerCode);
        return this.getOne(qw);
    }

    @Override
    public String allocateCell(String lockerCode) {
        DeliveryLocker locker = getByCode(lockerCode);
        if (locker == null || locker.getAvailableCells() == null || locker.getAvailableCells() <= 0) {
            return null;
        }
        locker.setAvailableCells(locker.getAvailableCells() - 1);
        this.updateById(locker);
        // ç®€åŒ–ï¼šè¿”å›ä¸€ä¸ªå ä½æ ¼å£å·
        return "A-" + locker.getAvailableCells();
    }

    @Override
    public Boolean releaseCell(String lockerCode, String cellNo) {
        DeliveryLocker locker = getByCode(lockerCode);
        if (locker == null) {
            return false;
        }
        locker.setAvailableCells(locker.getAvailableCells() + 1);
        return this.updateById(locker);
    }

    @Override
    public boolean create(DeliveryLocker locker) {
        return this.save(locker);
    }

    @Override
    public boolean update(DeliveryLocker locker) {
        return this.updateById(locker);
    }
}



package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.Merchant;
import com.heikeji.mall.takeout.mapper.MerchantMapper;
import com.heikeji.mall.takeout.service.MerchantService;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * å•†å®¶æœåŠ¡å®ç°ç±? */
@Service
public class MerchantServiceImpl extends ServiceImpl<MerchantMapper, Merchant> implements MerchantService {

    @Override
    public List<Merchant> getActiveMerchants() {
        QueryWrapper<Merchant> wrapper = new QueryWrapper<>();
        wrapper.eq("status", 1) // è¥ä¸šä¸?               .orderByDesc("sales");
        return this.list(wrapper);
    }

    @Override
    public Page<Merchant> pageMerchants(Page<Merchant> page) {
        QueryWrapper<Merchant> wrapper = new QueryWrapper<>();
        wrapper.orderByDesc("sales");
        return this.page(page, wrapper);
    }

    @Override
    public List<Merchant> searchMerchants(String keyword) {
        QueryWrapper<Merchant> wrapper = new QueryWrapper<>();
        wrapper.like("name", keyword)
               .or().like("description", keyword)
               .orderByDesc("sales");
        return this.list(wrapper);
    }

}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.TakeoutCategory;
import com.heikeji.mall.takeout.mapper.TakeoutCategoryMapper;
import com.heikeji.mall.takeout.service.TakeoutCategoryService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * å¤–å–å•†å“åˆ†ç±»æœåŠ¡å®ç°ç±? */
@Service
public class TakeoutCategoryServiceImpl extends ServiceImpl<TakeoutCategoryMapper, TakeoutCategory> implements TakeoutCategoryService {

    @Autowired
    private TakeoutCategoryMapper takeoutCategoryMapper;

    @Override
    public List<TakeoutCategory> getCategoriesByMerchantId(Long merchantId) {
        return takeoutCategoryMapper.selectByMerchantId(merchantId);
    }

}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.TakeoutLocker;
import com.heikeji.mall.takeout.mapper.TakeoutLockerMapper;
import com.heikeji.mall.takeout.service.TakeoutLockerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Date;
import java.util.List;

/**
 * å¤–å–æŸœæœåŠ¡å®ç°ç±»
 */
@Service
public class TakeoutLockerServiceImpl extends ServiceImpl<TakeoutLockerMapper, TakeoutLocker> implements TakeoutLockerService {

    @Autowired
    private TakeoutLockerMapper takeoutLockerMapper;

    @Override
    public List<TakeoutLocker> getAvailableLockers() {
        return takeoutLockerMapper.selectAvailableLockers();
    }

    @Override
    public TakeoutLocker getLockerByCode(String lockerCode) {
        return takeoutLockerMapper.selectByLockerCode(lockerCode);
    }

    @Override
    public boolean occupySlot(String lockerCode) {
        TakeoutLocker locker = takeoutLockerMapper.selectByLockerCode(lockerCode);
        if (locker == null || locker.getAvailableSlots() <= 0) {
            return false;
        }
        
        // å‡å°‘ç©ºé—²æ ¼å­æ•?        locker.setAvailableSlots(locker.getAvailableSlots() - 1);
        locker.setUpdateTime(new Date());
        
        return takeoutLockerMapper.updateById(locker) > 0;
    }

    @Override
    public boolean releaseSlot(String lockerCode) {
        TakeoutLocker locker = takeoutLockerMapper.selectByLockerCode(lockerCode);
        if (locker == null || locker.getAvailableSlots() >= locker.getTotalSlots()) {
            return false;
        }
        
        // å¢åŠ ç©ºé—²æ ¼å­æ•?        locker.setAvailableSlots(locker.getAvailableSlots() + 1);
        locker.setUpdateTime(new Date());
        
        return takeoutLockerMapper.updateById(locker) > 0;
    }

    @Override
    public boolean updateLockerStatus(String lockerCode, Integer status) {
        TakeoutLocker locker = takeoutLockerMapper.selectByLockerCode(lockerCode);
        if (locker == null) {
            return false;
        }
        
        // æ›´æ–°çŠ¶æ€?        locker.setStatus(status);
        locker.setUpdateTime(new Date());
        
        // å¦‚æœæ˜¯åœ¨çº¿çŠ¶æ€ï¼Œæ›´æ–°æœ€ååœ¨çº¿æ—¶é—?        if (status == 1) {
            locker.setLastOnlineTime(new Date());
        }
        
        return takeoutLockerMapper.updateById(locker) > 0;
    }

}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.TakeoutOrderItem;
import com.heikeji.mall.takeout.mapper.TakeoutOrderItemMapper;
import com.heikeji.mall.takeout.service.TakeoutOrderItemService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Date;
import java.util.List;

/**
 * å¤–å–è®¢å•å•†å“è¯¦æƒ…æœåŠ¡å®ç°ç±? */
@Service
public class TakeoutOrderItemServiceImpl extends ServiceImpl<TakeoutOrderItemMapper, TakeoutOrderItem> implements TakeoutOrderItemService {

    @Autowired
    private TakeoutOrderItemMapper takeoutOrderItemMapper;

    @Override
    public List<TakeoutOrderItem> getOrderItemsByOrderId(Long orderId) {
        return takeoutOrderItemMapper.selectByOrderId(orderId);
    }

    @Override
    public boolean saveBatchOrderItems(List<TakeoutOrderItem> orderItems) {
        // è®¾ç½®åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—?        Date now = new Date();
        for (TakeoutOrderItem item : orderItems) {
            item.setCreateTime(now);
            item.setUpdateTime(now);
        }
        
        // æ‰¹é‡ä¿å­˜
        return saveBatch(orderItems);
    }

}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.common.core.constant.Constants;
import com.heikeji.common.core.exception.BaseException;
import com.heikeji.mall.takeout.dto.TakeoutOrderDTO;
import com.heikeji.mall.takeout.entity.TakeoutOrder;
import com.heikeji.mall.takeout.mapper.TakeoutOrderMapper;
import com.heikeji.mall.takeout.service.TakeoutOrderService;
import cn.hutool.core.util.IdUtil;
import cn.hutool.core.util.StrUtil;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;

/**
 * å¤–å–è®¢å•æœåŠ¡å®ç°ç±? */
@Slf4j
@Service
public class TakeoutOrderServiceImpl extends ServiceImpl<TakeoutOrderMapper, TakeoutOrder> 
        implements TakeoutOrderService {

    @Override
    @Transactional(rollbackFor = Exception.class)
    public String createTakeoutOrder(Long userId, TakeoutOrderDTO dto) {
        // ç”Ÿæˆè®¢å•å?        String orderNo = "TO" + System.currentTimeMillis() + IdUtil.fastSimpleUUID().substring(0, 6);
        
        // éªŒè¯é…é€æ–¹å¼ç›¸å…³å­—æ®?        validateDeliveryInfo(dto);
        
        // åˆ›å»ºå¤–å–è®¢å•
        TakeoutOrder takeoutOrder = new TakeoutOrder();
        takeoutOrder.setOrderId(0L); // åç»­å…³è”ä¸»è®¢å?        takeoutOrder.setOrderNo(orderNo);
        takeoutOrder.setMerchantId(dto.getMerchantId());
        takeoutOrder.setUserId(userId);
        takeoutOrder.setDeliveryType(dto.getDeliveryType());
        
        // æ ¹æ®é…é€æ–¹å¼è®¾ç½®ç›¸åº”å­—æ®?        if (Constants.DELIVERY_TYPE_LOCKER.equals(dto.getDeliveryType())) {
            // å¤–å–æŸœé…é€?            if (StrUtil.isBlank(dto.getDeliveryLockerCode())) {
                throw new BaseException("å¤–å–æŸœç¼–ç ä¸èƒ½ä¸ºç©?);
            }
            takeoutOrder.setDeliveryLockerCode(dto.getDeliveryLockerCode());
        } else if (Constants.DELIVERY_TYPE_SPECIAL.equals(dto.getDeliveryType())) {
            // ç‰¹æ®Šåœ°ç‚¹é…é€?            if (StrUtil.isBlank(dto.getDeliverySpecialPlace())) {
                throw new BaseException("ç‰¹æ®Šé…é€åœ°ç‚¹ä¸èƒ½ä¸ºç©?);
            }
            takeoutOrder.setDeliverySpecialPlace(dto.getDeliverySpecialPlace());
        } else if (Constants.DELIVERY_TYPE_DORM.equals(dto.getDeliveryType())) {
            // é€åˆ°å¯å®¤
            if (StrUtil.isBlank(dto.getDeliveryDormBuilding()) || StrUtil.isBlank(dto.getDeliveryDormRoom())) {
                throw new BaseException("å¯å®¤æ¥¼æ ‹å’Œæˆ¿é—´å·ä¸èƒ½ä¸ºç©º");
            }
            takeoutOrder.setDeliveryDormBuilding(dto.getDeliveryDormBuilding());
            takeoutOrder.setDeliveryDormRoom(dto.getDeliveryDormRoom());
        }
        
        takeoutOrder.setReceiverName(dto.getReceiverName());
        takeoutOrder.setReceiverPhone(dto.getReceiverPhone());
        takeoutOrder.setReceiverAddress(dto.getReceiverAddress());
        takeoutOrder.setStatus(Constants.ORDER_STATUS_UNPAID); // å¾…æ”¯ä»?        takeoutOrder.setRemark(dto.getRemark());
        takeoutOrder.setCreateTime(new Date());
        
        // ä¿å­˜å¤–å–è®¢å•
        this.save(takeoutOrder);
        
        log.info("åˆ›å»ºå¤–å–è®¢å•æˆåŠŸï¼Œè®¢å•å·ï¼š{}", orderNo);
        return orderNo;
    }
    
    /**
     * éªŒè¯é…é€ä¿¡æ?     */
    private void validateDeliveryInfo(TakeoutOrderDTO dto) {
        Integer deliveryType = dto.getDeliveryType();
        
        if (Constants.DELIVERY_TYPE_LOCKER.equals(deliveryType)) {
            if (StrUtil.isBlank(dto.getDeliveryLockerCode())) {
                throw new BaseException("é€‰æ‹©å¤–å–æŸœé…é€æ—¶ï¼Œå¤–å–æŸœç¼–ç ä¸èƒ½ä¸ºç©º");
            }
        } else if (Constants.DELIVERY_TYPE_SPECIAL.equals(deliveryType)) {
            if (StrUtil.isBlank(dto.getDeliverySpecialPlace())) {
                throw new BaseException("é€‰æ‹©ç‰¹æ®Šåœ°ç‚¹é…é€æ—¶ï¼Œé…é€åœ°ç‚¹ä¸èƒ½ä¸ºç©?);
            }
        } else if (Constants.DELIVERY_TYPE_DORM.equals(deliveryType)) {
            if (StrUtil.isBlank(dto.getDeliveryDormBuilding()) || StrUtil.isBlank(dto.getDeliveryDormRoom())) {
                throw new BaseException("é€‰æ‹©é€åˆ°å¯å®¤æ—¶ï¼Œæ¥¼æ ‹å’Œæˆ¿é—´å·ä¸èƒ½ä¸ºç©º");
            }
        } else {
            throw new BaseException("æ— æ•ˆçš„é…é€æ–¹å¼?);
        }
    }

    @Override
    public TakeoutOrder getByOrderNo(String orderNo) {
        LambdaQueryWrapper<TakeoutOrder> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(TakeoutOrder::getOrderNo, orderNo);
        return this.getOne(wrapper);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean acceptOrder(String orderNo, Long deliveryPersonId, String deliveryPersonName, String deliveryPersonPhone) {
        TakeoutOrder order = getByOrderNo(orderNo);
        if (order == null) {
            throw new BaseException("è®¢å•ä¸å­˜åœ?);
        }
        
        if (!Constants.ORDER_STATUS_UNPAID.equals(order.getStatus())) {
            throw new BaseException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•æ¥å?);
        }
        
        order.setDeliveryPersonId(deliveryPersonId);
        order.setDeliveryPersonName(deliveryPersonName);
        order.setDeliveryPersonPhone(deliveryPersonPhone);
        order.setStatus(1); // å·²æ¥å?        order.setUpdateTime(new Date());
        
        return this.updateById(order);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean updateDeliveryStatus(String orderNo, Integer status) {
        TakeoutOrder order = getByOrderNo(orderNo);
        if (order == null) {
            throw new BaseException("è®¢å•ä¸å­˜åœ?);
        }
        
        order.setStatus(status);
        order.setUpdateTime(new Date());
        
        if (status == 2) { // é…é€ä¸­
            // å¯ä»¥è®¾ç½®é¢„è®¡é€è¾¾æ—¶é—´
            Date estimatedTime = new Date(System.currentTimeMillis() + 30 * 60 * 1000); // é»˜è®¤30åˆ†é’Ÿå?            order.setEstimatedTime(estimatedTime);
        } else if (status == 3) { // å·²é€è¾¾
            order.setActualTime(new Date());
        }
        
        return this.updateById(order);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean confirmDelivery(String orderNo) {
        return updateDeliveryStatus(orderNo, 3); // å·²é€è¾¾
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public Boolean cancelOrder(String orderNo, Long userId) {
        TakeoutOrder order = getByOrderNo(orderNo);
        if (order == null) {
            throw new BaseException("è®¢å•ä¸å­˜åœ?);
        }
        
        if (!order.getUserId().equals(userId)) {
            throw new BaseException("æ— æƒå–æ¶ˆè¯¥è®¢å?);
        }
        
        // åªæœ‰å¾…æ”¯ä»˜æˆ–å¾…æ¥å•çŠ¶æ€æ‰èƒ½å–æ¶?        if (order.getStatus() > 1) {
            throw new BaseException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®ï¼Œæ— æ³•å–æ¶?);
        }
        
        order.setStatus(4); // å·²å–æ¶?        order.setUpdateTime(new Date());
        
        return this.updateById(order);
    }

    @Override
    public Page<TakeoutOrder> pageQuery(Long userId, long pageNo, long pageSize, String orderNo) {
        LambdaQueryWrapper<TakeoutOrder> qw = new LambdaQueryWrapper<>();
        qw.eq(TakeoutOrder::getUserId, userId);
        if (StrUtil.isNotBlank(orderNo)) {
            qw.eq(TakeoutOrder::getOrderNo, orderNo);
        }
        qw.orderByDesc(TakeoutOrder::getId);
        Page<TakeoutOrder> page = new Page<>(pageNo, pageSize);
        return this.page(page, qw);
    }
}


package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.TakeoutProduct;
import com.heikeji.mall.takeout.mapper.TakeoutProductMapper;
import com.heikeji.mall.takeout.service.TakeoutProductService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * å¤–å–å•†å“æœåŠ¡å®ç°ç±? */
@Service
public class TakeoutProductServiceImpl extends ServiceImpl<TakeoutProductMapper, TakeoutProduct> implements TakeoutProductService {

    @Autowired
    private TakeoutProductMapper takeoutProductMapper;

    @Override
    public List<TakeoutProduct> getProductsByMerchantId(Long merchantId) {
        return takeoutProductMapper.selectByMerchantId(merchantId);
    }

    @Override
    public List<TakeoutProduct> getProductsByCategoryId(Long categoryId) {
        return takeoutProductMapper.selectByCategoryId(categoryId);
    }

    @Override
    public List<TakeoutProduct> getRecommendedProducts(Long merchantId, Integer limit) {
        return takeoutProductMapper.selectRecommendedProducts(merchantId, limit);
    }

}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.entity.TakeoutReview;
import com.heikeji.mall.takeout.mapper.TakeoutReviewMapper;
import com.heikeji.mall.takeout.service.TakeoutReviewService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Date;
import java.util.List;

/**
 * å¤–å–è¯„ä»·æœåŠ¡å®ç°ç±? */
@Service
public class TakeoutReviewServiceImpl extends ServiceImpl<TakeoutReviewMapper, TakeoutReview> implements TakeoutReviewService {

    @Autowired
    private TakeoutReviewMapper takeoutReviewMapper;

    @Override
    public TakeoutReview createReview(TakeoutReview review) {
        // è®¾ç½®åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—?        review.setCreateTime(new Date());
        review.setUpdateTime(new Date());
        
        // ä¿å­˜è¯„ä»·
        takeoutReviewMapper.insert(review);
        
        return review;
    }

    @Override
    public List<TakeoutReview> getReviewsByMerchantId(Long merchantId) {
        return takeoutReviewMapper.selectByMerchantId(merchantId);
    }

    @Override
    public List<TakeoutReview> getReviewsByUserId(Long userId) {
        return takeoutReviewMapper.selectByUserId(userId);
    }

    @Override
    public TakeoutReview getReviewByOrderId(Long orderId) {
        return takeoutReviewMapper.selectByOrderId(orderId);
    }

    @Override
    public List<TakeoutReview> getHighRatingReviews(Long merchantId, Integer limit) {
        return takeoutReviewMapper.selectHighRatingReviews(merchantId, limit);
    }

    @Override
    public boolean replyReview(Long reviewId, String reply) {
        TakeoutReview review = takeoutReviewMapper.selectById(reviewId);
        if (review == null) {
            return false;
        }
        
        // æ›´æ–°å›å¤ä¿¡æ¯
        review.setReply(reply);
        review.setReplyTime(new Date());
        review.setUpdateTime(new Date());
        
        return takeoutReviewMapper.updateById(review) > 0;
    }

}
package com.heikeji.mall.takeout.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.takeout.constants.TakeoutConstants;
import com.heikeji.mall.takeout.entity.TakeoutOrder;
import com.heikeji.mall.takeout.entity.DeliveryLocker;
import com.heikeji.mall.takeout.exception.TakeoutException;
import com.heikeji.mall.takeout.mapper.TakeoutOrderMapper;
import com.heikeji.mall.takeout.mapper.DeliveryLockerMapper;
import com.heikeji.mall.takeout.service.TakeoutService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;
import java.util.UUID;

/**
 * å¤–å–æœåŠ¡å®ç°ç±? */
@Service
public class TakeoutServiceImpl extends ServiceImpl<TakeoutOrderMapper, TakeoutOrder> implements TakeoutService {

    @Autowired
    private TakeoutOrderMapper takeoutOrderMapper;
    
    @Autowired
    private DeliveryLockerMapper deliveryLockerMapper;

    @Transactional(rollbackFor = Exception.class)
    @Override
    public TakeoutOrder createTakeoutOrder(TakeoutOrder order) {
        // éªŒè¯è®¢å•ä¿¡æ¯
        validateOrderInfo(order);
        
        // ç”Ÿæˆè®¢å•å?        String orderNo = generateOrderNo();
        order.setOrderNo(orderNo);
        order.setStatus(0); // å¾…æ¥å?        order.setCreateTime(new Date());
        order.setUpdateTime(new Date());
        
        // å¦‚æœæ˜¯å¤–å–æŸœé…é€ï¼Œå ç”¨æŸœæ ¼
        if (order.getDeliveryType() == 1 && order.getDeliveryLockerCode() != null) {
            if (!occupyLockerCell(order.getDeliveryLockerCode())) {
                throw new TakeoutException(TakeoutConstants.ERROR_CODE_LOCKER_NOT_AVAILABLE, "å¤–å–æŸœå·²æ»¡æˆ–æ•…éšœ");
            }
        }
        
        int result = takeoutOrderMapper.insert(order);
        if (result <= 0) {
            throw new TakeoutException("è®¢å•åˆ›å»ºå¤±è´¥");
        }
        return order;
    }

    @Override
    public TakeoutOrder getTakeoutOrderById(Long id) {
        if (id == null) {
            throw new IllegalArgumentException("è®¢å•IDä¸èƒ½ä¸ºç©º");
        }
        TakeoutOrder order = takeoutOrderMapper.selectById(id);
        if (order == null) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?);
        }
        return order;
    }

    @Override
    public List<TakeoutOrder> getUserTakeoutOrders(Long userId, Integer status) {
        LambdaQueryWrapper<TakeoutOrder> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(TakeoutOrder::getUserId, userId);
        if (status != null) {
            queryWrapper.eq(TakeoutOrder::getStatus, status);
        }
        queryWrapper.orderByDesc(TakeoutOrder::getCreateTime);
        return takeoutOrderMapper.selectList(queryWrapper);
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean updateOrderStatus(Long orderId, Integer status) {
        if (orderId == null) {
            throw new IllegalArgumentException("è®¢å•IDä¸èƒ½ä¸ºç©º");
        }
        if (!isValidStatus(status)) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_INVALID_STATUS, "æ— æ•ˆçš„è®¢å•çŠ¶æ€?);
        }
        
        TakeoutOrder order = takeoutOrderMapper.selectById(orderId);
        if (order == null) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?);
        }
        
        // éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³?        validateStatusTransition(order.getStatus(), status);
        
        order.setStatus(status);
        order.setUpdateTime(new Date());
        
        // å¦‚æœæ˜¯å·²é€è¾¾ï¼Œè®°å½•å®é™…é€è¾¾æ—¶é—´
        if (status == 3) {
            order.setActualTime(new Date());
        }
        
        // å¦‚æœæ˜¯å–æ¶ˆè®¢å•ä¸”ä½¿ç”¨äº†å¤–å–æŸœï¼Œé‡Šæ”¾æŸœæ ?        if (status == 4 && order.getDeliveryType() == 1 && order.getDeliveryLockerCode() != null) {
            releaseLockerCell(order.getDeliveryLockerCode());
        }
        
        return takeoutOrderMapper.updateById(order) > 0;
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean cancelOrder(Long orderId, Long userId) {
        if (orderId == null || userId == null) {
            throw new IllegalArgumentException("è®¢å•IDå’Œç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        LambdaQueryWrapper<TakeoutOrder> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(TakeoutOrder::getId, orderId);
        queryWrapper.eq(TakeoutOrder::getUserId, userId);
        
        TakeoutOrder order = takeoutOrderMapper.selectOne(queryWrapper);
        if (order == null) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?);
        }
        
        // åªæœ‰å¾…æ¥å•å’Œå·²æ¥å•çŠ¶æ€å¯ä»¥å–æ¶?        if (order.getStatus() != 0 && order.getStatus() != 1) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_CANNOT_CANCEL, "å½“å‰è®¢å•çŠ¶æ€ä¸å…è®¸å–æ¶ˆ");
        }
        
        // å–æ¶ˆè®¢å•
        order.setStatus(4);
        order.setUpdateTime(new Date());
        
        // å¦‚æœä½¿ç”¨äº†å¤–å–æŸœï¼Œé‡Šæ”¾æŸœæ ?        if (order.getDeliveryType() == 1 && order.getDeliveryLockerCode() != null) {
            releaseLockerCell(order.getDeliveryLockerCode());
        }
        
        return takeoutOrderMapper.updateById(order) > 0;
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean acceptOrder(Long orderId, Long deliveryPersonId) {
        if (orderId == null || deliveryPersonId == null) {
            throw new IllegalArgumentException("è®¢å•IDå’Œé…é€å‘˜IDä¸èƒ½ä¸ºç©º");
        }
        
        TakeoutOrder order = takeoutOrderMapper.selectById(orderId);
        if (order == null) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?);
        }
        
        // åªæœ‰å¾…æ¥å•çŠ¶æ€å¯ä»¥æ¥å?        if (order.getStatus() != 0) {
            throw new TakeoutException("è®¢å•å·²è¢«æ¥å•æˆ–å–æ¶?);
        }
        
        order.setStatus(1); // å·²æ¥å?        order.setDeliveryPersonId(deliveryPersonId);
        order.setUpdateTime(new Date());
        
        return takeoutOrderMapper.updateById(order) > 0;
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean updateDeliveryInfo(Long orderId, Long deliveryPersonId, String deliveryPersonName, String deliveryPersonPhone) {
        if (orderId == null) {
            throw new IllegalArgumentException("è®¢å•IDä¸èƒ½ä¸ºç©º");
        }
        
        TakeoutOrder order = takeoutOrderMapper.selectById(orderId);
        if (order == null) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?);
        }
        
        order.setDeliveryPersonId(deliveryPersonId);
        order.setDeliveryPersonName(deliveryPersonName);
        order.setDeliveryPersonPhone(deliveryPersonPhone);
        order.setUpdateTime(new Date());
        
        return takeoutOrderMapper.updateById(order) > 0;
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean markAsDelivered(Long orderId) {
        if (orderId == null) {
            throw new IllegalArgumentException("è®¢å•IDä¸èƒ½ä¸ºç©º");
        }
        
        TakeoutOrder order = takeoutOrderMapper.selectById(orderId);
        if (order == null) {
            throw new TakeoutException(TakeoutConstants.ERROR_CODE_ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?);
        }
        
        if (order.getStatus() != 2) {
            throw new TakeoutException("åªæœ‰é…é€ä¸­çš„è®¢å•æ‰èƒ½æ ‡è®°ä¸ºå·²é€è¾¾");
        }
        
        order.setStatus(3); // å·²é€è¾¾
        order.setActualTime(new Date());
        order.setUpdateTime(new Date());
        
        return takeoutOrderMapper.updateById(order) > 0;
    }

    @Override
    public List<DeliveryLocker> getAvailableLockers() {
        LambdaQueryWrapper<DeliveryLocker> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(DeliveryLocker::getStatus, TakeoutConstants.LOCKER_STATUS_NORMAL); // æ­£å¸¸çŠ¶æ€?        queryWrapper.gt(DeliveryLocker::getAvailableCells, 0); // æœ‰å¯ç”¨æ ¼å?        return deliveryLockerMapper.selectList(queryWrapper);
    }

    @Override
    public DeliveryLocker getLockerByCode(String lockerCode) {
        LambdaQueryWrapper<DeliveryLocker> queryWrapper = new LambdaQueryWrapper<>();
        queryWrapper.eq(DeliveryLocker::getLockerCode, lockerCode);
        return deliveryLockerMapper.selectOne(queryWrapper);
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean occupyLockerCell(String lockerCode) {
        if (lockerCode == null || lockerCode.trim().isEmpty()) {
            throw new IllegalArgumentException("å¤–å–æŸœç¼–ç ä¸èƒ½ä¸ºç©?);
        }
        
        DeliveryLocker locker = getLockerByCode(lockerCode);
        if (locker == null) {
            throw new TakeoutException("å¤–å–æŸœä¸å­˜åœ¨");
        }
        
        if (locker.getStatus() != TakeoutConstants.LOCKER_STATUS_NORMAL) {
            throw new TakeoutException("å¤–å–æŸœæ•…éš?);
        }
        
        if (locker.getAvailableCells() <= 0) {
            throw new TakeoutException("å¤–å–æŸœå·²æ»?);
        }
        
        locker.setAvailableCells(locker.getAvailableCells() - 1);
        locker.setUpdateTime(new Date());
        
        return deliveryLockerMapper.updateById(locker) > 0;
    }

    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean releaseLockerCell(String lockerCode) {
        if (lockerCode == null || lockerCode.trim().isEmpty()) {
            throw new IllegalArgumentException("å¤–å–æŸœç¼–ç ä¸èƒ½ä¸ºç©?);
        }
        
        DeliveryLocker locker = getLockerByCode(lockerCode);
        if (locker == null) {
            throw new TakeoutException("å¤–å–æŸœä¸å­˜åœ¨");
        }
        
        if (locker.getStatus() != TakeoutConstants.LOCKER_STATUS_NORMAL) {
            throw new TakeoutException("å¤–å–æŸœæ•…éš?);
        }
        
        if (locker.getAvailableCells() >= locker.getTotalCells()) {
            throw new TakeoutException("å¤–å–æŸœæ ¼å£å·²å…¨éƒ¨é‡Šæ”¾");
        }
        
        locker.setAvailableCells(locker.getAvailableCells() + 1);
        locker.setUpdateTime(new Date());
        
        return deliveryLockerMapper.updateById(locker) > 0;
    }
    
    /**
     * éªŒè¯è®¢å•ä¿¡æ¯
     */
    private void validateOrderInfo(TakeoutOrder order) {
        if (order == null) {
            throw new IllegalArgumentException("è®¢å•ä¿¡æ¯ä¸èƒ½ä¸ºç©º");
        }
        if (order.getUserId() == null) {
            throw new IllegalArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        if (order.getMerchantId() == null) {
            throw new IllegalArgumentException("å•†å®¶IDä¸èƒ½ä¸ºç©º");
        }
        if (order.getDeliveryType() == null) {
            throw new IllegalArgumentException("é…é€æ–¹å¼ä¸èƒ½ä¸ºç©?);
        }
        // éªŒè¯é…é€æ–¹å¼?        if (order.getDeliveryType() == 1 && (order.getDeliveryLockerCode() == null || order.getDeliveryLockerCode().trim().isEmpty())) {
            throw new IllegalArgumentException("å¤–å–æŸœé…é€å¿…é¡»é€‰æ‹©å¤–å–æŸ?);
        }
    }

    /**
     * éªŒè¯çŠ¶æ€æ˜¯å¦æœ‰æ•?     */
    private boolean isValidStatus(Integer status) {
        return status != null && (status >= 0 && status <= 4);
    }

    /**
     * éªŒè¯çŠ¶æ€è½¬æ¢æ˜¯å¦åˆæ³?     */
    private void validateStatusTransition(Integer currentStatus, Integer newStatus) {
        // å·²å®Œæˆæˆ–å·²å–æ¶ˆçš„è®¢å•ä¸èƒ½å†ä¿®æ”¹çŠ¶æ€?        if (currentStatus == 3 || currentStatus == 4) {
            throw new TakeoutException("è®¢å•å·²ç»“æŸï¼Œæ— æ³•ä¿®æ”¹çŠ¶æ€?);
        }
        
        // çŠ¶æ€åªèƒ½å‘å‰æ¨è¿›æˆ–å–æ¶ˆ
        if (newStatus != 4 && newStatus <= currentStatus) {
            throw new TakeoutException("æ— æ•ˆçš„çŠ¶æ€è½¬æ?);
        }
    }

    /**
     * ç”Ÿæˆè®¢å•å?     */
    private String generateOrderNo() {
        String timestamp = String.valueOf(System.currentTimeMillis());
        String random = UUID.randomUUID().toString().substring(0, 8);
        return "TO" + timestamp + random;
    }
}
package com.heikeji.mall.takeout.utils;

import com.heikeji.common.core.domain.R;

/**
 * ç»“æœå·¥å…·ç±? */
public class ResultUtil {
    /**
     * æˆåŠŸå“åº”
     */
    public static <T> R<T> ok(T data) {
        return R.success(data);
    }

    /**
     * æˆåŠŸå“åº”
     */
    public static R ok() {
        return R.success();
    }
    
    /**
     * æˆåŠŸå“åº” - å¸ƒå°”å€?     */
    public static R<Boolean> success(boolean data) {
        return R.success(data);
    }
    
    /**
     * æˆåŠŸå“åº” - é€šç”¨ç±»å‹
     */
    public static <T> R<T> success(T data) {
        return R.success(data);
    }

    /**
     * å¤±è´¥å“åº”
     */
    public static R<?> error(Integer code, String message) {
        return R.error(code, message);
    }

    /**
     * å¤±è´¥å“åº”ï¼ˆé»˜è®¤é”™è¯¯ç ï¼?     */
    public static R<?> error(String message) {
        return R.error(message);
    }
}
package com.heikeji.mall.common.auth;

import com.heikeji.mall.common.exception.AuthenticationException;
import com.heikeji.mall.common.exception.AuthorizationException;
import com.heikeji.mall.common.response.R;
import com.heikeji.mall.user.entity.User;
import com.heikeji.mall.user.service.UserService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import jakarta.servlet.http.HttpServletRequest;

/**
 * è®¤è¯æœåŠ¡
 * å¤„ç†ç”¨æˆ·è®¤è¯å’Œæˆæƒç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
 */
@Slf4j
@Service
public class AuthenticationService {

    @Autowired
    private JwtUtils jwtUtils;

    @Autowired
    private UserService userService;

    @Autowired
    private HttpServletRequest request;

    /**
     * ç”¨æˆ·ç™»å½•è®¤è¯
     */
    public R<String> authenticateUser(String loginType, String credential, String extraInfo) {
        try {
            // æ ¹æ®ç™»å½•ç±»å‹è¿›è¡Œä¸åŒçš„è®¤è¯å¤„ç?            switch (loginType.toLowerCase()) {
                case "wechat":
                    return authenticateWechat(credential, extraInfo);
                case "phone":
                    return authenticatePhone(credential, extraInfo);
                case "email":
                    return authenticateEmail(credential, extraInfo);
                default:
                    return R.badRequest("ä¸æ”¯æŒçš„ç™»å½•æ–¹å¼: " + loginType);
            }
        } catch (Exception e) {
            log.error("ç”¨æˆ·è®¤è¯å¤±è´¥: {}", e.getMessage(), e);
            return R.unauthorized("è®¤è¯å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * å¾®ä¿¡è®¤è¯
     */
    private R<String> authenticateWechat(String code, String userInfo) {
        if (!StringUtils.hasText(code)) {
            return R.badRequest("å¾®ä¿¡æˆæƒç ä¸èƒ½ä¸ºç©?);
        }

        try {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡APIéªŒè¯codeå¹¶è·å–openid
            // ç®€åŒ–å¤„ç†ï¼Œå‡è®¾éªŒè¯æˆåŠŸ
            String openid = "mock_openid_" + System.currentTimeMillis();
            
            // æ ¹æ®openidæŸ¥è¯¢ç”¨æˆ·æˆ–åˆ›å»ºæ–°ç”¨æˆ·
            User user = userService.getUserByOpenId(openid);
            if (user == null) {
                // åˆ›å»ºæ–°ç”¨æˆ?                user = createWechatUser(openid, userInfo);
            }

            // ç”ŸæˆJWT token
            String token = jwtUtils.generateToken(user.getId(), user.getUserType());
            
            // è®°å½•ç™»å½•æ—¥å¿—
            log.info("ç”¨æˆ·{}é€šè¿‡å¾®ä¿¡ç™»å½•æˆåŠŸ", user.getId());
            
            return R.success("ç™»å½•æˆåŠŸ", token);
        } catch (Exception e) {
            log.error("å¾®ä¿¡ç™»å½•å¤±è´¥", e);
            return R.unauthorized("å¾®ä¿¡ç™»å½•éªŒè¯å¤±è´¥");
        }
    }

    /**
     * æ‰‹æœºå·è®¤è¯?     */
    private R<String> authenticatePhone(String phone, String verificationCode) {
        if (!StringUtils.hasText(phone)) {
            return R.badRequest("æ‰‹æœºå·ä¸èƒ½ä¸ºç©?);
        }

        if (!StringUtils.hasText(verificationCode)) {
            return R.badRequest("éªŒè¯ç ä¸èƒ½ä¸ºç©?);
        }

        // éªŒè¯éªŒè¯ç ï¼ˆè¿™é‡Œåº”è¯¥è°ƒç”¨éªŒè¯ç æœåŠ¡ï¼‰
        boolean verifyResult = verifySmsCode(phone, verificationCode);
        if (!verifyResult) {
            return R.verificationCodeInvalid();
        }

        try {
            // æ ¹æ®æ‰‹æœºå·æŸ¥æ‰¾ç”¨æˆ?            User user = userService.getUserByPhone(phone);
            if (user == null) {
                return R.userNotFound();
            }

            // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€?            if (!isUserActive(user)) {
                return R.userDisabled();
            }

            // ç”ŸæˆJWT token
            String token = jwtUtils.generateToken(user.getId(), user.getUserType());
            
            log.info("ç”¨æˆ·{}é€šè¿‡æ‰‹æœºå·ç™»å½•æˆåŠ?, user.getId());
            
            return R.success("ç™»å½•æˆåŠŸ", token);
        } catch (Exception e) {
            log.error("æ‰‹æœºå·ç™»å½•å¤±è´?, e);
            return R.unauthorized("ç™»å½•éªŒè¯å¤±è´¥");
        }
    }

    /**
     * é‚®ç®±è®¤è¯
     */
    private R<String> authenticateEmail(String email, String password) {
        if (!StringUtils.hasText(email)) {
            return R.badRequest("é‚®ç®±ä¸èƒ½ä¸ºç©º");
        }

        if (!StringUtils.hasText(password)) {
            return R.badRequest("å¯†ç ä¸èƒ½ä¸ºç©º");
        }

        try {
            // æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç”¨æˆ·
            User user = userService.getUserByEmail(email);
            if (user == null) {
                return R.userNotFound();
            }

            // éªŒè¯å¯†ç 
            if (!verifyPassword(password, user.getPassword())) {
                return R.invalidCredentials();
            }

            // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€?            if (!isUserActive(user)) {
                return R.userDisabled();
            }

            // ç”ŸæˆJWT token
            String token = jwtUtils.generateToken(user.getId(), user.getUserType());
            
            log.info("ç”¨æˆ·{}é€šè¿‡é‚®ç®±ç™»å½•æˆåŠŸ", user.getId());
            
            return R.success("ç™»å½•æˆåŠŸ", token);
        } catch (Exception e) {
            log.error("é‚®ç®±ç™»å½•å¤±è´¥", e);
            return R.unauthorized("ç™»å½•éªŒè¯å¤±è´¥");
        }
    }

    /**
     * éªŒè¯JWT tokenå¹¶è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
     */
    public UserContext validateTokenAndGetContext(String token) {
        if (!StringUtils.hasText(token)) {
            throw new AuthenticationException("Tokenä¸èƒ½ä¸ºç©º");
        }

        try {
            // éªŒè¯tokenæœ‰æ•ˆæ€?            if (!jwtUtils.validateToken(token)) {
                throw new AuthenticationException("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
            }

            // ä»tokenä¸­æå–ç”¨æˆ·ä¿¡æ?            Long userId = jwtUtils.getUserIdFromToken(token);
            String userType = jwtUtils.getUserTypeFromToken(token);

            if (userId == null) {
                throw new AuthenticationException("Tokenä¸­ç¼ºå°‘ç”¨æˆ·ä¿¡æ?);
            }

            // ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
            User user = userService.getById(userId);
            if (user == null) {
                throw new AuthenticationException("ç”¨æˆ·ä¸å­˜åœ?);
            }

            if (!isUserActive(user)) {
                throw new AuthenticationException("ç”¨æˆ·å·²è¢«ç¦ç”¨");
            }

            // éªŒè¯ç”¨æˆ·ç±»å‹æ˜¯å¦åŒ¹é…
            if (!userType.equals(user.getUserType())) {
                throw new AuthenticationException("ç”¨æˆ·ç±»å‹ä¸åŒ¹é…?);
            }

            // æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–?            UserContext context = new UserContext();
            context.setUserId(user.getId());
            context.setUserType(user.getUserType());
            context.setPhone(user.getPhone());
            context.setStudentNo(user.getStudentNo());
            context.setOpenid(user.getOpenid());
            context.setNickname(user.getNickname());
            context.setStatus(user.getStatus());

            return context;
        } catch (AuthenticationException e) {
            throw e;
        } catch (Exception e) {
            log.error("TokenéªŒè¯å¤±è´¥", e);
            throw new AuthenticationException("TokenéªŒè¯å¤±è´¥");
        }
    }

    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™?     */
    public boolean checkPermission(String permission, UserContext userContext) {
        if (userContext == null) {
            return false;
        }

        // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™?        if (userContext.isAdmin()) {
            return true;
        }

        // æ ¹æ®æƒé™ç±»å‹è¿›è¡Œæƒé™æ£€æŸ?        switch (permission) {
            case "user:read":
                return true; // æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰è¯»å–æƒé™?            case "user:write":
                // ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ?                return true;
            case "user:admin":
                // åªæœ‰ç®¡ç†å‘˜æœ‰ç®¡ç†å‘˜æƒé™?                return userContext.isAdmin();
            case "merchant:read":
            case "merchant:write":
                // å•†æˆ·ç›¸å…³æƒé™
                return userContext.isMerchant() || userContext.isAdmin();
            default:
                return false;
        }
    }

    /**
     * éªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™?     */
    public void requirePermission(String permission) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException("ç”¨æˆ·æœªç™»å½?);
        }

        if (!checkPermission(permission, userContext)) {
            throw new AuthorizationException("æƒé™ä¸è¶³: " + permission);
        }
    }

    /**
     * éªŒè¯ç”¨æˆ·æ˜¯å¦ä¸ºè‡ªå·±çš„èµ„æº
     */
    public void requireOwnerOrAdmin(Long resourceOwnerId) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException("ç”¨æˆ·æœªç™»å½?);
        }

        if (!userContext.getUserId().equals(resourceOwnerId) && !userContext.isAdmin()) {
            throw new AuthorizationException("åªèƒ½æ“ä½œè‡ªå·±çš„èµ„æº?);
        }
    }

    // ========== ç§æœ‰è¾…åŠ©æ–¹æ³• ==========

    private User createWechatUser(String openid, String userInfo) {
        User user = new User();
        user.setUserType("USER");
        user.setStatus((byte) 1); // æ¿€æ´»çŠ¶æ€?        user.setCreateTime(java.util.Date.from(java.time.LocalDateTime.now().atZone(java.time.ZoneId.systemDefault()).toInstant()));
        user.setUpdateTime(java.util.Date.from(java.time.LocalDateTime.now().atZone(java.time.ZoneId.systemDefault()).toInstant()));
        
        // å¦‚æœæœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œè§£æå¹¶è®¾ç½?        if (StringUtils.hasText(userInfo)) {
            try {
                // è§£æJSONæ ¼å¼çš„ç”¨æˆ·ä¿¡æ?                // è¿™é‡Œç®€åŒ–å¤„ç?                user.setNickname("å¾®ä¿¡ç”¨æˆ·_" + System.currentTimeMillis());
            } catch (Exception e) {
                log.warn("è§£æå¾®ä¿¡ç”¨æˆ·ä¿¡æ¯å¤±è´¥", e);
            }
        }
        
        // ä¿å­˜ç”¨æˆ·
        userService.save(user);
        return user;
    }

    private boolean verifySmsCode(String phone, String code) {
        // è¿™é‡Œåº”è¯¥è°ƒç”¨éªŒè¯ç æœåŠ¡éªŒè¯çŸ­ä¿¡éªŒè¯ç 
        // ç®€åŒ–å¤„ç†ï¼Œå‡è®¾éªŒè¯ç æ­£ç¡?        return "123456".equals(code);
    }

    private boolean verifyPassword(String inputPassword, String storedPassword) {
        // è¿™é‡Œåº”è¯¥ä½¿ç”¨BCryptç­‰å·¥å…·éªŒè¯å¯†ç ?        // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ¯”è¾ƒ
        return inputPassword.equals(storedPassword);
    }

    private boolean isUserActive(User user) {
        return user != null && user.getStatus() == 1;
    }
}
package com.heikeji.mall.common.auth;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;

/**
 * JWTè®¤è¯è¿‡æ»¤å™? * éªŒè¯JWT tokenå¹¶è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
 */
@Slf4j
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtils jwtUtils;

    @Autowired
    private AuthenticationService authenticationService;

    /**
     * ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
     */
    private static final List<String> WHITE_LIST = Arrays.asList(
            "/api/v1/auth/login",
            "/api/v1/auth/wechat/login",
            "/api/v1/auth/refresh",
            "/api/v1/auth/register",
            "/api/v1/user/wechat/login",
            "/api/v1/user/wechat/bind-student-no",
            "/api/v1/public/**",
            "/swagger-ui/**",
            "/swagger-resources/**",
            "/v3/api-docs/**",
            "/actuator/health",
            "/error"
    );

    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        
        String requestURI = request.getRequestURI();
        
        // ç™½åå•è·¯å¾„ç›´æ¥æ”¾è¡?        if (isWhiteListed(requestURI)) {
            filterChain.doFilter(request, response);
            return;
        }

        try {
            // ä»è¯·æ±‚å¤´è·å–token
            String token = getTokenFromRequest(request);
            
            if (token != null) {
                // éªŒè¯tokenå¹¶è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
                UserContext userContext = authenticationService.validateTokenAndGetContext(token);
                UserContextHolder.setContext(userContext);
                
                log.debug("JWTè®¤è¯æˆåŠŸ: userId={}, userType={}, path={}", 
                        userContext.getUserId(), userContext.getUserType(), requestURI);
            }
            
            // ç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™?            filterChain.doFilter(request, response);
            
        } catch (Exception e) {
            // è®¤è¯å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ä½†ä¸æ”¾è¡Œç»™ç”¨æˆ·ï¼ˆç”±æ§åˆ¶å™¨å¤„ç†ï¼‰
            log.error("JWTè®¤è¯å¤±è´¥: {}, path={}", e.getMessage(), requestURI);
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ä¸Šä¸‹æ–‡
            UserContextHolder.clearContext();
            
            // ç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨ï¼Œè®©æ§åˆ¶å™¨å±‚å¤„ç†é”™è¯?            filterChain.doFilter(request, response);
            
        } finally {
            // æ¸…ç†ThreadLocalä¸Šä¸‹æ–?            UserContextHolder.clearContext();
        }
    }

    /**
     * æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨ç™½åå•ä¸­
     */
    private boolean isWhiteListed(String uri) {
        return WHITE_LIST.stream().anyMatch(uri::startsWith);
    }

    /**
     * ä»è¯·æ±‚ä¸­æå–token
     */
    private String getTokenFromRequest(HttpServletRequest request) {
        // ä»Authorizationå¤´éƒ¨è·å–
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }

        // ä¹Ÿå¯ä»¥ä»cookieä¸­è·å–ï¼ˆå¦‚æœéœ€è¦ï¼‰
        String tokenFromCookie = request.getHeader("Cookie");
        if (tokenFromCookie != null) {
            // ç®€å•çš„cookieè§£æé€»è¾‘
            String[] cookies = tokenFromCookie.split(";");
            for (String cookie : cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith("token=")) {
                    return cookie.substring(6);
                }
            }
        }

        // ä¹Ÿå¯ä»¥ä»è¯·æ±‚å‚æ•°è·å–ï¼ˆä¸æ¨èï¼Œä»…ç”¨äºç‰¹æ®Šæƒ…å†µï¼?        String tokenFromParam = request.getParameter("token");
        if (tokenFromParam != null) {
            log.warn("é€šè¿‡è¯·æ±‚å‚æ•°è·å–tokenï¼Œè¿™æ˜¯ä¸æ¨èçš„åšæ³?);
            return tokenFromParam;
        }

        return null;
    }
}
package com.heikeji.mall.common.auth;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.HandlerInterceptor;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.PrintWriter;

/**
 * JWTè®¤è¯æ‹¦æˆªå™? */
@Slf4j
@Component
public class JwtAuthenticationInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtUtils jwtUtils;
    
    /**
     * å…è®¸è®¿é—®çš„è·¯å¾„ï¼ˆä¸éœ€è¦è®¤è¯ï¼‰
     */
    private static final String[] ALLOWED_PATHS = {
        "/user/wechat/login",
        "/user/bind-student-no",
        "/user/verify-code",
        "/common/upload",
        "/common/upload-image",
        "/swagger",
        "/v2/api-docs",
        "/swagger-resources",
        "/webjars",
        "/actuator/health",
        "/actuator/info"
    };
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºHandlerMethodç±»å‹
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        // è·å–è¯·æ±‚è·¯å¾„
        String requestPath = request.getRequestURI();
        log.debug("è¯·æ±‚è·¯å¾„: {}", requestPath);
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸è®¿é—®çš„è·¯å¾„åˆ—è¡¨ä¸­
        if (isAllowedPath(requestPath)) {
            log.debug("å…è®¸è®¿é—®çš„è·¯å¾„ï¼Œè·³è¿‡è®¤è¯: {}", requestPath);
            return true;
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯æ³¨è§?        if (isPublicApi(handler)) {
            log.debug("å…¬å…±APIï¼Œè·³è¿‡è®¤è¯? {}", requestPath);
            return true;
        }
        
        // ä»è¯·æ±‚å¤´ä¸­è·å–Token
        String token = extractTokenFromRequest(request);
        if (token == null) {
            log.warn("è¯·æ±‚æœªæºå¸¦Token: {}", requestPath);
            sendUnauthorizedResponse(response, "æœªæä¾›è®¤è¯ä»¤ç‰?);
            return false;
        }
        
        // éªŒè¯Token
        if (!jwtUtils.validateToken(token)) {
            log.warn("Tokenæ— æ•ˆ: {}", requestPath);
            sendUnauthorizedResponse(response, "è®¤è¯ä»¤ç‰Œæ— æ•ˆ");
            return false;
        }
        
        // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
        if (jwtUtils.isTokenExpired(token)) {
            log.warn("Tokenå·²è¿‡æœ? {}", requestPath);
            sendUnauthorizedResponse(response, "è®¤è¯ä»¤ç‰Œå·²è¿‡æœ?);
            return false;
        }
        
        // ä»Tokenä¸­è·å–ç”¨æˆ·ä¿¡æ?        try {
            Long userId = jwtUtils.getUserIdFromToken(token);
            String userType = jwtUtils.getUserTypeFromToken(token);
            
            if (userId == null || userType == null) {
                log.warn("Tokenä¸­ç¼ºå°‘ç”¨æˆ·ä¿¡æ? {}", requestPath);
                sendUnauthorizedResponse(response, "Tokenä¸­ç¼ºå°‘ç”¨æˆ·ä¿¡æ?);
                return false;
            }
            
            // è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–?            UserContext userContext = new UserContext(userId, userType);
            UserContextHolder.setContext(userContext);
            
            log.info("ç”¨æˆ·è®¤è¯æˆåŠŸ: userId={}, userType={}, path={}", userId, userType, requestPath);
            
        } catch (Exception e) {
            log.error("Tokenè§£æå¤±è´¥: {}", e.getMessage(), e);
            sendUnauthorizedResponse(response, "Tokenè§£æå¤±è´¥");
            return false;
        }
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        // è¯·æ±‚å®Œæˆåæ¸…ç†ç”¨æˆ·ä¸Šä¸‹æ–‡
        UserContextHolder.clearContext();
    }
    
    /**
     * ä»è¯·æ±‚ä¸­æå–Token
     */
    private String extractTokenFromRequest(HttpServletRequest request) {
        String authorization = request.getHeader("Authorization");
        return jwtUtils.getTokenFromHeader(authorization);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå…è®¸è®¿é—®çš„è·¯å¾?     */
    private boolean isAllowedPath(String requestPath) {
        for (String allowedPath : ALLOWED_PATHS) {
            if (requestPath.startsWith(allowedPath)) {
                return true;
            }
        }
        return false;
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå…¬å…±APIï¼ˆå¸¦@PublicApiæ³¨è§£ï¼?     */
    private boolean isPublicApi(Object handler) {
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        return handlerMethod.hasMethodAnnotation(PublicApi.class);
    }
    
    /**
     * å‘é€æœªæˆæƒå“åº”
     */
    private void sendUnauthorizedResponse(HttpServletResponse response, String message) throws Exception {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");
        
        String jsonResponse = String.format(
            "{\"code\":401,\"message\":\"%s\",\"data\":null,\"timestamp\":%d}",
            message, System.currentTimeMillis()
        );
        
        try (PrintWriter writer = response.getWriter()) {
            writer.write(jsonResponse);
            writer.flush();
        }
    }
}
package com.heikeji.mall.common.auth;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;

/**
 * JWTå·¥å…·ç±?- ç®€åŒ–ç‰ˆæœ? */
@Slf4j
@Component
public class JwtUtils {
    
    @Value("${jwt.secret:heikeji-mall-secret-key-2024}")
    private String jwtSecret;
    
    @Value("${jwt.expiration:86400000}") // 24å°æ—¶
    private long jwtExpirationInMs;
    
    @Value("${jwt.refresh-expiration:604800000}") // 7å¤?    private long refreshTokenExpirationInMs;
    
    /**
     * ç”ŸæˆJWT Token
     */
    public String generateToken(Long userId, String userType, Map<String, Object> extraClaims) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("userType", userType);
        if (extraClaims != null) {
            claims.putAll(extraClaims);
        }
        
        return generateToken(claims);
    }
    
    /**
     * ç”ŸæˆJWT Tokenï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
     */
    public String generateToken(Long userId, String userType) {
        return generateToken(userId, userType, null);
    }
    
    /**
     * ç”ŸæˆTokenï¼ˆä½¿ç”¨è·è½½ï¼‰
     */
    private String generateToken(Map<String, Object> claims) {
        try {
            Date now = new Date();
            Date expiryDate = new Date(now.getTime() + jwtExpirationInMs);
            
            // ä½¿ç”¨Base64ç¼–ç ç®€åŒ–Tokenç”Ÿæˆï¼Œé¿å…JWTåº“ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢?            StringBuilder tokenBuilder = new StringBuilder();
            tokenBuilder.append("header.").append(System.currentTimeMillis())
                       .append(".").append(jwtSecret)
                       .append(".").append(expiryDate.getTime())
                       .append(".").append(claims.hashCode());
            
            return java.util.Base64.getEncoder().encodeToString(tokenBuilder.toString().getBytes());
        } catch (Exception e) {
            log.error("ç”ŸæˆTokenå¤±è´¥: {}", e.getMessage());
            return null;
        }
    }
    
    /**
     * ç”Ÿæˆåˆ·æ–°Token
     */
    public String generateRefreshToken(Long userId, String userType) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("userType", userType);
        claims.put("type", "refresh");
        
        return generateToken(claims);
    }
    
    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·ID
     */
    public Long getUserIdFromToken(String token) {
        Map<String, Object> claims = getClaimsFromToken(token);
        return claims != null ? (Long) claims.get("userId") : null;
    }
    
    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·ç±»å?     */
    public String getUserTypeFromToken(String token) {
        Map<String, Object> claims = getClaimsFromToken(token);
        return claims != null ? (String) claims.get("userType") : null;
    }
    
    /**
     * ä»Tokenä¸­è·å–è·è½?     */
    public Map<String, Object> getClaimsFromToken(String token) {
        try {
            if (token == null || token.isEmpty()) {
                return null;
            }
            
            // ç®€åŒ–çš„tokenè§£æ
            byte[] decoded = java.util.Base64.getDecoder().decode(token);
            String decodedString = new String(decoded);
            
            Map<String, Object> claims = new HashMap<>();
            claims.put("userId", 1L); // ç®€åŒ–å¤„ç?            claims.put("userType", "USER");
            
            return claims;
        } catch (Exception e) {
            log.warn("Tokenè§£æå¤±è´¥: {}", e.getMessage());
            return null;
        }
    }
    
    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean validateToken(String token) {
        try {
            return getClaimsFromToken(token) != null;
        } catch (Exception e) {
            return false;
        }
    }
    
    /**
     * æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
     */
    public boolean isTokenExpired(String token) {
        try {
            Map<String, Object> claims = getClaimsFromToken(token);
            if (claims == null) {
                return true;
            }
            return false; // ç®€åŒ–å¤„ç†ï¼Œå‡è®¾æœ‰æ•ˆ
        } catch (Exception e) {
            return true;
        }
    }
    
    /**
     * è·å–Tokenå‰©ä½™æœ‰æ•ˆæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    public long getTokenRemainingTime(String token) {
        try {
            Map<String, Object> claims = getClaimsFromToken(token);
            if (claims == null) {
                return 0;
            }
            return jwtExpirationInMs; // è¿”å›é»˜è®¤è¿‡æœŸæ—¶é—´
        } catch (Exception e) {
            return 0;
        }
    }
    
    /**
     * ä»è¯·æ±‚å¤´ä¸­æå–Token
     */
    public String getTokenFromHeader(String authorizationHeader) {
        if (authorizationHeader != null && authorizationHeader.startsWith("Bearer ")) {
            return authorizationHeader.substring(7);
        }
        return null;
    }
}
package com.heikeji.mall.common.auth;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * å…¬å…±APIæ³¨è§£
 * æ ‡è®°ä¸éœ€è¦è®¤è¯çš„æ¥å£
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface PublicApi {
    
    /**
     * æ¥å£æè¿°
     */
    String value() default "";
    
    /**
     * æ˜¯å¦è·³è¿‡è®¤è¯éªŒè¯
     */
    boolean skipAuth() default true;
}
package com.heikeji.mall.common.auth;

import lombok.Data;

/**
 * ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ? */
@Data
public class UserContext {
    
    /**
     * ç”¨æˆ·ID
     */
    private Long userId;
    
    /**
     * ç”¨æˆ·ç±»å‹ï¼šUSER-æ™®é€šç”¨æˆ? ADMIN-ç®¡ç†å‘? MERCHANT-å•†å®¶
     */
    private String userType;
    
    /**
     * ç”¨æˆ·æ‰‹æœºå?     */
    private String phone;
    
    /**
     * ç”¨æˆ·å­¦å·
     */
    private String studentNo;
    
    /**
     * ç”¨æˆ·æ˜µç§°
     */
    private String nickname;
    
    /**
     * å¾®ä¿¡OpenID
     */
    private String openid;
    
    /**
     * ç”¨æˆ·çŠ¶æ€ï¼š0-ç¦ç”¨ï¼?-æ­£å¸¸
     */
    private Byte status;
    
    public UserContext() {}
    
    public UserContext(Long userId, String userType) {
        this.userId = userId;
        this.userType = userType;
    }
    
    public UserContext(Long userId, String userType, String phone, String studentNo, String nickname, String openid, Byte status) {
        this.userId = userId;
        this.userType = userType;
        this.phone = phone;
        this.studentNo = studentNo;
        this.nickname = nickname;
        this.openid = openid;
        this.status = status;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºç®¡ç†å‘˜
     */
    public boolean isAdmin() {
        return "ADMIN".equals(userType);
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæ™®é€šç”¨æˆ?     */
    public boolean isUser() {
        return "USER".equals(userType);
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºå•†å®?     */
    public boolean isMerchant() {
        return "MERCHANT".equals(userType);
    }
    
    /**
     * åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ¿€æ´?     */
    public boolean isActive() {
        return status != null && status == 1;
    }
}
package com.heikeji.mall.common.auth;

import lombok.extern.slf4j.Slf4j;

/**
 * ç”¨æˆ·ä¸Šä¸‹æ–‡æŒæœ‰å™¨
 * ä½¿ç”¨ThreadLocalç¡®ä¿çº¿ç¨‹å®‰å…¨
 */
@Slf4j
public class UserContextHolder {
    
    private static final ThreadLocal<UserContext> CONTEXT = new ThreadLocal<>();
    
    /**
     * è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–?     */
    public static void setContext(UserContext context) {
        CONTEXT.set(context);
        log.debug("è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–? userId={}, userType={}", 
                context != null ? context.getUserId() : null, 
                context != null ? context.getUserType() : null);
    }
    
    /**
     * è·å–ç”¨æˆ·ä¸Šä¸‹æ–?     */
    public static UserContext getContext() {
        UserContext context = CONTEXT.get();
        if (context != null) {
            log.debug("è·å–ç”¨æˆ·ä¸Šä¸‹æ–? userId={}, userType={}", context.getUserId(), context.getUserType());
        }
        return context;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·ID
     */
    public static Long getCurrentUserId() {
        UserContext context = getContext();
        return context != null ? context.getUserId() : null;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·ç±»å‹
     */
    public static String getCurrentUserType() {
        UserContext context = getContext();
        return context != null ? context.getUserType() : null;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·æ‰‹æœºå?     */
    public static String getCurrentUserPhone() {
        UserContext context = getContext();
        return context != null ? context.getPhone() : null;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·å­¦å·
     */
    public static String getCurrentUserStudentNo() {
        UserContext context = getContext();
        return context != null ? context.getStudentNo() : null;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·æ˜µç§°
     */
    public static String getCurrentUserNickname() {
        UserContext context = getContext();
        return context != null ? context.getNickname() : null;
    }
    
    /**
     * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
     */
    public static boolean isCurrentUserAdmin() {
        UserContext context = getContext();
        return context != null && context.isAdmin();
    }
    
    /**
     * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºæ™®é€šç”¨æˆ?     */
    public static boolean isCurrentUser() {
        UserContext context = getContext();
        return context != null && context.isUser();
    }
    
    /**
     * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºå•†å®?     */
    public static boolean isCurrentMerchant() {
        UserContext context = getContext();
        return context != null && context.isMerchant();
    }
    
    /**
     * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ¿€æ´?     */
    public static boolean isCurrentUserActive() {
        UserContext context = getContext();
        return context != null && context.isActive();
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½?     */
    public static boolean isUserLoggedIn() {
        return getCurrentUserId() != null;
    }
    
    /**
     * æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–?     */
    public static void clearContext() {
        CONTEXT.remove();
        log.debug("æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–?);
    }
}
package com.heikeji.mall.common.auth.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * å…¬å¼€æ¥å£æ³¨è§£
 * æ ‡æ³¨è¯¥æ¥å£æ— éœ€è®¤è¯å³å¯è®¿é—®
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface PublicApi {
    
    /**
     * æè¿°ä¿¡æ¯
     */
    String value() default "";
    
    /**
     * æ˜¯å¦è·³è¿‡æƒé™éªŒè¯
     */
    boolean skipAuth() default true;
}
package com.heikeji.mall.common.auth.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * ç®¡ç†å‘˜æƒé™æ³¨è§? * æ ‡æ³¨è¯¥æ¥å£åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresAdmin {
    
    /**
     * æç¤ºä¿¡æ¯
     */
    String message() default "è¯¥æ¥å£ä»…ç®¡ç†å‘˜å¯è®¿é—®";
}
package com.heikeji.mall.common.auth.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * éœ€è¦ç™»å½•æ³¨è§? * æ ‡æ³¨è¯¥æ¥å£éœ€è¦ç”¨æˆ·ç™»å½•åæ‰èƒ½è®¿é—®
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresLogin {
    
    /**
     * æç¤ºä¿¡æ¯
     */
    String message() default "è¯·å…ˆç™»å½•åå†æ“ä½œ";
    
    /**
     * æ˜¯å¦å…è®¸è®°ä½ç™»å½•çŠ¶æ€çš„ç”¨æˆ·è®¿é—®
     */
    boolean allowRememberMe() default true;
}
package com.heikeji.mall.common.auth.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * å•†æˆ·æƒé™æ³¨è§£
 * æ ‡æ³¨è¯¥æ¥å£åªæœ‰å•†æˆ·æˆ–ç®¡ç†å‘˜æ‰èƒ½è®¿é—? */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresMerchant {
    
    /**
     * æç¤ºä¿¡æ¯
     */
    String message() default "è¯¥æ¥å£ä»…å•†æˆ·æˆ–ç®¡ç†å‘˜å¯è®¿é—?;
    
    /**
     * æ˜¯å¦å…è®¸ç®¡ç†å‘˜è®¿é—?     */
    boolean allowAdmin() default true;
}
package com.heikeji.mall.common.auth.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * æƒé™æ³¨è§£
 * ç”¨äºæ ‡æ³¨éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®çš„æ¥å£
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermission {
    
    /**
     * æƒé™ä»£ç 
     */
    String[] value();
    
    /**
     * æƒé™æè¿°
     */
    String desc() default "";
    
    /**
     * æ˜¯å¦éœ€è¦æ‰€æœ‰æƒé™ï¼ˆANDï¼‰ï¼Œé»˜è®¤ä¸ºfalseï¼ˆORï¼?     */
    boolean requireAll() default false;
}
package com.heikeji.mall.common.auth.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * è§’è‰²æ³¨è§£
 * ç”¨äºæ ‡æ³¨éœ€è¦ç‰¹å®šè§’è‰²æ‰èƒ½è®¿é—®çš„æ¥å£
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresRole {
    
    /**
     * è§’è‰²ä»£ç 
     */
    String[] value();
    
    /**
     * è§’è‰²æè¿°
     */
    String desc() default "";
    
    /**
     * æ˜¯å¦éœ€è¦æ‰€æœ‰è§’è‰²ï¼ˆANDï¼‰ï¼Œé»˜è®¤ä¸ºfalseï¼ˆORï¼?     */
    boolean requireAll() default false;
}
package com.heikeji.mall.common.auth.interceptor;

import com.heikeji.mall.common.auth.UserContext;
import com.heikeji.mall.common.auth.UserContextHolder;
import com.heikeji.mall.common.auth.annotation.*;
import com.heikeji.mall.common.auth.AuthenticationService;
import com.heikeji.mall.common.exception.AuthenticationException;
import com.heikeji.mall.common.exception.AuthorizationException;
import com.heikeji.mall.common.response.R;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.method.HandlerMethod;
import org.springframework.web.servlet.HandlerInterceptor;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.Method;
import java.util.Arrays;
import java.util.List;

/**
 * æƒé™éªŒè¯æ‹¦æˆªå™? * éªŒè¯ç”¨æˆ·æƒé™æ³¨è§£å¹¶è¿›è¡Œç›¸åº”æ§åˆ? */
@Slf4j
@Component
public class AuthorizationInterceptor implements HandlerInterceptor {

    @Autowired
    private AuthenticationService authenticationService;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }

        HandlerMethod handlerMethod = (HandlerMethod) handler;
        Method method = handlerMethod.getMethod();
        Class<?> clazz = handlerMethod.getBeanType();

        try {
            // éªŒè¯æ–¹æ³•çº§æƒé™æ³¨è§?            checkMethodPermissions(method);
            
            // éªŒè¯ç±»çº§æƒé™æ³¨è§£
            checkClassPermissions(clazz);
            
            return true;
        } catch (AuthenticationException e) {
            handleAuthenticationException(response, e);
            return false;
        } catch (AuthorizationException e) {
            handleAuthorizationException(response, e);
            return false;
        } catch (Exception e) {
            log.error("æƒé™éªŒè¯å¤±è´¥: {}", e.getMessage(), e);
            handleAuthorizationException(response, new AuthorizationException("æƒé™éªŒè¯å¼‚å¸¸"));
            return false;
        }
    }

    /**
     * æ£€æŸ¥æ–¹æ³•çº§æƒé™æ³¨è§£
     */
    private void checkMethodPermissions(Method method) {
        // æ£€æŸ¥@RequiresLoginæ³¨è§£
        RequiresLogin requiresLogin = method.getAnnotation(RequiresLogin.class);
        if (requiresLogin == null) {
            requiresLogin = method.getDeclaringClass().getAnnotation(RequiresLogin.class);
        }
        if (requiresLogin != null) {
            checkLoginRequirement(requiresLogin);
        }

        // æ£€æŸ¥@RequiresAdminæ³¨è§£
        RequiresAdmin requiresAdmin = method.getAnnotation(RequiresAdmin.class);
        if (requiresAdmin == null) {
            requiresAdmin = method.getDeclaringClass().getAnnotation(RequiresAdmin.class);
        }
        if (requiresAdmin != null) {
            checkAdminRequirement(requiresAdmin);
        }

        // æ£€æŸ¥@RequiresMerchantæ³¨è§£
        RequiresMerchant requiresMerchant = method.getAnnotation(RequiresMerchant.class);
        if (requiresMerchant == null) {
            requiresMerchant = method.getDeclaringClass().getAnnotation(RequiresMerchant.class);
        }
        if (requiresMerchant != null) {
            checkMerchantRequirement(requiresMerchant);
        }

        // æ£€æŸ¥@RequiresRoleæ³¨è§£
        RequiresRole requiresRole = method.getAnnotation(RequiresRole.class);
        if (requiresRole == null) {
            requiresRole = method.getDeclaringClass().getAnnotation(RequiresRole.class);
        }
        if (requiresRole != null) {
            checkRoleRequirement(requiresRole);
        }

        // æ£€æŸ¥@RequiresPermissionæ³¨è§£
        RequiresPermission requiresPermission = method.getAnnotation(RequiresPermission.class);
        if (requiresPermission == null) {
            requiresPermission = method.getDeclaringClass().getAnnotation(RequiresPermission.class);
        }
        if (requiresPermission != null) {
            checkPermissionRequirement(requiresPermission);
        }
    }

    /**
     * æ£€æŸ¥ç±»çº§æƒé™æ³¨è§?     */
    private void checkClassPermissions(Class<?> clazz) {
        // ç±»çº§åˆ«çš„æ³¨è§£å¤„ç†å·²åœ¨æ–¹æ³•æ£€æŸ¥ä¸­å®Œæˆ
        // è¿™é‡Œå¯ä»¥æ·»åŠ ç±»çº§åˆ«çš„ç‰¹æ®Šå¤„ç†é€»è¾‘
    }

    /**
     * æ£€æŸ¥ç™»å½•è¦æ±?     */
    private void checkLoginRequirement(RequiresLogin annotation) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException(annotation.message());
        }

        if (!userContext.isActive()) {
            throw new AuthenticationException("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨");
        }

        log.debug("ç™»å½•éªŒè¯é€šè¿‡: userId={}", userContext.getUserId());
    }

    /**
     * æ£€æŸ¥ç®¡ç†å‘˜è¦æ±‚
     */
    private void checkAdminRequirement(RequiresAdmin annotation) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException("è¯·å…ˆç™»å½•");
        }

        if (!userContext.isActive()) {
            throw new AuthenticationException("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨");
        }

        if (!userContext.isAdmin()) {
            throw new AuthorizationException(annotation.message());
        }

        log.debug("ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡: userId={}", userContext.getUserId());
    }

    /**
     * æ£€æŸ¥å•†æˆ·è¦æ±?     */
    private void checkMerchantRequirement(RequiresMerchant annotation) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException("è¯·å…ˆç™»å½•");
        }

        if (!userContext.isActive()) {
            throw new AuthenticationException("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨");
        }

        boolean hasPermission = userContext.isMerchant() || 
                               (annotation.allowAdmin() && userContext.isAdmin());

        if (!hasPermission) {
            throw new AuthorizationException(annotation.message());
        }

        log.debug("å•†æˆ·æƒé™éªŒè¯é€šè¿‡: userId={}, userType={}", userContext.getUserId(), userContext.getUserType());
    }

    /**
     * æ£€æŸ¥è§’è‰²è¦æ±?     */
    private void checkRoleRequirement(RequiresRole annotation) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException("è¯·å…ˆç™»å½•");
        }

        if (!userContext.isActive()) {
            throw new AuthenticationException("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨");
        }

        List<String> requiredRoles = Arrays.asList(annotation.value());
        List<String> userRoles = Arrays.asList(userContext.getUserType());

        boolean hasPermission;
        if (annotation.requireAll()) {
            // éœ€è¦æ‰€æœ‰è§’è‰?            hasPermission = requiredRoles.stream().allMatch(userRoles::contains);
        } else {
            // éœ€è¦ä»»ä¸€è§’è‰²
            hasPermission = requiredRoles.stream().anyMatch(userRoles::contains);
        }

        if (!hasPermission) {
            throw new AuthorizationException("è§’è‰²æƒé™ä¸è¶³: " + annotation.desc());
        }

        log.debug("è§’è‰²æƒé™éªŒè¯é€šè¿‡: userId={}, roles={}", userContext.getUserId(), userRoles);
    }

    /**
     * æ£€æŸ¥æƒé™è¦æ±?     */
    private void checkPermissionRequirement(RequiresPermission annotation) {
        UserContext userContext = UserContextHolder.getContext();
        if (userContext == null) {
            throw new AuthenticationException("è¯·å…ˆç™»å½•");
        }

        if (!userContext.isActive()) {
            throw new AuthenticationException("ç”¨æˆ·è´¦æˆ·å·²è¢«ç¦ç”¨");
        }

        List<String> requiredPermissions = Arrays.asList(annotation.value());
        boolean hasPermission;

        if (annotation.requireAll()) {
            // éœ€è¦æ‰€æœ‰æƒé™?            hasPermission = requiredPermissions.stream()
                    .allMatch(permission -> authenticationService.checkPermission(permission, userContext));
        } else {
            // éœ€è¦ä»»ä¸€æƒé™
            hasPermission = requiredPermissions.stream()
                    .anyMatch(permission -> authenticationService.checkPermission(permission, userContext));
        }

        if (!hasPermission) {
            throw new AuthorizationException("æƒé™ä¸è¶³: " + annotation.desc());
        }

        log.debug("æƒé™éªŒè¯é€šè¿‡: userId={}, permissions={}", userContext.getUserId(), requiredPermissions);
    }

    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸
     */
    private void handleAuthenticationException(HttpServletResponse response, AuthenticationException e) throws IOException {
        log.warn("è®¤è¯å¤±è´¥: {}", e.getMessage());
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write("{\"code\":401,\"message\":\"" + e.getMessage() + "\",\"success\":false,\"timestamp\":" + System.currentTimeMillis() + "}");
    }

    /**
     * å¤„ç†æˆæƒå¼‚å¸¸
     */
    private void handleAuthorizationException(HttpServletResponse response, AuthorizationException e) throws IOException {
        log.warn("æˆæƒå¤±è´¥: {}", e.getMessage());
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write("{\"code\":403,\"message\":\"" + e.getMessage() + "\",\"success\":false,\"timestamp\":" + System.currentTimeMillis() + "}");
    }
}
package com.heikeji.mall.common.config;

import com.heikeji.mall.common.auth.interceptor.AuthorizationInterceptor;
import com.heikeji.mall.common.auth.JwtAuthenticationFilter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.web.servlet.FilterRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * Webè®¤è¯é…ç½®
 * é…ç½®JWTè®¤è¯è¿‡æ»¤å™¨å’Œæƒé™éªŒè¯æ‹¦æˆªå™? */
@Configuration
public class WebAuthConfig implements WebMvcConfigurer {

    @Autowired
    private AuthorizationInterceptor authorizationInterceptor;

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    /**
     * æ³¨å†Œæƒé™éªŒè¯æ‹¦æˆªå™?     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(authorizationInterceptor)
                .addPathPatterns("/api/**")
                .excludePathPatterns(
                        "/api/v1/auth/**",
                        "/api/v1/user/wechat/login",
                        "/api/v1/user/wechat/bind-student-no",
                        "/api/v1/public/**",
                        "/swagger-ui/**",
                        "/swagger-resources/**",
                        "/v3/api-docs/**",
                        "/actuator/**",
                        "/error"
                );
    }

    /**
     * æ³¨å†ŒJWTè®¤è¯è¿‡æ»¤å™?     */
    @Bean
    public FilterRegistrationBean<JwtAuthenticationFilter> jwtFilterRegistration() {
        FilterRegistrationBean<JwtAuthenticationFilter> registration = new FilterRegistrationBean<>(jwtAuthenticationFilter);
        registration.setEnabled(false); // ä¸é€šè¿‡FilterRegistrationBeanå¯ç”¨ï¼Œä½¿ç”¨@Beanæ–¹å¼
        return registration;
    }
}
package com.heikeji.mall.common.exception;

/**
 * è®¤è¯å¼‚å¸¸
 * ç”¨äºå¤„ç†ç”¨æˆ·èº«ä»½è®¤è¯ç›¸å…³çš„å¼‚å¸? */
public class AuthenticationException extends RuntimeException {
    
    private int code;
    private String message;
    
    public AuthenticationException() {
        super();
    }
    
    public AuthenticationException(String message) {
        super(message);
        this.message = message;
        this.code = 401;
    }
    
    public AuthenticationException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public AuthenticationException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 401;
    }
    
    public AuthenticationException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * æˆæƒå¼‚å¸¸
 * ç”¨äºå¤„ç†ç”¨æˆ·æƒé™ç›¸å…³çš„å¼‚å¸? */
public class AuthorizationException extends RuntimeException {
    
    private int code;
    private String message;
    
    public AuthorizationException() {
        super();
    }
    
    public AuthorizationException(String message) {
        super(message);
        this.message = message;
        this.code = 403;
    }
    
    public AuthorizationException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public AuthorizationException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 403;
    }
    
    public AuthorizationException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * ä¸šåŠ¡å¼‚å¸¸
 * ç”¨äºå¤„ç†ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„å¼‚å¸? */
public class BusinessException extends RuntimeException {
    
    private int code;
    private String message;
    
    public BusinessException() {
        super();
    }
    
    public BusinessException(String message) {
        super(message);
        this.message = message;
        this.code = 500;
    }
    
    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public BusinessException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 500;
    }
    
    public BusinessException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * ç¼“å­˜å¼‚å¸¸
 * ç”¨äºå¤„ç†ç¼“å­˜æ“ä½œç›¸å…³çš„å¼‚å¸? */
public class CacheException extends RuntimeException {
    
    private int code;
    private String message;
    
    public CacheException() {
        super();
    }
    
    public CacheException(String message) {
        super(message);
        this.message = message;
        this.code = 500;
    }
    
    public CacheException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public CacheException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 500;
    }
    
    public CacheException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * æ•°æ®åº“å¼‚å¸? * ç”¨äºå¤„ç†æ•°æ®åº“æ“ä½œç›¸å…³çš„å¼‚å¸¸
 */
public class DatabaseException extends RuntimeException {
    
    private int code;
    private String message;
    
    public DatabaseException() {
        super();
    }
    
    public DatabaseException(String message) {
        super(message);
        this.message = message;
        this.code = 500;
    }
    
    public DatabaseException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public DatabaseException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 500;
    }
    
    public DatabaseException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * æ•°æ®å®Œæ•´æ€§å¼‚å¸? * ç”¨äºå¤„ç†æ•°æ®é‡å¤ã€å†²çªç­‰å®Œæ•´æ€§ç›¸å…³çš„å¼‚å¸¸
 */
public class DataIntegrityViolationException extends RuntimeException {
    
    private int code;
    private String message;
    
    public DataIntegrityViolationException() {
        super();
    }
    
    public DataIntegrityViolationException(String message) {
        super(message);
        this.message = message;
        this.code = 409; // å†²çª
    }
    
    public DataIntegrityViolationException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public DataIntegrityViolationException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 409;
    }
    
    public DataIntegrityViolationException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * å¤–éƒ¨æœåŠ¡å¼‚å¸¸
 * ç”¨äºå¤„ç†è°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼ˆå¦‚ç¬¬ä¸‰æ–¹APIã€å¾®æœåŠ¡ç­‰ï¼‰å¤±è´¥çš„å¼‚å¸? */
public class ExternalServiceException extends RuntimeException {
    
    private int code;
    private String message;
    
    public ExternalServiceException() {
        super();
    }
    
    public ExternalServiceException(String message) {
        super(message);
        this.message = message;
        this.code = 500;
    }
    
    public ExternalServiceException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public ExternalServiceException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 500;
    }
    
    public ExternalServiceException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

/**
 * æ–‡ä»¶å¤„ç†å¼‚å¸¸
 * ç”¨äºå¤„ç†æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€å¤„ç†ç›¸å…³çš„å¼‚å¸¸
 */
public class FileProcessingException extends RuntimeException {
    
    private int code;
    private String message;
    
    public FileProcessingException() {
        super();
    }
    
    public FileProcessingException(String message) {
        super(message);
        this.message = message;
        this.code = 6001;
    }
    
    public FileProcessingException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public FileProcessingException(String message, Throwable cause) {
        super(message, cause);
        this.message = message;
        this.code = 6001;
    }
    
    public FileProcessingException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.exception;

import com.heikeji.mall.common.response.R;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.BindException;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
// Spring Webç±»å‹è½¬æ¢å¼‚å¸¸
// import org.springframework.web.bind.MethodArgumentTypeMismatchException;

import jakarta.servlet.http.HttpServletRequest;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletionException;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™? * ç»Ÿä¸€å¤„ç†ç³»ç»Ÿä¸­çš„å„ç§å¼‚å¸¸ï¼Œè¿”å›æ ‡å‡†åŒ–çš„é”™è¯¯å“åº? */
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    /**
     * å¤„ç†å‚æ•°æ ¡éªŒå¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public R<Void> handleValidationException(MethodArgumentNotValidException e, HttpServletRequest request) {
        log.warn("å‚æ•°æ ¡éªŒå¤±è´¥: {} {}", request.getMethod(), request.getRequestURI(), e);
        
        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = error instanceof FieldError 
                    ? ((FieldError) error).getField() 
                    : error.getObjectName();
            errors.put(fieldName, error.getDefaultMessage());
        });
        
        String errorMessage = errors.isEmpty() ? "å‚æ•°æ ¡éªŒå¤±è´¥" : "å‚æ•°æ ¡éªŒå¤±è´¥: " + errors.toString();
        return R.validationFailed(errorMessage);
    }

    /**
     * å¤„ç†æ•°æ®ç»‘å®šå¼‚å¸¸
     */
    @ExceptionHandler(BindException.class)
    public R<Void> handleBindException(BindException e, HttpServletRequest request) {
        log.warn("æ•°æ®ç»‘å®šå¤±è´¥: {} {}", request.getMethod(), request.getRequestURI(), e);
        
        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = error instanceof FieldError 
                    ? ((FieldError) error).getField() 
                    : error.getObjectName();
            errors.put(fieldName, error.getDefaultMessage());
        });
        
        String errorMessage = errors.isEmpty() ? "æ•°æ®ç»‘å®šå¤±è´¥" : "æ•°æ®ç»‘å®šå¤±è´¥: " + errors.toString();
        return R.validationFailed(errorMessage);
    }

    /**
     * å¤„ç†å‚æ•°ç±»å‹ä¸åŒ¹é…å¼‚å¸?     * æš‚æ—¶æ³¨é‡Šæ‰æ­¤æ–¹æ³•ï¼Œç­‰å¾…ä¿®å¤å¯¼å…¥é—®é¢?     */
    /*
    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public R<Void> handleMethodArgumentTypeMismatchException(MethodArgumentTypeMismatchException e, HttpServletRequest request) {
        log.warn("å‚æ•°ç±»å‹ä¸åŒ¹é…? {} {} å‚æ•°: {} å€? {}", 
                request.getMethod(), request.getRequestURI(), 
                e.getName(), e.getValue(), e);
        
        return R.badRequest("å‚æ•°ç±»å‹é”™è¯¯: " + e.getName() + " åº”ä¸º " + e.getRequiredType().getSimpleName());
    }
    */

    /**
     * å¤„ç†ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public R<Void> handleBusinessException(BusinessException e, HttpServletRequest request) {
        log.warn("ä¸šåŠ¡å¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.error(e.getCode(), e.getMessage());
    }

    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸
     */
    @ExceptionHandler(AuthenticationException.class)
    public R<Void> handleAuthenticationException(AuthenticationException e, HttpServletRequest request) {
        log.warn("è®¤è¯å¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.unauthorized(e.getMessage());
    }

    /**
     * å¤„ç†æˆæƒå¼‚å¸¸
     */
    @ExceptionHandler(AuthorizationException.class)
    public R<Void> handleAuthorizationException(AuthorizationException e, HttpServletRequest request) {
        log.warn("æˆæƒå¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.forbidden(e.getMessage());
    }

    /**
     * å¤„ç†å¹¶å‘æ‰§è¡Œå¼‚å¸¸
     */
    @ExceptionHandler(CompletionException.class)
    public R<Void> handleCompletionException(CompletionException e, HttpServletRequest request) {
        log.error("å¹¶å‘æ‰§è¡Œå¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        
        // å¦‚æœæ˜¯ä¸šåŠ¡ç›¸å…³çš„å¼‚å¸¸ï¼Œç›´æ¥å¤„ç?        if (e.getCause() instanceof BusinessException) {
            return handleBusinessException((BusinessException) e.getCause(), request);
        }
        
        // å¦‚æœæ˜¯è®¤è¯ç›¸å…³çš„å¼‚å¸¸ï¼Œç›´æ¥å¤„ç?        if (e.getCause() instanceof AuthenticationException) {
            return handleAuthenticationException((AuthenticationException) e.getCause(), request);
        }
        
        // å¦‚æœæ˜¯æˆæƒç›¸å…³çš„å¼‚å¸¸ï¼Œç›´æ¥å¤„ç?        if (e.getCause() instanceof AuthorizationException) {
            return handleAuthorizationException((AuthorizationException) e.getCause(), request);
        }
        
        return R.internalServerError("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }

    /**
     * å¤„ç†å¹¶å‘é”å¼‚å¸?     */
    @ExceptionHandler(LockException.class)
    public R<Void> handleLockException(LockException e, HttpServletRequest request) {
        log.warn("å¹¶å‘é”å¼‚å¸? {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.conflict(e.getMessage());
    }

    /**
     * å¤„ç†æ•°æ®é‡å¤å¼‚å¸¸
     */
    @ExceptionHandler(DataIntegrityViolationException.class)
    public R<Void> handleDataIntegrityViolationException(DataIntegrityViolationException e, HttpServletRequest request) {
        log.warn("æ•°æ®å®Œæ•´æ€§å¼‚å¸? {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.conflict("æ•°æ®é‡å¤æˆ–å†²çª?);
    }

    /**
     * å¤„ç†æ•°æ®åº“å¼‚å¸?     */
    @ExceptionHandler(DatabaseException.class)
    public R<Void> handleDatabaseException(DatabaseException e, HttpServletRequest request) {
        log.error("æ•°æ®åº“å¼‚å¸? {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.internalServerError("æ•°æ®åº“æ“ä½œå¤±è´?);
    }

    /**
     * å¤„ç†å¤–éƒ¨æœåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(ExternalServiceException.class)
    public R<Void> handleExternalServiceException(ExternalServiceException e, HttpServletRequest request) {
        log.error("å¤–éƒ¨æœåŠ¡å¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.error(e.getCode(), e.getMessage() != null ? e.getMessage() : "å¤–éƒ¨æœåŠ¡è°ƒç”¨å¤±è´¥");
    }

    /**
     * å¤„ç†æ–‡ä»¶å¤„ç†å¼‚å¸¸
     */
    @ExceptionHandler(FileProcessingException.class)
    public R<Void> handleFileProcessingException(FileProcessingException e, HttpServletRequest request) {
        log.warn("æ–‡ä»¶å¤„ç†å¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.fileUploadFailed();
    }

    /**
     * å¤„ç†ç¼“å­˜å¼‚å¸¸
     */
    @ExceptionHandler(CacheException.class)
    public R<Void> handleCacheException(CacheException e, HttpServletRequest request) {
        log.error("ç¼“å­˜å¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.internalServerError("ç¼“å­˜æ“ä½œå¤±è´¥");
    }

    /**
     * å¤„ç†å…¶ä»–æ‰€æœ‰å¼‚å¸?     */
    @ExceptionHandler(Exception.class)
    public R<Void> handleGenericException(Exception e, HttpServletRequest request) {
        log.error("ç³»ç»Ÿå¼‚å¸¸: {} {}", request.getMethod(), request.getRequestURI(), e);
        return R.internalServerError("ç³»ç»Ÿå†…éƒ¨é”™è¯¯");
    }
}
package com.heikeji.mall.common.exception;

/**
 * å¹¶å‘é”å¼‚å¸? * ç”¨äºå¤„ç†åˆ†å¸ƒå¼é”ç›¸å…³çš„å¼‚å¸? */
public class LockException extends RuntimeException {
    
    private int code;
    private String message;
    
    public LockException() {
        super();
    }
    
    public LockException(String message) {
        super(message);
        this.message = message;
        this.code = 409; // å†²çª
    }
    
    public LockException(int code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public void setCode(int code) {
        this.code = code;
    }
    
    @Override
    public String getMessage() {
        return message;
    }
    
    public void setMessage(String message) {
        this.message = message;
    }
}
package com.heikeji.mall.common.response;

import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * åˆ†é¡µæ•°æ®å“åº”æ ¼å¼
 * 
 * @param <T> æ•°æ®ç±»å‹
 */
@Data
public class PageData<T> implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * å½“å‰é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
     */
    private long current;
    
    /**
     * æ¯é¡µæ˜¾ç¤ºæ•°é‡
     */
    private long size;
    
    /**
     * æ€»è®°å½•æ•°
     */
    private long total;
    
    /**
     * æ€»é¡µæ•?     */
    private long pages;
    
    /**
     * å½“å‰é¡µæ•°æ®åˆ—è¡?     */
    private List<T> records;
    
    public PageData() {}
    
    public PageData(long current, long size, long total, List<T> records) {
        this.current = current;
        this.size = size;
        this.total = total;
        this.records = records;
        this.pages = (total + size - 1) / size; // å‘ä¸Šå–æ•´è®¡ç®—æ€»é¡µæ•?    }
    
    /**
     * åˆ›å»ºåˆ†é¡µæ•°æ®
     */
    public static <T> PageData<T> of(long current, long size, long total, List<T> records) {
        return new PageData<>(current, size, total, records);
    }
    
    /**
     * åˆ›å»ºç©ºåˆ†é¡µæ•°æ?     */
    public static <T> PageData<T> empty() {
        return new PageData<>(1, 0, 0, null);
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€é¡?     */
    public boolean hasNext() {
        return current < pages;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ä¸Šä¸€é¡?     */
    public boolean hasPrevious() {
        return current > 1;
    }
    
    /**
     * è·å–å½“å‰é¡µèµ·å§‹ä½ç½®ï¼ˆä»?å¼€å§‹ï¼‰
     */
    public long getOffset() {
        return (current - 1) * size;
    }
    
    /**
     * è·å–å½“å‰é¡µç»“æŸä½ç½®ï¼ˆä»?å¼€å§‹ï¼‰
     */
    public long getEndOffset() {
        return Math.min(getOffset() + size, total);
    }
    
    /**
     * è·å–å½“å‰é¡µå®é™…è®°å½•æ•°
     */
    public long getCurrentSize() {
        if (records == null) {
            return 0;
        }
        return records.size();
    }
    
    /**
     * è®¡ç®—é¡µç èŒƒå›´ï¼ˆç”¨äºåˆ†é¡µå¯¼èˆªï¼‰
     */
    public PageRange getPageRange(int showPages) {
        long start = Math.max(1, current - showPages / 2);
        long end = Math.min(pages, start + showPages - 1);
        
        // è°ƒæ•´èµ·å§‹é¡µç ï¼Œç¡®ä¿æ˜¾ç¤ºé¡µæ•°è¶³å¤?        if (end - start + 1 < showPages) {
            start = Math.max(1, end - showPages + 1);
        }
        
        return new PageRange(start, end, hasPrevious(), hasNext());
    }
    
    /**
     * é¡µç èŒƒå›´ç±?     */
    public static class PageRange {
        private final long start;
        private final long end;
        private final boolean hasPrevious;
        private final boolean hasNext;
        
        public PageRange(long start, long end, boolean hasPrevious, boolean hasNext) {
            this.start = start;
            this.end = end;
            this.hasPrevious = hasPrevious;
            this.hasNext = hasNext;
        }
        
        public long getStart() {
            return start;
        }
        
        public long getEnd() {
            return end;
        }
        
        public boolean hasPrevious() {
            return hasPrevious;
        }
        
        public boolean hasNext() {
            return hasNext;
        }
        
        /**
         * è·å–é¡µç åˆ—è¡¨
         */
        public List<Long> getPageNumbers() {
            java.util.ArrayList<Long> pages = new java.util.ArrayList<>();
            for (long i = start; i <= end; i++) {
                pages.add(i);
            }
            return pages;
        }
    }
}
package com.heikeji.mall.common.response;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.io.Serializable;
import java.util.List;

/**
 * ç»Ÿä¸€APIå“åº”æ ¼å¼
 * 
 * @param <T> æ•°æ®ç±»å‹
 */
@Data
@JsonInclude(JsonInclude.Include.NON_NULL)
public class R<T> implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    // ==================== çŠ¶æ€ç å¸¸é‡ ====================
    
    /**
     * æˆåŠŸ
     */
    public static final int SUCCESS = 200;
    
    /**
     * åˆ›å»ºæˆåŠŸ
     */
    public static final int CREATED = 201;
    
    /**
     * æ— å†…å®?     */
    public static final int NO_CONTENT = 204;
    
    /**
     * è¯·æ±‚å‚æ•°é”™è¯¯
     */
    public static final int BAD_REQUEST = 400;
    
    /**
     * æœªæˆæ?     */
    public static final int UNAUTHORIZED = 401;
    
    /**
     * ç¦æ­¢è®¿é—®
     */
    public static final int FORBIDDEN = 403;
    
    /**
     * èµ„æºæœªæ‰¾åˆ?     */
    public static final int NOT_FOUND = 404;
    
    /**
     * è¯·æ±‚æ–¹æ³•ä¸å…è®?     */
    public static final int METHOD_NOT_ALLOWED = 405;
    
    /**
     * å†²çª
     */
    public static final int CONFLICT = 409;
    
    /**
     * è¯·æ±‚å®ä½“è¿‡å¤§
     */
    public static final int PAYLOAD_TOO_LARGE = 413;
    
    /**
     * åª’ä½“ç±»å‹ä¸æ”¯æŒ?     */
    public static final int UNSUPPORTED_MEDIA_TYPE = 415;
    
    /**
     * ä¸šåŠ¡å¤„ç†å¤±è´¥
     */
    public static final int UNPROCESSABLE_ENTITY = 422;
    
    /**
     * è¯·æ±‚è¿‡äºé¢‘ç¹
     */
    public static final int TOO_MANY_REQUESTS = 429;
    
    /**
     * æœåŠ¡å™¨å†…éƒ¨é”™è¯?     */
    public static final int INTERNAL_SERVER_ERROR = 500;
    
    /**
     * ç½‘å…³é”™è¯¯
     */
    public static final int BAD_GATEWAY = 502;
    
    /**
     * æœåŠ¡ä¸å¯ç”?     */
    public static final int SERVICE_UNAVAILABLE = 503;
    
    /**
     * ç½‘å…³è¶…æ—¶
     */
    public static final int GATEWAY_TIMEOUT = 504;
    
    // ==================== ä¸šåŠ¡é”™è¯¯ç å¸¸é‡?====================
    
    /**
     * ç”¨æˆ·ä¸å­˜åœ?     */
    public static final int USER_NOT_FOUND = 1001;
    
    /**
     * ç”¨æˆ·å·²å­˜åœ?     */
    public static final int USER_EXISTS = 1002;
    
    /**
     * ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
     */
    public static final int INVALID_CREDENTIALS = 1003;
    
    /**
     * ç”¨æˆ·å·²è¢«ç¦ç”¨
     */
    public static final int USER_DISABLED = 1004;
    
    /**
     * å•†å“ä¸å­˜åœ?     */
    public static final int PRODUCT_NOT_FOUND = 2001;
    
    /**
     * åº“å­˜ä¸è¶³
     */
    public static final int INSUFFICIENT_STOCK = 2002;
    
    /**
     * è®¢å•ä¸å­˜åœ?     */
    public static final int ORDER_NOT_FOUND = 3001;
    
    /**
     * è®¢å•çŠ¶æ€ä¸å…è®¸æ“ä½œ
     */
    public static final int ORDER_STATUS_INVALID = 3002;
    
    /**
     * ä½™é¢ä¸è¶³
     */
    public static final int INSUFFICIENT_BALANCE = 4001;
    
    /**
     * æ”¯ä»˜å¤±è´¥
     */
    public static final int PAYMENT_FAILED = 4002;
    
    /**
     * éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœ?     */
    public static final int VERIFICATION_CODE_INVALID = 5001;
    
    /**
     * æ–‡ä»¶ä¸Šä¼ å¤±è´¥
     */
    public static final int FILE_UPLOAD_FAILED = 6001;
    
    /**
     * æ•°æ®éªŒè¯å¤±è´¥
     */
    public static final int VALIDATION_FAILED = 7001;
    
    // ==================== å“åº”å­—æ®µ ====================
    
    /**
     * å“åº”çŠ¶æ€ç 
     */
    private int code;
    
    /**
     * å“åº”æ¶ˆæ¯
     */
    @JsonProperty("msg")
    private String message;
    
    /**
     * å“åº”æ•°æ®
     */
    private T data;
    
    /**
     * åˆ†é¡µæ•°æ®ï¼ˆå¦‚æœé€‚ç”¨ï¼?     */
    private PageData page;
    
    /**
     * æ—¶é—´æˆ?     */
    private long timestamp;
    
    /**
     * è¯·æ±‚IDï¼ˆç”¨äºé“¾è·¯è¿½è¸ªï¼‰
     */
    private String requestId;
    
    // ==================== æ„é€ å‡½æ•?====================
    
    public R() {
        this.timestamp = System.currentTimeMillis();
    }
    
    public R(int code, String message, T data, PageData page, String requestId) {
        this.code = code;
        this.message = message;
        this.data = data;
        this.page = page;
        this.requestId = requestId;
        this.timestamp = System.currentTimeMillis();
    }
    
    // ==================== æˆåŠŸå“åº”æ–¹æ³• ====================
    
    /**
     * æˆåŠŸå“åº”ï¼Œæ— æ•°æ®
     */
    public static <T> R<T> success() {
        return new R<>(SUCCESS, "æ“ä½œæˆåŠŸ", null, null, null);
    }
    
    /**
     * æˆåŠŸå“åº”ï¼Œå¸¦æ•°æ®
     */
    public static <T> R<T> success(T data) {
        return new R<>(SUCCESS, "æ“ä½œæˆåŠŸ", data, null, null);
    }
    
    /**
     * æˆåŠŸå“åº”ï¼Œå¸¦è‡ªå®šä¹‰æ¶ˆæ¯å’Œæ•°æ®
     */
    public static <T> R<T> success(String message, T data) {
        return new R<>(SUCCESS, message, data, null, null);
    }
    
    /**
     * æˆåŠŸå“åº”ï¼Œå¸¦åˆ†é¡µæ•°æ®
     */
    public static <T> R<T> success(T data, PageData page) {
        return new R<>(SUCCESS, "æŸ¥è¯¢æˆåŠŸ", data, page, null);
    }
    
    /**
     * æˆåŠŸå“åº”ï¼Œå¸¦è‡ªå®šä¹‰æ¶ˆæ¯ã€åˆ†é¡µæ•°æ®å’Œè¯·æ±‚ID
     */
    public static <T> R<T> success(String message, T data, PageData page, String requestId) {
        return new R<>(SUCCESS, message, data, page, requestId);
    }
    
    // ==================== é”™è¯¯å“åº”æ–¹æ³• ====================
    
    /**
     * é€šç”¨é”™è¯¯å“åº”
     */
    public static <T> R<T> error() {
        return new R<>(INTERNAL_SERVER_ERROR, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯", null, null, null);
    }
    
    /**
     * é€šç”¨é”™è¯¯å“åº”ï¼Œå¸¦æ¶ˆæ¯
     */
    public static <T> R<T> error(String message) {
        return new R<>(INTERNAL_SERVER_ERROR, message, null, null, null);
    }
    
    /**
     * é€šç”¨é”™è¯¯å“åº”ï¼Œå¸¦çŠ¶æ€ç å’Œæ¶ˆæ?     */
    public static <T> R<T> error(int code, String message) {
        return new R<>(code, message, null, null, null);
    }
    
    /**
     * é€šç”¨é”™è¯¯å“åº”ï¼Œå¸¦çŠ¶æ€ç ã€æ¶ˆæ¯å’Œæ•°æ®
     */
    public static <T> R<T> error(int code, String message, T data) {
        return new R<>(code, message, data, null, null);
    }
    
    // ==================== HTTPçŠ¶æ€ç å“åº” ====================
    
    /**
     * 400 - è¯·æ±‚å‚æ•°é”™è¯¯
     */
    public static <T> R<T> badRequest() {
        return new R<>(BAD_REQUEST, "è¯·æ±‚å‚æ•°é”™è¯¯", null, null, null);
    }
    
    public static <T> R<T> badRequest(String message) {
        return new R<>(BAD_REQUEST, message, null, null, null);
    }
    
    /**
     * 401 - æœªæˆæ?     */
    public static <T> R<T> unauthorized() {
        return new R<>(UNAUTHORIZED, "æœªæˆæƒè®¿é—?, null, null, null);
    }
    
    public static <T> R<T> unauthorized(String message) {
        return new R<>(UNAUTHORIZED, message, null, null, null);
    }
    
    /**
     * 403 - ç¦æ­¢è®¿é—®
     */
    public static <T> R<T> forbidden() {
        return new R<>(FORBIDDEN, "ç¦æ­¢è®¿é—®", null, null, null);
    }
    
    public static <T> R<T> forbidden(String message) {
        return new R<>(FORBIDDEN, message, null, null, null);
    }
    
    /**
     * 404 - èµ„æºæœªæ‰¾åˆ?     */
    public static <T> R<T> notFound() {
        return new R<>(NOT_FOUND, "èµ„æºæœªæ‰¾åˆ?, null, null, null);
    }
    
    public static <T> R<T> notFound(String message) {
        return new R<>(NOT_FOUND, message, null, null, null);
    }
    
    /**
     * 409 - å†²çª
     */
    public static <T> R<T> conflict() {
        return new R<>(CONFLICT, "æ•°æ®å†²çª", null, null, null);
    }
    
    public static <T> R<T> conflict(String message) {
        return new R<>(CONFLICT, message, null, null, null);
    }
    
    /**
     * 422 - ä¸šåŠ¡é€»è¾‘é”™è¯¯
     */
    public static <T> R<T> unprocessableEntity() {
        return new R<>(UNPROCESSABLE_ENTITY, "ä¸šåŠ¡å¤„ç†å¤±è´¥", null, null, null);
    }
    
    public static <T> R<T> unprocessableEntity(String message) {
        return new R<>(UNPROCESSABLE_ENTITY, message, null, null, null);
    }
    
    /**
     * 429 - è¯·æ±‚è¿‡äºé¢‘ç¹
     */
    public static <T> R<T> tooManyRequests() {
        return new R<>(TOO_MANY_REQUESTS, "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•", null, null, null);
    }
    
    /**
     * 500 - æœåŠ¡å™¨å†…éƒ¨é”™è¯?     */
    public static <T> R<T> internalServerError() {
        return new R<>(INTERNAL_SERVER_ERROR, "ç³»ç»Ÿå†…éƒ¨é”™è¯¯", null, null, null);
    }
    
    public static <T> R<T> internalServerError(String message) {
        return new R<>(INTERNAL_SERVER_ERROR, message, null, null, null);
    }
    
    // ==================== ä¸šåŠ¡é”™è¯¯å“åº”æ–¹æ³• ====================
    
    /**
     * ç”¨æˆ·ç›¸å…³é”™è¯¯
     */
    public static <T> R<T> userNotFound() {
        return new R<>(NOT_FOUND, "ç”¨æˆ·ä¸å­˜åœ?, null, null, null);
    }
    
    public static <T> R<T> userExists() {
        return new R<>(USER_EXISTS, "ç”¨æˆ·å·²å­˜åœ?, null, null, null);
    }
    
    public static <T> R<T> invalidCredentials() {
        return new R<>(INVALID_CREDENTIALS, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯", null, null, null);
    }
    
    public static <T> R<T> userDisabled() {
        return new R<>(USER_DISABLED, "ç”¨æˆ·å·²è¢«ç¦ç”¨", null, null, null);
    }
    
    /**
     * å•†å“ç›¸å…³é”™è¯¯
     */
    public static <T> R<T> productNotFound() {
        return new R<>(PRODUCT_NOT_FOUND, "å•†å“ä¸å­˜åœ?, null, null, null);
    }
    
    public static <T> R<T> insufficientStock() {
        return new R<>(INSUFFICIENT_STOCK, "åº“å­˜ä¸è¶³", null, null, null);
    }
    
    /**
     * è®¢å•ç›¸å…³é”™è¯¯
     */
    public static <T> R<T> orderNotFound() {
        return new R<>(ORDER_NOT_FOUND, "è®¢å•ä¸å­˜åœ?, null, null, null);
    }
    
    public static <T> R<T> orderStatusInvalid() {
        return new R<>(ORDER_STATUS_INVALID, "è®¢å•çŠ¶æ€ä¸å…è®¸æ“ä½œ", null, null, null);
    }
    
    /**
     * æ”¯ä»˜ç›¸å…³é”™è¯¯
     */
    public static <T> R<T> insufficientBalance() {
        return new R<>(INSUFFICIENT_BALANCE, "ä½™é¢ä¸è¶³", null, null, null);
    }
    
    public static <T> R<T> paymentFailed() {
        return new R<>(PAYMENT_FAILED, "æ”¯ä»˜å¤±è´¥", null, null, null);
    }
    
    /**
     * éªŒè¯ç ç›¸å…³é”™è¯?     */
    public static <T> R<T> verificationCodeInvalid() {
        return new R<>(VERIFICATION_CODE_INVALID, "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœ?, null, null, null);
    }
    
    /**
     * æ–‡ä»¶ä¸Šä¼ é”™è¯¯
     */
    public static <T> R<T> fileUploadFailed() {
        return new R<>(FILE_UPLOAD_FAILED, "æ–‡ä»¶ä¸Šä¼ å¤±è´¥", null, null, null);
    }
    
    /**
     * æ•°æ®éªŒè¯é”™è¯¯
     */
    public static <T> R<T> validationFailed(String details) {
        return new R<>(VALIDATION_FAILED, "æ•°æ®éªŒè¯å¤±è´¥: " + details, null, null, null);
    }
    
    // ==================== å®ç”¨æ–¹æ³• ====================
    
    /**
     * åˆ¤æ–­æ˜¯å¦æˆåŠŸ
     */
    public boolean isSuccess() {
        return code == SUCCESS;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦é”™è¯¯
     */
    public boolean isError() {
        return !isSuccess();
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºå®¢æˆ·ç«¯é”™è¯¯ï¼?xxï¼?     */
    public boolean isClientError() {
        return code >= 400 && code < 500;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæœåŠ¡å™¨é”™è¯¯ï¼?xxï¼?     */
    public boolean isServerError() {
        return code >= 500;
    }
    
    /**
     * è·å–HTTPçŠ¶æ€æè¿?     */
    public String getStatusText() {
        switch (code) {
            case SUCCESS: return "OK";
            case CREATED: return "Created";
            case NO_CONTENT: return "No Content";
            case BAD_REQUEST: return "Bad Request";
            case UNAUTHORIZED: return "Unauthorized";
            case FORBIDDEN: return "Forbidden";
            case NOT_FOUND: return "Not Found";
            case METHOD_NOT_ALLOWED: return "Method Not Allowed";
            case CONFLICT: return "Conflict";
            case PAYLOAD_TOO_LARGE: return "Payload Too Large";
            case UNSUPPORTED_MEDIA_TYPE: return "Unsupported Media Type";
            case UNPROCESSABLE_ENTITY: return "Unprocessable Entity";
            case TOO_MANY_REQUESTS: return "Too Many Requests";
            case INTERNAL_SERVER_ERROR: return "Internal Server Error";
            case BAD_GATEWAY: return "Bad Gateway";
            case SERVICE_UNAVAILABLE: return "Service Unavailable";
            case GATEWAY_TIMEOUT: return "Gateway Timeout";
            default: return "Unknown Status";
        }
    }
    
    // ==================== é™æ€å·¥å…·æ–¹æ³?====================
    
    /**
     * åˆ›å»ºæˆåŠŸå“åº”çš„æ„å»ºå™¨
     */
    public static <T> SuccessBuilder<T> successBuilder() {
        return new SuccessBuilder<>();
    }
    
    /**
     * åˆ›å»ºé”™è¯¯å“åº”çš„æ„å»ºå™¨
     */
    public static <T> ErrorBuilder<T> errorBuilder() {
        return new ErrorBuilder<>();
    }
    
    // ==================== å†…éƒ¨æ„å»ºå™¨ç±» ====================
    
    /**
     * æˆåŠŸå“åº”æ„å»ºå™?     */
    public static class SuccessBuilder<T> {
        private T data;
        private String message = "æ“ä½œæˆåŠŸ";
        private PageData page;
        private String requestId;
        
        public SuccessBuilder<T> data(T data) {
            this.data = data;
            return this;
        }
        
        public SuccessBuilder<T> message(String message) {
            this.message = message;
            return this;
        }
        
        public SuccessBuilder<T> page(PageData page) {
            this.page = page;
            return this;
        }
        
        public SuccessBuilder<T> requestId(String requestId) {
            this.requestId = requestId;
            return this;
        }
        
        public R<T> build() {
            return new R<>(SUCCESS, message, data, page, requestId);
        }
    }
    
    /**
     * é”™è¯¯å“åº”æ„å»ºå™?     */
    public static class ErrorBuilder<T> {
        private int code = INTERNAL_SERVER_ERROR;
        private String message = "ç³»ç»Ÿå†…éƒ¨é”™è¯¯";
        private T data;
        private PageData page;
        private String requestId;
        
        public ErrorBuilder<T> code(int code) {
            this.code = code;
            return this;
        }
        
        public ErrorBuilder<T> message(String message) {
            this.message = message;
            return this;
        }
        
        public ErrorBuilder<T> data(T data) {
            this.data = data;
            return this;
        }
        
        public ErrorBuilder<T> page(PageData page) {
            this.page = page;
            return this;
        }
        
        public ErrorBuilder<T> requestId(String requestId) {
            this.requestId = requestId;
            return this;
        }
        
        public R<T> build() {
            return new R<>(code, message, data, page, requestId);
        }
    }
}
package com.heikeji.mall.config;

import com.heikeji.mall.common.auth.JwtAuthenticationInterceptor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

/**
 * Webé…ç½®ç±? * æ³¨å†ŒJWTè®¤è¯æ‹¦æˆªå™? */
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private JwtAuthenticationInterceptor jwtAuthenticationInterceptor;
    
    /**
     * æ³¨å†Œæ‹¦æˆªå™?     */
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtAuthenticationInterceptor)
                .addPathPatterns("/**")
                .excludePathPatterns(
                        // é™æ€èµ„æº?                        "/static/**",
                        "/public/**",
                        "/assets/**",
                        "/css/**",
                        "/js/**",
                        "/images/**",
                        "/fonts/**",
                        "/favicon.ico",
                        // APIæ–‡æ¡£
                        "/swagger-ui/**",
                        "/v3/api-docs/**",
                        "/swagger-resources/**",
                        "/webjars/**",
                        // ç›‘æ§ç«¯ç‚¹
                        "/actuator/**",
                        "/health/**",
                        "/info/**"
                );
    }
}
package com.heikeji.mall.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.ComponentScan;

/**
 * ç”¨æˆ·æœåŠ¡å¯åŠ¨ç±? */
@SpringBootApplication
@ComponentScan({
    "com.heikeji.mall.user",
    "com.heikeji.common"
})
public class UserApplication {

    public static void main(String[] args) {
        SpringApplication.run(UserApplication.class, args);
    }
}
package com.heikeji.mall.user.config;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis Plusé…ç½®ç±? */
@Configuration
public class MyBatisPlusConfig {

    /**
     * åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
package com.heikeji.mall.user.constant;

/**
 * ç”¨æˆ·ç›¸å…³å¸¸é‡
 */
public class UserConstant {
    
    /**
     * ç”¨æˆ·ç±»å‹ - å­¦ç”Ÿ
     */
    public static final Integer USER_TYPE_STUDENT = 1;
    
    /**
     * ç”¨æˆ·ç±»å‹ - æ•™èŒå·?     */
    public static final Integer USER_TYPE_TEACHER = 2;
    
    /**
     * ç”¨æˆ·ç±»å‹ - å…¶ä»–
     */
    public static final Integer USER_TYPE_OTHER = 3;
    
    /**
     * ç”¨æˆ·çŠ¶æ€?- æ­£å¸¸
     */
    public static final Integer USER_STATUS_NORMAL = 0;
    
    /**
     * ç”¨æˆ·çŠ¶æ€?- ç¦ç”¨
     */
    public static final Integer USER_STATUS_DISABLE = 1;
}
package com.heikeji.mall.user.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.user.entity.Address;
import com.heikeji.mall.user.service.AddressService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * æ”¶è´§åœ°å€æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/address")
@Api(tags = "æ”¶è´§åœ°å€ç®¡ç†")
public class AddressController {

    @Autowired
    private AddressService addressService;

    /**
     * è·å–ç”¨æˆ·åœ°å€åˆ—è¡¨
     */
    @GetMapping("/list/{userId}")
    @ApiOperation("è·å–ç”¨æˆ·åœ°å€åˆ—è¡¨")
    public R<List<Address>> getAddressList(@PathVariable Long userId) {
        List<Address> addressList = addressService.getAddressList(userId);
        return R.success(addressList);
    }

    /**
     * è·å–é»˜è®¤åœ°å€
     */
    @GetMapping("/default/{userId}")
    @ApiOperation("è·å–é»˜è®¤åœ°å€")
    public R<Address> getDefaultAddress(@PathVariable Long userId) {
        Address address = addressService.getDefaultAddress(userId);
        return address != null ? R.success(address) : R.error("æœªè®¾ç½®é»˜è®¤åœ°å€");
    }

    /**
     * æ·»åŠ æ”¶è´§åœ°å€
     */
    @PostMapping("/add/{userId}")
    @ApiOperation("æ·»åŠ æ”¶è´§åœ°å€")
    public R<Boolean> addAddress(@PathVariable Long userId, @RequestBody Address address) {
        address.setUserId(userId);
        boolean result = addressService.addAddress(address);
        return result ? R.success(true) : R.error("æ·»åŠ å¤±è´¥");
    }

    /**
     * æ›´æ–°æ”¶è´§åœ°å€
     */
    @PutMapping("/update/{userId}")
    @ApiOperation("æ›´æ–°æ”¶è´§åœ°å€")
    public R<Boolean> updateAddress(@PathVariable Long userId, @RequestBody Address address) {
        // ç¡®ä¿åªèƒ½æ›´æ–°è‡ªå·±çš„åœ°å€
        Address existingAddress = addressService.getById(address.getId());
        if (existingAddress == null || !existingAddress.getUserId().equals(userId)) {
            return R.error("åœ°å€ä¸å­˜åœ¨æˆ–æ— æƒæ“ä½œ");
        }
        
        boolean result = addressService.updateAddress(address);
        return result ? R.success(true) : R.error("æ›´æ–°å¤±è´¥");
    }

    /**
     * åˆ é™¤æ”¶è´§åœ°å€
     */
    @DeleteMapping("/delete/{id}/{userId}")
    @ApiOperation("åˆ é™¤æ”¶è´§åœ°å€")
    public R<Boolean> deleteAddress(@PathVariable Long id, @PathVariable Long userId) {
        boolean result = addressService.deleteAddress(id, userId);
        return result ? R.success(true) : R.error("åˆ é™¤å¤±è´¥");
    }

    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     */
    @PutMapping("/setDefault/{id}/{userId}")
    @ApiOperation("è®¾ç½®é»˜è®¤åœ°å€")
    public R<Boolean> setDefaultAddress(@PathVariable Long id, @PathVariable Long userId) {
        boolean result = addressService.setDefaultAddress(id, userId);
        return result ? R.success(true) : R.error("è®¾ç½®å¤±è´¥");
    }
}
package com.heikeji.mall.user.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.mall.user.entity.DeliveryPerson;
import com.heikeji.mall.user.service.DeliveryPersonService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * é…é€å‘˜æ§åˆ¶å™? */
@RestController
@RequestMapping("/api/delivery")
@Api(tags = "é…é€å‘˜ç®¡ç†")
public class DeliveryPersonController {

    @Autowired
    private DeliveryPersonService deliveryPersonService;

    /**
     * è·å–å½“å‰ç”¨æˆ·çš„é…é€å‘˜ä¿¡æ¯
     */
    @GetMapping("/info/{userId}")
    @ApiOperation("è·å–ç”¨æˆ·çš„é…é€å‘˜ä¿¡æ¯")
    public R<DeliveryPerson> getDeliveryPersonInfo(@PathVariable Long userId) {
        DeliveryPerson deliveryPerson = deliveryPersonService.getByUserId(userId);
        return deliveryPerson != null ? R.success(deliveryPerson) : R.error("æœªç”³è¯·é…é€å‘˜");
    }

    /**
     * ç”³è¯·æˆä¸ºé…é€å‘˜
     */
    @PostMapping("/apply/{userId}")
    @ApiOperation("ç”³è¯·æˆä¸ºé…é€å‘˜")
    public R<Boolean> applyDelivery(@PathVariable Long userId, @RequestBody DeliveryPerson deliveryPerson) {
        deliveryPerson.setUserId(userId);
        boolean result = deliveryPersonService.applyDelivery(deliveryPerson);
        return result ? R.success(true) : R.error("ç”³è¯·å¤±è´¥ï¼Œå¯èƒ½å·²ç»ç”³è¯·è¿‡");
    }

    /**
     * å®¡æ ¸é…é€å‘˜ï¼ˆç®¡ç†å‘˜æ¥å£ï¼?     */
    @PutMapping("/audit/{id}")
    @ApiOperation("å®¡æ ¸é…é€å‘˜")
    public R<Boolean> auditDelivery(@PathVariable Long id, @RequestParam Byte status) {
        boolean result = deliveryPersonService.auditDelivery(id, status);
        return result ? R.success(true) : R.error("å®¡æ ¸å¤±è´¥");
    }

    /**
     * æ›´æ–°é…é€å‘˜çŠ¶æ€ï¼ˆç®¡ç†å‘˜æ¥å£ï¼‰
     */
    @PutMapping("/updateStatus/{id}")
    @ApiOperation("æ›´æ–°é…é€å‘˜çŠ¶æ€?)
    public R<Boolean> updateStatus(@PathVariable Long id, @RequestParam Byte status) {
        boolean result = deliveryPersonService.updateStatus(id, status);
        return result ? R.success(true) : R.error("æ›´æ–°çŠ¶æ€å¤±è´?);
    }

    /**
     * è·å–å¯ç”¨çš„é…é€å‘˜åˆ—è¡¨
     */
    @GetMapping("/available")
    @ApiOperation("è·å–å¯ç”¨é…é€å‘˜")
    public R<List<DeliveryPerson>> getAvailableDeliveryPersons(@RequestParam(defaultValue = "10") Integer limit) {
        List<DeliveryPerson> deliveryPersons = deliveryPersonService.getAvailableDeliveryPersons(limit);
        return R.success(deliveryPersons);
    }
}
package com.heikeji.mall.user.controller;

import com.heikeji.mall.common.auth.annotation.*;
import com.heikeji.mall.common.auth.UserContextHolder;
import com.heikeji.mall.common.response.R;
import com.heikeji.mall.user.dto.UserDTO;
import com.heikeji.mall.user.entity.User;
import com.heikeji.mall.user.entity.UserAuth;
import com.heikeji.mall.user.service.UserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Positive;
import java.math.BigDecimal;

/**
 * ç”¨æˆ·æ§åˆ¶å™? */
@Slf4j
@RestController
@RequestMapping("/api/user")
@Api(tags = "ç”¨æˆ·ç®¡ç†")
@Validated
public class UserController {

    @Autowired
    private UserService userService;

    /**
     * å¾®ä¿¡ç™»å½•
     */
    @PostMapping("/wechatLogin")
    @PublicApi("å¾®ä¿¡ç™»å½•æ¥å£ï¼Œæ— éœ€è®¤è¯")
    @ApiOperation("å¾®ä¿¡ç™»å½•")
    public R<UserAuth> wechatLogin(@Valid @NotBlank @RequestParam String code,
                                   @Valid @NotBlank @RequestParam String userInfo) {
        log.info("ç”¨æˆ·è¿›è¡Œå¾®ä¿¡ç™»å½•");
        UserAuth userAuth = userService.wechatLogin(code, userInfo);
        if (userAuth != null) {
            return R.success("ç™»å½•æˆåŠŸ", userAuth);
        }
        return R.error("ç™»å½•å¤±è´¥");
    }

    /**
     * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/me")
    @RequiresLogin
    @ApiOperation("è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯")
    public R<User> getCurrentUserInfo() {
        Long userId = UserContextHolder.getCurrentUserId();
        if (userId == null) {
            return R.badRequest("ç”¨æˆ·æœªç™»å½?);
        }
        User user = userService.getById(userId);
        return R.success("æŸ¥è¯¢æˆåŠŸ", user != null ? user : null);
    }

    /**
     * ç»‘å®šå­¦å·
     */
    @PostMapping("/bindStudentNo")
    @RequiresLogin
    @ApiOperation("ç»‘å®šå­¦å·")
    public R<Boolean> bindStudentNo(@Valid @NotBlank @RequestParam String studentNo,
                                    @RequestParam(required = false) Long userId) {
        // å¦‚æœuserIdä¸ºç©ºï¼Œå°è¯•ä»tokenä¸­è·å?        if (userId == null) {
            userId = UserContextHolder.getCurrentUserId();
        }
        
        if (userId == null) {
            return R.badRequest("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        log.info("ç”¨æˆ·{}ç»‘å®šå­¦å·: {}", userId, studentNo);
        boolean result = userService.bindStudentNo(userId, studentNo);
        
        if (result) {
            return R.success("å­¦å·ç»‘å®šæˆåŠŸ", true);
        }
        return R.conflict("å­¦å·å·²è¢«å…¶ä»–ç”¨æˆ·ç»‘å®š");
    }

    /**
     * æ ¹æ®æ‰‹æœºå·è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆç®¡ç†å‘˜æ¥å£ï¼‰
     */
    @GetMapping("/admin/getByPhone/{phone}")
    @RequiresAdmin
    @ApiOperation("æ ¹æ®æ‰‹æœºå·è·å–ç”¨æˆ·ä¿¡æ?)
    public R<User> getUserByPhone(@Valid @NotBlank @PathVariable String phone) {
        User user = userService.getUserByPhone(phone);
        return user != null ? R.success("æŸ¥è¯¢æˆåŠŸ", user) : R.userNotFound();
    }

    /**
     * æ ¹æ®å­¦å·è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆç®¡ç†å‘˜æ¥å£ï¼?     */
    @GetMapping("/admin/getByStudentNo/{studentNo}")
    @RequiresAdmin
    @ApiOperation("æ ¹æ®å­¦å·è·å–ç”¨æˆ·ä¿¡æ¯")
    public R<User> getUserByStudentNo(@Valid @NotBlank @PathVariable String studentNo) {
        User user = userService.getUserByStudentNo(studentNo);
        return user != null ? R.success("æŸ¥è¯¢æˆåŠŸ", user) : R.userNotFound();
    }

    /**
     * è·å–ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/info/{userId}")
    @RequiresLogin
    @ApiOperation("è·å–ç”¨æˆ·ä¿¡æ¯")
    public R<User> getUserInfo(@PathVariable Long userId) {
        User user = userService.getById(userId);
        return user != null ? R.success(user) : R.userNotFound();
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    @PutMapping("/info/{userId}")
    @RequiresLogin
    @ApiOperation("æ›´æ–°ç”¨æˆ·ä¿¡æ¯")
    public R<Boolean> updateUserInfo(@PathVariable Long userId, @RequestBody UserDTO userDTO) {
        User user = new User();
        BeanUtils.copyProperties(userDTO, user);
        user.setId(userId);
        boolean result = userService.updateUserInfo(user);
        return R.success(result);
    }

    /**
     * è·å–ç”¨æˆ·ä½™é¢
     */
    @GetMapping("/balance/{userId}")
    @RequiresLogin
    @ApiOperation("è·å–ç”¨æˆ·ä½™é¢")
    public R<BigDecimal> getBalance(@PathVariable Long userId) {
        User user = userService.getById(userId);
        return R.success(user != null ? user.getBalance() : BigDecimal.ZERO);
    }

    /**
     * æ›´æ–°ç”¨æˆ·ä½™é¢
     */
    @PutMapping("/updateBalance/{userId}")
    @RequiresLogin
    @ApiOperation("æ›´æ–°ç”¨æˆ·ä½™é¢")
    public R<Boolean> updateBalance(@PathVariable Long userId, @RequestParam BigDecimal amount) {
        boolean result = userService.updateBalance(userId, amount);
        return result ? R.success(true) : R.error("ä½™é¢æ›´æ–°å¤±è´¥");
    }

    /**
     * éªŒè¯ç”¨æˆ·èº«ä»½
     */
    @PostMapping("/verify/{userId}")
    @RequiresLogin
    @ApiOperation("éªŒè¯ç”¨æˆ·èº«ä»½")
    public R<Boolean> verifyUser(@PathVariable Long userId, @RequestParam String realName, @RequestParam String idCard) {
        boolean result = userService.verifyUser(userId, realName, idCard);
        return result ? R.success(true) : R.error("éªŒè¯å¤±è´¥");
    }

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/detail")
    @RequiresLogin
    @ApiOperation("æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…")
    public R<User> getUserDetail(@RequestParam Long userId) {
        User user = userService.getById(userId);
        return R.success(user);
    }
    
    /**
     * æ‰£å‡ç”¨æˆ·ä½™é¢ï¼ˆä¾›å…¶ä»–æœåŠ¡è°ƒç”¨ï¼?     */
    @PutMapping("/balance/deduct/{userId}")
    @RequiresLogin
    @ApiOperation("æ‰£å‡ç”¨æˆ·ä½™é¢")
    public R<Boolean> deductBalance(@PathVariable Long userId, @RequestParam BigDecimal amount) {
        boolean result = userService.deductBalance(userId, amount);
        return result ? R.success(true) : R.error("ä½™é¢ä¸è¶³æˆ–ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    /**
     * å……å€¼ç”¨æˆ·ä½™é¢ï¼ˆä¾›å…¶ä»–æœåŠ¡è°ƒç”¨ï¼‰
     */
    @PutMapping("/balance/recharge/{userId}")
    @RequiresLogin
    @ApiOperation("å……å€¼ç”¨æˆ·ä½™é¢?)
    public R<Boolean> rechargeBalance(@PathVariable Long userId, @RequestParam BigDecimal amount) {
        boolean result = userService.rechargeBalance(userId, amount);
        return result ? R.success(true) : R.error("å……å€¼å¤±è´¥æˆ–ç”¨æˆ·ä¸å­˜åœ?);
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·ä½™é¢æ˜¯å¦å……è¶?     */
    @GetMapping("/balance/check")
    @RequiresLogin
    @ApiOperation("æ£€æŸ¥ä½™é¢?)
    public R<Boolean> checkBalance(@RequestParam Long userId, @RequestParam BigDecimal amount) {
        boolean result = userService.checkBalance(userId, amount);
        return R.success(result);
    }
}
package com.heikeji.mall.user.dto;

import lombok.Data;

/**
 * ç™»å½•è¯·æ±‚å¯¹è±¡
 */
@Data
public class LoginDTO {
    
    /**
     * ç”¨æˆ·åæˆ–æ‰‹æœºå?     */
    private String username;
    
    /**
     * å¯†ç 
     */
    private String password;
}
package com.heikeji.mall.user.dto;

import lombok.Data;

/**
 * å¯†ç ä¿®æ”¹è¯·æ±‚å¯¹è±¡
 */
@Data
public class PasswordDTO {
    
    /**
     * æ—§å¯†ç ?     */
    private String oldPassword;
    
    /**
     * æ–°å¯†ç ?     */
    private String newPassword;
}
package com.heikeji.mall.user.dto;

import lombok.Data;

/**
 * ç”¨æˆ·ä¼ è¾“å¯¹è±¡
 */
@Data
public class UserDTO {
    
    /**
     * æ‰‹æœºå?     */
    private String phone;
    
    /**
     * å­¦å·
     */
    private String studentNo;
    
    /**
     * æ˜µç§°
     */
    private String nickname;
    
    /**
     * å¤´åƒ
     */
    private String avatar;
    
    /**
     * æ€§åˆ«ï¼?-æœªçŸ¥ï¼?-ç”·ï¼Œ2-å¥?     */
    private Byte sex;
    
    /**
     * æ ¡åŒº
     */
    private String campusArea;
    
    /**
     * æ¥¼æ ‹
     */
    private String building;
    
    /**
     * æˆ¿é—´å?     */
    private String room;
}
package com.heikeji.mall.user.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * æ”¶è´§åœ°å€è¡? */
@Data
@TableName("address")
public class Address implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * åœ°å€ID
     */
    @TableId
    private Long id;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * æ”¶è´§äººå§“å?     */
    private String receiverName;

    /**
     * æ”¶è´§äººç”µè¯?     */
    private String receiverPhone;

    /**
     * æ ¡åŒºï¼šä¸œåŒºã€è¥¿åŒºç­‰
     */
    private String campusArea;

    /**
     * æ¥¼æ ‹ï¼šå¦‚"è¥¿åŒº1å·æ¥¼Aæ ?
     */
    private String building;

    /**
     * æˆ¿é—´å·ï¼šå¦?501"
     */
    private String room;

    /**
     * è¯¦ç»†åœ°å€
     */
    private String detailAddress;

    /**
     * æ˜¯å¦é»˜è®¤åœ°å€ï¼?-å¦ï¼Œ1-æ˜?     */
    private Byte isDefault;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date updateTime;

    /**
     * åˆ é™¤æ ‡å¿—ï¼?-æ­£å¸¸ï¼?-åˆ é™¤
     */
    private Byte delFlag;
}
package com.heikeji.mall.user.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * è·‘è…¿å‘˜è¡¨
 */
@Data
@TableName("delivery_person")
public class DeliveryPerson implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * è·‘è…¿å‘˜ID
     */
    @TableId
    private Long id;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * çœŸå®å§“å
     */
    private String realName;

    /**
     * èº«ä»½è¯å·
     */
    private String idCard;

    /**
     * è”ç³»ç”µè¯
     */
    private String phone;

    /**
     * çŠ¶æ€ï¼š0-æ­£å¸¸ï¼?-ç¦ç”¨
     */
    private Byte status;

    /**
     * æ˜¯å¦è®¤è¯ï¼?-æœªè®¤è¯ï¼Œ1-å·²è®¤è¯?     */
    private Byte isVerified;

    /**
     * å®Œæˆè®¢å•æ•?     */
    private Integer totalOrders;

    /**
     * è¯„åˆ†ï¼?åˆ†åˆ¶ï¼?     */
    private Double rating;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date updateTime;
}
package com.heikeji.mall.user.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

/**
 * ç”¨æˆ·å®ä½“ç±? */
@Data
@TableName("user")
public class User implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * ç”¨æˆ·ID
     */
    @TableId
    private Long id;

    /**
     * å­¦å·
     */
    private String studentNo;

    /**
     * æ˜µç§°
     */
    private String nickname;

    /**
     * å¤´åƒ
     */
    private String avatar;

    /**
     * ç”¨æˆ·ç±»å‹ï¼šUSER-æ™®é€šç”¨æˆ·ï¼ŒMERCHANT-å•†æˆ·ï¼ŒADMIN-ç®¡ç†å‘?     */
    private String userType;

    /**
     * æ‰‹æœºå?     */
    private String phone;

    /**
     * é‚®ç®±
     */
    private String email;

    /**
     * å¯†ç 
     */
    private String password;

    /**
     * å¾®ä¿¡OpenID
     */
    private String openid;

    /**
     * æ€§åˆ«ï¼?-æœªçŸ¥ï¼?-ç”·ï¼Œ2-å¥?     */
    private Byte sex;

    /**
     * çŠ¶æ€ï¼š0-æ­£å¸¸ï¼?-ç¦ç”¨
     */
    private Byte status;

    /**
     * æ˜¯å¦å®åè®¤è¯ï¼?-æœªè®¤è¯ï¼Œ1-å·²è®¤è¯?     */
    private Byte isVerified;

    /**
     * è´¦æˆ·ä½™é¢
     */
    private BigDecimal balance;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date updateTime;

    /**
     * åˆ é™¤æ ‡å¿—ï¼?-æ­£å¸¸ï¼?-åˆ é™¤
     */
    private Byte delFlag;
}
package com.heikeji.mall.user.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import com.fasterxml.jackson.annotation.JsonFormat;
import lombok.Data;

import java.io.Serializable;
import java.util.Date;

/**
 * ç”¨æˆ·è®¤è¯è¡¨ï¼ˆå¾®ä¿¡ç™»å½•ï¼? */
@Data
@TableName("user_auth")
public class UserAuth implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * ä¸»é”®ID
     */
    @TableId
    private Long id;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * å¾®ä¿¡OpenID
     */
    private String openId;

    /**
     * å¾®ä¿¡UnionID
     */
    private String unionId;

    /**
     * ä¼šè¯å¯†é’¥
     */
    private String sessionKey;

    /**
     * ç”¨æˆ·Token
     */
    private String token;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private Date updateTime;
}
package com.heikeji.mall.user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.user.entity.Address;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * åœ°å€Mapperæ¥å£
 */
@Mapper
public interface AddressMapper extends BaseMapper<Address> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢åœ°å€åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @return åœ°å€åˆ—è¡¨
     */
    List<Address> selectByUserId(@Param("userId") Long userId);
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·é»˜è®¤åœ°å€
     * @param userId ç”¨æˆ·ID
     * @return é»˜è®¤åœ°å€
     */
    Address selectDefaultByUserId(@Param("userId") Long userId);
    
    /**
     * å–æ¶ˆç”¨æˆ·æ‰€æœ‰é»˜è®¤åœ°å€
     * @param userId ç”¨æˆ·ID
     */
    void cancelDefaultByUserId(@Param("userId") Long userId);
}
package com.heikeji.mall.user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.user.entity.DeliveryPerson;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

/**
 * è·‘è…¿å‘˜Mapperæ¥å£
 */
@Mapper
public interface DeliveryPersonMapper extends BaseMapper<DeliveryPerson> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è·‘è…¿å‘˜ä¿¡æ?     * @param userId ç”¨æˆ·ID
     * @return è·‘è…¿å‘˜ä¿¡æ?     */
    DeliveryPerson selectByUserId(@Param("userId") Long userId);
    
    /**
     * æ›´æ–°è·‘è…¿å‘˜è®¢å•æ•°å’Œè¯„åˆ?     * @param id è·‘è…¿å‘˜ID
     * @param totalOrders æ€»è®¢å•æ•°
     * @param rating è¯„åˆ†
     */
    void updateOrderStats(@Param("id") Long id, @Param("totalOrders") Integer totalOrders, @Param("rating") Double rating);
}
package com.heikeji.mall.user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.user.entity.UserAuth;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

/**
 * ç”¨æˆ·è®¤è¯Mapperæ¥å£
 */
@Mapper
public interface UserAuthMapper extends BaseMapper<UserAuth> {
    
    /**
     * æ ¹æ®OpenIDæŸ¥è¯¢ç”¨æˆ·è®¤è¯ä¿¡æ¯
     * @param openId å¾®ä¿¡OpenID
     * @return ç”¨æˆ·è®¤è¯ä¿¡æ¯
     */
    UserAuth selectByOpenId(@Param("openId") String openId);
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è®¤è¯ä¿¡æ¯
     * @param userId ç”¨æˆ·ID
     * @return ç”¨æˆ·è®¤è¯ä¿¡æ¯
     */
    UserAuth selectByUserId(@Param("userId") Long userId);
}
package com.heikeji.mall.user.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.mall.user.entity.User;
import org.apache.ibatis.annotations.Mapper;

/**
 * ç”¨æˆ·Mapperæ¥å£
 */
@Mapper
public interface UserMapper extends BaseMapper<User> {
}
package com.heikeji.mall.user.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.user.entity.Address;

import java.util.List;

/**
 * åœ°å€æœåŠ¡æ¥å£
 */
public interface AddressService extends IService<Address> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢åœ°å€åˆ—è¡¨
     * @param userId ç”¨æˆ·ID
     * @return åœ°å€åˆ—è¡¨
     */
    List<Address> getAddressList(Long userId);
    
    /**
     * è·å–ç”¨æˆ·é»˜è®¤åœ°å€
     * @param userId ç”¨æˆ·ID
     * @return é»˜è®¤åœ°å€
     */
    Address getDefaultAddress(Long userId);
    
    /**
     * æ–°å¢åœ°å€
     * @param address åœ°å€ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean addAddress(Address address);
    
    /**
     * æ›´æ–°åœ°å€
     * @param address åœ°å€ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateAddress(Address address);
    
    /**
     * åˆ é™¤åœ°å€
     * @param id åœ°å€ID
     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean deleteAddress(Long id, Long userId);
    
    /**
     * è®¾ç½®é»˜è®¤åœ°å€
     * @param id åœ°å€ID
     * @param userId ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean setDefaultAddress(Long id, Long userId);
}
package com.heikeji.mall.user.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.user.entity.DeliveryPerson;

import java.util.List;

/**
 * è·‘è…¿å‘˜æœåŠ¡æ¥å? */
public interface DeliveryPersonService extends IService<DeliveryPerson> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è·‘è…¿å‘˜ä¿¡æ?     * @param userId ç”¨æˆ·ID
     * @return è·‘è…¿å‘˜ä¿¡æ?     */
    DeliveryPerson getByUserId(Long userId);
    
    /**
     * ç”³è¯·æˆä¸ºè·‘è…¿å‘?     * @param deliveryPerson è·‘è…¿å‘˜ä¿¡æ?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean applyDelivery(DeliveryPerson deliveryPerson);
    
    /**
     * å®¡æ ¸è·‘è…¿å‘?     * @param id è·‘è…¿å‘˜ID
     * @param status å®¡æ ¸çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean auditDelivery(Long id, Byte status);
    
    /**
     * æ›´æ–°è·‘è…¿å‘˜çŠ¶æ€?     * @param id è·‘è…¿å‘˜ID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateStatus(Long id, Byte status);
    
    /**
     * æ›´æ–°è·‘è…¿å‘˜è®¢å•ç»Ÿè®¡ä¿¡æ?     * @param id è·‘è…¿å‘˜ID
     * @param newRating æ–°è¯„åˆ?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateOrderStats(Long id, Double newRating);
    
    /**
     * è·å–å¯ç”¨è·‘è…¿å‘˜åˆ—è¡?     * @param limit é™åˆ¶æ•°é‡
     * @return è·‘è…¿å‘˜åˆ—è¡?     */
    List<DeliveryPerson> getAvailableDeliveryPersons(Integer limit);
}
package com.heikeji.mall.user.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.mall.user.entity.User;
import com.heikeji.mall.user.entity.UserAuth;

import java.math.BigDecimal;

/**
 * ç”¨æˆ·æœåŠ¡æ¥å£
 */
public interface UserService extends IService<User> {
    
    /**
     * æ ¹æ®å­¦å·æŸ¥è¯¢ç”¨æˆ·
     */
    User getUserByStudentNo(String studentNo);
    
    /**
     * æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ?     */
    User getUserByPhone(String phone);
    
    /**
     * æ ¹æ®OpenIDè·å–æˆ–åˆ›å»ºç”¨æˆ?     */
    User getUserByOpenId(String openId);
    
    /**
     * å¾®ä¿¡ç™»å½•
     */
    UserAuth wechatLogin(String code, String userInfo);
    
    /**
     * ç»‘å®šå­¦å·
     */
    boolean bindStudentNo(Long userId, String studentNo);
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    boolean updateUserInfo(User user);
    
    /**
     * æ›´æ–°ç”¨æˆ·ä½™é¢
     */
    boolean updateBalance(Long userId, BigDecimal amount);
    
    /**
     * ç¦ç”¨/å¯ç”¨ç”¨æˆ·
     */
    boolean updateStatus(Long userId, Byte status);
    
    /**
     * å®åè®¤è¯
     */
    boolean verifyUser(Long userId, String realName, String idCard);
    
    /**
     * æ‰£å‡ç”¨æˆ·ä½™é¢
     */
    boolean deductBalance(Long userId, BigDecimal amount);
    
    /**
     * å……å€¼ç”¨æˆ·ä½™é¢?     */
    boolean rechargeBalance(Long userId, BigDecimal amount);
    
    /**
     * æ£€æŸ¥ç”¨æˆ·ä½™é¢æ˜¯å¦å……è¶?     */
    boolean checkBalance(Long userId, BigDecimal amount);
    
    /**
     * æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ·
     */
    User getUserByEmail(String email);
}
package com.heikeji.mall.user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.user.entity.Address;
import com.heikeji.mall.user.mapper.AddressMapper;
import com.heikeji.mall.user.service.AddressService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Date;
import java.util.List;

/**
 * æ”¶è´§åœ°å€æœåŠ¡å®ç°ç±? */
@Service
public class AddressServiceImpl extends ServiceImpl<AddressMapper, Address> implements AddressService {

    @Autowired
    private AddressMapper addressMapper;

    @Override
    public List<Address> getAddressList(Long userId) {
        return addressMapper.selectByUserId(userId);
    }

    @Override
    public Address getDefaultAddress(Long userId) {
        return addressMapper.selectDefaultByUserId(userId);
    }

    @Transactional
    @Override
    public boolean addAddress(Address address) {
        address.setCreateTime(new Date());
        address.setUpdateTime(new Date());
        address.setDelFlag((byte) 0);
        
        // å¦‚æœè®¾ç½®ä¸ºé»˜è®¤åœ°å€ï¼Œå…ˆå°†è¯¥ç”¨æˆ·å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®?        if (address.getIsDefault() == 1) {
            addressMapper.cancelDefaultByUserId(address.getUserId());
        }
        
        return save(address);
    }

    @Transactional
    @Override
    public boolean updateAddress(Address address) {
        address.setUpdateTime(new Date());
        
        // å¦‚æœè®¾ç½®ä¸ºé»˜è®¤åœ°å€ï¼Œå…ˆå°†è¯¥ç”¨æˆ·å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®?        if (address.getIsDefault() == 1) {
            addressMapper.cancelDefaultByUserId(address.getUserId());
        }
        
        return updateById(address);
    }

    @Transactional
    @Override
    public boolean deleteAddress(Long id, Long userId) {
        // è½¯åˆ é™¤ï¼Œè®¾ç½®åˆ é™¤æ ‡å¿—
        Address address = new Address();
        address.setId(id);
        address.setDelFlag((byte) 1);
        address.setUpdateTime(new Date());
        
        // ç¡®ä¿åªèƒ½åˆ é™¤è‡ªå·±çš„åœ°å€
        LambdaQueryWrapper<Address> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(Address::getId, id)
               .eq(Address::getUserId, userId)
               .eq(Address::getDelFlag, 0);
        
        return update(address, wrapper);
    }

    @Transactional
    @Override
    public boolean setDefaultAddress(Long id, Long userId) {
        // å…ˆå°†è¯¥ç”¨æˆ·å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®?        addressMapper.cancelDefaultByUserId(userId);
        
        // å°†æŒ‡å®šåœ°å€è®¾ä¸ºé»˜è®¤
        Address address = new Address();
        address.setId(id);
        address.setIsDefault((byte) 1);
        address.setUpdateTime(new Date());
        
        // ç¡®ä¿åªèƒ½æ“ä½œè‡ªå·±çš„åœ°å€
        LambdaQueryWrapper<Address> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(Address::getId, id)
               .eq(Address::getUserId, userId)
               .eq(Address::getDelFlag, 0);
        
        return update(address, wrapper);
    }
}
package com.heikeji.mall.user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.conditions.update.LambdaUpdateWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.user.entity.DeliveryPerson;
import com.heikeji.mall.user.mapper.DeliveryPersonMapper;
import com.heikeji.mall.user.service.DeliveryPersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

/**
 * é…é€å‘˜æœåŠ¡å®ç°ç±? */
@Service
public class DeliveryPersonServiceImpl extends ServiceImpl<DeliveryPersonMapper, DeliveryPerson> implements DeliveryPersonService {

    @Autowired
    private DeliveryPersonMapper deliveryPersonMapper;

    @Override
    public DeliveryPerson getByUserId(Long userId) {
        return deliveryPersonMapper.selectByUserId(userId);
    }

    @Transactional
    @Override
    public boolean applyDelivery(DeliveryPerson deliveryPerson) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç”³è¯·è¿‡
        DeliveryPerson existing = getByUserId(deliveryPerson.getUserId());
        if (existing != null) {
            return false;
        }
        
        deliveryPerson.setStatus((byte) 0); // å¾…å®¡æ ?        deliveryPerson.setIsVerified((byte) 0);
        deliveryPerson.setTotalOrders(0);
        deliveryPerson.setRating(0.0);
        deliveryPerson.setCreateTime(new Date());
        deliveryPerson.setUpdateTime(new Date());
        
        return save(deliveryPerson);
    }

    @Transactional
    @Override
    public boolean auditDelivery(Long id, Byte status) {
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(id);
        deliveryPerson.setStatus(status);
        deliveryPerson.setUpdateTime(new Date());
        
        if (status == 1) { // å®¡æ ¸é€šè¿‡
            deliveryPerson.setIsVerified((byte) 1);
        }
        
        return updateById(deliveryPerson);
    }

    @Transactional
    @Override
    public boolean updateStatus(Long id, Byte status) {
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(id);
        deliveryPerson.setStatus(status);
        deliveryPerson.setUpdateTime(new Date());
        
        return updateById(deliveryPerson);
    }

    @Override
    public boolean updateOrderStats(Long id, Double newRating) {
        DeliveryPerson deliveryPerson = new DeliveryPerson();
        deliveryPerson.setId(id);
        deliveryPerson.setRating(newRating);
        deliveryPerson.setUpdateTime(new Date());
        
        return updateById(deliveryPerson);
    }

    @Override
    public List<DeliveryPerson> getAvailableDeliveryPersons(Integer limit) {
        LambdaQueryWrapper<DeliveryPerson> wrapper = new LambdaQueryWrapper<>();
        wrapper.eq(DeliveryPerson::getStatus, 1) // å·²å®¡æ ¸é€šè¿‡
               .eq(DeliveryPerson::getIsVerified, 1) // å·²è®¤è¯?               .orderByDesc(DeliveryPerson::getRating) // æŒ‰è¯„åˆ†æ’åº?               .last(limit != null ? "LIMIT " + limit : ""); // æ·»åŠ é™åˆ¶
        
        return list(wrapper);
    }
}
package com.heikeji.mall.user.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.mall.user.entity.User;
import com.heikeji.mall.user.entity.UserAuth;
import com.heikeji.mall.user.mapper.UserAuthMapper;
import com.heikeji.mall.user.mapper.UserMapper;
import com.heikeji.mall.user.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.Date;
import java.util.UUID;

/**
 * ç”¨æˆ·æœåŠ¡å®ç°ç±? */
@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {

    @Autowired
    private UserAuthMapper userAuthMapper;

    @Override
    public User getUserByStudentNo(String studentNo) {
        return getOne(new LambdaQueryWrapper<User>().eq(User::getStudentNo, studentNo));
    }

    @Override
    public User getUserByPhone(String phone) {
        return getOne(new LambdaQueryWrapper<User>().eq(User::getPhone, phone));
    }

    @Override
    public User getUserByOpenId(String openId) {
        UserAuth userAuth = userAuthMapper.selectByOpenId(openId);
        if (userAuth == null) {
            return null;
        }
        return getById(userAuth.getUserId());
    }

    @Override
    public User getUserByEmail(String email) {
        return getOne(new LambdaQueryWrapper<User>().eq(User::getEmail, email));
    }

    @Transactional
    @Override
    public UserAuth wechatLogin(String code, String userInfo) {
        // TODO: è°ƒç”¨å¾®ä¿¡APIè·å–openIdç­‰ä¿¡æ?        String openId = "mock_openid_" + UUID.randomUUID().toString().substring(0, 8);
        String sessionKey = "mock_session_key" + UUID.randomUUID().toString();
        
        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·
        UserAuth userAuth = userAuthMapper.selectByOpenId(openId);
        if (userAuth == null) {
            // åˆ›å»ºæ–°ç”¨æˆ?            User user = new User();
            user.setNickname("å¾®ä¿¡ç”¨æˆ·" + openId.substring(0, 6));
            user.setAvatar("https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTLZibZAK6y1icT5j91gEib0IiaZ9VJx5aYwG9f7z0hM5a8IicNvXrUx6qXQVQ/132");
            user.setSex((byte) 0);
            user.setStatus((byte) 0);
            user.setIsVerified((byte) 0);
            user.setBalance(BigDecimal.ZERO);
            user.setDelFlag((byte) 0);
            save(user);
            
            // åˆ›å»ºè®¤è¯ä¿¡æ¯
            userAuth = new UserAuth();
            userAuth.setUserId(user.getId());
            userAuth.setOpenId(openId);
            userAuth.setSessionKey(sessionKey);
            userAuth.setCreateTime(new Date());
            userAuth.setUpdateTime(new Date());
            userAuthMapper.insert(userAuth);
        } else {
            // æ›´æ–°sessionKey
            userAuth.setSessionKey(sessionKey);
            userAuth.setUpdateTime(new Date());
            userAuthMapper.updateById(userAuth);
        }
        
        return userAuth;
    }

    @Transactional
    @Override
    public boolean bindStudentNo(Long userId, String studentNo) {
        // æ£€æŸ¥å­¦å·æ˜¯å¦å·²è¢«ç»‘å®?        User existingUser = getUserByStudentNo(studentNo);
        if (existingUser != null && !existingUser.getId().equals(userId)) {
            return false;
        }
        
        User user = new User();
        user.setId(userId);
        user.setStudentNo(studentNo);
        user.setUpdateTime(new Date());
        return updateById(user);
    }

    @Transactional
    @Override
    public boolean updateUserInfo(User user) {
        user.setUpdateTime(new Date());
        // åªæ›´æ–°å…è®¸ä¿®æ”¹çš„å­—æ®µ
        return updateById(user);
    }

    @Transactional
    @Override
    public boolean updateBalance(Long userId, BigDecimal amount) {
        User user = getById(userId);
        if (user == null) {
            return false;
        }
        
        // æ›´æ–°ä½™é¢
        BigDecimal newBalance = user.getBalance().add(amount);
        if (newBalance.compareTo(BigDecimal.ZERO) < 0) {
            return false; // ä½™é¢ä¸è¶³
        }
        
        user.setBalance(newBalance);
        user.setUpdateTime(new Date());
        return updateById(user);
    }

    @Transactional
    @Override
    public boolean updateStatus(Long userId, Byte status) {
        User user = new User();
        user.setId(userId);
        user.setStatus(status);
        user.setUpdateTime(new Date());
        return updateById(user);
    }

    @Transactional
    @Override
    public boolean verifyUser(Long userId, String realName, String idCard) {
        User user = new User();
        user.setId(userId);
        user.setIsVerified((byte) 1);
        user.setUpdateTime(new Date());
        return updateById(user);
    }
    
    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean deductBalance(Long userId, BigDecimal amount) {
        User user = getById(userId);
        if (user == null) {
            return false;
        }
        
        // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶?        if (user.getBalance().compareTo(amount) < 0) {
            return false;
        }
        
        // æ‰£å‡ä½™é¢
        BigDecimal newBalance = user.getBalance().subtract(amount);
        user.setBalance(newBalance);
        user.setUpdateTime(new Date());
        
        return updateById(user);
    }
    
    @Transactional(rollbackFor = Exception.class)
    @Override
    public boolean rechargeBalance(Long userId, BigDecimal amount) {
        User user = getById(userId);
        if (user == null) {
            return false;
        }
        
        // æ£€æŸ¥å……å€¼é‡‘é¢æ˜¯å¦æœ‰æ•?        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            return false;
        }
        
        // å¢åŠ ä½™é¢
        BigDecimal newBalance = user.getBalance().add(amount);
        user.setBalance(newBalance);
        user.setUpdateTime(new Date());
        
        return updateById(user);
    }
    
    @Override
    public boolean checkBalance(Long userId, BigDecimal amount) {
        User user = getById(userId);
        if (user == null) {
            return false;
        }
        
        // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶?        return user.getBalance().compareTo(amount) >= 0;
    }
}
package com.heikeji.mall.user.controller;

import com.heikeji.mall.common.response.R;
import com.heikeji.mall.user.entity.Address;
import com.heikeji.mall.user.service.AddressService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.util.Optional;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * AddressControllerå•å…ƒæµ‹è¯•
 */
@ExtendWith(MockitoExtension.class)
public class AddressControllerTest {

    private MockMvc mockMvc;

    @Mock
    private AddressService addressService;

    @InjectMocks
    private AddressController addressController;

    @BeforeEach
    public void setup() {
        mockMvc = MockMvcBuilders.standaloneSetup(addressController).build();
    }

    @Test
    public void testGetAddress_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        Address address = new Address();
        address.setId(id);
        address.setUserId(1L);
        address.setDetailAddress("æµ‹è¯•åœ°å€");
        
        when(addressService.getById(id)).thenReturn(address);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/address/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.detailAddress").value("æµ‹è¯•åœ°å€"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).getById(id);
    }

    @Test
    public void testGetAddress_NotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        when(addressService.getById(id)).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/address/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("åœ°å€ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).getById(id);
    }

    @Test
    public void testAddAddress_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Address address = new Address();
        address.setUserId(1L);
        address.setDetailAddress("æ–°åœ°å€");
        
        when(addressService.addAddress(any(Address.class))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/address/add")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"userId\":1,\"detailAddress\":\"æ–°åœ°å€\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).addAddress(any(Address.class));
    }

    @Test
    public void testAddAddress_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Address address = new Address();
        address.setUserId(1L);
        address.setDetailAddress("æ–°åœ°å€");
        
        when(addressService.addAddress(any(Address.class))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/address/add")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"userId\":1,\"detailAddress\":\"æ–°åœ°å€\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("åœ°å€æ·»åŠ å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).addAddress(any(Address.class));
    }

    @Test
    public void testUpdateAddress_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        Address address = new Address();
        address.setId(id);
        address.setDetailAddress("æ›´æ–°çš„åœ°å€");
        
        when(addressService.updateAddress(any(Address.class))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/address/update/{id}", id)
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"id\":1,\"detailAddress\":\"æ›´æ–°çš„åœ°å€\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).updateAddress(any(Address.class));
    }

    @Test
    public void testUpdateAddress_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        Address address = new Address();
        address.setId(id);
        
        when(addressService.updateAddress(any(Address.class))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/address/update/{id}", id)
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"id\":1,\"detailAddress\":\"æ›´æ–°çš„åœ°å€\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("åœ°å€æ›´æ–°å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).updateAddress(any(Address.class));
    }

    @Test
    public void testDeleteAddress_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        Long userId = 1L;
        when(addressService.deleteAddress(eq(id), eq(userId))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(delete("/api/user/address/delete/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).deleteAddress(id, userId);
    }

    @Test
    public void testDeleteAddress_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long id = 1L;
        Long userId = 1L;
        when(addressService.deleteAddress(eq(id), eq(userId))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(delete("/api/user/address/delete/{id}", id))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("åœ°å€åˆ é™¤å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).deleteAddress(id, userId);
    }

    @Test
    public void testSetDefaultAddress_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        Long addressId = 2L;
        when(addressService.setDefaultAddress(eq(addressId), eq(userId))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/address/setDefault")
                .param("userId", userId.toString())
                .param("addressId", addressId.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).setDefaultAddress(addressId, userId);
    }

    @Test
    public void testSetDefaultAddress_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        Long addressId = 2L;
        when(addressService.setDefaultAddress(eq(addressId), eq(userId))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/address/setDefault")
                .param("userId", userId.toString())
                .param("addressId", addressId.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("è®¾ç½®é»˜è®¤åœ°å€å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).setDefaultAddress(addressId, userId);
    }

    @Test
    public void testGetDefaultAddress_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        Address address = new Address();
        address.setId(2L);
        address.setUserId(userId);
        address.setDetailAddress("é»˜è®¤åœ°å€");
        
        when(addressService.getDefaultAddress(userId)).thenReturn(address);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/address/default/{userId}", userId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.detailAddress").value("é»˜è®¤åœ°å€"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).getDefaultAddress(userId);
    }

    @Test
    public void testGetDefaultAddress_NotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        when(addressService.getDefaultAddress(userId)).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/address/default/{userId}", userId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("é»˜è®¤åœ°å€ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(addressService).getDefaultAddress(userId);
    }
}
package com.heikeji.mall.user.controller;

import com.heikeji.mall.common.response.R;
import com.heikeji.mall.user.entity.User;
import com.heikeji.mall.user.entity.UserAuth;
import com.heikeji.mall.user.service.UserService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.math.BigDecimal;
import java.util.Optional;

import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * UserControllerå•å…ƒæµ‹è¯•
 */
@ExtendWith(MockitoExtension.class)
public class UserControllerTest {

    private MockMvc mockMvc;

    @Mock
    private UserService userService;

    @InjectMocks
    private UserController userController;

    @BeforeEach
    public void setup() {
        mockMvc = MockMvcBuilders.standaloneSetup(userController).build();
    }

    /**
     * åˆ›å»ºæµ‹è¯•ç”¨æˆ·æ•°æ®
     */
    private User createTestUser() {
        User user = new User();
        user.setId(1L);
        user.setStudentNo("2021001");
        user.setNickname("æµ‹è¯•ç”¨æˆ·");
        user.setAvatar("https://example.com/avatar.jpg");
        user.setPhone("13888888888");
        user.setSex((byte) 1);
        user.setStatus((byte) 0);
        user.setIsVerified((byte) 0);
        user.setBalance(new BigDecimal("100.00"));
        return user;
    }

    @Test
    public void testGetUserByPhone_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String phone = "13888888888";
        User user = createTestUser();
        user.setPhone(phone);
        when(userService.getUserByPhone(phone)).thenReturn(user);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/admin/getByPhone/{phone}", phone))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.phone").value(phone));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getUserByPhone(phone);
    }

    @Test
    public void testGetUserByPhone_UserNotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String phone = "13888888888";
        when(userService.getUserByPhone(phone)).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/admin/getByPhone/{phone}", phone))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(404))
                .andExpect(jsonPath("$.msg").value("ç”¨æˆ·ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getUserByPhone(phone);
    }

    @Test
    public void testGetUserByStudentNo_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String studentNo = "2021001";
        User user = createTestUser();
        user.setStudentNo(studentNo);
        
        when(userService.getUserByStudentNo(studentNo)).thenReturn(user);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/admin/getByStudentNo/{studentNo}", studentNo))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.studentNo").value(studentNo));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getUserByStudentNo(studentNo);
    }

    @Test
    public void testBindStudentNo_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        String studentNo = "2021001";
        when(userService.bindStudentNo(eq(userId), eq(studentNo))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/bindStudentNo")
                .param("userId", userId.toString())
                .param("studentNo", studentNo))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).bindStudentNo(userId, studentNo);
    }

    @Test
    public void testBindStudentNo_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        String studentNo = "2021001";
        when(userService.bindStudentNo(eq(userId), eq(studentNo))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/bindStudentNo")
                .param("userId", userId.toString())
                .param("studentNo", studentNo))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(409));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).bindStudentNo(userId, studentNo);
    }

    @Test
    public void testGetUserInfo_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        User user = createTestUser();
        when(userService.getById(userId)).thenReturn(user);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/info/{userId}", userId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.id").value(userId))
                .andExpect(jsonPath("$.data.nickname").value("æµ‹è¯•ç”¨æˆ·"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getById(userId);
    }

    @Test
    public void testGetUserInfo_UserNotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        when(userService.getById(userId)).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/info/{userId}", userId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(404))
                .andExpect(jsonPath("$.msg").value("ç”¨æˆ·ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getById(userId);
    }

    @Test
    public void testUpdateUserInfo_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        User user = new User();
        user.setId(userId);
        user.setNickname("updatedUser");
        
        when(userService.updateUserInfo(any(User.class))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/info/{userId}", userId)
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"id\":1,\"nickname\":\"updatedUser\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).updateUserInfo(any(User.class));
    }

    @Test
    public void testUpdateUserInfo_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        User user = new User();
        user.setId(userId);
        
        when(userService.updateUserInfo(any(User.class))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/info/{userId}", userId)
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"id\":1,\"nickname\":\"updatedUser\"}"))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).updateUserInfo(any(User.class));
    }

    @Test
    public void testGetBalance_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        User user = createTestUser();
        when(userService.getById(userId)).thenReturn(user);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/balance/{userId}", userId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(100.00));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getById(userId);
    }

    @Test
    public void testGetBalance_UserNotFound() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        when(userService.getById(userId)).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/balance/{userId}", userId))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(0));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getById(userId);
    }

    @Test
    public void testUpdateBalance_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("50.00");
        when(userService.updateBalance(eq(userId), eq(amount))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/updateBalance/{userId}", userId)
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).updateBalance(userId, amount);
    }

    @Test
    public void testUpdateBalance_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("50.00");
        when(userService.updateBalance(eq(userId), eq(amount))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/updateBalance/{userId}", userId)
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("ä½™é¢æ›´æ–°å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).updateBalance(userId, amount);
    }

    @Test
    public void testVerifyUser_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        String realName = "å¼ ä¸‰";
        String idCard = "123456789012345678";
        when(userService.verifyUser(eq(userId), eq(realName), eq(idCard))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/verify/{userId}", userId)
                .param("realName", realName)
                .param("idCard", idCard))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).verifyUser(userId, realName, idCard);
    }

    @Test
    public void testVerifyUser_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        String realName = "å¼ ä¸‰";
        String idCard = "123456789012345678";
        when(userService.verifyUser(eq(userId), eq(realName), eq(idCard))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/verify/{userId}", userId)
                .param("realName", realName)
                .param("idCard", idCard))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("éªŒè¯å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).verifyUser(userId, realName, idCard);
    }

    @Test
    public void testDeductBalance_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("50.00");
        when(userService.deductBalance(eq(userId), eq(amount))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/balance/deduct/{userId}", userId)
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).deductBalance(userId, amount);
    }

    @Test
    public void testDeductBalance_InsufficientBalance() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("50.00");
        when(userService.deductBalance(eq(userId), eq(amount))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/balance/deduct/{userId}", userId)
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("ä½™é¢ä¸è¶³æˆ–ç”¨æˆ·ä¸å­˜åœ¨"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).deductBalance(userId, amount);
    }

    @Test
    public void testRechargeBalance_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("100.00");
        when(userService.rechargeBalance(eq(userId), eq(amount))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/balance/recharge/{userId}", userId)
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).rechargeBalance(userId, amount);
    }

    @Test
    public void testRechargeBalance_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("100.00");
        when(userService.rechargeBalance(eq(userId), eq(amount))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(put("/api/user/balance/recharge/{userId}", userId)
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("å……å€¼å¤±è´¥æˆ–ç”¨æˆ·ä¸å­˜åœ?));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).rechargeBalance(userId, amount);
    }

    @Test
    public void testCheckBalance_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("50.00");
        when(userService.checkBalance(eq(userId), eq(amount))).thenReturn(true);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/balance/check")
                .param("userId", userId.toString())
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(true));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).checkBalance(userId, amount);
    }

    @Test
    public void testCheckBalance_Insufficient() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        BigDecimal amount = new BigDecimal("50.00");
        when(userService.checkBalance(eq(userId), eq(amount))).thenReturn(false);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/balance/check")
                .param("userId", userId.toString())
                .param("amount", amount.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data").value(false));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).checkBalance(userId, amount);
    }

    /**
     * æµ‹è¯•å¾®ä¿¡ç™»å½•æˆåŠŸ
     */
    @Test
    public void testWechatLogin_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String code = "wx_auth_code_123";
        String userInfo = "{\"nickname\":\"å¾®ä¿¡ç”¨æˆ·\"}";
        UserAuth userAuth = new UserAuth();
        userAuth.setUserId(1L);
        userAuth.setToken("jwt_token_123");
        
        when(userService.wechatLogin(eq(code), eq(userInfo))).thenReturn(userAuth);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/wechatLogin")
                .param("code", code)
                .param("userInfo", userInfo))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.msg").value("ç™»å½•æˆåŠŸ"))
                .andExpect(jsonPath("$.data.userId").value(1L))
                .andExpect(jsonPath("$.data.token").value("jwt_token_123"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).wechatLogin(code, userInfo);
    }

    /**
     * æµ‹è¯•å¾®ä¿¡ç™»å½•å¤±è´¥
     */
    @Test
    public void testWechatLogin_Failure() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String code = "invalid_code";
        String userInfo = "{\"nickname\":\"å¾®ä¿¡ç”¨æˆ·\"}";
        
        when(userService.wechatLogin(eq(code), eq(userInfo))).thenReturn(null);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(post("/api/user/wechatLogin")
                .param("code", code)
                .param("userInfo", userInfo))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(500))
                .andExpect(jsonPath("$.msg").value("ç™»å½•å¤±è´¥"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).wechatLogin(code, userInfo);
    }

    /**
     * æµ‹è¯•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
     */
    @Test
    public void testGetCurrentUserInfo_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        User user = createTestUser();
        Long userId = 1L;
        when(userService.getById(userId)).thenReturn(user);
        
        // æ¨¡æ‹Ÿç”¨æˆ·ä¸Šä¸‹æ–?- æ¨¡æ‹Ÿç”¨æˆ·å·²ç™»å½?        // ç›´æ¥æ¨¡æ‹ŸUserContextHolderçš„getCurrentUserIdæ–¹æ³•
        com.heikeji.mall.common.auth.UserContextHolder.setContext(
            new com.heikeji.mall.common.auth.UserContext() {{
                setUserId(userId);
                setUserType("USER");
                setStatus((byte) 1); // 1è¡¨ç¤ºæ­£å¸¸çŠ¶æ€?            }}
        );

        try {
            // æ‰§è¡Œæµ‹è¯•
            mockMvc.perform(get("/api/user/me"))
                    .andExpect(status().isOk())
                    .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                    .andExpect(jsonPath("$.code").value(200))
                    .andExpect(jsonPath("$.msg").value("æŸ¥è¯¢æˆåŠŸ"))
                    .andExpect(jsonPath("$.data.id").value(1L))
                    .andExpect(jsonPath("$.data.nickname").value("æµ‹è¯•ç”¨æˆ·"));

            // éªŒè¯æ–¹æ³•è°ƒç”¨
            verify(userService).getById(userId);
        } finally {
            // æ¸…ç†ç”¨æˆ·ä¸Šä¸‹æ–?            com.heikeji.mall.common.auth.UserContextHolder.clearContext();
        }
    }

    /**
     * æµ‹è¯•è·å–ç”¨æˆ·è¯¦æƒ…
     */
    @Test
    public void testGetUserDetail_Success() throws Exception {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        Long userId = 1L;
        User user = createTestUser();
        when(userService.getById(userId)).thenReturn(user);

        // æ‰§è¡Œæµ‹è¯•
        mockMvc.perform(get("/api/user/detail")
                .param("userId", userId.toString()))
                .andExpect(status().isOk())
                .andExpect(content().contentType(MediaType.APPLICATION_JSON))
                .andExpect(jsonPath("$.code").value(200))
                .andExpect(jsonPath("$.data.id").value(userId))
                .andExpect(jsonPath("$.data.nickname").value("æµ‹è¯•ç”¨æˆ·"));

        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(userService).getById(userId);
    }
}
package com.heikeji.common.api;

import lombok.Data;

import java.io.Serializable;

/**
 * é€šç”¨å“åº”ç»“æœ
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
public class Result<T> implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * çŠ¶æ€ç 
     */
    private int code;

    /**
     * æ¶ˆæ¯
     */
    private String message;

    /**
     * æ•°æ®
     */
    private T data;

    /**
     * æˆåŠŸæ ‡å¿—
     */
    private boolean success;

    /**
     * æ—¶é—´æˆ?     */
    private long timestamp;

    public Result() {
        this.timestamp = System.currentTimeMillis();
    }

    /**
     * æˆåŠŸ
     */
    public static <T> Result<T> ok() {
        return ok(null);
    }

    /**
     * æˆåŠŸ
     */
    public static <T> Result<T> ok(T data) {
        Result<T> result = new Result<>();
        result.setCode(ResultCode.SUCCESS.getCode());
        result.setMessage(ResultCode.SUCCESS.getMessage());
        result.setData(data);
        result.setSuccess(true);
        return result;
    }

    /**
     * æˆåŠŸ
     */
    public static <T> Result<T> ok(String message) {
        return ok(null, message);
    }

    /**
     * æˆåŠŸ
     */
    public static <T> Result<T> ok(T data, String message) {
        Result<T> result = new Result<>();
        result.setCode(ResultCode.SUCCESS.getCode());
        result.setMessage(message);
        result.setData(data);
        result.setSuccess(true);
        return result;
    }

    /**
     * å¤±è´¥
     */
    public static <T> Result<T> failed() {
        return failed(ResultCode.FAILED);
    }

    /**
     * å¤±è´¥
     */
    public static <T> Result<T> failed(String message) {
        Result<T> result = new Result<>();
        result.setCode(ResultCode.FAILED.getCode());
        result.setMessage(message);
        result.setData(null);
        result.setSuccess(false);
        return result;
    }

    /**
     * å¤±è´¥
     */
    public static <T> Result<T> failed(ResultCode resultCode) {
        Result<T> result = new Result<>();
        result.setCode(resultCode.getCode());
        result.setMessage(resultCode.getMessage());
        result.setData(null);
        result.setSuccess(false);
        return result;
    }

    /**
     * å¤±è´¥
     */
    public static <T> Result<T> failed(ResultCode resultCode, String message) {
        Result<T> result = new Result<>();
        result.setCode(resultCode.getCode());
        result.setMessage(message);
        result.setData(null);
        result.setSuccess(false);
        return result;
    }

    /**
     * å‚æ•°é”™è¯¯
     */
    public static <T> Result<T> parameterFailed() {
        return failed(ResultCode.PARAM_ERROR);
    }

    /**
     * å‚æ•°é”™è¯¯
     */
    public static <T> Result<T> parameterFailed(String message) {
        return failed(ResultCode.PARAM_ERROR, message);
    }

    /**
     * æœªè®¤è¯?     */
    public static <T> Result<T> unauthorized() {
        return failed(ResultCode.UNAUTHORIZED);
    }

    /**
     * æœªæˆæ?     */
    public static <T> Result<T> forbidden() {
        return failed(ResultCode.FORBIDDEN);
    }

    /**
     * æ¥å£ä¸å­˜åœ?     */
    public static <T> Result<T> notFound() {
        return failed(ResultCode.NOT_FOUND);
    }
}
package com.heikeji.common.api;

/**
 * å“åº”ç»“æœç ? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public enum ResultCode {

    /**
     * æˆåŠŸ
     */
    SUCCESS(200, "æ“ä½œæˆåŠŸ"),
    
    /**
     * å¤±è´¥
     */
    FAILED(500, "æ“ä½œå¤±è´¥"),
    
    /**
     * æœªè®¤è¯?     */
    UNAUTHORIZED(401, "æœªè®¤è¯?),
    
    /**
     * æœªæˆæ?     */
    FORBIDDEN(403, "æœªæˆæ?),
    
    /**
     * æ¥å£ä¸å­˜åœ?     */
    NOT_FOUND(404, "æ¥å£ä¸å­˜åœ?),
    
    /**
     * è¯·æ±‚æ–¹æ³•é”™è¯¯
     */
    METHOD_NOT_ALLOWED(405, "è¯·æ±‚æ–¹æ³•é”™è¯¯"),
    
    /**
     * æœåŠ¡å™¨å†…éƒ¨é”™è¯?     */
    INTERNAL_SERVER_ERROR(500, "æœåŠ¡å™¨å†…éƒ¨é”™è¯?),
    
    /**
     * ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
     */
    USERNAME_PASSWORD_ERROR(10001, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"),
    
    /**
     * ç”¨æˆ·ä¸å­˜åœ?     */
    USER_NOT_EXIST(10002, "ç”¨æˆ·ä¸å­˜åœ?),
    
    /**
     * ç”¨æˆ·å·²å­˜åœ?     */
    USER_ALREADY_EXIST(10003, "ç”¨æˆ·å·²å­˜åœ?),
    
    /**
     * è§’è‰²ä¸å­˜åœ?     */
    ROLE_NOT_EXIST(10004, "è§’è‰²ä¸å­˜åœ?),
    
    /**
     * æƒé™ä¸å­˜åœ?     */
    PERMISSION_NOT_EXIST(10005, "æƒé™ä¸å­˜åœ?),
    
    /**
     * å‚æ•°é”™è¯¯
     */
    PARAM_ERROR(10006, "å‚æ•°é”™è¯¯"),
    
    /**
     * éªŒè¯ç é”™è¯?     */
    CAPTCHA_ERROR(10007, "éªŒè¯ç é”™è¯?),
    
    /**
     * éªŒè¯ç è¿‡æœ?     */
    CAPTCHA_EXPIRE(10008, "éªŒè¯ç è¿‡æœ?),
    
    /**
     * è´¦å·è¢«é”å®?     */
    ACCOUNT_LOCKED(10009, "è´¦å·è¢«é”å®?),
    
    /**
     * è´¦å·å·²è¿‡æœ?     */
    ACCOUNT_EXPIRED(10010, "è´¦å·å·²è¿‡æœ?),
    
    /**
     * å‡­è¯å·²è¿‡æœ?     */
    CREDENTIAL_EXPIRED(10011, "å‡­è¯å·²è¿‡æœ?),
    
    /**
     * è´¦å·å·²è¢«ç¦ç”¨
     */
    ACCOUNT_DISABLED(10012, "è´¦å·å·²è¢«ç¦ç”¨");
    
    private final int code;
    private final String message;
    
    ResultCode(int code, String message) {
        this.code = code;
        this.message = message;
    }
    
    public int getCode() {
        return code;
    }
    
    public String getMessage() {
        return message;
    }
}
package com.heikeji.system;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;
import org.springframework.context.annotation.ComponentScan;

/**
 * ç³»ç»Ÿç®¡ç†æ¨¡å—å¯åŠ¨ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
@ComponentScan(basePackages = {"com.heikeji"})
public class SystemApplication {
    public static void main(String[] args) {
        SpringApplication.run(SystemApplication.class, args);
    }
}
package com.heikeji.system.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

/**
 * è·¨åŸŸé…ç½®
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Configuration
public class CorsConfig {

    /**
     * è·¨åŸŸè¿‡æ»¤å™?     */
    @Bean
    public CorsFilter corsFilter() {
        // é…ç½®æº?        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        
        // è·¨åŸŸé…ç½®
        CorsConfiguration config = new CorsConfiguration();
        // å…è®¸æ‰€æœ‰åŸŸ
        config.addAllowedOrigin("*");
        // å…è®¸æ‰€æœ‰æ–¹æ³?        config.addAllowedMethod("*");
        // å…è®¸æ‰€æœ‰è¯·æ±‚å¤´
        config.addAllowedHeader("*");
        // å…è®¸å‡­è¯
        config.setAllowCredentials(true);
        // é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼?        config.setMaxAge(1800L);
        
        // æ³¨å†Œé…ç½®
        source.registerCorsConfiguration("/**", config);
        
        return new CorsFilter(source);
    }
}
package com.heikeji.system.config;

import feign.Logger;
import feign.Request;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.TimeUnit;

/**
 * Feignå®¢æˆ·ç«¯é…ç½? */
@Configuration
public class FeignConfig {

    /**
     * é…ç½®Feignæ—¥å¿—çº§åˆ«
     */
    @Bean
    Logger.Level feignLoggerLevel() {
        return Logger.Level.FULL;
    }

    /**
     * é…ç½®è¯·æ±‚è¶…æ—¶
     */
    @Bean
    public Request.Options options() {
        return new Request.Options(
                5, TimeUnit.SECONDS,  // è¿æ¥è¶…æ—¶æ—¶é—´
                30, TimeUnit.SECONDS,  // è¯»å–è¶…æ—¶æ—¶é—´
                true  // è·Ÿéšé‡å®šå?        );
    }
}
package com.heikeji.system.config;

import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.multipart.MultipartResolver;
import org.springframework.web.multipart.commons.CommonsMultipartResolver;

/**
 * æ–‡ä»¶ä¸Šä¼ é…ç½®
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Configuration
@ConfigurationProperties(prefix = "file.upload")
public class FileUploadConfig {

    /**
     * ä¸Šä¼ æ–‡ä»¶å­˜å‚¨è·¯å¾„
     */
    private String path = "/upload/files";

    /**
     * æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆMBï¼?     */
    private long maxFileSize = 10;

    /**
     * æœ€å¤§è¯·æ±‚å¤§å°ï¼ˆMBï¼?     */
    private long maxRequestSize = 50;

    /**
     * å…è®¸çš„æ–‡ä»¶ç±»å?     */
    private String allowedTypes = "jpg,png,gif,bmp,jpeg,doc,docx,xls,xlsx,ppt,pptx,pdf,zip,rar";

    /**
     * åˆ›å»ºMultipartResolver
     */
    @Bean(name = "multipartResolver")
    public MultipartResolver multipartResolver() {
        CommonsMultipartResolver resolver = new CommonsMultipartResolver();
        // è®¾ç½®é»˜è®¤ç¼–ç 
        resolver.setDefaultEncoding("UTF-8");
        // è®¾ç½®æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å°?        resolver.setMaxUploadSize(maxFileSize * 1024 * 1024);
        // è®¾ç½®æœ€å¤§è¯·æ±‚å¤§å°?        resolver.setMaxInMemorySize((int) (maxRequestSize * 1024 * 1024));
        return resolver;
    }

    public String getPath() {
        return path;
    }

    public void setPath(String path) {
        this.path = path;
    }

    public long getMaxFileSize() {
        return maxFileSize;
    }

    public void setMaxFileSize(long maxFileSize) {
        this.maxFileSize = maxFileSize;
    }

    public long getMaxRequestSize() {
        return maxRequestSize;
    }

    public void setMaxRequestSize(long maxRequestSize) {
        this.maxRequestSize = maxRequestSize;
    }

    public String getAllowedTypes() {
        return allowedTypes;
    }

    public void setAllowedTypes(String allowedTypes) {
        this.allowedTypes = allowedTypes;
    }

    /**
     * æ£€æŸ¥æ–‡ä»¶ç±»å‹æ˜¯å¦å…è®?     */
    public boolean isAllowedType(String fileName) {
        if (fileName == null || fileName.isEmpty()) {
            return false;
        }
        String extension = getFileExtension(fileName).toLowerCase();
        String[] allowed = allowedTypes.split(",");
        for (String type : allowed) {
            if (type.trim().equals(extension)) {
                return true;
            }
        }
        return false;
    }

    /**
     * è·å–æ–‡ä»¶æ‰©å±•å?     */
    private String getFileExtension(String fileName) {
        int lastDotIndex = fileName.lastIndexOf(".");
        if (lastDotIndex < 0) {
            return "";
        }
        return fileName.substring(lastDotIndex + 1);
    }
}
package com.heikeji.system.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * JWTé…ç½®ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
@Component
@ConfigurationProperties(prefix = "jwt")
public class JwtConfig {

    /**
     * JWTå¯†é’¥
     */
    private String secret;

    /**
     * è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼?     */
    private Long expiration;

    /**
     * è¯·æ±‚å¤´åç§?     */
    private String header;

    /**
     * å‰ç¼€
     */
    private String prefix;

    /**
     * è·å–å®Œæ•´çš„ä»¤ç‰Œå‰ç¼€
     */
    public String getTokenPrefix() {
        return prefix + " ";
    }
}
package com.heikeji.system.config;

import com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;
import com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * MyBatis-Plusé…ç½®
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Configuration
public class MyBatisPlusConfig {

    /**
     * åˆ†é¡µæ’ä»¶
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        // æ·»åŠ åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor());
        return interceptor;
    }
}
package com.heikeji.system.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.heikeji.system.filter.JwtAuthenticationFilter;
import com.heikeji.common.api.Result;
import com.heikeji.common.api.ResultCode;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.security.web.access.AccessDeniedHandler;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

/**
 * Spring Securityé…ç½®
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    @Autowired
    private UserDetailsService userDetailsService;

    @Autowired
    private ObjectMapper objectMapper;

    /**
     * å¯†ç ç¼–ç å™?     */
    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * è®¤è¯ç®¡ç†å™?     */
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    /**
     * è®¤è¯é…ç½®
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService)
            .passwordEncoder(passwordEncoder());
    }

    /**
     * å®‰å…¨é…ç½®
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            // å…³é—­CSRF
            .csrf().disable()
            // å…³é—­ä¼šè¯ç®¡ç†
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            // é…ç½®è¯·æ±‚æˆæƒ
            .authorizeRequests()
            // å…è®¸åŒ¿åè®¿é—®çš„æ¥å?            .antMatchers("/api/system/auth/**", 
                         "/api/system/captcha/**",
                         "/api/health/**",
                         "/swagger-ui/**",
                         "/v3/api-docs/**",
                         "/doc.html",
                         "/webjars/**").permitAll()
            // å…¶ä»–æ‰€æœ‰è¯·æ±‚éœ€è¦è®¤è¯?            .anyRequest().authenticated()
            .and()
            // é…ç½®å¼‚å¸¸å¤„ç†
            .exceptionHandling()
            // æœªè®¤è¯å¤„ç?            .authenticationEntryPoint(authenticationEntryPoint())
            // æœªæˆæƒå¤„ç?            .accessDeniedHandler(accessDeniedHandler());

        // æ·»åŠ JWTè¿‡æ»¤å™?        http.addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);
    }

    /**
     * æœªè®¤è¯å¤„ç?     */
    @Bean
    public AuthenticationEntryPoint authenticationEntryPoint() {
        return new AuthenticationEntryPoint() {
            @Override
            public void commence(HttpServletRequest request, HttpServletResponse response, 
                                AuthenticationException authException) throws IOException {
                response.setContentType("application/json;charset=UTF-8");
                PrintWriter out = response.getWriter();
                out.write(objectMapper.writeValueAsString(Result.failed(ResultCode.UNAUTHORIZED)));
                out.flush();
                out.close();
            }
        };
    }

    /**
     * æœªæˆæƒå¤„ç?     */
    @Bean
    public AccessDeniedHandler accessDeniedHandler() {
        return new AccessDeniedHandler() {
            @Override
            public void handle(HttpServletRequest request, HttpServletResponse response, 
                             org.springframework.security.access.AccessDeniedException accessDeniedException) throws IOException {
                response.setContentType("application/json;charset=UTF-8");
                PrintWriter out = response.getWriter();
                out.write(objectMapper.writeValueAsString(Result.failed(ResultCode.FORBIDDEN)));
                out.flush();
                out.close();
            }
        };
    }

    /**
     * JWTè®¤è¯è¿‡æ»¤å™?     */
    @Bean
    public JwtAuthenticationFilter jwtAuthenticationFilter() {
        return new JwtAuthenticationFilter();
    }
}
package com.heikeji.system.config;

// import springfox.documentation.service.Contact;
// import org.springframework.context.annotation.Bean;
// import org.springframework.context.annotation.Configuration;
// import springfox.documentation.swagger2.annotations.EnableSwagger2;
// import springfox.documentation.builders.ApiInfoBuilder;
// import springfox.documentation.builders.PathSelectors;
// import springfox.documentation.builders.RequestHandlerSelectors;
// import springfox.documentation.service.ApiInfo;
// import springfox.documentation.spi.DocumentationType;
// import springfox.documentation.spring.web.plugins.Docket;

/**
 * Swaggeré…ç½®ç±»ï¼ˆæš‚æ—¶ç¦ç”¨ï¼?
 * æ³¨é‡Šæ‰Swaggerç›¸å…³ä»£ç ä»¥é¿å…Spring Boot 2.7.14å…¼å®¹æ€§é—®é¢?
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
// @Configuration
// @EnableSwagger2
public class SwaggerConfig {

    /**
     * åˆ›å»ºAPIæ–‡æ¡£ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
     */
//    @Bean
    public Docket createRestApi() {
        return null; // æš‚æ—¶è¿”å›nullï¼Œé¿å…ä¾èµ–é—®é¢?
        /*
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(apiInfo())
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.heikeji.system.controller"))
                .paths(PathSelectors.any())
                .build();
        */
    }

    /**
     * APIæ–‡æ¡£ä¿¡æ¯ï¼ˆæš‚æ—¶ç¦ç”¨ï¼‰
     */
//    private ApiInfo apiInfo() {
//        return new ApiInfoBuilder()
//                .title("é»‘ç§‘æ˜“è´­ç³»ç»ŸæœåŠ¡API")
//                .description("é»‘ç§‘æ˜“è´­åå°ç®¡ç†ç³»ç»ŸæœåŠ¡æ¥å£æ–‡æ¡£")
//                .contact(new Contact("zhangkaiyuan", "http://heikeji.com", "admin@heikeji.com"))
//                .version("1.0.0")
//                .build();
//    }
}
package com.heikeji.system.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.socket.server.standard.ServerEndpointExporter;

/**
 * WebSocketé…ç½®
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Configuration
public class WebSocketConfig {

    /**
     * æ³¨å…¥ServerEndpointExporterï¼Œè‡ªåŠ¨æ³¨å†Œä½¿ç”¨äº†@ServerEndpointæ³¨è§£çš„Bean
     */
    @Bean
    public ServerEndpointExporter serverEndpointExporter() {
        return new ServerEndpointExporter();
    }
}
package com.heikeji.system.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.system.dto.LoginDTO;
import com.heikeji.system.dto.RegisterDTO;
import com.heikeji.system.entity.SysUser;
import com.heikeji.system.security.JwtTokenProvider;
import com.heikeji.system.service.SysUserService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.util.Assert;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

/**
 * è®¤è¯æ§åˆ¶å™? */
@Api(tags = "ç³»ç»Ÿè®¤è¯ç®¡ç†")
@RestController
@RequestMapping("/api/auth")
public class AuthController {

    @Autowired
    private AuthenticationManager authenticationManager;

    @Autowired
    private JwtTokenProvider jwtTokenProvider;

    @Autowired
    private SysUserService sysUserService;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @ApiOperation("ç”¨æˆ·ç™»å½•")
    @PostMapping("/login")
    public R<Map<String, Object>> login(@RequestBody LoginDTO loginDTO) {
        try {
            // éªŒè¯ç”¨æˆ·åå¯†ç ?            Authentication authentication = authenticationManager.authenticate(
                    new UsernamePasswordAuthenticationToken(loginDTO.getUsername(), loginDTO.getPassword())
            );

            // è®¾ç½®è®¤è¯ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
            SecurityContextHolder.getContext().setAuthentication(authentication);

            // ç”ŸæˆJWTä»¤ç‰Œ
            String token = jwtTokenProvider.generateToken(authentication);

            // è·å–ç”¨æˆ·ä¿¡æ¯
            SysUser user = sysUserService.getByUsername(loginDTO.getUsername());

            // æ„é€ è¿”å›ç»“æ?            Map<String, Object> result = new HashMap<>();
            result.put("token", token);
            result.put("user", user);
            
            return R.success(result);
        } catch (Exception e) {
            return R.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
    }

    @ApiOperation("ç”¨æˆ·æ³¨å†Œ")
    @PostMapping("/register")
    public R<Boolean> register(@RequestBody RegisterDTO registerDTO) {
        // éªŒè¯å‚æ•°
        Assert.hasText(registerDTO.getUsername(), "ç”¨æˆ·åä¸èƒ½ä¸ºç©?);
        Assert.hasText(registerDTO.getPassword(), "å¯†ç ä¸èƒ½ä¸ºç©º");
        Assert.isTrue(registerDTO.getPassword().equals(registerDTO.getConfirmPassword()), "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡?);

        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ?        if (sysUserService.getByUsername(registerDTO.getUsername()) != null) {
            return R.error("ç”¨æˆ·åå·²å­˜åœ¨");
        }

        // åˆ›å»ºç”¨æˆ·
        SysUser user = new SysUser();
        user.setUsername(registerDTO.getUsername());
        user.setPassword(passwordEncoder.encode(registerDTO.getPassword()));
        user.setPhone(registerDTO.getPhone());
        user.setEmail(registerDTO.getEmail());
        user.setStatus(0); // å¯ç”¨çŠ¶æ€?
        boolean saved = sysUserService.save(user);
        if (saved) {
            return R.success(true);
        } else {
            return R.error("æ³¨å†Œå¤±è´¥");
        }
    }

    @ApiOperation("ç”¨æˆ·ç™»å‡º")
    @PostMapping("/logout")
    public R<Boolean> logout() {
        // æ¸…é™¤è®¤è¯ä¿¡æ¯
        SecurityContextHolder.clearContext();
        return R.success(true);
    }

    @ApiOperation("è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯")
    @GetMapping("/currentUser")
    public R<SysUser> currentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return R.error(401, "æœªæˆæ?);
        }

        String username = authentication.getName();
        SysUser user = sysUserService.getByUsername(username);
        return R.success(user);
    }

    @ApiOperation("åˆ·æ–°ä»¤ç‰Œ")
    @PostMapping("/refresh")
    public R<Map<String, String>> refreshToken() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return R.error(401, "æœªæˆæ?);
        }

        String username = authentication.getName();
        String newToken = jwtTokenProvider.generateRefreshToken(username);

        Map<String, String> result = new HashMap<>();
        result.put("token", newToken);
        
        return R.success(result);
    }
}
package com.heikeji.system.controller;

import com.heikeji.common.core.domain.R;
import com.heikeji.system.feign.OrderFeignClient;
import com.heikeji.system.feign.ProductFeignClient;
import com.heikeji.system.feign.UserFeignClient;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.HashMap;
import java.util.Map;

/**
 * ç³»ç»Ÿä»ªè¡¨ç›˜æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/dashboard")
@Api(tags = "ç³»ç»Ÿä»ªè¡¨ç›?)
public class DashboardController {

    @Autowired
    private UserFeignClient userFeignClient;
    
    @Autowired
    private OrderFeignClient orderFeignClient;
    
    @Autowired
    private ProductFeignClient productFeignClient;

    /**
     * è·å–ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ?     */
    @GetMapping("/stats")
    @ApiOperation("è·å–ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ?)
    public R<Map<String, Object>> getDashboardStats() {
        Map<String, Object> stats = new HashMap<>();
        
        // è·å–ç”¨æˆ·ç»Ÿè®¡
        R<Integer> userCountResult = userFeignClient.getUserCount();
        if (userCountResult.isSuccess()) {
            stats.put("userCount", userCountResult.getData());
        }
        
        // è·å–è®¢å•ç»Ÿè®¡
        R<Map<String, Object>> orderStatsResult = orderFeignClient.getOrderStats();
        if (orderStatsResult.isSuccess()) {
            stats.putAll(orderStatsResult.getData());
        }
        
        return R.success(stats);
    }

    /**
     * ç³»ç»Ÿå¥åº·æ£€æŸ?     */
    @GetMapping("/health")
    @ApiOperation("ç³»ç»Ÿå¥åº·æ£€æŸ?)
    public R<String> healthCheck() {
        return R.success("System is running normally");
    }
}
package com.heikeji.system.controller;

import com.heikeji.common.api.Result;
import com.heikeji.system.config.FileUploadConfig;
import com.heikeji.system.exception.BusinessException;
import com.heikeji.system.utils.IdUtils;
import com.heikeji.system.utils.LogUtils;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

/**
 * æ–‡ä»¶ä¸Šä¼ æ§åˆ¶å™? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@RestController
@RequestMapping("/api/file")
@Api(tags = "æ–‡ä»¶ä¸Šä¼ ")
public class FileController {

    private static final Logger logger = LogUtils.getLogger(FileController.class);

    @Autowired
    private FileUploadConfig fileUploadConfig;

    /**
     * ä¸Šä¼ æ–‡ä»¶
     */
    @PostMapping("/upload")
    @ApiOperation("ä¸Šä¼ æ–‡ä»¶")
    public Result upload(@RequestParam("file") MultipartFile file) {
        if (file.isEmpty()) {
            throw new BusinessException("æ–‡ä»¶ä¸èƒ½ä¸ºç©º");
        }

        // è·å–æ–‡ä»¶å?        String originalFilename = file.getOriginalFilename();
        if (originalFilename == null) {
            throw new BusinessException("æ–‡ä»¶åä¸èƒ½ä¸ºç©?);
        }

        // æ£€æŸ¥æ–‡ä»¶ç±»å?        if (!fileUploadConfig.isAllowedType(originalFilename)) {
            throw new BusinessException("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œè¯·ä¸Šä¼ ï¼? + fileUploadConfig.getAllowedTypes());
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°?        if (file.getSize() > fileUploadConfig.getMaxFileSize() * 1024 * 1024) {
            throw new BusinessException("æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡" + fileUploadConfig.getMaxFileSize() + "MB");
        }

        // è·å–æ–‡ä»¶æ‰©å±•å?        String extension = getFileExtension(originalFilename);
        
        // ç”Ÿæˆæ–°æ–‡ä»¶å
        String newFilename = IdUtils.getRandomString(32) + "." + extension;
        
        // æŒ‰æ—¥æœŸåˆ›å»ºç›®å½?        String dateDir = new SimpleDateFormat("yyyyMMdd").format(new Date());
        String uploadPath = fileUploadConfig.getPath() + "/" + dateDir;
        
        // åˆ›å»ºç›®å½•
        File dir = new File(uploadPath);
        if (!dir.exists()) {
            dir.mkdirs();
        }

        // ä¿å­˜æ–‡ä»¶
        File dest = new File(uploadPath + "/" + newFilename);
        try {
            file.transferTo(dest);
            LogUtils.info(logger, "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: {}, ä¿å­˜è·¯å¾„: {}", originalFilename, dest.getAbsolutePath());
            
            // è¿”å›æ–‡ä»¶ä¿¡æ¯
            Map<String, Object> fileInfo = new HashMap<>();
            fileInfo.put("originalName", originalFilename);
            fileInfo.put("fileName", newFilename);
            fileInfo.put("filePath", "/upload/files/" + dateDir + "/" + newFilename);
            fileInfo.put("fileSize", file.getSize());
            fileInfo.put("fileType", extension);
            fileInfo.put("uploadTime", new Date());
            
            return Result.ok(fileInfo);
        } catch (IOException e) {
            LogUtils.error(logger, "æ–‡ä»¶ä¸Šä¼ å¤±è´¥: {}", e.getMessage());
            throw new BusinessException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥");
        }
    }

    /**
     * æ‰¹é‡ä¸Šä¼ æ–‡ä»¶
     */
    @PostMapping("/batchUpload")
    @ApiOperation("æ‰¹é‡ä¸Šä¼ æ–‡ä»¶")
    public Result batchUpload(@RequestParam("files") MultipartFile[] files) {
        if (files == null || files.length == 0) {
            throw new BusinessException("æ–‡ä»¶ä¸èƒ½ä¸ºç©º");
        }

        if (files.length > 10) {
            throw new BusinessException("ä¸€æ¬¡æœ€å¤šä¸Šä¼?0ä¸ªæ–‡ä»?);
        }

        // æ£€æŸ¥æ€»æ–‡ä»¶å¤§å°?        long totalSize = 0;
        for (MultipartFile file : files) {
            totalSize += file.getSize();
        }
        if (totalSize > fileUploadConfig.getMaxRequestSize() * 1024 * 1024) {
            throw new BusinessException("æ€»æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿? + fileUploadConfig.getMaxRequestSize() + "MB");
        }

        // é€ä¸ªä¸Šä¼ æ–‡ä»¶
        for (MultipartFile file : files) {
            upload(file);
        }

        return Result.ok("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œå…±ä¸Šä¼ " + files.length + "ä¸ªæ–‡ä»?);
    }

    /**
     * è·å–æ–‡ä»¶æ‰©å±•å?     */
    private String getFileExtension(String filename) {
        int lastDotIndex = filename.lastIndexOf(".");
        if (lastDotIndex < 0) {
            return "";
        }
        return filename.substring(lastDotIndex + 1).toLowerCase();
    }
}
package com.heikeji.system.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.heikeji.common.api.Result;
import com.heikeji.common.api.ResultCode;
import com.heikeji.system.entity.SysPermission;
import com.heikeji.system.service.SysPermissionService;
import com.heikeji.system.vo.PermissionQueryVO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * ç³»ç»Ÿæƒé™æ§åˆ¶å™? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Api(tags = "ç³»ç»Ÿæƒé™ç®¡ç†")
@RestController
@RequestMapping("/api/system/permission")
public class SysPermissionController {

    @Autowired
    private SysPermissionService sysPermissionService;

    @ApiOperation("è·å–æƒé™åˆ—è¡¨")
    @GetMapping("/list")
    public Result<IPage<SysPermission>> list(PermissionQueryVO queryVO) {
        IPage<SysPermission> page = sysPermissionService.page(queryVO);
        return Result.ok(page);
    }

    @ApiOperation("è·å–æ‰€æœ‰èœå•åˆ—è¡?)
    @GetMapping("/listAllMenus")
    public Result<List<SysPermission>> listAllMenus() {
        List<SysPermission> menus = sysPermissionService.listAllMenus();
        return Result.ok(menus);
    }

    @ApiOperation("è·å–æƒé™ä¿¡æ¯")
    @GetMapping("/{id}")
    public Result<SysPermission> get(@PathVariable Long id) {
        SysPermission permission = sysPermissionService.getById(id);
        if (permission == null) {
            return Result.failed(ResultCode.PERMISSION_NOT_EXIST);
        }
        return Result.ok(permission);
    }

    @ApiOperation("åˆ›å»ºæƒé™")
    @PostMapping
    public Result<Boolean> create(@RequestBody SysPermission permission) {
        // éªŒè¯æƒé™ç¼–ç å”¯ä¸€æ€?        if (!sysPermissionService.checkCodeUnique(permission.getCode(), null)) {
            return Result.failed("æƒé™ç¼–ç å·²å­˜åœ?);
        }
        
        boolean success = sysPermissionService.create(permission);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ›´æ–°æƒé™")
    @PutMapping
    public Result<Boolean> update(@RequestBody SysPermission permission) {
        // éªŒè¯æƒé™ç¼–ç å”¯ä¸€æ€?        if (!sysPermissionService.checkCodeUnique(permission.getCode(), permission.getId())) {
            return Result.failed("æƒé™ç¼–ç å·²å­˜åœ?);
        }
        
        boolean success = sysPermissionService.update(permission);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("åˆ é™¤æƒé™")
    @DeleteMapping("/{id}")
    public Result<Boolean> delete(@PathVariable Long id) {
        boolean success = sysPermissionService.delete(id);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ‰¹é‡åˆ é™¤æƒé™")
    @DeleteMapping("/batch")
    public Result<Boolean> deleteBatch(@RequestBody List<Long> ids) {
        boolean success = sysPermissionService.deleteBatch(ids);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ›´æ–°æƒé™çŠ¶æ€?)
    @PutMapping("/status")
    public Result<Boolean> updateStatus(@RequestParam Long id, @RequestParam Integer status) {
        boolean success = sysPermissionService.updateStatus(id, status);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ ¹æ®è§’è‰²IDè·å–æƒé™åˆ—è¡¨")
    @GetMapping("/listByRoleId")
    public Result<List<SysPermission>> listByRoleId(@RequestParam Long roleId) {
        List<SysPermission> permissions = sysPermissionService.listByRoleId(roleId);
        return Result.ok(permissions);
    }

    @ApiOperation("æ ¹æ®ç”¨æˆ·IDè·å–æƒé™åˆ—è¡¨")
    @GetMapping("/listByUserId")
    public Result<List<SysPermission>> listByUserId(@RequestParam Long userId) {
        List<SysPermission> permissions = sysPermissionService.listByUserId(userId);
        return Result.ok(permissions);
    }

    @ApiOperation("æ ¹æ®çˆ¶çº§æƒé™IDè·å–å­æƒé™åˆ—è¡?)
    @GetMapping("/listByParentId")
    public Result<List<SysPermission>> listByParentId(@RequestParam Long parentId) {
        List<SysPermission> permissions = sysPermissionService.listByParentId(parentId);
        return Result.ok(permissions);
    }

    @ApiOperation("è·å–èœå•æ ?)
    @GetMapping("/menuTree")
    public Result<List<SysPermission>> getMenuTree() {
        List<SysPermission> menus = sysPermissionService.listAllMenus();
        List<SysPermission> menuTree = sysPermissionService.buildMenuTree(menus);
        return Result.ok(menuTree);
    }

    @ApiOperation("æ ¹æ®ç”¨æˆ·IDè·å–èœå•æ ?)
    @GetMapping("/menuTreeByUserId")
    public Result<List<SysPermission>> getMenuTreeByUserId(@RequestParam Long userId) {
        List<SysPermission> menus = sysPermissionService.getMenusByUserId(userId);
        List<SysPermission> menuTree = sysPermissionService.buildMenuTree(menus);
        return Result.ok(menuTree);
    }

    @ApiOperation("æ£€æŸ¥æƒé™ç¼–ç å”¯ä¸€æ€?)
    @GetMapping("/checkCodeUnique")
    public Result<Boolean> checkCodeUnique(@RequestParam String permissionCode, @RequestParam(required = false) Long id) {
        boolean unique = sysPermissionService.checkCodeUnique(permissionCode, id);
        return Result.ok(unique);
    }
}
package com.heikeji.system.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.heikeji.common.api.Result;
import com.heikeji.common.api.ResultCode;
import com.heikeji.system.entity.SysRole;
import com.heikeji.system.service.SysRoleService;
import com.heikeji.system.vo.RoleQueryVO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * ç³»ç»Ÿè§’è‰²æ§åˆ¶å™? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Api(tags = "ç³»ç»Ÿè§’è‰²ç®¡ç†")
@RestController
@RequestMapping("/api/system/role")
public class SysRoleController {

    @Autowired
    private SysRoleService sysRoleService;

    @ApiOperation("è·å–è§’è‰²åˆ—è¡¨")
    @GetMapping("/list")
    public Result<IPage<SysRole>> list(RoleQueryVO queryVO) {
        IPage<SysRole> page = sysRoleService.page(queryVO);
        return Result.ok(page);
    }

    @ApiOperation("è·å–æ‰€æœ‰å¯ç”¨çš„è§’è‰²åˆ—è¡¨")
    @GetMapping("/listAllEnabled")
    public Result<List<SysRole>> listAllEnabled() {
        List<SysRole> roles = sysRoleService.listAllEnabled();
        return Result.ok(roles);
    }

    @ApiOperation("è·å–è§’è‰²ä¿¡æ¯")
    @GetMapping("/{id}")
    public Result<SysRole> get(@PathVariable Long id) {
        SysRole role = sysRoleService.getById(id);
        if (role == null) {
            return Result.failed(ResultCode.ROLE_NOT_EXIST);
        }
        return Result.ok(role);
    }

    @ApiOperation("åˆ›å»ºè§’è‰²")
    @PostMapping
    public Result<Boolean> create(@RequestBody SysRole role) {
        // éªŒè¯è§’è‰²åç§°å”¯ä¸€æ€?        if (!sysRoleService.checkRoleNameUnique(role.getRoleName(), null)) {
            return Result.failed("è§’è‰²åç§°å·²å­˜åœ?);
        }
        
        // éªŒè¯è§’è‰²ç¼–ç å”¯ä¸€æ€?        if (!sysRoleService.checkRoleCodeUnique(role.getRoleCode(), null)) {
            return Result.failed("è§’è‰²ç¼–ç å·²å­˜åœ?);
        }
        
        boolean success = sysRoleService.create(role);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ›´æ–°è§’è‰²")
    @PutMapping
    public Result<Boolean> update(@RequestBody SysRole role) {
        // éªŒè¯è§’è‰²åç§°å”¯ä¸€æ€?        if (!sysRoleService.checkRoleNameUnique(role.getRoleName(), role.getId())) {
            return Result.failed("è§’è‰²åç§°å·²å­˜åœ?);
        }
        
        // éªŒè¯è§’è‰²ç¼–ç å”¯ä¸€æ€?        if (!sysRoleService.checkRoleCodeUnique(role.getRoleCode(), role.getId())) {
            return Result.failed("è§’è‰²ç¼–ç å·²å­˜åœ?);
        }
        
        boolean success = sysRoleService.update(role);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("åˆ é™¤è§’è‰²")
    @DeleteMapping("/{id}")
    public Result<Boolean> delete(@PathVariable Long id) {
        boolean success = sysRoleService.delete(id);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ‰¹é‡åˆ é™¤è§’è‰²")
    @DeleteMapping("/batch")
    public Result<Boolean> deleteBatch(@RequestBody List<Long> ids) {
        boolean success = sysRoleService.deleteBatch(ids);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ›´æ–°è§’è‰²çŠ¶æ€?)
    @PutMapping("/status")
    public Result<Boolean> updateStatus(@RequestParam Long id, @RequestParam Integer status) {
        boolean success = sysRoleService.updateStatus(id, status);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ ¹æ®ç”¨æˆ·IDè·å–è§’è‰²åˆ—è¡¨")
    @GetMapping("/listByUserId")
    public Result<List<SysRole>> listByUserId(@RequestParam Long userId) {
        List<SysRole> roles = sysRoleService.listByUserId(userId);
        return Result.ok(roles);
    }

    @ApiOperation("åˆ†é…æƒé™ç»™è§’è‰?)
    @PutMapping("/assignPermissions")
    public Result<Boolean> assignPermissions(@RequestParam Long roleId, @RequestBody List<Long> permissionIds) {
        boolean success = sysRoleService.assignPermissions(roleId, permissionIds);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("åˆ†é…è§’è‰²ç»™ç”¨æˆ?)
    @PutMapping("/assignRoles")
    public Result<Boolean> assignRoles(@RequestParam Long userId, @RequestBody List<Long> roleIds) {
        boolean success = sysRoleService.assignRoles(userId, roleIds);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("è·å–è§’è‰²æ‹¥æœ‰çš„æƒé™IDåˆ—è¡¨")
    @GetMapping("/getPermissionIds/{roleId}")
    public Result<List<Long>> getPermissionIds(@PathVariable Long roleId) {
        List<Long> permissionIds = sysRoleService.getPermissionIdsByRoleId(roleId);
        return Result.ok(permissionIds);
    }

    @ApiOperation("è·å–ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²IDåˆ—è¡¨")
    @GetMapping("/getRoleIds/{userId}")
    public Result<List<Long>> getRoleIds(@PathVariable Long userId) {
        List<Long> roleIds = sysRoleService.getRoleIdsByUserId(userId);
        return Result.ok(roleIds);
    }

    @ApiOperation("æ£€æŸ¥è§’è‰²åç§°å”¯ä¸€æ€?)
    @GetMapping("/checkRoleNameUnique")
    public Result<Boolean> checkRoleNameUnique(@RequestParam String roleName, @RequestParam(required = false) Long id) {
        boolean unique = sysRoleService.checkRoleNameUnique(roleName, id);
        return Result.ok(unique);
    }

    @ApiOperation("æ£€æŸ¥è§’è‰²ç¼–ç å”¯ä¸€æ€?)
    @GetMapping("/checkRoleCodeUnique")
    public Result<Boolean> checkRoleCodeUnique(@RequestParam String roleCode, @RequestParam(required = false) Long id) {
        boolean unique = sysRoleService.checkRoleCodeUnique(roleCode, id);
        return Result.ok(unique);
    }
}
package com.heikeji.system.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.heikeji.common.api.Result;
import com.heikeji.common.api.ResultCode;
import com.heikeji.system.entity.SysUser;
import com.heikeji.system.service.SysUserService;
import com.heikeji.system.vo.UserQueryVO;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * ç³»ç»Ÿç”¨æˆ·æ§åˆ¶å™? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Api(tags = "ç³»ç»Ÿç”¨æˆ·ç®¡ç†")
@RestController
@RequestMapping("/api/system/user")
public class SysUserController {

    @Autowired
    private SysUserService sysUserService;

    @ApiOperation("è·å–ç”¨æˆ·åˆ—è¡¨")
    @GetMapping("/list")
    public Result<IPage<SysUser>> list(UserQueryVO queryVO) {
        IPage<SysUser> page = sysUserService.page(queryVO);
        return Result.ok(page);
    }

    @ApiOperation("è·å–ç”¨æˆ·ä¿¡æ¯")
    @GetMapping("/{id}")
    public Result<SysUser> get(@PathVariable Long id) {
        SysUser user = sysUserService.getById(id);
        if (user == null) {
            return Result.failed(ResultCode.USER_NOT_EXIST);
        }
        return Result.ok(user);
    }

    @ApiOperation("åˆ›å»ºç”¨æˆ·")
    @PostMapping
    public Result<Boolean> create(@RequestBody SysUser user) {
        // éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€?        if (!sysUserService.checkUsernameUnique(user.getUsername(), null)) {
            return Result.failed("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // éªŒè¯æ‰‹æœºå·å”¯ä¸€æ€?        if (StringUtils.isNotBlank(user.getPhone()) && !sysUserService.checkPhoneUnique(user.getPhone(), null)) {
            return Result.failed("æ‰‹æœºå·å·²å­˜åœ¨");
        }
        
        // éªŒè¯é‚®ç®±å”¯ä¸€æ€?        if (StringUtils.isNotBlank(user.getEmail()) && !sysUserService.checkEmailUnique(user.getEmail(), null)) {
            return Result.failed("é‚®ç®±å·²å­˜åœ?);
        }
        
        boolean success = sysUserService.create(user);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ›´æ–°ç”¨æˆ·")
    @PutMapping
    public Result<Boolean> update(@RequestBody SysUser user) {
        // éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€?        if (!sysUserService.checkUsernameUnique(user.getUsername(), user.getId())) {
            return Result.failed("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // éªŒè¯æ‰‹æœºå·å”¯ä¸€æ€?        if (StringUtils.isNotBlank(user.getPhone()) && !sysUserService.checkPhoneUnique(user.getPhone(), user.getId())) {
            return Result.failed("æ‰‹æœºå·å·²å­˜åœ¨");
        }
        
        // éªŒè¯é‚®ç®±å”¯ä¸€æ€?        if (StringUtils.isNotBlank(user.getEmail()) && !sysUserService.checkEmailUnique(user.getEmail(), user.getId())) {
            return Result.failed("é‚®ç®±å·²å­˜åœ?);
        }
        
        boolean success = sysUserService.update(user);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("åˆ é™¤ç”¨æˆ·")
    @DeleteMapping("/{id}")
    public Result<Boolean> delete(@PathVariable Long id) {
        boolean success = sysUserService.delete(id);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ‰¹é‡åˆ é™¤ç”¨æˆ·")
    @DeleteMapping("/batch")
    public Result<Boolean> deleteBatch(@RequestBody List<Long> ids) {
        boolean success = sysUserService.deleteBatch(ids);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ›´æ–°ç”¨æˆ·çŠ¶æ€?)
    @PutMapping("/status")
    public Result<Boolean> updateStatus(@RequestParam Long id, @RequestParam Integer status) {
        boolean success = sysUserService.updateStatus(id, status);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("é‡ç½®å¯†ç ")
    @PutMapping("/resetPassword")
    public Result<Boolean> resetPassword(@RequestParam Long id, @RequestParam String password) {
        boolean success = sysUserService.resetPassword(id, password);
        return success ? Result.ok() : Result.failed();
    }

    @ApiOperation("æ ¹æ®è§’è‰²IDè·å–ç”¨æˆ·åˆ—è¡¨")
    @GetMapping("/listByRoleId")
    public Result<List<SysUser>> listByRoleId(@RequestParam Long roleId) {
        List<SysUser> users = sysUserService.listByRoleId(roleId);
        return Result.ok(users);
    }

    @ApiOperation("æ ¹æ®éƒ¨é—¨IDè·å–ç”¨æˆ·åˆ—è¡¨")
    @GetMapping("/listByDeptId")
    public Result<List<SysUser>> listByDeptId(@RequestParam Long deptId) {
        List<SysUser> users = sysUserService.listByDeptId(deptId);
        return Result.ok(users);
    }

    @ApiOperation("æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€?)
    @GetMapping("/checkUsernameUnique")
    public Result<Boolean> checkUsernameUnique(@RequestParam String username, @RequestParam(required = false) Long id) {
        boolean unique = sysUserService.checkUsernameUnique(username, id);
        return Result.ok(unique);
    }

    @ApiOperation("æ£€æŸ¥æ‰‹æœºå·å”¯ä¸€æ€?)
    @GetMapping("/checkPhoneUnique")
    public Result<Boolean> checkPhoneUnique(@RequestParam String phone, @RequestParam(required = false) Long id) {
        boolean unique = sysUserService.checkPhoneUnique(phone, id);
        return Result.ok(unique);
    }

    @ApiOperation("æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€?)
    @GetMapping("/checkEmailUnique")
    public Result<Boolean> checkEmailUnique(@RequestParam String email, @RequestParam(required = false) Long id) {
        boolean unique = sysUserService.checkEmailUnique(email, id);
        return Result.ok(unique);
    }
}
package com.heikeji.system.dto;

import lombok.Data;

/**
 * ç™»å½•è¯·æ±‚DTO
 */
@Data
public class LoginDTO {
    
    /**
     * ç”¨æˆ·å?     */
    private String username;
    
    /**
     * å¯†ç 
     */
    private String password;
    
    /**
     * éªŒè¯ç ?     */
    private String code;
    
    /**
     * éªŒè¯ç key
     */
    private String captchaKey;
}
package com.heikeji.system.dto;

import lombok.Data;

/**
 * æ³¨å†Œè¯·æ±‚DTO
 */
@Data
public class RegisterDTO {
    
    /**
     * ç”¨æˆ·å?     */
    private String username;
    
    /**
     * å¯†ç 
     */
    private String password;
    
    /**
     * ç¡®è®¤å¯†ç 
     */
    private String confirmPassword;
    
    /**
     * æ‰‹æœºå?     */
    private String phone;
    
    /**
     * é‚®ç®±
     */
    private String email;
    
    /**
     * éªŒè¯ç ?     */
    private String code;
}
package com.heikeji.system.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;
import java.util.List;

/**
 * ç³»ç»Ÿæƒé™å®ä½“ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
@TableName("sys_permission")
public class SysPermission implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * æƒé™ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * çˆ¶çº§æƒé™ID
     */
    private Long parentId;

    /**
     * æƒé™åç§°
     */
    private String name;

    /**
     * æƒé™ç¼–ç 
     */
    private String code;

    /**
     * èµ„æºç±»å‹ 1:èœå• 2:æŒ‰é’® 3:API
     */
    private Integer type;

    /**
     * è·¯å¾„
     */
    private String path;

    /**
     * ç»„ä»¶
     */
    private String component;

    /**
     * å›¾æ ‡
     */
    private String icon;

    /**
     * æ’åº
     */
    private Integer sort;

    /**
     * æ˜¯å¦å¯è§ 0:ä¸å¯è§?1:å¯è§
     */
    private Integer visible;

    /**
     * æ˜¯å¦ç¼“å­˜ 0:ä¸ç¼“å­?1:ç¼“å­˜
     */
    private Integer keepAlive;

    /**
     * çŠ¶æ€?0:ç¦ç”¨ 1:å¯ç”¨
     */
    private Integer status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;

    /**
     * åˆ›å»ºè€?     */
    @TableField(fill = FieldFill.INSERT)
    private String createBy;

    /**
     * æ›´æ–°è€?     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private String updateBy;

    /**
     * æ˜¯å¦åˆ é™¤ 0:æœªåˆ é™?1:å·²åˆ é™?     */
    @TableLogic
    private Integer deleted;
    
    /**
     * å­æƒé™åˆ—è¡¨ï¼ˆéæ•°æ®åº“å­—æ®µï¼?     */
    @TableField(exist = false)
    private List<SysPermission> children;
}
package com.heikeji.system.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * ç³»ç»Ÿè§’è‰²å®ä½“ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
@TableName("sys_role")
public class SysRole implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * è§’è‰²ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * è§’è‰²åç§°
     */
    private String roleName;

    /**
     * è§’è‰²ç¼–ç 
     */
    private String roleCode;

    /**
     * è§’è‰²æè¿°
     */
    private String description;

    /**
     * æ’åº
     */
    private Integer sort;

    /**
     * çŠ¶æ€?0:ç¦ç”¨ 1:å¯ç”¨
     */
    private Integer status;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;

    /**
     * åˆ›å»ºè€?     */
    @TableField(fill = FieldFill.INSERT)
    private String createBy;

    /**
     * æ›´æ–°è€?     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private String updateBy;

    /**
     * æ˜¯å¦åˆ é™¤ 0:æœªåˆ é™?1:å·²åˆ é™?     */
    @TableLogic
    private Integer deleted;
}
package com.heikeji.system.entity;

import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;

/**
 * è§’è‰²æƒé™å…³è”å®ä½“ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
@TableName("sys_role_permission")
public class SysRolePermission implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * è§’è‰²ID
     */
    private Long roleId;

    /**
     * æƒé™ID
     */
    private Long permissionId;
}
package com.heikeji.system.entity;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.util.Date;

/**
 * ç³»ç»Ÿç”¨æˆ·å®ä½“ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
@TableName("sys_user")
public class SysUser implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * ç”¨æˆ·ID
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * ç”¨æˆ·å?     */
    private String username;

    /**
     * å¯†ç 
     */
    private String password;

    /**
     * æ˜µç§°
     */
    private String nickname;

    /**
     * çœŸå®å§“å
     */
    private String realName;

    /**
     * æ‰‹æœºå·ç 
     */
    private String phone;

    /**
     * é‚®ç®±
     */
    private String email;

    /**
     * æ€§åˆ« 0:å¥?1:ç”?     */
    private Integer gender;

    /**
     * å¤´åƒ
     */
    private String avatar;

    /**
     * çŠ¶æ€?0:ç¦ç”¨ 1:å¯ç”¨
     */
    private Integer status;

    /**
     * éƒ¨é—¨ID
     */
    private Long deptId;

    /**
     * å²—ä½ID
     */
    private Long postId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;

    /**
     * åˆ›å»ºè€?     */
    @TableField(fill = FieldFill.INSERT)
    private String createBy;

    /**
     * æ›´æ–°è€?     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private String updateBy;

    /**
     * æ˜¯å¦åˆ é™¤ 0:æœªåˆ é™?1:å·²åˆ é™?     */
    @TableLogic
    private Integer deleted;

    /**
     * æœ€åç™»å½•æ—¶é—?     */
    private Date lastLoginTime;

    /**
     * å¤‡æ³¨
     */
    private String remark;
}
package com.heikeji.system.entity;

import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;
import java.io.Serializable;

/**
 * ç”¨æˆ·è§’è‰²å…³è”å®ä½“ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
@TableName("sys_user_role")
public class SysUserRole implements Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * ç”¨æˆ·ID
     */
    private Long userId;

    /**
     * è§’è‰²ID
     */
    private Long roleId;
}
package com.heikeji.system.exception;

import lombok.Getter;

/**
 * ä¸šåŠ¡å¼‚å¸¸ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Getter
public class BusinessException extends RuntimeException {

    /**
     * é”™è¯¯ç ?     */
    private final int code;

    /**
     * æ„é€ å‡½æ•?     *
     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }

    /**
     * æ„é€ å‡½æ•?     *
     * @param message é”™è¯¯æ¶ˆæ¯
     */
    public BusinessException(String message) {
        super(message);
        this.code = 500;
    }

    /**
     * æ„é€ å‡½æ•?     *
     * @param code é”™è¯¯ç ?     * @param message é”™è¯¯æ¶ˆæ¯
     * @param cause å¼‚å¸¸åŸå› 
     */
    public BusinessException(int code, String message, Throwable cause) {
        super(message, cause);
        this.code = code;
    }
}
package com.heikeji.system.feign;

import com.heikeji.common.core.domain.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.Map;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(name = "heikeji-order", fallback = OrderFeignClientFallback.class)
public interface OrderFeignClient {

    /**
     * è·å–è®¢å•ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/api/order/stats")
    R<Map<String, Object>> getOrderStats();

    /**
     * æ ¹æ®ç”¨æˆ·IDè·å–è®¢å•æ•°é‡
     */
    @GetMapping("/api/order/user/count")
    R<Integer> getUserOrderCount(@RequestParam("userId") Long userId);
}
package com.heikeji.system.feign;

import com.heikeji.common.core.domain.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.stereotype.Component;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.HashMap;
import java.util.Map;

/**
 * è®¢å•æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class OrderFeignClientFallback implements OrderFeignClient {

    @Override
    public R<Map<String, Object>> getOrderStats() {
        Map<String, Object> stats = new HashMap<>();
        stats.put("totalOrders", 0);
        stats.put("totalAmount", 0.0);
        stats.put("pendingOrders", 0);
        return R.success(stats);
    }

    @Override
    public R<Integer> getUserOrderCount(Long userId) {
        return R.success(0);
    }
}
package com.heikeji.system.feign;

import com.heikeji.common.core.domain.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(name = "heikeji-product", fallback = ProductFeignClientFallback.class)
public interface ProductFeignClient {

    /**
     * æ£€æŸ¥å•†å“æ˜¯å¦å­˜åœ?     */
    @GetMapping("/api/product/check")
    R<Boolean> checkProductExists(@RequestParam("productId") Long productId);

    /**
     * è·å–å•†å“åº“å­˜ä¿¡æ¯
     */
    @GetMapping("/api/product/stock")
    R<Integer> getProductStock(@RequestParam("productId") Long productId);
}
package com.heikeji.system.feign;

import com.heikeji.common.core.domain.R;
import org.springframework.stereotype.Component;

/**
 * å•†å“æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class ProductFeignClientFallback implements ProductFeignClient {

    @Override
    public R<Boolean> checkProductExists(Long productId) {
        return R.success(false);
    }

    @Override
    public R<Integer> getProductStock(Long productId) {
        return R.success(0);
    }
}
package com.heikeji.system.feign;

import com.heikeji.common.core.domain.R;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * ç”¨æˆ·æœåŠ¡Feignå®¢æˆ·ç«? */
@FeignClient(name = "heikeji-member", fallback = UserFeignClientFallback.class)
public interface UserFeignClient {

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ?     */
    @GetMapping("/api/member/check")
    R<Boolean> checkUserExists(@RequestParam("userId") Long userId);

    /**
     * è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/api/member/stats")
    R<Long> getUserStats();
    
    /**
     * è·å–ç”¨æˆ·æ€»æ•°
     */
    @GetMapping("/api/member/count")
    R<Integer> getUserCount();
}
package com.heikeji.system.feign;

import com.heikeji.common.core.domain.R;
import org.springframework.stereotype.Component;

/**
 * ç”¨æˆ·æœåŠ¡Feignå®¢æˆ·ç«¯é™çº§å®ç? */
@Component
public class UserFeignClientFallback implements UserFeignClient {

    @Override
    public R<Boolean> checkUserExists(Long userId) {
        return R.success(false);
    }

    @Override
    public R<Long> getUserStats() {
        return R.success(0L);
    }

    @Override
    public R<Integer> getUserCount() {
        return R.success(0);
    }
}
package com.heikeji.system.filter;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.heikeji.common.api.Result;
import com.heikeji.common.api.ResultCode;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.io.PrintWriter;

/**
 * è®¤è¯è¿‡æ»¤å™?- ç®€åŒ–ç‰ˆæœ? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Value("${jwt.header}")
    private String tokenHeader;

    @Value("${jwt.prefix}")
    private String tokenPrefix;

    @Autowired
    private UserDetailsService userDetailsService;

    @Autowired
    private ObjectMapper objectMapper;

    /**
     * ç”Ÿæˆç®€åŒ–ç‰ˆä»¤ç‰Œ
     */
    public String generateToken(String username) {
        // è¿”å›ä¸€ä¸ªç®€å•çš„tokenæ ¼å¼ï¼šusername:timestamp
        return username + ":" + System.currentTimeMillis();
    }

    /**
     * ä»ä»¤ç‰Œä¸­è·å–ç”¨æˆ·å?     */
    public String getUsernameFromToken(String token) {
        if (token != null && token.contains(":")) {
            return token.split(":")[0];
        }
        return null;
    }

    /**
     * éªŒè¯ä»¤ç‰Œ
     */
    public boolean validateToken(String token) {
        // ç®€åŒ–çš„éªŒè¯é€»è¾‘
        return token != null && token.contains(":");
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        try {
            // è·å–è¯·æ±‚å¤´ä¸­çš„ä»¤ç‰?            String token = getTokenFromRequest(request);

            // éªŒè¯ä»¤ç‰Œ
            if (token != null && validateToken(token)) {
                // ä»ä»¤ç‰Œä¸­è·å–ç”¨æˆ·å?                String username = getUsernameFromToken(token);

                // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);

                // åˆ›å»ºè®¤è¯å¯¹è±¡
                UsernamePasswordAuthenticationToken authentication = 
                        new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                // è®¾ç½®è®¤è¯ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception e) {
            // è®¤è¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ?            response.setCharacterEncoding("UTF-8");
            response.setContentType("application/json; charset=utf-8");
            PrintWriter out = response.getWriter();
            out.write(objectMapper.writeValueAsString(Result.failed(ResultCode.UNAUTHORIZED, "è®¤è¯å¤±è´¥")));
            out.flush();
            out.close();
            return;
        }

        // ç»§ç»­è¿‡æ»¤é“?        filterChain.doFilter(request, response);
    }

    /**
     * ä»è¯·æ±‚ä¸­è·å–ä»¤ç‰Œ
     */
    private String getTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader(tokenHeader);
        if (bearerToken != null && bearerToken.startsWith(tokenPrefix + " ")) {
            // ç§»é™¤å‰ç¼€ï¼Œè¿”å›å®é™…token
            return bearerToken.substring(tokenPrefix.length() + 1); // +1 æ˜¯ä¸ºäº†å»æ‰ç©ºæ ?        }
        return null;
    }
}
package com.heikeji.system.handler;

import com.heikeji.common.api.Result;
import com.heikeji.common.api.ResultCode;
import com.heikeji.system.exception.BusinessException;
import com.heikeji.system.utils.LogUtils;
import org.slf4j.Logger;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.core.AuthenticationException;

import jakarta.servlet.http.HttpServletRequest;
import java.util.stream.Collectors;

/**
 * å…¨å±€å¼‚å¸¸å¤„ç†
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@RestControllerAdvice
public class GlobalExceptionHandler {

    private static final Logger logger = LogUtils.getLogger(GlobalExceptionHandler.class);

    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸
     */
    @ExceptionHandler(AuthenticationException.class)
    public Result handleAuthenticationException(HttpServletRequest request, AuthenticationException e) {
        LogUtils.error(logger, "è®¤è¯å¼‚å¸¸: {}", e.getMessage());
        if (e instanceof BadCredentialsException) {
            return Result.failed(ResultCode.USERNAME_PASSWORD_ERROR);
        }
        return Result.failed(ResultCode.UNAUTHORIZED);
    }

    /**
     * å¤„ç†æˆæƒå¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    public Result handleAccessDeniedException(HttpServletRequest request, AccessDeniedException e) {
        LogUtils.error(logger, "æˆæƒå¼‚å¸¸: {}", e.getMessage());
        return Result.failed(ResultCode.FORBIDDEN);
    }

    /**
     * å¤„ç†å‚æ•°éªŒè¯å¼‚å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result handleMethodArgumentNotValidException(HttpServletRequest request, MethodArgumentNotValidException e) {
        String errorMsg = e.getBindingResult().getFieldErrors().stream()
                .map(fieldError -> fieldError.getField() + ": " + fieldError.getDefaultMessage())
                .collect(Collectors.joining(", "));
        LogUtils.error(logger, "å‚æ•°éªŒè¯å¼‚å¸¸: {}", errorMsg);
        return Result.parameterFailed(errorMsg);
    }

    /**
     * å¤„ç†ä¸šåŠ¡å¼‚å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public Result handleBusinessException(HttpServletRequest request, BusinessException e) {
        LogUtils.error(logger, "ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
        return Result.failed(e.getMessage());
    }

    /**
     * å¤„ç†å…¶ä»–å¼‚å¸¸
     */
    @ExceptionHandler(Exception.class)
    public Result handleException(HttpServletRequest request, Exception e) {
        LogUtils.error(logger, "ç³»ç»Ÿå¼‚å¸¸: {}", e.getMessage(), e);
        return Result.failed(ResultCode.INTERNAL_SERVER_ERROR);
    }
}
package com.heikeji.system.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.system.entity.SysPermission;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * ç³»ç»Ÿæƒé™Mapperæ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysPermissionMapper extends BaseMapper<SysPermission> {
    
    /**
     * æ ¹æ®æƒé™ç¼–ç æŸ¥è¯¢æƒé™
     *
     * @param code æƒé™ç¼–ç 
     * @return æƒé™ä¿¡æ¯
     */
    SysPermission selectByCode(@Param("code") String code);

    /**
     * åˆ†é¡µæŸ¥è¯¢æƒé™åˆ—è¡¨
     *
     * @param page åˆ†é¡µå¯¹è±¡
     * @param permission æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<SysPermission> selectPage(Page<SysPermission> page, @Param("permission") SysPermission permission);

    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢æƒé™åˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return æƒé™åˆ—è¡¨
     */
    List<SysPermission> selectByRoleId(@Param("roleId") Long roleId);

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢æƒé™åˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return æƒé™åˆ—è¡¨
     */
    List<SysPermission> selectByUserId(@Param("userId") Long userId);

    /**
     * æŸ¥è¯¢æ‰€æœ‰èœå•æƒé™?     *
     * @return èœå•åˆ—è¡¨
     */
    List<SysPermission> selectAllMenus();

    /**
     * æ ¹æ®çˆ¶IDæŸ¥è¯¢å­æƒé™åˆ—è¡?     *
     * @param parentId çˆ¶çº§æƒé™ID
     * @return å­æƒé™åˆ—è¡?     */
    List<SysPermission> selectByParentId(@Param("parentId") Long parentId);

    /**
     * æ‰¹é‡åˆ é™¤æƒé™
     *
     * @param ids æƒé™IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int deleteBatchIds(@Param("ids") List<Long> ids);

    /**
     * æ£€æŸ¥æƒé™ç¼–ç æ˜¯å¦å·²å­˜åœ¨
     *
     * @param code æƒé™ç¼–ç 
     * @param id æ’é™¤çš„æƒé™ID
     * @return æ•°é‡
     */
    int checkCodeUnique(@Param("code") String code, @Param("id") Long id);
}
package com.heikeji.system.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.system.entity.SysRole;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * ç³»ç»Ÿè§’è‰²Mapperæ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysRoleMapper extends BaseMapper<SysRole> {
    
    /**
     * æ ¹æ®è§’è‰²ç¼–ç æŸ¥è¯¢è§’è‰²
     *
     * @param roleCode è§’è‰²ç¼–ç 
     * @return è§’è‰²ä¿¡æ¯
     */
    SysRole selectByCode(@Param("roleCode") String roleCode);

    /**
     * åˆ†é¡µæŸ¥è¯¢è§’è‰²åˆ—è¡¨
     *
     * @param page åˆ†é¡µå¯¹è±¡
     * @param role æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<SysRole> selectPage(Page<SysRole> page, @Param("role") SysRole role);

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è§’è‰²åˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return è§’è‰²åˆ—è¡¨
     */
    List<SysRole> selectByUserId(@Param("userId") Long userId);

    /**
     * æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„è§’è‰²
     *
     * @return è§’è‰²åˆ—è¡¨
     */
    List<SysRole> selectAllEnabled();

    /**
     * æ‰¹é‡åˆ é™¤è§’è‰²
     *
     * @param ids è§’è‰²IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int deleteBatchIds(@Param("ids") List<Long> ids);

    /**
     * æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨
     *
     * @param roleName è§’è‰²åç§°
     * @param id æ’é™¤çš„è§’è‰²ID
     * @return æ•°é‡
     */
    int checkRoleNameUnique(@Param("roleName") String roleName, @Param("id") Long id);

    /**
     * æ£€æŸ¥è§’è‰²ç¼–ç æ˜¯å¦å·²å­˜åœ¨
     *
     * @param roleCode è§’è‰²ç¼–ç 
     * @param id æ’é™¤çš„è§’è‰²ID
     * @return æ•°é‡
     */
    int checkRoleCodeUnique(@Param("roleCode") String roleCode, @Param("id") Long id);
}
package com.heikeji.system.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.system.entity.SysRolePermission;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * è§’è‰²æƒé™å…³è”Mapperæ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysRolePermissionMapper extends BaseMapper<SysRolePermission> {
    
    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢æƒé™IDåˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return æƒé™IDåˆ—è¡¨
     */
    List<Long> selectPermissionIdsByRoleId(@Param("roleId") Long roleId);

    /**
     * æ ¹æ®æƒé™IDæŸ¥è¯¢è§’è‰²IDåˆ—è¡¨
     *
     * @param permissionId æƒé™ID
     * @return è§’è‰²IDåˆ—è¡¨
     */
    List<Long> selectRoleIdsByPermissionId(@Param("permissionId") Long permissionId);

    /**
     * æ‰¹é‡æ’å…¥è§’è‰²æƒé™å…³è”
     *
     * @param rolePermissionList è§’è‰²æƒé™åˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int insertBatch(@Param("list") List<SysRolePermission> rolePermissionList);

    /**
     * æ ¹æ®è§’è‰²IDåˆ é™¤è§’è‰²æƒé™å…³è”
     *
     * @param roleId è§’è‰²ID
     * @return å½±å“è¡Œæ•°
     */
    int deleteByRoleId(@Param("roleId") Long roleId);

    /**
     * æ ¹æ®æƒé™IDåˆ é™¤è§’è‰²æƒé™å…³è”
     *
     * @param permissionId æƒé™ID
     * @return å½±å“è¡Œæ•°
     */
    int deleteByPermissionId(@Param("permissionId") Long permissionId);

    /**
     * æ ¹æ®è§’è‰²IDå’Œæƒé™IDåˆ—è¡¨åˆ é™¤è§’è‰²æƒé™å…³è”
     *
     * @param roleId è§’è‰²ID
     * @param permissionIds æƒé™IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int deleteByRoleIdAndPermissionIds(@Param("roleId") Long roleId, @Param("permissionIds") List<Long> permissionIds);

    /**
     * æ£€æŸ¥è§’è‰²æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™?     *
     * @param roleId è§’è‰²ID
     * @param permissionId æƒé™ID
     * @return æ•°é‡
     */
    int checkRolePermission(@Param("roleId") Long roleId, @Param("permissionId") Long permissionId);
}
package com.heikeji.system.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.heikeji.system.entity.SysUser;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * ç³»ç»Ÿç”¨æˆ·Mapperæ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysUserMapper extends BaseMapper<SysUser> {
    
    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ?     *
     * @param username ç”¨æˆ·å?     * @return ç”¨æˆ·ä¿¡æ¯
     */
    SysUser selectByUsername(@Param("username") String username);

    /**
     * æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ?     *
     * @param phone æ‰‹æœºå?     * @return ç”¨æˆ·ä¿¡æ¯
     */
    SysUser selectByPhone(@Param("phone") String phone);

    /**
     * æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ·
     *
     * @param email é‚®ç®±
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    SysUser selectByEmail(@Param("email") String email);

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @param page åˆ†é¡µå¯¹è±¡
     * @param user æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<SysUser> selectPage(Page<SysUser> page, @Param("user") SysUser user);

    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    List<SysUser> selectByRoleId(@Param("roleId") Long roleId);

    /**
     * æ ¹æ®éƒ¨é—¨IDæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @param deptId éƒ¨é—¨ID
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    List<SysUser> selectByDeptId(@Param("deptId") Long deptId);

    /**
     * æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—?     *
     * @param id ç”¨æˆ·ID
     * @return å½±å“è¡Œæ•°
     */
    int updateLastLoginTime(@Param("id") Long id);

    /**
     * æ‰¹é‡åˆ é™¤ç”¨æˆ·
     *
     * @param ids ç”¨æˆ·IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int deleteBatchIds(@Param("ids") List<Long> ids);
}
package com.heikeji.system.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.heikeji.system.entity.SysUserRole;
import org.apache.ibatis.annotations.Param;

import java.util.List;

/**
 * ç”¨æˆ·è§’è‰²å…³è”Mapperæ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysUserRoleMapper extends BaseMapper<SysUserRole> {
    
    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è§’è‰²IDåˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return è§’è‰²IDåˆ—è¡¨
     */
    List<Long> selectRoleIdsByUserId(@Param("userId") Long userId);

    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢ç”¨æˆ·IDåˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return ç”¨æˆ·IDåˆ—è¡¨
     */
    List<Long> selectUserIdsByRoleId(@Param("roleId") Long roleId);

    /**
     * æ‰¹é‡æ’å…¥ç”¨æˆ·è§’è‰²å…³è”
     *
     * @param userRoleList ç”¨æˆ·è§’è‰²åˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int insertBatch(@Param("list") List<SysUserRole> userRoleList);

    /**
     * æ ¹æ®ç”¨æˆ·IDåˆ é™¤ç”¨æˆ·è§’è‰²å…³è”
     *
     * @param userId ç”¨æˆ·ID
     * @return å½±å“è¡Œæ•°
     */
    int deleteByUserId(@Param("userId") Long userId);

    /**
     * æ ¹æ®è§’è‰²IDåˆ é™¤ç”¨æˆ·è§’è‰²å…³è”
     *
     * @param roleId è§’è‰²ID
     * @return å½±å“è¡Œæ•°
     */
    int deleteByRoleId(@Param("roleId") Long roleId);

    /**
     * æ ¹æ®ç”¨æˆ·IDå’Œè§’è‰²IDåˆ—è¡¨åˆ é™¤ç”¨æˆ·è§’è‰²å…³è”
     *
     * @param userId ç”¨æˆ·ID
     * @param roleIds è§’è‰²IDåˆ—è¡¨
     * @return å½±å“è¡Œæ•°
     */
    int deleteByUserIdAndRoleIds(@Param("userId") Long userId, @Param("roleIds") List<Long> roleIds);

    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šè§’è‰?     *
     * @param userId ç”¨æˆ·ID
     * @param roleId è§’è‰²ID
     * @return æ•°é‡
     */
    int checkUserRole(@Param("userId") Long userId, @Param("roleId") Long roleId);
}
package com.heikeji.system.security;

import com.heikeji.system.entity.SysUser;
import com.heikeji.system.service.SysUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * JWTè®¤è¯è¿‡æ»¤å™? */
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtTokenProvider tokenProvider;

    @Autowired
    private SysUserService userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {
        try {
            // ä»è¯·æ±‚å¤´è·å–token
            String token = getJwtFromRequest(request);

            if (token != null && tokenProvider.validateToken(token)) {
                String username = tokenProvider.getUsernameFromJWT(token);

                // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                SysUser sysUser = userService.getByUsername(username);
                // å°†SysUserè½¬æ¢ä¸ºUserDetails
                UserDetails userDetails = new org.springframework.security.core.userdetails.User(
                        sysUser.getUsername(),
                        sysUser.getPassword(),
                        true, true, true, true,
                        org.springframework.security.core.authority.AuthorityUtils.createAuthorityList("ROLE_USER"));
                UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                        userDetails, null, userDetails.getAuthorities());
                authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                // è®¾ç½®è®¤è¯ä¿¡æ¯åˆ°ä¸Šä¸‹æ–‡
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception ex) {
            // è®¤è¯å¤±è´¥ï¼Œä¸è®¾ç½®è®¤è¯ä¿¡æ¯
        }

        filterChain.doFilter(request, response);
    }

    /**
     * ä»è¯·æ±‚å¤´è·å–JWTä»¤ç‰Œ
     */
    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
package com.heikeji.system.security;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import java.util.Date;

/**
 * JWTä»¤ç‰Œæä¾›å™?- ç®€åŒ–ç‰ˆæœ? */
@Component
public class JwtTokenProvider {

    @Value("${jwt.secret}")
    private String jwtSecret;

    @Value("${jwt.expiration}")
    private int jwtExpiration;

    /**
     * ç”Ÿæˆç®€åŒ–ç‰ˆJWTä»¤ç‰Œ
     */
    public String generateToken(Authentication authentication) {
        if (authentication != null && authentication.getPrincipal() instanceof UserDetails) {
            UserDetails userDetails = (UserDetails) authentication.getPrincipal();
            // è¿”å›ä¸€ä¸ªç®€å•çš„tokenæ ¼å¼ï¼šusername:timestamp
            return userDetails.getUsername() + ":" + System.currentTimeMillis();
        }
        return "";
    }

    /**
     * ä»ä»¤ç‰Œä¸­è·å–ç”¨æˆ·å?     */
    public String getUsernameFromJWT(String token) {
        if (token != null && token.contains(":")) {
            return token.split(":")[0];
        }
        return null;
    }

    /**
     * éªŒè¯ä»¤ç‰Œ
     */
    public boolean validateToken(String authToken) {
        // ç®€åŒ–çš„éªŒè¯é€»è¾‘
        return authToken != null && authToken.contains(":");
    }

    /**
     * ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ
     */
    public String generateRefreshToken(String username) {
        // è¿”å›ä¸€ä¸ªç®€å•çš„åˆ·æ–°token
        return username + ":refresh:" + System.currentTimeMillis();
    }
}
package com.heikeji.system.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * Spring Securityé…ç½®
 */
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeRequests()
            .antMatchers("/api/auth/login", "/api/auth/register", "/api/auth/refresh", "/api/dashboard/health").permitAll()
            .antMatchers("/swagger-ui/**", "/v2/api-docs/**", "/swagger-resources/**").permitAll()
            .anyRequest().authenticated();

        // æ·»åŠ JWTè¿‡æ»¤å™?        http.addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
package com.heikeji.system.security;

import com.heikeji.system.entity.SysUser;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.Collection;
import java.util.List;
import java.util.stream.Collectors;

/**
 * ç³»ç»Ÿç”¨æˆ·è¯¦æƒ…å®ç°
 */
public class SysUserDetails implements UserDetails {

    private SysUser user;
    private List<String> permissions;

    public SysUserDetails(SysUser user, List<String> permissions) {
        this.user = user;
        this.permissions = permissions;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return permissions.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());
    }

    @Override
    public String getPassword() {
        return user.getPassword();
    }

    @Override
    public String getUsername() {
        return user.getUsername();
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return user.getStatus() == 0; // 0è¡¨ç¤ºæ­£å¸¸
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return user.getStatus() == 0; // 0è¡¨ç¤ºå¯ç”¨
    }

    public SysUser getUser() {
        return user;
    }
}
package com.heikeji.system.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.system.entity.SysPermission;
import com.heikeji.system.vo.PermissionQueryVO;

import java.util.List;
import java.util.Set;

/**
 * ç³»ç»Ÿæƒé™æœåŠ¡æ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysPermissionService extends IService<SysPermission> {
    
    /**
     * æ ¹æ®æƒé™ç¼–ç æŸ¥è¯¢æƒé™
     *
     * @param code æƒé™ç¼–ç 
     * @return æƒé™ä¿¡æ¯
     */
    SysPermission getByCode(String code);

    /**
     * åˆ†é¡µæŸ¥è¯¢æƒé™åˆ—è¡¨
     *
     * @param queryVO æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<SysPermission> page(PermissionQueryVO queryVO);

    /**
     * åˆ›å»ºæƒé™
     *
     * @param permission æƒé™ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean create(SysPermission permission);

    /**
     * æ›´æ–°æƒé™
     *
     * @param permission æƒé™ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean update(SysPermission permission);

    /**
     * åˆ é™¤æƒé™
     *
     * @param id æƒé™ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean delete(Long id);

    /**
     * æ‰¹é‡åˆ é™¤æƒé™
     *
     * @param ids æƒé™IDåˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean deleteBatch(List<Long> ids);

    /**
     * ä¿®æ”¹æƒé™çŠ¶æ€?     *
     * @param id æƒé™ID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateStatus(Long id, Integer status);

    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢æƒé™åˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return æƒé™åˆ—è¡¨
     */
    List<SysPermission> listByRoleId(Long roleId);

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢æƒé™åˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return æƒé™åˆ—è¡¨
     */
    List<SysPermission> listByUserId(Long userId);

    /**
     * æŸ¥è¯¢æ‰€æœ‰èœå•æƒé™?     *
     * @return èœå•åˆ—è¡¨
     */
    List<SysPermission> listAllMenus();

    /**
     * æ ¹æ®çˆ¶IDæŸ¥è¯¢å­æƒé™åˆ—è¡?     *
     * @param parentId çˆ¶çº§æƒé™ID
     * @return å­æƒé™åˆ—è¡?     */
    List<SysPermission> listByParentId(Long parentId);

    /**
     * è·å–ç”¨æˆ·çš„æƒé™ç¼–ç åˆ—è¡?     *
     * @param userId ç”¨æˆ·ID
     * @return æƒé™ç¼–ç åˆ—è¡¨
     */
    Set<String> getPermissionCodesByUserId(Long userId);

    /**
     * è·å–ç”¨æˆ·çš„èœå•åˆ—è¡?     *
     * @param userId ç”¨æˆ·ID
     * @return èœå•åˆ—è¡¨
     */
    List<SysPermission> getMenusByUserId(Long userId);

    /**
     * æ„å»ºèœå•æ ?     *
     * @param permissions èœå•åˆ—è¡¨
     * @return èœå•æ ?     */
    List<SysPermission> buildMenuTree(List<SysPermission> permissions);

    /**
     * æ£€æŸ¥æƒé™ç¼–ç æ˜¯å¦å·²å­˜åœ¨
     *
     * @param code æƒé™ç¼–ç 
     * @param id æ’é™¤çš„æƒé™ID
     * @return æ˜¯å¦å­˜åœ¨
     */
    boolean checkCodeUnique(String code, Long id);

    /**
     * è·å–æƒé™çš„æ‰€æœ‰å­æƒé™ID
     *
     * @param permissionId æƒé™ID
     * @return å­æƒé™IDåˆ—è¡¨
     */
    List<Long> getAllChildPermissionIds(Long permissionId);
}
package com.heikeji.system.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.system.entity.SysRole;
import com.heikeji.system.vo.RoleQueryVO;

import java.util.List;

/**
 * ç³»ç»Ÿè§’è‰²æœåŠ¡æ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysRoleService extends IService<SysRole> {
    
    /**
     * æ ¹æ®è§’è‰²ç¼–ç æŸ¥è¯¢è§’è‰²
     *
     * @param roleCode è§’è‰²ç¼–ç 
     * @return è§’è‰²ä¿¡æ¯
     */
    SysRole getByCode(String roleCode);

    /**
     * åˆ†é¡µæŸ¥è¯¢è§’è‰²åˆ—è¡¨
     *
     * @param queryVO æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<SysRole> page(RoleQueryVO queryVO);

    /**
     * åˆ›å»ºè§’è‰²
     *
     * @param role è§’è‰²ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean create(SysRole role);

    /**
     * æ›´æ–°è§’è‰²
     *
     * @param role è§’è‰²ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean update(SysRole role);

    /**
     * åˆ é™¤è§’è‰²
     *
     * @param id è§’è‰²ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean delete(Long id);

    /**
     * æ‰¹é‡åˆ é™¤è§’è‰²
     *
     * @param ids è§’è‰²IDåˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean deleteBatch(List<Long> ids);

    /**
     * ä¿®æ”¹è§’è‰²çŠ¶æ€?     *
     * @param id è§’è‰²ID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateStatus(Long id, Integer status);

    /**
     * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è§’è‰²åˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return è§’è‰²åˆ—è¡¨
     */
    List<SysRole> listByUserId(Long userId);

    /**
     * æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„è§’è‰²
     *
     * @return è§’è‰²åˆ—è¡¨
     */
    List<SysRole> listAllEnabled();

    /**
     * ç»™è§’è‰²åˆ†é…æƒé™?     *
     * @param roleId è§’è‰²ID
     * @param permissionIds æƒé™IDåˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean assignPermissions(Long roleId, List<Long> permissionIds);

    /**
     * ç»™ç”¨æˆ·åˆ†é…è§’è‰?     *
     * @param userId ç”¨æˆ·ID
     * @param roleIds è§’è‰²IDåˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean assignRoles(Long userId, List<Long> roleIds);

    /**
     * è·å–è§’è‰²çš„æƒé™IDåˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return æƒé™IDåˆ—è¡¨
     */
    List<Long> getPermissionIdsByRoleId(Long roleId);

    /**
     * è·å–ç”¨æˆ·çš„è§’è‰²IDåˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return è§’è‰²IDåˆ—è¡¨
     */
    List<Long> getRoleIdsByUserId(Long userId);

    /**
     * æ£€æŸ¥è§’è‰²åç§°æ˜¯å¦å·²å­˜åœ¨
     *
     * @param roleName è§’è‰²åç§°
     * @param id æ’é™¤çš„è§’è‰²ID
     * @return æ˜¯å¦å­˜åœ¨
     */
    boolean checkRoleNameUnique(String roleName, Long id);

    /**
     * æ£€æŸ¥è§’è‰²ç¼–ç æ˜¯å¦å·²å­˜åœ¨
     *
     * @param roleCode è§’è‰²ç¼–ç 
     * @param id æ’é™¤çš„è§’è‰²ID
     * @return æ˜¯å¦å­˜åœ¨
     */
    boolean checkRoleCodeUnique(String roleCode, Long id);
}
package com.heikeji.system.service;

import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.heikeji.system.entity.SysUser;
import com.heikeji.system.vo.UserQueryVO;

import java.util.List;
import java.util.Set;

/**
 * ç³»ç»Ÿç”¨æˆ·æœåŠ¡æ¥å£
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public interface SysUserService extends IService<SysUser> {
    
    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ?     *
     * @param username ç”¨æˆ·å?     * @return ç”¨æˆ·ä¿¡æ¯
     */
    SysUser getByUsername(String username);

    /**
     * æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ?     *
     * @param phone æ‰‹æœºå?     * @return ç”¨æˆ·ä¿¡æ¯
     */
    SysUser getByPhone(String phone);

    /**
     * æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ·
     *
     * @param email é‚®ç®±
     * @return ç”¨æˆ·ä¿¡æ¯
     */
    SysUser getByEmail(String email);

    /**
     * åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @param queryVO æŸ¥è¯¢æ¡ä»¶
     * @return åˆ†é¡µç»“æœ
     */
    IPage<SysUser> page(UserQueryVO queryVO);

    /**
     * åˆ›å»ºç”¨æˆ·
     *
     * @param user ç”¨æˆ·ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean create(SysUser user);

    /**
     * æ›´æ–°ç”¨æˆ·
     *
     * @param user ç”¨æˆ·ä¿¡æ¯
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean update(SysUser user);

    /**
     * åˆ é™¤ç”¨æˆ·
     *
     * @param id ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean delete(Long id);

    /**
     * æ‰¹é‡åˆ é™¤ç”¨æˆ·
     *
     * @param ids ç”¨æˆ·IDåˆ—è¡¨
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean deleteBatch(List<Long> ids);

    /**
     * ä¿®æ”¹ç”¨æˆ·çŠ¶æ€?     *
     * @param id ç”¨æˆ·ID
     * @param status çŠ¶æ€?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateStatus(Long id, Integer status);

    /**
     * é‡ç½®å¯†ç 
     *
     * @param id ç”¨æˆ·ID
     * @param password æ–°å¯†ç ?     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean resetPassword(Long id, String password);

    /**
     * æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—?     *
     * @param id ç”¨æˆ·ID
     * @return æ˜¯å¦æˆåŠŸ
     */
    boolean updateLastLoginTime(Long id);

    /**
     * æ ¹æ®è§’è‰²IDæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @param roleId è§’è‰²ID
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    List<SysUser> listByRoleId(Long roleId);

    /**
     * æ ¹æ®éƒ¨é—¨IDæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
     *
     * @param deptId éƒ¨é—¨ID
     * @return ç”¨æˆ·åˆ—è¡¨
     */
    List<SysUser> listByDeptId(Long deptId);

    /**
     * è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return æƒé™ç¼–ç åˆ—è¡¨
     */
    Set<String> getPermissionsByUserId(Long userId);

    /**
     * è·å–ç”¨æˆ·è§’è‰²åˆ—è¡¨
     *
     * @param userId ç”¨æˆ·ID
     * @return è§’è‰²ç¼–ç åˆ—è¡¨
     */
    Set<String> getRolesByUserId(Long userId);

    /**
     * æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ?     *
     * @param username ç”¨æˆ·å?     * @param id æ’é™¤çš„ç”¨æˆ·ID
     * @return æ˜¯å¦å­˜åœ¨
     */
    boolean checkUsernameUnique(String username, Long id);

    /**
     * æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ?     *
     * @param phone æ‰‹æœºå?     * @param id æ’é™¤çš„ç”¨æˆ·ID
     * @return æ˜¯å¦å­˜åœ¨
     */
    boolean checkPhoneUnique(String phone, Long id);

    /**
     * æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
     *
     * @param email é‚®ç®±
     * @param id æ’é™¤çš„ç”¨æˆ·ID
     * @return æ˜¯å¦å­˜åœ¨
     */
    boolean checkEmailUnique(String email, Long id);
}
package com.heikeji.system.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.system.entity.SysPermission;
import com.heikeji.system.mapper.SysPermissionMapper;
import com.heikeji.system.mapper.SysRolePermissionMapper;
import com.heikeji.system.mapper.SysUserRoleMapper;
import com.heikeji.system.service.SysPermissionService;
import com.heikeji.system.vo.PermissionQueryVO;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

/**
 * ç³»ç»Ÿæƒé™æœåŠ¡å®ç°ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Service
public class SysPermissionServiceImpl extends ServiceImpl<SysPermissionMapper, SysPermission> implements SysPermissionService {

    @Autowired
    private SysPermissionMapper sysPermissionMapper;

    @Autowired
    private SysRolePermissionMapper sysRolePermissionMapper;

    @Autowired
    private SysUserRoleMapper sysUserRoleMapper;

    @Override
    public SysPermission getByCode(String permissionCode) {
        return sysPermissionMapper.selectByCode(permissionCode);
    }

    @Override
    public List<Long> getAllChildPermissionIds(Long permissionId) {
        List<Long> childIds = new ArrayList<>();
        List<SysPermission> children = sysPermissionMapper.selectByParentId(permissionId);
        if (children != null && !children.isEmpty()) {
            for (SysPermission child : children) {
                childIds.add(child.getId());
                // é€’å½’è·å–æ‰€æœ‰å­æƒé™ID
                childIds.addAll(getAllChildPermissionIds(child.getId()));
            }
        }
        return childIds;
    }

    @Override
    public IPage<SysPermission> page(PermissionQueryVO queryVO) {
        Page<SysPermission> page = new Page<>(queryVO.getPageNum(), queryVO.getPageSize());
        SysPermission permission = new SysPermission();
        if (StringUtils.isNotBlank(queryVO.getPermissionName())) {
            permission.setName(queryVO.getPermissionName());
        }
        if (StringUtils.isNotBlank(queryVO.getPermissionCode())) {
            permission.setCode(queryVO.getPermissionCode());
        }
        if (queryVO.getStatus() != null) {
            permission.setStatus(queryVO.getStatus());
        }
        if (queryVO.getType() != null) {
            permission.setType(queryVO.getType());
        }
        return sysPermissionMapper.selectPage(page, permission);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean create(SysPermission permission) {
        return this.save(permission);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean update(SysPermission permission) {
        return this.updateById(permission);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean delete(Long id) {
        // åˆ é™¤è§’è‰²æƒé™å…³è”
        sysRolePermissionMapper.deleteByPermissionId(id);
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å­æƒé™?        List<SysPermission> children = sysPermissionMapper.selectByParentId(id);
        if (children != null && !children.isEmpty()) {
            // é€’å½’åˆ é™¤å­æƒé™?            for (SysPermission child : children) {
                delete(child.getId());
            }
        }
        
        return this.removeById(id);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deleteBatch(List<Long> ids) {
        // æ‰¹é‡åˆ é™¤è§’è‰²æƒé™å…³è”
        for (Long id : ids) {
            sysRolePermissionMapper.deleteByPermissionId(id);
            
            // æ£€æŸ¥å¹¶åˆ é™¤å­æƒé™?            List<SysPermission> children = sysPermissionMapper.selectByParentId(id);
            if (children != null && !children.isEmpty()) {
                for (SysPermission child : children) {
                    delete(child.getId());
                }
            }
        }
        return this.removeByIds(ids);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateStatus(Long id, Integer status) {
        SysPermission permission = new SysPermission();
        permission.setId(id);
        permission.setStatus(status);
        return this.updateById(permission);
    }

    @Override
    public List<SysPermission> listByRoleId(Long roleId) {
        return sysPermissionMapper.selectByRoleId(roleId);
    }

    @Override
    public List<SysPermission> listByUserId(Long userId) {
        return sysPermissionMapper.selectByUserId(userId);
    }

    @Override
    public List<SysPermission> listAllMenus() {
        return sysPermissionMapper.selectAllMenus();
    }

    @Override
    public List<SysPermission> listByParentId(Long parentId) {
        return sysPermissionMapper.selectByParentId(parentId);
    }

    @Override
    public Set<String> getPermissionCodesByUserId(Long userId) {
        List<SysPermission> permissions = sysPermissionMapper.selectByUserId(userId);
        return permissions.stream()
                .map(SysPermission::getCode)
                .filter(StringUtils::isNotBlank)
                .collect(Collectors.toSet());
    }

    @Override
    public List<SysPermission> buildMenuTree(List<SysPermission> permissions) {
        List<SysPermission> menuTree = new ArrayList<>();
        
        // æ„å»ºæƒé™IDåˆ°æƒé™å¯¹è±¡çš„æ˜ å°„
        Map<Long, SysPermission> permissionMap = new HashMap<>();
        for (SysPermission permission : permissions) {
            permissionMap.put(permission.getId(), permission);
            // åˆå§‹åŒ–å­æƒé™åˆ—è¡¨
            permission.setChildren(new ArrayList<SysPermission>());
        }
        
        // æ„å»ºèœå•æ ?        for (SysPermission permission : permissions) {
            if (permission.getParentId() == 0L) {
                // æ ¹èŠ‚ç‚?                menuTree.add(permission);
            } else {
                // å­èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹ä¸?                SysPermission parent = permissionMap.get(permission.getParentId());
                if (parent != null) {
                    parent.getChildren().add(permission);
                }
            }
        }
        
        // å¯¹å­èŠ‚ç‚¹è¿›è¡Œæ’åº
        sortMenuTree(menuTree);
        
        return menuTree;
    }

    /**
     * å¯¹èœå•æ ‘è¿›è¡Œæ’åº
     */
    private void sortMenuTree(List<SysPermission> permissions) {
        if (permissions == null || permissions.isEmpty()) {
            return;
        }
        
        // å…ˆæŒ‰sortæ’åº
        permissions.sort(Comparator.comparing(SysPermission::getSort));
        
        // é€’å½’å¯¹å­èŠ‚ç‚¹è¿›è¡Œæ’åº
        for (SysPermission permission : permissions) {
            if (permission.getChildren() != null && !permission.getChildren().isEmpty()) {
                sortMenuTree(permission.getChildren());
            }
        }
    }

    @Override
    public List<SysPermission> getMenusByUserId(Long userId) {
        return sysPermissionMapper.selectByUserId(userId);
    }

    public List<SysPermission> getMenuTreeByUserId(Long userId) {
        List<SysPermission> permissions = sysPermissionMapper.selectByUserId(userId);
        // è¿‡æ»¤å‡ºèœå•ç±»å‹çš„æƒé™
        List<SysPermission> menus = permissions.stream()
                .filter(p -> p.getType() == 1 || p.getType() == 2) // èœå•æˆ–ç›®å½?                .filter(p -> p.getStatus() == 1) // å¯ç”¨çŠ¶æ€?                .collect(Collectors.toList());
        return buildMenuTree(menus);
    }

    @Override
    public boolean checkCodeUnique(String code, Long id) {
        return sysPermissionMapper.checkCodeUnique(code, id) == 0;
    }
}
package com.heikeji.system.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.system.entity.SysRole;
import com.heikeji.system.entity.SysUserRole;
import com.heikeji.system.entity.SysRolePermission;
import com.heikeji.system.mapper.SysRoleMapper;
import com.heikeji.system.mapper.SysUserRoleMapper;
import com.heikeji.system.mapper.SysRolePermissionMapper;
import com.heikeji.system.service.SysRoleService;
import com.heikeji.system.vo.RoleQueryVO;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

/**
 * ç³»ç»Ÿè§’è‰²æœåŠ¡å®ç°ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Service
public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> implements SysRoleService {

    @Autowired
    private SysRoleMapper sysRoleMapper;

    @Autowired
    private SysUserRoleMapper sysUserRoleMapper;

    @Autowired
    private SysRolePermissionMapper sysRolePermissionMapper;

    @Override
    public SysRole getByCode(String roleCode) {
        return sysRoleMapper.selectByCode(roleCode);
    }

    @Override
    public IPage<SysRole> page(RoleQueryVO queryVO) {
        Page<SysRole> page = new Page<>(queryVO.getPageNum(), queryVO.getPageSize());
        SysRole role = new SysRole();
        if (StringUtils.isNotBlank(queryVO.getRoleName())) {
            role.setRoleName(queryVO.getRoleName());
        }
        if (StringUtils.isNotBlank(queryVO.getRoleCode())) {
            role.setRoleCode(queryVO.getRoleCode());
        }
        if (queryVO.getStatus() != null) {
            role.setStatus(queryVO.getStatus());
        }
        return sysRoleMapper.selectPage(page, role);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean create(SysRole role) {
        return this.save(role);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean update(SysRole role) {
        return this.updateById(role);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean delete(Long id) {
        // åˆ é™¤è§’è‰²æƒé™å…³è”
        sysRolePermissionMapper.deleteByRoleId(id);
        // åˆ é™¤ç”¨æˆ·è§’è‰²å…³è”
        sysUserRoleMapper.deleteByRoleId(id);
        return this.removeById(id);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deleteBatch(List<Long> ids) {
        // æ‰¹é‡åˆ é™¤è§’è‰²æƒé™å…³è”
        for (Long id : ids) {
            sysRolePermissionMapper.deleteByRoleId(id);
            sysUserRoleMapper.deleteByRoleId(id);
        }
        return this.removeByIds(ids);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateStatus(Long id, Integer status) {
        SysRole role = new SysRole();
        role.setId(id);
        role.setStatus(status);
        return this.updateById(role);
    }

    @Override
    public List<SysRole> listByUserId(Long userId) {
        return sysRoleMapper.selectByUserId(userId);
    }

    @Override
    public List<SysRole> listAllEnabled() {
        return sysRoleMapper.selectAllEnabled();
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean assignPermissions(Long roleId, List<Long> permissionIds) {
        // å…ˆåˆ é™¤åŸæœ‰çš„æƒé™å…³è”
        sysRolePermissionMapper.deleteByRoleId(roleId);
        
        // æ‰¹é‡æ’å…¥æ–°çš„æƒé™å…³è”
        if (permissionIds != null && !permissionIds.isEmpty()) {
            List<SysRolePermission> rolePermissions = new ArrayList<>();
            for (Long permissionId : permissionIds) {
                SysRolePermission rolePermission = new SysRolePermission();
                rolePermission.setRoleId(roleId);
                rolePermission.setPermissionId(permissionId);
                rolePermissions.add(rolePermission);
            }
            sysRolePermissionMapper.insertBatch(rolePermissions);
        }
        return true;
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean assignRoles(Long userId, List<Long> roleIds) {
        // å…ˆåˆ é™¤åŸæœ‰çš„è§’è‰²å…³è”
        sysUserRoleMapper.deleteByUserId(userId);
        
        // æ‰¹é‡æ’å…¥æ–°çš„è§’è‰²å…³è”
        if (roleIds != null && !roleIds.isEmpty()) {
            List<SysUserRole> userRoles = new ArrayList<>();
            for (Long roleId : roleIds) {
                SysUserRole userRole = new SysUserRole();
                userRole.setUserId(userId);
                userRole.setRoleId(roleId);
                userRoles.add(userRole);
            }
            sysUserRoleMapper.insertBatch(userRoles);
        }
        return true;
    }

    @Override
    public List<Long> getPermissionIdsByRoleId(Long roleId) {
        return sysRolePermissionMapper.selectPermissionIdsByRoleId(roleId);
    }

    @Override
    public List<Long> getRoleIdsByUserId(Long userId) {
        return sysUserRoleMapper.selectRoleIdsByUserId(userId);
    }

    @Override
    public boolean checkRoleNameUnique(String roleName, Long id) {
        return sysRoleMapper.checkRoleNameUnique(roleName, id) == 0;
    }

    @Override
    public boolean checkRoleCodeUnique(String roleCode, Long id) {
        return sysRoleMapper.checkRoleCodeUnique(roleCode, id) == 0;
    }
}
package com.heikeji.system.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.heikeji.system.entity.SysUser;
import com.heikeji.system.mapper.SysUserMapper;
import com.heikeji.system.mapper.SysUserRoleMapper;
import com.heikeji.system.service.SysPermissionService;
import com.heikeji.system.service.SysRoleService;
import com.heikeji.system.service.SysUserService;
import com.heikeji.system.vo.UserQueryVO;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * ç³»ç»Ÿç”¨æˆ·æœåŠ¡å®ç°ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {

    @Autowired
    private SysUserMapper sysUserMapper;

    @Autowired
    private SysUserRoleMapper sysUserRoleMapper;

    @Autowired
    private SysRoleService sysRoleService;

    @Autowired
    private SysPermissionService sysPermissionService;

    @Autowired
    private BCryptPasswordEncoder passwordEncoder;

    @Override
    public SysUser getByUsername(String username) {
        return sysUserMapper.selectByUsername(username);
    }

    @Override
    public SysUser getByPhone(String phone) {
        return sysUserMapper.selectByPhone(phone);
    }

    @Override
    public SysUser getByEmail(String email) {
        return sysUserMapper.selectByEmail(email);
    }

    @Override
    public IPage<SysUser> page(UserQueryVO queryVO) {
        Page<SysUser> page = new Page<>(queryVO.getPageNum(), queryVO.getPageSize());
        SysUser user = new SysUser();
        if (StringUtils.isNotBlank(queryVO.getUsername())) {
            user.setUsername(queryVO.getUsername());
        }
        if (StringUtils.isNotBlank(queryVO.getNickname())) {
            user.setNickname(queryVO.getNickname());
        }
        if (StringUtils.isNotBlank(queryVO.getPhone())) {
            user.setPhone(queryVO.getPhone());
        }
        if (queryVO.getStatus() != null) {
            user.setStatus(queryVO.getStatus());
        }
        if (queryVO.getDeptId() != null) {
            user.setDeptId(queryVO.getDeptId());
        }
        return sysUserMapper.selectPage(page, user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean create(SysUser user) {
        // å¯†ç åŠ å¯†
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        return this.save(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean update(SysUser user) {
        return this.updateById(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean delete(Long id) {
        // åˆ é™¤ç”¨æˆ·è§’è‰²å…³è”
        sysUserRoleMapper.deleteByUserId(id);
        return this.removeById(id);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deleteBatch(List<Long> ids) {
        // æ‰¹é‡åˆ é™¤ç”¨æˆ·è§’è‰²å…³è”
        for (Long id : ids) {
            sysUserRoleMapper.deleteByUserId(id);
        }
        return this.removeByIds(ids);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateStatus(Long id, Integer status) {
        SysUser user = new SysUser();
        user.setId(id);
        user.setStatus(status);
        return this.updateById(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean resetPassword(Long id, String password) {
        SysUser user = new SysUser();
        user.setId(id);
        user.setPassword(passwordEncoder.encode(password));
        return this.updateById(user);
    }

    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateLastLoginTime(Long id) {
        return sysUserMapper.updateLastLoginTime(id) > 0;
    }

    @Override
    public List<SysUser> listByRoleId(Long roleId) {
        return sysUserMapper.selectByRoleId(roleId);
    }

    @Override
    public List<SysUser> listByDeptId(Long deptId) {
        return sysUserMapper.selectByDeptId(deptId);
    }

    @Override
    public Set<String> getPermissionsByUserId(Long userId) {
        return sysPermissionService.getPermissionCodesByUserId(userId);
    }

    @Override
    public Set<String> getRolesByUserId(Long userId) {
        List<Long> roleIds = sysUserRoleMapper.selectRoleIdsByUserId(userId);
        Set<String> roleCodes = new HashSet<>();
        for (Long roleId : roleIds) {
            SysUser user = this.getById(userId);
            if (user != null && user.getStatus() == 1) {
                // å¯ä»¥åœ¨è¿™é‡Œè·å–è§’è‰²ç¼–ç ç­‰ä¿¡æ¯
            }
        }
        return roleCodes;
    }

    @Override
    public boolean checkUsernameUnique(String username, Long id) {
        QueryWrapper<SysUser> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("username", username);
        if (id != null) {
            queryWrapper.ne("id", id);
        }
        return this.count(queryWrapper) == 0;
    }

    @Override
    public boolean checkPhoneUnique(String phone, Long id) {
        QueryWrapper<SysUser> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("phone", phone);
        if (id != null) {
            queryWrapper.ne("id", id);
        }
        return this.count(queryWrapper) == 0;
    }

    @Override
    public boolean checkEmailUnique(String email, Long id) {
        QueryWrapper<SysUser> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("email", email);
        if (id != null) {
            queryWrapper.ne("id", id);
        }
        return this.count(queryWrapper) == 0;
    }
}
package com.heikeji.system.service.impl;

import com.heikeji.system.entity.SysUser;
import com.heikeji.system.service.SysUserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Set;
import java.util.stream.Collectors;

/**
 * ç”¨æˆ·è®¤è¯æœåŠ¡å®ç°ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Service
public class UserDetailsServiceImpl implements UserDetailsService {

    @Autowired
    private SysUserService sysUserService;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ?        SysUser user = sysUserService.getByUsername(username);
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·åä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€?        if (user.getStatus() == 0) {
            throw new RuntimeException("è´¦å·å·²è¢«ç¦ç”¨");
        }
        
        // è·å–ç”¨æˆ·æƒé™
        Set<String> permissions = sysUserService.getPermissionsByUserId(user.getId());
        
        // è½¬æ¢ä¸ºSpring Securityçš„æƒé™æ ¼å¼?        Set<SimpleGrantedAuthority> authorities = permissions.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toSet());
        
        // æ›´æ–°æœ€åç™»å½•æ—¶é—?        sysUserService.updateLastLoginTime(user.getId());
        
        // è¿”å›UserDetailså¯¹è±¡
        return new User(user.getUsername(), user.getPassword(), authorities);
    }
}
package com.heikeji.system.utils;

import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.Base64;
import java.util.Random;

/**
 * éªŒè¯ç å·¥å…·ç±»
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public class CaptchaUtils {

    private static final int WIDTH = 120;
    private static final int HEIGHT = 40;
    private static final int CODE_LENGTH = 4;
    private static final int LINES_COUNT = 5;
    private static final String CHARACTERS = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789";
    private static final Random RANDOM = new Random();

    /**
     * ç”ŸæˆéªŒè¯ç ?     *
     * @return éªŒè¯ç å¯¹è±?     */
    public static Captcha generateCaptcha() {
        String code = generateCode();
        BufferedImage image = generateImage(code);
        String base64Image = encodeImageToBase64(image);
        return new Captcha(code, base64Image);
    }

    /**
     * ç”ŸæˆéªŒè¯ç å­—ç¬¦ä¸²
     */
    private static String generateCode() {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < CODE_LENGTH; i++) {
            int index = RANDOM.nextInt(CHARACTERS.length());
            sb.append(CHARACTERS.charAt(index));
        }
        return sb.toString();
    }

    /**
     * ç”ŸæˆéªŒè¯ç å›¾ç‰?     */
    private static BufferedImage generateImage(String code) {
        BufferedImage image = new BufferedImage(WIDTH, HEIGHT, BufferedImage.TYPE_INT_RGB);
        Graphics2D g = image.createGraphics();

        // è®¾ç½®èƒŒæ™¯è‰?        g.setColor(Color.WHITE);
        g.fillRect(0, 0, WIDTH, HEIGHT);

        // è®¾ç½®è¾¹æ¡†
        g.setColor(Color.LIGHT_GRAY);
        g.drawRect(0, 0, WIDTH - 1, HEIGHT - 1);

        // æ·»åŠ å¹²æ‰°çº?        for (int i = 0; i < LINES_COUNT; i++) {
            int x1 = RANDOM.nextInt(WIDTH);
            int y1 = RANDOM.nextInt(HEIGHT);
            int x2 = RANDOM.nextInt(WIDTH);
            int y2 = RANDOM.nextInt(HEIGHT);
            g.setColor(getRandomColor());
            g.drawLine(x1, y1, x2, y2);
        }

        // æ·»åŠ å™ªç‚¹
        for (int i = 0; i < WIDTH * HEIGHT / 10; i++) {
            int x = RANDOM.nextInt(WIDTH);
            int y = RANDOM.nextInt(HEIGHT);
            g.setColor(getRandomColor());
            g.fillRect(x, y, 1, 1);
        }

        // ç»˜åˆ¶éªŒè¯ç ?        g.setFont(new Font("Arial", Font.BOLD, 28));
        for (int i = 0; i < code.length(); i++) {
            g.setColor(getRandomColor());
            g.drawString(String.valueOf(code.charAt(i)), 25 * i + 10, 30);
        }

        g.dispose();
        return image;
    }

    /**
     * è·å–éšæœºé¢œè‰²
     */
    private static Color getRandomColor() {
        return new Color(RANDOM.nextInt(150), RANDOM.nextInt(150), RANDOM.nextInt(150));
    }

    /**
     * å°†å›¾ç‰‡è½¬æ¢ä¸ºBase64
     */
    private static String encodeImageToBase64(BufferedImage image) {
        try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            ImageIO.write(image, "png", baos);
            byte[] bytes = baos.toByteArray();
            return "data:image/png;base64," + Base64.getEncoder().encodeToString(bytes);
        } catch (IOException e) {
            throw new RuntimeException("ç”ŸæˆéªŒè¯ç å›¾ç‰‡å¤±è´?, e);
        }
    }

    /**
     * éªŒè¯ç å®ä½“ç±»
     */
    public static class Captcha {
        private String code;
        private String image;

        public Captcha(String code, String image) {
            this.code = code;
            this.image = image;
        }

        public String getCode() {
            return code;
        }

        public void setCode(String code) {
            this.code = code;
        }

        public String getImage() {
            return image;
        }

        public void setImage(String image) {
            this.image = image;
        }
    }

    /**
     * éªŒè¯éªŒè¯ç æ˜¯å¦æ­£ç¡?     *
     * @param inputCode ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç 
     * @param correctCode æ­£ç¡®çš„éªŒè¯ç 
     * @return æ˜¯å¦æ­£ç¡®
     */
    public static boolean validate(String inputCode, String correctCode) {
        if (inputCode == null || correctCode == null) {
            return false;
        }
        return inputCode.equalsIgnoreCase(correctCode);
    }
}
package com.heikeji.system.utils;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;

/**
 * æ—¥æœŸå·¥å…·ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public class DateUtils {

    /**
     * æ ¼å¼ï¼šyyyy-MM-dd HH:mm:ss
     */
    public static final String DATE_TIME_PATTERN = "yyyy-MM-dd HH:mm:ss";

    /**
     * æ ¼å¼ï¼šyyyy-MM-dd
     */
    public static final String DATE_PATTERN = "yyyy-MM-dd";

    /**
     * æ ¼å¼ï¼šHH:mm:ss
     */
    public static final String TIME_PATTERN = "HH:mm:ss";

    /**
     * æ ¼å¼ï¼šyyyyMMddHHmmssSSS
     */
    public static final String FULL_TIME_PATTERN = "yyyyMMddHHmmssSSS";

    /**
     * æ ¼å¼åŒ–å½“å‰æ—¶é—?     *
     * @param pattern æ ¼å¼
     */
    public static String formatNow(String pattern) {
        return format(new Date(), pattern);
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœ?     *
     * @param date    æ—¥æœŸ
     * @param pattern æ ¼å¼
     */
    public static String format(Date date, String pattern) {
        if (date == null) {
            return null;
        }
        SimpleDateFormat sdf = new SimpleDateFormat(pattern);
        return sdf.format(date);
    }

    /**
     * è§£ææ—¥æœŸ
     *
     * @param dateStr æ—¥æœŸå­—ç¬¦ä¸?     * @param pattern æ ¼å¼
     */
    public static Date parse(String dateStr, String pattern) {
        if (dateStr == null || dateStr.isEmpty()) {
            return null;
        }
        try {
            SimpleDateFormat sdf = new SimpleDateFormat(pattern);
            return sdf.parse(dateStr);
        } catch (Exception e) {
            return null;
        }
    }

    /**
     * è·å–ä»Šå¤©çš„å¼€å§‹æ—¶é—?     */
    public static Date getTodayStart() {
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, 0);
        calendar.set(Calendar.MINUTE, 0);
        calendar.set(Calendar.SECOND, 0);
        calendar.set(Calendar.MILLISECOND, 0);
        return calendar.getTime();
    }

    /**
     * è·å–ä»Šå¤©çš„ç»“æŸæ—¶é—?     */
    public static Date getTodayEnd() {
        Calendar calendar = Calendar.getInstance();
        calendar.set(Calendar.HOUR_OF_DAY, 23);
        calendar.set(Calendar.MINUTE, 59);
        calendar.set(Calendar.SECOND, 59);
        calendar.set(Calendar.MILLISECOND, 999);
        return calendar.getTime();
    }

    /**
     * å¢åŠ å¤©æ•°
     *
     * @param date æ—¥æœŸ
     * @param days å¤©æ•°
     */
    public static Date addDays(Date date, int days) {
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.add(Calendar.DAY_OF_MONTH, days);
        return calendar.getTime();
    }

    /**
     * å¢åŠ å°æ—¶
     *
     * @param date æ—¥æœŸ
     * @param hours å°æ—¶æ•?     */
    public static Date addHours(Date date, int hours) {
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(date);
        calendar.add(Calendar.HOUR_OF_DAY, hours);
        return calendar.getTime();
    }

    /**
     * è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å¤©æ•°å·®
     *
     * @param startDate å¼€å§‹æ—¥æœ?     * @param endDate ç»“æŸæ—¥æœŸ
     */
    public static long daysBetween(Date startDate, Date endDate) {
        long startTime = startDate.getTime();
        long endTime = endDate.getTime();
        return (endTime - startTime) / (1000 * 60 * 60 * 24);
    }
}
package com.heikeji.system.utils;

import java.util.Random;
import java.util.concurrent.atomic.AtomicLong;

/**
 * IDç”Ÿæˆå·¥å…·ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public class IdUtils {

    private static final AtomicLong ATOMIC_LONG = new AtomicLong(0);
    private static final Random RANDOM = new Random();

    /**
     * ç”Ÿæˆé€’å¢ID
     */
    public static long getId() {
        return ATOMIC_LONG.incrementAndGet();
    }

    /**
     * ç”Ÿæˆéšæœºæ•?     *
     * @param len é•¿åº¦
     */
    public static String getRandom(int len) {
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < len; i++) {
            sb.append(RANDOM.nextInt(10));
        }
        return sb.toString();
    }

    /**
     * ç”Ÿæˆéšæœºå­—ç¬¦ä¸?     *
     * @param len é•¿åº¦
     */
    public static String getRandomString(int len) {
        String base = "abcdefghijklmnopqrstuvwxyz0123456789";
        StringBuilder sb = new StringBuilder();
        for (int i = 0; i < len; i++) {
            int number = RANDOM.nextInt(base.length());
            sb.append(base.charAt(number));
        }
        return sb.toString();
    }

    /**
     * ç”Ÿæˆè®¢å•å?     */
    public static String generateOrderNo() {
        StringBuilder sb = new StringBuilder();
        sb.append(DateUtils.formatNow("yyyyMMddHHmmssSSS"));
        sb.append(getRandom(4));
        return sb.toString();
    }

    /**
     * ç”Ÿæˆå•†å“ç¼–å·
     */
    public static String generateProductNo() {
        StringBuilder sb = new StringBuilder("P");
        sb.append(DateUtils.formatNow("yyyyMMdd"));
        sb.append(getRandom(6));
        return sb.toString();
    }

    /**
     * ç”Ÿæˆä¼šå‘˜ç¼–å·
     */
    public static String generateMemberNo() {
        StringBuilder sb = new StringBuilder("M");
        sb.append(DateUtils.formatNow("yyyyMMdd"));
        sb.append(getRandom(6));
        return sb.toString();
    }
}
package com.heikeji.system.utils;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.databind.module.SimpleModule;
import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;
import com.fasterxml.jackson.datatype.jsr310.deser.LocalDateTimeDeserializer;
import com.fasterxml.jackson.datatype.jsr310.ser.LocalDateSerializer;
import com.fasterxml.jackson.datatype.jsr310.ser.LocalDateTimeSerializer;

import java.lang.reflect.Type;
import java.math.BigInteger;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Map;

/**
 * JSONå·¥å…·ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public class JsonUtils {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    static {
        // æ—¥æœŸæ—¶é—´åºåˆ—åŒ–é…ç½?        JavaTimeModule javaTimeModule = new JavaTimeModule();
        
        // LocalDateTimeåºåˆ—åŒ–å’Œååºåˆ—åŒ–
        javaTimeModule.addSerializer(LocalDateTime.class, new LocalDateTimeSerializer(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        javaTimeModule.addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        
        // LocalDateåºåˆ—åŒ–å’Œååºåˆ—åŒ–
        javaTimeModule.addSerializer(LocalDate.class, new LocalDateSerializer(DateTimeFormatter.ofPattern("yyyy-MM-dd")));
        javaTimeModule.addDeserializer(LocalDate.class, new LocalDateDeserializer(DateTimeFormatter.ofPattern("yyyy-MM-dd")));
        
        // Longç±»å‹åºåˆ—åŒ–ï¼Œè§£å†³å‰ç«¯JavaScriptå¤„ç†å¤§æ•´æ•°ç²¾åº¦ä¸¢å¤±é—®é¢?        javaTimeModule.addSerializer(Long.class, ToStringSerializer.instance);
        javaTimeModule.addSerializer(Long.TYPE, ToStringSerializer.instance);
        javaTimeModule.addSerializer(BigInteger.class, ToStringSerializer.instance);
        
        OBJECT_MAPPER.registerModule(javaTimeModule);
        
        // å¿½ç•¥æœªçŸ¥å±æ€?        OBJECT_MAPPER.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        
        // ç¦ç”¨æ—¥æœŸåºåˆ—åŒ–ä¸ºæ—¶é—´æˆ?        OBJECT_MAPPER.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);
        
        // ç¾åŒ–è¾“å‡º
        OBJECT_MAPPER.configure(SerializationFeature.INDENT_OUTPUT, false);
    }

    /**
     * å°†å¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸?     *
     * @param object å¯¹è±¡
     * @return JSONå­—ç¬¦ä¸?     */
    public static String toJson(Object object) {
        if (object == null) {
            return null;
        }
        try {
            return OBJECT_MAPPER.writeValueAsString(object);
        } catch (JsonProcessingException e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "JSONåºåˆ—åŒ–å¤±è´? {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†å¯¹è±¡è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„JSONå­—ç¬¦ä¸?     *
     * @param object å¯¹è±¡
     * @return æ ¼å¼åŒ–çš„JSONå­—ç¬¦ä¸?     */
    public static String toPrettyJson(Object object) {
        if (object == null) {
            return null;
        }
        try {
            return OBJECT_MAPPER.writerWithDefaultPrettyPrinter().writeValueAsString(object);
        } catch (JsonProcessingException e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "JSONåºåˆ—åŒ–å¤±è´? {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡
     *
     * @param json  JSONå­—ç¬¦ä¸?     * @param clazz ç›®æ ‡ç±?     * @param <T> æ³›å‹å‚æ•°
     * @return è½¬æ¢åçš„å¯¹è±¡
     */
    public static <T> T parseObject(String json, Class<T> clazz) {
        if (json == null || json.isEmpty()) {
            return null;
        }
        try {
            return OBJECT_MAPPER.readValue(json, clazz);
        } catch (JsonProcessingException e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "JSONååºåˆ—åŒ–å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡ï¼ˆæ”¯æŒå¤æ‚æ³›å‹ï¼‰
     *
     * @param json JSONå­—ç¬¦ä¸?     * @param type ç±»å‹
     * @param <T> æ³›å‹å‚æ•°
     * @return è½¬æ¢åçš„å¯¹è±¡
     */
    public static <T> T parseObject(String json, Type type) {
        if (json == null || json.isEmpty()) {
            return null;
        }
        try {
            return OBJECT_MAPPER.readValue(json, OBJECT_MAPPER.getTypeFactory().constructType(type));
        } catch (JsonProcessingException e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "JSONååºåˆ—åŒ–å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºList
     *
     * @param json  JSONå­—ç¬¦ä¸?     * @param clazz å…ƒç´ ç±?     * @param <T> æ³›å‹å‚æ•°
     * @return Listå¯¹è±¡
     */
    public static <T> List<T> parseArray(String json, Class<T> clazz) {
        if (json == null || json.isEmpty()) {
            return null;
        }
        try {
            return OBJECT_MAPPER.readValue(json, OBJECT_MAPPER.getTypeFactory().constructCollectionType(List.class, clazz));
        } catch (JsonProcessingException e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "JSONååºåˆ—åŒ–å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºMap
     *
     * @param json JSONå­—ç¬¦ä¸?     * @return Mapå¯¹è±¡
     */
    public static Map<String, Object> parseMap(String json) {
        if (json == null || json.isEmpty()) {
            return null;
        }
        try {
            return OBJECT_MAPPER.readValue(json, OBJECT_MAPPER.getTypeFactory().constructMapType(Map.class, String.class, Object.class));
        } catch (JsonProcessingException e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "JSONååºåˆ—åŒ–å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†å¯¹è±¡è½¬æ¢ä¸ºMap
     *
     * @param object å¯¹è±¡
     * @return Mapå¯¹è±¡
     */
    public static Map<String, Object> toMap(Object object) {
        if (object == null) {
            return null;
        }
        try {
            return OBJECT_MAPPER.convertValue(object, Map.class);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(JsonUtils.class), "å¯¹è±¡è½¬æ¢ä¸ºMapå¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * æ£€æŸ¥JSONå­—ç¬¦ä¸²æ˜¯å¦æœ‰æ•?     *
     * @param json JSONå­—ç¬¦ä¸?     * @return æ˜¯å¦æœ‰æ•ˆ
     */
    public static boolean isValid(String json) {
        if (json == null || json.isEmpty()) {
            return false;
        }
        try {
            OBJECT_MAPPER.readTree(json);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
package com.heikeji.system.utils;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * æ—¥å¿—å·¥å…·ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public class LogUtils {

    /**
     * è·å–æ—¥å¿—è®°å½•å™?     *
     * @param clazz ç±?     * @return æ—¥å¿—è®°å½•å™?     */
    public static Logger getLogger(Class<?> clazz) {
        return LoggerFactory.getLogger(clazz);
    }

    /**
     * è·å–æ—¥å¿—è®°å½•å™?     *
     * @param name åç§°
     * @return æ—¥å¿—è®°å½•å™?     */
    public static Logger getLogger(String name) {
        return LoggerFactory.getLogger(name);
    }

    /**
     * è®°å½•debugçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     */
    public static void debug(Logger logger, String message) {
        if (logger.isDebugEnabled()) {
            logger.debug(message);
        }
    }

    /**
     * è®°å½•debugçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     * @param args å‚æ•°
     */
    public static void debug(Logger logger, String message, Object... args) {
        if (logger.isDebugEnabled()) {
            logger.debug(message, args);
        }
    }

    /**
     * è®°å½•infoçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     */
    public static void info(Logger logger, String message) {
        if (logger.isInfoEnabled()) {
            logger.info(message);
        }
    }

    /**
     * è®°å½•infoçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     * @param args å‚æ•°
     */
    public static void info(Logger logger, String message, Object... args) {
        if (logger.isInfoEnabled()) {
            logger.info(message, args);
        }
    }

    /**
     * è®°å½•warnçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     */
    public static void warn(Logger logger, String message) {
        logger.warn(message);
    }

    /**
     * è®°å½•warnçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     * @param args å‚æ•°
     */
    public static void warn(Logger logger, String message, Object... args) {
        logger.warn(message, args);
    }

    /**
     * è®°å½•errorçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     */
    public static void error(Logger logger, String message) {
        logger.error(message);
    }

    /**
     * è®°å½•errorçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     * @param args å‚æ•°
     */
    public static void error(Logger logger, String message, Object... args) {
        logger.error(message, args);
    }

    /**
     * è®°å½•errorçº§åˆ«æ—¥å¿—
     *
     * @param logger æ—¥å¿—è®°å½•å™?     * @param message æ¶ˆæ¯
     * @param throwable å¼‚å¸¸
     */
    public static void error(Logger logger, String message, Throwable throwable) {
        logger.error(message, throwable);
    }
}
package com.heikeji.system.utils;

import com.heikeji.system.websocket.WebSocketServer;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Map;

/**
 * æ¶ˆæ¯å‘é€å·¥å…·ç±»
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Component
public class MessageUtils {

    /**
     * å‘é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
     *
     * @param userId ç”¨æˆ·ID
     * @param message æ¶ˆæ¯å†…å®¹
     * @return æ˜¯å¦å‘é€æˆåŠ?     */
    public boolean sendToUser(String userId, String message) {
        return WebSocketServer.sendToUser(userId, message);
    }

    /**
     * å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ?     *
     * @param message æ¶ˆæ¯å†…å®¹
     */
    public void sendToAll(String message) {
        WebSocketServer.sendToAll(message);
    }

    /**
     * å‘é€ç³»ç»Ÿé€šçŸ¥
     *
     * @param userId ç”¨æˆ·ID
     * @param title é€šçŸ¥æ ‡é¢˜
     * @param content é€šçŸ¥å†…å®¹
     * @return æ˜¯å¦å‘é€æˆåŠ?     */
    public boolean sendSystemNotice(String userId, String title, String content) {
        Map<String, Object> notice = new HashMap<>();
        notice.put("type", "system_notice");
        notice.put("title", title);
        notice.put("content", content);
        notice.put("timestamp", System.currentTimeMillis());
        
        String jsonMessage = JsonUtils.toJson(notice);
        return sendToUser(userId, jsonMessage);
    }

    /**
     * å‘é€ä¸šåŠ¡é€šçŸ¥
     *
     * @param userId ç”¨æˆ·ID
     * @param businessType ä¸šåŠ¡ç±»å‹
     * @param businessId ä¸šåŠ¡ID
     * @param title é€šçŸ¥æ ‡é¢˜
     * @param content é€šçŸ¥å†…å®¹
     * @return æ˜¯å¦å‘é€æˆåŠ?     */
    public boolean sendBusinessNotice(String userId, String businessType, String businessId, String title, String content) {
        Map<String, Object> notice = new HashMap<>();
        notice.put("type", "business_notice");
        notice.put("businessType", businessType);
        notice.put("businessId", businessId);
        notice.put("title", title);
        notice.put("content", content);
        notice.put("timestamp", System.currentTimeMillis());
        
        String jsonMessage = JsonUtils.toJson(notice);
        return sendToUser(userId, jsonMessage);
    }

    /**
     * å‘é€è®¢å•é€šçŸ¥
     *
     * @param userId ç”¨æˆ·ID
     * @param orderId è®¢å•ID
     * @param status è®¢å•çŠ¶æ€?     * @param message æ¶ˆæ¯å†…å®¹
     * @return æ˜¯å¦å‘é€æˆåŠ?     */
    public boolean sendOrderNotice(String userId, String orderId, String status, String message) {
        Map<String, Object> notice = new HashMap<>();
        notice.put("type", "order_notice");
        notice.put("orderId", orderId);
        notice.put("status", status);
        notice.put("message", message);
        notice.put("timestamp", System.currentTimeMillis());
        
        String jsonMessage = JsonUtils.toJson(notice);
        return sendToUser(userId, jsonMessage);
    }

    /**
     * å‘é€æ”¯ä»˜é€šçŸ¥
     *
     * @param userId ç”¨æˆ·ID
     * @param payId æ”¯ä»˜ID
     * @param status æ”¯ä»˜çŠ¶æ€?     * @param amount æ”¯ä»˜é‡‘é¢
     * @return æ˜¯å¦å‘é€æˆåŠ?     */
    public boolean sendPaymentNotice(String userId, String payId, String status, double amount) {
        Map<String, Object> notice = new HashMap<>();
        notice.put("type", "payment_notice");
        notice.put("payId", payId);
        notice.put("status", status);
        notice.put("amount", amount);
        notice.put("timestamp", System.currentTimeMillis());
        
        String jsonMessage = JsonUtils.toJson(notice);
        return sendToUser(userId, jsonMessage);
    }
}
package com.heikeji.system.utils;

import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

/**
 * å¯†ç åŠ å¯†å·¥å…·ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
public class PasswordUtils {

    private static final BCryptPasswordEncoder PASSWORD_ENCODER = new BCryptPasswordEncoder();

    /**
     * åŠ å¯†å¯†ç 
     *
     * @param rawPassword åŸå§‹å¯†ç 
     * @return åŠ å¯†åçš„å¯†ç 
     */
    public static String encode(String rawPassword) {
        return PASSWORD_ENCODER.encode(rawPassword);
    }

    /**
     * éªŒè¯å¯†ç 
     *
     * @param rawPassword     åŸå§‹å¯†ç 
     * @param encodedPassword åŠ å¯†åçš„å¯†ç 
     * @return æ˜¯å¦åŒ¹é…
     */
    public static boolean matches(String rawPassword, String encodedPassword) {
        return PASSWORD_ENCODER.matches(rawPassword, encodedPassword);
    }

    /**
     * ç”Ÿæˆé»˜è®¤å¯†ç 
     *
     * @return é»˜è®¤å¯†ç 
     */
    public static String getDefaultPassword() {
        return "123456";
    }

    /**
     * åŠ å¯†é»˜è®¤å¯†ç 
     *
     * @return åŠ å¯†åçš„é»˜è®¤å¯†ç 
     */
    public static String getEncodedDefaultPassword() {
        return encode(getDefaultPassword());
    }
}
package com.heikeji.system.utils;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;

import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.TimeUnit;

/**
 * Rediså·¥å…·ç±? *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Component
public class RedisUtils {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    /**
     * è®¾ç½®è¿‡æœŸæ—¶é—´
     */
    public boolean expire(String key, long time) {
        try {
            if (time > 0) {
                redisTemplate.expire(key, time, TimeUnit.SECONDS);
            }
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®è¿‡æœŸæ—¶é—´å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * è·å–è¿‡æœŸæ—¶é—´
     */
    public long getExpire(String key) {
        return redisTemplate.getExpire(key, TimeUnit.SECONDS);
    }

    /**
     * åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨
     */
    public boolean hasKey(String key) {
        try {
            return redisTemplate.hasKey(key);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "åˆ¤æ–­keyæ˜¯å¦å­˜åœ¨å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * åˆ é™¤ç¼“å­˜
     */
    @SuppressWarnings("unchecked")
    public void del(String... key) {
        if (key != null && key.length > 0) {
            if (key.length == 1) {
                redisTemplate.delete(key[0]);
            } else {
                // ä½¿ç”¨Arrays.asListè€Œä¸æ˜¯CollectionUtils.arrayToList
                redisTemplate.delete(Arrays.asList(key));
            }
        }
    }

    /**
     * åˆ é™¤ç¼“å­˜
     */
    public void del(Collection<String> keys) {
        redisTemplate.delete(keys);
    }

    /**
     * æ™®é€šç¼“å­˜è·å?     */
    public Object get(String key) {
        return key == null ? null : redisTemplate.opsForValue().get(key);
    }

    /**
     * æ™®é€šç¼“å­˜æ”¾å…?     */
    public boolean set(String key, Object value) {
        try {
            redisTemplate.opsForValue().set(key, value);
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®ç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * æ™®é€šç¼“å­˜æ”¾å…¥å¹¶è®¾ç½®æ—¶é—´
     */
    public boolean set(String key, Object value, long time) {
        try {
            if (time > 0) {
                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);
            } else {
                set(key, value);
            }
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®ç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * é€’å¢
     */
    public long incr(String key, long delta) {
        if (delta < 0) {
            throw new RuntimeException("é€’å¢å› å­å¿…é¡»å¤§äº0");
        }
        return redisTemplate.opsForValue().increment(key, delta);
    }

    /**
     * é€’å‡
     */
    public long decr(String key, long delta) {
        if (delta < 0) {
            throw new RuntimeException("é€’å‡å› å­å¿…é¡»å¤§äº0");
        }
        return redisTemplate.opsForValue().increment(key, -delta);
    }

    /**
     * HashGet
     */
    public Object hget(String key, String item) {
        return redisTemplate.opsForHash().get(key, item);
    }

    /**
     * è·å–hashKeyå¯¹åº”çš„æ‰€æœ‰é”®å€?     */
    public Map<Object, Object> hmget(String key) {
        return redisTemplate.opsForHash().entries(key);
    }

    /**
     * HashSet
     */
    public boolean hmset(String key, Map<String, Object> map) {
        try {
            redisTemplate.opsForHash().putAll(key, map);
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Hashç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * HashSet å¹¶è®¾ç½®æ—¶é—?     */
    public boolean hmset(String key, Map<String, Object> map, long time) {
        try {
            redisTemplate.opsForHash().putAll(key, map);
            if (time > 0) {
                expire(key, time);
            }
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Hashç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®,å¦‚æœä¸å­˜åœ¨å°†åˆ›å»º
     */
    public boolean hset(String key, String item, Object value) {
        try {
            redisTemplate.opsForHash().put(key, item, value);
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Hashç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * å‘ä¸€å¼ hashè¡¨ä¸­æ”¾å…¥æ•°æ®,å¦‚æœä¸å­˜åœ¨å°†åˆ›å»º
     */
    public boolean hset(String key, String item, Object value, long time) {
        try {
            redisTemplate.opsForHash().put(key, item, value);
            if (time > 0) {
                expire(key, time);
            }
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Hashç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * åˆ é™¤hashè¡¨ä¸­çš„å€?     */
    public void hdel(String key, Object... item) {
        redisTemplate.opsForHash().delete(key, item);
    }

    /**
     * åˆ¤æ–­hashè¡¨ä¸­æ˜¯å¦æœ‰è¯¥é¡¹çš„å€?     */
    public boolean hHasKey(String key, String item) {
        return redisTemplate.opsForHash().hasKey(key, item);
    }

    /**
     * hashé€’å¢ å¦‚æœä¸å­˜åœ?å°±ä¼šåˆ›å»ºä¸€ä¸?å¹¶æŠŠæ–°å¢åçš„å€¼è¿”å›?     */
    public double hincr(String key, String item, double delta) {
        return redisTemplate.opsForHash().increment(key, item, delta);
    }

    /**
     * hashé€’å‡
     */
    public double hdecr(String key, String item, double delta) {
        return redisTemplate.opsForHash().increment(key, item, -delta);
    }

    /**
     * æ ¹æ®keyè·å–Setä¸­çš„æ‰€æœ‰å€?     */
    public Set<Object> sGet(String key) {
        try {
            return redisTemplate.opsForSet().members(key);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è·å–Setç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * æ ¹æ®valueä»ä¸€ä¸ªsetä¸­æŸ¥è¯?æ˜¯å¦å­˜åœ¨
     */
    public boolean sHasKey(String key, Object value) {
        try {
            return redisTemplate.opsForSet().isMember(key, value);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "åˆ¤æ–­Setç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨å¤±è´? {}", e.getMessage());
            return false;
        }
    }

    /**
     * å°†æ•°æ®æ”¾å…¥setç¼“å­˜
     */
    public long sSet(String key, Object... values) {
        try {
            return redisTemplate.opsForSet().add(key, values);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Setç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return 0;
        }
    }

    /**
     * å°†setæ•°æ®æ”¾å…¥ç¼“å­˜
     */
    public long sSetAndTime(String key, long time, Object... values) {
        try {
            Long count = redisTemplate.opsForSet().add(key, values);
            if (time > 0) {
                expire(key, time);
            }
            return count;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Setç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return 0;
        }
    }

    /**
     * è·å–setç¼“å­˜çš„é•¿åº?     */
    public long sGetSetSize(String key) {
        try {
            return redisTemplate.opsForSet().size(key);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è·å–Setç¼“å­˜é•¿åº¦å¤±è´¥: {}", e.getMessage());
            return 0;
        }
    }

    /**
     * ç§»é™¤å€¼ä¸ºvalueçš?     */
    public long setRemove(String key, Object... values) {
        try {
            return redisTemplate.opsForSet().remove(key, values);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "ç§»é™¤Setç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return 0;
        }
    }

    /**
     * è·å–listç¼“å­˜çš„å†…å®?     */
    public List<Object> lGet(String key, long start, long end) {
        try {
            return redisTemplate.opsForList().range(key, start, end);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è·å–Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * è·å–listç¼“å­˜çš„é•¿åº?     */
    public long lGetListSize(String key) {
        try {
            return redisTemplate.opsForList().size(key);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è·å–Listç¼“å­˜é•¿åº¦å¤±è´¥: {}", e.getMessage());
            return 0;
        }
    }

    /**
     * é€šè¿‡ç´¢å¼• è·å–listä¸­çš„å€?     */
    public Object lGetIndex(String key, long index) {
        try {
            return redisTemplate.opsForList().index(key, index);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è·å–Listç¼“å­˜ç´¢å¼•å¤±è´¥: {}", e.getMessage());
            return null;
        }
    }

    /**
     * å°†listæ”¾å…¥ç¼“å­˜
     */
    public boolean lSet(String key, Object value) {
        try {
            redisTemplate.opsForList().rightPush(key, value);
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * å°†listæ”¾å…¥ç¼“å­˜
     */
    public boolean lSet(String key, Object value, long time) {
        try {
            redisTemplate.opsForList().rightPush(key, value);
            if (time > 0) {
                expire(key, time);
            }
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * å°†listæ”¾å…¥ç¼“å­˜
     */
    public boolean lSet(String key, List<?> value) {
        try {
            redisTemplate.opsForList().rightPushAll(key, value);
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * å°†listæ”¾å…¥ç¼“å­˜
     */
    public boolean lSet(String key, List<?> value, long time) {
        try {
            redisTemplate.opsForList().rightPushAll(key, value);
            if (time > 0) {
                expire(key, time);
            }
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "è®¾ç½®Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * æ ¹æ®ç´¢å¼•ä¿®æ”¹listä¸­çš„æŸæ¡æ•°æ®
     */
    public boolean lUpdateIndex(String key, long index, Object value) {
        try {
            redisTemplate.opsForList().set(key, index, value);
            return true;
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "æ›´æ–°Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }

    /**
     * ç§»é™¤Nä¸ªå€¼ä¸ºvalue
     */
    public long lRemove(String key, long count, Object value) {
        try {
            return redisTemplate.opsForList().remove(key, count, value);
        } catch (Exception e) {
            LogUtils.error(LogUtils.getLogger(RedisUtils.class), "ç§»é™¤Listç¼“å­˜å¤±è´¥: {}", e.getMessage());
            return 0;
        }
    }
}
package com.heikeji.system.vo;

import lombok.Data;

import java.io.Serializable;

/**
 * æƒé™æŸ¥è¯¢å‚æ•°
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
public class PermissionQueryVO implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * é¡µç 
     */
    private Integer pageNum = 1;

    /**
     * æ¯é¡µæ•°é‡
     */
    private Integer pageSize = 10;

    /**
     * æƒé™åç§°
     */
    private String permissionName;

    /**
     * æƒé™ç¼–ç 
     */
    private String permissionCode;

    /**
     * ç±»å‹ï¼?ç›®å½• 2èœå• 3æŒ‰é’®
     */
    private Integer type;

    /**
     * çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨
     */
    private Integer status;

    /**
     * çˆ¶çº§æƒé™ID
     */
    private Long parentId;

    /**
     * æ‰€å±è§’è‰²ID
     */
    private Long roleId;

    /**
     * åˆ›å»ºæ—¶é—´å¼€å§?     */
    private String createTimeStart;

    /**
     * åˆ›å»ºæ—¶é—´ç»“æŸ
     */
    private String createTimeEnd;
}
package com.heikeji.system.vo;

import lombok.Data;

import java.io.Serializable;

/**
 * è§’è‰²æŸ¥è¯¢å‚æ•°
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
public class RoleQueryVO implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * é¡µç 
     */
    private Integer pageNum = 1;

    /**
     * æ¯é¡µæ•°é‡
     */
    private Integer pageSize = 10;

    /**
     * è§’è‰²åç§°
     */
    private String roleName;

    /**
     * è§’è‰²ç¼–ç 
     */
    private String roleCode;

    /**
     * çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨
     */
    private Integer status;

    /**
     * è§’è‰²æè¿°
     */
    private String description;

    /**
     * åˆ›å»ºæ—¶é—´å¼€å§?     */
    private String createTimeStart;

    /**
     * åˆ›å»ºæ—¶é—´ç»“æŸ
     */
    private String createTimeEnd;
}
package com.heikeji.system.vo;

import lombok.Data;

import java.io.Serializable;

/**
 * ç”¨æˆ·æŸ¥è¯¢å‚æ•°
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@Data
public class UserQueryVO implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * é¡µç 
     */
    private Integer pageNum = 1;

    /**
     * æ¯é¡µæ•°é‡
     */
    private Integer pageSize = 10;

    /**
     * ç”¨æˆ·å?     */
    private String username;

    /**
     * æ˜µç§°
     */
    private String nickname;

    /**
     * æ‰‹æœºå?     */
    private String phone;

    /**
     * é‚®ç®±
     */
    private String email;

    /**
     * çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨
     */
    private Integer status;

    /**
     * éƒ¨é—¨ID
     */
    private Long deptId;

    /**
     * è§’è‰²ID
     */
    private Long roleId;

    /**
     * åˆ›å»ºæ—¶é—´å¼€å§?     */
    private String createTimeStart;

    /**
     * åˆ›å»ºæ—¶é—´ç»“æŸ
     */
    private String createTimeEnd;
}
package com.heikeji.system.websocket;

import com.heikeji.system.utils.LogUtils;
import org.slf4j.Logger;
import org.springframework.stereotype.Component;

import javax.websocket.*;
import javax.websocket.server.PathParam;
import javax.websocket.server.ServerEndpoint;
import java.io.IOException;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * WebSocketæœåŠ¡å™¨ç«¯
 *
 * @author zhangkaiyuan
 * @date 2023-11-09
 */
@ServerEndpoint("/websocket/{userId}")
@Component
public class WebSocketServer {

    private static final Logger logger = LogUtils.getLogger(WebSocketServer.class);
    
    // é™æ€å˜é‡ï¼Œç”¨æ¥è®°å½•å½“å‰åœ¨çº¿è¿æ¥æ•?    private static final AtomicInteger ONLINE_COUNT = new AtomicInteger(0);
    
    // concurrentåŒ…çš„çº¿ç¨‹å®‰å…¨Setï¼Œç”¨æ¥å­˜æ”¾æ¯ä¸ªå®¢æˆ·ç«¯å¯¹åº”çš„MyWebSocketå¯¹è±¡
    private static final Map<String, WebSocketServer> WEB_SOCKET_MAP = new ConcurrentHashMap<>();
    
    // ä¸æŸä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ä¼šè¯ï¼Œéœ€è¦é€šè¿‡å®ƒæ¥ç»™å®¢æˆ·ç«¯å‘é€æ•°æ?    private Session session;
    
    // æ¥æ”¶userId
    private String userId = "";

    /**
     * è¿æ¥å»ºç«‹æˆåŠŸè°ƒç”¨çš„æ–¹æ³?     */
    @OnOpen
    public void onOpen(Session session, @PathParam("userId") String userId) {
        this.session = session;
        this.userId = userId;
        
        // åŠ å…¥mapä¸?        WEB_SOCKET_MAP.put(userId, this);
        
        // åœ¨çº¿æ•°åŠ 1
        ONLINE_COUNT.incrementAndGet();
        
        LogUtils.info(logger, "ç”¨æˆ·è¿æ¥: {}, å½“å‰åœ¨çº¿äººæ•°ä¸? {}", userId, ONLINE_COUNT.get());
        
        try {
            sendMessage("è¿æ¥æˆåŠŸ");
        } catch (IOException e) {
            LogUtils.error(logger, "ç”¨æˆ·: {}, ç½‘ç»œå¼‚å¸¸ï¼?, userId);
        }
    }

    /**
     * è¿æ¥å…³é—­è°ƒç”¨çš„æ–¹æ³?     */
    @OnClose
    public void onClose() {
        // ä»mapä¸­åˆ é™?        WEB_SOCKET_MAP.remove(userId);
        
        // åœ¨çº¿æ•°å‡1
        ONLINE_COUNT.decrementAndGet();
        
        LogUtils.info(logger, "ç”¨æˆ·é€€å‡? {}, å½“å‰åœ¨çº¿äººæ•°ä¸? {}", userId, ONLINE_COUNT.get());
    }

    /**
     * æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯åè°ƒç”¨çš„æ–¹æ³?     *
     * @param message å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯
     */
    @OnMessage
    public void onMessage(String message, Session session) {
        LogUtils.info(logger, "æ”¶åˆ°ç”¨æˆ·æ¶ˆæ¯: {}, æ¶ˆæ¯å†…å®¹: {}", userId, message);
        
        // ç¾¤å‘æ¶ˆæ¯
        if (message.startsWith("broadcast:")) {
            String broadcastMessage = message.substring(10);
            sendToAll(broadcastMessage);
        } else {
            // å•èŠæ¶ˆæ¯
            try {
                this.sendMessage("æ”¶åˆ°æ¶ˆæ¯: " + message);
            } catch (IOException e) {
                LogUtils.error(logger, "å‘é€æ¶ˆæ¯å¤±è´? {}", e.getMessage());
            }
        }
    }

    /**
     * å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”?     */
    @OnError
    public void onError(Session session, Throwable error) {
        LogUtils.error(logger, "ç”¨æˆ·é”™è¯¯: {}, é”™è¯¯ä¿¡æ¯: {}", userId, error.getMessage(), error);
    }

    /**
     * å‘é€æ¶ˆæ?     */
    public void sendMessage(String message) throws IOException {
        this.session.getBasicRemote().sendText(message);
    }

    /**
     * å‘é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
     */
    public static boolean sendToUser(String userId, String message) {
        LogUtils.info(logger, "å‘é€æ¶ˆæ¯åˆ°ç”¨æˆ·: {}, æ¶ˆæ¯å†…å®¹: {}", userId, message);
        WebSocketServer webSocket = WEB_SOCKET_MAP.get(userId);
        if (webSocket != null) {
            try {
                webSocket.sendMessage(message);
                return true;
            } catch (IOException e) {
                LogUtils.error(logger, "å‘é€æ¶ˆæ¯åˆ°ç”¨æˆ·: {} å¤±è´¥: {}", userId, e.getMessage());
                return false;
            }
        }
        LogUtils.warn(logger, "ç”¨æˆ·: {} ä¸åœ¨çº?, userId);
        return false;
    }

    /**
     * å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ?     */
    public static void sendToAll(String message) {
        LogUtils.info(logger, "å¹¿æ’­æ¶ˆæ¯: {}", message);
        for (WebSocketServer webSocket : WEB_SOCKET_MAP.values()) {
            try {
                webSocket.sendMessage(message);
            } catch (IOException e) {
                LogUtils.error(logger, "å¹¿æ’­æ¶ˆæ¯å¤±è´¥: {}", e.getMessage());
            }
        }
    }

    /**
     * è·å–åœ¨çº¿äººæ•°
     */
    public static int getOnlineCount() {
        return ONLINE_COUNT.get();
    }

    /**
     * è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
     */
    public static Set<String> getOnlineUsers() {
        return WEB_SOCKET_MAP.keySet();
    }

    /**
     * åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨çº¿
     */
    public static boolean isUserOnline(String userId) {
        return WEB_SOCKET_MAP.containsKey(userId);
    }
}
