# 黑科易购项目 SQL 管理计划

## 📋 项目概述
- **项目名称**: 黑科易购校园商城
- **数据库类型**: MySQL
- **表结构**: 15个核心表，覆盖用户、商品、订单、配送、支付等模块
- **数据规模**: 校园级别，预计支持数千到数万用户

## 🎯 管理目标
1. 确保数据库结构的一致性和可维护性
2. 提供高效的数据迁移和版本管理
3. 保障数据安全和系统性能
4. 简化开发和部署流程

---

## 📊 当前数据库结构分析

### 核心业务表
1. **用户模块** - user, user_auth, address
2. **商品模块** - merchant, category, product, cart  
3. **订单模块** - order, order_item
4. **配送模块** - delivery_request, takeout_order, delivery_locker, delivery_person
5. **支付模块** - payment
6. **校园服务** - campus_info

### 数据关系
- **用户关系**: user ← user_auth, address, cart, order
- **订单关系**: order ← order_item, takeout_order, payment
- **配送关系**: delivery_request, takeout_order → delivery_person
- **商品关系**: product → merchant, category

---

## 🗂️ SQL文件分类与管理

### 1. 基础结构文件
| 文件名 | 用途 | 状态 | 备注 |
|--------|------|------|------|
| `schema.sql` | 完整数据库结构 | ✅ 完整 | 15个核心表 |
| `simple_schema.sql` | 简化结构 | 🔄 待确认 | 适合开发环境 |
| `clean_schema.sql` | 清理脚本 | ❓ 需要检查 | 用于重置数据 |

### 2. 初始化数据文件
| 文件名 | 用途 | 状态 | 备注 |
|--------|------|------|------|
| `init_data.sql` | 基础初始化数据 | 🔄 待检查 | 必需的系统数据 |
| `basic_data.sql` | 基础业务数据 | 🔄 待检查 | 商家、分类等 |
| `minimal_data.sql` | 最小数据集 | 🔄 待检查 | 仅开发测试 |
| `heikeji_user_data.sql` | 用户模拟数据 | 🔄 待检查 | 测试用户数据 |
| `heikeji_campus_data.sql` | 校园模拟数据 | 🔄 待检查 | 校园服务数据 |
| `ascii_data.sql` | ASCII测试数据 | 🔄 待检查 | 特殊测试场景 |

### 3. 维护工具文件
| 文件名 | 用途 | 状态 | 备注 |
|--------|------|------|------|
| `optimize_indexes.sql` | 索引优化 | ❓ 待确认 | 性能优化 |
| `add_basic_data.sql` | 补充基础数据 | ❓ 待确认 | 增量数据 |
| `campus_service_menu.sql` | 校园服务菜单 | ❓ 待确认 | 校园功能数据 |

---

## 🔧 SQL版本管理策略

### 1. 版本控制结构
```
sql/
├── versions/              # 版本化管理
│   ├── v1.0.0/           # 初始版本
│   │   ├── 001_create_tables.sql
│   │   ├── 002_init_data.sql
│   │   └── 003_indexes.sql
│   ├── v1.1.0/           # 功能升级版本
│   │   ├── 001_add_campus_features.sql
│   │   └── 002_update_data.sql
│   └── current/          # 当前版本脚本
├── schemas/              # 完整schema文件
├── migrations/           # 数据迁移脚本
├── seed_data/           # 测试和种子数据
└── maintenance/         # 维护工具脚本
```

### 2. 版本命名规范
- **格式**: `vX.Y.Z_描述_YYYYMMDD.sql`
- **示例**: `v1.1.0_add_delivery_lockers_20241118.sql`

---

## 📅 维护计划

### 1. 日常维护 (每日/每周)
- **数据备份**: 每日自动全量备份
- **日志监控**: 监控慢查询和错误日志
- **连接数检查**: 确保连接池健康
- **磁盘空间**: 监控数据库磁盘使用情况

### 2. 定期维护 (每月)
- **索引优化**: 分析并优化索引使用
- **表空间整理**: 执行OPTIMIZE TABLE
- **统计信息更新**: 更新表统计信息
- **数据完整性检查**: 验证外键约束

### 3. 性能优化 (每季度)
- **慢查询分析**: 识别并优化慢查询
- **分区策略**: 根据数据增长考虑分区
- **读写分离**: 评估读写分离需求
- **缓存策略**: 优化Redis缓存使用

---

## 🚀 部署流程

### 1. 开发环境部署
```bash
# 1. 清理现有数据
mysql -u root -p < sql/clean_schema.sql

# 2. 创建基础结构
mysql -u root -p < sql/simple_schema.sql

# 3. 初始化开发数据
mysql -u root -p < sql/minimal_data.sql
```

### 2. 测试环境部署
```bash
# 1. 完整结构部署
mysql -u root -p < sql/schema.sql

# 2. 基础业务数据
mysql -u root -p < sql/basic_data.sql

# 3. 测试数据
mysql -u root -p < sql/heikeji_user_data.sql
mysql -u root -p < sql/heikeji_campus_data.sql
```

### 3. 生产环境部署
```bash
# 1. 使用迁移脚本
mysql -u root -p < sql/migrations/latest.sql

# 2. 执行索引优化
mysql -u root -p < sql/optimize_indexes.sql

# 3. 验证数据完整性
mysql -u root -p < sql/maintenance/verify_data.sql
```

---

## 🔒 数据安全策略

### 1. 备份策略
- **全量备份**: 每日凌晨2点执行
- **增量备份**: 每4小时执行一次binlog备份
- **保留策略**: 全量保留30天，增量保留7天
- **异地备份**: 备份文件同步到云存储

### 2. 权限管理
- **最小权限原则**: 应用账户只授予必要权限
- **分离权限**: 开发、测试、生产环境权限隔离
- **审计日志**: 记录所有权限变更操作

### 3. 数据加密
- **传输加密**: 启用SSL/TLS连接
- **存储加密**: 敏感字段考虑加密存储
- **密钥管理**: 定期轮换加密密钥

---

## 📈 性能监控指标

### 1. 基础指标
- **QPS**: 每秒查询数
- **TPS**: 每秒事务数
- **连接数**: 当前活跃连接数
- **响应时间**: P95、P99响应时间

### 2. 资源指标
- **CPU使用率**: 数据库服务器CPU使用率
- **内存使用率**: 缓冲区命中率
- **磁盘IO**: 读写IOPS和延迟
- **网络IO**: 网络带宽使用情况

### 3. 业务指标
- **订单创建成功率**: >99.9%
- **支付处理时间**: <3秒
- **用户查询响应**: <500ms
- **配送状态更新**: <1秒

---

## 🛠️ 故障恢复计划

### 1. 数据恢复流程
1. **确定恢复点**: 根据备份时间确定恢复点
2. **评估影响范围**: 确定受影响的数据范围
3. **执行恢复**: 从备份恢复数据
4. **数据一致性验证**: 验证恢复后数据完整性
5. **业务验证**: 确认业务功能正常

### 2. 常见故障处理
| 故障类型 | 处理方案 | 恢复时间目标 |
|----------|----------|--------------|
| 数据损坏 | 从最近备份恢复 | <30分钟 |
| 连接异常 | 重启数据库服务 | <5分钟 |
| 性能问题 | 索引优化、查询重写 | <2小时 |
| 磁盘满 | 清理日志、扩展磁盘 | <1小时 |

---

## 📋 任务清单

### 立即执行 (本周内)
- [ ] 分析现有SQL文件内容和用途
- [ ] 评估数据量级和增长趋势
- [ ] 设计索引优化策略
- [ ] 制定备份恢复测试计划

### 短期计划 (本月内)
- [ ] 建立SQL版本管理结构
- [ ] 创建数据迁移脚本模板
- [ ] 设置监控和告警系统
- [ ] 编写部署自动化脚本

### 中期计划 (3个月内)
- [ ] 实施读写分离架构
- [ ] 建立数据库主从复制
- [ ] 设计分区策略 (如需要)
- [ ] 完善性能基准测试

### 长期计划 (6个月内)
- [ ] 考虑数据库中间件 (如MyCat)
- [ ] 评估NoSQL数据库补充需求
- [ ] 建立数据仓库和BI系统
- [ ] 制定数据治理规范

---

## 📞 支持与联系

### 技术支持
- **DBA负责人**: 数据库管理员
- **后端负责人**: 服务端开发负责人
- **运维负责人**: 系统运维负责人

### 紧急联系
- **工作时间**: 内部沟通工具
- **非工作时间**: 紧急联系电话
- **严重故障**: 直接上报技术总监

---

*文档版本: v1.0*  
*创建日期: 2025-11-18*  
*最后更新: 2025-11-18*