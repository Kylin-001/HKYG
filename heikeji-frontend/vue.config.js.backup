const { defineConfig } = require('@vue/cli-service')

module.exports = defineConfig({
  // 基本配置
  publicPath: process.env.NODE_ENV === 'production' ? '/heikeji-mall/' : '/',
  outputDir: 'dist',
  assetsDir: 'static',
  
  // 开发服务器配置
  devServer: {
    host: '0.0.0.0',
    port: 8080,
    open: true,
    hot: true,
    compress: true,
    historyApiFallback: true,
    client: {
      overlay: {
        warnings: false,
        errors: true
      },
      progress: true
    },
    // 代理配置
    proxy: {
      '/api': {
        target: 'http://localhost:8081',
        changeOrigin: true,
        pathRewrite: {
          '^/api': '/api'
        }
      }
    },
    // 开发环境变量
    define: {
      __VUE_PROD_DEVTOOLS__: false,
      __VUE_OPTIONS_API__: true,
      __VUE_PROD_HYDRATION_MISMATCH_DETAILS__: false
    }
  },

  // 构建配置
  productionSourceMap: false,
  filenameHashing: true,
  runtimeCompiler: false,
  parallel: require('os').cpus().length > 1,
  
  // PWA配置
  pwa: {
    name: '黑科易购',
    themeColor: '#4DBA87',
    msTileColor: '#000000',
    appleMobileWebAppCapable: 'yes',
    appleMobileWebAppStatusBarStyle: 'black-translucent',
    workboxOptions: {
      skipWaiting: true
    }
  },

  // Webpack配置
  configureWebpack: config => {
    // 生产环境优化
    if (process.env.NODE_ENV === 'production') {
      config.optimization = {
        ...config.optimization,
        splitChunks: {
          chunks: 'all',
          cacheGroups: {
            // 第三方库分离
            vendor: {
              name: 'chunk-vendors',
              test: /[\\/]node_modules[\\/]/,
              priority: 10,
              chunks: 'initial'
            },
            // Element UI相关组件分离
            element: {
              name: 'chunk-element-ui',
              test: /[\\/]node_modules[\\/]element-ui[\\/]/,
              priority: 20,
              chunks: 'all'
            },
            // 常用工具库分离
            utils: {
              name: 'chunk-utils',
              test: /[\\/]node_modules[\\/](axios|lodash|moment|dayjs)[\\/]/,
              priority: 15,
              chunks: 'all'
            },
            // 图表库分离
            charts: {
              name: 'chunk-charts',
              test: /[\\/]node_modules[\\/](echarts|chart\.js|d3)[\\/]/,
              priority: 12,
              chunks: 'all'
            }
          }
        }
      }
    }

    // 添加别名配置
    config.resolve.alias = {
      ...config.resolve.alias,
      '@': require('path').resolve(__dirname, 'src'),
      '@components': require('path').resolve(__dirname, 'src/components'),
      '@views': require('path').resolve(__dirname, 'src/views'),
      '@utils': require('path').resolve(__dirname, 'src/utils'),
      '@api': require('path').resolve(__dirname, 'src/api'),
      '@assets': require('path').resolve(__dirname, 'src/assets'),
      '@styles': require('path').resolve(__dirname, 'src/styles')
    }

    // 添加文件扩展名解析
    config.resolve.extensions = ['.js', '.vue', '.json', '.ts', '.tsx']

    // 开发环境添加Source Map
    if (process.env.NODE_ENV === 'development') {
      config.devtool = 'cheap-module-eval-source-map'
    }
  },

  // CSS相关配置
  css: {
    extract: process.env.NODE_ENV === 'production',
    sourceMap: false,
    loaderOptions: {
      sass: {
        additionalData: `
          @import "@/styles/variables.scss";
          @import "@/styles/mixins.scss";
        `
      },
      postcss: {
        plugins: [
          require('autoprefixer'),
          require('cssnano')({
            preset: 'default'
          })
        ]
      }
    }
  },

  // 插件配置
  pluginOptions: {
    // ESLint配置
    eslint: {
      lintOnSave: process.env.NODE_ENV !== 'production',
      extensions: ['js', 'vue'],
      cache: true,
      cacheLocation: 'node_modules/.cache/eslint'
    },

    // Storybook配置
    storybook: {
      framework: '@storybook/vue',
      stories: ['../src/**/*.stories.@(js|jsx|ts|tsx|vue)'],
      addons: [
        '@storybook/addon-essentials',
        '@storybook/addon-a11y',
        '@storybook/addon-design-tokens'
      ]
    }
  },

  // 链式配置
  chainWebpack: config => {
    // 移除Prefetch
    config.plugins.delete('prefetch')
    config.plugins.delete('preload')

    // 按需加载路由
    config.plugin('prefetch').tap(options => {
      options[0].fileBlacklist = options[0].fileBlacklist || []
      options[0].fileBlacklist.push(/\.map$/, /hot-update\.js$/)
      return options
    })

    // SVG优化
    const svgRule = config.module.rule('svg')
    svgRule.uses.clear()
    svgRule
      .test(/\.svg$/)
      .use('babel-loader')
      .loader('babel-loader')
      .end()
      .use('vue-svg-loader')
      .loader('vue-svg-loader')
      .end()

    // 性能分析
    if (process.env.NODE_ENV === 'production' && process.env.ANALYZE) {
      config
        .plugin('webpack-bundle-analyzer')
        .use(require('webpack-bundle-analyzer').BundleAnalyzerPlugin)
    }

    // PWA优化
    if (process.env.NODE_ENV === 'production') {
      config.plugin('workbox-sw').use('workbox-sw')
      
      config.plugin('generate-sw').use('html-webpack-plugin', [
        {
          template: 'public/index.html'
        }
      ])
    }
  },

  // 复制文件配置
  transpileDependencies: [
    'element-ui',
    'dayjs',
    'axios'
  ],

  // 依赖优化
  optimizeDeps: {
    include: [
      'vue',
      'vue-router',
      'vuex',
      'axios',
      'element-ui',
      'dayjs',
      'lodash'
    ]
  }
})