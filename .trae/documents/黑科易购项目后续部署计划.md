# 黑科易购项目后续部署计划

## 1. 部署目标

### 1.1 核心目标
- 解决业务服务启动问题
- 确保所有服务正常运行
- 验证系统功能完整性
- 实施生产环境优化

### 1.2 预期效果
| 服务类型 | 预期状态 | 访问地址 |
|----------|----------|----------|
| 前端 | ✅ 运行中 | http://localhost |
| APP端API | ✅ 运行中 | http://localhost:8082/api/app |
| 用户服务 | ✅ 运行中 | http://localhost:8081/api/user |
| 商品服务 | ✅ 运行中 | http://localhost:8083/api/product |
| 支付服务 | ✅ 运行中 | http://localhost:8084/api/payment |
| 外卖服务 | ✅ 运行中 | http://localhost:8085/api/takeout |
| 订单服务 | ✅ 运行中 | http://localhost:8086/api/order |
| 跑腿服务 | ✅ 运行中 | http://localhost:8087/api/delivery |
| 校园信息服务 | ✅ 运行中 | http://localhost:8088/api/campus |
| 二手市场服务 | ✅ 运行中 | http://localhost:8089/api/secondhand |
| 失物招领服务 | ✅ 运行中 | http://localhost:8090/api/lostfound |

## 2. 部署步骤

### 2.1 阶段一：解决业务服务启动问题

#### 2.1.1 问题分析
- **错误信息**：`Invalid value type for attribute 'factoryBeanObjectType': java.lang.String`
- **根本原因**：Spring Boot 3.x的FactoryBean实现与某些依赖库不兼容
- **影响范围**：9个业务服务无法启动

#### 2.1.2 解决方案
```bash
# 1. 修改业务服务的Spring Boot版本为2.7.18
cd /home/heikeji/heikeji-mall

# 2. 重新构建业务服务
mvn clean install '-Dmaven.test.skip=true' -pl '!heikeji-mall-api,!heikeji-mall-job,!heikeji-gateway,!heikeji-admin'

# 3. 修改启动脚本，禁用Nacos配置检查
echo "修改启动脚本，禁用Nacos配置检查"
cat > /home/heikeji/heikeji-mall/heikeji-mall-service/start_services_final.sh << 'EOF'
#!/bin/bash

# 先停止所有正在运行的业务服务
ps -ef | grep java | grep -v grep | grep -v nacos | grep -v zipkin | grep -v trae | awk '{print $2}' | xargs kill -9 2>/dev/null

# 服务列表
SERVICES=()
SERVICES+=("service-user")
SERVICES+=("service-product")
SERVICES+=("service-payment")
SERVICES+=("service-takeout")
SERVICES+=("service-order")
SERVICES+=("service-campus")
SERVICES+=("service-delivery")
SERVICES+=("service-secondhand")
SERVICES+=("service-lostfound")

# 启动所有服务
for service in "${SERVICES[@]}"; do
    echo "启动 ${service}..."
    # 使用本地配置启动服务，禁用Nacos配置检查
    nohup java -jar -Dspring.cloud.nacos.config.import-check.enabled=false ${service}/target/${service}-1.0.0.jar > ${service}.log 2>&1 &
    echo "${service} 启动成功，PID: $!"
    sleep 5
done

echo "所有服务启动完成！"
EOF

# 4. 启动业务服务
chmod +x /home/heikeji/heikeji-mall/heikeji-mall-service/start_services_final.sh
cd /home/heikeji/heikeji-mall/heikeji-mall-service
./start_services_final.sh
```

### 2.2 阶段二：验证服务运行状态

#### 2.2.1 服务进程检查
```bash
# 检查服务进程
ps -ef | grep java | grep -v grep

# 检查服务端口
netstat -tuln | grep -E '8081|8082|8083|8084|8085|8086|8087|8088|8089|8090'
```

#### 2.2.2 服务日志检查
```bash
# 查看服务日志
cd /home/heikeji/heikeji-mall/heikeji-mall-service
for service in service-user service-product service-payment service-takeout service-order; do
    echo "=== ${service} 日志 ==="
    tail -n 20 ${service}.log | grep -E 'Started|started|running|Running|ERROR|Exception'
    echo ""
done
```

#### 2.2.3 服务API验证
```bash
# 测试服务API
echo "测试APP端API健康检查"
curl -I http://localhost:8082/api/app/health

echo "测试用户服务API"
curl -X GET http://localhost:8081/api/user/health
```

### 2.3 阶段三：功能测试

#### 2.3.1 核心功能测试
```bash
# 1. 用户服务测试
echo "测试用户注册"
curl -X POST http://localhost:8081/api/user/register -H "Content-Type: application/json" -d '{"username":"test","password":"123456"}'

# 2. 商品服务测试
echo "测试商品列表"
curl -X GET http://localhost:8083/api/product/list

# 3. 订单服务测试
echo "测试创建订单"
curl -X POST http://localhost:8086/api/order/create -H "Content-Type: application/json" -d '{"userId":1,"productId":1,"quantity":1}'
```

#### 2.3.2 前端功能测试
- 访问 http://localhost
- 测试首页访问
- 测试商品列表
- 测试用户登录
- 测试下单流程

### 2.4 阶段四：生产环境优化

#### 2.4.1 安全性优化
```bash
# 1. 配置防火墙
echo "配置防火墙规则"
sudo ufw enable
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 3306/tcp
sudo ufw allow 6379/tcp
sudo ufw allow 8848/tcp

# 2. 配置HTTPS
echo "安装Certbot"
sudo apt install certbot python3-certbot-nginx
echo "获取SSL证书"
sudo certbot --nginx -d yourdomain.com
```

#### 2.4.2 性能优化
```bash
# 1. 数据库优化
echo "优化MySQL配置"
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf

# 2. Redis优化
echo "优化Redis配置"
sudo vim /etc/redis/redis.conf

# 3. Nginx优化
echo "优化Nginx配置"
sudo vim /etc/nginx/nginx.conf
```

#### 2.4.3 监控系统搭建
```bash
# 1. 安装Prometheus
echo "安装Prometheus"
wget https://github.com/prometheus/prometheus/releases/download/v2.47.0/prometheus-2.47.0.linux-amd64.tar.gz
tar -xzf prometheus-2.47.0.linux-amd64.tar.gz
cd prometheus-2.47.0.linux-amd64
./prometheus &

# 2. 安装Grafana
echo "安装Grafana"
sudo apt-get install -y adduser libfontconfig1
wget https://dl.grafana.com/oss/release/grafana_10.0.0_amd64.deb
sudo dpkg -i grafana_10.0.0_amd64.deb
sudo systemctl start grafana-server
sudo systemctl enable grafana-server
```

## 3. 部署验收

### 3.1 功能验收
- ✅ 所有业务服务正常运行
- ✅ 核心业务流程可正常执行
- ✅ 前端与后端API正常交互
- ✅ 服务间通信正常

### 3.2 性能验收
- ✅ 90%请求响应时间<1秒
- ✅ 系统可承受100并发请求
- ✅ 数据库查询性能良好

### 3.3 安全性验收
- ✅ HTTPS配置正常
- ✅ 防火墙规则配置正确
- ✅ 敏感数据加密存储

## 4. 风险评估与应急预案

### 4.1 主要风险
| 风险点 | 解决方案 |
|--------|----------|
| 业务服务启动失败 | 检查日志，调整配置，重启服务 |
| 数据库连接失败 | 检查MySQL服务状态，验证连接配置 |
| Nacos连接失败 | 检查Nacos服务状态，验证网络连接 |
| 性能问题 | 优化配置，增加服务器资源 |

### 4.2 回滚方案
```bash
# 保存当前配置
cp pom.xml pom.xml.bak

# 回滚配置
cp pom.xml.bak pom.xml

# 重新构建服务
mvn clean install '-Dmaven.test.skip=true'

# 重启服务
./start_services_final.sh
```

## 5. 后续维护建议

### 5.1 日常维护
- 定期检查服务日志
- 监控系统资源使用情况
- 定期备份数据库
- 及时更新依赖库

### 5.2 版本升级规划
- 待Spring Boot 3.x生态成熟后，逐步升级
- 建立完善的测试体系，确保版本升级顺利
- 定期进行安全审计

## 6. 部署时间计划

| 阶段 | 时间 | 任务 |
|------|------|------|
| 阶段一：解决业务服务启动问题 | 1天 | 修改配置，重新构建，启动服务 |
| 阶段二：验证服务运行状态 | 半天 | 检查进程，查看日志，测试API |
| 阶段三：功能测试 | 1天 | 核心功能测试，前端功能测试 |
| 阶段四：生产环境优化 | 1天 | 安全性优化，性能优化，监控系统搭建 |
| 部署验收 | 半天 | 功能验收，性能验收，安全性验收 |

## 7. 联系方式

| 角色 | 姓名 | 联系方式 |
|------|------|----------|
| 系统管理员 | - | - |
| 开发负责人 | - | - |
| 运维负责人 | - | - |

---

**部署文档版本**：v2.0  
**编写日期**：2025-12-17  
**执行日期**：2025-12-17