<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heikeji.mall.delivery.mapper.DeliveryOrderMapper">

    <select id="getByOrderId" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        SELECT * FROM delivery_order WHERE order_id = #{orderId} AND del_flag = 0
    </select>

    <select id="getByDeliveryUserId" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        SELECT * FROM delivery_order WHERE delivery_user_id = #{deliveryUserId} AND del_flag = 0
        ORDER BY create_time DESC
    </select>

    <update id="updateStatus">
        UPDATE delivery_order 
        SET status = #{status}, 
            delivery_user_id = #{deliveryUserId},
            update_time = NOW() 
        WHERE id = #{id}
    </update>

    <update id="updateDeliveryInfo">
        UPDATE delivery_order 
        SET delivery_time = #{deliveryTime}, 
            complete_time = #{completeTime}, 
            status = #{status}, 
            update_time = NOW() 
        WHERE id = #{id}
    </update>

    <select id="getPendingDeliveryOrders" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        SELECT * FROM delivery_order 
        WHERE status = 0 AND delivery_user_id IS NULL AND del_flag = 0
        ORDER BY create_time ASC
    </select>

    <select id="selectByDeliveryUserId" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        SELECT * FROM delivery_order 
        WHERE delivery_user_id = #{deliveryUserId} AND del_flag = 0
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
    </select>
    
    <select id="selectByOrderNo" parameterType="java.lang.String" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        select id, order_no as orderNo, user_id as userId, delivery_user_id as deliveryUserId, 
               order_type as orderType, start_location as startLocation, end_location as endLocation, 
               item_description as itemDescription, expected_time as expectedTime, amount, tip,
               status, pay_status as payStatus, pay_type as payType, remark, create_time as createTime, update_time as updateTime
        from delivery_order
        where order_no = #{orderNo}
    </select>

    <select id="selectByUserId" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        select id, order_no as orderNo, user_id as userId, delivery_user_id as deliveryUserId, 
               order_type as orderType, start_location as startLocation, end_location as endLocation, 
               item_description as itemDescription, expected_time as expectedTime, amount, tip,
               status, pay_status as payStatus, pay_type as payType, remark, create_time as createTime, update_time as updateTime
        from delivery_order
        where user_id = #{userId}
        <if test="status != null">
            and status = #{status}
        </if>
        order by create_time desc
    </select>

    <select id="selectPendingOrders" resultType="com.heikeji.mall.delivery.entity.DeliveryOrder">
        select id, order_no as orderNo, user_id as userId, delivery_user_id as deliveryUserId, 
               order_type as orderType, start_location as startLocation, end_location as endLocation, 
               item_description as itemDescription, expected_time as expectedTime, amount, tip,
               status, pay_status as payStatus, pay_type as payType, remark, create_time as createTime, update_time as updateTime
        from delivery_order
        where status = 0
        order by create_time desc
    </select>

</mapper>