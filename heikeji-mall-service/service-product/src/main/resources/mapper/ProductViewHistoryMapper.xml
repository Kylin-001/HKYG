<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heikeji.mall.product.mapper.ProductViewHistoryMapper">

    <!-- 记录或更新用户浏览历史 -->
    <insert id="recordOrUpdateViewHistory" parameterType="java.util.Map">
        INSERT INTO product_view_history (user_id, product_id, view_time, view_count)
        VALUES (#{userId}, #{productId}, NOW(), 1)
        ON DUPLICATE KEY UPDATE
        view_time = NOW(),
        view_count = view_count + 1
    </insert>

    <!-- 获取用户最近浏览的商品ID列表 -->
    <select id="getRecentViewedProductIds" resultType="java.lang.Long">
        SELECT product_id
        FROM product_view_history
        WHERE user_id = #{userId}
        ORDER BY view_time DESC
        LIMIT #{limit}
    </select>

    <!-- 获取用户浏览最多的商品分类ID列表 -->
    <select id="getMostViewedCategoryIds" resultType="java.lang.Long">
        SELECT p.category_id
        FROM product_view_history pvh
        JOIN product p ON pvh.product_id = p.id
        WHERE pvh.user_id = #{userId}
        GROUP BY p.category_id
        ORDER BY SUM(pvh.view_count) DESC
        LIMIT #{limit}
    </select>

    <!-- 根据用户ID和商品ID删除浏览记录 -->
    <delete id="deleteByUserIdAndProductId">
        DELETE FROM product_view_history
        WHERE user_id = #{userId}
          AND product_id = #{productId}
    </delete>

    <!-- 根据用户ID删除所有浏览记录 -->
    <delete id="deleteByUserId">
        DELETE FROM product_view_history
        WHERE user_id = #{userId}
    </delete>

</mapper>