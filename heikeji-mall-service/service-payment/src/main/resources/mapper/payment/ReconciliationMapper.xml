<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heikeji.mall.payment.mapper.ReconciliationMapper">

    <resultMap id="BaseResultMap" type="com.heikeji.mall.payment.entity.Reconciliation">
        <id column="id" property="id"/>
        <result column="batch_no" property="batchNo"/>
        <result column="reconciliation_date" property="reconciliationDate"/>
        <result column="payment_type" property="paymentType"/>
        <result column="payment_no" property="paymentNo"/>
        <result column="transaction_id" property="transactionId"/>
        <result column="order_no" property="orderNo"/>
        <result column="order_amount" property="orderAmount"/>
        <result column="actual_amount" property="actualAmount"/>
        <result column="platform_amount" property="platformAmount"/>
        <result column="reconciliation_status" property="reconciliationStatus"/>
        <result column="diff_amount" property="diffAmount"/>
        <result column="error_reason" property="errorReason"/>
        <result column="solve_status" property="solveStatus"/>
        <result column="solution" property="solution"/>
        <result column="solver" property="solver"/>
        <result column="solve_time" property="solveTime"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, batch_no, reconciliation_date, payment_type, payment_no, transaction_id, 
        order_no, order_amount, actual_amount, platform_amount, reconciliation_status, 
        diff_amount, error_reason, solve_status, solution, solver, solve_time, 
        create_time, update_time
    </sql>

    <!-- 根据批次号查询对账记录 -->
    <select id="selectByBatchNo" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        batch_no = #{batchNo}
        ORDER BY
        create_time DESC
    </select>

    <!-- 根据批次号和状态查询对账记录 -->
    <select id="selectByBatchNoAndStatus" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        batch_no = #{batchNo}
        AND reconciliation_status = #{status}
        ORDER BY
        create_time DESC
    </select>

    <!-- 根据日期和支付方式查询对账记录 -->
    <select id="selectByDateAndPaymentType" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        reconciliation_date = #{date}
        AND payment_type = #{paymentType}
        ORDER BY
        create_time DESC
    </select>

    <!-- 根据交易号查询对账记录 -->
    <select id="selectByTransactionId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        transaction_id = #{transactionId}
    </select>

    <!-- 根据支付流水号查询对账记录 -->
    <select id="selectByPaymentNo" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        payment_no = #{paymentNo}
    </select>

    <!-- 批量插入对账记录 -->
    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reconciliation (
        batch_no, reconciliation_date, payment_type, payment_no, transaction_id, 
        order_no, order_amount, actual_amount, platform_amount, reconciliation_status, 
        diff_amount, error_reason, solve_status, create_time, update_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.batchNo}, #{item.reconciliationDate}, #{item.paymentType}, #{item.paymentNo}, #{item.transactionId}, 
            #{item.orderNo}, #{item.orderAmount}, #{item.actualAmount}, #{item.platformAmount}, #{item.reconciliationStatus}, 
            #{item.diffAmount}, #{item.errorReason}, #{item.solveStatus}, #{item.createTime}, #{item.updateTime}
            )
        </foreach>
    </insert>

    <!-- 批量更新对账记录 -->
    <update id="batchUpdate">
        <foreach collection="list" item="item" index="index" separator=";">
            UPDATE reconciliation
            SET 
            reconciliation_status = #{item.reconciliationStatus},
            diff_amount = #{item.diffAmount},
            error_reason = #{item.errorReason},
            update_time = #{item.updateTime}
            WHERE id = #{item.id}
        </foreach>
    </update>

    <!-- 更新对账记录状态 -->
    <update id="updateStatus">
        UPDATE reconciliation
        SET 
        reconciliation_status = #{status},
        update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <!-- 更新解决状态 -->
    <update id="updateSolveStatus">
        UPDATE reconciliation
        SET 
        solve_status = #{solveStatus},
        solution = #{solution},
        solver = #{solver},
        solve_time = #{solveTime},
        update_time = #{solveTime}
        WHERE id = #{id}
    </update>

    <!-- 统计对账状态 -->
    <select id="countByStatus" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM reconciliation
        WHERE batch_no = #{batchNo}
        AND reconciliation_status = #{status}
    </select>

    <!-- 统计差异 -->
    <select id="countReconciliationDiff" resultType="java.util.Map">
        SELECT 
        SUM(CASE WHEN reconciliation_status = 2 THEN 1 ELSE 0 END) AS amountDiffCount,
        SUM(CASE WHEN reconciliation_status = 3 THEN 1 ELSE 0 END) AS platformOnlyCount,
        SUM(CASE WHEN reconciliation_status = 4 THEN 1 ELSE 0 END) AS systemOnlyCount,
        SUM(CASE WHEN solve_status = 0 THEN 1 ELSE 0 END) AS unsolvedDiffCount
        FROM reconciliation
        WHERE reconciliation_date >= #{startDate}
        AND reconciliation_date <= #{endDate}
    </select>

    <!-- 查询未解决的对账差异 -->
    <select id="selectUnresolvedDiff" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        solve_status = 0
        AND reconciliation_status IN (2, 3, 4)
        ORDER BY
        create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 查询指定日期范围的对账记录 -->
    <select id="selectByDateRange" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        reconciliation_date >= #{startDate}
        AND reconciliation_date <= #{endDate}
        <if test="paymentType != null">
            AND payment_type = #{paymentType}
        </if>
        <if test="status != null">
            AND reconciliation_status = #{status}
        </if>
        ORDER BY
        create_time DESC
    </select>

    <!-- 查询指定批次号的差异记录 -->
    <select id="selectDiffByBatchNo" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE
        batch_no = #{batchNo}
        AND reconciliation_status IN (2, 3, 4)
        ORDER BY
        reconciliation_status
    </select>

    <!-- 删除指定日期之前的对账记录 -->
    <delete id="deleteBeforeDate">
        DELETE FROM reconciliation
        WHERE reconciliation_date < #{date}
    </delete>

    <!-- 查询对账记录总数 -->
    <select id="countTotal" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM reconciliation
        WHERE 1=1
        <if test="startDate != null">
            AND reconciliation_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND reconciliation_date <= #{endDate}
        </if>
        <if test="paymentType != null">
            AND payment_type = #{paymentType}
        </if>
    </select>

    <!-- 分页查询对账记录 -->
    <select id="selectByPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        reconciliation
        WHERE 1=1
        <if test="startDate != null">
            AND reconciliation_date >= #{startDate}
        </if>
        <if test="endDate != null">
            AND reconciliation_date <= #{endDate}
        </if>
        <if test="paymentType != null">
            AND payment_type = #{paymentType}
        </if>
        <if test="status != null">
            AND reconciliation_status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (payment_no LIKE CONCAT('%', #{keyword}, '%')
            OR transaction_id LIKE CONCAT('%', #{keyword}, '%')
            OR order_no LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY
        create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

</mapper>